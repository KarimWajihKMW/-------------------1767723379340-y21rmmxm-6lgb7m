<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>๐ง ููุงุฐุฌ ุงููุฎุงุทุฑ ูุฎุทุท ุงูุฏูุน ูุงูุญูููุฉ - ูุธุงู ูุงููุด</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Cairo', sans-serif;
            background: linear-gradient(135deg, #1d4ed8 0%, #0ea5e9 50%, #14b8a6 100%);
            min-height: 100vh;
        }
        .glass { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(12px); }
        .shape-rounded { border-radius: 26px; }
        .shape-angled { border-radius: 34px 10px 34px 10px; }
        .shape-pill { border-radius: 999px; }
        .shape-cut { border-radius: 18px 18px 42px 8px; }
        .table-scroll { max-height: 520px; overflow: auto; }
        .chart-box { position: relative; height: 260px; }
        .accent-sky { border-top: 4px solid #0ea5e9; }
        .accent-indigo { border-top: 4px solid #6366f1; }
        .accent-emerald { border-top: 4px solid #10b981; }
        .accent-rose { border-top: 4px solid #f43f5e; }
        .accent-amber { border-top: 4px solid #f59e0b; }
    </style>
</head>
<body>
    <div class="container mx-auto px-4 py-8">
        <div class="text-white mb-8">
            <h1 class="text-4xl font-bold mb-2">๐ง ููุงุฐุฌ ุงููุฎุงุทุฑ ูุฎุทุท ุงูุฏูุน ูุงูุญูููุฉ</h1>
            <p class="text-lg opacity-90">ุงูุฎุทูุงุช ุงูุนูููุฉ ูููุงุฐุฌ ุงูุฐูุงุก ุงููุงูู + ุงูุฅุทุงุฑ ุงูุนุงู ููุญูููุฉ (ุงูุตูุญุฉ 38)</p>
        </div>

        <div class="mb-6 flex flex-wrap gap-3">
            <button onclick="refreshData()" class="bg-white text-sky-700 px-6 py-3 rounded-full font-bold hover:shadow-lg transition flex items-center gap-2">
                <i class="fas fa-rotate"></i>
                ุชุญุฏูุซ ุงูุจูุงูุงุช
            </button>
            <button onclick="downloadAllJSON()" class="bg-indigo-600 text-white px-6 py-3 rounded-full font-bold hover:shadow-lg transition flex items-center gap-2">
                <i class="fas fa-file-code"></i>
                ุชูุฒูู ููู ุจูุงูุงุช ุดุงูู
            </button>
            <button onclick="downloadAllCSV()" class="bg-emerald-600 text-white px-6 py-3 rounded-full font-bold hover:shadow-lg transition flex items-center gap-2">
                <i class="fas fa-file-csv"></i>
                ุชูุฒูู ููู ุฌุฏููู ุดุงูู
            </button>
            <button onclick="printPage()" class="bg-rose-600 text-white px-6 py-3 rounded-full font-bold hover:shadow-lg transition flex items-center gap-2">
                <i class="fas fa-print"></i>
                ุทุจุงุนุฉ ุงูุตูุญุฉ
            </button>
            <button onclick="copySummary()" class="bg-amber-500 text-white px-6 py-3 rounded-full font-bold hover:shadow-lg transition flex items-center gap-2">
                <i class="fas fa-copy"></i>
                ูุณุฎ ููุฎุต ุงููููุฐุฌ
            </button>
        </div>

        <div class="glass shape-rounded shadow-2xl p-6 mb-8 accent-sky">
            <div class="flex flex-wrap items-center justify-between gap-3 mb-6">
                <h2 class="text-2xl font-bold text-slate-800">โ ุฎุทูุฉ 2: ูููุฐุฌ ูุฎุงุทุฑ ุงูุชุนุซุฑ ููู ุนููู</h2>
                <span class="text-sm text-slate-500">ุชุญููู ุงูุจูุงูุงุช ุฅูู ุฏุฑุฌุฉ ูุฎุงุทุฑุฉ ูุงุถุญุฉ</span>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5">
                <div class="glass shape-angled p-5 shadow-lg border border-sky-100">
                    <h3 class="font-bold text-slate-800 mb-2">ุงููุฏุฎูุงุช</h3>
                    <ul class="text-sm text-slate-600 space-y-1">
                        <li>ุนุฏุฏ ุงูุชุฃุฎูุฑุงุช ุงูุณุงุจูุฉ</li>
                        <li>ูุชูุณุท ูุฏุฉ ุงูุชุฃุฎูุฑ</li>
                        <li>ูุณุจุฉ ุงูุงูุชุฒุงู</li>
                        <li>ูุฌููุน ุงูููุงุชูุฑ ุงูููุชูุญุฉ</li>
                    </ul>
                </div>
                <div class="glass shape-cut p-5 shadow-lg border border-amber-100">
                    <h3 class="font-bold text-slate-800 mb-2">ุนูุงูู ุงูุณูุงู</h3>
                    <ul class="text-sm text-slate-600 space-y-1">
                        <li>ููุน ุงูุจุฑุงูุฌ</li>
                        <li>ุงูุญุงุถูุฉ/ุงููุฑุน</li>
                        <li>ุณุฌู ุงูุนููู ุงููุงูู</li>
                    </ul>
                </div>
                <div class="glass shape-pill p-5 shadow-lg border border-emerald-100">
                    <h3 class="font-bold text-slate-800 mb-2">ุงููุฎุฑุฌุงุช</h3>
                    <ul class="text-sm text-slate-600 space-y-1">
                        <li>ุฏุฑุฌุฉ ูุฎุงุทุฑุฉ ูู 0 ุฅูู 100</li>
                        <li>ุชุตููู: ููุฎูุถ / ูุชูุณุท / ูุฑุชูุน / ุญุฑุฌ</li>
                        <li>ุงูุชุฑุงุญ ุขูู: ุชุฐููุฑ / ุฎุทุฉ ุฏูุน / ุชุฏุฎู ุฅุฏุงุฑู</li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="glass shape-rounded shadow-2xl p-6 mb-8 accent-emerald">
            <div class="flex flex-wrap items-center justify-between gap-3 mb-6">
                <h2 class="text-2xl font-bold text-slate-800">๐ ุฎุทูุฉ 3: ูููุฐุฌ ุงูุชุฑุงุญ ุฎุทุท ุงูุฏูุน</h2>
                <span class="text-sm text-slate-500">ูุฑุชุจุท ุจุฏุฑุฌุฉ ุงููุฎุงุทุฑ ููุฏุฑุฉ ุงูุนููู</span>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5">
                <div class="glass shape-angled p-5 shadow-lg border border-emerald-100">
                    <h3 class="font-bold text-slate-800 mb-2">ุงูููุทู ุงูุชุดุบููู</h3>
                    <ul class="text-sm text-slate-600 space-y-1">
                        <li>ุฅุฐุง ุงููุฎุงุทุฑ ูุชูุณุทุฉ/ูุฑุชูุนุฉ ููุชุฑุญ ุชูุณูู ุงููุงุชูุฑุฉ</li>
                        <li>ูููุฉ ุงูุฏูุนุฉ โ ูุชูุณุท ูุง ุฏูุนู ุงูุนููู ุณุงุจููุง</li>
                        <li>ูุฏุฉ ุงูุฎุทุฉ โค ุญุฏ ุงูุณูุงุณุฉ ุงููุนุชูุฏุฉ</li>
                    </ul>
                </div>
                <div class="glass shape-cut p-5 shadow-lg border border-sky-100">
                    <h3 class="font-bold text-slate-800 mb-2">ุงููุฎุฑุฌุงุช ุงูุธุงูุฑุฉ</h3>
                    <p class="text-sm text-slate-600">ุงูุฎุทุฉ ุงูููุชุฑุญุฉ ุชุธูุฑ ูููุธู ุงูุชุญุตูู ุจุตูุบุฉ ูุงุถุญุฉ ุชุณุงุนุฏ ุนูู ุงููุฑุงุฑ ุงูุณุฑูุน.</p>
                </div>
                <div class="glass shape-pill p-5 shadow-lg border border-amber-100">
                    <h3 class="font-bold text-slate-800 mb-2">ุฏุนู ุงููุฑุงุฑ</h3>
                    <p class="text-sm text-slate-600">ูุชู ุฑุจุท ุงูุฎุทุฉ ูุน ุณุฌู ุงููุฎุงุทุฑ ูุฏุฑุฌุฉ ุงูุงูุชุฒุงู ูุถูุงู ุงูุถุจุงุท ุงูุชุญุตูู.</p>
                </div>
            </div>
        </div>

        <div class="glass shape-rounded shadow-2xl p-6 mb-8 accent-indigo">
            <div class="flex flex-wrap items-center justify-between gap-3 mb-6">
                <h2 class="text-2xl font-bold text-slate-800">๐ ุฎุทูุฉ 4: ุฏูุฌ ุงูุฐูุงุก ูู ุงูุชูุงุฑูุฑ ูุงูููุญุงุช</h2>
                <span class="text-sm text-slate-500">ูุคุดุฑุงุช ุฐููุฉ ููุชููุนุงุช ูุงููุฎุงุทุฑ</span>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-5">
                <div class="glass shape-angled p-5 shadow-lg border border-indigo-100">
                    <h4 class="font-bold text-slate-800 mb-2">ูุคุดุฑ ุงูุชููุนุงุช</h4>
                    <div id="forecastInsight" class="text-sm text-slate-600">ุฌุงุฑู ุงูุชุญููู...</div>
                </div>
                <div class="glass shape-cut p-5 shadow-lg border border-rose-100">
                    <h4 class="font-bold text-slate-800 mb-2">ูุคุดุฑ ุงููุฎุงุทุฑ</h4>
                    <div id="riskInsight" class="text-sm text-slate-600">ุฌุงุฑู ุงูุชุญููู...</div>
                </div>
                <div class="glass shape-pill p-5 shadow-lg border border-amber-100">
                    <h4 class="font-bold text-slate-800 mb-2">ุชูุจูู ุงูุณูุงุณุงุช</h4>
                    <div id="policyInsight" class="text-sm text-slate-600">ุฌุงุฑู ุงูุชุญููู...</div>
                </div>
            </div>
        </div>

        <div class="glass shape-rounded shadow-2xl p-6 mb-8 accent-rose">
            <div class="flex flex-wrap items-center justify-between gap-3 mb-6">
                <h2 class="text-2xl font-bold text-slate-800">๐๏ธ ุงูุฅุทุงุฑ ุงูุนุงู ููุญูููุฉ ุงููุงููุฉ</h2>
                <span class="text-sm text-slate-500">ูุธุงู ูุงูู ููุญุฏ ูุฎุฏู ุงูุชูุณุน ุงููุญูู ูุงูุฏููู</span>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5">
                <div class="glass shape-angled p-5 shadow-lg border border-rose-100">
                    <h3 class="font-bold text-slate-800 mb-2">ุงููุฏู ุงูุนุงู</h3>
                    <ul class="text-sm text-slate-600 space-y-1">
                        <li>ุฎุฏูุฉ 38+ ุญุงุถูุฉ</li>
                        <li>ููุตุงุช ุฑูููุฉ ูุจุฑุงูุฌ ุชุฏุฑูุจูุฉ</li>
                        <li>ูุฑูุน ูุชุนุฏุฏุฉ ูุชูุณุน ูุณุชูุจูู</li>
                    </ul>
                </div>
                <div class="glass shape-cut p-5 shadow-lg border border-sky-100">
                    <h3 class="font-bold text-slate-800 mb-2">ุงููุจุงุฏุฆ ุงูุฃุณุงุณูุฉ</h3>
                    <ul class="text-sm text-slate-600 space-y-1">
                        <li>ุงูุดูุงููุฉ: ูู ุนูููุฉ ูุงุจูุฉ ููุชุชุจุน</li>
                        <li>ุงูุงูุถุจุงุท: ูุง ุนูููุงุช ุฎุงุฑุฌ ุงููุธุงู</li>
                        <li>ุงูุชูููุถ: ุตูุงุญูุงุช ูุงุถุญุฉ ููู ุฏูุฑ</li>
                    </ul>
                </div>
                <div class="glass shape-pill p-5 shadow-lg border border-emerald-100">
                    <h3 class="font-bold text-slate-800 mb-2">ุงูุญูููุฉ ุงูุชุดุบูููุฉ</h3>
                    <ul class="text-sm text-slate-600 space-y-1">
                        <li>ุงููุตู ุจูู ุงูููุงู</li>
                        <li>ุฑูุงุจุฉ ุฏุงุฎููุฉ ูุณุชูุฑุฉ</li>
                        <li>ุชุญุณูู ุงูุณูุงุณุงุช ุณููููุง</li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-5 mb-8">
            <div class="glass shape-angled p-5 shadow-lg accent-sky">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-sm text-slate-600">ุฅุฌูุงูู ุงูููุงุชูุฑ ุงูููุชูุญุฉ</span>
                    <i class="fas fa-file-invoice text-sky-500 text-2xl"></i>
                </div>
                <div id="openInvoices" class="text-3xl font-bold text-slate-800">0</div>
            </div>
            <div class="glass shape-cut p-5 shadow-lg accent-emerald">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-sm text-slate-600">ุฅุฌูุงูู ุงููุฏููุนุงุช</span>
                    <i class="fas fa-credit-card text-emerald-500 text-2xl"></i>
                </div>
                <div id="totalPayments" class="text-3xl font-bold text-slate-800">0</div>
            </div>
            <div class="glass shape-rounded p-5 shadow-lg accent-rose">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-sm text-slate-600">ุนุฏุฏ ุชููููุงุช ุงููุฎุงุทุฑ</span>
                    <i class="fas fa-shield-halved text-rose-500 text-2xl"></i>
                </div>
                <div id="riskCount" class="text-3xl font-bold text-slate-800">0</div>
            </div>
            <div class="glass shape-pill p-5 shadow-lg accent-amber">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-sm text-slate-600">ุฎุทุท ุงูุณุฏุงุฏ ุงููุดุทุฉ</span>
                    <i class="fas fa-calendar-check text-amber-500 text-2xl"></i>
                </div>
                <div id="plansCount" class="text-3xl font-bold text-slate-800">0</div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
            <div class="glass shape-rounded shadow-2xl p-6 accent-sky">
                <h3 class="text-lg font-bold text-slate-800 mb-4">๐งญ ุชูุฒูุน ูุณุชููุงุช ุงููุฎุงุทุฑ</h3>
                <div class="chart-box"><canvas id="riskChart"></canvas></div>
            </div>
            <div class="glass shape-rounded shadow-2xl p-6 accent-emerald">
                <h3 class="text-lg font-bold text-slate-800 mb-4">๐ ุงุชุฌุงู ุงููุฏููุนุงุช ุงูุดูุฑูุฉ</h3>
                <div class="chart-box"><canvas id="paymentsChart"></canvas></div>
            </div>
        </div>

        <div class="glass shape-rounded shadow-2xl p-6 mb-8 accent-sky">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-xl font-bold text-slate-800">๐ ุฌุฏูู ุชููููุงุช ุงููุฎุงุทุฑ</h3>
                <span id="riskTableCount" class="text-sm text-slate-500"></span>
            </div>
            <div class="table-scroll">
                <table class="w-full text-xs">
                    <thead class="bg-sky-50 text-sky-700">
                        <tr>
                            <th class="px-3 py-2 text-right">ุฑูู ุงููุฎุงุทุฑ</th>
                            <th class="px-3 py-2 text-right">ุฑูู ุงูุนููู</th>
                            <th class="px-3 py-2 text-right">ุฏุฑุฌุฉ ุงููุฎุงุทุฑุฉ</th>
                            <th class="px-3 py-2 text-right">ูุณุชูู ุงููุฎุงุทุฑุฉ</th>
                            <th class="px-3 py-2 text-right">ุงูุชูุตูุงุช</th>
                            <th class="px-3 py-2 text-right">ุชุงุฑูุฎ ุงูุชูููู</th>
                        </tr>
                    </thead>
                    <tbody id="riskTable" class="divide-y divide-slate-100">
                        <tr><td colspan="6" class="px-4 py-10 text-center text-slate-500">ุฌุงุฑู ุชุญููู ุงูุจูุงูุงุช...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="glass shape-rounded shadow-2xl p-6 mb-8 accent-indigo">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-xl font-bold text-slate-800">๐ ุฌุฏูู ุฎุทุท ุงูุณุฏุงุฏ ุงูููุชุฑุญุฉ</h3>
                <span id="plansTableCount" class="text-sm text-slate-500"></span>
            </div>
            <div class="table-scroll">
                <table class="w-full text-xs">
                    <thead class="bg-indigo-50 text-indigo-700">
                        <tr>
                            <th class="px-3 py-2 text-right">ุฑูู ุงููุงุชูุฑุฉ</th>
                            <th class="px-3 py-2 text-right">ุงูุนููู</th>
                            <th class="px-3 py-2 text-right">ุงููุจูุบ ุงููุชุจูู</th>
                            <th class="px-3 py-2 text-right">ุฏุฑุฌุฉ ุงููุฎุงุทุฑุฉ</th>
                            <th class="px-3 py-2 text-right">ุงูุฎุทุฉ ุงูููุชุฑุญุฉ</th>
                            <th class="px-3 py-2 text-right">ุจุฏุงูุฉ ุงูุฎุทุฉ</th>
                        </tr>
                    </thead>
                    <tbody id="plansTable" class="divide-y divide-slate-100">
                        <tr><td colspan="6" class="px-4 py-10 text-center text-slate-500">ุฌุงุฑู ุชุญููู ุงูุจูุงูุงุช...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="glass shape-rounded shadow-2xl p-6 mb-8 accent-emerald">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-xl font-bold text-slate-800">๐ง ุฌุฏูู ุงููุฏููุนุงุช ุงููุฑุชุจุทุฉ ุจุงููุฎุงุทุฑ</h3>
                <span id="paymentsTableCount" class="text-sm text-slate-500"></span>
            </div>
            <div class="table-scroll">
                <table class="w-full text-xs">
                    <thead class="bg-emerald-50 text-emerald-700">
                        <tr>
                            <th class="px-3 py-2 text-right">ุฑูู ุงูุฏูุนุฉ</th>
                            <th class="px-3 py-2 text-right">ุงูุนููู</th>
                            <th class="px-3 py-2 text-right">ูููุฉ ุงูุฏูุนุฉ</th>
                            <th class="px-3 py-2 text-right">ุชุงุฑูุฎ ุงูุฏูุนุฉ</th>
                            <th class="px-3 py-2 text-right">ุงููุฑุน</th>
                            <th class="px-3 py-2 text-right">ุงูุญุงูุฉ</th>
                        </tr>
                    </thead>
                    <tbody id="paymentsTable" class="divide-y divide-slate-100">
                        <tr><td colspan="6" class="px-4 py-10 text-center text-slate-500">ุฌุงุฑู ุชุญููู ุงูุจูุงูุงุช...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = window.location.origin;
        const ENTITY_ID = '1';

        let store = {
            invoices: [],
            payments: [],
            plans: [],
            risks: [],
            forecasts: []
        };

        let riskChartInstance = null;
        let paymentsChartInstance = null;

        async function loadData() {
            try {
                const [invoiceRes, paymentRes, planRes, riskRes, forecastRes] = await Promise.all([
                    fetch(`${API_BASE}/finance/invoices`),
                    fetch(`${API_BASE}/finance/payments`),
                    fetch(`${API_BASE}/finance/payment-plans?entity_id=${ENTITY_ID}`),
                    fetch(`${API_BASE}/finance/ai-risk-scores?entity_id=${ENTITY_ID}`),
                    fetch(`${API_BASE}/finance/ai-forecasts?entity_id=${ENTITY_ID}`)
                ]);

                const [invoiceData, paymentData, planData, riskData, forecastData] = await Promise.all([
                    invoiceRes.json(),
                    paymentRes.json(),
                    planRes.json(),
                    riskRes.json(),
                    forecastRes.json()
                ]);

                store.invoices = invoiceData.invoices || [];
                store.payments = paymentData.payments || [];
                store.plans = planData.plans || [];
                store.risks = riskData.rows || [];
                store.forecasts = forecastData.forecasts || [];

                renderStats();
                renderInsights();
                renderTables();
                renderCharts();
            } catch (error) {
                console.error('ุฎุทุฃ ูู ุชุญููู ุงูุจูุงูุงุช:', error);
            }
        }

        function renderStats() {
            const openInvoices = store.invoices.filter(i => ['UNPAID', 'PARTIAL', 'OVERDUE'].includes(String(i.status || '').toUpperCase()));
            document.getElementById('openInvoices').textContent = openInvoices.length.toLocaleString('ar-SA');
            document.getElementById('totalPayments').textContent = formatMoney(sum(store.payments, 'payment_amount'));
            document.getElementById('riskCount').textContent = store.risks.length.toLocaleString('ar-SA');
            document.getElementById('plansCount').textContent = store.plans.length.toLocaleString('ar-SA');
        }

        function renderInsights() {
            const forecastSorted = [...store.forecasts].sort((a, b) => new Date(a.created_at) - new Date(b.created_at));
            const forecast90 = forecastSorted.slice(0, 3).reduce((sumValue, f) => sumValue + parseFloat(f.forecast_amount || 0), 0);
            const highRisk = store.risks.filter(r => ['HIGH', 'CRITICAL'].includes(String(r.risk_level || '').toUpperCase()));
            const overdueInvoices = store.invoices.filter(i => String(i.status || '').toUpperCase() === 'OVERDUE');

            document.getElementById('forecastInsight').textContent = `ุชุญุตูู ูุชููุน ุฎูุงู 90 ููู: ${formatMoney(forecast90)}`;
            document.getElementById('riskInsight').textContent = `ุนุฏุฏ ุนููุงุก ุงููุฎุงุทุฑ ุงููุฑุชูุนุฉ: ${highRisk.length}`;
            document.getElementById('policyInsight').textContent = overdueInvoices.length
                ? `ุชุญุชุงุฌ ${overdueInvoices.length} ูุงุชูุฑุฉ ูุชุฃุฎุฑุฉ ุฅูู ูุฑุงุฌุนุฉ ุดุฑูุท ุงูุฏูุน.`
                : 'ูุง ุชูุฌุฏ ููุงุชูุฑ ูุชุฃุฎุฑุฉ ุญุฑุฌุฉ ุญุงููุงู.';
        }

        function renderTables() {
            const riskRows = store.risks.map(r => `
                <tr class="hover:bg-sky-50">
                    <td class="px-3 py-2">${r.risk_id ?? '-'}</td>
                    <td class="px-3 py-2">${sanitizeText(r.customer_id)}</td>
                    <td class="px-3 py-2">${formatPercent(r.risk_score)}</td>
                    <td class="px-3 py-2">${translateRiskLevel(r.risk_level)}</td>
                    <td class="px-3 py-2">${truncate(sanitizeText(r.recommendations))}</td>
                    <td class="px-3 py-2">${formatDate(r.assessment_date)}</td>
                </tr>
            `).join('');
            document.getElementById('riskTable').innerHTML = riskRows || `<tr><td colspan="6" class="px-4 py-10 text-center text-slate-500">ูุง ุชูุฌุฏ ุจูุงูุงุช</td></tr>`;
            document.getElementById('riskTableCount').textContent = `ุนุฏุฏ ุงูุตููู: ${store.risks.length}`;

            const suggestedPlans = buildSuggestedPlans();
            const planRows = suggestedPlans.map(p => `
                <tr class="hover:bg-indigo-50">
                    <td class="px-3 py-2">${sanitizeText(p.invoice_number)}</td>
                    <td class="px-3 py-2">${sanitizeText(p.customer_name)}</td>
                    <td class="px-3 py-2 font-semibold text-emerald-700">${formatMoney(p.remaining_amount)}</td>
                    <td class="px-3 py-2">${formatPercent(p.risk_score)}</td>
                    <td class="px-3 py-2">${p.plan_text}</td>
                    <td class="px-3 py-2">${p.start_date}</td>
                </tr>
            `).join('');
            document.getElementById('plansTable').innerHTML = planRows || `<tr><td colspan="6" class="px-4 py-10 text-center text-slate-500">ูุง ุชูุฌุฏ ุจูุงูุงุช</td></tr>`;
            document.getElementById('plansTableCount').textContent = `ุนุฏุฏ ุงูุตููู: ${suggestedPlans.length}`;

            const paymentRows = store.payments.map(p => `
                <tr class="hover:bg-emerald-50">
                    <td class="px-3 py-2">${sanitizeText(p.payment_number || p.payment_id)}</td>
                    <td class="px-3 py-2">${sanitizeText(p.customer_id || p.customer_name_ar || p.customer_name)}</td>
                    <td class="px-3 py-2 font-semibold text-emerald-700">${formatMoney(p.payment_amount)}</td>
                    <td class="px-3 py-2">${formatDate(p.payment_date)}</td>
                    <td class="px-3 py-2">${sanitizeText(p.branch_id)}</td>
                    <td class="px-3 py-2">${translateStatus(p.status)}</td>
                </tr>
            `).join('');
            document.getElementById('paymentsTable').innerHTML = paymentRows || `<tr><td colspan="6" class="px-4 py-10 text-center text-slate-500">ูุง ุชูุฌุฏ ุจูุงูุงุช</td></tr>`;
            document.getElementById('paymentsTableCount').textContent = `ุนุฏุฏ ุงูุตููู: ${store.payments.length}`;
        }

        function renderCharts() {
            const riskCounts = store.risks.reduce((acc, r) => {
                const level = translateRiskLevel(r.risk_level) || 'ุบูุฑ ูุญุฏุฏ';
                acc[level] = (acc[level] || 0) + 1;
                return acc;
            }, {});
            const riskCtx = document.getElementById('riskChart').getContext('2d');
            if (riskChartInstance) riskChartInstance.destroy();
            riskChartInstance = new Chart(riskCtx, {
                type: 'bar',
                data: {
                    labels: Object.keys(riskCounts).length ? Object.keys(riskCounts) : ['ูุง ุชูุฌุฏ ุจูุงูุงุช'],
                    datasets: [{
                        data: Object.values(riskCounts).length ? Object.values(riskCounts) : [0],
                        backgroundColor: ['#ef4444', '#f59e0b', '#10b981', '#6366f1']
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
            });

            const monthly = groupByMonth(store.payments, 'payment_date', 'payment_amount');
            const paymentCtx = document.getElementById('paymentsChart').getContext('2d');
            if (paymentsChartInstance) paymentsChartInstance.destroy();
            paymentsChartInstance = new Chart(paymentCtx, {
                type: 'line',
                data: {
                    labels: Object.keys(monthly),
                    datasets: [{
                        label: 'ุงููุฏููุนุงุช',
                        data: Object.values(monthly),
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.2)',
                        tension: 0.35
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });
        }

        function buildSuggestedPlans() {
            const riskMap = new Map(store.risks.map(r => [String(r.customer_id), r]));
            const paymentsByCustomer = store.payments.reduce((acc, p) => {
                const key = String(p.customer_id || p.customer_name_ar || p.customer_name || 'ุบูุฑ ูุญุฏุฏ');
                if (!acc[key]) acc[key] = [];
                acc[key].push(p);
                return acc;
            }, {});

            const overdueInvoices = store.invoices.filter(i => ['OVERDUE', 'PARTIAL', 'UNPAID'].includes(String(i.status || '').toUpperCase()));

            return overdueInvoices.map(inv => {
                const customerKey = String(inv.customer_id || inv.customer_name_ar || inv.customer_name || 'ุบูุฑ ูุญุฏุฏ');
                const risk = riskMap.get(String(inv.customer_id)) || {};
                const avgPaid = average((paymentsByCustomer[customerKey] || []).map(p => parseFloat(p.payment_amount || 0))) || 0;
                const remaining = parseFloat(inv.remaining_amount || 0);
                const installment = avgPaid > 0 ? avgPaid : Math.max(remaining / 6, 500);
                const installments = Math.max(2, Math.ceil(remaining / installment));
                const startDate = new Date();
                startDate.setMonth(startDate.getMonth() + 1);
                const startText = startDate.toLocaleDateString('ar-SA');
                const planText = `ุฎุทุฉ ููุชุฑุญุฉ: ${installments} ุฏูุนุฉ ร ${formatMoney(installment)}.`;
                return {
                    invoice_number: inv.invoice_number || inv.invoice_id,
                    customer_name: inv.customer_name_ar || inv.customer_name || inv.customer_id,
                    remaining_amount: remaining,
                    risk_score: risk.risk_score || 0,
                    plan_text: planText,
                    start_date: startText
                };
            }).slice(0, 20);
        }

        function groupByMonth(rows, dateKey, valueKey) {
            const grouped = rows.reduce((acc, row) => {
                const date = row[dateKey] ? new Date(row[dateKey]) : null;
                const label = date ? `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}` : 'ุบูุฑ ูุญุฏุฏ';
                acc[label] = (acc[label] || 0) + parseFloat(row[valueKey] || 0);
                return acc;
            }, {});
            const ordered = Object.keys(grouped).sort().reduce((acc, key) => {
                acc[key] = grouped[key];
                return acc;
            }, {});
            return ordered;
        }

        function translateRiskLevel(value) {
            const map = { HIGH: 'ูุฑุชูุน', MEDIUM: 'ูุชูุณุท', LOW: 'ููุฎูุถ', CRITICAL: 'ุญุฑุฌ' };
            return map[String(value || '').toUpperCase()] || 'ุบูุฑ ูุญุฏุฏ';
        }

        function translateStatus(value) {
            const map = {
                PAID: 'ูุฏููุนุฉ',
                UNPAID: 'ุบูุฑ ูุฏููุนุฉ',
                PARTIAL: 'ูุฏููุนุฉ ุฌุฒุฆููุง',
                OVERDUE: 'ูุชุฃุฎุฑุฉ',
                PENDING: 'ููุฏ ุงููุฑุงุฌุนุฉ',
                APPROVED: 'ูุนุชูุฏุฉ'
            };
            return map[String(value || '').toUpperCase()] || 'ุบูุฑ ูุญุฏุฏ';
        }

        function formatMoney(value) {
            const num = parseFloat(value || 0);
            return num.toLocaleString('ar-SA') + ' ุฑ.ุณ';
        }

        function formatDate(value) {
            if (!value) return '-';
            return new Date(value).toLocaleDateString('ar-SA');
        }

        function formatPercent(value) {
            if (value === null || value === undefined || value === '') return '-';
            const num = parseFloat(value || 0);
            return `${num.toFixed(1)}%`;
        }

        function truncate(value) {
            if (value === null || value === undefined) return '-';
            const text = typeof value === 'string' ? value : JSON.stringify(value);
            return text.length > 120 ? text.slice(0, 120) + '...' : text;
        }

        function sanitizeText(value) {
            if (value === null || value === undefined) return 'ุบูุฑ ูุญุฏุฏ';
            const text = typeof value === 'string' ? value : JSON.stringify(value);
            const cleaned = text.replace(/[A-Za-z]+/g, '').replace(/\s{2,}/g, ' ').trim();
            return cleaned || 'ุบูุฑ ูุญุฏุฏ';
        }

        function sum(rows, key) {
            return rows.reduce((acc, row) => acc + parseFloat(row[key] || 0), 0);
        }

        function average(values) {
            if (!values.length) return 0;
            return values.reduce((sumValue, val) => sumValue + val, 0) / values.length;
        }

        function downloadAllJSON() {
            const payload = {
                invoices: store.invoices,
                payments: store.payments,
                plans: store.plans,
                risks: store.risks,
                forecasts: store.forecasts
            };
            downloadBlob(JSON.stringify(payload, null, 2), 'ููุงุฐุฌ-ุงููุฎุงุทุฑ-ูุฎุทุฉ-ุงูุฏูุน.json', 'application/json');
        }

        function downloadAllCSV() {
            const rows = [];
            rows.push(['ุชููููุงุช ุงููุฎุงุทุฑ']);
            rows.push(['ุฑูู ุงููุฎุงุทุฑ','ุฑูู ุงูุนููู','ุงูุฏุฑุฌุฉ','ุงููุณุชูู','ุงูุชูุตูุงุช','ุชุงุฑูุฎ ุงูุชูููู']);
            store.risks.forEach(r => rows.push([r.risk_id, r.customer_id, r.risk_score, translateRiskLevel(r.risk_level), sanitizeText(r.recommendations), r.assessment_date]));

            rows.push([]);
            rows.push(['ุฎุทุท ุงูุฏูุน ุงูููุชุฑุญุฉ']);
            rows.push(['ุฑูู ุงููุงุชูุฑุฉ','ุงูุนููู','ุงููุชุจูู','ุฏุฑุฌุฉ ุงููุฎุงุทุฑุฉ','ุงูุฎุทุฉ ุงูููุชุฑุญุฉ','ุจุฏุงูุฉ ุงูุฎุทุฉ']);
            buildSuggestedPlans().forEach(p => rows.push([p.invoice_number, p.customer_name, p.remaining_amount, p.risk_score, p.plan_text, p.start_date]));

            rows.push([]);
            rows.push(['ุงููุฏููุนุงุช']);
            rows.push(['ุฑูู ุงูุฏูุนุฉ','ุงูุนููู','ูููุฉ ุงูุฏูุนุฉ','ุชุงุฑูุฎ ุงูุฏูุนุฉ','ุงููุฑุน','ุงูุญุงูุฉ']);
            store.payments.forEach(p => rows.push([p.payment_number || p.payment_id, p.customer_id || p.customer_name_ar || p.customer_name, p.payment_amount, p.payment_date, p.branch_id, translateStatus(p.status)]));

            const csv = rows.map(r => r.map(v => `"${v ?? ''}"`).join(',')).join('\n');
            downloadBlob(csv, 'ููุงุฐุฌ-ุงููุฎุงุทุฑ-ูุฎุทุฉ-ุงูุฏูุน.csv', 'text/csv;charset=utf-8;');
        }

        function copySummary() {
            const summary = `ููุฎุต ูููุฐุฌ ุงููุฎุงุทุฑ ูุฎุทุท ุงูุฏูุน\n` +
                `ุงูููุงุชูุฑ ุงูููุชูุญุฉ: ${store.invoices.filter(i => ['UNPAID','PARTIAL','OVERDUE'].includes(String(i.status || '').toUpperCase())).length}\n` +
                `ุฅุฌูุงูู ุงููุฏููุนุงุช: ${formatMoney(sum(store.payments, 'payment_amount'))}\n` +
                `ุชููููุงุช ุงููุฎุงุทุฑ: ${store.risks.length}\n` +
                `ุฎุทุท ุงูุณุฏุงุฏ: ${store.plans.length}`;
            navigator.clipboard.writeText(summary).catch(() => {});
        }

        function downloadBlob(content, filename, type) {
            const blob = new Blob([content], { type });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            link.click();
            URL.revokeObjectURL(url);
        }

        function printPage() {
            window.print();
        }

        function refreshData() {
            loadData();
        }

        document.addEventListener('DOMContentLoaded', loadData);
    </script>
</body>
</html>
