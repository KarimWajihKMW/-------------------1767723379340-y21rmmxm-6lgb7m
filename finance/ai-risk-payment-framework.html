<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>๐ง ููุงุฐุฌ ุงููุฎุงุทุฑ ูุฎุทุท ุงูุฏูุน ูุงูุญูููุฉ - ูุธุงู ูุงููุด</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Cairo', sans-serif; background-color: #f9fafb; color: #0f172a; }
        
        .card-gradient {
            background: linear-gradient(145deg, #ffffff, #f3f4f6);
            border: 1px solid #e2e8f0;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
    
        .shape-rounded { border-radius: 26px; }
        .shape-angled { border-radius: 34px 10px 34px 10px; }
        .shape-pill { border-radius: 999px; }
        .shape-cut { border-radius: 18px 18px 42px 8px; }
        .table-scroll { max-height: 520px; overflow: auto; }
        .chart-box { position: relative; height: 260px; }
        .accent-sky { border-top: 4px solid #0ea5e9; }
        .accent-indigo { border-top: 4px solid #6366f1; }
        .accent-emerald { border-top: 4px solid #10b981; }
        .accent-rose { border-top: 4px solid #f43f5e; }
        .accent-amber { border-top: 4px solid #f59e0b; }
    </style>
</head>
<body>
    <div class="container mx-auto px-4 py-8">
        <div class="text-slate-900 mb-8">
            <h1 class="text-4xl font-bold mb-2">๐ง ููุงุฐุฌ ุงููุฎุงุทุฑ ูุฎุทุท ุงูุฏูุน ูุงูุญูููุฉ</h1>
            <p class="text-lg text-slate-600">ุงูุฎุทูุงุช ุงูุนูููุฉ ูููุงุฐุฌ ุงูุฐูุงุก ุงููุงูู + ุงูุฅุทุงุฑ ุงูุนุงู ููุญูููุฉ (ุงูุตูุญุฉ 38)</p>
        </div>

        <div class="mb-6 flex flex-wrap gap-3">
            <button onclick="refreshData()" class="bg-white text-sky-700 border border-sky-100 shadow-sm px-6 py-3 rounded-full font-bold hover:shadow-lg transition flex items-center gap-2">
                <i class="fas fa-rotate"></i>
                ุชุญุฏูุซ ุงูุจูุงูุงุช
            </button>
            <button onclick="downloadAllJSON()" class="bg-indigo-600 text-white px-6 py-3 rounded-full font-bold hover:shadow-lg transition flex items-center gap-2">
                <i class="fas fa-file-code"></i>
                ุชูุฒูู ููู ุจูุงูุงุช ุดุงูู
            </button>
            <button onclick="downloadAllCSV()" class="bg-emerald-600 text-white px-6 py-3 rounded-full font-bold hover:shadow-lg transition flex items-center gap-2">
                <i class="fas fa-file-csv"></i>
                ุชูุฒูู ููู ุฌุฏููู ุดุงูู
            </button>
            <button onclick="printPage()" class="bg-rose-600 text-white px-6 py-3 rounded-full font-bold hover:shadow-lg transition flex items-center gap-2">
                <i class="fas fa-print"></i>
                ุทุจุงุนุฉ ุงูุตูุญุฉ
            </button>
            <button onclick="copySummary()" class="bg-amber-500 text-white px-6 py-3 rounded-full font-bold hover:shadow-lg transition flex items-center gap-2">
                <i class="fas fa-copy"></i>
                ูุณุฎ ููุฎุต ุงููููุฐุฌ
            </button>
        </div>

        <div class="mb-6 flex flex-wrap gap-3">
            <button onclick="openRiskForm()" class="bg-sky-700 text-white px-5 py-2 rounded-xl font-semibold shadow hover:shadow-lg transition flex items-center gap-2">
                <i class="fas fa-shield"></i>
                ุฅุถุงูุฉ ุชูููู ูุฎุงุทุฑ
            </button>
            <button onclick="openPlanForm()" class="bg-indigo-700 text-white px-5 py-2 rounded-xl font-semibold shadow hover:shadow-lg transition flex items-center gap-2">
                <i class="fas fa-calendar-plus"></i>
                ุฅุถุงูุฉ ุฎุทุฉ ุณุฏุงุฏ
            </button>
            <button onclick="openPaymentForm()" class="bg-emerald-700 text-white px-5 py-2 rounded-xl font-semibold shadow hover:shadow-lg transition flex items-center gap-2">
                <i class="fas fa-money-bill"></i>
                ุชุณุฌูู ุฏูุนุฉ ุฌุฏูุฏุฉ
            </button>
        </div>

        <div class="card-gradient shape-rounded shadow-2xl p-6 mb-8 accent-sky">
            <div class="flex flex-wrap items-center justify-between gap-3 mb-6">
                <h2 class="text-2xl font-bold text-slate-800">โ ุฎุทูุฉ 2: ูููุฐุฌ ูุฎุงุทุฑ ุงูุชุนุซุฑ ููู ุนููู</h2>
                <span class="text-sm text-slate-500">ุชุญููู ุงูุจูุงูุงุช ุฅูู ุฏุฑุฌุฉ ูุฎุงุทุฑุฉ ูุงุถุญุฉ</span>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5">
                <div class="card-gradient shape-angled p-5 shadow-lg border border-sky-100">
                    <h3 class="font-bold text-slate-800 mb-2">ุงููุฏุฎูุงุช</h3>
                    <ul class="text-sm text-slate-600 space-y-1">
                        <li>ุนุฏุฏ ุงูุชุฃุฎูุฑุงุช ุงูุณุงุจูุฉ</li>
                        <li>ูุชูุณุท ูุฏุฉ ุงูุชุฃุฎูุฑ</li>
                        <li>ูุณุจุฉ ุงูุงูุชุฒุงู</li>
                        <li>ูุฌููุน ุงูููุงุชูุฑ ุงูููุชูุญุฉ</li>
                    </ul>
                </div>
                <div class="card-gradient shape-cut p-5 shadow-lg border border-amber-100">
                    <h3 class="font-bold text-slate-800 mb-2">ุนูุงูู ุงูุณูุงู</h3>
                    <ul class="text-sm text-slate-600 space-y-1">
                        <li>ููุน ุงูุจุฑุงูุฌ</li>
                        <li>ุงูุญุงุถูุฉ/ุงููุฑุน</li>
                        <li>ุณุฌู ุงูุนููู ุงููุงูู</li>
                    </ul>
                </div>
                <div class="card-gradient shape-pill p-5 shadow-lg border border-emerald-100">
                    <h3 class="font-bold text-slate-800 mb-2">ุงููุฎุฑุฌุงุช</h3>
                    <ul class="text-sm text-slate-600 space-y-1">
                        <li>ุฏุฑุฌุฉ ูุฎุงุทุฑุฉ ูู 0 ุฅูู 100</li>
                        <li>ุชุตููู: ููุฎูุถ / ูุชูุณุท / ูุฑุชูุน / ุญุฑุฌ</li>
                        <li>ุงูุชุฑุงุญ ุขูู: ุชุฐููุฑ / ุฎุทุฉ ุฏูุน / ุชุฏุฎู ุฅุฏุงุฑู</li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="card-gradient shape-rounded shadow-2xl p-6 mb-8 accent-emerald">
            <div class="flex flex-wrap items-center justify-between gap-3 mb-6">
                <h2 class="text-2xl font-bold text-slate-800">๐ ุฎุทูุฉ 3: ูููุฐุฌ ุงูุชุฑุงุญ ุฎุทุท ุงูุฏูุน</h2>
                <span class="text-sm text-slate-500">ูุฑุชุจุท ุจุฏุฑุฌุฉ ุงููุฎุงุทุฑ ููุฏุฑุฉ ุงูุนููู</span>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5">
                <div class="card-gradient shape-angled p-5 shadow-lg border border-emerald-100">
                    <h3 class="font-bold text-slate-800 mb-2">ุงูููุทู ุงูุชุดุบููู</h3>
                    <ul class="text-sm text-slate-600 space-y-1">
                        <li>ุฅุฐุง ุงููุฎุงุทุฑ ูุชูุณุทุฉ/ูุฑุชูุนุฉ ููุชุฑุญ ุชูุณูู ุงููุงุชูุฑุฉ</li>
                        <li>ูููุฉ ุงูุฏูุนุฉ โ ูุชูุณุท ูุง ุฏูุนู ุงูุนููู ุณุงุจููุง</li>
                        <li>ูุฏุฉ ุงูุฎุทุฉ โค ุญุฏ ุงูุณูุงุณุฉ ุงููุนุชูุฏุฉ</li>
                    </ul>
                </div>
                <div class="card-gradient shape-cut p-5 shadow-lg border border-sky-100">
                    <h3 class="font-bold text-slate-800 mb-2">ุงููุฎุฑุฌุงุช ุงูุธุงูุฑุฉ</h3>
                    <p class="text-sm text-slate-600">ุงูุฎุทุฉ ุงูููุชุฑุญุฉ ุชุธูุฑ ูููุธู ุงูุชุญุตูู ุจุตูุบุฉ ูุงุถุญุฉ ุชุณุงุนุฏ ุนูู ุงููุฑุงุฑ ุงูุณุฑูุน.</p>
                </div>
                <div class="card-gradient shape-pill p-5 shadow-lg border border-amber-100">
                    <h3 class="font-bold text-slate-800 mb-2">ุฏุนู ุงููุฑุงุฑ</h3>
                    <p class="text-sm text-slate-600">ูุชู ุฑุจุท ุงูุฎุทุฉ ูุน ุณุฌู ุงููุฎุงุทุฑ ูุฏุฑุฌุฉ ุงูุงูุชุฒุงู ูุถูุงู ุงูุถุจุงุท ุงูุชุญุตูู.</p>
                </div>
            </div>
        </div>

        <div class="card-gradient shape-rounded shadow-2xl p-6 mb-8 accent-indigo">
            <div class="flex flex-wrap items-center justify-between gap-3 mb-6">
                <h2 class="text-2xl font-bold text-slate-800">๐ ุฎุทูุฉ 4: ุฏูุฌ ุงูุฐูุงุก ูู ุงูุชูุงุฑูุฑ ูุงูููุญุงุช</h2>
                <span class="text-sm text-slate-500">ูุคุดุฑุงุช ุฐููุฉ ููุชููุนุงุช ูุงููุฎุงุทุฑ</span>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-5">
                <div class="card-gradient shape-angled p-5 shadow-lg border border-indigo-100">
                    <h4 class="font-bold text-slate-800 mb-2">ูุคุดุฑ ุงูุชููุนุงุช</h4>
                    <div id="forecastInsight" class="text-sm text-slate-600">ุฌุงุฑู ุงูุชุญููู...</div>
                </div>
                <div class="card-gradient shape-cut p-5 shadow-lg border border-rose-100">
                    <h4 class="font-bold text-slate-800 mb-2">ูุคุดุฑ ุงููุฎุงุทุฑ</h4>
                    <div id="riskInsight" class="text-sm text-slate-600">ุฌุงุฑู ุงูุชุญููู...</div>
                </div>
                <div class="card-gradient shape-pill p-5 shadow-lg border border-amber-100">
                    <h4 class="font-bold text-slate-800 mb-2">ุชูุจูู ุงูุณูุงุณุงุช</h4>
                    <div id="policyInsight" class="text-sm text-slate-600">ุฌุงุฑู ุงูุชุญููู...</div>
                </div>
            </div>
        </div>

        <div class="card-gradient shape-rounded shadow-2xl p-6 mb-8 accent-rose">
            <div class="flex flex-wrap items-center justify-between gap-3 mb-6">
                <h2 class="text-2xl font-bold text-slate-800">๐๏ธ ุงูุฅุทุงุฑ ุงูุนุงู ููุญูููุฉ ุงููุงููุฉ</h2>
                <span class="text-sm text-slate-500">ูุธุงู ูุงูู ููุญุฏ ูุฎุฏู ุงูุชูุณุน ุงููุญูู ูุงูุฏููู</span>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5">
                <div class="card-gradient shape-angled p-5 shadow-lg border border-rose-100">
                    <h3 class="font-bold text-slate-800 mb-2">ุงููุฏู ุงูุนุงู</h3>
                    <ul class="text-sm text-slate-600 space-y-1">
                        <li>ุฎุฏูุฉ 38+ ุญุงุถูุฉ</li>
                        <li>ููุตุงุช ุฑูููุฉ ูุจุฑุงูุฌ ุชุฏุฑูุจูุฉ</li>
                        <li>ูุฑูุน ูุชุนุฏุฏุฉ ูุชูุณุน ูุณุชูุจูู</li>
                    </ul>
                </div>
                <div class="card-gradient shape-cut p-5 shadow-lg border border-sky-100">
                    <h3 class="font-bold text-slate-800 mb-2">ุงููุจุงุฏุฆ ุงูุฃุณุงุณูุฉ</h3>
                    <ul class="text-sm text-slate-600 space-y-1">
                        <li>ุงูุดูุงููุฉ: ูู ุนูููุฉ ูุงุจูุฉ ููุชุชุจุน</li>
                        <li>ุงูุงูุถุจุงุท: ูุง ุนูููุงุช ุฎุงุฑุฌ ุงููุธุงู</li>
                        <li>ุงูุชูููุถ: ุตูุงุญูุงุช ูุงุถุญุฉ ููู ุฏูุฑ</li>
                    </ul>
                </div>
                <div class="card-gradient shape-pill p-5 shadow-lg border border-emerald-100">
                    <h3 class="font-bold text-slate-800 mb-2">ุงูุญูููุฉ ุงูุชุดุบูููุฉ</h3>
                    <ul class="text-sm text-slate-600 space-y-1">
                        <li>ุงููุตู ุจูู ุงูููุงู</li>
                        <li>ุฑูุงุจุฉ ุฏุงุฎููุฉ ูุณุชูุฑุฉ</li>
                        <li>ุชุญุณูู ุงูุณูุงุณุงุช ุณููููุง</li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-5 mb-8">
            <div class="card-gradient shape-angled p-5 shadow-lg accent-sky">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-sm text-slate-600">ุฅุฌูุงูู ุงูููุงุชูุฑ ุงูููุชูุญุฉ</span>
                    <i class="fas fa-file-invoice text-sky-500 text-2xl"></i>
                </div>
                <div id="openInvoices" class="text-3xl font-bold text-slate-800">0</div>
            </div>
            <div class="card-gradient shape-cut p-5 shadow-lg accent-emerald">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-sm text-slate-600">ุฅุฌูุงูู ุงููุฏููุนุงุช</span>
                    <i class="fas fa-credit-card text-emerald-500 text-2xl"></i>
                </div>
                <div id="totalPayments" class="text-3xl font-bold text-slate-800">0</div>
            </div>
            <div class="card-gradient shape-rounded p-5 shadow-lg accent-rose">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-sm text-slate-600">ุนุฏุฏ ุชููููุงุช ุงููุฎุงุทุฑ</span>
                    <i class="fas fa-shield-halved text-rose-500 text-2xl"></i>
                </div>
                <div id="riskCount" class="text-3xl font-bold text-slate-800">0</div>
            </div>
            <div class="card-gradient shape-pill p-5 shadow-lg accent-amber">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-sm text-slate-600">ุฎุทุท ุงูุณุฏุงุฏ ุงููุดุทุฉ</span>
                    <i class="fas fa-calendar-check text-amber-500 text-2xl"></i>
                </div>
                <div id="plansCount" class="text-3xl font-bold text-slate-800">0</div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
            <div class="card-gradient shape-rounded shadow-2xl p-6 accent-sky">
                <h3 class="text-lg font-bold text-slate-800 mb-4">๐งญ ุชูุฒูุน ูุณุชููุงุช ุงููุฎุงุทุฑ</h3>
                <div class="chart-box"><canvas id="riskChart"></canvas></div>
            </div>
            <div class="card-gradient shape-rounded shadow-2xl p-6 accent-emerald">
                <h3 class="text-lg font-bold text-slate-800 mb-4">๐ ุงุชุฌุงู ุงููุฏููุนุงุช ุงูุดูุฑูุฉ</h3>
                <div class="chart-box"><canvas id="paymentsChart"></canvas></div>
            </div>
        </div>

        <div class="card-gradient shape-rounded shadow-2xl p-6 mb-8 accent-sky">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-xl font-bold text-slate-800">๐ ุฌุฏูู ุชููููุงุช ุงููุฎุงุทุฑ</h3>
                <span id="riskTableCount" class="text-sm text-slate-500"></span>
            </div>
            <div class="table-scroll">
                <table class="w-full text-xs">
                    <thead class="bg-sky-50 text-sky-700">
                        <tr>
                            <th class="px-3 py-2 text-right">ุฑูู ุงููุฎุงุทุฑ</th>
                            <th class="px-3 py-2 text-right">ุฑูู ุงูุนููู</th>
                            <th class="px-3 py-2 text-right">ุฏุฑุฌุฉ ุงููุฎุงุทุฑุฉ</th>
                            <th class="px-3 py-2 text-right">ูุณุชูู ุงููุฎุงุทุฑุฉ</th>
                            <th class="px-3 py-2 text-right">ุงูุชูุตูุงุช</th>
                            <th class="px-3 py-2 text-right">ุชุงุฑูุฎ ุงูุชูููู</th>
                            <th class="px-3 py-2 text-right">ุฅุฌุฑุงุกุงุช</th>
                        </tr>
                    </thead>
                    <tbody id="riskTable" class="divide-y divide-slate-100">
                        <tr><td colspan="7" class="px-4 py-10 text-center text-slate-500">ุฌุงุฑู ุชุญููู ุงูุจูุงูุงุช...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="card-gradient shape-rounded shadow-2xl p-6 mb-8 accent-indigo">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-xl font-bold text-slate-800">๐ ุฌุฏูู ุฎุทุท ุงูุณุฏุงุฏ ุงูููุชุฑุญุฉ</h3>
                <span id="plansTableCount" class="text-sm text-slate-500"></span>
            </div>
            <div class="table-scroll">
                <table class="w-full text-xs">
                    <thead class="bg-indigo-50 text-indigo-700">
                        <tr>
                            <th class="px-3 py-2 text-right">ุฑูู ุงููุงุชูุฑุฉ</th>
                            <th class="px-3 py-2 text-right">ุงูุนููู</th>
                            <th class="px-3 py-2 text-right">ุงููุจูุบ ุงููุชุจูู</th>
                            <th class="px-3 py-2 text-right">ุฏุฑุฌุฉ ุงููุฎุงุทุฑุฉ</th>
                            <th class="px-3 py-2 text-right">ุงูุฎุทุฉ ุงูููุชุฑุญุฉ</th>
                            <th class="px-3 py-2 text-right">ุจุฏุงูุฉ ุงูุฎุทุฉ</th>
                            <th class="px-3 py-2 text-right">ุฅุฌุฑุงุกุงุช</th>
                        </tr>
                    </thead>
                    <tbody id="plansTable" class="divide-y divide-slate-100">
                        <tr><td colspan="7" class="px-4 py-10 text-center text-slate-500">ุฌุงุฑู ุชุญููู ุงูุจูุงูุงุช...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="card-gradient shape-rounded shadow-2xl p-6 mb-8 accent-emerald">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-xl font-bold text-slate-800">๐ง ุฌุฏูู ุงููุฏููุนุงุช ุงููุฑุชุจุทุฉ ุจุงููุฎุงุทุฑ</h3>
                <span id="paymentsTableCount" class="text-sm text-slate-500"></span>
            </div>
            <div class="table-scroll">
                <table class="w-full text-xs">
                    <thead class="bg-emerald-50 text-emerald-700">
                        <tr>
                            <th class="px-3 py-2 text-right">ุฑูู ุงูุฏูุนุฉ</th>
                            <th class="px-3 py-2 text-right">ุงูุนููู</th>
                            <th class="px-3 py-2 text-right">ูููุฉ ุงูุฏูุนุฉ</th>
                            <th class="px-3 py-2 text-right">ุชุงุฑูุฎ ุงูุฏูุนุฉ</th>
                            <th class="px-3 py-2 text-right">ุงููุฑุน</th>
                            <th class="px-3 py-2 text-right">ุงูุญุงูุฉ</th>
                            <th class="px-3 py-2 text-right">ุฅุฌุฑุงุกุงุช</th>
                        </tr>
                    </thead>
                    <tbody id="paymentsTable" class="divide-y divide-slate-100">
                        <tr><td colspan="7" class="px-4 py-10 text-center text-slate-500">ุฌุงุฑู ุชุญููู ุงูุจูุงูุงุช...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- ููุงูุฐ ุงูุชุญูู ุงูุณุฑูุนุฉ -->
    <div id="riskModal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/40 px-4">
        <div class="bg-white w-full max-w-3xl rounded-2xl shadow-2xl p-6 space-y-4">
            <div class="flex items-center justify-between">
                <h3 class="text-xl font-bold text-slate-800">ุฅุฏุงุฑุฉ ุชูููู ูุฎุงุทุฑ</h3>
                <button onclick="toggleModal('riskModal', false)" class="text-slate-500 hover:text-rose-600"><i class="fas fa-times"></i></button>
            </div>
            <form id="riskForm" class="grid grid-cols-1 md:grid-cols-2 gap-4" onsubmit="submitRiskForm(event)">
                <input type="hidden" id="riskId" />
                <label class="space-y-1">
                    <span class="text-sm text-slate-600">ุฑูู ุงูุนููู</span>
                    <input id="riskCustomerId" type="number" class="w-full border rounded-lg px-3 py-2" required />
                </label>
                <label class="space-y-1">
                    <span class="text-sm text-slate-600">ุชุงุฑูุฎ ุงูุชูููู</span>
                    <input id="riskDate" type="date" class="w-full border rounded-lg px-3 py-2" required />
                </label>
                <label class="space-y-1">
                    <span class="text-sm text-slate-600">ุฏุฑุฌุฉ ุงููุฎุงุทุฑุฉ</span>
                    <input id="riskScore" type="number" step="0.1" min="0" max="100" class="w-full border rounded-lg px-3 py-2" required />
                </label>
                <label class="space-y-1">
                    <span class="text-sm text-slate-600">ูุณุชูู ุงููุฎุงุทุฑุฉ</span>
                    <select id="riskLevel" class="w-full border rounded-lg px-3 py-2" required>
                        <option value="LOW">ููุฎูุถ</option>
                        <option value="MEDIUM">ูุชูุณุท</option>
                        <option value="HIGH">ูุฑุชูุน</option>
                        <option value="CRITICAL">ุญุฑุฌ</option>
                    </select>
                </label>
                <label class="space-y-1 md:col-span-2">
                    <span class="text-sm text-slate-600">ุงูุชูุตูุงุช</span>
                    <textarea id="riskNotes" rows="3" class="w-full border rounded-lg px-3 py-2"></textarea>
                </label>
                <label class="space-y-1 md:col-span-2">
                    <span class="text-sm text-slate-600">ุนูุงูู ุงููุฎุงุทุฑุฉ (JSON ุงุฎุชูุงุฑู)</span>
                    <textarea id="riskFactors" rows="3" class="w-full border rounded-lg px-3 py-2" placeholder='{"late_payments":2}'></textarea>
                </label>
                <div class="md:col-span-2 flex justify-end gap-3">
                    <button type="button" onclick="toggleModal('riskModal', false)" class="px-4 py-2 rounded-lg border text-slate-700">ุฅูุบุงุก</button>
                    <button type="submit" class="px-5 py-2 rounded-lg bg-sky-700 text-white font-semibold">ุญูุธ</button>
                </div>
            </form>
        </div>
    </div>

    <div id="planModal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/40 px-4">
        <div class="bg-white w-full max-w-4xl rounded-2xl shadow-2xl p-6 space-y-4">
            <div class="flex items-center justify-between">
                <h3 class="text-xl font-bold text-slate-800">ุฅุฏุงุฑุฉ ุฎุทุฉ ุณุฏุงุฏ</h3>
                <button onclick="toggleModal('planModal', false)" class="text-slate-500 hover:text-rose-600"><i class="fas fa-times"></i></button>
            </div>
            <form id="planForm" class="grid grid-cols-1 md:grid-cols-2 gap-4" onsubmit="submitPlanForm(event)">
                <input type="hidden" id="planId" />
                <label class="space-y-1">
                    <span class="text-sm text-slate-600">ุฑูู ุงูุฎุทุฉ</span>
                    <input id="planNumber" class="w-full border rounded-lg px-3 py-2" required />
                </label>
                <label class="space-y-1">
                    <span class="text-sm text-slate-600">ุงููุงุชูุฑุฉ ุงููุฑุชุจุทุฉ</span>
                    <select id="planInvoice" class="w-full border rounded-lg px-3 py-2" onchange="onInvoiceChange()" required></select>
                </label>
                <label class="space-y-1">
                    <span class="text-sm text-slate-600">ุฑูู ุงูุนููู</span>
                    <input id="planCustomer" class="w-full border rounded-lg px-3 py-2" readonly />
                </label>
                <label class="space-y-1">
                    <span class="text-sm text-slate-600">ุงููุจูุบ ุงูููู</span>
                    <input id="planTotal" type="number" step="0.01" class="w-full border rounded-lg px-3 py-2" required />
                </label>
                <label class="space-y-1">
                    <span class="text-sm text-slate-600">ุงููุจูุบ ุงููุชุจูู</span>
                    <input id="planRemaining" type="number" step="0.01" class="w-full border rounded-lg px-3 py-2" required />
                </label>
                <label class="space-y-1">
                    <span class="text-sm text-slate-600">ุนุฏุฏ ุงูุฏูุนุงุช</span>
                    <input id="planInstallments" type="number" min="1" class="w-full border rounded-lg px-3 py-2" onchange="recalcInstallmentAmount()" required />
                </label>
                <label class="space-y-1">
                    <span class="text-sm text-slate-600">ูููุฉ ุงูุฏูุนุฉ</span>
                    <input id="planInstallmentAmount" type="number" step="0.01" class="w-full border rounded-lg px-3 py-2" required />
                </label>
                <label class="space-y-1">
                    <span class="text-sm text-slate-600">ุชุงุฑูุฎ ุจุฏุงูุฉ ุงูุฎุทุฉ</span>
                    <input id="planStart" type="date" class="w-full border rounded-lg px-3 py-2" onchange="recalcEndDate()" required />
                </label>
                <label class="space-y-1">
                    <span class="text-sm text-slate-600">ุชุงุฑูุฎ ููุงูุฉ ุงูุฎุทุฉ</span>
                    <input id="planEnd" type="date" class="w-full border rounded-lg px-3 py-2" required />
                </label>
                <label class="space-y-1">
                    <span class="text-sm text-slate-600">ุญุงูุฉ ุงูุฎุทุฉ</span>
                    <select id="planStatus" class="w-full border rounded-lg px-3 py-2" required>
                        <option value="active">ูุดุทุฉ</option>
                        <option value="in_progress">ููุฏ ุงูุชูููุฐ</option>
                        <option value="completed">ููุชููุฉ</option>
                        <option value="overdue">ูุชุฃุฎุฑุฉ</option>
                        <option value="paused">ูุชูููุฉ</option>
                    </select>
                </label>
                <label class="space-y-1">
                    <span class="text-sm text-slate-600">ุฏุฑุฌุฉ ุงููุฎุงุทุฑุฉ ุนูุฏ ุงูุฅูุดุงุก</span>
                    <input id="planRiskScore" type="number" step="0.1" min="0" max="100" class="w-full border rounded-lg px-3 py-2" />
                </label>
                <label class="space-y-1">
                    <span class="text-sm text-slate-600">ูุณุชูู ุงููุฎุงุทุฑุฉ</span>
                    <select id="planRiskLevel" class="w-full border rounded-lg px-3 py-2">
                        <option value="">โ</option>
                        <option value="LOW">ููุฎูุถ</option>
                        <option value="MEDIUM">ูุชูุณุท</option>
                        <option value="HIGH">ูุฑุชูุน</option>
                        <option value="CRITICAL">ุญุฑุฌ</option>
                    </select>
                </label>
                <div class="md:col-span-2 flex justify-end gap-3">
                    <button type="button" onclick="toggleModal('planModal', false)" class="px-4 py-2 rounded-lg border text-slate-700">ุฅูุบุงุก</button>
                    <button type="submit" class="px-5 py-2 rounded-lg bg-indigo-700 text-white font-semibold">ุญูุธ ุงูุฎุทุฉ</button>
                </div>
            </form>
        </div>
    </div>

    <div id="paymentModal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/40 px-4">
        <div class="bg-white w-full max-w-3xl rounded-2xl shadow-2xl p-6 space-y-4">
            <div class="flex items-center justify-between">
                <h3 class="text-xl font-bold text-slate-800">ุชุณุฌูู ุฏูุนุฉ</h3>
                <button onclick="toggleModal('paymentModal', false)" class="text-slate-500 hover:text-rose-600"><i class="fas fa-times"></i></button>
            </div>
            <form id="paymentForm" class="grid grid-cols-1 md:grid-cols-2 gap-4" onsubmit="submitPaymentForm(event)">
                <input type="hidden" id="paymentId" />
                <label class="space-y-1">
                    <span class="text-sm text-slate-600">ุฑูู ุงูุฏูุนุฉ</span>
                    <input id="paymentNumber" class="w-full border rounded-lg px-3 py-2" />
                </label>
                <label class="space-y-1">
                    <span class="text-sm text-slate-600">ุชุงุฑูุฎ ุงูุฏูุนุฉ</span>
                    <input id="paymentDate" type="date" class="w-full border rounded-lg px-3 py-2" required />
                </label>
                <label class="space-y-1">
                    <span class="text-sm text-slate-600">ุงููุงุชูุฑุฉ (ุงุฎุชูุงุฑู ูุฑุจุท ุงูุชุญุตูู)</span>
                    <select id="paymentInvoice" class="w-full border rounded-lg px-3 py-2" onchange="onPaymentInvoiceChange()">
                        <option value="">โ</option>
                    </select>
                </label>
                <label class="space-y-1">
                    <span class="text-sm text-slate-600">ุฑูู ุงูุนููู</span>
                    <input id="paymentCustomer" class="w-full border rounded-lg px-3 py-2" required />
                </label>
                <label class="space-y-1">
                    <span class="text-sm text-slate-600">ูููุฉ ุงูุฏูุนุฉ</span>
                    <input id="paymentAmount" type="number" step="0.01" class="w-full border rounded-lg px-3 py-2" required />
                </label>
                <label class="space-y-1">
                    <span class="text-sm text-slate-600">ุทุฑููุฉ ุงูุฏูุน</span>
                    <select id="paymentMethod" class="w-full border rounded-lg px-3 py-2" required>
                        <option value="BANK_TRANSFER">ุญูุงูุฉ ุจูููุฉ</option>
                        <option value="CARD">ุจุทุงูุฉ</option>
                        <option value="CASH">ููุฏู</option>
                        <option value="CHEQUE">ุดูู</option>
                    </select>
                </label>
                <label class="space-y-1">
                    <span class="text-sm text-slate-600">ุญุงูุฉ ุงูุฏูุนุฉ</span>
                    <select id="paymentStatus" class="w-full border rounded-lg px-3 py-2" required>
                        <option value="COMPLETED">ููุชููุฉ</option>
                        <option value="PENDING">ููุฏ ุงููุฑุงุฌุนุฉ</option>
                        <option value="FAILED">ูุงุดูุฉ</option>
                    </select>
                </label>
                <label class="space-y-1 md:col-span-2">
                    <span class="text-sm text-slate-600">ููุงุญุธุงุช</span>
                    <textarea id="paymentNotes" rows="2" class="w-full border rounded-lg px-3 py-2"></textarea>
                </label>
                <div class="md:col-span-2 flex justify-end gap-3">
                    <button type="button" onclick="toggleModal('paymentModal', false)" class="px-4 py-2 rounded-lg border text-slate-700">ุฅูุบุงุก</button>
                    <button type="submit" class="px-5 py-2 rounded-lg bg-emerald-700 text-white font-semibold">ุญูุธ ุงูุฏูุนุฉ</button>
                </div>
            </form>
        </div>
    </div>

    <div id="infoModal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/40 px-4">
        <div class="bg-white w-full max-w-3xl rounded-2xl shadow-2xl p-6 space-y-3">
            <div class="flex items-center justify-between">
                <h3 class="text-lg font-bold text-slate-800" id="infoTitle">ุชูุงุตูู</h3>
                <button onclick="toggleModal('infoModal', false)" class="text-slate-500 hover:text-rose-600"><i class="fas fa-times"></i></button>
            </div>
            <pre id="infoBody" class="bg-slate-50 border rounded-xl p-4 text-sm overflow-auto max-h-[400px]"></pre>
        </div>
    </div>

    <script>
        const API_BASE = window.location.origin;
        const ENTITY_ID = window.getFinanceEntityId ? window.getFinanceEntityId() : 'HQ001';
        const ENTITY_PARAM = encodeURIComponent(ENTITY_ID);

        let store = {
            invoices: [],
            payments: [],
            plans: [],
            risks: [],
            forecasts: []
        };

        let lastSuggestedPlans = [];
        let currentPlanId = null;
        let currentRiskId = null;
        let currentPaymentId = null;

        let riskChartInstance = null;
        let paymentsChartInstance = null;

        async function loadData() {
            try {
                const [invoiceRes, paymentRes, planRes, riskRes, forecastRes] = await Promise.all([
                    fetch(`${API_BASE}/finance/invoices`),
                    fetch(`${API_BASE}/finance/payments?entity_id=${ENTITY_PARAM}`),
                    fetch(`${API_BASE}/finance/payment-plans?entity_id=${ENTITY_ID}`),
                    fetch(`${API_BASE}/finance/ai-risk-scores?entity_id=${ENTITY_ID}`),
                    fetch(`${API_BASE}/finance/ai-forecasts?entity_id=${ENTITY_ID}`)
                ]);

                const [invoiceData, paymentData, planData, riskData, forecastData] = await Promise.all([
                    invoiceRes.json(),
                    paymentRes.json(),
                    planRes.json(),
                    riskRes.json(),
                    forecastRes.json()
                ]);

                store.invoices = invoiceData.invoices || [];
                store.payments = paymentData.payments || [];
                store.plans = planData.plans || [];
                store.risks = riskData.rows || [];
                store.forecasts = forecastData.forecasts || [];

                populateInvoiceSelects();

                renderStats();
                renderInsights();
                renderTables();
                renderCharts();
            } catch (error) {
                console.error('ุฎุทุฃ ูู ุชุญููู ุงูุจูุงูุงุช:', error);
            }
        }

        function renderStats() {
            const openInvoices = store.invoices.filter(i => ['UNPAID', 'PARTIAL', 'OVERDUE'].includes(String(i.status || '').toUpperCase()));
            document.getElementById('openInvoices').textContent = openInvoices.length.toLocaleString('ar-SA');
            document.getElementById('totalPayments').textContent = formatMoney(sum(store.payments, 'payment_amount'));
            document.getElementById('riskCount').textContent = store.risks.length.toLocaleString('ar-SA');
            document.getElementById('plansCount').textContent = store.plans.length.toLocaleString('ar-SA');
        }

        function renderInsights() {
            const forecastSorted = [...store.forecasts].sort((a, b) => new Date(a.created_at) - new Date(b.created_at));
            const forecast90 = forecastSorted.slice(0, 3).reduce((sumValue, f) => sumValue + parseFloat(f.forecast_amount || 0), 0);
            const highRisk = store.risks.filter(r => ['HIGH', 'CRITICAL'].includes(String(r.risk_level || '').toUpperCase()));
            const overdueInvoices = store.invoices.filter(i => String(i.status || '').toUpperCase() === 'OVERDUE');

            document.getElementById('forecastInsight').textContent = `ุชุญุตูู ูุชููุน ุฎูุงู 90 ููู: ${formatMoney(forecast90)}`;
            document.getElementById('riskInsight').textContent = `ุนุฏุฏ ุนููุงุก ุงููุฎุงุทุฑ ุงููุฑุชูุนุฉ: ${highRisk.length}`;
            document.getElementById('policyInsight').textContent = overdueInvoices.length
                ? `ุชุญุชุงุฌ ${overdueInvoices.length} ูุงุชูุฑุฉ ูุชุฃุฎุฑุฉ ุฅูู ูุฑุงุฌุนุฉ ุดุฑูุท ุงูุฏูุน.`
                : 'ูุง ุชูุฌุฏ ููุงุชูุฑ ูุชุฃุฎุฑุฉ ุญุฑุฌุฉ ุญุงููุงู.';
        }

        function renderTables() {
            const riskRows = store.risks.map(r => `
                <tr class="hover:bg-sky-50">
                    <td class="px-3 py-2">${r.risk_id ?? '-'}</td>
                    <td class="px-3 py-2">${sanitizeText(r.customer_id)}</td>
                    <td class="px-3 py-2">${formatPercent(r.risk_score)}</td>
                    <td class="px-3 py-2">${translateRiskLevel(r.risk_level)}</td>
                    <td class="px-3 py-2">${truncate(sanitizeText(r.recommendations))}</td>
                    <td class="px-3 py-2">${formatDate(r.assessment_date)}</td>
                    <td class="px-3 py-2">
                        <div class="flex flex-wrap gap-2">
                            <button class="text-xs px-3 py-1 rounded-full bg-slate-100" onclick="viewRisk(${r.risk_id})">ูุนุงููุฉ</button>
                            <button class="text-xs px-3 py-1 rounded-full bg-sky-600 text-white" onclick="openRiskForm(${r.risk_id})">ุชุนุฏูู</button>
                            <button class="text-xs px-3 py-1 rounded-full bg-rose-600 text-white" onclick="deleteRisk(${r.risk_id})">ุญุฐู</button>
                        </div>
                    </td>
                </tr>
            `).join('');
            document.getElementById('riskTable').innerHTML = riskRows || `<tr><td colspan="7" class="px-4 py-10 text-center text-slate-500">ูุง ุชูุฌุฏ ุจูุงูุงุช</td></tr>`;
            document.getElementById('riskTableCount').textContent = `ุนุฏุฏ ุงูุตููู: ${store.risks.length}`;

            lastSuggestedPlans = buildSuggestedPlans();
            const planSource = store.plans.length ? store.plans : lastSuggestedPlans;
            const planRows = planSource.map(p => {
                const planId = p.plan_id || null;
                const invoiceLabel = sanitizeText(p.invoice_number || p.invoice_id || p.invoice);
                const customerLabel = sanitizeText(p.customer_name_ar || p.customer_name || p.customer_id);
                const remaining = p.remaining_amount ?? p.total_amount ?? 0;
                const riskScore = p.risk_score_at_creation ?? p.risk_score ?? 0;
                const planText = p.plan_text || `ุนุฏุฏ ${p.number_of_installments || 0} ร ${formatMoney(p.installment_amount || 0)} (${translatePlanStatus(p.status)})`;
                const startDate = formatDate(p.start_date || p.startDate);
                const actionButtons = planId
                    ? `<div class="flex flex-wrap gap-2">
                            <button class="text-xs px-3 py-1 rounded-full bg-slate-100" onclick="viewPlan(${planId})">ูุนุงููุฉ</button>
                            <button class="text-xs px-3 py-1 rounded-full bg-indigo-600 text-white" onclick="openPlanForm(${planId})">ุชุนุฏูู</button>
                            <button class="text-xs px-3 py-1 rounded-full bg-rose-600 text-white" onclick="deletePlan(${planId})">ุญุฐู</button>
                       </div>`
                    : `<button class="text-xs px-3 py-1 rounded-full bg-emerald-600 text-white" onclick="openPlanForm(null, ${p.invoice_id || 'null'})">ุงุนุชูุงุฏ</button>`;

                return `
                    <tr class="hover:bg-indigo-50">
                        <td class="px-3 py-2">${invoiceLabel}</td>
                        <td class="px-3 py-2">${customerLabel}</td>
                        <td class="px-3 py-2 font-semibold text-emerald-700">${formatMoney(remaining)}</td>
                        <td class="px-3 py-2">${formatPercent(riskScore)}</td>
                        <td class="px-3 py-2">${planText}</td>
                        <td class="px-3 py-2">${startDate}</td>
                        <td class="px-3 py-2">${actionButtons}</td>
                    </tr>`;
            }).join('');
            document.getElementById('plansTable').innerHTML = planRows || `<tr><td colspan="7" class="px-4 py-10 text-center text-slate-500">ูุง ุชูุฌุฏ ุจูุงูุงุช</td></tr>`;
            document.getElementById('plansTableCount').textContent = `ุนุฏุฏ ุงูุตููู: ${planSource.length}`;

            const paymentRows = store.payments.map(p => {
                const pid = p.payment_id || p.id;
                return `
                    <tr class="hover:bg-emerald-50">
                        <td class="px-3 py-2">${sanitizeText(p.payment_number || pid)}</td>
                        <td class="px-3 py-2">${sanitizeText(p.customer_id || p.customer_name_ar || p.customer_name)}</td>
                        <td class="px-3 py-2 font-semibold text-emerald-700">${formatMoney(p.payment_amount)}</td>
                        <td class="px-3 py-2">${formatDate(p.payment_date)}</td>
                        <td class="px-3 py-2">${sanitizeText(p.branch_id)}</td>
                        <td class="px-3 py-2">${translateStatus(p.status)}</td>
                        <td class="px-3 py-2">
                            <div class="flex flex-wrap gap-2">
                                <button class="text-xs px-3 py-1 rounded-full bg-slate-100" onclick="viewPayment(${pid})">ูุนุงููุฉ</button>
                                <button class="text-xs px-3 py-1 rounded-full bg-emerald-600 text-white" onclick="openPaymentForm(${pid})">ุชุนุฏูู</button>
                                <button class="text-xs px-3 py-1 rounded-full bg-rose-600 text-white" onclick="deletePayment(${pid})">ุญุฐู</button>
                            </div>
                        </td>
                    </tr>`;
            }).join('');
            document.getElementById('paymentsTable').innerHTML = paymentRows || `<tr><td colspan="7" class="px-4 py-10 text-center text-slate-500">ูุง ุชูุฌุฏ ุจูุงูุงุช</td></tr>`;
            document.getElementById('paymentsTableCount').textContent = `ุนุฏุฏ ุงูุตููู: ${store.payments.length}`;
        }

        function renderCharts() {
            const riskCounts = store.risks.reduce((acc, r) => {
                const level = translateRiskLevel(r.risk_level) || 'ุบูุฑ ูุญุฏุฏ';
                acc[level] = (acc[level] || 0) + 1;
                return acc;
            }, {});
            const riskCtx = document.getElementById('riskChart').getContext('2d');
            if (riskChartInstance) riskChartInstance.destroy();
            riskChartInstance = new Chart(riskCtx, {
                type: 'bar',
                data: {
                    labels: Object.keys(riskCounts).length ? Object.keys(riskCounts) : ['ูุง ุชูุฌุฏ ุจูุงูุงุช'],
                    datasets: [{
                        data: Object.values(riskCounts).length ? Object.values(riskCounts) : [0],
                        backgroundColor: ['#ef4444', '#f59e0b', '#10b981', '#6366f1']
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
            });

            const monthly = groupByMonth(store.payments, 'payment_date', 'payment_amount');
            const paymentCtx = document.getElementById('paymentsChart').getContext('2d');
            if (paymentsChartInstance) paymentsChartInstance.destroy();
            paymentsChartInstance = new Chart(paymentCtx, {
                type: 'line',
                data: {
                    labels: Object.keys(monthly),
                    datasets: [{
                        label: 'ุงููุฏููุนุงุช',
                        data: Object.values(monthly),
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.2)',
                        tension: 0.35
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });
        }

        function buildSuggestedPlans() {
            const riskMap = new Map(store.risks.map(r => [String(r.customer_id), r]));
            const paymentsByCustomer = store.payments.reduce((acc, p) => {
                const key = String(p.customer_id || p.customer_name_ar || p.customer_name || 'ุบูุฑ ูุญุฏุฏ');
                if (!acc[key]) acc[key] = [];
                acc[key].push(p);
                return acc;
            }, {});

            const overdueInvoices = store.invoices.filter(i => ['OVERDUE', 'PARTIAL', 'UNPAID'].includes(String(i.status || '').toUpperCase()));

            return overdueInvoices.map(inv => {
                const customerKey = String(inv.customer_id || inv.customer_name_ar || inv.customer_name || 'ุบูุฑ ูุญุฏุฏ');
                const risk = riskMap.get(String(inv.customer_id)) || {};
                const avgPaid = average((paymentsByCustomer[customerKey] || []).map(p => parseFloat(p.payment_amount || 0))) || 0;
                const remaining = parseFloat(inv.remaining_amount || 0);
                const installment = avgPaid > 0 ? avgPaid : Math.max(remaining / 6, 500);
                const installments = Math.max(2, Math.ceil(remaining / installment));
                const startDate = new Date();
                startDate.setMonth(startDate.getMonth() + 1);
                const startText = startDate.toLocaleDateString('ar-SA');
                const planText = `ุฎุทุฉ ููุชุฑุญุฉ: ${installments} ุฏูุนุฉ ร ${formatMoney(installment)}.`;
                return {
                    invoice_id: inv.invoice_id,
                    invoice_number: inv.invoice_number || inv.invoice_id,
                    customer_name: inv.customer_name_ar || inv.customer_name || inv.customer_id,
                    customer_id: inv.customer_id,
                    remaining_amount: remaining,
                    risk_score: risk.risk_score || 0,
                    risk_level: risk.risk_level,
                    plan_text: planText,
                    start_date: startText
                };
            }).slice(0, 20);
        }

        function groupByMonth(rows, dateKey, valueKey) {
            const grouped = rows.reduce((acc, row) => {
                const date = row[dateKey] ? new Date(row[dateKey]) : null;
                const label = date ? `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}` : 'ุบูุฑ ูุญุฏุฏ';
                acc[label] = (acc[label] || 0) + parseFloat(row[valueKey] || 0);
                return acc;
            }, {});
            const ordered = Object.keys(grouped).sort().reduce((acc, key) => {
                acc[key] = grouped[key];
                return acc;
            }, {});
            return ordered;
        }

        function translateRiskLevel(value) {
            const map = { HIGH: 'ูุฑุชูุน', MEDIUM: 'ูุชูุณุท', LOW: 'ููุฎูุถ', CRITICAL: 'ุญุฑุฌ' };
            return map[String(value || '').toUpperCase()] || 'ุบูุฑ ูุญุฏุฏ';
        }

        function translateStatus(value) {
            const map = {
                PAID: 'ูุฏููุนุฉ',
                UNPAID: 'ุบูุฑ ูุฏููุนุฉ',
                PARTIAL: 'ูุฏููุนุฉ ุฌุฒุฆููุง',
                OVERDUE: 'ูุชุฃุฎุฑุฉ',
                PENDING: 'ููุฏ ุงููุฑุงุฌุนุฉ',
                APPROVED: 'ูุนุชูุฏุฉ'
            };
            return map[String(value || '').toUpperCase()] || 'ุบูุฑ ูุญุฏุฏ';
        }

        function translatePlanStatus(value) {
            const map = {
                ACTIVE: 'ูุดุทุฉ',
                IN_PROGRESS: 'ููุฏ ุงูุชูููุฐ',
                COMPLETED: 'ููุชููุฉ',
                OVERDUE: 'ูุชุฃุฎุฑุฉ',
                PAUSED: 'ูุชูููุฉ'
            };
            return map[String(value || '').toUpperCase()] || 'ุบูุฑ ูุญุฏุฏ';
        }

        function formatMoney(value) {
            const num = parseFloat(value || 0);
            return num.toLocaleString('ar-SA') + ' ุฑ.ุณ';
        }

        function formatDate(value) {
            if (!value) return '-';
            return new Date(value).toLocaleDateString('ar-SA');
        }

        function formatPercent(value) {
            if (value === null || value === undefined || value === '') return '-';
            const num = parseFloat(value || 0);
            return `${num.toFixed(1)}%`;
        }

        function truncate(value) {
            if (value === null || value === undefined) return '-';
            const text = typeof value === 'string' ? value : JSON.stringify(value);
            return text.length > 120 ? text.slice(0, 120) + '...' : text;
        }

        function sanitizeText(value) {
            if (value === null || value === undefined) return 'ุบูุฑ ูุญุฏุฏ';
            const text = typeof value === 'string' ? value : JSON.stringify(value);
            const cleaned = text.replace(/[A-Za-z]+/g, '').replace(/\s{2,}/g, ' ').trim();
            return cleaned || 'ุบูุฑ ูุญุฏุฏ';
        }

        function sum(rows, key) {
            return rows.reduce((acc, row) => acc + parseFloat(row[key] || 0), 0);
        }

        function average(values) {
            if (!values.length) return 0;
            return values.reduce((sumValue, val) => sumValue + val, 0) / values.length;
        }

        function downloadAllJSON() {
            const payload = {
                invoices: store.invoices,
                payments: store.payments,
                plans: store.plans,
                risks: store.risks,
                forecasts: store.forecasts
            };
            downloadBlob(JSON.stringify(payload, null, 2), 'ููุงุฐุฌ-ุงููุฎุงุทุฑ-ูุฎุทุฉ-ุงูุฏูุน.json', 'application/json');
        }

        function downloadAllCSV() {
            const rows = [];
            rows.push(['ุชููููุงุช ุงููุฎุงุทุฑ']);
            rows.push(['ุฑูู ุงููุฎุงุทุฑ','ุฑูู ุงูุนููู','ุงูุฏุฑุฌุฉ','ุงููุณุชูู','ุงูุชูุตูุงุช','ุชุงุฑูุฎ ุงูุชูููู']);
            store.risks.forEach(r => rows.push([r.risk_id, r.customer_id, r.risk_score, translateRiskLevel(r.risk_level), sanitizeText(r.recommendations), r.assessment_date]));

            rows.push([]);
            rows.push(['ุฎุทุท ุงูุฏูุน ุงูููุชุฑุญุฉ']);
            rows.push(['ุฑูู ุงููุงุชูุฑุฉ','ุงูุนููู','ุงููุชุจูู','ุฏุฑุฌุฉ ุงููุฎุงุทุฑุฉ','ุงูุฎุทุฉ ุงูููุชุฑุญุฉ','ุจุฏุงูุฉ ุงูุฎุทุฉ']);
            buildSuggestedPlans().forEach(p => rows.push([p.invoice_number, p.customer_name, p.remaining_amount, p.risk_score, p.plan_text, p.start_date]));

            rows.push([]);
            rows.push(['ุงููุฏููุนุงุช']);
            rows.push(['ุฑูู ุงูุฏูุนุฉ','ุงูุนููู','ูููุฉ ุงูุฏูุนุฉ','ุชุงุฑูุฎ ุงูุฏูุนุฉ','ุงููุฑุน','ุงูุญุงูุฉ']);
            store.payments.forEach(p => rows.push([p.payment_number || p.payment_id, p.customer_id || p.customer_name_ar || p.customer_name, p.payment_amount, p.payment_date, p.branch_id, translateStatus(p.status)]));

            const csv = rows.map(r => r.map(v => `"${v ?? ''}"`).join(',')).join('\n');
            downloadBlob(csv, 'ููุงุฐุฌ-ุงููุฎุงุทุฑ-ูุฎุทุฉ-ุงูุฏูุน.csv', 'text/csv;charset=utf-8;');
        }

        function copySummary() {
            const summary = `ููุฎุต ูููุฐุฌ ุงููุฎุงุทุฑ ูุฎุทุท ุงูุฏูุน\n` +
                `ุงูููุงุชูุฑ ุงูููุชูุญุฉ: ${store.invoices.filter(i => ['UNPAID','PARTIAL','OVERDUE'].includes(String(i.status || '').toUpperCase())).length}\n` +
                `ุฅุฌูุงูู ุงููุฏููุนุงุช: ${formatMoney(sum(store.payments, 'payment_amount'))}\n` +
                `ุชููููุงุช ุงููุฎุงุทุฑ: ${store.risks.length}\n` +
                `ุฎุทุท ุงูุณุฏุงุฏ: ${store.plans.length}`;
            navigator.clipboard.writeText(summary).catch(() => {});
        }

        function downloadBlob(content, filename, type) {
            const blob = new Blob([content], { type });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            link.click();
            URL.revokeObjectURL(url);
        }

        function toggleModal(id, show = true) {
            const el = document.getElementById(id);
            if (!el) return;
            el.classList.toggle('hidden', !show);
        }

        function getInvoiceById(invoiceId) {
            return store.invoices.find(inv => String(inv.invoice_id) === String(invoiceId));
        }

        function populateInvoiceSelects() {
            const planSelect = document.getElementById('planInvoice');
            const paymentSelect = document.getElementById('paymentInvoice');
            if (!planSelect || !paymentSelect) return;
            const options = store.invoices.map(inv => {
                const label = `${sanitizeText(inv.invoice_number || inv.invoice_id)} โ ูุชุจูู ${formatMoney(inv.remaining_amount ?? inv.total_amount ?? 0)}`;
                return `<option value="${inv.invoice_id}">${label}</option>`;
            }).join('');
            planSelect.innerHTML = `<option value="">ุงุฎุชุฑ ูุงุชูุฑุฉ</option>${options}`;
            paymentSelect.innerHTML = `<option value="">โ</option>${options}`;
        }

        function onInvoiceChange() {
            const invoiceId = document.getElementById('planInvoice').value;
            const invoice = getInvoiceById(invoiceId);
            if (invoice) {
                document.getElementById('planCustomer').value = invoice.customer_id || '';
                document.getElementById('planTotal').value = invoice.total_amount || invoice.remaining_amount || 0;
                document.getElementById('planRemaining').value = invoice.remaining_amount || 0;
                document.getElementById('planStart').value = (new Date()).toISOString().slice(0, 10);
                recalcInstallmentAmount();
            }
        }

        function onPaymentInvoiceChange() {
            const invoiceId = document.getElementById('paymentInvoice').value;
            const invoice = getInvoiceById(invoiceId);
            if (invoice) {
                document.getElementById('paymentCustomer').value = invoice.customer_id || '';
                document.getElementById('paymentAmount').value = invoice.remaining_amount || invoice.total_amount || 0;
            }
        }

        function recalcInstallmentAmount() {
            const remaining = parseFloat(document.getElementById('planRemaining').value || 0);
            const installments = parseInt(document.getElementById('planInstallments').value || 1, 10);
            const amount = installments ? remaining / installments : remaining;
            document.getElementById('planInstallmentAmount').value = amount.toFixed(2);
            recalcEndDate();
        }

        function addMonths(dateString, months) {
            const d = new Date(dateString);
            d.setMonth(d.getMonth() + months);
            return d.toISOString().slice(0, 10);
        }

        function recalcEndDate() {
            const start = document.getElementById('planStart').value;
            const installments = parseInt(document.getElementById('planInstallments').value || 1, 10);
            if (start) {
                document.getElementById('planEnd').value = addMonths(start, Math.max(installments - 1, 0));
            }
        }

        function safeParseJSON(text) {
            if (!text) return {};
            try { return JSON.parse(text); } catch (e) { return { ููุงุญุธุงุช: text }; }
        }

        function openRiskForm(id = null) {
            const risk = store.risks.find(r => String(r.risk_id) === String(id)) || {};
            document.getElementById('riskId').value = risk.risk_id || '';
            document.getElementById('riskCustomerId').value = risk.customer_id || '';
            document.getElementById('riskDate').value = risk.assessment_date ? String(risk.assessment_date).slice(0, 10) : (new Date()).toISOString().slice(0, 10);
            document.getElementById('riskScore').value = risk.risk_score ?? '';
            document.getElementById('riskLevel').value = String(risk.risk_level || 'MEDIUM').toUpperCase();
            document.getElementById('riskNotes').value = risk.recommendations || '';
            document.getElementById('riskFactors').value = risk.risk_factors ? JSON.stringify(risk.risk_factors, null, 2) : '';
            toggleModal('riskModal', true);
        }

        function viewRisk(id) {
            const risk = store.risks.find(r => String(r.risk_id) === String(id));
            if (!risk) return;
            showInfo('ุชูุงุตูู ุชูููู ุงููุฎุงุทุฑ', {
                ุงูุนููู: risk.customer_id,
                ุงูุฏุฑุฌุฉ: risk.risk_score,
                ุงููุณุชูู: translateRiskLevel(risk.risk_level),
                ุงูุชูุตูุงุช: risk.recommendations,
                ุงูุนูุงูู: risk.risk_factors,
                ุชูุงุตูู_ุงูุญุณุงุจ: risk.calculation_details,
                ุชุงุฑูุฎ: risk.assessment_date
            });
        }

        async function deleteRisk(id) {
            if (!confirm('ูู ุฃูุช ูุชุฃูุฏ ูู ุญุฐู ูุฐุง ุงูุชููููุ')) return;
            const res = await fetch(`${API_BASE}/finance/ai-risk-scores/${id}?entity_id=${ENTITY_PARAM}`, { method: 'DELETE' });
            if (!res.ok) {
                alert('ูุดู ุญุฐู ุงูุชูููู');
                return;
            }
            await loadData();
        }

        async function submitRiskForm(event) {
            event.preventDefault();
            const id = document.getElementById('riskId').value;
            const payload = {
                entity_id: ENTITY_ID,
                entity_type: 'HQ',
                customer_id: document.getElementById('riskCustomerId').value,
                assessment_date: document.getElementById('riskDate').value,
                risk_score: parseFloat(document.getElementById('riskScore').value),
                risk_level: document.getElementById('riskLevel').value,
                recommendations: document.getElementById('riskNotes').value,
                risk_factors: safeParseJSON(document.getElementById('riskFactors').value)
            };

            const url = id ? `${API_BASE}/finance/ai-risk-scores/${id}` : `${API_BASE}/finance/ai-risk-scores`;
            const method = id ? 'PUT' : 'POST';
            const res = await fetch(url, {
                method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!res.ok) {
                alert('ูุดู ุญูุธ ุชูููู ุงููุฎุงุทุฑ');
                return;
            }

            toggleModal('riskModal', false);
            await loadData();
        }

        function openPlanForm(planId = null, suggestedInvoiceId = null) {
            currentPlanId = planId;
            const plan = planId
                ? store.plans.find(p => String(p.plan_id) === String(planId))
                : lastSuggestedPlans.find(p => String(p.invoice_id) === String(suggestedInvoiceId)) || {};

            const invoice = getInvoiceById(plan.invoice_id || suggestedInvoiceId || plan.invoiceId);
            document.getElementById('planId').value = plan.plan_id || '';
            document.getElementById('planNumber').value = plan.plan_number || `PLAN-AI-${Date.now()}`;
            document.getElementById('planInvoice').value = invoice?.invoice_id || '';
            document.getElementById('planCustomer').value = plan.customer_id || invoice?.customer_id || '';
            const remaining = plan.remaining_amount ?? invoice?.remaining_amount ?? plan.total_amount ?? 0;
            document.getElementById('planTotal').value = plan.total_amount ?? invoice?.total_amount ?? remaining;
            document.getElementById('planRemaining').value = remaining;
            document.getElementById('planInstallments').value = plan.number_of_installments || 4;
            document.getElementById('planInstallmentAmount').value = plan.installment_amount || (remaining ? (remaining / (plan.number_of_installments || 4)).toFixed(2) : 0);
            const start = plan.start_date || (new Date()).toISOString().slice(0, 10);
            document.getElementById('planStart').value = String(start).slice(0, 10);
            document.getElementById('planEnd').value = (plan.end_date ? String(plan.end_date).slice(0, 10) : addMonths(start, 3));
            document.getElementById('planStatus').value = String(plan.status || 'active').toLowerCase();
            document.getElementById('planRiskScore').value = plan.risk_score_at_creation || plan.risk_score || '';
            document.getElementById('planRiskLevel').value = plan.risk_level_at_creation || plan.risk_level || '';
            toggleModal('planModal', true);
        }

        function viewPlan(planId) {
            const plan = store.plans.find(p => String(p.plan_id) === String(planId));
            if (!plan) return;
            showInfo('ุชูุงุตูู ุฎุทุฉ ุงูุณุฏุงุฏ', plan);
        }

        async function deletePlan(planId) {
            if (!confirm('ุญุฐู ุฎุทุฉ ุงูุณุฏุงุฏุ')) return;
            const res = await fetch(`${API_BASE}/finance/payment-plans/${planId}`, { method: 'DELETE' });
            if (!res.ok) {
                alert('ูุดู ุญุฐู ุงูุฎุทุฉ');
                return;
            }
            await loadData();
        }

        async function submitPlanForm(event) {
            event.preventDefault();
            const planId = document.getElementById('planId').value;
            const payload = {
                plan_number: document.getElementById('planNumber').value,
                customer_id: document.getElementById('planCustomer').value,
                invoice_id: document.getElementById('planInvoice').value,
                start_date: document.getElementById('planStart').value,
                end_date: document.getElementById('planEnd').value,
                total_amount: parseFloat(document.getElementById('planTotal').value || 0),
                paid_amount: 0,
                remaining_amount: parseFloat(document.getElementById('planRemaining').value || 0),
                number_of_installments: parseInt(document.getElementById('planInstallments').value || 1, 10),
                installment_amount: parseFloat(document.getElementById('planInstallmentAmount').value || 0),
                installment_frequency: 'MONTHLY',
                status: document.getElementById('planStatus').value,
                risk_score_at_creation: document.getElementById('planRiskScore').value || null,
                risk_level_at_creation: document.getElementById('planRiskLevel').value || null,
                entity_id: ENTITY_ID,
                entity_type: 'HQ'
            };

            const url = planId ? `${API_BASE}/finance/payment-plans/${planId}` : `${API_BASE}/finance/payment-plans`;
            const method = planId ? 'PUT' : 'POST';
            const res = await fetch(url, {
                method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!res.ok) {
                alert('ูุดู ุญูุธ ุงูุฎุทุฉ');
                return;
            }

            toggleModal('planModal', false);
            await loadData();
        }

        function openPaymentForm(paymentId = null) {
            currentPaymentId = paymentId;
            const payment = store.payments.find(p => String(p.payment_id) === String(paymentId)) || {};
            document.getElementById('paymentId').value = payment.payment_id || '';
            document.getElementById('paymentNumber').value = payment.payment_number || `PAY-${Date.now()}`;
            document.getElementById('paymentDate').value = payment.payment_date ? String(payment.payment_date).slice(0, 10) : (new Date()).toISOString().slice(0, 10);
            document.getElementById('paymentInvoice').value = '';
            document.getElementById('paymentCustomer').value = payment.customer_id || '';
            document.getElementById('paymentAmount').value = payment.payment_amount || '';
            document.getElementById('paymentMethod').value = payment.payment_method || 'BANK_TRANSFER';
            document.getElementById('paymentStatus').value = payment.status || 'COMPLETED';
            document.getElementById('paymentNotes').value = payment.notes || '';
            toggleModal('paymentModal', true);
        }

        function viewPayment(paymentId) {
            const payment = store.payments.find(p => String(p.payment_id) === String(paymentId));
            if (!payment) return;
            showInfo('ุชูุงุตูู ุงูุฏูุนุฉ', payment);
        }

        async function deletePayment(paymentId) {
            if (!confirm('ุญุฐู ุงูุฏูุนุฉุ')) return;
            const res = await fetch(`${API_BASE}/finance/payments/${paymentId}?entity_id=${ENTITY_PARAM}`, { method: 'DELETE' });
            if (!res.ok) {
                alert('ูุดู ุญุฐู ุงูุฏูุนุฉ');
                return;
            }
            await loadData();
        }

        async function submitPaymentForm(event) {
            event.preventDefault();
            const paymentId = document.getElementById('paymentId').value;
            const invoiceId = document.getElementById('paymentInvoice').value;
            const payload = {
                payment_number: document.getElementById('paymentNumber').value || `PAY-${Date.now()}`,
                payment_date: document.getElementById('paymentDate').value,
                customer_id: document.getElementById('paymentCustomer').value,
                payment_amount: parseFloat(document.getElementById('paymentAmount').value || 0),
                payment_method: document.getElementById('paymentMethod').value,
                status: document.getElementById('paymentStatus').value,
                notes: document.getElementById('paymentNotes').value,
                entity_id: ENTITY_ID,
                customer_name: null
            };

            const url = paymentId ? `${API_BASE}/finance/payments/${paymentId}` : `${API_BASE}/finance/payments`;
            const method = paymentId ? 'PUT' : 'POST';
            const res = await fetch(url, {
                method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!res.ok) {
                alert('ูุดู ุญูุธ ุงูุฏูุนุฉ');
                return;
            }

            const saved = await res.json();
            const savedId = paymentId || saved.payment?.payment_id;

            if (!paymentId && invoiceId && savedId) {
                await fetch(`${API_BASE}/finance/payment-allocations`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ payment_id: savedId, invoice_id: invoiceId, allocated_amount: payload.payment_amount })
                });
            }

            toggleModal('paymentModal', false);
            await loadData();
        }

        function showInfo(title, body) {
            document.getElementById('infoTitle').textContent = title;
            document.getElementById('infoBody').textContent = typeof body === 'string' ? body : JSON.stringify(body, null, 2);
            toggleModal('infoModal', true);
        }

        function printPage() {
            window.print();
        }

        function refreshData() {
            loadData();
        }

        document.addEventListener('DOMContentLoaded', loadData);
    </script>
</body>
</html>
