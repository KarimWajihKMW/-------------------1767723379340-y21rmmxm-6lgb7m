<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ’§ Ø§Ù„ØªØ¯ÙÙ‚Ø§Øª Ø§Ù„Ù†Ù‚Ø¯ÙŠØ© + Ø§Ù„Ù…Ø®Ø§Ø·Ø± + Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ø°ÙƒÙŠØ© - Ù†Ø¸Ø§Ù… Ù†Ø§ÙŠÙˆØ´</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Cairo', sans-serif;
            background: linear-gradient(125deg, #0ea5e9 0%, #6366f1 55%, #14b8a6 100%);
            min-height: 100vh;
        }
        .card-glass {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
        }
        .stat-pill {
            border-radius: 999px;
            box-shadow: 0 18px 30px rgba(15, 23, 42, 0.15);
        }
        .stat-angled {
            border-radius: 28px 6px 28px 6px;
        }
        .stat-rounded {
            border-radius: 28px;
        }
        .chart-container {
            position: relative;
            height: 280px;
        }
        .table-scroll {
            max-height: 520px;
            overflow: auto;
        }
        .section-accent-sky { border-top: 4px solid #0ea5e9; }
        .section-accent-emerald { border-top: 4px solid #10b981; }
        .section-accent-amber { border-top: 4px solid #f59e0b; }
        .section-accent-violet { border-top: 4px solid #8b5cf6; }
        .section-accent-rose { border-top: 4px solid #f43f5e; }
        .chip {
            padding: 6px 12px;
            border-radius: 999px;
            font-weight: 700;
        }
    </style>
</head>
<body>
    <div class="container mx-auto px-4 py-8">
        <div class="mb-8 text-white">
            <h1 class="text-4xl font-bold mb-2">ğŸ’§ Ø§Ù„ØªØ¯ÙÙ‚Ø§Øª Ø§Ù„Ù†Ù‚Ø¯ÙŠØ© + Ø§Ù„Ù…Ø®Ø§Ø·Ø± + Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ø°ÙƒÙŠØ©</h1>
            <p class="text-lg opacity-90">Cash Flow Zone + Financial Risk Zone + Smart Reports (Ø§Ù„ØµÙØ­Ø© 27)</p>
        </div>

        <div class="mb-6 flex flex-wrap gap-3">
            <button onclick="refreshData()" class="bg-white text-sky-700 px-6 py-3 rounded-full font-bold hover:shadow-lg transition flex items-center gap-2">
                <i class="fas fa-rotate"></i>
                ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            </button>
            <button onclick="downloadAllJSON()" class="bg-indigo-600 text-white px-6 py-3 rounded-full font-bold hover:shadow-lg transition flex items-center gap-2">
                <i class="fas fa-file-code"></i>
                ØªÙ†Ø²ÙŠÙ„ JSON Ø´Ø§Ù…Ù„
            </button>
            <button onclick="downloadAllCSV()" class="bg-emerald-600 text-white px-6 py-3 rounded-full font-bold hover:shadow-lg transition flex items-center gap-2">
                <i class="fas fa-file-csv"></i>
                ØªÙ†Ø²ÙŠÙ„ CSV Ø´Ø§Ù…Ù„
            </button>
            <button onclick="printReport()" class="bg-rose-600 text-white px-6 py-3 rounded-full font-bold hover:shadow-lg transition flex items-center gap-2">
                <i class="fas fa-print"></i>
                Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ±
            </button>
        </div>

        <!-- Cash Flow Zone -->
        <div class="card-glass rounded-3xl shadow-2xl p-6 mb-8 section-accent-sky">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-2xl font-bold text-slate-800">ğŸ’§ Ù…Ù†Ø·Ù‚Ø© Ø§Ù„ØªØ¯ÙÙ‚Ø§Øª Ø§Ù„Ù†Ù‚Ø¯ÙŠØ© (Cash Flow Zone)</h2>
                <div class="text-sm text-slate-500">Ù…ØµØ¯Ø± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: finance_cashflow_* + finance_ai_forecasts</div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-5 mb-8">
                <div class="stat-pill bg-gradient-to-br from-sky-500 to-blue-600 text-white p-6">
                    <div class="flex justify-between mb-3"><span>Ø§Ù„ØªØ¯ÙÙ‚ Ø§Ù„Ø¯Ø§Ø®Ù„</span><i class="fas fa-arrow-trend-up text-2xl opacity-70"></i></div>
                    <div id="cashInflow" class="text-3xl font-bold"><div class="animate-pulse">...</div></div>
                </div>
                <div class="stat-angled bg-gradient-to-br from-rose-500 to-red-600 text-white p-6">
                    <div class="flex justify-between mb-3"><span>Ø§Ù„ØªØ¯ÙÙ‚ Ø§Ù„Ø®Ø§Ø±Ø¬</span><i class="fas fa-arrow-trend-down text-2xl opacity-70"></i></div>
                    <div id="cashOutflow" class="text-3xl font-bold"><div class="animate-pulse">...</div></div>
                </div>
                <div class="stat-rounded bg-gradient-to-br from-emerald-500 to-teal-600 text-white p-6">
                    <div class="flex justify-between mb-3"><span>ØµØ§ÙÙŠ Ø§Ù„ØªØ¯ÙÙ‚</span><i class="fas fa-water text-2xl opacity-70"></i></div>
                    <div id="cashNet" class="text-3xl font-bold"><div class="animate-pulse">...</div></div>
                </div>
                <div class="stat-pill bg-gradient-to-br from-indigo-500 to-purple-600 text-white p-6">
                    <div class="flex justify-between mb-3"><span>ØªÙˆÙ‚Ø¹Ø§Øª 30 ÙŠÙˆÙ…</span><i class="fas fa-calendar-day text-2xl opacity-70"></i></div>
                    <div id="forecast30" class="text-3xl font-bold"><div class="animate-pulse">...</div></div>
                </div>
                <div class="stat-angled bg-gradient-to-br from-amber-500 to-orange-600 text-white p-6">
                    <div class="flex justify-between mb-3"><span>ØªÙˆÙ‚Ø¹Ø§Øª 90 ÙŠÙˆÙ…</span><i class="fas fa-calendar-week text-2xl opacity-70"></i></div>
                    <div id="forecast90" class="text-3xl font-bold"><div class="animate-pulse">...</div></div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="card-glass rounded-2xl p-5 shadow-lg section-accent-emerald">
                    <h3 class="text-lg font-bold text-slate-800 mb-4">ğŸ“ˆ Ù…Ø®Ø·Ø· Ø§Ù„ØªØ¯ÙÙ‚ Ø§Ù„Ù†Ù‚Ø¯ÙŠ</h3>
                    <div class="chart-container">
                        <canvas id="cashflowChart"></canvas>
                    </div>
                </div>
                <div class="card-glass rounded-2xl p-5 shadow-lg section-accent-violet">
                    <h3 class="text-lg font-bold text-slate-800 mb-4">ğŸ¤– Ø°ÙƒØ§Ø¡ Ø§ØµØ·Ù†Ø§Ø¹ÙŠ</h3>
                    <div id="cashflowInsights" class="space-y-3 text-sm text-slate-600">
                        <div class="animate-pulse">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
                    </div>
                </div>
                <div class="card-glass rounded-2xl p-5 shadow-lg section-accent-amber">
                    <h3 class="text-lg font-bold text-slate-800 mb-4">ğŸ“Š ØªÙˆØ²ÙŠØ¹ Ø§Ù„ØªØ¯ÙÙ‚Ø§Øª Ø­Ø³Ø¨ Ø§Ù„Ù†ÙˆØ¹</h3>
                    <div class="chart-container">
                        <canvas id="cashflowMixChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Financial Risk Zone -->
        <div class="card-glass rounded-3xl shadow-2xl p-6 mb-8 section-accent-rose">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-2xl font-bold text-slate-800">âš ï¸ Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ù…Ø®Ø§Ø·Ø± Ø§Ù„Ù…Ø§Ù„ÙŠØ© (Financial Risk Zone)</h2>
                <div class="text-sm text-slate-500">Ø±Ø§Ø¯Ø§Ø± Ø§Ù„Ù…Ø®Ø§Ø·Ø± Ø§Ù„Ø°ÙƒÙŠ</div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-5 mb-8">
                <div class="stat-pill bg-gradient-to-br from-red-500 to-rose-600 text-white p-6">
                    <div class="flex justify-between mb-3"><span>Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ø¹Ø§Ù„ÙŠ Ø§Ù„Ù…Ø®Ø§Ø·Ø±</span><i class="fas fa-user-shield text-2xl opacity-70"></i></div>
                    <div id="riskCustomers" class="text-3xl font-bold"><div class="animate-pulse">...</div></div>
                </div>
                <div class="stat-rounded bg-gradient-to-br from-amber-500 to-orange-600 text-white p-6">
                    <div class="flex justify-between mb-3"><span>Ø§Ù„ÙØ±ÙˆØ¹ Ø¹Ø§Ù„ÙŠØ© Ø§Ù„Ù…Ø®Ø§Ø·Ø±</span><i class="fas fa-building text-2xl opacity-70"></i></div>
                    <div id="riskBranches" class="text-3xl font-bold"><div class="animate-pulse">...</div></div>
                </div>
                <div class="stat-angled bg-gradient-to-br from-purple-500 to-indigo-600 text-white p-6">
                    <div class="flex justify-between mb-3"><span>Ø§Ù„Ø¨Ø±Ø§Ù…Ø¬ Ø¹Ø§Ù„ÙŠØ© Ø§Ù„Ù…Ø®Ø§Ø·Ø±</span><i class="fas fa-layer-group text-2xl opacity-70"></i></div>
                    <div id="riskPrograms" class="text-3xl font-bold"><div class="animate-pulse">...</div></div>
                </div>
                <div class="stat-pill bg-gradient-to-br from-sky-500 to-cyan-600 text-white p-6">
                    <div class="flex justify-between mb-3"><span>Ù†Ø³Ø¨Ø© Ø§Ù„Ù…Ø®Ø§Ø·Ø± Ø§Ù„Ø¹Ø§Ù…Ø©</span><i class="fas fa-gauge-high text-2xl opacity-70"></i></div>
                    <div id="overallRisk" class="text-3xl font-bold"><div class="animate-pulse">...</div></div>
                </div>
                <div class="stat-angled bg-gradient-to-br from-emerald-500 to-teal-600 text-white p-6">
                    <div class="flex justify-between mb-3"><span>ØªÙˆÙ‚Ø¹Ø§Øª Ø§Ù„ØªØ¹Ø«Ø± 30 ÙŠÙˆÙ…</span><i class="fas fa-triangle-exclamation text-2xl opacity-70"></i></div>
                    <div id="default30" class="text-3xl font-bold"><div class="animate-pulse">...</div></div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="card-glass rounded-2xl p-5 shadow-lg section-accent-amber">
                    <h3 class="text-lg font-bold text-slate-800 mb-4">ğŸ§­ ØªÙˆØ²ÙŠØ¹ Ù…Ø³ØªÙˆÙŠØ§Øª Ø§Ù„Ù…Ø®Ø§Ø·Ø±</h3>
                    <div class="chart-container">
                        <canvas id="riskLevelChart"></canvas>
                    </div>
                </div>
                <div class="card-glass rounded-2xl p-5 shadow-lg section-accent-emerald">
                    <h3 class="text-lg font-bold text-slate-800 mb-4">ğŸ… Ø£Ø¹Ù„Ù‰ 10 Ø¹Ù…Ù„Ø§Ø¡ Ù…Ø®Ø§Ø·Ø±Ø©</h3>
                    <div id="topRiskCustomers" class="space-y-3 text-sm text-slate-700">
                        <div class="animate-pulse">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
                    </div>
                </div>
                <div class="card-glass rounded-2xl p-5 shadow-lg section-accent-violet">
                    <h3 class="text-lg font-bold text-slate-800 mb-4">ğŸ¤– Ø°ÙƒØ§Ø¡ Ø§ØµØ·Ù†Ø§Ø¹ÙŠ</h3>
                    <div id="riskInsights" class="space-y-3 text-sm text-slate-600">
                        <div class="animate-pulse">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Smart Reports Zone -->
        <div class="card-glass rounded-3xl shadow-2xl p-6 mb-8 section-accent-indigo">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-2xl font-bold text-slate-800">ğŸ“‘ Ù…Ù†Ø·Ù‚Ø© Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ø°ÙƒÙŠØ© (Smart Reports Zone)</h2>
                <div class="text-sm text-slate-500">ØªÙ‚Ø§Ø±ÙŠØ± Ø¬Ø§Ù‡Ø²Ø© Ø¨Ø¶ØºØ·Ø© Ø²Ø±</div>
            </div>
            <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
                <div class="bg-slate-50 rounded-2xl p-5 shadow-inner">
                    <h4 class="font-bold text-slate-800 mb-3">ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</h4>
                    <div class="space-y-2">
                        <button onclick="downloadReport('customer-statement')" class="w-full text-right px-4 py-2 bg-white rounded-xl shadow hover:bg-sky-50">ÙƒØ´Ù Ø­Ø³Ø§Ø¨</button>
                        <button onclick="downloadReport('overdue-customers')" class="w-full text-right px-4 py-2 bg-white rounded-xl shadow hover:bg-sky-50">Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ø§Ù„Ù…ØªØ£Ø®Ø±ÙˆÙ†</button>
                        <button onclick="downloadReport('top-balances')" class="w-full text-right px-4 py-2 bg-white rounded-xl shadow hover:bg-sky-50">Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ø§Ù„Ø£Ø¹Ù„Ù‰ Ø±ØµÙŠØ¯Ù‹Ø§</button>
                    </div>
                </div>
                <div class="bg-slate-50 rounded-2xl p-5 shadow-inner">
                    <h4 class="font-bold text-slate-800 mb-3">ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„ÙØ±ÙˆØ¹</h4>
                    <div class="space-y-2">
                        <button onclick="downloadReport('branch-collections')" class="w-full text-right px-4 py-2 bg-white rounded-xl shadow hover:bg-emerald-50">Ø£Ø¯Ø§Ø¡ Ø§Ù„ØªØ­ØµÙŠÙ„</button>
                        <button onclick="downloadReport('branch-ar')" class="w-full text-right px-4 py-2 bg-white rounded-xl shadow hover:bg-emerald-50">Ø§Ù„Ø°Ù…Ù…</button>
                        <button onclick="downloadReport('branch-cashflow')" class="w-full text-right px-4 py-2 bg-white rounded-xl shadow hover:bg-emerald-50">Ø§Ù„ØªØ¯ÙÙ‚ Ø§Ù„Ù†Ù‚Ø¯ÙŠ</button>
                    </div>
                </div>
                <div class="bg-slate-50 rounded-2xl p-5 shadow-inner">
                    <h4 class="font-bold text-slate-800 mb-3">ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ø­Ø§Ø¶Ù†Ø§Øª</h4>
                    <div class="space-y-2">
                        <button onclick="downloadReport('incubator-programs')" class="w-full text-right px-4 py-2 bg-white rounded-xl shadow hover:bg-violet-50">Ø£Ø¯Ø§Ø¡ Ø§Ù„Ø¨Ø±Ø§Ù…Ø¬</button>
                        <button onclick="downloadReport('incubator-collections')" class="w-full text-right px-4 py-2 bg-white rounded-xl shadow hover:bg-violet-50">Ø§Ù„ØªØ­ØµÙŠÙ„ Ø­Ø³Ø¨ Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬</button>
                        <button onclick="downloadReport('incubator-ar')" class="w-full text-right px-4 py-2 bg-white rounded-xl shadow hover:bg-violet-50">Ø§Ù„Ø°Ù…Ù… Ø­Ø³Ø¨ Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬</button>
                    </div>
                </div>
                <div class="bg-slate-50 rounded-2xl p-5 shadow-inner">
                    <h4 class="font-bold text-slate-800 mb-3">ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ø¥Ù…Ø¨Ø±Ø§Ø·ÙˆØ±ÙŠØ©</h4>
                    <div class="space-y-2">
                        <button onclick="downloadReport('empire-monthly')" class="w-full text-right px-4 py-2 bg-white rounded-xl shadow hover:bg-rose-50">ØªÙ‚Ø±ÙŠØ± Ù…Ø§Ù„ÙŠ Ø´Ù‡Ø±ÙŠ</button>
                        <button onclick="downloadReport('empire-quarterly')" class="w-full text-right px-4 py-2 bg-white rounded-xl shadow hover:bg-rose-50">ØªÙ‚Ø±ÙŠØ± Ù…Ø§Ù„ÙŠ Ø±Ø¨Ø¹ Ø³Ù†ÙˆÙŠ</button>
                        <button onclick="downloadReport('empire-risk')" class="w-full text-right px-4 py-2 bg-white rounded-xl shadow hover:bg-rose-50">ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ø®Ø§Ø·Ø±</button>
                        <button onclick="downloadReport('empire-forecast')" class="w-full text-right px-4 py-2 bg-white rounded-xl shadow hover:bg-rose-50">ØªÙ‚Ø±ÙŠØ± Ø§Ù„ØªÙˆÙ‚Ø¹Ø§Øª</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Cashflow Tables -->
        <div class="card-glass rounded-3xl shadow-2xl p-6 mb-8 section-accent-sky">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-xl font-bold text-slate-800">ğŸ“„ Ø¬Ø¯ÙˆÙ„ Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ø§Ù„ØªØ¯ÙÙ‚ Ø§Ù„Ù†Ù‚Ø¯ÙŠ</h3>
                <span id="cashflowCount" class="text-sm text-slate-500"></span>
            </div>
            <div class="table-scroll">
                <table class="w-full text-xs">
                    <thead class="bg-sky-50 text-sky-700">
                        <tr>
                            <th class="px-3 py-2 text-right">flow_id</th>
                            <th class="px-3 py-2 text-right">flow_type</th>
                            <th class="px-3 py-2 text-right">amount</th>
                            <th class="px-3 py-2 text-right">description</th>
                            <th class="px-3 py-2 text-right">flow_date</th>
                            <th class="px-3 py-2 text-right">entity_id</th>
                            <th class="px-3 py-2 text-right">created_by</th>
                            <th class="px-3 py-2 text-right">created_at</th>
                            <th class="px-3 py-2 text-right">source</th>
                        </tr>
                    </thead>
                    <tbody id="cashflowTable" class="divide-y divide-slate-100">
                        <tr>
                            <td colspan="9" class="px-4 py-12 text-center text-slate-500">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- AI Forecasts Table -->
        <div class="card-glass rounded-3xl shadow-2xl p-6 mb-8 section-accent-emerald">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-xl font-bold text-slate-800">ğŸ”® Ø¬Ø¯ÙˆÙ„ Ø§Ù„ØªÙˆÙ‚Ø¹Ø§Øª Ø§Ù„Ø°ÙƒÙŠØ©</h3>
                <span id="forecastCount" class="text-sm text-slate-500"></span>
            </div>
            <div class="table-scroll">
                <table class="w-full text-xs">
                    <thead class="bg-emerald-50 text-emerald-700">
                        <tr>
                            <th class="px-3 py-2 text-right">forecast_id</th>
                            <th class="px-3 py-2 text-right">entity_id</th>
                            <th class="px-3 py-2 text-right">forecast_period</th>
                            <th class="px-3 py-2 text-right">forecast_type</th>
                            <th class="px-3 py-2 text-right">forecast_amount</th>
                            <th class="px-3 py-2 text-right">confidence_level</th>
                            <th class="px-3 py-2 text-right">ai_model</th>
                            <th class="px-3 py-2 text-right">ai_insights</th>
                            <th class="px-3 py-2 text-right">created_at</th>
                        </tr>
                    </thead>
                    <tbody id="forecastTable" class="divide-y divide-slate-100">
                        <tr>
                            <td colspan="9" class="px-4 py-12 text-center text-slate-500">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Risk Scores Table -->
        <div class="card-glass rounded-3xl shadow-2xl p-6 section-accent-rose">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-xl font-bold text-slate-800">ğŸ›¡ï¸ Ø¬Ø¯ÙˆÙ„ ØªÙ‚ÙŠÙŠÙ…Ø§Øª Ø§Ù„Ù…Ø®Ø§Ø·Ø±</h3>
                <span id="riskCount" class="text-sm text-slate-500"></span>
            </div>
            <div class="table-scroll">
                <table class="w-full text-xs">
                    <thead class="bg-rose-50 text-rose-700">
                        <tr>
                            <th class="px-3 py-2 text-right">risk_id</th>
                            <th class="px-3 py-2 text-right">customer_id</th>
                            <th class="px-3 py-2 text-right">assessment_date</th>
                            <th class="px-3 py-2 text-right">risk_score</th>
                            <th class="px-3 py-2 text-right">risk_level</th>
                            <th class="px-3 py-2 text-right">risk_factors</th>
                            <th class="px-3 py-2 text-right">calculation_details</th>
                            <th class="px-3 py-2 text-right">recommendations</th>
                            <th class="px-3 py-2 text-right">suggested_actions</th>
                            <th class="px-3 py-2 text-right">entity_type</th>
                            <th class="px-3 py-2 text-right">entity_id</th>
                            <th class="px-3 py-2 text-right">model_version</th>
                            <th class="px-3 py-2 text-right">created_at</th>
                        </tr>
                    </thead>
                    <tbody id="riskTable" class="divide-y divide-slate-100">
                        <tr>
                            <td colspan="13" class="px-4 py-12 text-center text-slate-500">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = window.location.origin;
        const CASHFLOW_ENTITY_ID = '1';
        const AR_ENTITY_ID = 'HQ001';

        let cashflowOverview = null;
        let cashflowOperating = [];
        let cashflowInvesting = [];
        let cashflowFinancing = [];
        let forecasts = [];
        let riskScores = [];
        let invoices = [];
        let payments = [];
        let arAging = [];

        let cashflowChartInstance = null;
        let cashflowMixInstance = null;
        let riskLevelInstance = null;

        async function loadData() {
            try {
                const [overviewRes, operatingRes, investingRes, financingRes, forecastRes, riskRes, invoiceRes, paymentRes, arRes] = await Promise.all([
                    fetch(`${API_BASE}/finance/cashflow/overview?entity_id=${CASHFLOW_ENTITY_ID}`),
                    fetch(`${API_BASE}/finance/cashflow/operating?entity_id=${CASHFLOW_ENTITY_ID}`),
                    fetch(`${API_BASE}/finance/cashflow/investing?entity_id=${CASHFLOW_ENTITY_ID}`),
                    fetch(`${API_BASE}/finance/cashflow/financing?entity_id=${CASHFLOW_ENTITY_ID}`),
                    fetch(`${API_BASE}/finance/ai-forecasts?entity_id=${CASHFLOW_ENTITY_ID}`),
                    fetch(`${API_BASE}/finance/ai-risk-scores?entity_id=${CASHFLOW_ENTITY_ID}`),
                    fetch(`${API_BASE}/finance/invoices`),
                    fetch(`${API_BASE}/finance/payments`),
                    fetch(`${API_BASE}/finance/ar-aging?entity_id=${AR_ENTITY_ID}`)
                ]);

                const [overviewData, operatingData, investingData, financingData, forecastData, riskData, invoiceData, paymentData, arData] = await Promise.all([
                    overviewRes.json(), operatingRes.json(), investingRes.json(), financingRes.json(), forecastRes.json(), riskRes.json(), invoiceRes.json(), paymentRes.json(), arRes.json()
                ]);

                cashflowOverview = overviewData;
                cashflowOperating = operatingData.cashflows || [];
                cashflowInvesting = investingData.cashflows || [];
                cashflowFinancing = financingData.cashflows || [];
                forecasts = forecastData.forecasts || [];
                riskScores = riskData.rows || [];
                invoices = invoiceData.invoices || [];
                payments = paymentData.payments || [];
                arAging = arData.rows || [];

                renderCashflow();
                renderRisk();
                renderTables();
            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', error);
            }
        }

        function renderCashflow() {
            if (!cashflowOverview?.success) return;
            const inflow = cashflowOverview.operating.inflow + cashflowOverview.investing.inflow + cashflowOverview.financing.inflow;
            const outflow = cashflowOverview.operating.outflow + cashflowOverview.investing.outflow + cashflowOverview.financing.outflow;
            const net = cashflowOverview.total_net_cashflow;

            document.getElementById('cashInflow').textContent = formatMoney(inflow);
            document.getElementById('cashOutflow').textContent = formatMoney(outflow);
            document.getElementById('cashNet').textContent = formatMoney(net);

            const forecastSorted = [...forecasts].sort((a, b) => new Date(a.created_at) - new Date(b.created_at));
            const forecast30Val = forecastSorted[0]?.forecast_amount || 0;
            const forecast90Val = forecastSorted.slice(0, 3).reduce((sum, f) => sum + parseFloat(f.forecast_amount || 0), 0);

            document.getElementById('forecast30').textContent = formatMoney(forecast30Val);
            document.getElementById('forecast90').textContent = formatMoney(forecast90Val);

            const insights = forecastSorted.slice(0, 2).map((f, idx) => `
                <div class="bg-slate-50 p-3 rounded-xl">
                    <div class="font-bold">ØªÙ†Ø¨ÙŠÙ‡ ${idx + 1}</div>
                    <div>${extractInsight(f.ai_insights) || 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„Ø§Ø­Ø¸Ø©'}</div>
                </div>
            `).join('') || '<div class="text-slate-500">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙ†Ø¨ÙŠÙ‡Ø§Øª</div>';
            document.getElementById('cashflowInsights').innerHTML = insights;

            const merged = mergeCashflows();
            renderCashflowCharts(merged);
        }

        function renderCashflowCharts(merged) {
            const grouped = groupByDate(merged);
            const labels = Object.keys(grouped).sort();
            const inflowSeries = labels.map(date => grouped[date].inflow);
            const outflowSeries = labels.map(date => Math.abs(grouped[date].outflow));
            const netSeries = labels.map(date => grouped[date].net);

            const ctx = document.getElementById('cashflowChart').getContext('2d');
            if (cashflowChartInstance) cashflowChartInstance.destroy();
            cashflowChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels,
                    datasets: [
                        { label: 'ØªØ¯ÙÙ‚ Ø¯Ø§Ø®Ù„', data: inflowSeries, borderColor: '#0ea5e9', backgroundColor: 'rgba(14, 165, 233, 0.2)', tension: 0.35 },
                        { label: 'ØªØ¯ÙÙ‚ Ø®Ø§Ø±Ø¬', data: outflowSeries, borderColor: '#ef4444', backgroundColor: 'rgba(239, 68, 68, 0.2)', tension: 0.35 },
                        { label: 'ØµØ§ÙÙŠ', data: netSeries, borderColor: '#10b981', backgroundColor: 'rgba(16, 185, 129, 0.2)', tension: 0.35 }
                    ]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });

            const mixTotals = {
                operating: sumAmounts(cashflowOperating),
                investing: sumAmounts(cashflowInvesting),
                financing: sumAmounts(cashflowFinancing)
            };
            const mixCtx = document.getElementById('cashflowMixChart').getContext('2d');
            if (cashflowMixInstance) cashflowMixInstance.destroy();
            cashflowMixInstance = new Chart(mixCtx, {
                type: 'doughnut',
                data: {
                    labels: ['ØªØ´ØºÙŠÙ„ÙŠ', 'Ø§Ø³ØªØ«Ù…Ø§Ø±ÙŠ', 'ØªÙ…ÙˆÙŠÙ„ÙŠ'],
                    datasets: [{
                        data: [Math.abs(mixTotals.operating), Math.abs(mixTotals.investing), Math.abs(mixTotals.financing)],
                        backgroundColor: ['#0ea5e9', '#8b5cf6', '#14b8a6']
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });
        }

        function renderRisk() {
            const totalScores = riskScores.length;
            const highRisk = riskScores.filter(r => ['HIGH', 'CRITICAL'].includes(String(r.risk_level || '').toUpperCase()));
            const uniqueHighRiskCustomers = new Set(highRisk.map(r => r.customer_id)).size;

            const highRiskBranches = new Set(invoices.filter(i => ['HIGH', 'CRITICAL'].includes(String(i.risk_level || '').toUpperCase())).map(i => i.branch_id || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯')).size;
            const highRiskPrograms = new Set(invoices.filter(i => ['HIGH', 'CRITICAL'].includes(String(i.risk_level || '').toUpperCase())).map(i => i.program_id || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯')).size;
            const overallRisk = totalScores ? ((highRisk.length / totalScores) * 100) : 0;
            const default30 = totalScores ? (average(riskScores.map(r => parseFloat(r.risk_score || 0))) / 100) * 100 : 0;

            document.getElementById('riskCustomers').textContent = uniqueHighRiskCustomers;
            document.getElementById('riskBranches').textContent = highRiskBranches;
            document.getElementById('riskPrograms').textContent = highRiskPrograms;
            document.getElementById('overallRisk').textContent = `${overallRisk.toFixed(1)}%`;
            document.getElementById('default30').textContent = `${default30.toFixed(1)}%`;

            const levelCounts = riskScores.reduce((acc, r) => {
                const level = (r.risk_level || 'Unknown').toUpperCase();
                acc[level] = (acc[level] || 0) + 1;
                return acc;
            }, {});
            renderRiskChart(levelCounts);

            const topCustomers = [...riskScores].sort((a, b) => parseFloat(b.risk_score || 0) - parseFloat(a.risk_score || 0)).slice(0, 10);
            document.getElementById('topRiskCustomers').innerHTML = topCustomers.length ? topCustomers.map(c => `
                <div class="flex items-center justify-between bg-amber-50 p-3 rounded-xl">
                    <span>Ø¹Ù…ÙŠÙ„ ${c.customer_id}</span>
                    <span class="chip bg-amber-100 text-amber-700">${parseFloat(c.risk_score || 0).toFixed(1)}</span>
                </div>
            `).join('') : '<div class="text-slate-500">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</div>';

            document.getElementById('riskInsights').innerHTML = `
                <div class="bg-slate-50 p-3 rounded-xl">
                    "${topCustomers[0] ? `Ø§Ù„Ø¹Ù…ÙŠÙ„ ${topCustomers[0].customer_id} Ù„Ø¯ÙŠÙ‡ Ø§Ø­ØªÙ…Ø§Ù„ ØªØ¹Ø«Ø± ${(parseFloat(topCustomers[0].risk_score || 0)).toFixed(1)}%` : 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…ØªØ§Ø­Ø©'}"
                </div>
                <div class="bg-slate-50 p-3 rounded-xl">
                    "${highRiskPrograms ? 'ØªØ­Ø³ÙŠÙ† Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø¨Ø±Ø§Ù…Ø¬ Ø¹Ø§Ù„ÙŠØ© Ø§Ù„Ù…Ø®Ø§Ø·Ø± Ø³ÙŠØ®ÙØ¶ Ù…Ø¤Ø´Ø± Ø§Ù„Ù…Ø®Ø§Ø·Ø± Ø§Ù„Ø¹Ø§Ù….' : 'Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©'}"
                </div>
            `;
        }

        function renderRiskChart(levelCounts) {
            const ctx = document.getElementById('riskLevelChart').getContext('2d');
            if (riskLevelInstance) riskLevelInstance.destroy();
            riskLevelInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Object.keys(levelCounts),
                    datasets: [{
                        data: Object.values(levelCounts),
                        backgroundColor: ['#ef4444', '#f59e0b', '#10b981', '#6366f1']
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
            });
        }

        function renderTables() {
            const merged = mergeCashflows();
            const cashRows = merged.map(row => `
                <tr class="hover:bg-sky-50">
                    <td class="px-3 py-2">${row.flow_id ?? '-'}</td>
                    <td class="px-3 py-2">${row.flow_type ?? '-'}</td>
                    <td class="px-3 py-2 font-semibold text-emerald-700">${formatMoney(row.amount)}</td>
                    <td class="px-3 py-2">${row.description ?? '-'}</td>
                    <td class="px-3 py-2">${formatDate(row.flow_date)}</td>
                    <td class="px-3 py-2">${row.entity_id ?? '-'}</td>
                    <td class="px-3 py-2">${row.created_by ?? '-'}</td>
                    <td class="px-3 py-2">${formatDateTime(row.created_at)}</td>
                    <td class="px-3 py-2">${row.source ?? '-'}</td>
                </tr>
            `).join('');
            document.getElementById('cashflowTable').innerHTML = cashRows || `<tr><td colspan="9" class="px-4 py-12 text-center text-slate-500">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</td></tr>`;
            document.getElementById('cashflowCount').textContent = `Ø¹Ø¯Ø¯ Ø§Ù„ØµÙÙˆÙ: ${merged.length}`;

            const forecastRows = forecasts.map(f => `
                <tr class="hover:bg-emerald-50">
                    <td class="px-3 py-2">${f.forecast_id ?? '-'}</td>
                    <td class="px-3 py-2">${f.entity_id ?? '-'}</td>
                    <td class="px-3 py-2">${f.forecast_period ?? '-'}</td>
                    <td class="px-3 py-2">${f.forecast_type ?? '-'}</td>
                    <td class="px-3 py-2">${formatMoney(f.forecast_amount)}</td>
                    <td class="px-3 py-2">${f.confidence_level ?? '-'}</td>
                    <td class="px-3 py-2">${f.ai_model ?? '-'}</td>
                    <td class="px-3 py-2">${truncate(f.ai_insights)}</td>
                    <td class="px-3 py-2">${formatDateTime(f.created_at)}</td>
                </tr>
            `).join('');
            document.getElementById('forecastTable').innerHTML = forecastRows || `<tr><td colspan="9" class="px-4 py-12 text-center text-slate-500">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</td></tr>`;
            document.getElementById('forecastCount').textContent = `Ø¹Ø¯Ø¯ Ø§Ù„ØµÙÙˆÙ: ${forecasts.length}`;

            const riskRows = riskScores.map(r => `
                <tr class="hover:bg-rose-50">
                    <td class="px-3 py-2">${r.risk_id ?? '-'}</td>
                    <td class="px-3 py-2">${r.customer_id ?? '-'}</td>
                    <td class="px-3 py-2">${formatDate(r.assessment_date)}</td>
                    <td class="px-3 py-2">${r.risk_score ?? '-'}</td>
                    <td class="px-3 py-2">${r.risk_level ?? '-'}</td>
                    <td class="px-3 py-2">${truncate(r.risk_factors)}</td>
                    <td class="px-3 py-2">${truncate(r.calculation_details)}</td>
                    <td class="px-3 py-2">${truncate(r.recommendations)}</td>
                    <td class="px-3 py-2">${truncate(r.suggested_actions)}</td>
                    <td class="px-3 py-2">${r.entity_type ?? '-'}</td>
                    <td class="px-3 py-2">${r.entity_id ?? '-'}</td>
                    <td class="px-3 py-2">${r.model_version ?? '-'}</td>
                    <td class="px-3 py-2">${formatDateTime(r.created_at)}</td>
                </tr>
            `).join('');
            document.getElementById('riskTable').innerHTML = riskRows || `<tr><td colspan="13" class="px-4 py-12 text-center text-slate-500">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</td></tr>`;
            document.getElementById('riskCount').textContent = `Ø¹Ø¯Ø¯ Ø§Ù„ØµÙÙˆÙ: ${riskScores.length}`;
        }

        function mergeCashflows() {
            const tag = (rows, source) => rows.map(r => ({ ...r, source }));
            return [...tag(cashflowOperating, 'operating'), ...tag(cashflowInvesting, 'investing'), ...tag(cashflowFinancing, 'financing')]
                .sort((a, b) => new Date(b.flow_date) - new Date(a.flow_date));
        }

        function groupByDate(rows) {
            return rows.reduce((acc, row) => {
                const date = row.flow_date ? new Date(row.flow_date).toISOString().split('T')[0] : 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
                if (!acc[date]) acc[date] = { inflow: 0, outflow: 0, net: 0 };
                const amount = parseFloat(row.amount || 0);
                if (amount >= 0) acc[date].inflow += amount;
                else acc[date].outflow += amount;
                acc[date].net += amount;
                return acc;
            }, {});
        }

        function sumAmounts(rows) {
            return rows.reduce((sum, r) => sum + parseFloat(r.amount || 0), 0);
        }

        function average(values) {
            if (!values.length) return 0;
            return values.reduce((sum, v) => sum + v, 0) / values.length;
        }

        function extractInsight(value) {
            if (!value) return '';
            try {
                const parsed = typeof value === 'string' ? JSON.parse(value) : value;
                return parsed?.risks?.[0] || parsed?.trend || '';
            } catch {
                return String(value).slice(0, 120);
            }
        }

        function formatMoney(value) {
            const num = parseFloat(value || 0);
            return num.toLocaleString('ar-SA') + ' Ø±.Ø³';
        }

        function formatDate(value) {
            if (!value) return '-';
            return new Date(value).toLocaleDateString('ar-SA');
        }

        function formatDateTime(value) {
            if (!value) return '-';
            return new Date(value).toLocaleString('ar-SA');
        }

        function truncate(value) {
            if (value === null || value === undefined) return '-';
            const text = typeof value === 'string' ? value : JSON.stringify(value);
            return text.length > 120 ? text.slice(0, 120) + '...' : text;
        }

        function downloadAllJSON() {
            const payload = {
                cashflow_overview: cashflowOverview,
                cashflow_operating: cashflowOperating,
                cashflow_investing: cashflowInvesting,
                cashflow_financing: cashflowFinancing,
                forecasts,
                risk_scores: riskScores,
                invoices,
                payments,
                ar_aging: arAging
            };
            downloadBlob(JSON.stringify(payload, null, 2), 'cashflow-risk-reports.json', 'application/json');
        }

        function downloadAllCSV() {
            const rows = [];
            rows.push(['CASHFLOW_TRANSACTIONS']);
            rows.push(['flow_id','flow_type','amount','description','flow_date','entity_id','created_by','created_at','source']);
            mergeCashflows().forEach(r => rows.push([r.flow_id, r.flow_type, r.amount, r.description, r.flow_date, r.entity_id, r.created_by, r.created_at, r.source]));

            rows.push([]);
            rows.push(['AI_FORECASTS']);
            rows.push(['forecast_id','entity_id','forecast_period','forecast_type','forecast_amount','confidence_level','ai_model','ai_insights','created_at']);
            forecasts.forEach(f => rows.push([f.forecast_id, f.entity_id, f.forecast_period, f.forecast_type, f.forecast_amount, f.confidence_level, f.ai_model, f.ai_insights, f.created_at]));

            rows.push([]);
            rows.push(['AI_RISK_SCORES']);
            rows.push(['risk_id','customer_id','assessment_date','risk_score','risk_level','risk_factors','calculation_details','recommendations','suggested_actions','entity_type','entity_id','model_version','created_at']);
            riskScores.forEach(r => rows.push([r.risk_id, r.customer_id, r.assessment_date, r.risk_score, r.risk_level, r.risk_factors, r.calculation_details, r.recommendations, r.suggested_actions, r.entity_type, r.entity_id, r.model_version, r.created_at]));

            const csvContent = rows.map(r => r.map(v => `"${v ?? ''}"`).join(',')).join('\n');
            downloadBlob(csvContent, 'cashflow-risk-reports.csv', 'text/csv;charset=utf-8;');
        }

        function downloadReport(type) {
            const report = buildReport(type);
            downloadBlob(JSON.stringify(report, null, 2), `${type}.json`, 'application/json');
        }

        function buildReport(type) {
            switch (type) {
                case 'customer-statement':
                    return buildCustomerStatement();
                case 'overdue-customers':
                    return { overdue_invoices: invoices.filter(i => String(i.status || '').toUpperCase() === 'OVERDUE') };
                case 'top-balances':
                    return { top_balances: arAging.sort((a, b) => parseFloat(b.remaining_amount || 0) - parseFloat(a.remaining_amount || 0)).slice(0, 10) };
                case 'branch-collections':
                    return { branch_collections: groupSum(payments, 'branch_id', 'payment_amount') };
                case 'branch-ar':
                    return { branch_ar: groupSum(arAging, 'branch_id', 'remaining_amount') };
                case 'branch-cashflow':
                    return { cashflow_overview: cashflowOverview };
                case 'incubator-programs':
                    return { program_performance: groupSum(invoices, 'program_id', 'total_amount') };
                case 'incubator-collections':
                    return { program_collections: groupSum(payments, 'program_id', 'payment_amount') };
                case 'incubator-ar':
                    return { program_ar: groupSum(arAging, 'program_id', 'remaining_amount') };
                case 'empire-monthly':
                    return { monthly_cashflow: cashflowOverview };
                case 'empire-quarterly':
                    return { quarterly_forecasts: forecasts };
                case 'empire-risk':
                    return { risk_scores: riskScores };
                case 'empire-forecast':
                    return { forecasts };
                default:
                    return { error: 'Unknown report type' };
            }
        }

        function buildCustomerStatement() {
            const groupedInvoices = invoices.reduce((acc, inv) => {
                const key = inv.customer_id || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
                if (!acc[key]) acc[key] = { invoices: [], payments: [] };
                acc[key].invoices.push(inv);
                return acc;
            }, {});

            payments.forEach(p => {
                const key = p.customer_id || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
                if (!groupedInvoices[key]) groupedInvoices[key] = { invoices: [], payments: [] };
                groupedInvoices[key].payments.push(p);
            });

            return { customer_statements: groupedInvoices };
        }

        function groupSum(rows, key, valueKey) {
            return rows.reduce((acc, row) => {
                const label = row[key] ?? 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
                acc[label] = (acc[label] || 0) + parseFloat(row[valueKey] || 0);
                return acc;
            }, {});
        }

        function downloadBlob(content, filename, type) {
            const blob = new Blob([content], { type });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            link.click();
            URL.revokeObjectURL(url);
        }

        function printReport() {
            window.print();
        }

        function refreshData() {
            loadData();
        }

        document.addEventListener('DOMContentLoaded', loadData);
    </script>
</body>
</html>
