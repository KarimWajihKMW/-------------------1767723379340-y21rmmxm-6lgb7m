<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>๐ง ุงูุชุฏููุงุช ุงูููุฏูุฉ + ุงููุฎุงุทุฑ + ุงูุชูุงุฑูุฑ ุงูุฐููุฉ - ูุธุงู ูุงููุด</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Cairo', sans-serif;
            background-color: #f9fafb; /* Zinc-50 */
            color: #18181b; /* Zinc-900 */
            min-height: 100vh;
        }
        .card-glass {
            background: #ffffff;
            border: 1px solid #e4e4e7; /* Zinc-200 */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .stat-pill {
            border-radius: 999px;
            background-color: #18181b; /* Zinc-900 */
            color: #ffffff;
        }
        .stat-angled {
            border-radius: 28px 6px 28px 6px;
            background-color: #ef4444; /* Red-500 */
            color: #ffffff;
        }
        .stat-rounded {
            border-radius: 28px;
            background-color: #ffffff;
            border: 2px solid #18181b;
            color: #18181b;
        }
        .chart-container {
            position: relative;
            height: 280px;
        }
        .table-scroll {
            max-height: 520px;
            overflow: auto;
        }
        /* Accents converted to Black/Red/Gray theme */
        .section-accent-sky { border-top: 4px solid #18181b; }      /* Black */
        .section-accent-emerald { border-top: 4px solid #52525b; }  /* Zinc-600 */
        .section-accent-amber { border-top: 4px solid #ef4444; }    /* Red-500 */
        .section-accent-violet { border-top: 4px solid #18181b; }   /* Black */
        .section-accent-rose { border-top: 4px solid #991b1b; }     /* Red-800 */
        .section-accent-indigo { border-top: 4px solid #3f3f46; }   /* Zinc-700 */
        .chip {
            padding: 6px 12px;
            border-radius: 999px;
            font-weight: 700;
        }
        .glass-panel {
            background: #ffffff;
            border: 1px solid #e5e7eb;
        }
        .kpi-glow {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        .progress-track {
            height: 8px;
            border-radius: 999px;
            background: #f4f4f5; /* Zinc-100 */
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            border-radius: 999px;
            transition: width 0.4s ease;
        }
        .insight-card {
            border-left: 4px solid #ef4444;
        }
        .pulse-dot {
            width: 10px;
            height: 10px;
            border-radius: 999px;
            background: #ef4444;
            box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7);
            animation: pulse 1.6s infinite;
        }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.6); }
            70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }
        .demo-banner {
            background: #fef2f2; /* Red-50 */
            border: 1px dashed #ef4444;
            color: #991b1b;
        }
    </style>
</head>
<body>
    <div class="container mx-auto px-4 py-8">
        <div class="mb-8 text-slate-900">
            <h1 class="text-4xl font-bold mb-2">๐ง ุงูุชุฏููุงุช ุงูููุฏูุฉ + ุงููุฎุงุทุฑ + ุงูุชูุงุฑูุฑ ุงูุฐููุฉ</h1>
            <p class="text-lg text-slate-600">ููุทูุฉ ุงูุชุฏููุงุช ุงูููุฏูุฉ + ููุทูุฉ ุงููุฎุงุทุฑ ุงููุงููุฉ + ุงูุชูุงุฑูุฑ ุงูุฐููุฉ (ุงูุตูุญุฉ 27)</p>
        </div>

        <div class="mb-6 flex flex-wrap gap-3">
            <button onclick="refreshData()" class="bg-white text-slate-800 border border-slate-200 px-6 py-3 rounded-full font-bold hover:shadow-lg transition flex items-center gap-2">
                <i class="fas fa-rotate"></i>
                ุชุญุฏูุซ ุงูุจูุงูุงุช
            </button>
            <button onclick="downloadAllJSON()" class="bg-slate-900 text-white px-6 py-3 rounded-full font-bold hover:shadow-lg transition flex items-center gap-2">
                <i class="fas fa-file-code"></i>
                ุชูุฒูู ููู ุจูุงูุงุช ุดุงูู
            </button>
            <button onclick="downloadAllCSV()" class="bg-slate-700 text-white px-6 py-3 rounded-full font-bold hover:shadow-lg transition flex items-center gap-2">
                <i class="fas fa-file-csv"></i>
                ุชูุฒูู ููู ุฌุฏููู ุดุงูู
            </button>
            <button onclick="printReport()" class="bg-red-600 text-white px-6 py-3 rounded-full font-bold hover:shadow-lg transition flex items-center gap-2">
                <i class="fas fa-print"></i>
                ุทุจุงุนุฉ ุงูุชูุฑูุฑ
            </button>
            <button onclick="downloadEnhancementPack()" class="bg-black text-white px-6 py-3 rounded-full font-bold hover:shadow-lg transition flex items-center gap-2">
                <i class="fas fa-bolt"></i>
                ุชูุฒูู ุชุนุฒูุฒุงุช ุฐููุฉ
            </button>
        </div>

        <div id="demoBanner" class="demo-banner hidden mb-6 rounded-2xl p-4 text-slate-700 text-sm">
            ูุชู ุนุฑุถ ุจูุงูุงุช ุชุฌุฑูุจูุฉ ูุคูุชูุง ูุฃู ุงููุตุงุฏุฑ ูู ุชูุนุฏ ุฃู ุจูุงูุงุช ุญุชู ุงูุขู.
        </div>

        <!-- Command Center -->
        <div class="grid grid-cols-1 xl:grid-cols-3 gap-6 mb-8">
            <div class="glass-panel rounded-3xl p-6 kpi-glow">
                <div class="flex items-center justify-between mb-4">
                    <div>
                        <h3 class="text-lg font-bold text-slate-800">๐ง ุฌูุฏุฉ ุงูุชุฏูู ุงูููุฏู</h3>
                        <p class="text-sm text-slate-500">ูุคุดุฑ ุชูุงุฒู ูุชุฐุจุฐุจ ุงูุชุฏููุงุช</p>
                    </div>
                    <span id="cashflowQualityBadge" class="chip bg-emerald-100 text-emerald-700">ููุชุงุฒ</span>
                </div>
                <div class="flex items-end justify-between mb-3">
                    <div>
                        <div class="text-3xl font-bold text-slate-800" id="cashflowQualityScore">0%</div>
                        <div class="text-sm text-slate-500">ูุคุดุฑ ุงูุฌูุฏุฉ</div>
                    </div>
                    <div class="text-right">
                        <div class="text-sm text-slate-500">ูุณุจุฉ ุงูุชุฐุจุฐุจ</div>
                        <div class="text-xl font-bold text-rose-600" id="cashflowVolatility">0%</div>
                    </div>
                </div>
                <div class="progress-track">
                    <div id="cashflowQualityProgress" class="progress-fill bg-emerald-500" style="width: 0%"></div>
                </div>
                <div class="mt-4 grid grid-cols-2 gap-3 text-sm">
                    <div class="bg-slate-50 rounded-xl p-3">
                        <div class="text-slate-500">ุตุงูู 30 ููู</div>
                        <div class="font-bold text-slate-800" id="net30">0</div>
                    </div>
                    <div class="bg-slate-50 rounded-xl p-3">
                        <div class="text-slate-500">ุขุฎุฑ ุชุญุฏูุซ</div>
                        <div class="font-bold text-slate-800" id="lastSync">-</div>
                    </div>
                </div>
            </div>
            <div class="glass-panel rounded-3xl p-6 kpi-glow">
                <div class="flex items-center justify-between mb-4">
                    <div>
                        <h3 class="text-lg font-bold text-slate-800">๐จ ุชูุจููุงุช ุงุณุชุจุงููุฉ</h3>
                        <p class="text-sm text-slate-500">ุชุญุฐูุฑุงุช ูุจูุฑุฉ ูููุฎุงุทุฑ ูุงูุณูููุฉ</p>
                    </div>
                    <span class="pulse-dot"></span>
                </div>
                <div id="cashflowAlerts" class="space-y-3 text-sm text-slate-700">
                    <div class="animate-pulse text-slate-400">ุฌุงุฑู ุงูุชุญููู...</div>
                </div>
            </div>
            <div class="glass-panel rounded-3xl p-6 kpi-glow">
                <div class="flex items-center justify-between mb-4">
                    <div>
                        <h3 class="text-lg font-bold text-slate-800">โก ูุคุดุฑุงุช ุณุฑูุนุฉ</h3>
                        <p class="text-sm text-slate-500">ููุฎุต ุฃุฏุงุก ุงูุชุญุตูู ูุงููุฎุงุทุฑ</p>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div class="bg-indigo-50 rounded-xl p-4">
                        <div class="text-sm text-indigo-600">ูุนุฏู ุงูุชุญุตูู</div>
                        <div class="text-2xl font-bold text-indigo-800" id="collectionRate">0%</div>
                    </div>
                    <div class="bg-rose-50 rounded-xl p-4">
                        <div class="text-sm text-rose-600">ูุฎุงุทุฑ ุนุงููุฉ</div>
                        <div class="text-2xl font-bold text-rose-700" id="highRiskShare">0%</div>
                    </div>
                    <div class="bg-emerald-50 rounded-xl p-4">
                        <div class="text-sm text-emerald-600">ูุชูุณุท ุงูุชุญุตูู</div>
                        <div class="text-2xl font-bold text-emerald-700" id="avgCollection">0</div>
                    </div>
                    <div class="bg-amber-50 rounded-xl p-4">
                        <div class="text-sm text-amber-600">ุตุงูู ุงูุณูููุฉ</div>
                        <div class="text-2xl font-bold text-amber-700" id="netLiquidity">0</div>
                    </div>
                </div>
                <div class="mt-4">
                    <h4 class="text-sm font-bold text-slate-700 mb-2">๐ ุฃุนูู ูุตุงุฏุฑ ุงูุชุฏูู</h4>
                    <div id="topSources" class="space-y-2 text-sm"></div>
                </div>
            </div>
        </div>

        <!-- Cash Flow Zone -->
        <div class="card-glass rounded-3xl shadow-2xl p-6 mb-8 section-accent-sky">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-2xl font-bold text-slate-800">๐ง ููุทูุฉ ุงูุชุฏููุงุช ุงูููุฏูุฉ</h2>
                <div class="text-sm text-slate-500">ูุตุฏุฑ ุงูุจูุงูุงุช: ุฌุฏุงูู ุงูุชุฏููุงุช ุงูููุฏูุฉ ูุงูุชููุนุงุช ุงูุฐููุฉ</div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-5 mb-8">
                <div class="stat-pill bg-slate-900 text-white p-6">
                    <div class="flex justify-between mb-3"><span>ุงูุชุฏูู ุงูุฏุงุฎู</span><i class="fas fa-arrow-trend-up text-2xl opacity-70"></i></div>
                    <div id="cashInflow" class="text-3xl font-bold"><div class="animate-pulse">...</div></div>
                </div>
                <div class="stat-angled bg-red-600 text-white p-6">
                    <div class="flex justify-between mb-3"><span>ุงูุชุฏูู ุงูุฎุงุฑุฌ</span><i class="fas fa-arrow-trend-down text-2xl opacity-70"></i></div>
                    <div id="cashOutflow" class="text-3xl font-bold"><div class="animate-pulse">...</div></div>
                </div>
                <div class="stat-rounded bg-white text-slate-900 border-2 border-slate-900 p-6">
                    <div class="flex justify-between mb-3"><span>ุตุงูู ุงูุชุฏูู</span><i class="fas fa-water text-2xl opacity-70"></i></div>
                    <div id="cashNet" class="text-3xl font-bold"><div class="animate-pulse">...</div></div>
                </div>
                <div class="stat-pill bg-black text-white p-6">
                    <div class="flex justify-between mb-3"><span>ุชููุนุงุช 30 ููู</span><i class="fas fa-calendar-day text-2xl opacity-70"></i></div>
                    <div id="forecast30" class="text-3xl font-bold"><div class="animate-pulse">...</div></div>
                </div>
                <div class="stat-angled bg-slate-700 text-white p-6">
                    <div class="flex justify-between mb-3"><span>ุชููุนุงุช 90 ููู</span><i class="fas fa-calendar-week text-2xl opacity-70"></i></div>
                    <div id="forecast90" class="text-3xl font-bold"><div class="animate-pulse">...</div></div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="card-glass rounded-2xl p-5 shadow-lg section-accent-emerald">
                    <h3 class="text-lg font-bold text-slate-800 mb-4">๐ ูุฎุทุท ุงูุชุฏูู ุงูููุฏู</h3>
                    <div class="chart-container">
                        <canvas id="cashflowChart"></canvas>
                    </div>
                </div>
                <div class="card-glass rounded-2xl p-5 shadow-lg section-accent-violet">
                    <h3 class="text-lg font-bold text-slate-800 mb-4">๐ค ุฐูุงุก ุงุตุทูุงุนู</h3>
                    <div id="cashflowInsights" class="space-y-3 text-sm text-slate-600">
                        <div class="animate-pulse">ุฌุงุฑู ุงูุชุญููู...</div>
                    </div>
                </div>
                <div class="card-glass rounded-2xl p-5 shadow-lg section-accent-amber">
                    <h3 class="text-lg font-bold text-slate-800 mb-4">๐ ุชูุฒูุน ุงูุชุฏููุงุช ุญุณุจ ุงูููุน</h3>
                    <div class="chart-container">
                        <canvas id="cashflowMixChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Financial Risk Zone -->
        <div class="card-glass rounded-3xl shadow-2xl p-6 mb-8 section-accent-rose">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-2xl font-bold text-slate-800">โ๏ธ ููุทูุฉ ุงููุฎุงุทุฑ ุงููุงููุฉ</h2>
                <div class="text-sm text-slate-500">ุฑุงุฏุงุฑ ุงููุฎุงุทุฑ ุงูุฐูู</div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-5 mb-8">
                <div class="stat-pill bg-red-600 text-white p-6">
                    <div class="flex justify-between mb-3"><span>ุงูุนููุงุก ุนุงูู ุงููุฎุงุทุฑ</span><i class="fas fa-user-shield text-2xl opacity-70"></i></div>
                    <div id="riskCustomers" class="text-3xl font-bold"><div class="animate-pulse">...</div></div>
                </div>
                <div class="stat-rounded bg-slate-900 text-white p-6">
                    <div class="flex justify-between mb-3"><span>ุงููุฑูุน ุนุงููุฉ ุงููุฎุงุทุฑ</span><i class="fas fa-building text-2xl opacity-70"></i></div>
                    <div id="riskBranches" class="text-3xl font-bold"><div class="animate-pulse">...</div></div>
                </div>
                <div class="stat-angled bg-black text-white p-6">
                    <div class="flex justify-between mb-3"><span>ุงูุจุฑุงูุฌ ุนุงููุฉ ุงููุฎุงุทุฑ</span><i class="fas fa-layer-group text-2xl opacity-70"></i></div>
                    <div id="riskPrograms" class="text-3xl font-bold"><div class="animate-pulse">...</div></div>
                </div>
                <div class="stat-pill bg-slate-700 text-white p-6">
                    <div class="flex justify-between mb-3"><span>ูุณุจุฉ ุงููุฎุงุทุฑ ุงูุนุงูุฉ</span><i class="fas fa-gauge-high text-2xl opacity-70"></i></div>
                    <div id="overallRisk" class="text-3xl font-bold"><div class="animate-pulse">...</div></div>
                </div>
                <div class="stat-angled bg-white text-red-700 border border-red-200 p-6">
                    <div class="flex justify-between mb-3"><span>ุชููุนุงุช ุงูุชุนุซุฑ 30 ููู</span><i class="fas fa-triangle-exclamation text-2xl opacity-70"></i></div>
                    <div id="default30" class="text-3xl font-bold"><div class="animate-pulse">...</div></div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="card-glass rounded-2xl p-5 shadow-lg section-accent-amber">
                    <h3 class="text-lg font-bold text-slate-800 mb-4">๐งญ ุชูุฒูุน ูุณุชููุงุช ุงููุฎุงุทุฑ</h3>
                    <div class="chart-container">
                        <canvas id="riskLevelChart"></canvas>
                    </div>
                </div>
                <div class="card-glass rounded-2xl p-5 shadow-lg section-accent-emerald">
                    <h3 class="text-lg font-bold text-slate-800 mb-4">๐ ุฃุนูู 10 ุนููุงุก ูุฎุงุทุฑุฉ</h3>
                    <div id="topRiskCustomers" class="space-y-3 text-sm text-slate-700">
                        <div class="animate-pulse">ุฌุงุฑู ุงูุชุญููู...</div>
                    </div>
                </div>
                <div class="card-glass rounded-2xl p-5 shadow-lg section-accent-violet">
                    <h3 class="text-lg font-bold text-slate-800 mb-4">๐ค ุฐูุงุก ุงุตุทูุงุนู</h3>
                    <div id="riskInsights" class="space-y-3 text-sm text-slate-600">
                        <div class="animate-pulse">ุฌุงุฑู ุงูุชุญููู...</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Smart Reports Zone -->
        <div class="card-glass rounded-3xl shadow-2xl p-6 mb-8 section-accent-indigo">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-2xl font-bold text-slate-800">๐ ููุทูุฉ ุงูุชูุงุฑูุฑ ุงูุฐููุฉ</h2>
                <div class="text-sm text-slate-500">ุชูุงุฑูุฑ ุฌุงูุฒุฉ ุจุถุบุทุฉ ุฒุฑ</div>
            </div>
            <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
                <div class="bg-white border boundary-slate-200 rounded-2xl p-5 shadow-sm">
                    <h4 class="font-bold text-slate-900 mb-3 border-b pb-2">ุชูุงุฑูุฑ ุงูุนููุงุก</h4>
                    <div class="space-y-2">
                        <button onclick="downloadReport('customer-statement')" class="w-full text-right px-4 py-2 bg-slate-50 rounded-xl hover:bg-slate-200 transition">ูุดู ุญุณุงุจ</button>
                        <button onclick="downloadReport('overdue-customers')" class="w-full text-right px-4 py-2 bg-slate-50 rounded-xl hover:bg-slate-200 transition">ุงูุนููุงุก ุงููุชุฃุฎุฑูู</button>
                        <button onclick="downloadReport('top-balances')" class="w-full text-right px-4 py-2 bg-slate-50 rounded-xl hover:bg-slate-200 transition">ุงูุนููุงุก ุงูุฃุนูู ุฑุตูุฏูุง</button>
                    </div>
                </div>
                <div class="bg-white border boundary-slate-200 rounded-2xl p-5 shadow-sm">
                    <h4 class="font-bold text-slate-900 mb-3 border-b pb-2">ุชูุงุฑูุฑ ุงููุฑูุน</h4>
                    <div class="space-y-2">
                        <button onclick="downloadReport('branch-collections')" class="w-full text-right px-4 py-2 bg-slate-50 rounded-xl hover:bg-slate-200 transition">ุฃุฏุงุก ุงูุชุญุตูู</button>
                        <button onclick="downloadReport('branch-ar')" class="w-full text-right px-4 py-2 bg-slate-50 rounded-xl hover:bg-slate-200 transition">ุงูุฐูู</button>
                        <button onclick="downloadReport('branch-cashflow')" class="w-full text-right px-4 py-2 bg-slate-50 rounded-xl hover:bg-slate-200 transition">ุงูุชุฏูู ุงูููุฏู</button>
                    </div>
                </div>
                <div class="bg-white border boundary-slate-200 rounded-2xl p-5 shadow-sm">
                    <h4 class="font-bold text-slate-900 mb-3 border-b pb-2">ุชูุงุฑูุฑ ุงูุญุงุถูุงุช</h4>
                    <div class="space-y-2">
                        <button onclick="downloadReport('incubator-programs')" class="w-full text-right px-4 py-2 bg-slate-50 rounded-xl hover:bg-slate-200 transition">ุฃุฏุงุก ุงูุจุฑุงูุฌ</button>
                        <button onclick="downloadReport('incubator-collections')" class="w-full text-right px-4 py-2 bg-slate-50 rounded-xl hover:bg-slate-200 transition">ุงูุชุญุตูู ุญุณุจ ุงูุจุฑูุงูุฌ</button>
                        <button onclick="downloadReport('incubator-ar')" class="w-full text-right px-4 py-2 bg-slate-50 rounded-xl hover:bg-slate-200 transition">ุงูุฐูู ุญุณุจ ุงูุจุฑูุงูุฌ</button>
                    </div>
                </div>
                <div class="bg-white border boundary-red-200 rounded-2xl p-5 shadow-sm">
                    <h4 class="font-bold text-red-700 mb-3 border-b border-red-100 pb-2">ุชูุงุฑูุฑ ุงูุฅูุจุฑุงุทูุฑูุฉ</h4>
                    <div class="space-y-2">
                        <button onclick="downloadReport('empire-monthly')" class="w-full text-right px-4 py-2 bg-red-50 rounded-xl hover:bg-red-100 text-red-900 transition">ุชูุฑูุฑ ูุงูู ุดูุฑู</button>
                        <button onclick="downloadReport('empire-quarterly')" class="w-full text-right px-4 py-2 bg-red-50 rounded-xl hover:bg-red-100 text-red-900 transition">ุชูุฑูุฑ ูุงูู ุฑุจุน ุณููู</button>
                        <button onclick="downloadReport('empire-risk')" class="w-full text-right px-4 py-2 bg-red-50 rounded-xl hover:bg-red-100 text-red-900 transition">ุชูุฑูุฑ ุงููุฎุงุทุฑ</button>
                        <button onclick="downloadReport('empire-forecast')" class="w-full text-right px-4 py-2 bg-red-50 rounded-xl hover:bg-red-100 text-red-900 transition">ุชูุฑูุฑ ุงูุชููุนุงุช</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Cashflow Tables -->
        <div class="card-glass rounded-3xl shadow-2xl p-6 mb-8 section-accent-sky">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-xl font-bold text-slate-800">๐ ุฌุฏูู ูุนุงููุงุช ุงูุชุฏูู ุงูููุฏู</h3>
                <span id="cashflowCount" class="text-sm text-slate-500"></span>
            </div>
            <div class="table-scroll">
                <table class="w-full text-xs">
                    <thead class="bg-sky-50 text-sky-700">
                        <tr>
                            <th class="px-3 py-2 text-right">ุฑูู ุงูุชุฏูู</th>
                            <th class="px-3 py-2 text-right">ููุน ุงูุชุฏูู</th>
                            <th class="px-3 py-2 text-right">ุงููุจูุบ</th>
                            <th class="px-3 py-2 text-right">ุงููุตู</th>
                            <th class="px-3 py-2 text-right">ุชุงุฑูุฎ ุงูุชุฏูู</th>
                            <th class="px-3 py-2 text-right">ูุนุฑู ุงูููุดุฃุฉ</th>
                            <th class="px-3 py-2 text-right">ููุดุฆ ุงูุณุฌู</th>
                            <th class="px-3 py-2 text-right">ุชุงุฑูุฎ ุงูุฅูุดุงุก</th>
                            <th class="px-3 py-2 text-right">ุงููุตุฏุฑ</th>
                        </tr>
                    </thead>
                    <tbody id="cashflowTable" class="divide-y divide-slate-100">
                        <tr>
                            <td colspan="9" class="px-4 py-12 text-center text-slate-500">ุฌุงุฑู ุชุญููู ุงูุจูุงูุงุช...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- AI Forecasts Table -->
        <div class="card-glass rounded-3xl shadow-2xl p-6 mb-8 section-accent-emerald">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-xl font-bold text-slate-800">๐ฎ ุฌุฏูู ุงูุชููุนุงุช ุงูุฐููุฉ</h3>
                <span id="forecastCount" class="text-sm text-slate-500"></span>
            </div>
            <div class="table-scroll">
                <table class="w-full text-xs">
                    <thead class="bg-emerald-50 text-emerald-700">
                        <tr>
                            <th class="px-3 py-2 text-right">ุฑูู ุงูุชููุน</th>
                            <th class="px-3 py-2 text-right">ูุนุฑู ุงูููุดุฃุฉ</th>
                            <th class="px-3 py-2 text-right">ูุชุฑุฉ ุงูุชููุน</th>
                            <th class="px-3 py-2 text-right">ููุน ุงูุชููุน</th>
                            <th class="px-3 py-2 text-right">ูููุฉ ุงูุชููุน</th>
                            <th class="px-3 py-2 text-right">ูุณุชูู ุงูุซูุฉ</th>
                            <th class="px-3 py-2 text-right">ูููุฐุฌ ุงูุฐูุงุก</th>
                            <th class="px-3 py-2 text-right">ููุงุญุธุงุช ุงูุฐูุงุก</th>
                            <th class="px-3 py-2 text-right">ุชุงุฑูุฎ ุงูุฅูุดุงุก</th>
                        </tr>
                    </thead>
                    <tbody id="forecastTable" class="divide-y divide-slate-100">
                        <tr>
                            <td colspan="9" class="px-4 py-12 text-center text-slate-500">ุฌุงุฑู ุชุญููู ุงูุจูุงูุงุช...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Risk Scores Table -->
        <div class="card-glass rounded-3xl shadow-2xl p-6 section-accent-rose">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-xl font-bold text-slate-800">๐ก๏ธ ุฌุฏูู ุชููููุงุช ุงููุฎุงุทุฑ</h3>
                <span id="riskCount" class="text-sm text-slate-500"></span>
            </div>
            <div class="table-scroll">
                <table class="w-full text-xs">
                    <thead class="bg-rose-50 text-rose-700">
                        <tr>
                            <th class="px-3 py-2 text-right">ุฑูู ุงููุฎุงุทุฑ</th>
                            <th class="px-3 py-2 text-right">ุฑูู ุงูุนููู</th>
                            <th class="px-3 py-2 text-right">ุชุงุฑูุฎ ุงูุชูููู</th>
                            <th class="px-3 py-2 text-right">ุฏุฑุฌุฉ ุงููุฎุงุทุฑุฉ</th>
                            <th class="px-3 py-2 text-right">ูุณุชูู ุงููุฎุงุทุฑุฉ</th>
                            <th class="px-3 py-2 text-right">ุนูุงูู ุงููุฎุงุทุฑ</th>
                            <th class="px-3 py-2 text-right">ุชูุงุตูู ุงูุญุณุงุจ</th>
                            <th class="px-3 py-2 text-right">ุงูุชูุตูุงุช</th>
                            <th class="px-3 py-2 text-right">ุฅุฌุฑุงุกุงุช ููุชุฑุญุฉ</th>
                            <th class="px-3 py-2 text-right">ููุน ุงูููุดุฃุฉ</th>
                            <th class="px-3 py-2 text-right">ูุนุฑู ุงูููุดุฃุฉ</th>
                            <th class="px-3 py-2 text-right">ูุณุฎุฉ ุงููููุฐุฌ</th>
                            <th class="px-3 py-2 text-right">ุชุงุฑูุฎ ุงูุฅูุดุงุก</th>
                        </tr>
                    </thead>
                    <tbody id="riskTable" class="divide-y divide-slate-100">
                        <tr>
                            <td colspan="13" class="px-4 py-12 text-center text-slate-500">ุฌุงุฑู ุชุญููู ุงูุจูุงูุงุช...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = window.location.origin;
        const CASHFLOW_ENTITY_ID = '1';
        const AR_ENTITY_ID = 'HQ001';

        let cashflowOverview = null;
        let cashflowOperating = [];
        let cashflowInvesting = [];
        let cashflowFinancing = [];
        let forecasts = [];
        let riskScores = [];
        let invoices = [];
        let payments = [];
        let arAging = [];

        let lastSyncAt = null;
        let isDemoMode = false;

        let cashflowChartInstance = null;
        let cashflowMixInstance = null;
        let riskLevelInstance = null;

        async function fetchJsonSafe(url, fallback) {
            try {
                const res = await fetch(url);
                if (!res.ok) {
                    return fallback;
                }
                return await res.json();
            } catch (error) {
                console.warn('โ๏ธ fetch failed:', url, error);
                return fallback;
            }
        }

        async function fetchJsonWithFallback(urls, fallback) {
            for (const url of urls) {
                const data = await fetchJsonSafe(url, null);
                if (data !== null) {
                    return data;
                }
            }
            return fallback;
        }

        async function loadData() {
            try {
                const [overviewData, operatingData, investingData, financingData, forecastData, riskData, invoiceData, paymentData, arData] = await Promise.all([
                    fetchJsonSafe(`${API_BASE}/finance/cashflow/overview?entity_id=${CASHFLOW_ENTITY_ID}`, null),
                    fetchJsonSafe(`${API_BASE}/finance/cashflow/operating?entity_id=${CASHFLOW_ENTITY_ID}`, { cashflows: [] }),
                    fetchJsonSafe(`${API_BASE}/finance/cashflow/investing?entity_id=${CASHFLOW_ENTITY_ID}`, { cashflows: [] }),
                    fetchJsonSafe(`${API_BASE}/finance/cashflow/financing?entity_id=${CASHFLOW_ENTITY_ID}`, { cashflows: [] }),
                    fetchJsonSafe(`${API_BASE}/finance/ai-forecasts?entity_id=${CASHFLOW_ENTITY_ID}`, { forecasts: [] }),
                    fetchJsonSafe(`${API_BASE}/finance/ai-risk-scores?entity_id=${CASHFLOW_ENTITY_ID}`, { rows: [] }),
                    fetchJsonWithFallback([
                        `${API_BASE}/finance/invoices?entity_id=${AR_ENTITY_ID}`,
                        `${API_BASE}/api/invoices?entity_id=${AR_ENTITY_ID}`,
                        `${API_BASE}/api/invoices`
                    ], []),
                    fetchJsonSafe(`${API_BASE}/finance/payments?entity_id=${AR_ENTITY_ID}`, { payments: [] }),
                    fetchJsonSafe(`${API_BASE}/finance/ar-aging?entity_id=${AR_ENTITY_ID}`, { rows: [] })
                ]);

                cashflowOverview = overviewData;
                cashflowOperating = operatingData.cashflows || [];
                cashflowInvesting = investingData.cashflows || [];
                cashflowFinancing = financingData.cashflows || [];
                forecasts = forecastData.forecasts || [];
                riskScores = riskData.rows || [];
                invoices = Array.isArray(invoiceData) ? invoiceData : (invoiceData.invoices || invoiceData.rows || []);
                payments = paymentData.payments || [];
                arAging = arData.rows || [];

                applyDemoFallbackIfEmpty();
                lastSyncAt = new Date();

                renderCashflow();
                renderRisk();
                renderTables();
                renderEnhancements();
            } catch (error) {
                console.error('โ ุฎุทุฃ ูู ุชุญููู ุงูุจูุงูุงุช:', error);
                cashflowOverview = null;
                cashflowOperating = [];
                cashflowInvesting = [];
                cashflowFinancing = [];
                forecasts = [];
                riskScores = [];
                invoices = [];
                payments = [];
                arAging = [];
                applyDemoFallbackIfEmpty();
                lastSyncAt = new Date();
                renderCashflow();
                renderRisk();
                renderTables();
                renderEnhancements();
            }
        }

        function renderCashflow() {
            const hasOverview = cashflowOverview?.success && cashflowOverview.operating && cashflowOverview.investing && cashflowOverview.financing;
            const inflow = hasOverview
                ? cashflowOverview.operating.inflow + cashflowOverview.investing.inflow + cashflowOverview.financing.inflow
                : 0;
            const outflow = hasOverview
                ? cashflowOverview.operating.outflow + cashflowOverview.investing.outflow + cashflowOverview.financing.outflow
                : 0;
            const net = hasOverview ? cashflowOverview.total_net_cashflow : 0;

            document.getElementById('cashInflow').textContent = formatMoney(inflow);
            document.getElementById('cashOutflow').textContent = formatMoney(outflow);
            document.getElementById('cashNet').textContent = formatMoney(net);

            const forecastSorted = [...forecasts].sort((a, b) => new Date(a.created_at) - new Date(b.created_at));
            const forecast30Val = forecastSorted[0]?.forecast_amount || 0;
            const forecast90Val = forecastSorted.slice(0, 3).reduce((sum, f) => sum + parseFloat(f.forecast_amount || 0), 0);

            document.getElementById('forecast30').textContent = formatMoney(forecast30Val);
            document.getElementById('forecast90').textContent = formatMoney(forecast90Val);

            const insights = forecastSorted.length ? forecastSorted.slice(0, 2).map((f, idx) => `
                <div class="bg-slate-50 p-3 rounded-xl">
                    <div class="font-bold">ุชูุจูู ${idx + 1}</div>
                    <div>${extractInsight(f.ai_insights) || 'ูุง ุชูุฌุฏ ููุงุญุธุฉ'}</div>
                </div>
            `).join('') : '<div class="text-slate-500">ูุง ุชูุฌุฏ ุชูุจููุงุช</div>';
            document.getElementById('cashflowInsights').innerHTML = insights;

            const merged = mergeCashflows();
            renderCashflowCharts(merged);
        }

        function renderCashflowCharts(merged) {
            const grouped = groupByDate(merged);
            const labels = Object.keys(grouped).sort();
            const inflowSeries = labels.map(date => grouped[date].inflow);
            const outflowSeries = labels.map(date => Math.abs(grouped[date].outflow));
            const netSeries = labels.map(date => grouped[date].net);

            const ctx = document.getElementById('cashflowChart').getContext('2d');
            if (cashflowChartInstance) cashflowChartInstance.destroy();
            cashflowChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels,
                    datasets: [
                        { label: 'ุชุฏูู ุฏุงุฎู', data: inflowSeries, borderColor: '#18181b', backgroundColor: 'rgba(24, 24, 27, 0.1)', tension: 0.35, borderWidth: 2 },
                        { label: 'ุชุฏูู ุฎุงุฑุฌ', data: outflowSeries, borderColor: '#ef4444', backgroundColor: 'rgba(239, 68, 68, 0.1)', tension: 0.35, borderWidth: 2 },
                        { label: 'ุตุงูู', data: netSeries, borderColor: '#52525b', backgroundColor: 'rgba(82, 82, 91, 0.1)', tension: 0.35, borderDash: [5, 5], borderWidth: 2 }
                    ]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });

            const mixTotals = {
                operating: sumAmounts(cashflowOperating),
                investing: sumAmounts(cashflowInvesting),
                financing: sumAmounts(cashflowFinancing)
            };
            const mixCtx = document.getElementById('cashflowMixChart').getContext('2d');
            if (cashflowMixInstance) cashflowMixInstance.destroy();
            cashflowMixInstance = new Chart(mixCtx, {
                type: 'doughnut',
                data: {
                    labels: ['ุชุดุบููู', 'ุงุณุชุซูุงุฑู', 'ุชููููู'],
                    datasets: [{
                        data: [Math.abs(mixTotals.operating), Math.abs(mixTotals.investing), Math.abs(mixTotals.financing)],
                        backgroundColor: ['#18181b', '#ef4444', '#94a3b8'],
                        borderWidth: 0
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });
        }

        function renderRisk() {
            const totalScores = riskScores.length;
            const highRisk = riskScores.filter(r => ['HIGH', 'CRITICAL'].includes(String(r.risk_level || '').toUpperCase()));
            const uniqueHighRiskCustomers = new Set(highRisk.map(r => r.customer_id)).size;

            const highRiskBranches = new Set(invoices.filter(i => ['HIGH', 'CRITICAL'].includes(String(i.risk_level || '').toUpperCase())).map(i => i.branch_id || 'ุบูุฑ ูุญุฏุฏ')).size;
            const highRiskPrograms = new Set(invoices.filter(i => ['HIGH', 'CRITICAL'].includes(String(i.risk_level || '').toUpperCase())).map(i => i.program_id || 'ุบูุฑ ูุญุฏุฏ')).size;
            const overallRisk = totalScores ? ((highRisk.length / totalScores) * 100) : 0;
            const default30 = totalScores ? (average(riskScores.map(r => parseFloat(r.risk_score || 0))) / 100) * 100 : 0;

            document.getElementById('riskCustomers').textContent = uniqueHighRiskCustomers;
            document.getElementById('riskBranches').textContent = highRiskBranches;
            document.getElementById('riskPrograms').textContent = highRiskPrograms;
            document.getElementById('overallRisk').textContent = `${overallRisk.toFixed(1)}%`;
            document.getElementById('default30').textContent = `${default30.toFixed(1)}%`;

            const levelCounts = riskScores.reduce((acc, r) => {
                const level = translateRiskLevel(r.risk_level) || 'ุบูุฑ ูุญุฏุฏ';
                acc[level] = (acc[level] || 0) + 1;
                return acc;
            }, {});
            renderRiskChart(levelCounts);

            const topCustomers = [...riskScores].sort((a, b) => parseFloat(b.risk_score || 0) - parseFloat(a.risk_score || 0)).slice(0, 10);
            document.getElementById('topRiskCustomers').innerHTML = topCustomers.length ? topCustomers.map(c => `
                <div class="flex items-center justify-between bg-amber-50 p-3 rounded-xl">
                    <span>ุนููู ${sanitizeText(c.customer_id)}</span>
                    <span class="chip bg-amber-100 text-amber-700">${parseFloat(c.risk_score || 0).toFixed(1)}</span>
                </div>
            `).join('') : '<div class="text-slate-500">ูุง ุชูุฌุฏ ุจูุงูุงุช</div>';

            document.getElementById('riskInsights').innerHTML = `
                <div class="bg-slate-50 p-3 rounded-xl">
                    "${topCustomers[0] ? `ุงูุนููู ${sanitizeText(topCustomers[0].customer_id)} ูุฏูู ุงุญุชูุงู ุชุนุซุฑ ${(parseFloat(topCustomers[0].risk_score || 0)).toFixed(1)}%` : 'ูุง ุชูุฌุฏ ุจูุงูุงุช ูุชุงุญุฉ'}"
                </div>
                <div class="bg-slate-50 p-3 rounded-xl">
                    "${highRiskPrograms ? 'ุชุญุณูู ูุฑุงูุจุฉ ุงูุจุฑุงูุฌ ุนุงููุฉ ุงููุฎุงุทุฑ ุณูุฎูุถ ูุคุดุฑ ุงููุฎุงุทุฑ ุงูุนุงู.' : 'ูุง ุชูุฌุฏ ุชูุจููุงุช ุฅุถุงููุฉ'}"
                </div>
            `;
        }

        function renderRiskChart(levelCounts) {
            const ctx = document.getElementById('riskLevelChart').getContext('2d');
            if (riskLevelInstance) riskLevelInstance.destroy();
            riskLevelInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Object.keys(levelCounts),
                    datasets: [{
                        data: Object.values(levelCounts),
                        // Colors mapped for risk levels: High/Crit=Red/DarkRed, Low/Med=Gray/Black
                        backgroundColor: ['#ef4444', '#b91c1c', '#18181b', '#9ca3af']
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
            });
        }

        function renderTables() {
            const merged = mergeCashflows();
            const cashRows = merged.map(row => `
                <tr class="hover:bg-sky-50">
                    <td class="px-3 py-2">${row.flow_id ?? '-'}</td>
                    <td class="px-3 py-2">${translateFlowType(row.flow_type)}</td>
                    <td class="px-3 py-2 font-semibold text-emerald-700">${formatMoney(row.amount)}</td>
                    <td class="px-3 py-2">${sanitizeText(row.description)}</td>
                    <td class="px-3 py-2">${formatDate(row.flow_date)}</td>
                    <td class="px-3 py-2">${row.entity_id ?? '-'}</td>
                    <td class="px-3 py-2">${sanitizeText(row.created_by)}</td>
                    <td class="px-3 py-2">${formatDateTime(row.created_at)}</td>
                    <td class="px-3 py-2">${sanitizeText(row.source)}</td>
                </tr>
            `).join('');
            document.getElementById('cashflowTable').innerHTML = cashRows || `<tr><td colspan="9" class="px-4 py-12 text-center text-slate-500">ูุง ุชูุฌุฏ ุจูุงูุงุช</td></tr>`;
            document.getElementById('cashflowCount').textContent = `ุนุฏุฏ ุงูุตููู: ${merged.length}`;

            const forecastRows = forecasts.map(f => `
                <tr class="hover:bg-emerald-50">
                    <td class="px-3 py-2">${f.forecast_id ?? '-'}</td>
                    <td class="px-3 py-2">${f.entity_id ?? '-'}</td>
                    <td class="px-3 py-2">${formatPeriod(f.forecast_period)}</td>
                    <td class="px-3 py-2">${translateForecastType(f.forecast_type)}</td>
                    <td class="px-3 py-2">${formatMoney(f.forecast_amount)}</td>
                    <td class="px-3 py-2">${formatPercent(f.confidence_level)}</td>
                    <td class="px-3 py-2">${sanitizeText(f.ai_model)}</td>
                    <td class="px-3 py-2">${truncate(sanitizeText(f.ai_insights))}</td>
                    <td class="px-3 py-2">${formatDateTime(f.created_at)}</td>
                </tr>
            `).join('');
            document.getElementById('forecastTable').innerHTML = forecastRows || `<tr><td colspan="9" class="px-4 py-12 text-center text-slate-500">ูุง ุชูุฌุฏ ุจูุงูุงุช</td></tr>`;
            document.getElementById('forecastCount').textContent = `ุนุฏุฏ ุงูุตููู: ${forecasts.length}`;

            const riskRows = riskScores.map(r => `
                <tr class="hover:bg-rose-50">
                    <td class="px-3 py-2">${r.risk_id ?? '-'}</td>
                    <td class="px-3 py-2">${r.customer_id ?? '-'}</td>
                    <td class="px-3 py-2">${formatDate(r.assessment_date)}</td>
                    <td class="px-3 py-2">${formatPercent(r.risk_score)}</td>
                    <td class="px-3 py-2">${translateRiskLevel(r.risk_level)}</td>
                    <td class="px-3 py-2">${truncate(sanitizeText(r.risk_factors))}</td>
                    <td class="px-3 py-2">${truncate(sanitizeText(r.calculation_details))}</td>
                    <td class="px-3 py-2">${truncate(sanitizeText(r.recommendations))}</td>
                    <td class="px-3 py-2">${truncate(sanitizeText(r.suggested_actions))}</td>
                    <td class="px-3 py-2">${translateEntityType(r.entity_type)}</td>
                    <td class="px-3 py-2">${r.entity_id ?? '-'}</td>
                    <td class="px-3 py-2">${sanitizeText(r.model_version)}</td>
                    <td class="px-3 py-2">${formatDateTime(r.created_at)}</td>
                </tr>
            `).join('');
            document.getElementById('riskTable').innerHTML = riskRows || `<tr><td colspan="13" class="px-4 py-12 text-center text-slate-500">ูุง ุชูุฌุฏ ุจูุงูุงุช</td></tr>`;
            document.getElementById('riskCount').textContent = `ุนุฏุฏ ุงูุตููู: ${riskScores.length}`;
        }

        function applyDemoFallbackIfEmpty() {
            const hasData = (cashflowOperating.length + cashflowInvesting.length + cashflowFinancing.length + forecasts.length + riskScores.length + invoices.length + payments.length + arAging.length) > 0;
            if (hasData) {
                isDemoMode = false;
                const banner = document.getElementById('demoBanner');
                if (banner) banner.classList.add('hidden');
                return;
            }

            isDemoMode = true;
            const banner = document.getElementById('demoBanner');
            if (banner) banner.classList.remove('hidden');

            const today = new Date();
            const daysAgo = (n) => new Date(today.getTime() - n * 24 * 60 * 60 * 1000).toISOString();

            cashflowOperating = [
                { flow_id: 101, flow_type: 'collection', amount: 180000, description: 'ุชุญุตูู ุนููุงุก ุฑุฆูุณู', flow_date: daysAgo(3), entity_id: CASHFLOW_ENTITY_ID, created_by: 'system', created_at: daysAgo(3) },
                { flow_id: 102, flow_type: 'payment', amount: -95000, description: 'ุฏูุนุงุช ููุฑุฏูู', flow_date: daysAgo(2), entity_id: CASHFLOW_ENTITY_ID, created_by: 'system', created_at: daysAgo(2) }
            ];
            cashflowInvesting = [
                { flow_id: 201, flow_type: 'investment', amount: -45000, description: 'ุงุณุชุซูุงุฑ ุชูุณุนู', flow_date: daysAgo(6), entity_id: CASHFLOW_ENTITY_ID, created_by: 'system', created_at: daysAgo(6) }
            ];
            cashflowFinancing = [
                { flow_id: 301, flow_type: 'loan_received', amount: 120000, description: 'ุชูููู ูุตูุฑ ุงูุฃุฌู', flow_date: daysAgo(10), entity_id: CASHFLOW_ENTITY_ID, created_by: 'system', created_at: daysAgo(10) }
            ];
            cashflowOverview = {
                success: true,
                operating: { inflow: 180000, outflow: -95000 },
                investing: { inflow: 0, outflow: -45000 },
                financing: { inflow: 120000, outflow: 0 },
                total_net_cashflow: 160000
            };
            forecasts = [
                { forecast_id: 1, entity_id: CASHFLOW_ENTITY_ID, forecast_period: '30D', forecast_type: 'CASHFLOW', forecast_amount: 145000, confidence_level: 84, ai_model: 'Naiosh-AI', ai_insights: 'ุฒูุงุฏุฉ ุงูุชุฏููุงุช ูุชูุฌุฉ ุงูุชุญุตูู', created_at: daysAgo(1) },
                { forecast_id: 2, entity_id: CASHFLOW_ENTITY_ID, forecast_period: '90D', forecast_type: 'CASHFLOW', forecast_amount: 380000, confidence_level: 79, ai_model: 'Naiosh-AI', ai_insights: 'ุงุณุชูุฑุงุฑ ูุณุจู ูุน ูุฎุงุทุฑ ููุณููุฉ', created_at: daysAgo(7) }
            ];
            riskScores = [
                { risk_id: 10, customer_id: 'C-1001', assessment_date: daysAgo(2), risk_score: 72, risk_level: 'HIGH', risk_factors: 'ุชุฃุฎุฑ ุณุฏุงุฏ', calculation_details: 'ูุณุจุฉ ุชุฃุฎุฑ 35%', recommendations: 'ุชูุซูู ุงูุชุญุตูู', suggested_actions: 'ุฎุทุฉ ุณุฏุงุฏ', entity_type: 'HQ', entity_id: CASHFLOW_ENTITY_ID, model_version: 'v2.3', created_at: daysAgo(2) },
                { risk_id: 11, customer_id: 'C-1015', assessment_date: daysAgo(4), risk_score: 48, risk_level: 'MEDIUM', risk_factors: 'ุชุฐุจุฐุจ ุชุฏููุงุช', calculation_details: 'ูุชูุณุท ุฑุตูุฏ', recommendations: 'ูุชุงุจุนุฉ ุฃุณุจูุนูุฉ', suggested_actions: 'ูุฑุงุฌุนุฉ ุนููุฏ', entity_type: 'BRANCH', entity_id: CASHFLOW_ENTITY_ID, model_version: 'v2.3', created_at: daysAgo(4) }
            ];
            invoices = [
                { invoice_id: 501, customer_id: 'C-1001', total_amount: 180000, status: 'OVERDUE', risk_level: 'HIGH', branch_id: 'B-01', program_id: 'P-01' }
            ];
            payments = [
                { payment_id: 601, customer_id: 'C-1001', payment_amount: 45000, branch_id: 'B-01', program_id: 'P-01' }
            ];
            arAging = [
                { customer_id: 'C-1001', remaining_amount: 135000, branch_id: 'B-01', program_id: 'P-01' }
            ];
        }

        function renderEnhancements() {
            renderCashflowQuality();
            renderCashflowAlerts();
            renderQuickIndicators();
        }

        function renderCashflowQuality() {
            const merged = mergeCashflows();
            const totalNet = merged.reduce((sum, row) => sum + parseFloat(row.amount || 0), 0);
            const inflow = merged.filter(r => parseFloat(r.amount || 0) >= 0).reduce((sum, r) => sum + parseFloat(r.amount || 0), 0);
            const outflow = merged.filter(r => parseFloat(r.amount || 0) < 0).reduce((sum, r) => sum + Math.abs(parseFloat(r.amount || 0)), 0);
            const volatility = inflow + outflow ? Math.round((outflow / (inflow + outflow)) * 100) : 0;
            const qualityScore = inflow ? Math.max(10, 100 - volatility) : 0;

            const qualityEl = document.getElementById('cashflowQualityScore');
            if (qualityEl) qualityEl.textContent = `${qualityScore}%`;

            const volEl = document.getElementById('cashflowVolatility');
            if (volEl) volEl.textContent = `${volatility}%`;

            const progressEl = document.getElementById('cashflowQualityProgress');
            if (progressEl) progressEl.style.width = `${qualityScore}%`;

            const badgeEl = document.getElementById('cashflowQualityBadge');
            if (badgeEl) {
                if (qualityScore >= 85) {
                    badgeEl.textContent = 'ููุชุงุฒ';
                    badgeEl.className = 'chip bg-emerald-100 text-emerald-700';
                } else if (qualityScore >= 65) {
                    badgeEl.textContent = 'ูุณุชูุฑ';
                    badgeEl.className = 'chip bg-amber-100 text-amber-700';
                } else {
                    badgeEl.textContent = 'ูุชููุจ';
                    badgeEl.className = 'chip bg-rose-100 text-rose-700';
                }
            }

            const net30 = merged.filter(r => new Date(r.flow_date) >= new Date(Date.now() - 30 * 24 * 60 * 60 * 1000))
                .reduce((sum, r) => sum + parseFloat(r.amount || 0), 0);
            const net30El = document.getElementById('net30');
            if (net30El) net30El.textContent = formatMoney(net30);

            const syncEl = document.getElementById('lastSync');
            if (syncEl) syncEl.textContent = lastSyncAt ? lastSyncAt.toLocaleString('ar-SA') : '-';
        }

        function renderCashflowAlerts() {
            const alertsEl = document.getElementById('cashflowAlerts');
            if (!alertsEl) return;
            const merged = mergeCashflows();
            const net = merged.reduce((sum, row) => sum + parseFloat(row.amount || 0), 0);
            const highRiskCount = riskScores.filter(r => ['HIGH', 'CRITICAL'].includes(String(r.risk_level || '').toUpperCase())).length;
            const overdueCount = invoices.filter(i => String(i.status || '').toUpperCase() === 'OVERDUE').length;

            const alerts = [
                net < 0 ? `โ๏ธ ุตุงูู ุงูุชุฏูู ุณูุจู ุจูููุฉ <strong>${formatMoney(net)}</strong>` : 'โ ุตุงูู ุงูุชุฏูู ููุฌุจ ููุณุชูุฑ.',
                highRiskCount ? `๐ฉ ููุฌุฏ <strong>${highRiskCount}</strong> ุนููู ุนุงูู ุงููุฎุงุทุฑ ูุญุชุงุฌ ูุชุงุจุนุฉ.` : 'โ ูุง ุชูุฌุฏ ูุฎุงุทุฑ ุนุงููุฉ ุจุงุฑุฒุฉ.',
                overdueCount ? `๐ณ ููุงู <strong>${overdueCount}</strong> ูุงุชูุฑุฉ ูุชุฃุฎุฑุฉ ุนู ุงูุณุฏุงุฏ.` : 'โ ูุง ุชูุฌุฏ ููุงุชูุฑ ูุชุฃุฎุฑุฉ ุญุงููุงู.',
                isDemoMode ? '๐งช ุจูุงูุงุช ุชุฌุฑูุจูุฉ ููุฏ ุงูุนุฑุถ ุญุชู ุชูุนูู ุงูุจูุงูุงุช ุงููุนููุฉ.' : 'โ ุงูุจูุงูุงุช ุญูุฉ ููุชู ุชุญุฏูุซูุง ุชููุงุฆูุงู.'
            ];

            alertsEl.innerHTML = alerts.map(text => `<div class="bg-slate-50 rounded-xl p-3">${text}</div>`).join('');
        }

        function renderQuickIndicators() {
            const totalInvoices = invoices.reduce((sum, i) => sum + parseFloat(i.total_amount || 0), 0);
            const totalPayments = payments.reduce((sum, p) => sum + parseFloat(p.payment_amount || 0), 0);
            const collectionRate = totalInvoices ? Math.min(100, (totalPayments / totalInvoices) * 100) : 0;

            const highRiskCount = riskScores.filter(r => ['HIGH', 'CRITICAL'].includes(String(r.risk_level || '').toUpperCase())).length;
            const highRiskShare = riskScores.length ? (highRiskCount / riskScores.length) * 100 : 0;

            const avgCollection = payments.length ? (totalPayments / payments.length) : 0;
            const netLiquidity = mergeCashflows().reduce((sum, row) => sum + parseFloat(row.amount || 0), 0);

            const collectionRateEl = document.getElementById('collectionRate');
            if (collectionRateEl) collectionRateEl.textContent = `${collectionRate.toFixed(1)}%`;

            const highRiskShareEl = document.getElementById('highRiskShare');
            if (highRiskShareEl) highRiskShareEl.textContent = `${highRiskShare.toFixed(1)}%`;

            const avgCollectionEl = document.getElementById('avgCollection');
            if (avgCollectionEl) avgCollectionEl.textContent = formatMoney(avgCollection);

            const netLiquidityEl = document.getElementById('netLiquidity');
            if (netLiquidityEl) netLiquidityEl.textContent = formatMoney(netLiquidity);

            const sourceTotals = mergeCashflows().reduce((acc, row) => {
                const key = translateFlowType(row.flow_type) || 'ุบูุฑ ูุญุฏุฏ';
                acc[key] = (acc[key] || 0) + Math.abs(parseFloat(row.amount || 0));
                return acc;
            }, {});

            const topSourcesEl = document.getElementById('topSources');
            if (topSourcesEl) {
                const items = Object.entries(sourceTotals).sort((a, b) => b[1] - a[1]).slice(0, 4);
                topSourcesEl.innerHTML = items.length
                    ? items.map(([name, amount]) => `
                        <div class="flex items-center justify-between bg-slate-50 rounded-xl px-3 py-2">
                            <span>${name}</span>
                            <span class="chip bg-indigo-100 text-indigo-700">${formatMoney(amount)}</span>
                        </div>
                    `).join('')
                    : '<div class="text-slate-500">ูุง ุชูุฌุฏ ุจูุงูุงุช ูุงููุฉ</div>';
            }
        }

        function mergeCashflows() {
            const tag = (rows, source) => rows.map(r => ({ ...r, source }));
            return [...tag(cashflowOperating, 'operating'), ...tag(cashflowInvesting, 'investing'), ...tag(cashflowFinancing, 'financing')]
                .sort((a, b) => new Date(b.flow_date) - new Date(a.flow_date));
        }

        function groupByDate(rows) {
            return rows.reduce((acc, row) => {
                const date = row.flow_date ? new Date(row.flow_date).toISOString().split('T')[0] : 'ุบูุฑ ูุญุฏุฏ';
                if (!acc[date]) acc[date] = { inflow: 0, outflow: 0, net: 0 };
                const amount = parseFloat(row.amount || 0);
                if (amount >= 0) acc[date].inflow += amount;
                else acc[date].outflow += amount;
                acc[date].net += amount;
                return acc;
            }, {});
        }

        function sumAmounts(rows) {
            return rows.reduce((sum, r) => sum + parseFloat(r.amount || 0), 0);
        }

        function average(values) {
            if (!values.length) return 0;
            return values.reduce((sum, v) => sum + v, 0) / values.length;
        }

        function extractInsight(value) {
            if (!value) return '';
            try {
                const parsed = typeof value === 'string' ? JSON.parse(value) : value;
                return parsed?.risks?.[0] || parsed?.trend || '';
            } catch {
                return String(value).slice(0, 120);
            }
        }

        function formatMoney(value) {
            const num = parseFloat(value || 0);
            return num.toLocaleString('ar-SA') + ' ุฑ.ุณ';
        }

        function formatDate(value) {
            if (!value) return '-';
            return new Date(value).toLocaleDateString('ar-SA');
        }

        function formatDateTime(value) {
            if (!value) return '-';
            return new Date(value).toLocaleString('ar-SA');
        }

        function truncate(value) {
            if (value === null || value === undefined) return '-';
            const text = typeof value === 'string' ? value : JSON.stringify(value);
            return text.length > 120 ? text.slice(0, 120) + '...' : text;
        }

        function downloadAllJSON() {
            const payload = {
                cashflow_overview: cashflowOverview,
                cashflow_operating: cashflowOperating,
                cashflow_investing: cashflowInvesting,
                cashflow_financing: cashflowFinancing,
                forecasts,
                risk_scores: riskScores,
                invoices,
                payments,
                ar_aging: arAging
            };
            downloadBlob(JSON.stringify(payload, null, 2), 'ุงูุชุฏููุงุช-ูุงููุฎุงุทุฑ-ูุงูุชูุงุฑูุฑ.json', 'application/json');
        }

        function downloadAllCSV() {
            const rows = [];
            rows.push(['ูุนุงููุงุช ุงูุชุฏูู ุงูููุฏู']);
            rows.push(['ุฑูู ุงูุชุฏูู','ููุน ุงูุชุฏูู','ุงููุจูุบ','ุงููุตู','ุชุงุฑูุฎ ุงูุชุฏูู','ูุนุฑู ุงูููุดุฃุฉ','ููุดุฆ ุงูุณุฌู','ุชุงุฑูุฎ ุงูุฅูุดุงุก','ุงููุตุฏุฑ']);
            mergeCashflows().forEach(r => rows.push([r.flow_id, translateFlowType(r.flow_type), r.amount, sanitizeText(r.description), r.flow_date, r.entity_id, r.created_by, r.created_at, r.source]));

            rows.push([]);
            rows.push(['ุงูุชููุนุงุช ุงูุฐููุฉ']);
            rows.push(['ุฑูู ุงูุชููุน','ูุนุฑู ุงูููุดุฃุฉ','ูุชุฑุฉ ุงูุชููุน','ููุน ุงูุชููุน','ูููุฉ ุงูุชููุน','ูุณุชูู ุงูุซูุฉ','ูููุฐุฌ ุงูุฐูุงุก','ููุงุญุธุงุช ุงูุฐูุงุก','ุชุงุฑูุฎ ุงูุฅูุดุงุก']);
            forecasts.forEach(f => rows.push([f.forecast_id, f.entity_id, f.forecast_period, translateForecastType(f.forecast_type), f.forecast_amount, f.confidence_level, sanitizeText(f.ai_model), sanitizeText(f.ai_insights), f.created_at]));

            rows.push([]);
            rows.push(['ุชููููุงุช ุงููุฎุงุทุฑ']);
            rows.push(['ุฑูู ุงููุฎุงุทุฑ','ุฑูู ุงูุนููู','ุชุงุฑูุฎ ุงูุชูููู','ุฏุฑุฌุฉ ุงููุฎุงุทุฑุฉ','ูุณุชูู ุงููุฎุงุทุฑุฉ','ุนูุงูู ุงููุฎุงุทุฑ','ุชูุงุตูู ุงูุญุณุงุจ','ุงูุชูุตูุงุช','ุฅุฌุฑุงุกุงุช ููุชุฑุญุฉ','ููุน ุงูููุดุฃุฉ','ูุนุฑู ุงูููุดุฃุฉ','ูุณุฎุฉ ุงููููุฐุฌ','ุชุงุฑูุฎ ุงูุฅูุดุงุก']);
            riskScores.forEach(r => rows.push([r.risk_id, r.customer_id, r.assessment_date, r.risk_score, translateRiskLevel(r.risk_level), sanitizeText(r.risk_factors), sanitizeText(r.calculation_details), sanitizeText(r.recommendations), sanitizeText(r.suggested_actions), translateEntityType(r.entity_type), r.entity_id, sanitizeText(r.model_version), r.created_at]));

            const csvContent = rows.map(r => r.map(v => `"${v ?? ''}"`).join(',')).join('\n');
            downloadBlob(csvContent, 'ุงูุชุฏููุงุช-ูุงููุฎุงุทุฑ-ูุงูุชูุงุฑูุฑ.csv', 'text/csv;charset=utf-8;');
        }

        function downloadReport(type) {
            const report = buildReport(type);
            const nameMap = {
                'customer-statement': 'ูุดู-ุญุณุงุจ-ุงูุนููุงุก',
                'overdue-customers': 'ุงูุนููุงุก-ุงููุชุฃุฎุฑูู',
                'top-balances': 'ุงูุนููุงุก-ุงูุฃุนูู-ุฑุตูุฏูุง',
                'branch-collections': 'ุชุญุตูู-ุงููุฑูุน',
                'branch-ar': 'ุฐูู-ุงููุฑูุน',
                'branch-cashflow': 'ุชุฏูู-ุงููุฑูุน',
                'incubator-programs': 'ุฃุฏุงุก-ุจุฑุงูุฌ-ุงูุญุงุถูุงุช',
                'incubator-collections': 'ุชุญุตูู-ุงูุญุงุถูุงุช',
                'incubator-ar': 'ุฐูู-ุงูุญุงุถูุงุช',
                'empire-monthly': 'ุชูุฑูุฑ-ูุงูู-ุดูุฑู',
                'empire-quarterly': 'ุชูุฑูุฑ-ูุงูู-ุฑุจุน-ุณููู',
                'empire-risk': 'ุชูุฑูุฑ-ุงููุฎุงุทุฑ',
                'empire-forecast': 'ุชูุฑูุฑ-ุงูุชููุนุงุช'
            };
            const fileName = nameMap[type] || 'ุชูุฑูุฑ';
            downloadBlob(JSON.stringify(report, null, 2), `${fileName}.json`, 'application/json');
        }

        function buildReport(type) {
            switch (type) {
                case 'customer-statement':
                    return buildCustomerStatement();
                case 'overdue-customers':
                    return { overdue_invoices: invoices.filter(i => String(i.status || '').toUpperCase() === 'OVERDUE') };
                case 'top-balances':
                    return { top_balances: arAging.sort((a, b) => parseFloat(b.remaining_amount || 0) - parseFloat(a.remaining_amount || 0)).slice(0, 10) };
                case 'branch-collections':
                    return { branch_collections: groupSum(payments, 'branch_id', 'payment_amount') };
                case 'branch-ar':
                    return { branch_ar: groupSum(arAging, 'branch_id', 'remaining_amount') };
                case 'branch-cashflow':
                    return { cashflow_overview: cashflowOverview };
                case 'incubator-programs':
                    return { program_performance: groupSum(invoices, 'program_id', 'total_amount') };
                case 'incubator-collections':
                    return { program_collections: groupSum(payments, 'program_id', 'payment_amount') };
                case 'incubator-ar':
                    return { program_ar: groupSum(arAging, 'program_id', 'remaining_amount') };
                case 'empire-monthly':
                    return { monthly_cashflow: cashflowOverview };
                case 'empire-quarterly':
                    return { quarterly_forecasts: forecasts };
                case 'empire-risk':
                    return { risk_scores: riskScores };
                case 'empire-forecast':
                    return { forecasts };
                default:
                    return { ุฎุทุฃ: 'ููุน ุชูุฑูุฑ ุบูุฑ ูุนุฑูู' };
            }
        }

        function translateFlowType(value) {
            const map = {
                collection: 'ุชุญุตูู',
                payment: 'ูุฏููุนุงุช',
                salary: 'ุฑูุงุชุจ',
                expense: 'ูุตุฑููุงุช ุชุดุบูููุฉ',
                asset_purchase: 'ุดุฑุงุก ุฃุตูู',
                investment: 'ุงุณุชุซูุงุฑ',
                other_investing: 'ุฃูุดุทุฉ ุงุณุชุซูุงุฑูุฉ ุฃุฎุฑู',
                capital_injection: 'ุฒูุงุฏุฉ ุฑุฃุณ ุงููุงู',
                loan_received: 'ูุฑุถ ูุณุชูู',
                loan_payment: 'ุณุฏุงุฏ ูุฑุถ',
                dividend_payment: 'ุชูุฒูุน ุฃุฑุจุงุญ'
            };
            return map[value] || 'ุบูุฑ ูุญุฏุฏ';
        }

        function translateRiskLevel(value) {
            const map = { HIGH: 'ูุฑุชูุน', MEDIUM: 'ูุชูุณุท', LOW: 'ููุฎูุถ', CRITICAL: 'ุญุฑุฌ' };
            return map[String(value || '').toUpperCase()] || 'ุบูุฑ ูุญุฏุฏ';
        }

        function translateEntityType(value) {
            const map = { HQ: 'ูุฑูุฒ ุฑุฆูุณู', BRANCH: 'ูุฑุน', PLATFORM: 'ููุตุฉ', INCUBATOR: 'ุญุงุถูุฉ', PROGRAM: 'ุจุฑูุงูุฌ' };
            return map[String(value || '').toUpperCase()] || 'ุบูุฑ ูุญุฏุฏ';
        }

        function translateForecastType(value) {
            const map = { REVENUE: 'ุฅูุฑุงุฏุงุช', EXPENSE: 'ูุตุฑููุงุช', CASHFLOW: 'ุชุฏููุงุช ููุฏูุฉ', DEFAULT: 'ุชุนุซุฑ' };
            return map[String(value || '').toUpperCase()] || 'ุบูุฑ ูุญุฏุฏ';
        }

        function formatPeriod(value) {
            return value ? sanitizeText(value) : 'ุบูุฑ ูุญุฏุฏ';
        }

        function formatPercent(value) {
            if (value === null || value === undefined || value === '') return '-';
            const num = parseFloat(value || 0);
            return `${num.toFixed(1)}%`;
        }

        function sanitizeText(value) {
            if (value === null || value === undefined) return '-';
            const text = typeof value === 'string' ? value : JSON.stringify(value);
            const cleaned = text.replace(/[A-Za-z]+/g, '').replace(/\s{2,}/g, ' ').trim();
            return cleaned || '-';
        }

        function buildCustomerStatement() {
            const groupedInvoices = invoices.reduce((acc, inv) => {
                const key = inv.customer_id || 'ุบูุฑ ูุญุฏุฏ';
                if (!acc[key]) acc[key] = { invoices: [], payments: [] };
                acc[key].invoices.push(inv);
                return acc;
            }, {});

            payments.forEach(p => {
                const key = p.customer_id || 'ุบูุฑ ูุญุฏุฏ';
                if (!groupedInvoices[key]) groupedInvoices[key] = { invoices: [], payments: [] };
                groupedInvoices[key].payments.push(p);
            });

            return { customer_statements: groupedInvoices };
        }

        function groupSum(rows, key, valueKey) {
            return rows.reduce((acc, row) => {
                const label = row[key] ?? 'ุบูุฑ ูุญุฏุฏ';
                acc[label] = (acc[label] || 0) + parseFloat(row[valueKey] || 0);
                return acc;
            }, {});
        }

        function downloadBlob(content, filename, type) {
            const blob = new Blob([content], { type });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            link.click();
            URL.revokeObjectURL(url);
        }

        function printReport() {
            window.print();
        }

        function downloadEnhancementPack() {
            const payload = {
                generated_at: new Date().toISOString(),
                demo_mode: isDemoMode,
                cashflow_overview: cashflowOverview,
                cashflow_operating: cashflowOperating,
                cashflow_investing: cashflowInvesting,
                cashflow_financing: cashflowFinancing,
                forecasts,
                risk_scores: riskScores,
                invoices,
                payments,
                ar_aging: arAging,
                indicators: {
                    net_liquidity: mergeCashflows().reduce((sum, row) => sum + parseFloat(row.amount || 0), 0),
                    collection_rate: invoices.length ? (payments.reduce((sum, p) => sum + parseFloat(p.payment_amount || 0), 0) / invoices.reduce((sum, i) => sum + parseFloat(i.total_amount || 0), 0)) * 100 : 0
                }
            };
            downloadBlob(JSON.stringify(payload, null, 2), 'ุชุนุฒูุฒุงุช-ุงูุชุฏููุงุช-ูุงููุฎุงุทุฑ.json', 'application/json');
        }

        function refreshData() {
            loadData();
        }

        document.addEventListener('DOMContentLoaded', loadData);
    </script>
</body>
</html>
