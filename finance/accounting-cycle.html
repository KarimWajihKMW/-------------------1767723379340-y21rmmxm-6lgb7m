<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ§¾ Ø§Ù„Ø¯ÙˆØ±Ø© Ø§Ù„Ù…Ø­Ø§Ø³Ø¨ÙŠØ© Ø§Ù„ÙƒØ§Ù…Ù„Ø© - Ù†Ø¸Ø§Ù… Ù†Ø§ÙŠÙˆØ´</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Cairo', sans-serif;
            background: #f9fafb; /* Slate-50 */
            min-height: 100vh;
        }
        .card-gradient {
            background: linear-gradient(135deg, rgba(255,255,255,0.95), rgba(255,255,255,0.98));
            backdrop-filter: blur(10px);
        }
        .stat-card { transition: transform 0.3s, box-shadow 0.3s; }
        .stat-card:hover { transform: translateY(-5px); box-shadow: 0 14px 28px rgba(15,23,42,0.15); }
        .shape-pill { border-radius: 999px; }
        .shape-angle { border-radius: 28px 8px 28px 8px; }
        .shape-wave { border-radius: 28px 28px 6px 28px; }
        .shape-arc { border-radius: 18px 40px 18px 40px; }
        .chart-container { position: relative; height: 280px; }
        .table-scroll { max-height: 520px; overflow: auto; }
        .section-accent-sky { border-top: 4px solid #0ea5e9; }
        .section-accent-emerald { border-top: 4px solid #10b981; }
        .section-accent-amber { border-top: 4px solid #f59e0b; }
        .section-accent-indigo { border-top: 4px solid #6366f1; }
        .section-accent-rose { border-top: 4px solid #f43f5e; }
        .badge { padding: 6px 12px; border-radius: 999px; font-weight: 700; }
        details > summary { cursor: pointer; }
    </style>
</head>
<body>
    <div class="container mx-auto px-4 py-8">
        <div class="mb-8 text-slate-900">
            <h1 class="text-4xl font-bold mb-2">ğŸ§¾ Ø§Ù„Ø¯ÙˆØ±Ø© Ø§Ù„Ù…Ø­Ø§Ø³Ø¨ÙŠØ© Ø§Ù„ÙƒØ§Ù…Ù„Ø© Ø¯Ø§Ø®Ù„ Ù†Ø§ÙŠÙˆØ´</h1>
            <p class="text-lg opacity-90">Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„ÙŠÙˆÙ…ÙŠØ© + Ø¥Ù‚ÙØ§Ù„ Ø§Ù„ÙØªØ±Ø© + Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ø®ØªØ§Ù…ÙŠØ© (Ø§Ù„ØµÙØ­Ø© 29)</p>
        </div>

        <div class="mb-6 flex flex-wrap gap-3">
            <button onclick="refreshData()" class="bg-white text-gray-800 px-6 py-3 rounded-xl font-bold shadow-sm hover:shadow-md hover:bg-gray-50 transition flex items-center gap-3 border border-gray-200 hover:border-emerald-500 group">
                <i class="fas fa-rotate text-xl text-emerald-600 group-hover:text-emerald-700 transition"></i>
                ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            </button>
            <button onclick="downloadJSON()" class="bg-white text-gray-800 px-6 py-3 rounded-xl font-bold shadow-sm hover:shadow-md hover:bg-gray-50 transition flex items-center gap-3 border border-gray-200 hover:border-indigo-500 group">
                <i class="fas fa-file-code text-xl text-indigo-600 group-hover:text-indigo-700 transition"></i>
                ØªÙ†Ø²ÙŠÙ„ JSON
            </button>
            <button onclick="downloadCSV()" class="bg-white text-gray-800 px-6 py-3 rounded-xl font-bold shadow-sm hover:shadow-md hover:bg-gray-50 transition flex items-center gap-3 border border-gray-200 hover:border-blue-500 group">
                <i class="fas fa-file-csv text-xl text-blue-600 group-hover:text-blue-700 transition"></i>
                ØªÙ†Ø²ÙŠÙ„ CSV
            </button>
            <button onclick="printReport()" class="bg-rose-600 text-white px-6 py-3 rounded-full font-bold hover:shadow-lg transition flex items-center gap-2">
                <i class="fas fa-print text-xl text-gray-600 group-hover:text-gray-700 transition"></i>
                Ø·Ø¨Ø§Ø¹Ø©
            </button>
        </div>

        <!-- Daily Operations -->
        <div class="card-gradient rounded-xl shadow-2xl p-6 mb-8 section-accent-sky">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-2xl font-bold text-slate-800">ğŸ“Œ Ø¥Ø«Ø¨Ø§Øª Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ù…Ø§Ù„ÙŠØ© Ø§Ù„ÙŠÙˆÙ…ÙŠØ©</h2>
                <span class="text-sm text-slate-500">ÙƒÙ„ Ø¹Ù…Ù„ÙŠØ© ØªÙØ³Ø¬Ù„ Ø¨Ù‚ÙŠØ¯ Ù…Ø­Ø§Ø³Ø¨ÙŠ ØªÙ„Ù‚Ø§Ø¦ÙŠ</span>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-5 mb-6">
                <div class="stat-card shape-pill bg-gradient-to-br from-sky-500 to-blue-600 text-white p-5">
                    <div class="flex justify-between mb-3"><span>Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</span><i class="fas fa-file-invoice-dollar text-2xl opacity-70"></i></div>
                    <div id="salesKpi" class="text-3xl font-bold"><div class="animate-pulse">...</div></div>
                </div>
                <div class="stat-card shape-angle bg-gradient-to-br from-emerald-500 to-teal-600 text-white p-5">
                    <div class="flex justify-between mb-3"><span>Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª</span><i class="fas fa-receipt text-2xl opacity-70"></i></div>
                    <div id="expensesKpi" class="text-3xl font-bold"><div class="animate-pulse">...</div></div>
                </div>
                <div class="stat-card shape-wave bg-gradient-to-br from-indigo-500 to-purple-600 text-white p-5">
                    <div class="flex justify-between mb-3"><span>Ø§Ù„ØªØ­ØµÙŠÙ„</span><i class="fas fa-sack-dollar text-2xl opacity-70"></i></div>
                    <div id="collectionsKpi" class="text-3xl font-bold"><div class="animate-pulse">...</div></div>
                </div>
                <div class="stat-card shape-arc bg-gradient-to-br from-amber-500 to-orange-600 text-white p-5">
                    <div class="flex justify-between mb-3"><span>Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª</span><i class="fas fa-credit-card text-2xl opacity-70"></i></div>
                    <div id="paymentsKpi" class="text-3xl font-bold"><div class="animate-pulse">...</div></div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="card-gradient rounded-2xl p-5 shadow-lg section-accent-emerald">
                    <h3 class="text-lg font-bold text-slate-800 mb-4">ğŸ“Š ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„ÙŠÙˆÙ…ÙŠØ©</h3>
                    <div class="chart-container">
                        <canvas id="dailyOpsChart"></canvas>
                    </div>
                </div>
                <div class="card-gradient rounded-2xl p-5 shadow-lg section-accent-amber">
                    <h3 class="text-lg font-bold text-slate-800 mb-4">ğŸ§  Ø£Ù…Ø«Ù„Ø© Ù‚ÙŠÙˆØ¯ ØªÙ„Ù‚Ø§Ø¦ÙŠØ©</h3>
                    <div id="autoEntries" class="space-y-3 text-sm text-slate-700">
                        <div class="animate-pulse">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Period Closing -->
        <div class="card-gradient rounded-xl shadow-2xl p-6 mb-8 section-accent-indigo">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-2xl font-bold text-slate-800">ğŸ§¾ Ø¥Ù‚ÙØ§Ù„ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ù…Ø­Ø§Ø³Ø¨ÙŠØ© (Period Closing)</h2>
                <span class="text-sm text-slate-500">Ø­Ø§Ù„Ø© Ø§Ù„Ø¥Ù‚ÙØ§Ù„ ÙˆÙÙ‚ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©</span>
            </div>
            <div id="closingChecklist" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
        </div>

        <!-- Final Statements -->
        <div class="card-gradient rounded-xl shadow-2xl p-6 mb-8 section-accent-emerald">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-2xl font-bold text-slate-800">ğŸ“ˆ Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ù…Ø§Ù„ÙŠØ© Ø§Ù„Ø®ØªØ§Ù…ÙŠØ©</h2>
                <span class="text-sm text-slate-500">Income Statement + Balance Sheet + Cash Flow</span>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-5 mb-6">
                <div class="stat-card shape-pill bg-white text-slate-800 p-5 shadow-lg">
                    <div class="flex justify-between mb-3"><span>Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª</span><i class="fas fa-arrow-up text-emerald-600"></i></div>
                    <div id="totalRevenue" class="text-2xl font-bold"><div class="animate-pulse">...</div></div>
                </div>
                <div class="stat-card shape-angle bg-white text-slate-800 p-5 shadow-lg">
                    <div class="flex justify-between mb-3"><span>Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª</span><i class="fas fa-arrow-down text-rose-600"></i></div>
                    <div id="totalExpenses" class="text-2xl font-bold"><div class="animate-pulse">...</div></div>
                </div>
                <div class="stat-card shape-wave bg-white text-slate-800 p-5 shadow-lg">
                    <div class="flex justify-between mb-3"><span>ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­</span><i class="fas fa-chart-line text-indigo-600"></i></div>
                    <div id="netIncome" class="text-2xl font-bold"><div class="animate-pulse">...</div></div>
                </div>
                <div class="stat-card shape-arc bg-white text-slate-800 p-5 shadow-lg">
                    <div class="flex justify-between mb-3"><span>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£ØµÙˆÙ„</span><i class="fas fa-building-columns text-sky-600"></i></div>
                    <div id="totalAssets" class="text-2xl font-bold"><div class="animate-pulse">...</div></div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="card-gradient rounded-2xl p-5 shadow-lg section-accent-amber">
                    <h3 class="text-lg font-bold text-slate-800 mb-4">ğŸ’§ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØªØ¯ÙÙ‚Ø§Øª Ø§Ù„Ù†Ù‚Ø¯ÙŠØ©</h3>
                    <div class="chart-container">
                        <canvas id="cashflowStatementChart"></canvas>
                    </div>
                </div>
                <div class="card-gradient rounded-2xl p-5 shadow-lg section-accent-rose">
                    <h3 class="text-lg font-bold text-slate-800 mb-4">âš–ï¸ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø±ÙƒØ² Ø§Ù„Ù…Ø§Ù„ÙŠ</h3>
                    <div id="balanceSummary" class="space-y-3 text-sm text-slate-700"></div>
                </div>
            </div>
        </div>

        <!-- Data Tables -->
        <div class="space-y-6">
            <details class="card-gradient rounded-xl shadow-2xl p-6 section-accent-sky" open>
                <summary class="text-xl font-bold text-slate-800">ğŸ§¾ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„ÙŠÙˆÙ…ÙŠØ© (ÙÙˆØ§ØªÙŠØ± + Ù…ØµØ±ÙˆÙØ§Øª + Ù…Ø¯ÙÙˆØ¹Ø§Øª)</summary>
                <div class="mt-4 space-y-6">
                    <div>
                        <div class="flex justify-between mb-2"><h4 class="font-bold text-slate-700">Ø§Ù„ÙÙˆØ§ØªÙŠØ± (Sales)</h4><span id="invoicesCount" class="text-sm text-slate-500"></span></div>
                        <div class="table-scroll"><table class="w-full text-xs"><thead id="invoicesHead" class="bg-sky-50 text-sky-700"></thead><tbody id="invoicesTable" class="divide-y divide-slate-100"></tbody></table></div>
                    </div>
                    <div>
                        <div class="flex justify-between mb-2"><h4 class="font-bold text-slate-700">Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª</h4><span id="expensesCount" class="text-sm text-slate-500"></span></div>
                        <div class="table-scroll"><table class="w-full text-xs"><thead id="expensesHead" class="bg-rose-50 text-rose-700"></thead><tbody id="expensesTable" class="divide-y divide-slate-100"></tbody></table></div>
                    </div>
                    <div>
                        <div class="flex justify-between mb-2"><h4 class="font-bold text-slate-700">Ø§Ù„ØªØ­ØµÙŠÙ„ (Payments)</h4><span id="paymentsCount" class="text-sm text-slate-500"></span></div>
                        <div class="table-scroll"><table class="w-full text-xs"><thead id="paymentsHead" class="bg-emerald-50 text-emerald-700"></thead><tbody id="paymentsTable" class="divide-y divide-slate-100"></tbody></table></div>
                    </div>
                </div>
            </details>

            <details class="card-gradient rounded-xl shadow-2xl p-6 section-accent-indigo">
                <summary class="text-xl font-bold text-slate-800">ğŸ“š Ø§Ù„Ù‚ÙŠÙˆØ¯ Ø§Ù„Ù…Ø­Ø§Ø³Ø¨ÙŠØ© Ø§Ù„Ø¢Ù„ÙŠØ©</summary>
                <div class="mt-4 space-y-6">
                    <div>
                        <div class="flex justify-between mb-2"><h4 class="font-bold text-slate-700">Ù‚ÙŠÙˆØ¯ Ø§Ù„ÙŠÙˆÙ…ÙŠØ©</h4><span id="entriesCount" class="text-sm text-slate-500"></span></div>
                        <div class="table-scroll"><table class="w-full text-xs"><thead id="entriesHead" class="bg-indigo-50 text-indigo-700"></thead><tbody id="entriesTable" class="divide-y divide-slate-100"></tbody></table></div>
                    </div>
                    <div>
                        <div class="flex justify-between mb-2"><h4 class="font-bold text-slate-700">Ø³Ø·ÙˆØ± Ø§Ù„Ù‚ÙŠÙˆØ¯</h4><span id="linesCount" class="text-sm text-slate-500"></span></div>
                        <div class="table-scroll"><table class="w-full text-xs"><thead id="linesHead" class="bg-sky-50 text-sky-700"></thead><tbody id="linesTable" class="divide-y divide-slate-100"></tbody></table></div>
                    </div>
                </div>
            </details>

            <details class="card-gradient rounded-xl shadow-2xl p-6 section-accent-amber">
                <summary class="text-xl font-bold text-slate-800">ğŸ“Š Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ù…Ø§Ù„ÙŠØ©</summary>
                <div class="mt-4 space-y-6">
                    <div>
                        <div class="flex justify-between mb-2"><h4 class="font-bold text-slate-700">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¯Ø®Ù„ - Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª</h4><span id="incomeRevenueCount" class="text-sm text-slate-500"></span></div>
                        <div class="table-scroll"><table class="w-full text-xs"><thead id="incomeRevenueHead" class="bg-emerald-50 text-emerald-700"></thead><tbody id="incomeRevenueTable" class="divide-y divide-slate-100"></tbody></table></div>
                    </div>
                    <div>
                        <div class="flex justify-between mb-2"><h4 class="font-bold text-slate-700">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¯Ø®Ù„ - Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª</h4><span id="incomeExpenseCount" class="text-sm text-slate-500"></span></div>
                        <div class="table-scroll"><table class="w-full text-xs"><thead id="incomeExpenseHead" class="bg-rose-50 text-rose-700"></thead><tbody id="incomeExpenseTable" class="divide-y divide-slate-100"></tbody></table></div>
                    </div>
                    <div>
                        <div class="flex justify-between mb-2"><h4 class="font-bold text-slate-700">Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ© Ø§Ù„Ø¹Ù…ÙˆÙ…ÙŠØ©</h4><span id="balanceSheetCount" class="text-sm text-slate-500"></span></div>
                        <div class="table-scroll"><table class="w-full text-xs"><thead id="balanceSheetHead" class="bg-amber-50 text-amber-700"></thead><tbody id="balanceSheetTable" class="divide-y divide-slate-100"></tbody></table></div>
                    </div>
                </div>
            </details>
        </div>
    </div>

    <script>
        const API_BASE = window.location.origin;
        const PRIMARY_ENTITY_ID = '1';
        const SECONDARY_ENTITY_ID = 'HQ001';

        let dataStore = {
            invoices: [],
            expenses: [],
            payments: [],
            entries: [],
            lines: [],
            incomeRevenue: [],
            incomeExpenses: [],
            balanceSheet: null,
            cashflowOverview: null,
            cashflowOperating: [],
            cashflowInvesting: [],
            cashflowFinancing: []
        };

        let dailyOpsChartInstance = null;
        let cashflowChartInstance = null;

        async function fetchJson(url) {
            const res = await fetch(url);
            const data = await res.json();
            return { ok: res.ok, status: res.status, data };
        }

        async function fetchWithFallback(primaryUrl, fallbackUrl) {
            const primary = await fetchJson(primaryUrl);
            if (primary.ok && hasRows(primary.data)) return primary;
            if (!fallbackUrl) return primary;
            const fallback = await fetchJson(fallbackUrl);
            return fallback.ok ? fallback : primary;
        }

        function hasRows(data) {
            const arrays = ['entries','lines','rows','invoices','payments','expenses','revenue_accounts','expense_accounts','assets','liabilities','equity'];
            return arrays.some(key => Array.isArray(data[key]) && data[key].length > 0);
        }

        async function loadData() {
            try {
                const [invoicesRes, expensesRes, paymentsRes, entriesRes, linesRes, incomeRes, balanceRes, overviewRes, operatingRes, investingRes, financingRes] = await Promise.all([
                    fetchJson(`${API_BASE}/finance/invoices`),
                    fetchWithFallback(`${API_BASE}/finance/expenses?entity_id=${SECONDARY_ENTITY_ID}`, `${API_BASE}/finance/expenses?entity_id=${PRIMARY_ENTITY_ID}`),
                    fetchJson(`${API_BASE}/finance/payments`),
                    fetchWithFallback(`${API_BASE}/finance/journal/entries?entity_id=${PRIMARY_ENTITY_ID}`, `${API_BASE}/finance/journal/entries?entity_id=${SECONDARY_ENTITY_ID}`),
                    fetchWithFallback(`${API_BASE}/finance/journal-lines?entity_id=${PRIMARY_ENTITY_ID}`, `${API_BASE}/finance/journal-lines?entity_id=${SECONDARY_ENTITY_ID}`),
                    fetchWithFallback(`${API_BASE}/finance/income-statement?entity_id=${PRIMARY_ENTITY_ID}`, `${API_BASE}/finance/income-statement?entity_id=${SECONDARY_ENTITY_ID}`),
                    fetchWithFallback(`${API_BASE}/finance/balance-sheet/complete?entity_id=${PRIMARY_ENTITY_ID}`, `${API_BASE}/finance/balance-sheet/complete?entity_id=${SECONDARY_ENTITY_ID}`),
                    fetchWithFallback(`${API_BASE}/finance/cashflow/overview?entity_id=${PRIMARY_ENTITY_ID}`, `${API_BASE}/finance/cashflow/overview?entity_id=${SECONDARY_ENTITY_ID}`),
                    fetchWithFallback(`${API_BASE}/finance/cashflow/operating?entity_id=${PRIMARY_ENTITY_ID}`, `${API_BASE}/finance/cashflow/operating?entity_id=${SECONDARY_ENTITY_ID}`),
                    fetchWithFallback(`${API_BASE}/finance/cashflow/investing?entity_id=${PRIMARY_ENTITY_ID}`, `${API_BASE}/finance/cashflow/investing?entity_id=${SECONDARY_ENTITY_ID}`),
                    fetchWithFallback(`${API_BASE}/finance/cashflow/financing?entity_id=${PRIMARY_ENTITY_ID}`, `${API_BASE}/finance/cashflow/financing?entity_id=${SECONDARY_ENTITY_ID}`)
                ]);

                dataStore.invoices = invoicesRes.data.invoices || [];
                dataStore.expenses = expensesRes.data.expenses || [];
                dataStore.payments = paymentsRes.data.payments || [];
                dataStore.entries = entriesRes.data.entries || [];
                dataStore.lines = linesRes.data.lines || [];
                dataStore.incomeRevenue = incomeRes.data.revenue_accounts || [];
                dataStore.incomeExpenses = incomeRes.data.expense_accounts || [];
                dataStore.balanceSheet = balanceRes.ok ? balanceRes.data : null;
                dataStore.cashflowOverview = overviewRes.data || null;
                dataStore.cashflowOperating = operatingRes.data.cashflows || [];
                dataStore.cashflowInvesting = investingRes.data.cashflows || [];
                dataStore.cashflowFinancing = financingRes.data.cashflows || [];

                renderKPIs();
                renderDailyOpsChart();
                renderAutoEntries();
                renderClosingChecklist();
                renderStatements();
                renderTables();
            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', error);
            }
        }

        function renderKPIs() {
            const sales = sum(dataStore.invoices, 'total_amount');
            const expenses = sum(dataStore.expenses, 'total_amount');
            const collections = sum(dataStore.payments, 'payment_amount');

            document.getElementById('salesKpi').textContent = formatMoney(sales);
            document.getElementById('expensesKpi').textContent = formatMoney(expenses);
            document.getElementById('collectionsKpi').textContent = formatMoney(collections);
            document.getElementById('paymentsKpi').textContent = formatMoney(expenses);
        }

        function renderDailyOpsChart() {
            const ctx = document.getElementById('dailyOpsChart').getContext('2d');
            if (dailyOpsChartInstance) dailyOpsChartInstance.destroy();
            dailyOpsChartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª', 'Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª', 'Ø§Ù„ØªØ­ØµÙŠÙ„'],
                    datasets: [{
                        data: [
                            sum(dataStore.invoices, 'total_amount'),
                            sum(dataStore.expenses, 'total_amount'),
                            sum(dataStore.payments, 'payment_amount')
                        ],
                        backgroundColor: ['#0ea5e9', '#f43f5e', '#10b981']
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });
        }

        function renderAutoEntries() {
            const samplePayment = dataStore.payments[0];
            const sampleExpense = dataStore.expenses[0];

            const paymentText = samplePayment
                ? `Ù…Ø«Ø§Ù„: ØªØ­ØµÙŠÙ„ ÙØ§ØªÙˆØ±Ø© Ø¬Ø²Ø¦ÙŠÙ‹Ø§ - Ù…Ù†: Ø§Ù„Ù†Ù‚Ø¯ÙŠØ© Ø¥Ù„Ù‰: Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¹Ù…ÙŠÙ„ (${samplePayment.customer_name || 'Ø¹Ù…ÙŠÙ„'})`
                : 'Ù…Ø«Ø§Ù„: ØªØ­ØµÙŠÙ„ ÙØ§ØªÙˆØ±Ø© Ø¬Ø²Ø¦ÙŠÙ‹Ø§ - Ù…Ù†: Ø§Ù„Ù†Ù‚Ø¯ÙŠØ© Ø¥Ù„Ù‰: Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¹Ù…ÙŠÙ„';
            const expenseText = sampleExpense
                ? `Ù…Ø«Ø§Ù„: Ù…ØµØ±ÙˆÙ ØªØ´ØºÙŠÙ„ - Ù…Ù†: Ù…ØµØ±ÙˆÙØ§Øª ØªØ´ØºÙŠÙ„ Ø¥Ù„Ù‰: Ø§Ù„Ø¨Ù†Ùƒ (${sampleExpense.vendor_name || 'Ù…Ø²ÙˆØ¯'})`
                : 'Ù…Ø«Ø§Ù„: Ù…ØµØ±ÙˆÙ ØªØ´ØºÙŠÙ„ - Ù…Ù†: Ù…ØµØ±ÙˆÙØ§Øª ØªØ´ØºÙŠÙ„ Ø¥Ù„Ù‰: Ø§Ù„Ø¨Ù†Ùƒ';

            document.getElementById('autoEntries').innerHTML = `
                <div class="bg-slate-50 p-3 rounded-xl">${paymentText}</div>
                <div class="bg-slate-50 p-3 rounded-xl">${expenseText}</div>
            `;
        }

        function renderClosingChecklist() {
            const checklist = [
                { label: 'Ø¥Ù‚ÙØ§Ù„ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª ÙÙŠ Ø­Ø³Ø§Ø¨ Ø§Ù„Ø£Ø±Ø¨Ø§Ø­ ÙˆØ§Ù„Ø®Ø³Ø§Ø¦Ø±', done: dataStore.incomeRevenue.length > 0 },
                { label: 'Ø¥Ù‚ÙØ§Ù„ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª', done: dataStore.incomeExpenses.length > 0 },
                { label: 'Ø§Ø­ØªØ³Ø§Ø¨ Ø§Ù„Ø¥Ù‡Ù„Ø§Ùƒ', done: dataStore.cashflowInvesting.length > 0 },
                { label: 'ØªØ³ÙˆÙŠØ© Ø§Ù„Ø¹Ù‡Ø¯', done: dataStore.entries.length > 0 },
                { label: 'ØªØ³ÙˆÙŠØ© Ø§Ù„Ù…Ø®Ø²ÙˆÙ†', done: dataStore.entries.length > 0 },
                { label: 'ØªØ³ÙˆÙŠØ© Ø§Ù„Ø°Ù…Ù…', done: dataStore.payments.length > 0 }
            ];

            document.getElementById('closingChecklist').innerHTML = checklist.map(item => `
                <div class="flex items-center justify-between p-4 bg-white rounded-2xl shadow">
                    <span>${item.label}</span>
                    <span class="badge ${item.done ? 'bg-emerald-100 text-emerald-700' : 'bg-amber-100 text-amber-700'}">
                        ${item.done ? 'Ù…ÙƒØªÙ…Ù„' : 'Ù‚ÙŠØ¯ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©'}
                    </span>
                </div>
            `).join('');
        }

        function renderStatements() {
            const totals = dataStore.cashflowOverview || { total_net_cashflow: 0 };
            const incomeRevenue = sum(dataStore.incomeRevenue, 'balance');
            const incomeExpenses = sum(dataStore.incomeExpenses, 'balance');
            const netIncome = incomeRevenue - incomeExpenses;

            document.getElementById('totalRevenue').textContent = formatMoney(incomeRevenue);
            document.getElementById('totalExpenses').textContent = formatMoney(incomeExpenses);
            document.getElementById('netIncome').textContent = formatMoney(netIncome);
            document.getElementById('totalAssets').textContent = formatMoney(dataStore.balanceSheet?.totals?.total_assets || 0);

            const ctx = document.getElementById('cashflowStatementChart').getContext('2d');
            if (cashflowChartInstance) cashflowChartInstance.destroy();
            cashflowChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['ØªØ´ØºÙŠÙ„ÙŠ', 'Ø§Ø³ØªØ«Ù…Ø§Ø±ÙŠ', 'ØªÙ…ÙˆÙŠÙ„ÙŠ'],
                    datasets: [{
                        data: [
                            sum(dataStore.cashflowOperating, 'amount'),
                            sum(dataStore.cashflowInvesting, 'amount'),
                            sum(dataStore.cashflowFinancing, 'amount')
                        ],
                        backgroundColor: ['#0ea5e9', '#8b5cf6', '#14b8a6']
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
            });

            const bs = dataStore.balanceSheet?.totals;
            document.getElementById('balanceSummary').innerHTML = bs ? `
                <div class="bg-slate-50 p-3 rounded-xl">Ø§Ù„Ø£ØµÙˆÙ„: ${formatMoney(bs.total_assets)}</div>
                <div class="bg-slate-50 p-3 rounded-xl">Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª: ${formatMoney(bs.total_liabilities)}</div>
                <div class="bg-slate-50 p-3 rounded-xl">Ø­Ù‚ÙˆÙ‚ Ø§Ù„Ù…Ù„ÙƒÙŠØ©: ${formatMoney(bs.total_equity)}</div>
                <div class="bg-slate-50 p-3 rounded-xl">Ù…ØªÙˆØ§Ø²Ù†: ${bs.is_balanced ? 'Ù†Ø¹Ù…' : 'Ù„Ø§'} (${formatMoney(bs.difference)})</div>
            ` : '<div class="text-slate-500">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</div>';
        }

        function renderTables() {
            renderDynamicTable('invoicesHead', 'invoicesTable', dataStore.invoices, 'invoicesCount');
            renderDynamicTable('expensesHead', 'expensesTable', dataStore.expenses, 'expensesCount');
            renderDynamicTable('paymentsHead', 'paymentsTable', dataStore.payments, 'paymentsCount');
            renderDynamicTable('entriesHead', 'entriesTable', dataStore.entries, 'entriesCount');
            renderDynamicTable('linesHead', 'linesTable', dataStore.lines, 'linesCount');

            renderDynamicTable('incomeRevenueHead', 'incomeRevenueTable', dataStore.incomeRevenue, 'incomeRevenueCount');
            renderDynamicTable('incomeExpenseHead', 'incomeExpenseTable', dataStore.incomeExpenses, 'incomeExpenseCount');

            const bsRows = dataStore.balanceSheet ? [dataStore.balanceSheet.sheet] : [];
            renderDynamicTable('balanceSheetHead', 'balanceSheetTable', bsRows, 'balanceSheetCount');
        }

        function renderDynamicTable(headId, bodyId, rows, countId) {
            const head = document.getElementById(headId);
            const body = document.getElementById(bodyId);
            const count = document.getElementById(countId);

            count.textContent = `Ø¹Ø¯Ø¯ Ø§Ù„ØµÙÙˆÙ: ${rows.length}`;
            if (!rows.length) {
                head.innerHTML = '';
                body.innerHTML = `<tr><td class="px-4 py-8 text-center text-slate-500">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</td></tr>`;
                return;
            }

            const columns = Array.from(new Set(rows.flatMap(row => Object.keys(row))));
            head.innerHTML = `<tr>${columns.map(c => `<th class="px-3 py-2 text-right">${c}</th>`).join('')}</tr>`;
            body.innerHTML = rows.map(row => `
                <tr class="hover:bg-slate-50">
                    ${columns.map(c => `<td class="px-3 py-2">${formatValue(row[c])}</td>`).join('')}
                </tr>
            `).join('');
        }

        function sum(rows, key) {
            return rows.reduce((acc, r) => acc + parseFloat(r[key] || 0), 0);
        }

        function formatMoney(value) {
            const num = parseFloat(value || 0);
            return num.toLocaleString('ar-SA') + ' Ø±.Ø³';
        }

        function formatValue(value) {
            if (value === null || value === undefined || value === '') return '-';
            if (typeof value === 'number') return value.toLocaleString('ar-SA');
            if (typeof value === 'boolean') return value ? 'true' : 'false';
            if (typeof value === 'object') return JSON.stringify(value);
            return String(value);
        }

        function downloadJSON() {
            downloadBlob(JSON.stringify(dataStore, null, 2), 'accounting-cycle.json', 'application/json');
        }

        function downloadCSV() {
            const sections = [
                ['INVOICES', dataStore.invoices],
                ['EXPENSES', dataStore.expenses],
                ['PAYMENTS', dataStore.payments],
                ['JOURNAL_ENTRIES', dataStore.entries],
                ['JOURNAL_LINES', dataStore.lines],
                ['INCOME_REVENUE', dataStore.incomeRevenue],
                ['INCOME_EXPENSE', dataStore.incomeExpenses],
                ['BALANCE_SHEET', dataStore.balanceSheet ? [dataStore.balanceSheet.sheet] : []]
            ];
            const rows = [];
            sections.forEach(([title, data]) => {
                rows.push([title]);
                if (data.length) {
                    const cols = Array.from(new Set(data.flatMap(row => Object.keys(row))));
                    rows.push(cols);
                    data.forEach(row => rows.push(cols.map(c => row[c])));
                }
                rows.push([]);
            });
            const csvContent = rows.map(r => r.map(v => `"${v ?? ''}"`).join(',')).join('\n');
            downloadBlob(csvContent, 'accounting-cycle.csv', 'text/csv;charset=utf-8;');
        }

        function downloadBlob(content, filename, type) {
            const blob = new Blob([content], { type });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            link.click();
            URL.revokeObjectURL(url);
        }

        function printReport() {
            window.print();
        }

        function refreshData() {
            loadData();
        }

        document.addEventListener('DOMContentLoaded', loadData);
    </script>
</body>
</html>
