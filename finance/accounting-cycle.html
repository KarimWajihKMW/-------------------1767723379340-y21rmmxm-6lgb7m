<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ§¾ Ø§Ù„Ø¯ÙˆØ±Ø© Ø§Ù„Ù…Ø­Ø§Ø³Ø¨ÙŠØ© Ø§Ù„ÙƒØ§Ù…Ù„Ø© - Ù†Ø¸Ø§Ù… Ù†Ø§ÙŠÙˆØ´</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Cairo', sans-serif;
            background: #f9fafb; /* Slate-50 */
            min-height: 100vh;
        }
        .card-gradient {
            background: linear-gradient(135deg, rgba(255,255,255,0.95), rgba(255,255,255,0.98));
            backdrop-filter: blur(10px);
        }
        .stat-card { transition: transform 0.3s, box-shadow 0.3s; }
        .stat-card:hover { transform: translateY(-5px); box-shadow: 0 14px 28px rgba(15,23,42,0.15); }
        .shape-pill { border-radius: 999px; }
        .shape-angle { border-radius: 28px 8px 28px 8px; }
        .shape-wave { border-radius: 28px 28px 6px 28px; }
        .shape-arc { border-radius: 18px 40px 18px 40px; }
        .chart-container { position: relative; height: 280px; }
        .table-scroll { max-height: 520px; overflow: auto; }
        .section-accent-sky { border-top: 4px solid #0ea5e9; }
        .section-accent-emerald { border-top: 4px solid #10b981; }
        .section-accent-amber { border-top: 4px solid #f59e0b; }
        .section-accent-indigo { border-top: 4px solid #6366f1; }
        .section-accent-rose { border-top: 4px solid #f43f5e; }
        .badge { padding: 6px 12px; border-radius: 999px; font-weight: 700; }
        details > summary { cursor: pointer; }
    </style>
</head>
<body>
    <div class="container mx-auto px-4 py-8">
        <div class="mb-8 text-slate-900">
            <h1 class="text-4xl font-bold mb-2">ğŸ§¾ Ø§Ù„Ø¯ÙˆØ±Ø© Ø§Ù„Ù…Ø­Ø§Ø³Ø¨ÙŠØ© Ø§Ù„ÙƒØ§Ù…Ù„Ø© Ø¯Ø§Ø®Ù„ Ù†Ø§ÙŠÙˆØ´</h1>
            <p class="text-lg opacity-90">Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„ÙŠÙˆÙ…ÙŠØ© + Ø¥Ù‚ÙØ§Ù„ Ø§Ù„ÙØªØ±Ø© + Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ø®ØªØ§Ù…ÙŠØ© (Ø§Ù„ØµÙØ­Ø© 29)</p>
        </div>

        <div class="mb-6 flex flex-wrap gap-3">
            <button onclick="refreshData()" class="bg-white text-gray-800 px-6 py-3 rounded-xl font-bold shadow-sm hover:shadow-md hover:bg-gray-50 transition flex items-center gap-3 border border-gray-200 hover:border-emerald-500 group">
                <i class="fas fa-rotate text-xl text-emerald-600 group-hover:text-emerald-700 transition"></i>
                ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            </button>
            <button onclick="downloadJSON()" class="bg-white text-gray-800 px-6 py-3 rounded-xl font-bold shadow-sm hover:shadow-md hover:bg-gray-50 transition flex items-center gap-3 border border-gray-200 hover:border-indigo-500 group">
                <i class="fas fa-file-code text-xl text-indigo-600 group-hover:text-indigo-700 transition"></i>
                ØªÙ†Ø²ÙŠÙ„ Ù…Ù„Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            </button>
            <button onclick="downloadCSV()" class="bg-white text-gray-800 px-6 py-3 rounded-xl font-bold shadow-sm hover:shadow-md hover:bg-gray-50 transition flex items-center gap-3 border border-gray-200 hover:border-blue-500 group">
                <i class="fas fa-file-csv text-xl text-blue-600 group-hover:text-blue-700 transition"></i>
                ØªÙ†Ø²ÙŠÙ„ Ù…Ù„Ù Ø§Ù„Ø¬Ø¯ÙˆÙ„
            </button>
            <button onclick="printReport()" class="bg-rose-600 text-white px-6 py-3 rounded-full font-bold hover:shadow-lg transition flex items-center gap-2">
                <i class="fas fa-print text-xl text-gray-600 group-hover:text-gray-700 transition"></i>
                Ø·Ø¨Ø§Ø¹Ø©
            </button>
        </div>

        <div class="card-gradient rounded-xl shadow-2xl p-6 mb-8 section-accent-sky">
            <div class="flex flex-wrap items-center justify-between gap-3 mb-4">
                <h2 class="text-2xl font-bold text-slate-800">ğŸ§­ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ø³Ø±ÙŠØ¹</h2>
                <span id="demoBadge" class="badge bg-amber-100 text-amber-700 hidden">Ø¨ÙŠØ§Ù†Ø§Øª ØªØ¬Ø±ÙŠØ¨ÙŠØ©</span>
            </div>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-5">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-semibold text-slate-600 mb-1">Ø§Ø®ØªØ± Ø§Ù„Ø¬Ø¯ÙˆÙ„</label>
                        <select id="actionTable" class="w-full border border-slate-200 rounded-xl px-3 py-2 bg-white"></select>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-slate-600 mb-1">Ø§Ø®ØªØ± Ø§Ù„Ø³Ø¬Ù„</label>
                        <select id="actionRow" class="w-full border border-slate-200 rounded-xl px-3 py-2 bg-white"></select>
                    </div>
                </div>
                <div class="flex flex-wrap gap-3 items-start">
                    <button id="actionAdd" class="bg-slate-900 text-white px-5 py-2 rounded-xl font-bold shadow-sm hover:shadow-md transition flex items-center gap-2">
                        <i class="fas fa-plus"></i>
                        Ø¥Ø¶Ø§ÙØ©
                    </button>
                    <button id="actionView" class="bg-indigo-600 text-white px-5 py-2 rounded-xl font-bold shadow-sm hover:shadow-md transition flex items-center gap-2">
                        <i class="fas fa-eye"></i>
                        Ù…Ø¹Ø§ÙŠÙ†Ø©
                    </button>
                    <button id="actionEdit" class="bg-blue-600 text-white px-5 py-2 rounded-xl font-bold shadow-sm hover:shadow-md transition flex items-center gap-2">
                        <i class="fas fa-pen"></i>
                        ØªØ¹Ø¯ÙŠÙ„
                    </button>
                    <button id="actionDelete" class="bg-rose-600 text-white px-5 py-2 rounded-xl font-bold shadow-sm hover:shadow-md transition flex items-center gap-2">
                        <i class="fas fa-trash"></i>
                        Ø­Ø°Ù
                    </button>
                </div>
            </div>
        </div>

        <!-- Daily Operations -->
        <div class="card-gradient rounded-xl shadow-2xl p-6 mb-8 section-accent-sky">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-2xl font-bold text-slate-800">ğŸ“Œ Ø¥Ø«Ø¨Ø§Øª Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ù…Ø§Ù„ÙŠØ© Ø§Ù„ÙŠÙˆÙ…ÙŠØ©</h2>
                <span class="text-sm text-slate-500">ÙƒÙ„ Ø¹Ù…Ù„ÙŠØ© ØªÙØ³Ø¬Ù„ Ø¨Ù‚ÙŠØ¯ Ù…Ø­Ø§Ø³Ø¨ÙŠ ØªÙ„Ù‚Ø§Ø¦ÙŠ</span>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-5 mb-6">
                <div class="stat-card shape-pill bg-gradient-to-br from-sky-500 to-blue-600 text-white p-5">
                    <div class="flex justify-between mb-3"><span>Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</span><i class="fas fa-file-invoice-dollar text-2xl opacity-70"></i></div>
                    <div id="salesKpi" class="text-3xl font-bold"><div class="animate-pulse">...</div></div>
                </div>
                <div class="stat-card shape-angle bg-gradient-to-br from-emerald-500 to-teal-600 text-white p-5">
                    <div class="flex justify-between mb-3"><span>Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª</span><i class="fas fa-receipt text-2xl opacity-70"></i></div>
                    <div id="expensesKpi" class="text-3xl font-bold"><div class="animate-pulse">...</div></div>
                </div>
                <div class="stat-card shape-wave bg-gradient-to-br from-indigo-500 to-purple-600 text-white p-5">
                    <div class="flex justify-between mb-3"><span>Ø§Ù„ØªØ­ØµÙŠÙ„</span><i class="fas fa-sack-dollar text-2xl opacity-70"></i></div>
                    <div id="collectionsKpi" class="text-3xl font-bold"><div class="animate-pulse">...</div></div>
                </div>
                <div class="stat-card shape-arc bg-gradient-to-br from-amber-500 to-orange-600 text-white p-5">
                    <div class="flex justify-between mb-3"><span>Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª</span><i class="fas fa-credit-card text-2xl opacity-70"></i></div>
                    <div id="paymentsKpi" class="text-3xl font-bold"><div class="animate-pulse">...</div></div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="card-gradient rounded-2xl p-5 shadow-lg section-accent-emerald">
                    <h3 class="text-lg font-bold text-slate-800 mb-4">ğŸ“Š ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„ÙŠÙˆÙ…ÙŠØ©</h3>
                    <div class="chart-container">
                        <canvas id="dailyOpsChart"></canvas>
                    </div>
                </div>
                <div class="card-gradient rounded-2xl p-5 shadow-lg section-accent-amber">
                    <h3 class="text-lg font-bold text-slate-800 mb-4">ğŸ§  Ø£Ù…Ø«Ù„Ø© Ù‚ÙŠÙˆØ¯ ØªÙ„Ù‚Ø§Ø¦ÙŠØ©</h3>
                    <div id="autoEntries" class="space-y-3 text-sm text-slate-700">
                        <div class="animate-pulse">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Period Closing -->
        <div class="card-gradient rounded-xl shadow-2xl p-6 mb-8 section-accent-indigo">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-2xl font-bold text-slate-800">ğŸ§¾ Ø¥Ù‚ÙØ§Ù„ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ù…Ø­Ø§Ø³Ø¨ÙŠØ©</h2>
                <span class="text-sm text-slate-500">Ø­Ø§Ù„Ø© Ø§Ù„Ø¥Ù‚ÙØ§Ù„ ÙˆÙÙ‚ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©</span>
            </div>
            <div id="closingChecklist" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
        </div>

        <!-- Final Statements -->
        <div class="card-gradient rounded-xl shadow-2xl p-6 mb-8 section-accent-emerald">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-2xl font-bold text-slate-800">ğŸ“ˆ Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ù…Ø§Ù„ÙŠØ© Ø§Ù„Ø®ØªØ§Ù…ÙŠØ©</h2>
                <span class="text-sm text-slate-500">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¯Ø®Ù„ + Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ© Ø§Ù„Ø¹Ù…ÙˆÙ…ÙŠØ© + Ø§Ù„ØªØ¯ÙÙ‚Ø§Øª Ø§Ù„Ù†Ù‚Ø¯ÙŠØ©</span>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-5 mb-6">
                <div class="stat-card shape-pill bg-white text-slate-800 p-5 shadow-lg">
                    <div class="flex justify-between mb-3"><span>Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª</span><i class="fas fa-arrow-up text-emerald-600"></i></div>
                    <div id="totalRevenue" class="text-2xl font-bold"><div class="animate-pulse">...</div></div>
                </div>
                <div class="stat-card shape-angle bg-white text-slate-800 p-5 shadow-lg">
                    <div class="flex justify-between mb-3"><span>Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª</span><i class="fas fa-arrow-down text-rose-600"></i></div>
                    <div id="totalExpenses" class="text-2xl font-bold"><div class="animate-pulse">...</div></div>
                </div>
                <div class="stat-card shape-wave bg-white text-slate-800 p-5 shadow-lg">
                    <div class="flex justify-between mb-3"><span>ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­</span><i class="fas fa-chart-line text-indigo-600"></i></div>
                    <div id="netIncome" class="text-2xl font-bold"><div class="animate-pulse">...</div></div>
                </div>
                <div class="stat-card shape-arc bg-white text-slate-800 p-5 shadow-lg">
                    <div class="flex justify-between mb-3"><span>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£ØµÙˆÙ„</span><i class="fas fa-building-columns text-sky-600"></i></div>
                    <div id="totalAssets" class="text-2xl font-bold"><div class="animate-pulse">...</div></div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="card-gradient rounded-2xl p-5 shadow-lg section-accent-amber">
                    <h3 class="text-lg font-bold text-slate-800 mb-4">ğŸ’§ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØªØ¯ÙÙ‚Ø§Øª Ø§Ù„Ù†Ù‚Ø¯ÙŠØ©</h3>
                    <div class="chart-container">
                        <canvas id="cashflowStatementChart"></canvas>
                    </div>
                </div>
                <div class="card-gradient rounded-2xl p-5 shadow-lg section-accent-rose">
                    <h3 class="text-lg font-bold text-slate-800 mb-4">âš–ï¸ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø±ÙƒØ² Ø§Ù„Ù…Ø§Ù„ÙŠ</h3>
                    <div id="balanceSummary" class="space-y-3 text-sm text-slate-700"></div>
                </div>
            </div>
        </div>

        <!-- Data Tables -->
        <div class="space-y-6">
            <details class="card-gradient rounded-xl shadow-2xl p-6 section-accent-sky" open>
                <summary class="text-xl font-bold text-slate-800">ğŸ§¾ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„ÙŠÙˆÙ…ÙŠØ© (ÙÙˆØ§ØªÙŠØ± + Ù…ØµØ±ÙˆÙØ§Øª + Ù…Ø¯ÙÙˆØ¹Ø§Øª)</summary>
                <div class="mt-4 space-y-6">
                    <div>
                        <div class="flex justify-between mb-2"><h4 class="font-bold text-slate-700">Ø§Ù„ÙÙˆØ§ØªÙŠØ±</h4><span id="invoicesCount" class="text-sm text-slate-500"></span></div>
                        <div class="table-scroll"><table class="w-full text-xs"><thead id="invoicesHead" class="bg-sky-50 text-sky-700"></thead><tbody id="invoicesTable" class="divide-y divide-slate-100"></tbody></table></div>
                    </div>
                    <div>
                        <div class="flex justify-between mb-2"><h4 class="font-bold text-slate-700">Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª</h4><span id="expensesCount" class="text-sm text-slate-500"></span></div>
                        <div class="table-scroll"><table class="w-full text-xs"><thead id="expensesHead" class="bg-rose-50 text-rose-700"></thead><tbody id="expensesTable" class="divide-y divide-slate-100"></tbody></table></div>
                    </div>
                    <div>
                        <div class="flex justify-between mb-2"><h4 class="font-bold text-slate-700">Ø§Ù„ØªØ­ØµÙŠÙ„</h4><span id="paymentsCount" class="text-sm text-slate-500"></span></div>
                        <div class="table-scroll"><table class="w-full text-xs"><thead id="paymentsHead" class="bg-emerald-50 text-emerald-700"></thead><tbody id="paymentsTable" class="divide-y divide-slate-100"></tbody></table></div>
                    </div>
                </div>
            </details>

            <details class="card-gradient rounded-xl shadow-2xl p-6 section-accent-indigo">
                <summary class="text-xl font-bold text-slate-800">ğŸ“š Ø§Ù„Ù‚ÙŠÙˆØ¯ Ø§Ù„Ù…Ø­Ø§Ø³Ø¨ÙŠØ© Ø§Ù„Ø¢Ù„ÙŠØ©</summary>
                <div class="mt-4 space-y-6">
                    <div>
                        <div class="flex justify-between mb-2"><h4 class="font-bold text-slate-700">Ù‚ÙŠÙˆØ¯ Ø§Ù„ÙŠÙˆÙ…ÙŠØ©</h4><span id="entriesCount" class="text-sm text-slate-500"></span></div>
                        <div class="table-scroll"><table class="w-full text-xs"><thead id="entriesHead" class="bg-indigo-50 text-indigo-700"></thead><tbody id="entriesTable" class="divide-y divide-slate-100"></tbody></table></div>
                    </div>
                    <div>
                        <div class="flex justify-between mb-2"><h4 class="font-bold text-slate-700">Ø³Ø·ÙˆØ± Ø§Ù„Ù‚ÙŠÙˆØ¯</h4><span id="linesCount" class="text-sm text-slate-500"></span></div>
                        <div class="table-scroll"><table class="w-full text-xs"><thead id="linesHead" class="bg-sky-50 text-sky-700"></thead><tbody id="linesTable" class="divide-y divide-slate-100"></tbody></table></div>
                    </div>
                </div>
            </details>

            <details class="card-gradient rounded-xl shadow-2xl p-6 section-accent-amber">
                <summary class="text-xl font-bold text-slate-800">ğŸ“Š Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ù…Ø§Ù„ÙŠØ©</summary>
                <div class="mt-4 space-y-6">
                    <div>
                        <div class="flex justify-between mb-2"><h4 class="font-bold text-slate-700">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¯Ø®Ù„ - Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª</h4><span id="incomeRevenueCount" class="text-sm text-slate-500"></span></div>
                        <div class="table-scroll"><table class="w-full text-xs"><thead id="incomeRevenueHead" class="bg-emerald-50 text-emerald-700"></thead><tbody id="incomeRevenueTable" class="divide-y divide-slate-100"></tbody></table></div>
                    </div>
                    <div>
                        <div class="flex justify-between mb-2"><h4 class="font-bold text-slate-700">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¯Ø®Ù„ - Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª</h4><span id="incomeExpenseCount" class="text-sm text-slate-500"></span></div>
                        <div class="table-scroll"><table class="w-full text-xs"><thead id="incomeExpenseHead" class="bg-rose-50 text-rose-700"></thead><tbody id="incomeExpenseTable" class="divide-y divide-slate-100"></tbody></table></div>
                    </div>
                    <div>
                        <div class="flex justify-between mb-2"><h4 class="font-bold text-slate-700">Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ© Ø§Ù„Ø¹Ù…ÙˆÙ…ÙŠØ©</h4><span id="balanceSheetCount" class="text-sm text-slate-500"></span></div>
                        <div class="table-scroll"><table class="w-full text-xs"><thead id="balanceSheetHead" class="bg-amber-50 text-amber-700"></thead><tbody id="balanceSheetTable" class="divide-y divide-slate-100"></tbody></table></div>
                    </div>
                </div>
            </details>
        </div>
    </div>

    <script>
        const API_BASE = window.location.origin;
        const ENTITY_ID = window.getFinanceEntityId ? window.getFinanceEntityId() : 'HQ001';
        const ENTITY_TYPE = window.getFinanceEntityType ? window.getFinanceEntityType() : 'HQ';
        const FALLBACK_ENTITY_ID = 'HQ001';

        let dataStore = {
            invoices: [],
            expenses: [],
            payments: [],
            entries: [],
            lines: [],
            incomeRevenue: [],
            incomeExpenses: [],
            balanceSheet: null,
            cashflowOverview: null,
            cashflowOperating: [],
            cashflowInvesting: [],
            cashflowFinancing: []
        };

        let isDemoMode = false;

        const DEMO_DATA = {
            invoices: [
                { invoice_id: 101, invoice_number: 'INV-HQ001-001', invoice_date: '2026-01-05', due_date: '2026-02-04', customer_id: 1, customer_name: 'Ù…Ø¬Ù…ÙˆØ¹Ø© Ø§Ù„Ø´Ø±ÙˆÙ‚ Ù„Ù„ØªØ¬Ø§Ø±Ø©', total_amount: 185000, paid_amount: 25000, remaining_amount: 160000, status: 'ISSUED', payment_status: 'PARTIAL', entity_type: 'HQ', entity_id: 'HQ001' },
                { invoice_id: 102, invoice_number: 'INV-HQ001-002', invoice_date: '2026-01-12', due_date: '2026-02-11', customer_id: 2, customer_name: 'Ø´Ø±ÙƒØ© Ø§Ù„Ù…Ø¯Ù‰ Ù„Ù„Ø®Ø¯Ù…Ø§Øª', total_amount: 98000, paid_amount: 0, remaining_amount: 98000, status: 'OVERDUE', payment_status: 'UNPAID', entity_type: 'HQ', entity_id: 'HQ001' },
                { invoice_id: 103, invoice_number: 'INV-HQ001-003', invoice_date: '2026-01-18', due_date: '2026-02-17', customer_id: 3, customer_name: 'Ù…Ø¤Ø³Ø³Ø© Ø§Ù„Ù†Ø®Ø¨Ø©', total_amount: 72000, paid_amount: 20000, remaining_amount: 52000, status: 'ISSUED', payment_status: 'PARTIAL', entity_type: 'HQ', entity_id: 'HQ001' },
                { invoice_id: 104, invoice_number: 'INV-HQ001-004', invoice_date: '2026-01-22', due_date: '2026-02-21', customer_id: 4, customer_name: 'Ù…ØµÙ†Ø¹ Ø§Ù„ØªÙ…ÙŠØ² Ø§Ù„ØµÙ†Ø§Ø¹ÙŠ', total_amount: 56000, paid_amount: 15000, remaining_amount: 41000, status: 'ISSUED', payment_status: 'PARTIAL', entity_type: 'HQ', entity_id: 'HQ001' },
                { invoice_id: 105, invoice_number: 'INV-HQ001-005', invoice_date: '2026-01-27', due_date: '2026-02-26', customer_id: 5, customer_name: 'Ø±ÙˆØ§Ø¯ Ø§Ù„ØªÙ‚Ù†ÙŠØ© Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©', total_amount: 120000, paid_amount: 60000, remaining_amount: 60000, status: 'PAID', payment_status: 'PAID', entity_type: 'HQ', entity_id: 'HQ001' }
            ],
            expenses: [
                { expense_id: 501, expense_date: '2026-01-04', expense_amount: 18500, vendor_id: 21, vendor_name: 'Ø¨ÙŠØª Ø§Ù„Ø³ÙØ± Ø§Ù„Ø±Ø§Ù‚ÙŠ', status: 'APPROVED', notes: 'Ø­Ø¬ÙˆØ²Ø§Øª Ø·ÙŠØ±Ø§Ù† ÙˆÙÙ†Ø§Ø¯Ù‚ Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª', total_amount: 21275, entity_type: 'HQ', entity_id: 'HQ001' },
                { expense_id: 502, expense_date: '2026-01-08', expense_amount: 24000, vendor_id: 22, vendor_name: 'Ø´Ø±ÙƒØ© Ø§Ù„Ù…Ø¯Ø§Ø± Ù„Ù„Ù…Ø±Ø§ÙÙ‚', status: 'APPROVED', notes: 'ÙÙˆØ§ØªÙŠØ± ÙƒÙ‡Ø±Ø¨Ø§Ø¡ ÙˆÙ…ÙŠØ§Ù‡', total_amount: 27600, entity_type: 'HQ', entity_id: 'HQ001' },
                { expense_id: 503, expense_date: '2026-01-12', expense_amount: 64000, vendor_id: 23, vendor_name: 'Ø´Ø±ÙƒØ© Ø§Ù„Ø±ÙŠØ§Ø¯Ø© Ù„Ù„Ø·Ø§Ù‚Ø©', status: 'APPROVED', notes: 'Ø¥ÙŠØ¬Ø§Ø± Ù…Ø³ØªÙˆØ¯Ø¹ Ø§Ù„Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ù„ÙˆØ¬Ø³ØªÙŠØ©', total_amount: 73600, entity_type: 'HQ', entity_id: 'HQ001' },
                { expense_id: 504, expense_date: '2026-01-18', expense_amount: 9800, vendor_id: 24, vendor_name: 'Ù…Ø³ØªÙ„Ø²Ù…Ø§Øª Ø§Ù„Ø£Ø¹Ù…Ø§Ù„', status: 'APPROVED', notes: 'ØªÙˆØ±ÙŠØ¯ Ù…Ø³ØªÙ„Ø²Ù…Ø§Øª Ù…ÙƒØªØ¨ÙŠØ©', total_amount: 11270, entity_type: 'HQ', entity_id: 'HQ001' },
                { expense_id: 505, expense_date: '2026-01-24', expense_amount: 14200, vendor_id: 25, vendor_name: 'Ø´Ø±ÙƒØ© Ø£Ù…Ø§Ù† Ù„Ù„Ø§ØªØµØ§Ù„Ø§Øª', status: 'APPROVED', notes: 'Ø®Ø¯Ù…Ø§Øª Ø®Ø·ÙˆØ· Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ§Ù„ØµÙˆØª', total_amount: 16330, entity_type: 'HQ', entity_id: 'HQ001' }
            ],
            payments: [
                { payment_id: 901, payment_number: 'PAY-HQ-0001', payment_date: '2026-01-10', payment_amount: 25000, payment_method: 'BANK', payment_type: 'PARTIAL', status: 'COMPLETED', customer_id: 1, customer_name: 'Ù…Ø¬Ù…ÙˆØ¹Ø© Ø§Ù„Ø´Ø±ÙˆÙ‚ Ù„Ù„ØªØ¬Ø§Ø±Ø©', entity_type: 'HQ', entity_id: 'HQ001' },
                { payment_id: 902, payment_number: 'PAY-HQ-0002', payment_date: '2026-01-15', payment_amount: 15000, payment_method: 'CASH', payment_type: 'PARTIAL', status: 'COMPLETED', customer_id: 4, customer_name: 'Ù…ØµÙ†Ø¹ Ø§Ù„ØªÙ…ÙŠØ² Ø§Ù„ØµÙ†Ø§Ø¹ÙŠ', entity_type: 'HQ', entity_id: 'HQ001' },
                { payment_id: 903, payment_number: 'PAY-HQ-0003', payment_date: '2026-01-20', payment_amount: 60000, payment_method: 'BANK', payment_type: 'FULL', status: 'COMPLETED', customer_id: 5, customer_name: 'Ø±ÙˆØ§Ø¯ Ø§Ù„ØªÙ‚Ù†ÙŠØ© Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©', entity_type: 'HQ', entity_id: 'HQ001' },
                { payment_id: 904, payment_number: 'PAY-HQ-0004', payment_date: '2026-01-25', payment_amount: 20000, payment_method: 'ONLINE', payment_type: 'PARTIAL', status: 'COMPLETED', customer_id: 3, customer_name: 'Ù…Ø¤Ø³Ø³Ø© Ø§Ù„Ù†Ø®Ø¨Ø©', entity_type: 'HQ', entity_id: 'HQ001' }
            ],
            entries: [
                { entry_id: 701, entry_number: 'JE-2026-001', entry_date: '2026-01-10', entry_type: 'AUTO', description: 'Ù‚ÙŠØ¯ ØªØ­ØµÙŠÙ„ Ø¯ÙØ¹Ø© PAY-HQ-0001', reference_number: 'PAY-HQ-0001', status: 'POSTED', entity_type: 'HQ', entity_id: 'HQ001' },
                { entry_id: 702, entry_number: 'JE-2026-002', entry_date: '2026-01-12', entry_type: 'AUTO', description: 'Ù‚ÙŠØ¯ Ù…ØµØ±ÙˆÙ Ù…Ø±Ø§ÙÙ‚', reference_number: 'EXP-502', status: 'POSTED', entity_type: 'HQ', entity_id: 'HQ001' },
                { entry_id: 703, entry_number: 'JE-2026-003', entry_date: '2026-01-15', entry_type: 'AUTO', description: 'Ù‚ÙŠØ¯ ØªØ­ØµÙŠÙ„ Ø¯ÙØ¹Ø© PAY-HQ-0002', reference_number: 'PAY-HQ-0002', status: 'POSTED', entity_type: 'HQ', entity_id: 'HQ001' },
                { entry_id: 704, entry_number: 'JE-2026-004', entry_date: '2026-01-20', entry_type: 'AUTO', description: 'Ù‚ÙŠØ¯ ØªØ­ØµÙŠÙ„ Ø¯ÙØ¹Ø© PAY-HQ-0003', reference_number: 'PAY-HQ-0003', status: 'POSTED', entity_type: 'HQ', entity_id: 'HQ001' },
                { entry_id: 705, entry_number: 'JE-2026-005', entry_date: '2026-01-24', entry_type: 'AUTO', description: 'Ù‚ÙŠØ¯ Ù…ØµØ±ÙˆÙ Ø§ØªØµØ§Ù„Ø§Øª', reference_number: 'EXP-505', status: 'POSTED', entity_type: 'HQ', entity_id: 'HQ001' }
            ],
            lines: [
                { line_id: 801, line_number: 1, entry_id: 701, account_id: 1001, account_name_ar: 'Ø§Ù„Ù†Ù‚Ø¯ÙŠØ©', debit_amount: 25000, credit_amount: 0, description: 'ØªØ­ØµÙŠÙ„ Ù…Ù† Ø§Ù„Ø¹Ù…ÙŠÙ„', entity_type: 'HQ', entity_id: 'HQ001' },
                { line_id: 802, line_number: 2, entry_id: 701, account_id: 2001, account_name_ar: 'Ø§Ù„Ø°Ù…Ù… Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©', debit_amount: 0, credit_amount: 25000, description: 'ØªØ®ÙÙŠØ¶ Ø§Ù„Ø°Ù…Ù…', entity_type: 'HQ', entity_id: 'HQ001' },
                { line_id: 803, line_number: 1, entry_id: 702, account_id: 5101, account_name_ar: 'Ù…ØµØ±ÙˆÙ Ù…Ø±Ø§ÙÙ‚', debit_amount: 24000, credit_amount: 0, description: 'Ù‚ÙŠØ¯ Ù…ØµØ±ÙˆÙ', entity_type: 'HQ', entity_id: 'HQ001' },
                { line_id: 804, line_number: 2, entry_id: 702, account_id: 1002, account_name_ar: 'Ø§Ù„Ø¨Ù†Ùƒ', debit_amount: 0, credit_amount: 24000, description: 'Ø³Ø¯Ø§Ø¯ Ù„Ù„Ù…ÙˆØ±Ø¯', entity_type: 'HQ', entity_id: 'HQ001' },
                { line_id: 805, line_number: 1, entry_id: 704, account_id: 1002, account_name_ar: 'Ø§Ù„Ø¨Ù†Ùƒ', debit_amount: 60000, credit_amount: 0, description: 'ØªØ­ØµÙŠÙ„ Ø¯ÙØ¹Ø©', entity_type: 'HQ', entity_id: 'HQ001' },
                { line_id: 806, line_number: 2, entry_id: 704, account_id: 2001, account_name_ar: 'Ø§Ù„Ø°Ù…Ù… Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©', debit_amount: 0, credit_amount: 60000, description: 'ØªØ®ÙÙŠØ¶ Ø§Ù„Ø°Ù…Ù…', entity_type: 'HQ', entity_id: 'HQ001' }
            ],
            incomeRevenue: [
                { account_code: '4100', account_name_ar: 'Ø¥ÙŠØ±Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª', balance: 531000 },
                { account_code: '4200', account_name_ar: 'Ø¥ÙŠØ±Ø§Ø¯Ø§Øª Ø§Ù„Ø®Ø¯Ù…Ø§Øª', balance: 185000 },
                { account_code: '4300', account_name_ar: 'Ø¥ÙŠØ±Ø§Ø¯Ø§Øª Ø£Ø®Ø±Ù‰', balance: 62000 }
            ],
            incomeExpenses: [
                { account_code: '5100', account_name_ar: 'Ù…ØµØ±ÙˆÙØ§Øª ØªØ´ØºÙŠÙ„', balance: 186000 },
                { account_code: '5200', account_name_ar: 'Ù…ØµØ±ÙˆÙØ§Øª ØªØ³ÙˆÙŠÙ‚', balance: 74000 },
                { account_code: '5300', account_name_ar: 'Ù…ØµØ±ÙˆÙØ§Øª Ø¥Ø¯Ø§Ø±ÙŠØ©', balance: 56000 }
            ],
            balanceSheet: {
                sheet: {
                    sheet_date: '2026-01-31',
                    total_assets: 1250000,
                    total_liabilities: 420000,
                    total_equity: 830000,
                    is_balanced: true,
                    difference: 0,
                    notes: 'Ù…ÙŠØ²Ø§Ù†ÙŠØ© ØªØ¬Ø±ÙŠØ¨ÙŠØ©'
                },
                totals: {
                    total_assets: 1250000,
                    total_liabilities: 420000,
                    total_equity: 830000,
                    is_balanced: true,
                    difference: 0
                }
            },
            cashflowOverview: { total_net_cashflow: 172000 },
            cashflowOperating: [
                { amount: 215000, description: 'ØªØ­ØµÙŠÙ„Ø§Øª Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡' },
                { amount: -82000, description: 'Ù…Ø¯ÙÙˆØ¹Ø§Øª Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ†' },
                { amount: -31000, description: 'Ø±ÙˆØ§ØªØ¨ ÙˆØ£Ø¬ÙˆØ±' }
            ],
            cashflowInvesting: [
                { amount: -45000, description: 'Ø´Ø±Ø§Ø¡ Ù…Ø¹Ø¯Ø§Øª ØªØ´ØºÙŠÙ„' },
                { amount: -12000, description: 'ØªØ±Ù‚ÙŠØ© Ø§Ù„Ø£Ù†Ø¸Ù…Ø©' }
            ],
            cashflowFinancing: [
                { amount: 150000, description: 'ØªÙ…ÙˆÙŠÙ„ Ø¨Ù†ÙƒÙŠ' },
                { amount: -23000, description: 'Ø³Ø¯Ø§Ø¯ Ø£Ù‚Ø³Ø§Ø· Ù‚Ø±Ø¶' }
            ]
        };

        let dailyOpsChartInstance = null;
        let cashflowChartInstance = null;

        function getFinanceHeaders() {
            return window.getFinanceHeaders ? window.getFinanceHeaders() : { 'x-entity-id': ENTITY_ID, 'x-entity-type': ENTITY_TYPE };
        }

        async function fetchJson(url, options = {}) {
            try {
                const headers = { ...(options.headers || {}), ...getFinanceHeaders() };
                const res = await fetch(url, { ...options, headers });
                const text = await res.text();
                let data = {};
                try {
                    data = text ? JSON.parse(text) : {};
                } catch {
                    data = {};
                }
                return { ok: res.ok, status: res.status, data };
            } catch (error) {
                return { ok: false, status: 0, data: {}, error };
            }
        }

        async function fetchWithFallback(primaryUrl, fallbackUrl) {
            const primary = await fetchJson(primaryUrl);
            if (primary.ok && hasRows(primary.data)) return primary;
            if (!fallbackUrl) return primary;
            const fallback = await fetchJson(fallbackUrl);
            return fallback.ok ? fallback : primary;
        }

        function hasRows(data) {
            const arrays = ['entries','lines','rows','invoices','payments','expenses','revenue_accounts','expense_accounts','assets','liabilities','equity'];
            return arrays.some(key => Array.isArray(data[key]) && data[key].length > 0);
        }

        async function loadData() {
            try {
                const results = await Promise.all([
                    fetchJson(`${API_BASE}/finance/invoices?entity_id=${ENTITY_ID}`),
                    fetchWithFallback(`${API_BASE}/finance/expenses?entity_id=${ENTITY_ID}`, `${API_BASE}/finance/expenses?entity_id=${FALLBACK_ENTITY_ID}`),
                    fetchJson(`${API_BASE}/finance/payments?entity_id=${ENTITY_ID}`),
                    fetchWithFallback(`${API_BASE}/finance/journal/entries?entity_id=${ENTITY_ID}`, `${API_BASE}/finance/journal/entries?entity_id=${FALLBACK_ENTITY_ID}`),
                    fetchWithFallback(`${API_BASE}/finance/journal-lines?entity_id=${ENTITY_ID}`, `${API_BASE}/finance/journal-lines?entity_id=${FALLBACK_ENTITY_ID}`),
                    fetchWithFallback(`${API_BASE}/finance/income-statement?entity_id=${ENTITY_ID}`, `${API_BASE}/finance/income-statement?entity_id=${FALLBACK_ENTITY_ID}`),
                    fetchWithFallback(`${API_BASE}/finance/balance-sheet/complete?entity_id=${ENTITY_ID}`, `${API_BASE}/finance/balance-sheet/complete?entity_id=${FALLBACK_ENTITY_ID}`),
                    fetchWithFallback(`${API_BASE}/finance/cashflow/overview?entity_id=${ENTITY_ID}`, `${API_BASE}/finance/cashflow/overview?entity_id=${FALLBACK_ENTITY_ID}`),
                    fetchWithFallback(`${API_BASE}/finance/cashflow/operating?entity_id=${ENTITY_ID}`, `${API_BASE}/finance/cashflow/operating?entity_id=${FALLBACK_ENTITY_ID}`),
                    fetchWithFallback(`${API_BASE}/finance/cashflow/investing?entity_id=${ENTITY_ID}`, `${API_BASE}/finance/cashflow/investing?entity_id=${FALLBACK_ENTITY_ID}`),
                    fetchWithFallback(`${API_BASE}/finance/cashflow/financing?entity_id=${ENTITY_ID}`, `${API_BASE}/finance/cashflow/financing?entity_id=${FALLBACK_ENTITY_ID}`)
                ]);

                const [invoicesRes, expensesRes, paymentsRes, entriesRes, linesRes, incomeRes, balanceRes, overviewRes, operatingRes, investingRes, financingRes] = results;

                dataStore.invoices = invoicesRes.data.invoices || [];
                dataStore.expenses = expensesRes.data.expenses || [];
                dataStore.payments = paymentsRes.data.payments || [];
                dataStore.entries = entriesRes.data.entries || [];
                dataStore.lines = linesRes.data.lines || [];
                dataStore.incomeRevenue = incomeRes.data.revenue_accounts || [];
                dataStore.incomeExpenses = incomeRes.data.expense_accounts || [];
                dataStore.balanceSheet = balanceRes.ok ? balanceRes.data : null;
                dataStore.cashflowOverview = overviewRes.data || null;
                dataStore.cashflowOperating = operatingRes.data.cashflows || [];
                dataStore.cashflowInvesting = investingRes.data.cashflows || [];
                dataStore.cashflowFinancing = financingRes.data.cashflows || [];

                const hasAnyData = [
                    dataStore.invoices.length,
                    dataStore.expenses.length,
                    dataStore.payments.length,
                    dataStore.entries.length,
                    dataStore.lines.length,
                    dataStore.incomeRevenue.length,
                    dataStore.incomeExpenses.length
                ].some(count => count > 0) || (dataStore.balanceSheet && dataStore.balanceSheet.totals);

                if (!hasAnyData) {
                    applyDemoData();
                } else {
                    isDemoMode = false;
                    setDemoBadge(false);
                }

                renderAll();
            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', error);
                applyDemoData();
                renderAll();
            }
        }

        function applyDemoData() {
            isDemoMode = true;
            setDemoBadge(true);
            dataStore = JSON.parse(JSON.stringify(DEMO_DATA));
        }

        function setDemoBadge(show) {
            const badge = document.getElementById('demoBadge');
            if (!badge) return;
            badge.classList.toggle('hidden', !show);
        }

        function renderAll() {
            renderKPIs();
            renderDailyOpsChart();
            renderAutoEntries();
            renderClosingChecklist();
            renderStatements();
            renderTables();
            renderActionPanel();
        }

        function renderKPIs() {
            const sales = sum(dataStore.invoices, 'total_amount');
            const expenses = sum(dataStore.expenses, 'total_amount');
            const collections = sum(dataStore.payments, 'payment_amount');

            document.getElementById('salesKpi').textContent = formatMoney(sales);
            document.getElementById('expensesKpi').textContent = formatMoney(expenses);
            document.getElementById('collectionsKpi').textContent = formatMoney(collections);
            document.getElementById('paymentsKpi').textContent = formatMoney(expenses);
        }

        function renderDailyOpsChart() {
            const ctx = document.getElementById('dailyOpsChart').getContext('2d');
            if (dailyOpsChartInstance) dailyOpsChartInstance.destroy();
            dailyOpsChartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª', 'Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª', 'Ø§Ù„ØªØ­ØµÙŠÙ„'],
                    datasets: [{
                        data: [
                            sum(dataStore.invoices, 'total_amount'),
                            sum(dataStore.expenses, 'total_amount'),
                            sum(dataStore.payments, 'payment_amount')
                        ],
                        backgroundColor: ['#0ea5e9', '#f43f5e', '#10b981']
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });
        }

        function renderAutoEntries() {
            const samplePayment = dataStore.payments[0];
            const sampleExpense = dataStore.expenses[0];

            const paymentText = samplePayment
                ? `Ù…Ø«Ø§Ù„: ØªØ­ØµÙŠÙ„ ÙØ§ØªÙˆØ±Ø© Ø¬Ø²Ø¦ÙŠÙ‹Ø§ - Ù…Ù†: Ø§Ù„Ù†Ù‚Ø¯ÙŠØ© Ø¥Ù„Ù‰: Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¹Ù…ÙŠÙ„ (${samplePayment.customer_name || 'Ø¹Ù…ÙŠÙ„'})`
                : 'Ù…Ø«Ø§Ù„: ØªØ­ØµÙŠÙ„ ÙØ§ØªÙˆØ±Ø© Ø¬Ø²Ø¦ÙŠÙ‹Ø§ - Ù…Ù†: Ø§Ù„Ù†Ù‚Ø¯ÙŠØ© Ø¥Ù„Ù‰: Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¹Ù…ÙŠÙ„';
            const expenseText = sampleExpense
                ? `Ù…Ø«Ø§Ù„: Ù…ØµØ±ÙˆÙ ØªØ´ØºÙŠÙ„ - Ù…Ù†: Ù…ØµØ±ÙˆÙØ§Øª ØªØ´ØºÙŠÙ„ Ø¥Ù„Ù‰: Ø§Ù„Ø¨Ù†Ùƒ (${sampleExpense.vendor_name || 'Ù…Ø²ÙˆØ¯'})`
                : 'Ù…Ø«Ø§Ù„: Ù…ØµØ±ÙˆÙ ØªØ´ØºÙŠÙ„ - Ù…Ù†: Ù…ØµØ±ÙˆÙØ§Øª ØªØ´ØºÙŠÙ„ Ø¥Ù„Ù‰: Ø§Ù„Ø¨Ù†Ùƒ';

            document.getElementById('autoEntries').innerHTML = `
                <div class="bg-slate-50 p-3 rounded-xl">${paymentText}</div>
                <div class="bg-slate-50 p-3 rounded-xl">${expenseText}</div>
            `;
        }

        function renderClosingChecklist() {
            const checklist = [
                { label: 'Ø¥Ù‚ÙØ§Ù„ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª ÙÙŠ Ø­Ø³Ø§Ø¨ Ø§Ù„Ø£Ø±Ø¨Ø§Ø­ ÙˆØ§Ù„Ø®Ø³Ø§Ø¦Ø±', done: dataStore.incomeRevenue.length > 0 },
                { label: 'Ø¥Ù‚ÙØ§Ù„ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª', done: dataStore.incomeExpenses.length > 0 },
                { label: 'Ø§Ø­ØªØ³Ø§Ø¨ Ø§Ù„Ø¥Ù‡Ù„Ø§Ùƒ', done: dataStore.cashflowInvesting.length > 0 },
                { label: 'ØªØ³ÙˆÙŠØ© Ø§Ù„Ø¹Ù‡Ø¯', done: dataStore.entries.length > 0 },
                { label: 'ØªØ³ÙˆÙŠØ© Ø§Ù„Ù…Ø®Ø²ÙˆÙ†', done: dataStore.entries.length > 0 },
                { label: 'ØªØ³ÙˆÙŠØ© Ø§Ù„Ø°Ù…Ù…', done: dataStore.payments.length > 0 }
            ];

            document.getElementById('closingChecklist').innerHTML = checklist.map(item => `
                <div class="flex items-center justify-between p-4 bg-white rounded-2xl shadow">
                    <span>${item.label}</span>
                    <span class="badge ${item.done ? 'bg-emerald-100 text-emerald-700' : 'bg-amber-100 text-amber-700'}">
                        ${item.done ? 'Ù…ÙƒØªÙ…Ù„' : 'Ù‚ÙŠØ¯ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©'}
                    </span>
                </div>
            `).join('');
        }

        function renderStatements() {
            const totals = dataStore.cashflowOverview || { total_net_cashflow: 0 };
            const incomeRevenue = sum(dataStore.incomeRevenue, 'balance');
            const incomeExpenses = sum(dataStore.incomeExpenses, 'balance');
            const netIncome = incomeRevenue - incomeExpenses;

            document.getElementById('totalRevenue').textContent = formatMoney(incomeRevenue);
            document.getElementById('totalExpenses').textContent = formatMoney(incomeExpenses);
            document.getElementById('netIncome').textContent = formatMoney(netIncome);
            document.getElementById('totalAssets').textContent = formatMoney(dataStore.balanceSheet?.totals?.total_assets || 0);

            const ctx = document.getElementById('cashflowStatementChart').getContext('2d');
            if (cashflowChartInstance) cashflowChartInstance.destroy();
            cashflowChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['ØªØ´ØºÙŠÙ„ÙŠ', 'Ø§Ø³ØªØ«Ù…Ø§Ø±ÙŠ', 'ØªÙ…ÙˆÙŠÙ„ÙŠ'],
                    datasets: [{
                        data: [
                            sum(dataStore.cashflowOperating, 'amount'),
                            sum(dataStore.cashflowInvesting, 'amount'),
                            sum(dataStore.cashflowFinancing, 'amount')
                        ],
                        backgroundColor: ['#0ea5e9', '#8b5cf6', '#14b8a6']
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
            });

            const bs = dataStore.balanceSheet?.totals;
            document.getElementById('balanceSummary').innerHTML = bs ? `
                <div class="bg-slate-50 p-3 rounded-xl">Ø§Ù„Ø£ØµÙˆÙ„: ${formatMoney(bs.total_assets)}</div>
                <div class="bg-slate-50 p-3 rounded-xl">Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª: ${formatMoney(bs.total_liabilities)}</div>
                <div class="bg-slate-50 p-3 rounded-xl">Ø­Ù‚ÙˆÙ‚ Ø§Ù„Ù…Ù„ÙƒÙŠØ©: ${formatMoney(bs.total_equity)}</div>
                <div class="bg-slate-50 p-3 rounded-xl">Ù…ØªÙˆØ§Ø²Ù†: ${bs.is_balanced ? 'Ù†Ø¹Ù…' : 'Ù„Ø§'} (${formatMoney(bs.difference)})</div>
            ` : '<div class="text-slate-500">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</div>';
        }

        const TABLE_CONFIGS = {
            invoices: { endpoint: '/finance/invoices', idField: 'invoice_id' },
            expenses: { endpoint: '/finance/expenses', idField: 'expense_id' },
            payments: { endpoint: '/finance/payments', idField: 'payment_id' },
            entries: { endpoint: '/finance/journal/entries', idField: 'entry_id' },
            lines: { endpoint: '/finance/journal-lines', idField: 'line_id' },
            incomeRevenue: { readOnly: true },
            incomeExpenses: { readOnly: true },
            balanceSheet: { readOnly: true }
        };

        const TABLE_LABELS = {
            invoices: 'Ø§Ù„ÙÙˆØ§ØªÙŠØ±',
            expenses: 'Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª',
            payments: 'Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª',
            entries: 'Ù‚ÙŠÙˆØ¯ Ø§Ù„ÙŠÙˆÙ…ÙŠØ©',
            lines: 'Ø³Ø·ÙˆØ± Ø§Ù„Ù‚ÙŠÙˆØ¯',
            incomeRevenue: 'Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¯Ø®Ù„ - Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª',
            incomeExpenses: 'Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¯Ø®Ù„ - Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª',
            balanceSheet: 'Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ© Ø§Ù„Ø¹Ù…ÙˆÙ…ÙŠØ©'
        };

        const COLUMN_LABELS = {
            invoice_id: 'Ù…Ø¹Ø±Ù‘Ù Ø§Ù„ÙØ§ØªÙˆØ±Ø©',
            invoice_number: 'Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©',
            invoice_date: 'ØªØ§Ø±ÙŠØ® Ø§Ù„ÙØ§ØªÙˆØ±Ø©',
            due_date: 'ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚',
            customer_id: 'Ù…Ø¹Ø±Ù‘Ù Ø§Ù„Ø¹Ù…ÙŠÙ„',
            customer_name_ar: 'Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©',
            customer_name_en: 'Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø¨Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©',
            customer_name: 'Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„',
            customer_code: 'ÙƒÙˆØ¯ Ø§Ù„Ø¹Ù…ÙŠÙ„',
            total_amount: 'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨Ù„Øº',
            paid_amount: 'Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹',
            remaining_amount: 'Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ',
            payment_status: 'Ø­Ø§Ù„Ø© Ø§Ù„Ø³Ø¯Ø§Ø¯',
            expense_id: 'Ù…Ø¹Ø±Ù‘Ù Ø§Ù„Ù…ØµØ±ÙˆÙ',
            expense_date: 'ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ØµØ±ÙˆÙ',
            expense_amount: 'Ù…Ø¨Ù„Øº Ø§Ù„Ù…ØµØ±ÙˆÙ',
            vendor_id: 'Ù…Ø¹Ø±Ù‘Ù Ø§Ù„Ù…ÙˆØ±Ø¯',
            vendor_name: 'Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ±Ø¯',
            payment_id: 'Ù…Ø¹Ø±Ù‘Ù Ø§Ù„Ø¯ÙØ¹Ø©',
            payment_number: 'Ø±Ù‚Ù… Ø§Ù„Ø¯ÙØ¹Ø©',
            payment_date: 'ØªØ§Ø±ÙŠØ® Ø§Ù„Ø³Ø¯Ø§Ø¯',
            payment_amount: 'Ù…Ø¨Ù„Øº Ø§Ù„Ø³Ø¯Ø§Ø¯',
            payment_method: 'Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø³Ø¯Ø§Ø¯',
            payment_type: 'Ù†ÙˆØ¹ Ø§Ù„Ø³Ø¯Ø§Ø¯',
            status: 'Ø§Ù„Ø­Ø§Ù„Ø©',
            notes: 'Ù…Ù„Ø§Ø­Ø¸Ø§Øª',
            entry_id: 'Ù…Ø¹Ø±Ù‘Ù Ø§Ù„Ù‚ÙŠØ¯',
            entry_number: 'Ø±Ù‚Ù… Ø§Ù„Ù‚ÙŠØ¯',
            entry_date: 'ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‚ÙŠØ¯',
            entry_type: 'Ù†ÙˆØ¹ Ø§Ù„Ù‚ÙŠØ¯',
            description: 'Ø§Ù„ÙˆØµÙ',
            reference_number: 'Ø±Ù‚Ù… Ø§Ù„Ù…Ø±Ø¬Ø¹',
            reference_type: 'Ù†ÙˆØ¹ Ø§Ù„Ù…Ø±Ø¬Ø¹',
            line_id: 'Ù…Ø¹Ø±Ù‘Ù Ø§Ù„Ø³Ø·Ø±',
            line_number: 'Ø±Ù‚Ù… Ø§Ù„Ø³Ø·Ø±',
            account_id: 'Ù…Ø¹Ø±Ù‘Ù Ø§Ù„Ø­Ø³Ø§Ø¨',
            account_code: 'ÙƒÙˆØ¯ Ø§Ù„Ø­Ø³Ø§Ø¨',
            account_name_ar: 'Ø§Ø³Ù… Ø§Ù„Ø­Ø³Ø§Ø¨ Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©',
            account_name_en: 'Ø§Ø³Ù… Ø§Ù„Ø­Ø³Ø§Ø¨ Ø¨Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©',
            debit_amount: 'Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙŠÙ†',
            credit_amount: 'Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø¯Ø§Ø¦Ù†',
            created_at: 'ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡',
            updated_at: 'ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ­Ø¯ÙŠØ«',
            balance: 'Ø§Ù„Ø±ØµÙŠØ¯',
            entity_type: 'Ù†ÙˆØ¹ Ø§Ù„ÙƒÙŠØ§Ù†',
            entity_id: 'Ù…Ø¹Ø±Ù‘Ù Ø§Ù„ÙƒÙŠØ§Ù†'
        };

        const STATUS_LABELS = {
            APPROVED: 'Ù…Ø¹ØªÙ…Ø¯Ø©',
            COMPLETED: 'Ù…ÙƒØªÙ…Ù„Ø©',
            PENDING: 'Ù…Ø¹Ù„Ù‚Ø©',
            CANCELLED: 'Ù…Ù„ØºØ§Ø©',
            FAILED: 'ÙØ§Ø´Ù„Ø©',
            PAID: 'Ù…Ø¯ÙÙˆØ¹Ø©',
            UNPAID: 'ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹Ø©',
            PARTIAL: 'Ù…Ø¯ÙÙˆØ¹Ø© Ø¬Ø²Ø¦ÙŠØ§Ù‹',
            DRAFT: 'Ù…Ø³ÙˆØ¯Ø©',
            ISSUED: 'Ù…ØµØ¯Ø±Ø©',
            OVERDUE: 'Ù…ØªØ£Ø®Ø±Ø©',
            HIGH: 'Ù…Ø±ØªÙØ¹',
            MEDIUM: 'Ù…ØªÙˆØ³Ø·',
            LOW: 'Ù…Ù†Ø®ÙØ¶',
            HQ: 'Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ø§Ù…Ø©',
            BRANCH: 'ÙØ±Ø¹',
            INCUBATOR: 'Ø­Ø§Ø¶Ù†Ø©',
            PLATFORM: 'Ù…Ù†ØµØ©',
            OFFICE: 'Ù…ÙƒØªØ¨'
        };

        const PAYMENT_METHOD_LABELS = {
            CASH: 'Ù†Ù‚Ø¯ÙŠ',
            BANK: 'ØªØ­ÙˆÙŠÙ„ Ø¨Ù†ÙƒÙŠ',
            CARD: 'Ø¨Ø·Ø§Ù‚Ø©',
            CHECK: 'Ø´ÙŠÙƒ',
            ONLINE: 'Ø¯ÙØ¹ Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ'
        };

        const PAYMENT_TYPE_LABELS = {
            FULL: 'ÙƒØ§Ù…Ù„Ø©',
            PARTIAL: 'Ø¬Ø²Ø¦ÙŠØ©',
            ADVANCE: 'Ù…Ù‚Ø¯Ù…Ø©'
        };

        const WORD_TRANSLATIONS = {
            id: 'Ù…Ø¹Ø±Ù‘Ù',
            number: 'Ø±Ù‚Ù…',
            date: 'ØªØ§Ø±ÙŠØ®',
            due: 'Ø§Ø³ØªØ­Ù‚Ø§Ù‚',
            customer: 'Ø¹Ù…ÙŠÙ„',
            name: 'Ø§Ø³Ù…',
            ar: 'Ø¹Ø±Ø¨ÙŠ',
            en: 'Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ',
            type: 'Ù†ÙˆØ¹',
            status: 'Ø­Ø§Ù„Ø©',
            payment: 'Ø³Ø¯Ø§Ø¯',
            amount: 'Ù…Ø¨Ù„Øº',
            total: 'Ø¥Ø¬Ù…Ø§Ù„ÙŠ',
            paid: 'Ù…Ø¯ÙÙˆØ¹',
            remaining: 'Ù…ØªØ¨Ù‚ÙŠ',
            notes: 'Ù…Ù„Ø§Ø­Ø¸Ø§Øª',
            created: 'Ø¥Ù†Ø´Ø§Ø¡',
            updated: 'ØªØ­Ø¯ÙŠØ«',
            account: 'Ø­Ø³Ø§Ø¨',
            balance: 'Ø±ØµÙŠØ¯',
            debit: 'Ù…Ø¯ÙŠÙ†',
            credit: 'Ø¯Ø§Ø¦Ù†',
            description: 'ÙˆØµÙ',
            reference: 'Ù…Ø±Ø¬Ø¹',
            entry: 'Ù‚ÙŠØ¯',
            line: 'Ø³Ø·Ø±',
            code: 'ÙƒÙˆØ¯',
            method: 'Ø·Ø±ÙŠÙ‚Ø©',
            invoice: 'ÙØ§ØªÙˆØ±Ø©',
            expense: 'Ù…ØµØ±ÙˆÙ',
            vendor: 'Ù…ÙˆØ±Ø¯',
            revenue: 'Ø¥ÙŠØ±Ø§Ø¯',
            income: 'Ø¯Ø®Ù„',
            entity: 'ÙƒÙŠØ§Ù†'
        };

        const TABLE_ROWS_MAP = {};
        const TABLE_COLUMNS_MAP = {};

        function renderTables() {
            renderDynamicTable('invoicesHead', 'invoicesTable', dataStore.invoices, 'invoicesCount', 'invoices');
            renderDynamicTable('expensesHead', 'expensesTable', dataStore.expenses, 'expensesCount', 'expenses');
            renderDynamicTable('paymentsHead', 'paymentsTable', dataStore.payments, 'paymentsCount', 'payments');
            renderDynamicTable('entriesHead', 'entriesTable', dataStore.entries, 'entriesCount', 'entries');
            renderDynamicTable('linesHead', 'linesTable', dataStore.lines, 'linesCount', 'lines');

            renderDynamicTable('incomeRevenueHead', 'incomeRevenueTable', dataStore.incomeRevenue, 'incomeRevenueCount', 'incomeRevenue');
            renderDynamicTable('incomeExpenseHead', 'incomeExpenseTable', dataStore.incomeExpenses, 'incomeExpenseCount', 'incomeExpenses');

            const bsRows = dataStore.balanceSheet ? [dataStore.balanceSheet.sheet] : [];
            renderDynamicTable('balanceSheetHead', 'balanceSheetTable', bsRows, 'balanceSheetCount', 'balanceSheet');
        }

        function renderActionPanel() {
            const tableSelect = document.getElementById('actionTable');
            const rowSelect = document.getElementById('actionRow');
            if (!tableSelect || !rowSelect) return;

            const options = Object.keys(TABLE_LABELS).map(key => `<option value="${key}">${TABLE_LABELS[key]}</option>`).join('');
            tableSelect.innerHTML = options;
            if (!tableSelect.value) tableSelect.value = 'invoices';
            updateRowSelect(tableSelect.value);
        }

        function updateRowSelect(tableKey) {
            const rowSelect = document.getElementById('actionRow');
            const addBtn = document.getElementById('actionAdd');
            const editBtn = document.getElementById('actionEdit');
            const viewBtn = document.getElementById('actionView');
            const deleteBtn = document.getElementById('actionDelete');
            if (!rowSelect) return;

            const rows = TABLE_ROWS_MAP[tableKey] || [];
            const config = TABLE_CONFIGS[tableKey] || { readOnly: true };
            rowSelect.innerHTML = rows.length
                ? rows.map((row, idx) => `<option value="${idx}">${getRowLabel(tableKey, row, idx)}</option>`).join('')
                : '<option value="">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª</option>';

            const hasRows = rows.length > 0;
            [editBtn, viewBtn, deleteBtn].forEach(btn => {
                if (!btn) return;
                btn.disabled = !hasRows;
                btn.classList.toggle('opacity-50', !hasRows);
                btn.classList.toggle('cursor-not-allowed', !hasRows);
            });

            if (addBtn) {
                addBtn.disabled = !!config.readOnly;
                addBtn.classList.toggle('opacity-50', !!config.readOnly);
                addBtn.classList.toggle('cursor-not-allowed', !!config.readOnly);
            }
        }

        function getRowLabel(tableKey, row, idx) {
            if (!row) return `Ø³Ø¬Ù„ ${idx + 1}`;
            const config = TABLE_CONFIGS[tableKey] || {};
            const idValue = config.idField ? row[config.idField] : null;
            const label = row.invoice_number || row.expense_number || row.payment_number || row.entry_number || row.line_number || row.account_name_ar || row.customer_name || row.vendor_name || row.description || row.notes;
            const idText = idValue ? `#${idValue}` : `#${idx + 1}`;
            return label ? `${idText} - ${label}` : idText;
        }

        function renderDynamicTable(headId, bodyId, rows, countId, tableKey) {
            const head = document.getElementById(headId);
            const body = document.getElementById(bodyId);
            const count = document.getElementById(countId);
            const config = TABLE_CONFIGS[tableKey] || { readOnly: true };

            count.textContent = `Ø¹Ø¯Ø¯ Ø§Ù„ØµÙÙˆÙ: ${rows.length}`;
            const columns = Array.from(new Set(rows.flatMap(row => Object.keys(row))));
            TABLE_ROWS_MAP[tableKey] = rows;
            TABLE_COLUMNS_MAP[tableKey] = columns;

            const addButton = config.readOnly
                ? `<button class="px-3 py-1 rounded-lg border text-slate-400 cursor-not-allowed" disabled>Ø¥Ø¶Ø§ÙØ©</button>`
                : `<button onclick="openAddModal('${tableKey}')" class="px-3 py-1 rounded-lg bg-slate-900 text-white">Ø¥Ø¶Ø§ÙØ©</button>`;

            head.innerHTML = `
                <tr>
                    ${columns.map((c, idx) => `<th class="px-3 py-2 text-right">${getArabicLabel(c, idx)}</th>`).join('')}
                    <th class="px-3 py-2 text-right">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                </tr>
                <tr>
                    <th colspan="${columns.length + 1}" class="px-3 py-2 text-left">${addButton}</th>
                </tr>
            `;

            if (!rows.length) {
                body.innerHTML = `<tr><td colspan="${columns.length + 1}" class="px-4 py-8 text-center text-slate-500">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</td></tr>`;
                return;
            }

            body.innerHTML = rows.map((row, rowIndex) => `
                <tr class="hover:bg-slate-50">
                    ${columns.map(c => `<td class="px-3 py-2">${formatValue(row[c], c)}</td>`).join('')}
                    <td class="px-3 py-2">
                        <div class="flex gap-2">
                            <button onclick="openViewModal('${tableKey}', ${rowIndex})" class="p-2 text-indigo-600 hover:bg-indigo-50 rounded-lg transition" title="Ù…Ø¹Ø§ÙŠÙ†Ø©">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button onclick="openEditModal('${tableKey}', ${rowIndex})" class="p-2 text-blue-600 hover:bg-blue-50 rounded-lg transition ${config.readOnly ? 'opacity-50 cursor-not-allowed' : ''}" title="ØªØ¹Ø¯ÙŠÙ„" ${config.readOnly ? 'disabled' : ''}>
                                <i class="fas fa-pen"></i>
                            </button>
                            <button onclick="deleteRow('${tableKey}', ${rowIndex})" class="p-2 text-red-600 hover:bg-red-50 rounded-lg transition ${config.readOnly ? 'opacity-50 cursor-not-allowed' : ''}" title="Ø­Ø°Ù" ${config.readOnly ? 'disabled' : ''}>
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        function sum(rows, key) {
            return rows.reduce((acc, r) => acc + parseFloat(r[key] || 0), 0);
        }

        function formatMoney(value) {
            const num = parseFloat(value || 0);
            return num.toLocaleString('ar-SA') + ' Ø±.Ø³';
        }

        function formatDateValue(value) {
            if (!value) return '-';
            const d = new Date(value);
            if (Number.isNaN(d.getTime())) return String(value);
            return d.toLocaleDateString('ar-SA');
        }

        function formatDateTimeValue(value) {
            if (!value) return '-';
            const d = new Date(value);
            if (Number.isNaN(d.getTime())) return String(value);
            return d.toLocaleString('ar-SA');
        }

        function translateValue(value) {
            if (value === null || value === undefined || value === '') return '-';
            const key = String(value).toUpperCase();
            return STATUS_LABELS[key] || PAYMENT_METHOD_LABELS[key] || PAYMENT_TYPE_LABELS[key] || value;
        }

        function getArabicLabel(key, index) {
            if (!key) return `Ø­Ù‚Ù„ ${index + 1}`;
            if (COLUMN_LABELS[key]) return COLUMN_LABELS[key];
            if (key.endsWith('_en')) {
                const base = key.replace(/_en$/, '');
                return `${getArabicLabel(base, index)} Ø¨Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©`;
            }
            if (key.endsWith('_ar')) {
                const base = key.replace(/_ar$/, '');
                return `${getArabicLabel(base, index)} Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©`;
            }
            const parts = key.split('_');
            const mapped = parts.map(part => WORD_TRANSLATIONS[part]).filter(Boolean);
            if (!mapped.length) return `Ø­Ù‚Ù„ ${index + 1}`;
            return mapped.join(' ');
        }

        function formatValue(value, key) {
            if (value === null || value === undefined || value === '') return '-';
            if (key && /_en$/i.test(key)) return '-';

            if (typeof value === 'boolean') return value ? 'Ù†Ø¹Ù…' : 'Ù„Ø§';

            if (key && /(date|_at)$/i.test(key)) {
                return key.endsWith('_at') ? formatDateTimeValue(value) : formatDateValue(value);
            }

            if (key && /(amount|total|paid|remaining|cost|price|value|balance|debit|credit)/i.test(key)) {
                const num = parseFloat(value);
                return Number.isFinite(num) ? formatMoney(num) : translateValue(value);
            }

            if (key && /(status|level|method|type)/i.test(key)) {
                return translateValue(value);
            }

            if (typeof value === 'number') return value.toLocaleString('ar-SA');
            if (typeof value === 'object') return 'ØªÙØ§ØµÙŠÙ„';
            if (typeof value === 'string') {
                const translated = translateValue(value);
                if (typeof translated === 'string' && /[A-Za-z]/.test(translated)) return '-';
                return translated;
            }
            return String(value);
        }

        function createModal(title, contentHtml, footerHtml = '') {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay fixed inset-0 bg-black/40 flex items-start justify-center z-50 p-4 overflow-y-auto';
            modal.innerHTML = `
                <div class="bg-white rounded-2xl shadow-2xl w-full max-w-3xl my-6">
                    <div class="p-5 border-b flex items-center justify-between">
                        <h3 class="font-bold text-lg">${title}</h3>
                        <button onclick="this.closest('.modal-overlay').remove()" class="text-gray-500 hover:text-gray-700"><i class="fas fa-times"></i></button>
                    </div>
                    <div class="p-5 space-y-3 text-sm">${contentHtml}</div>
                    ${footerHtml ? `<div class="p-5 border-t flex items-center justify-end gap-2">${footerHtml}</div>` : ''}
                </div>
            `;
            document.body.appendChild(modal);
        }

        function getEditableColumns(tableKey, columns) {
            const config = TABLE_CONFIGS[tableKey] || {};
            const excluded = new Set([
                config.idField,
                'created_at',
                'updated_at',
                'approved_at',
                'cancelled_at',
                'posted_at',
                'posted_by'
            ].filter(Boolean));
            return columns.filter(col => !excluded.has(col));
        }

        function formatInputDate(value, withTime) {
            if (!value) return '';
            const d = new Date(value);
            if (Number.isNaN(d.getTime())) return '';
            return withTime ? d.toISOString().slice(0, 16) : d.toISOString().slice(0, 10);
        }

        function buildInputField(key, value) {
            const label = getArabicLabel(key, 0);
            const isDateTime = key.endsWith('_at');
            const isDate = !isDateTime && /date/i.test(key);
            const isNumber = /amount|total|paid|remaining|cost|price|value|balance|debit|credit|score|count|ratio|percentage/i.test(key);

            if (value && typeof value === 'object') {
                return `
                    <div>
                        <label class="block mb-1 text-gray-600">${label}</label>
                        <textarea data-field="${key}" data-type="json" class="w-full border rounded-lg px-3 py-2" rows="2">${JSON.stringify(value)}</textarea>
                    </div>
                `;
            }

            if (isDateTime) {
                return `
                    <div>
                        <label class="block mb-1 text-gray-600">${label}</label>
                        <input data-field="${key}" type="datetime-local" class="w-full border rounded-lg px-3 py-2" value="${formatInputDate(value, true)}">
                    </div>
                `;
            }

            if (isDate) {
                return `
                    <div>
                        <label class="block mb-1 text-gray-600">${label}</label>
                        <input data-field="${key}" type="date" class="w-full border rounded-lg px-3 py-2" value="${formatInputDate(value, false)}">
                    </div>
                `;
            }

            if (typeof value === 'boolean') {
                return `
                    <div>
                        <label class="block mb-1 text-gray-600">${label}</label>
                        <select data-field="${key}" class="w-full border rounded-lg px-3 py-2">
                            <option value="true" ${value ? 'selected' : ''}>Ù†Ø¹Ù…</option>
                            <option value="false" ${!value ? 'selected' : ''}>Ù„Ø§</option>
                        </select>
                    </div>
                `;
            }

            return `
                <div>
                    <label class="block mb-1 text-gray-600">${label}</label>
                    <input data-field="${key}" type="${isNumber ? 'number' : 'text'}" ${isNumber ? 'step="0.01"' : ''} class="w-full border rounded-lg px-3 py-2" value="${value ?? ''}">
                </div>
            `;
        }

        function collectFormValues(form, columns) {
            const payload = {};
            columns.forEach(key => {
                const input = form.querySelector(`[data-field="${key}"]`);
                if (!input) return;
                let value = input.value;
                if (value === '') return;
                if (input.dataset.type === 'json') {
                    try {
                        value = JSON.parse(value);
                    } catch {
                        value = value;
                    }
                } else if (input.type === 'number') {
                    const num = parseFloat(value);
                    value = Number.isFinite(num) ? num : value;
                } else if (input.tagName === 'SELECT' && (value === 'true' || value === 'false')) {
                    value = value === 'true';
                }
                payload[key] = value;
            });

            if (!('entity_id' in payload)) payload.entity_id = ENTITY_ID;
            if (!('entity_type' in payload)) payload.entity_type = ENTITY_TYPE;
            return payload;
        }

        function openViewModal(tableKey, rowIndex) {
            const rows = TABLE_ROWS_MAP[tableKey] || [];
            const row = rows[rowIndex];
            if (!row) return;
            const columns = TABLE_COLUMNS_MAP[tableKey] || Object.keys(row);
            const content = columns.map((key, idx) => `
                <div class="flex items-center justify-between border-b pb-2">
                    <span class="font-semibold text-gray-700">${getArabicLabel(key, idx)}</span>
                    <span class="text-gray-900">${formatValue(row[key], key)}</span>
                </div>
            `).join('');
            createModal('ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø³Ø¬Ù„', content);
        }

        function openAddModal(tableKey) {
            const config = TABLE_CONFIGS[tableKey] || { readOnly: true };
            if (config.readOnly || !config.endpoint) {
                alert('Ù‡Ø°Ù‡ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø¹Ø±Ø¶ ÙÙ‚Ø· Ø¯Ø§Ø®Ù„ Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø©.');
                return;
            }
            const columns = TABLE_COLUMNS_MAP[tableKey] || [];
            const editable = getEditableColumns(tableKey, columns);
            const fields = editable.length
                ? editable.map(key => buildInputField(key, '')).join('')
                : `<div class="text-slate-500">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ù‚ÙˆÙ„ Ø¬Ø§Ù‡Ø²Ø© Ù„Ù„Ø¥Ø¶Ø§ÙØ© Ø­Ø§Ù„ÙŠØ§Ù‹.</div>`;
            const content = `<form id="modal-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">${fields}</form>`;
            const footer = `
                <button onclick="this.closest('.modal-overlay').remove()" class="px-4 py-2 rounded-lg border">Ø¥Ù„ØºØ§Ø¡</button>
                <button onclick="submitModal('${tableKey}', 'add')" class="px-4 py-2 rounded-lg bg-slate-900 text-white">Ø­ÙØ¸</button>
            `;
            createModal('Ø¥Ø¶Ø§ÙØ© Ø³Ø¬Ù„ Ø¬Ø¯ÙŠØ¯', content, footer);
        }

        function openEditModal(tableKey, rowIndex) {
            const config = TABLE_CONFIGS[tableKey] || { readOnly: true };
            if (config.readOnly || !config.endpoint) {
                alert('Ù‡Ø°Ù‡ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø¹Ø±Ø¶ ÙÙ‚Ø· Ø¯Ø§Ø®Ù„ Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø©.');
                return;
            }
            const rows = TABLE_ROWS_MAP[tableKey] || [];
            const row = rows[rowIndex];
            if (!row) return;
            const columns = TABLE_COLUMNS_MAP[tableKey] || Object.keys(row);
            const editable = getEditableColumns(tableKey, columns);
            const fields = editable.map(key => buildInputField(key, row[key])).join('');
            const content = `<form id="modal-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">${fields}</form>`;
            const footer = `
                <button onclick="this.closest('.modal-overlay').remove()" class="px-4 py-2 rounded-lg border">Ø¥Ù„ØºØ§Ø¡</button>
                <button onclick="submitModal('${tableKey}', 'edit', ${rowIndex})" class="px-4 py-2 rounded-lg bg-slate-900 text-white">Ø­ÙØ¸</button>
            `;
            createModal('ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø³Ø¬Ù„', content, footer);
        }

        async function submitModal(tableKey, mode, rowIndex) {
            const config = TABLE_CONFIGS[tableKey] || {};
            if (!config.endpoint) return;
            const form = document.getElementById('modal-form');
            if (!form) return;
            const columns = TABLE_COLUMNS_MAP[tableKey] || [];
            const editable = getEditableColumns(tableKey, columns);
            const payload = collectFormValues(form, editable);

            if (isDemoMode) {
                handleDemoSubmit(tableKey, mode, rowIndex, payload);
                document.querySelector('.modal-overlay')?.remove();
                return;
            }

            let url = `${API_BASE}${config.endpoint}`;
            let method = 'POST';
            if (mode === 'edit') {
                const row = (TABLE_ROWS_MAP[tableKey] || [])[rowIndex];
                const id = row ? row[config.idField] : null;
                if (!id) {
                    alert('ØªØ¹Ø°Ø± ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…Ø¹Ø±Ù‘Ù Ù„Ù„ØªØ¹Ø¯ÙŠÙ„');
                    return;
                }
                url = `${API_BASE}${config.endpoint}/${id}`;
                method = 'PUT';
            }

            const res = await fetch(url, {
                method,
                headers: { 'Content-Type': 'application/json', ...getFinanceHeaders() },
                body: JSON.stringify(payload)
            });

            if (res.ok) {
                document.querySelector('.modal-overlay')?.remove();
                await loadData();
            } else {
                let message = mode === 'edit' ? 'ØªØ¹Ø°Ø± ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø³Ø¬Ù„' : 'ØªØ¹Ø°Ø± Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø³Ø¬Ù„';
                try {
                    const data = await res.json();
                    if (data && data.error) message = data.error;
                } catch (e) {
                    // ignore
                }
                alert(message);
            }
        }

        async function deleteRow(tableKey, rowIndex) {
            const config = TABLE_CONFIGS[tableKey] || {};
            if (config.readOnly || !config.endpoint) {
                alert('Ù‡Ø°Ù‡ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø¹Ø±Ø¶ ÙÙ‚Ø· Ø¯Ø§Ø®Ù„ Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø©.');
                return;
            }
            if (!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø³Ø¬Ù„ØŸ')) return;
            const row = (TABLE_ROWS_MAP[tableKey] || [])[rowIndex];
            const id = row ? row[config.idField] : null;
            if (!id) {
                alert('ØªØ¹Ø°Ø± ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…Ø¹Ø±Ù‘Ù Ù„Ù„Ø­Ø°Ù');
                return;
            }

            if (isDemoMode) {
                const rows = dataStore[tableKey] || [];
                rows.splice(rowIndex, 1);
                renderAll();
                return;
            }
            const res = await fetch(`${API_BASE}${config.endpoint}/${id}`, {
                method: 'DELETE',
                headers: getFinanceHeaders()
            });

            if (res.ok) {
                await loadData();
            } else {
                let message = 'ØªØ¹Ø°Ø± Ø­Ø°Ù Ø§Ù„Ø³Ø¬Ù„';
                try {
                    const data = await res.json();
                    if (data && data.error) message = data.error;
                } catch (e) {
                    // ignore
                }
                alert(message);
            }
        }

        function downloadJSON() {
            downloadBlob(JSON.stringify(dataStore, null, 2), 'Ø§Ù„Ø¯ÙˆØ±Ø©-Ø§Ù„Ù…Ø­Ø§Ø³Ø¨ÙŠØ©.json', 'application/json');
        }

        function downloadCSV() {
            const sections = [
                ['Ø§Ù„ÙÙˆØ§ØªÙŠØ±', dataStore.invoices],
                ['Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª', dataStore.expenses],
                ['Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª', dataStore.payments],
                ['Ù‚ÙŠÙˆØ¯ Ø§Ù„ÙŠÙˆÙ…ÙŠØ©', dataStore.entries],
                ['Ø³Ø·ÙˆØ± Ø§Ù„Ù‚ÙŠÙˆØ¯', dataStore.lines],
                ['Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¯Ø®Ù„ - Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª', dataStore.incomeRevenue],
                ['Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¯Ø®Ù„ - Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª', dataStore.incomeExpenses],
                ['Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ© Ø§Ù„Ø¹Ù…ÙˆÙ…ÙŠØ©', dataStore.balanceSheet ? [dataStore.balanceSheet.sheet] : []]
            ];
            const rows = [];
            sections.forEach(([title, data]) => {
                rows.push([title]);
                if (data.length) {
                    const cols = Array.from(new Set(data.flatMap(row => Object.keys(row))));
                    rows.push(cols.map((c, idx) => getArabicLabel(c, idx)));
                    data.forEach(row => rows.push(cols.map(c => formatValue(row[c], c))));
                }
                rows.push([]);
            });
            const csvContent = rows.map(r => r.map(v => `"${v ?? ''}"`).join(',')).join('\n');
            downloadBlob(csvContent, 'Ø§Ù„Ø¯ÙˆØ±Ø©-Ø§Ù„Ù…Ø­Ø§Ø³Ø¨ÙŠØ©.csv', 'text/csv;charset=utf-8;');
        }

        function downloadBlob(content, filename, type) {
            const blob = new Blob([content], { type });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            link.click();
            URL.revokeObjectURL(url);
        }

        function printReport() {
            window.print();
        }

        function refreshData() {
            loadData();
        }

        function handleDemoSubmit(tableKey, mode, rowIndex, payload) {
            const rows = dataStore[tableKey] || [];
            const config = TABLE_CONFIGS[tableKey] || {};
            const idField = config.idField;

            if (mode === 'add') {
                const nextId = idField ? getNextId(rows, idField) : rows.length + 1;
                const row = { ...payload };
                if (idField && !row[idField]) row[idField] = nextId;
                rows.push(row);
            } else if (mode === 'edit') {
                const row = rows[rowIndex];
                if (row) rows[rowIndex] = { ...row, ...payload };
            }
            renderAll();
        }

        function getNextId(rows, idField) {
            const max = rows.reduce((acc, row) => {
                const value = parseInt(row[idField], 10);
                return Number.isFinite(value) ? Math.max(acc, value) : acc;
            }, 0);
            return max + 1;
        }

        function bindActionPanel() {
            const tableSelect = document.getElementById('actionTable');
            const rowSelect = document.getElementById('actionRow');
            const addBtn = document.getElementById('actionAdd');
            const viewBtn = document.getElementById('actionView');
            const editBtn = document.getElementById('actionEdit');
            const deleteBtn = document.getElementById('actionDelete');
            if (!tableSelect || !rowSelect) return;

            tableSelect.addEventListener('change', () => updateRowSelect(tableSelect.value));

            addBtn?.addEventListener('click', () => openAddModal(tableSelect.value));
            viewBtn?.addEventListener('click', () => {
                if (!rowSelect.value) return alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª Ù„Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©');
                openViewModal(tableSelect.value, Number(rowSelect.value));
            });
            editBtn?.addEventListener('click', () => {
                if (!rowSelect.value) return alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª Ù„Ù„ØªØ¹Ø¯ÙŠÙ„');
                openEditModal(tableSelect.value, Number(rowSelect.value));
            });
            deleteBtn?.addEventListener('click', () => {
                if (!rowSelect.value) return alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª Ù„Ù„Ø­Ø°Ù');
                deleteRow(tableSelect.value, Number(rowSelect.value));
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            bindActionPanel();
            loadData();
        });
    </script>
</body>
</html>
