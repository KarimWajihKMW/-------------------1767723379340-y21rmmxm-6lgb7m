<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>๐ ุงูุชูุงุฑูุฑ ุงูุงุณุชุฑุงุชูุฌูุฉ ูุงูุฐูุงุก ุงููุงูู - ูุธุงู ูุงููุด</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Cairo', sans-serif; background-color: #f9fafb; color: #0f172a; }
        
        .card-gradient {
            background: linear-gradient(145deg, #ffffff, #f3f4f6);
            border: 1px solid #e2e8f0;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
    
        .shape-rounded { border-radius: 26px; }
        .shape-angled { border-radius: 34px 10px 34px 10px; }
        .shape-pill { border-radius: 999px; }
        .shape-cut { border-radius: 18px 18px 42px 8px; }
        .table-scroll { max-height: 520px; overflow: auto; }
        .chart-box { position: relative; height: 260px; }
        .accent-sky { border-top: 4px solid #0ea5e9; }
        .accent-indigo { border-top: 4px solid #6366f1; }
        .accent-emerald { border-top: 4px solid #10b981; }
        .accent-rose { border-top: 4px solid #f43f5e; }
        .accent-amber { border-top: 4px solid #f59e0b; }
        .tab-btn.active { background: #e0f2fe; color: #0f172a; border-bottom: 3px solid #0ea5e9; }
    </style>
</head>
<body>
    <div class="container mx-auto px-4 py-8">
        <div class="text-slate-900 mb-8">
            <h1 class="text-4xl font-bold mb-2">๐ ุงูุชูุงุฑูุฑ ุงูุงุณุชุฑุงุชูุฌูุฉ ูุงูุฐูุงุก ุงููุงูู</h1>
            <p class="text-lg text-slate-600">ุชูุงุฑูุฑ ุงูุฅุฏุงุฑุฉ ุงูุนููุง ูุงูุฑุงุฏุงุฑ ุงููุงูู ูุฎุงุฑุทุฉ ุงูุญูููุฉ (ุงูุตูุญุฉ 37)</p>
            <div id="lastUpdated" class="text-sm text-slate-500 mt-2">ุขุฎุฑ ุชุญุฏูุซ: -</div>
        </div>

        <div class="mb-6 flex flex-wrap gap-3">
            <button onclick="refreshData()" class="bg-white text-sky-700 border border-sky-100 shadow-sm px-6 py-3 rounded-full font-bold hover:shadow-lg transition flex items-center gap-2">
                <i class="fas fa-rotate"></i>
                ุชุญุฏูุซ ุงูุจูุงูุงุช
            </button>
            <button onclick="downloadAllJSON()" class="bg-indigo-600 text-white px-6 py-3 rounded-full font-bold hover:shadow-lg transition flex items-center gap-2">
                <i class="fas fa-file-code"></i>
                ุชูุฒูู ููู ุจูุงูุงุช ุดุงูู
            </button>
            <button onclick="downloadAllCSV()" class="bg-emerald-600 text-white px-6 py-3 rounded-full font-bold hover:shadow-lg transition flex items-center gap-2">
                <i class="fas fa-file-csv"></i>
                ุชูุฒูู ููู ุฌุฏููู ุดุงูู
            </button>
            <button onclick="printPage()" class="bg-rose-600 text-white px-6 py-3 rounded-full font-bold hover:shadow-lg transition flex items-center gap-2">
                <i class="fas fa-print"></i>
                ุทุจุงุนุฉ ุงูุตูุญุฉ
            </button>
            <button onclick="copySummary()" class="bg-amber-500 text-white px-6 py-3 rounded-full font-bold hover:shadow-lg transition flex items-center gap-2">
                <i class="fas fa-copy"></i>
                ูุณุฎ ููุฎุต ุงูุชูุงุฑูุฑ
            </button>
        </div>

        <div class="card-gradient shape-rounded shadow-2xl p-6 mb-8 accent-sky">
            <div class="flex flex-wrap items-center justify-between gap-3 mb-6">
                <h2 class="text-2xl font-bold text-slate-800">๐ ุงูุฅุทุงุฑ ุงูุงุณุชุฑุงุชูุฌู ููุชูุงุฑูุฑ</h2>
                <span class="text-sm text-slate-500">ุฑุจุท ุงูุดูุงููุฉ ูุงูุงูุถุจุงุท ููุงุจููุฉ ุงูุชูุณุน</span>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-5">
                <div class="card-gradient shape-angled p-5 shadow-lg border border-sky-100">
                    <h3 class="font-bold text-slate-800 mb-2">ูุซููุฉ ุชุดุบูู ูุงูู ููุญุฏุฉ</h3>
                    <p class="text-sm text-slate-600">ุชุฑุจุท ูู ุงููุญุฏุงุช ูุชุถูู ุงูุงูุถุจุงุท ูุงูุดูุงููุฉ ููุงุจููุฉ ุงูุชูุณุน.</p>
                </div>
                <div class="card-gradient shape-cut p-5 shadow-lg border border-indigo-100">
                    <h3 class="font-bold text-slate-800 mb-2">ุฎุงุฑุทุฉ ุงูุญูููุฉ ุงููุงููุฉ</h3>
                    <ul class="text-sm text-slate-600 space-y-1">
                        <li>ุงูุฅุทุงุฑ ุงูุนุงู ููุญูููุฉ ุงููุงููุฉ</li>
                        <li>ุงูุณูุงุณุงุช ุงููุงููุฉ ุงูุฃุณุงุณูุฉ</li>
                        <li>ุฅุฌุฑุงุกุงุช ุงูุชุดุบูู ุงูููุงุณูุฉ</li>
                    </ul>
                </div>
                <div class="card-gradient shape-rounded p-5 shadow-lg border border-emerald-100">
                    <h3 class="font-bold text-slate-800 mb-2">ุญูููุฉ ุงูุจูุงูุงุช ูุงูุชูุงุฑูุฑ</h3>
                    <ul class="text-sm text-slate-600 space-y-1">
                        <li>ุญูููุฉ ุงูุจูุงูุงุช ุงููุงููุฉ</li>
                        <li>ุญูููุฉ ุงูุชูุงุฑูุฑ ุงููุงููุฉ</li>
                        <li>ุญูููุฉ ุงูุฐูุงุก ุงูุงุตุทูุงุนู</li>
                    </ul>
                </div>
                <div class="card-gradient shape-pill p-5 shadow-lg border border-rose-100">
                    <h3 class="font-bold text-slate-800 mb-2">ุญูููุฉ ุงููุฎุงุทุฑ</h3>
                    <ul class="text-sm text-slate-600 space-y-1">
                        <li>ูุตูููุฉ ูุฎุงุทุฑ ูููุฑูุน ูุงูุจุฑุงูุฌ</li>
                        <li>ุชูุจููุงุช ูุจูุฑุฉ ููุชุนุซุฑ</li>
                        <li>ุชูุงุฑูุฑ ูุฌูุณ ุงูุฅุฏุงุฑุฉ</li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-5 mb-8">
            <div class="card-gradient shape-angled p-5 shadow-lg accent-sky">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-sm text-slate-600">ุฅูุฑุงุฏุงุช ูุฌูุนุฉ</span>
                    <i class="fas fa-chart-line text-sky-500 text-2xl"></i>
                </div>
                <div id="totalRevenue" class="text-3xl font-bold text-slate-800">0</div>
            </div>
            <div class="card-gradient shape-cut p-5 shadow-lg accent-emerald">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-sm text-slate-600">ุตุงูู ุงูุชุฏูู ุงูููุฏู</span>
                    <i class="fas fa-water text-emerald-500 text-2xl"></i>
                </div>
                <div id="netCashflow" class="text-3xl font-bold text-slate-800">0</div>
            </div>
            <div class="card-gradient shape-rounded p-5 shadow-lg accent-rose">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-sm text-slate-600">ุงูุฐูู ุงููุชุฃุฎุฑุฉ</span>
                    <i class="fas fa-triangle-exclamation text-rose-500 text-2xl"></i>
                </div>
                <div id="overdueAmount" class="text-3xl font-bold text-slate-800">0</div>
            </div>
            <div class="card-gradient shape-pill p-5 shadow-lg accent-amber">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-sm text-slate-600">ุชููุนุงุช 90 ููู</span>
                    <i class="fas fa-calendar-week text-amber-500 text-2xl"></i>
                </div>
                <div id="forecast90" class="text-3xl font-bold text-slate-800">0</div>
            </div>
        </div>

        <div class="card-gradient shape-rounded shadow-2xl p-6 mb-8 accent-indigo">
            <div class="flex flex-wrap items-center justify-between gap-3 mb-6">
                <h2 class="text-2xl font-bold text-slate-800">๐งญ ุชูุงุฑูุฑ ุงุณุชุฑุงุชูุฌูุฉ ููุฅุฏุงุฑุฉ ุงูุนููุง</h2>
                <span class="text-sm text-slate-500">ุฑุตุฏ ุงูุฅูุฑุงุฏุงุช ูุงููุฎุงุทุฑ ูุงูุชููุนุงุช</span>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-5">
                <div class="card-gradient shape-angled p-4 border border-sky-100">
                    <h4 class="font-bold text-slate-800 mb-2">ุชูุฑูุฑ ุงููุถุน ุงููุงูู ููุฅูุจุฑุงุทูุฑูุฉ</h4>
                    <ul class="text-sm text-slate-600 space-y-1">
                        <li>ุฅูุฑุงุฏุงุช ูุฌููุนุฉ ุญุณุจ ุงููุฑุน ูุงูุญุงุถูุฉ ูุงูุจุฑูุงูุฌ</li>
                        <li>ุตุงูู ุงูุฑุจุญ ูุงูุชุฏูู ุงูููุฏู</li>
                        <li>ุงูุฐูู ุงููุฏููุฉ ูุงููุชุฃุฎุฑุฉ</li>
                    </ul>
                </div>
                <div class="card-gradient shape-cut p-4 border border-emerald-100">
                    <h4 class="font-bold text-slate-800 mb-2">ูุตูููุฉ ุงููุฎุงุทุฑ</h4>
                    <ul class="text-sm text-slate-600 space-y-1">
                        <li>Top 20 ุนููุงุก ูุฎุงุทุฑุฉ</li>
                        <li>Top 10 ูุฑูุน ูุฎุงุทุฑุฉ</li>
                        <li>Top 10 ุจุฑุงูุฌ ูุฎุงุทุฑุฉ</li>
                    </ul>
                </div>
                <div class="card-gradient shape-rounded p-4 border border-amber-100">
                    <h4 class="font-bold text-slate-800 mb-2">ุฑุงุฏุงุฑ ุงููุฎุงุทุฑ ุงููุงููุฉ</h4>
                    <ul class="text-sm text-slate-600 space-y-1">
                        <li>ุชููุนุงุช ุงูุชุนุซุฑ 90 ููููุง</li>
                        <li>ูุคุดุฑุงุช ุงูุชุนุซุฑ ุญุณุจ ุงูุดุฑุงุฆุญ</li>
                        <li>ุชูุจููุงุช ุงููุฎุงุทุฑ</li>
                    </ul>
                </div>
                <div class="card-gradient shape-pill p-4 border border-rose-100">
                    <h4 class="font-bold text-slate-800 mb-2">ูุนุงููุฑ ุงูุชูุงุฑูุฑ</h4>
                    <ul class="text-sm text-slate-600 space-y-1">
                        <li>ุชุจููุจ ุงูุฃุฑูุงู</li>
                        <li>ุชุจููุจ ุงูุฑุณูู ุงูุจูุงููุฉ</li>
                        <li>ุชุจููุจ ููุฎุตุงุช ุงูุฐูุงุก</li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="card-gradient shape-rounded shadow-2xl p-6 mb-8 accent-emerald">
            <div class="flex flex-wrap items-center justify-between gap-3 mb-6">
                <h2 class="text-2xl font-bold text-slate-800">๐ง ุจุฏุก ุงูุฐูุงุก ุงูุงุตุทูุงุนู ุงููุงูู ุฎุทูุฉ ุจุฎุทูุฉ</h2>
                <span class="text-sm text-slate-500">ูุณุฎุฉ ุฃูููุฉ ุฐููุฉ ุซู ุชูุณูุน ุชุฏุฑูุฌู</span>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5">
                <div class="card-gradient shape-angled p-5 border border-sky-100">
                    <h4 class="font-bold text-slate-800 mb-2">ุงูุฎุทูุฉ 0: ุฌุงูุฒูุฉ ุงูุจูุงูุงุช</h4>
                    <ul class="text-sm text-slate-600 space-y-1">
                        <li>ุชูุญูุฏ ุชูุงุฑูุฎ ุงูููุงุชูุฑ ูุงููุฏููุนุงุช</li>
                        <li>ุชูุญูุฏ ุญุงูุงุช ุงูููุงุชูุฑ ูุงูุนููุงุช</li>
                        <li>ุฑุจุท ุนููู โ ุจุฑูุงูุฌ โ ูุฑุน โ ุญุงุถูุฉ</li>
                    </ul>
                </div>
                <div class="card-gradient shape-cut p-5 border border-emerald-100">
                    <h4 class="font-bold text-slate-800 mb-2">ุงูุฎุทูุฉ 1: ุชููุน ุงูุชุฏููุงุช ุงูููุฏูุฉ</h4>
                    <ul class="text-sm text-slate-600 space-y-1">
                        <li>ูุฏู: ุชููุน ุงูุชุญุตูู ููุฃุดูุฑ 3โ6 ุงููุงุฏูุฉ</li>
                        <li>ูุฏุฎูุงุช: ุชุงุฑูุฎ ุงูุชุญุตููุ ููุงุชูุฑ ูุณุฏุฏุฉ/ูุชุฃุฎุฑุฉ</li>
                        <li>ููุงุณ ูุชูุณุท ูุฏุฉ ุงูุณุฏุงุฏ ูุชุฃุซูุฑ ุงูููุงุณู</li>
                    </ul>
                </div>
                <div class="card-gradient shape-rounded p-5 border border-amber-100">
                    <h4 class="font-bold text-slate-800 mb-2">ูุฎุฑุฌุงุช ุงููููุฐุฌ</h4>
                    <ul class="text-sm text-slate-600 space-y-1">
                        <li>ุชููุน ุชุญุตูู ูู ุดูุฑ</li>
                        <li>ุฏุฑุฌุฉ ุงูุซูุฉ ุจุงูุชููุน</li>
                        <li>ุชูุจูู ุนูุฏ ุงูุฎูุงุถ ุงูุชุญุตูู ุนู ุงูุงูุชุฒุงูุงุช</li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="card-gradient shape-rounded shadow-2xl p-6 mb-8 accent-sky">
            <div class="flex border-b border-slate-200 mb-4">
                <button class="tab-btn active flex-1 py-3 font-bold" onclick="switchTab('numbers')">ุงูุชุจููุจ ูก: ุงูุฃุฑูุงู</button>
                <button class="tab-btn flex-1 py-3 font-bold" onclick="switchTab('charts')">ุงูุชุจููุจ ูข: ุงูุฑุณูู ุงูุจูุงููุฉ</button>
                <button class="tab-btn flex-1 py-3 font-bold" onclick="switchTab('insights')">ุงูุชุจููุจ ูฃ: ููุฎุตุงุช ุงูุฐูุงุก</button>
            </div>

            <div id="tab-numbers" class="tab-content">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                    <div class="card-gradient shape-rounded p-5 shadow-lg accent-sky">
                        <div class="flex items-center justify-between mb-3">
                            <h3 class="text-lg font-bold text-slate-800">๐ ููุงุชูุฑ ุญุณุจ ุงููุฑูุน</h3>
                            <span id="branchRevenueCount" class="text-sm text-slate-500"></span>
                        </div>
                        <div class="table-scroll">
                            <table class="w-full text-xs">
                                <thead class="bg-sky-50 text-sky-700">
                                    <tr>
                                        <th class="px-3 py-2 text-right">ุงููุฑุน</th>
                                        <th class="px-3 py-2 text-right">ุฑูู ุงููุงุชูุฑุฉ</th>
                                        <th class="px-3 py-2 text-right">ูููุฉ ุงููุงุชูุฑุฉ</th>
                                        <th class="px-3 py-2 text-right">ุงูุญุงูุฉ</th>
                                        <th class="px-3 py-2 text-right">ุฅุฌุฑุงุกุงุช</th>
                                    </tr>
                                </thead>
                                <tbody id="branchRevenueTable" class="divide-y divide-slate-100">
                                    <tr><td colspan="5" class="px-4 py-8 text-center text-slate-500">ุฌุงุฑู ุงูุชุญููู...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="card-gradient shape-rounded p-5 shadow-lg accent-emerald">
                        <div class="flex items-center justify-between mb-3">
                            <h3 class="text-lg font-bold text-slate-800">๐ ููุงุชูุฑ ุญุณุจ ุงูุจุฑุงูุฌ</h3>
                            <span id="programRevenueCount" class="text-sm text-slate-500"></span>
                        </div>
                        <div class="table-scroll">
                            <table class="w-full text-xs">
                                <thead class="bg-emerald-50 text-emerald-700">
                                    <tr>
                                        <th class="px-3 py-2 text-right">ุงูุจุฑูุงูุฌ</th>
                                        <th class="px-3 py-2 text-right">ุฑูู ุงููุงุชูุฑุฉ</th>
                                        <th class="px-3 py-2 text-right">ูููุฉ ุงููุงุชูุฑุฉ</th>
                                        <th class="px-3 py-2 text-right">ุงูุญุงูุฉ</th>
                                        <th class="px-3 py-2 text-right">ุฅุฌุฑุงุกุงุช</th>
                                    </tr>
                                </thead>
                                <tbody id="programRevenueTable" class="divide-y divide-slate-100">
                                    <tr><td colspan="5" class="px-4 py-8 text-center text-slate-500">ุฌุงุฑู ุงูุชุญููู...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div class="card-gradient shape-rounded shadow-2xl p-6 mb-6 accent-rose">
                    <div class="flex items-center justify-between mb-3">
                        <h3 class="text-lg font-bold text-slate-800">โ๏ธ ุฌุฏูู ุงูููุงุชูุฑ ุงููุชุฃุฎุฑุฉ</h3>
                        <span id="overdueCount" class="text-sm text-slate-500"></span>
                    </div>
                    <div class="table-scroll">
                        <table class="w-full text-xs">
                            <thead class="bg-rose-50 text-rose-700">
                                <tr>
                                    <th class="px-3 py-2 text-right">ุฑูู ุงููุงุชูุฑุฉ</th>
                                    <th class="px-3 py-2 text-right">ุงุณู ุงูุนููู</th>
                                    <th class="px-3 py-2 text-right">ุชุงุฑูุฎ ุงููุงุชูุฑุฉ</th>
                                    <th class="px-3 py-2 text-right">ุงููุชุจูู</th>
                                    <th class="px-3 py-2 text-right">ุงููุฑุน</th>
                                    <th class="px-3 py-2 text-right">ุงูุจุฑูุงูุฌ</th>
                                        <th class="px-3 py-2 text-right">ุฅุฌุฑุงุกุงุช</th>
                                </tr>
                            </thead>
                            <tbody id="overdueTable" class="divide-y divide-slate-100">
                                    <tr><td colspan="7" class="px-4 py-8 text-center text-slate-500">ุฌุงุฑู ุงูุชุญููู...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="card-gradient shape-rounded shadow-2xl p-6 accent-indigo">
                    <div class="flex items-center justify-between mb-3">
                        <h3 class="text-lg font-bold text-slate-800">๐ก๏ธ ุฑุงุฏุงุฑ ุงููุฎุงุทุฑ ุงููุงููุฉ</h3>
                        <span id="riskRadarCount" class="text-sm text-slate-500"></span>
                    </div>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="table-scroll">
                            <table class="w-full text-xs">
                                <thead class="bg-indigo-50 text-indigo-700">
                                    <tr>
                                        <th class="px-3 py-2 text-right">ุนููู ูุฎุงุทุฑุฉ</th>
                                        <th class="px-3 py-2 text-right">ุฏุฑุฌุฉ ุงููุฎุงุทุฑุฉ</th>
                                        <th class="px-3 py-2 text-right">ุงููุณุชูู</th>
                                        <th class="px-3 py-2 text-right">ุงูุชุงุฑูุฎ</th>
                                        <th class="px-3 py-2 text-right">ุฅุฌุฑุงุกุงุช</th>
                                    </tr>
                                </thead>
                                <tbody id="topRiskCustomersTable" class="divide-y divide-slate-100">
                                    <tr><td colspan="5" class="px-4 py-8 text-center text-slate-500">ุฌุงุฑู ุงูุชุญููู...</td></tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="table-scroll">
                            <table class="w-full text-xs">
                                <thead class="bg-indigo-100 text-indigo-800">
                                    <tr>
                                        <th class="px-3 py-2 text-right">ูุชุฑุฉ ุงูุชููุน</th>
                                        <th class="px-3 py-2 text-right">ููุน ุงูุชููุน</th>
                                        <th class="px-3 py-2 text-right">ูููุฉ ุงูุชููุน</th>
                                        <th class="px-3 py-2 text-right">ุงูุซูุฉ</th>
                                        <th class="px-3 py-2 text-right">ุฅุฌุฑุงุกุงุช</th>
                                    </tr>
                                </thead>
                                <tbody id="forecastTable" class="divide-y divide-slate-100">
                                    <tr><td colspan="5" class="px-4 py-8 text-center text-slate-500">ุฌุงุฑู ุงูุชุญููู...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <div id="tab-charts" class="tab-content hidden">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="card-gradient shape-rounded p-5 shadow-lg accent-sky">
                        <h3 class="text-lg font-bold text-slate-800 mb-3">๐ ุชูุฒูุน ุงูุฅูุฑุงุฏุงุช ุญุณุจ ุงููุฑูุน</h3>
                        <div class="chart-box"><canvas id="branchRevenueChart"></canvas></div>
                    </div>
                    <div class="card-gradient shape-rounded p-5 shadow-lg accent-emerald">
                        <h3 class="text-lg font-bold text-slate-800 mb-3">๐งญ ุชูุฒูุน ูุณุชููุงุช ุงููุฎุงุทุฑ</h3>
                        <div class="chart-box"><canvas id="riskLevelChart"></canvas></div>
                    </div>
                    <div class="card-gradient shape-rounded p-5 shadow-lg accent-amber">
                        <h3 class="text-lg font-bold text-slate-800 mb-3">๐ฎ ูุณุงุฑ ุงูุชููุนุงุช ุงูุฐููุฉ</h3>
                        <div class="chart-box"><canvas id="forecastChart"></canvas></div>
                    </div>
                    <div class="card-gradient shape-rounded p-5 shadow-lg accent-rose">
                        <h3 class="text-lg font-bold text-slate-800 mb-3">๐ง ุงูุชุฏูู ุงูููุฏู ุงูุญุงูู</h3>
                        <div class="chart-box"><canvas id="cashflowChart"></canvas></div>
                    </div>
                </div>
            </div>

            <div id="tab-insights" class="tab-content hidden">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="card-gradient shape-angled p-5 shadow-lg accent-indigo">
                        <h3 class="text-lg font-bold text-slate-800 mb-3">๐ ููุฎุต ุงูุฐูุงุก</h3>
                        <div id="aiSummary" class="text-sm text-slate-600 space-y-2">
                            <div class="animate-pulse">ุฌุงุฑู ุงูุชุญููู...</div>
                        </div>
                    </div>
                    <div class="card-gradient shape-cut p-5 shadow-lg accent-emerald">
                        <h3 class="text-lg font-bold text-slate-800 mb-3">๐ ุชูุจููุงุช ุงููุฎุงุทุฑ</h3>
                        <div id="aiRiskNotes" class="text-sm text-slate-600 space-y-2">
                            <div class="animate-pulse">ุฌุงุฑู ุงูุชุญููู...</div>
                        </div>
                    </div>
                    <div class="card-gradient shape-pill p-5 shadow-lg accent-sky">
                        <h3 class="text-lg font-bold text-slate-800 mb-3">๐ ุชูุตูุงุช ุชุดุบูููุฉ</h3>
                        <div id="aiActions" class="text-sm text-slate-600 space-y-2">
                            <div class="animate-pulse">ุฌุงุฑู ุงูุชุญููู...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="modalOverlay" class="fixed inset-0 bg-slate-900/60 hidden items-center justify-center p-4 z-50">
        <div class="bg-white w-full max-w-2xl rounded-3xl shadow-2xl p-6">
            <div class="flex items-center justify-between mb-4">
                <h3 id="modalTitle" class="text-xl font-bold text-slate-800"></h3>
                <button onclick="closeModal()" class="text-slate-500 hover:text-slate-700">
                    <i class="fas fa-xmark text-xl"></i>
                </button>
            </div>
            <div id="modalBody" class="space-y-3 text-sm text-slate-700"></div>
            <div id="modalActions" class="flex flex-wrap gap-3 justify-end mt-6"></div>
        </div>
    </div>

    <script>
        const API_BASE = window.location.origin;
        const ENTITY_ID = '1';
        const AR_ENTITY_ID = 'HQ001';
        const CONTEXT_HEADERS = window.getFinanceHeaders ? window.getFinanceHeaders() : {};

        let store = {
            invoices: [],
            payments: [],
            risks: [],
            forecasts: [],
            customers: [],
            cashflow: null,
            arAging: []
        };

        let branchChart = null;
        let riskChart = null;
        let forecastChart = null;
        let cashflowChart = null;

        async function loadData() {
            try {
                const [invoiceRes, paymentRes, riskRes, forecastRes, customerRes, cashflowRes, arRes] = await Promise.all([
                    fetch(`${API_BASE}/finance/invoices`, { headers: CONTEXT_HEADERS }),
                    fetch(`${API_BASE}/finance/payments`, { headers: CONTEXT_HEADERS }),
                    fetch(`${API_BASE}/finance/ai-risk-scores?entity_id=${ENTITY_ID}`, { headers: CONTEXT_HEADERS }),
                    fetch(`${API_BASE}/finance/ai-forecasts?entity_id=${ENTITY_ID}`, { headers: CONTEXT_HEADERS }),
                    fetch(`${API_BASE}/finance/customers?entity_id=${ENTITY_ID}`, { headers: CONTEXT_HEADERS }),
                    fetch(`${API_BASE}/finance/cashflow/overview?entity_id=${ENTITY_ID}`, { headers: CONTEXT_HEADERS }),
                    fetch(`${API_BASE}/finance/ar-aging?entity_id=${AR_ENTITY_ID}`, { headers: CONTEXT_HEADERS })
                ]);

                const [invoiceData, paymentData, riskData, forecastData, customerData, cashflowData, arData] = await Promise.all([
                    safeJson(invoiceRes),
                    safeJson(paymentRes),
                    safeJson(riskRes),
                    safeJson(forecastRes),
                    safeJson(customerRes),
                    safeJson(cashflowRes),
                    safeJson(arRes)
                ]);

                store.invoices = invoiceData.invoices || [];
                store.payments = paymentData.payments || [];
                store.risks = riskData.rows || [];
                store.forecasts = forecastData.forecasts || [];
                store.customers = customerData.customers || customerData.rows || [];
                store.cashflow = cashflowData;
                store.arAging = arData.rows || [];

                renderStats();
                renderTables();
                renderCharts();
                renderInsights();
                updateLastUpdated();
            } catch (error) {
                console.error('ุฎุทุฃ ูู ุชุญููู ุงูุจูุงูุงุช:', error);
            }
        }

        function renderStats() {
            const totalRevenue = sum(store.invoices, 'total_amount');
            const overdueInvoices = store.invoices.filter(i => String(i.status || '').toUpperCase() === 'OVERDUE');
            const overdueAmount = sum(overdueInvoices, 'remaining_amount');
            const netCashflow = store.cashflow?.total_net_cashflow || 0;
            const forecastSorted = [...store.forecasts].sort((a, b) => new Date(a.created_at) - new Date(b.created_at));
            const forecast90 = forecastSorted.slice(0, 3).reduce((sumValue, f) => sumValue + parseFloat(f.forecast_amount || 0), 0);

            document.getElementById('totalRevenue').textContent = formatMoney(totalRevenue);
            document.getElementById('netCashflow').textContent = formatMoney(netCashflow);
            document.getElementById('overdueAmount').textContent = formatMoney(overdueAmount);
            document.getElementById('forecast90').textContent = formatMoney(forecast90);
        }

        function renderTables() {
            const branchInvoices = store.invoices
                .filter(i => i.branch_id)
                .sort((a, b) => parseFloat(b.total_amount || 0) - parseFloat(a.total_amount || 0))
                .slice(0, 50);
            const branchRows = branchInvoices.map(inv => `
                <tr class="hover:bg-sky-50">
                    <td class="px-3 py-2">${sanitizeText(inv.branch_id)}</td>
                    <td class="px-3 py-2">${sanitizeText(inv.invoice_number)}</td>
                    <td class="px-3 py-2 font-semibold text-emerald-700">${formatMoney(inv.total_amount)}</td>
                    <td class="px-3 py-2">${translateInvoiceStatus(inv.status)}</td>
                    <td class="px-3 py-2">
                        ${renderInvoiceActions(inv)}
                    </td>
                </tr>
            `).join('');
            document.getElementById('branchRevenueTable').innerHTML = branchRows || `<tr><td colspan="5" class="px-4 py-8 text-center text-slate-500">ูุง ุชูุฌุฏ ุจูุงูุงุช</td></tr>`;
            document.getElementById('branchRevenueCount').textContent = `ุนุฏุฏ ุงูุตููู: ${branchInvoices.length}`;

            const programInvoices = store.invoices
                .filter(i => i.program_id)
                .sort((a, b) => parseFloat(b.total_amount || 0) - parseFloat(a.total_amount || 0))
                .slice(0, 50);
            const programRows = programInvoices.map(inv => `
                <tr class="hover:bg-emerald-50">
                    <td class="px-3 py-2">${formatProgram(inv.program_id)}</td>
                    <td class="px-3 py-2">${sanitizeText(inv.invoice_number)}</td>
                    <td class="px-3 py-2 font-semibold text-emerald-700">${formatMoney(inv.total_amount)}</td>
                    <td class="px-3 py-2">${translateInvoiceStatus(inv.status)}</td>
                    <td class="px-3 py-2">
                        ${renderInvoiceActions(inv)}
                    </td>
                </tr>
            `).join('');
            document.getElementById('programRevenueTable').innerHTML = programRows || `<tr><td colspan="5" class="px-4 py-8 text-center text-slate-500">ูุง ุชูุฌุฏ ุจูุงูุงุช</td></tr>`;
            document.getElementById('programRevenueCount').textContent = `ุนุฏุฏ ุงูุตููู: ${programInvoices.length}`;

            const overdueInvoices = store.invoices.filter(i => String(i.status || '').toUpperCase() === 'OVERDUE');
            const overdueRows = overdueInvoices.map(inv => `
                <tr class="hover:bg-rose-50">
                    <td class="px-3 py-2">${sanitizeText(inv.invoice_number)}</td>
                    <td class="px-3 py-2">${sanitizeText(inv.customer_name_ar || inv.customer_name)}</td>
                    <td class="px-3 py-2">${formatDate(inv.invoice_date)}</td>
                    <td class="px-3 py-2 font-semibold text-rose-700">${formatMoney(inv.remaining_amount)}</td>
                    <td class="px-3 py-2">${sanitizeText(inv.branch_id)}</td>
                    <td class="px-3 py-2">${formatProgram(inv.program_id)}</td>
                    <td class="px-3 py-2">${renderInvoiceActions(inv)}</td>
                </tr>
            `).join('');
            document.getElementById('overdueTable').innerHTML = overdueRows || `<tr><td colspan="7" class="px-4 py-8 text-center text-slate-500">ูุง ุชูุฌุฏ ุจูุงูุงุช</td></tr>`;
            document.getElementById('overdueCount').textContent = `ุนุฏุฏ ุงูุตููู: ${overdueInvoices.length}`;

            const topRiskCustomers = [...store.risks].sort((a, b) => parseFloat(b.risk_score || 0) - parseFloat(a.risk_score || 0)).slice(0, 20);
            const riskRows = topRiskCustomers.map(r => `
                <tr class="hover:bg-indigo-50">
                    <td class="px-3 py-2">${formatCustomerLabel(r.customer_id)}</td>
                    <td class="px-3 py-2">${formatPercent(r.risk_score)}</td>
                    <td class="px-3 py-2">${translateRiskLevel(r.risk_level)}</td>
                    <td class="px-3 py-2">${formatDate(r.assessment_date)}</td>
                    <td class="px-3 py-2">${renderRiskActions(r)}</td>
                </tr>
            `).join('');
            document.getElementById('topRiskCustomersTable').innerHTML = riskRows || `<tr><td colspan="5" class="px-4 py-8 text-center text-slate-500">ูุง ุชูุฌุฏ ุจูุงูุงุช</td></tr>`;

            const forecastRows = [...store.forecasts]
                .sort((a, b) => new Date(b.created_at) - new Date(a.created_at))
                .slice(0, 20)
                .map(f => `
                    <tr class="hover:bg-indigo-50">
                        <td class="px-3 py-2">${sanitizeText(f.forecast_period)}</td>
                        <td class="px-3 py-2">${sanitizeText(f.forecast_type)}</td>
                        <td class="px-3 py-2 font-semibold text-emerald-700">${formatMoney(f.forecast_amount)}</td>
                        <td class="px-3 py-2">${formatConfidence(f.confidence_level)}</td>
                        <td class="px-3 py-2">${renderForecastActions(f)}</td>
                    </tr>
                `).join('');
            document.getElementById('forecastTable').innerHTML = forecastRows || `<tr><td colspan="5" class="px-4 py-8 text-center text-slate-500">ูุง ุชูุฌุฏ ุจูุงูุงุช</td></tr>`;

            document.getElementById('riskRadarCount').textContent = `ุชููููุงุช ุงููุฎุงุทุฑ: ${topRiskCustomers.length} | ุงูุชููุนุงุช: ${store.forecasts.length}`;
        }

        function renderCharts() {
            const branchGroups = groupSum(store.invoices, 'branch_id', 'total_amount');
            const branchLabels = Object.keys(branchGroups).map(sanitizeText);
            const branchValues = Object.values(branchGroups);

            const branchCtx = document.getElementById('branchRevenueChart').getContext('2d');
            if (branchChart) branchChart.destroy();
            branchChart = new Chart(branchCtx, {
                type: 'bar',
                data: {
                    labels: branchLabels.length ? branchLabels : ['ูุง ุชูุฌุฏ ุจูุงูุงุช'],
                    datasets: [{
                        label: 'ุงูุฅูุฑุงุฏุงุช',
                        data: branchValues.length ? branchValues : [0],
                        backgroundColor: '#0ea5e9'
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });

            const riskCounts = store.risks.reduce((acc, r) => {
                const level = translateRiskLevel(r.risk_level) || 'ุบูุฑ ูุญุฏุฏ';
                acc[level] = (acc[level] || 0) + 1;
                return acc;
            }, {});
            const riskCtx = document.getElementById('riskLevelChart').getContext('2d');
            if (riskChart) riskChart.destroy();
            riskChart = new Chart(riskCtx, {
                type: 'bar',
                data: {
                    labels: Object.keys(riskCounts).length ? Object.keys(riskCounts) : ['ูุง ุชูุฌุฏ ุจูุงูุงุช'],
                    datasets: [{
                        data: Object.values(riskCounts).length ? Object.values(riskCounts) : [0],
                        backgroundColor: ['#ef4444', '#f59e0b', '#10b981', '#6366f1']
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
            });

            const forecastSorted = [...store.forecasts].sort((a, b) => new Date(a.created_at) - new Date(b.created_at));
            const forecastLabels = forecastSorted.map(f => sanitizeText(f.forecast_period) || formatDate(f.created_at));
            const forecastValues = forecastSorted.map(f => parseFloat(f.forecast_amount || 0));
            const forecastCtx = document.getElementById('forecastChart').getContext('2d');
            if (forecastChart) forecastChart.destroy();
            forecastChart = new Chart(forecastCtx, {
                type: 'line',
                data: {
                    labels: forecastLabels.length ? forecastLabels : ['ูุง ุชูุฌุฏ ุจูุงูุงุช'],
                    datasets: [{
                        label: 'ูููุฉ ุงูุชููุน',
                        data: forecastValues.length ? forecastValues : [0],
                        borderColor: '#f59e0b',
                        backgroundColor: 'rgba(245, 158, 11, 0.2)',
                        tension: 0.35
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });

            const cashflowCtx = document.getElementById('cashflowChart').getContext('2d');
            if (cashflowChart) cashflowChart.destroy();
            const inflow = store.cashflow?.operating?.inflow || 0;
            const outflow = Math.abs(store.cashflow?.operating?.outflow || 0);
            const net = store.cashflow?.total_net_cashflow || 0;
            cashflowChart = new Chart(cashflowCtx, {
                type: 'doughnut',
                data: {
                    labels: ['ุชุฏูู ุฏุงุฎู', 'ุชุฏูู ุฎุงุฑุฌ', 'ุตุงูู'],
                    datasets: [{
                        data: [inflow, outflow, net],
                        backgroundColor: ['#0ea5e9', '#ef4444', '#10b981']
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });
        }

        function renderInsights() {
            const forecastSorted = [...store.forecasts].sort((a, b) => new Date(a.created_at) - new Date(b.created_at));
            const nextForecast = forecastSorted[0];
            const riskTop = store.risks.sort((a, b) => parseFloat(b.risk_score || 0) - parseFloat(a.risk_score || 0))[0];
            const overdueInvoices = store.invoices.filter(i => String(i.status || '').toUpperCase() === 'OVERDUE');

            document.getElementById('aiSummary').innerHTML = `
                <div class="bg-slate-50 p-3 rounded-xl">ุฅุฌูุงูู ุงูุฅูุฑุงุฏุงุช: ${formatMoney(sum(store.invoices, 'total_amount'))}</div>
                <div class="bg-slate-50 p-3 rounded-xl">ุตุงูู ุงูุชุฏูู ุงูููุฏู: ${formatMoney(store.cashflow?.total_net_cashflow || 0)}</div>
                <div class="bg-slate-50 p-3 rounded-xl">ุชููุน ุฃูุฑุจ ูุชุฑุฉ: ${nextForecast ? formatMoney(nextForecast.forecast_amount) : 'ูุง ุชูุฌุฏ ุจูุงูุงุช'}</div>
            `;

            document.getElementById('aiRiskNotes').innerHTML = `
                <div class="bg-slate-50 p-3 rounded-xl">ุฃุนูู ุนููู ูุฎุงุทุฑุฉ: ${riskTop ? sanitizeText(riskTop.customer_id) : 'ูุง ุชูุฌุฏ ุจูุงูุงุช'}</div>
                <div class="bg-slate-50 p-3 rounded-xl">ูุณุจุฉ ุงูููุงุชูุฑ ุงููุชุฃุฎุฑุฉ: ${store.invoices.length ? ((overdueInvoices.length / store.invoices.length) * 100).toFixed(1) + '%' : '0%'} </div>
                <div class="bg-slate-50 p-3 rounded-xl">ุชููุน ุงูุชุนุซุฑ 90 ููููุง ูุนุชูุฏ ุนูู ูุชูุณุท ุฏุฑุฌุงุช ุงููุฎุงุทุฑ</div>
            `;

            document.getElementById('aiActions').innerHTML = `
                <div class="bg-slate-50 p-3 rounded-xl">ุฑูุน ูุชุงุจุนุฉ ุงูุชุญุตูู ููููุงุชูุฑ ุงููุชุฃุฎุฑุฉ ุฐุงุช ุงููุจุงูุบ ุงููุจูุฑุฉ.</div>
                <div class="bg-slate-50 p-3 rounded-xl">ูุฑุงุฌุนุฉ ุณูุงุณุงุช ุงูุฎุตู ููุจุฑุงูุฌ ุนุงููุฉ ุงููุฎุงุทุฑ.</div>
                <div class="bg-slate-50 p-3 rounded-xl">ุชุญุณูู ุฌูุฏุฉ ุงูุจูุงูุงุช ูุถูุงู ุฏูุฉ ุงูุชููุนุงุช.</div>
            `;
        }

        function switchTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.querySelector(`[onclick="switchTab('${tab}')"]`).classList.add('active');
            document.getElementById(`tab-${tab}`).classList.remove('hidden');
        }

        function translateRiskLevel(value) {
            const map = { HIGH: 'ูุฑุชูุน', MEDIUM: 'ูุชูุณุท', LOW: 'ููุฎูุถ', CRITICAL: 'ุญุฑุฌ' };
            return map[String(value || '').toUpperCase()] || 'ุบูุฑ ูุญุฏุฏ';
        }

        function translateInvoiceStatus(value) {
            const map = { ISSUED: 'ูุตุฏุฑุฉ', PARTIAL: 'ูุฏููุนุฉ ุฌุฒุฆูุงู', PAID: 'ูุฏููุนุฉ', OVERDUE: 'ูุชุฃุฎุฑุฉ', DRAFT: 'ูุณูุฏุฉ', CANCELLED: 'ููุบุงุฉ' };
            return map[String(value || '').toUpperCase()] || 'ุบูุฑ ูุญุฏุฏ';
        }

        function translatePaymentStatus(value) {
            const map = { UNPAID: 'ุบูุฑ ูุฏููุนุฉ', PARTIAL: 'ูุฏููุนุฉ ุฌุฒุฆูุงู', PAID: 'ูุฏููุนุฉ' };
            return map[String(value || '').toUpperCase()] || 'ุบูุฑ ูุญุฏุฏ';
        }

        function formatMoney(value) {
            const num = parseFloat(value || 0);
            return num.toLocaleString('ar-SA') + ' ุฑ.ุณ';
        }

        function formatDate(value) {
            if (!value) return '-';
            return new Date(value).toLocaleDateString('ar-SA');
        }

        function formatPercent(value) {
            if (value === null || value === undefined || value === '') return '-';
            const num = parseFloat(value || 0);
            return `${num.toFixed(1)}%`;
        }

        function sanitizeText(value) {
            if (value === null || value === undefined) return 'ุบูุฑ ูุญุฏุฏ';
            const text = typeof value === 'string' ? value : JSON.stringify(value);
            const cleaned = text.replace(/[<>]/g, '').replace(/\s{2,}/g, ' ').trim();
            return cleaned || 'ุบูุฑ ูุญุฏุฏ';
        }

        function formatProgram(value) {
            if (value === null || value === undefined || value === '') return 'ุบูุฑ ูุญุฏุฏ';
            return `ุจุฑูุงูุฌ ุฑูู ${String(value)}`;
        }

        function formatCustomerLabel(value) {
            if (value === null || value === undefined || value === '') return 'ุบูุฑ ูุญุฏุฏ';
            return `ุนููู ุฑูู ${String(value)}`;
        }

        function formatConfidence(value) {
            if (value === null || value === undefined || value === '') return '-';
            const num = parseFloat(value || 0);
            if (num <= 1) return `${(num * 100).toFixed(1)}%`;
            return `${num.toFixed(1)}%`;
        }

        function sum(rows, key) {
            return rows.reduce((acc, row) => acc + parseFloat(row[key] || 0), 0);
        }

        function groupSum(rows, key, valueKey) {
            return rows.reduce((acc, row) => {
                const label = row[key] ?? 'ุบูุฑ ูุญุฏุฏ';
                acc[label] = (acc[label] || 0) + parseFloat(row[valueKey] || 0);
                return acc;
            }, {});
        }

        function groupRisk(rows, key) {
            const grouped = rows.reduce((acc, row) => {
                const label = row[key] ?? 'ุบูุฑ ูุญุฏุฏ';
                if (!acc[label]) acc[label] = { count: 0, score: 0 };
                acc[label].count += 1;
                acc[label].score += String(row.status || '').toUpperCase() === 'OVERDUE' ? 1 : 0.2;
                return acc;
            }, {});
            return Object.entries(grouped).map(([k, v]) => ({ key: k, count: v.count, score: (v.score / v.count) * 100 }))
                .sort((a, b) => b.score - a.score);
        }

        function downloadAllJSON() {
            const payload = {
                invoices: store.invoices,
                payments: store.payments,
                risks: store.risks,
                forecasts: store.forecasts,
                customers: store.customers,
                cashflow: store.cashflow,
                ar_aging: store.arAging
            };
            downloadBlob(JSON.stringify(payload, null, 2), 'ุงูุชูุงุฑูุฑ-ุงูุงุณุชุฑุงุชูุฌูุฉ-ูุงูุฐูุงุก-ุงููุงูู.json', 'application/json');
        }

        function downloadAllCSV() {
            const rows = [];
            rows.push(['ููุงุชูุฑ ุญุณุจ ุงููุฑูุน']);
            rows.push(['ุงููุฑุน','ุฑูู ุงููุงุชูุฑุฉ','ูููุฉ ุงููุงุชูุฑุฉ','ุงูุญุงูุฉ']);
            store.invoices.filter(i => i.branch_id).forEach(inv => {
                rows.push([sanitizeText(inv.branch_id), sanitizeText(inv.invoice_number), inv.total_amount, translateInvoiceStatus(inv.status)]);
            });

            rows.push([]);
            rows.push(['ููุงุชูุฑ ุญุณุจ ุงูุจุฑุงูุฌ']);
            rows.push(['ุงูุจุฑูุงูุฌ','ุฑูู ุงููุงุชูุฑุฉ','ูููุฉ ุงููุงุชูุฑุฉ','ุงูุญุงูุฉ']);
            store.invoices.filter(i => i.program_id).forEach(inv => {
                rows.push([formatProgram(inv.program_id), sanitizeText(inv.invoice_number), inv.total_amount, translateInvoiceStatus(inv.status)]);
            });

            rows.push([]);
            rows.push(['ุงูููุงุชูุฑ ุงููุชุฃุฎุฑุฉ']);
            rows.push(['ุฑูู ุงููุงุชูุฑุฉ','ุงุณู ุงูุนููู','ุชุงุฑูุฎ ุงููุงุชูุฑุฉ','ุงููุชุจูู','ุงููุฑุน','ุงูุจุฑูุงูุฌ']);
            store.invoices.filter(i => String(i.status || '').toUpperCase() === 'OVERDUE').forEach(inv => {
                rows.push([
                    sanitizeText(inv.invoice_number), sanitizeText(inv.customer_name_ar || inv.customer_name), inv.invoice_date,
                    inv.remaining_amount, inv.branch_id, inv.program_id
                ]);
            });

            rows.push([]);
            rows.push(['ุชููููุงุช ุงููุฎุงุทุฑ']);
            rows.push(['ุนููู ูุฎุงุทุฑุฉ','ุฏุฑุฌุฉ ุงููุฎุงุทุฑุฉ','ุงููุณุชูู','ุงูุชุงุฑูุฎ']);
            [...store.risks].sort((a, b) => parseFloat(b.risk_score || 0) - parseFloat(a.risk_score || 0)).slice(0, 20)
                .forEach(r => rows.push([formatCustomerLabel(r.customer_id), r.risk_score, translateRiskLevel(r.risk_level), r.assessment_date]));

            rows.push([]);
            rows.push(['ุงูุชููุนุงุช ุงูุฐููุฉ']);
            rows.push(['ูุชุฑุฉ ุงูุชููุน','ููุน ุงูุชููุน','ูููุฉ ุงูุชููุน','ุงูุซูุฉ']);
            store.forecasts.forEach(f => rows.push([sanitizeText(f.forecast_period), sanitizeText(f.forecast_type), f.forecast_amount, f.confidence_level]));

            const csv = rows.map(r => r.map(v => `"${v ?? ''}"`).join(',')).join('\n');
            downloadBlob(csv, 'ุงูุชูุงุฑูุฑ-ุงูุงุณุชุฑุงุชูุฌูุฉ-ูุงูุฐูุงุก-ุงููุงูู.csv', 'text/csv;charset=utf-8;');
        }

        function downloadBlob(content, filename, type) {
            const blob = new Blob([content], { type });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            link.click();
            URL.revokeObjectURL(url);
        }

        function copySummary() {
            const summary = `ููุฎุต ุงูุชูุงุฑูุฑ ุงูุงุณุชุฑุงุชูุฌูุฉ\n` +
                `ุฅูุฑุงุฏุงุช ูุฌูุนุฉ: ${formatMoney(sum(store.invoices, 'total_amount'))}\n` +
                `ุตุงูู ุงูุชุฏูู: ${formatMoney(store.cashflow?.total_net_cashflow || 0)}\n` +
                `ุงูููุงุชูุฑ ุงููุชุฃุฎุฑุฉ: ${store.invoices.filter(i => String(i.status || '').toUpperCase() === 'OVERDUE').length}\n` +
                `ุชููุนุงุช 90 ููู: ${formatMoney([...store.forecasts].slice(0, 3).reduce((a, b) => a + parseFloat(b.forecast_amount || 0), 0))}`;
            navigator.clipboard.writeText(summary).catch(() => {});
        }

        function printPage() {
            window.print();
        }

        function refreshData() {
            loadData();
        }

        function updateLastUpdated() {
            const now = new Date();
            const formatted = now.toLocaleString('ar-SA');
            const el = document.getElementById('lastUpdated');
            if (el) el.textContent = `ุขุฎุฑ ุชุญุฏูุซ: ${formatted}`;
        }

        async function safeJson(res) {
            try {
                if (!res.ok) {
                    console.warn('ุทูุจ ุบูุฑ ูุงุฌุญ:', res.status);
                }
                return await res.json();
            } catch (error) {
                return {};
            }
        }

        function escapeHtml(value) {
            return String(value ?? '')
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
        }

        function openModal(title, bodyHtml, actionsHtml) {
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalBody').innerHTML = bodyHtml;
            document.getElementById('modalActions').innerHTML = actionsHtml || '';
            const overlay = document.getElementById('modalOverlay');
            overlay.classList.remove('hidden');
            overlay.classList.add('flex');
        }

        function closeModal() {
            const overlay = document.getElementById('modalOverlay');
            overlay.classList.add('hidden');
            overlay.classList.remove('flex');
        }

        function renderInvoiceActions(inv) {
            return `
                <div class="flex flex-wrap gap-2">
                    <button onclick="openInvoiceView(${inv.invoice_id})" class="px-3 py-1 rounded-full bg-slate-100 text-slate-700 hover:bg-slate-200">ูุนุงููุฉ</button>
                    <button onclick="openInvoiceEdit(${inv.invoice_id})" class="px-3 py-1 rounded-full bg-amber-100 text-amber-700 hover:bg-amber-200">ุชุนุฏูู</button>
                    <button onclick="deleteInvoice(${inv.invoice_id})" class="px-3 py-1 rounded-full bg-rose-100 text-rose-700 hover:bg-rose-200">ุญุฐู</button>
                </div>
            `;
        }

        function renderRiskActions(risk) {
            return `
                <div class="flex flex-wrap gap-2">
                    <button onclick="openRiskView(${risk.risk_id})" class="px-3 py-1 rounded-full bg-slate-100 text-slate-700 hover:bg-slate-200">ูุนุงููุฉ</button>
                    <button onclick="openRiskEdit(${risk.risk_id})" class="px-3 py-1 rounded-full bg-amber-100 text-amber-700 hover:bg-amber-200">ุชุนุฏูู</button>
                    <button onclick="deleteRisk(${risk.risk_id})" class="px-3 py-1 rounded-full bg-rose-100 text-rose-700 hover:bg-rose-200">ุญุฐู</button>
                </div>
            `;
        }

        function renderForecastActions(forecast) {
            return `
                <div class="flex flex-wrap gap-2">
                    <button onclick="openForecastView(${forecast.forecast_id})" class="px-3 py-1 rounded-full bg-slate-100 text-slate-700 hover:bg-slate-200">ูุนุงููุฉ</button>
                    <button onclick="openForecastEdit(${forecast.forecast_id})" class="px-3 py-1 rounded-full bg-amber-100 text-amber-700 hover:bg-amber-200">ุชุนุฏูู</button>
                    <button onclick="deleteForecast(${forecast.forecast_id})" class="px-3 py-1 rounded-full bg-rose-100 text-rose-700 hover:bg-rose-200">ุญุฐู</button>
                </div>
            `;
        }

        function openInvoiceView(invoiceId) {
            const inv = store.invoices.find(i => String(i.invoice_id) === String(invoiceId));
            if (!inv) return;
            const body = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                    <div class="bg-slate-50 p-3 rounded-xl">ุฑูู ุงููุงุชูุฑุฉ: ${sanitizeText(inv.invoice_number)}</div>
                    <div class="bg-slate-50 p-3 rounded-xl">ุงูุนููู: ${sanitizeText(inv.customer_name_ar || inv.customer_name)}</div>
                    <div class="bg-slate-50 p-3 rounded-xl">ูููุฉ ุงููุงุชูุฑุฉ: ${formatMoney(inv.total_amount)}</div>
                    <div class="bg-slate-50 p-3 rounded-xl">ุงููุชุจูู: ${formatMoney(inv.remaining_amount)}</div>
                    <div class="bg-slate-50 p-3 rounded-xl">ุงูุญุงูุฉ: ${translateInvoiceStatus(inv.status)}</div>
                    <div class="bg-slate-50 p-3 rounded-xl">ุญุงูุฉ ุงูุณุฏุงุฏ: ${translatePaymentStatus(inv.payment_status)}</div>
                    <div class="bg-slate-50 p-3 rounded-xl">ุชุงุฑูุฎ ุงููุงุชูุฑุฉ: ${formatDate(inv.invoice_date)}</div>
                    <div class="bg-slate-50 p-3 rounded-xl">ุชุงุฑูุฎ ุงูุงุณุชุญูุงู: ${formatDate(inv.due_date)}</div>
                </div>
            `;
            openModal('ูุนุงููุฉ ุงููุงุชูุฑุฉ', body, `<button onclick="closeModal()" class="px-4 py-2 rounded-full bg-slate-200">ุฅุบูุงู</button>`);
        }

        function openInvoiceEdit(invoiceId) {
            const inv = store.invoices.find(i => String(i.invoice_id) === String(invoiceId));
            if (!inv) return;
            const body = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="text-xs text-slate-500">ุชุงุฑูุฎ ุงููุงุชูุฑุฉ</label>
                        <input id="editInvoiceDate" type="date" class="w-full border rounded-xl p-2" value="${escapeHtml(inv.invoice_date || '')}">
                    </div>
                    <div>
                        <label class="text-xs text-slate-500">ุชุงุฑูุฎ ุงูุงุณุชุญูุงู</label>
                        <input id="editInvoiceDue" type="date" class="w-full border rounded-xl p-2" value="${escapeHtml(inv.due_date || '')}">
                    </div>
                    <div>
                        <label class="text-xs text-slate-500">ุงูุญุงูุฉ</label>
                        <select id="editInvoiceStatus" class="w-full border rounded-xl p-2">
                            ${renderOptions(['ISSUED','PARTIAL','PAID','OVERDUE','DRAFT','CANCELLED'], inv.status)}
                        </select>
                    </div>
                    <div>
                        <label class="text-xs text-slate-500">ุญุงูุฉ ุงูุณุฏุงุฏ</label>
                        <select id="editPaymentStatus" class="w-full border rounded-xl p-2">
                            ${renderOptions(['UNPAID','PARTIAL','PAID'], inv.payment_status)}
                        </select>
                    </div>
                    <div>
                        <label class="text-xs text-slate-500">ุงููุฑุน</label>
                        <input id="editBranch" type="text" class="w-full border rounded-xl p-2" value="${escapeHtml(inv.branch_id || '')}">
                    </div>
                    <div>
                        <label class="text-xs text-slate-500">ุงูุจุฑูุงูุฌ</label>
                        <input id="editProgram" type="number" class="w-full border rounded-xl p-2" value="${escapeHtml(inv.program_id || '')}">
                    </div>
                    <div class="md:col-span-2">
                        <label class="text-xs text-slate-500">ููุงุญุธุงุช</label>
                        <textarea id="editNotes" class="w-full border rounded-xl p-2" rows="2">${escapeHtml(inv.notes || '')}</textarea>
                    </div>
                </div>
            `;
            const actions = `
                <button onclick="saveInvoiceEdit(${inv.invoice_id})" class="px-4 py-2 rounded-full bg-emerald-600 text-white">ุญูุธ ุงูุชุนุฏููุงุช</button>
                <button onclick="closeModal()" class="px-4 py-2 rounded-full bg-slate-200">ุฅูุบุงุก</button>
            `;
            openModal('ุชุนุฏูู ุงููุงุชูุฑุฉ', body, actions);
        }

        async function saveInvoiceEdit(invoiceId) {
            const payload = {
                invoice_date: document.getElementById('editInvoiceDate').value || null,
                due_date: document.getElementById('editInvoiceDue').value || null,
                status: document.getElementById('editInvoiceStatus').value || null,
                payment_status: document.getElementById('editPaymentStatus').value || null,
                branch_id: document.getElementById('editBranch').value || null,
                program_id: document.getElementById('editProgram').value || null,
                notes: document.getElementById('editNotes').value || null
            };

            const res = await fetch(`${API_BASE}/finance/invoices/${invoiceId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json', ...CONTEXT_HEADERS },
                body: JSON.stringify(payload)
            });
            const data = await safeJson(res);
            if (!res.ok) {
                alert(`ุชุนุฐุฑ ุญูุธ ุงูุชุนุฏููุงุช: ${data.error || 'ุฎุทุฃ ุบูุฑ ูุนุฑูู'}`);
                return;
            }
            closeModal();
            await loadData();
        }

        async function deleteInvoice(invoiceId) {
            if (!confirm('ูู ุชุฑูุฏ ุญุฐู ุงููุงุชูุฑุฉุ')) return;
            const res = await fetch(`${API_BASE}/finance/invoices/${invoiceId}`, {
                method: 'DELETE',
                headers: CONTEXT_HEADERS
            });
            const data = await safeJson(res);
            if (!res.ok) {
                alert(`ุชุนุฐุฑ ุญุฐู ุงููุงุชูุฑุฉ: ${data.error || 'ุฎุทุฃ ุบูุฑ ูุนุฑูู'}`);
                return;
            }
            await loadData();
        }

        function openRiskView(riskId) {
            const risk = store.risks.find(r => String(r.risk_id) === String(riskId));
            if (!risk) return;
            const body = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                    <div class="bg-slate-50 p-3 rounded-xl">ุงูุนููู: ${formatCustomerLabel(risk.customer_id)}</div>
                    <div class="bg-slate-50 p-3 rounded-xl">ุงูุชุงุฑูุฎ: ${formatDate(risk.assessment_date)}</div>
                    <div class="bg-slate-50 p-3 rounded-xl">ุงูุฏุฑุฌุฉ: ${formatPercent(risk.risk_score)}</div>
                    <div class="bg-slate-50 p-3 rounded-xl">ุงููุณุชูู: ${translateRiskLevel(risk.risk_level)}</div>
                    <div class="bg-slate-50 p-3 rounded-xl md:col-span-2">ุงูุชูุตูุงุช: ${sanitizeText(risk.recommendations || 'ูุง ุชูุฌุฏ')}</div>
                </div>
            `;
            openModal('ูุนุงููุฉ ุชูููู ุงููุฎุงุทุฑ', body, `<button onclick="closeModal()" class="px-4 py-2 rounded-full bg-slate-200">ุฅุบูุงู</button>`);
        }

        function openRiskEdit(riskId) {
            const risk = store.risks.find(r => String(r.risk_id) === String(riskId));
            if (!risk) return;
            const body = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="text-xs text-slate-500">ุงูุนููู</label>
                        <input id="editRiskCustomer" type="number" class="w-full border rounded-xl p-2" value="${escapeHtml(risk.customer_id)}" readonly>
                    </div>
                    <div>
                        <label class="text-xs text-slate-500">ุชุงุฑูุฎ ุงูุชูููู</label>
                        <input id="editRiskDate" type="date" class="w-full border rounded-xl p-2" value="${escapeHtml(risk.assessment_date || '')}">
                    </div>
                    <div>
                        <label class="text-xs text-slate-500">ุฏุฑุฌุฉ ุงููุฎุงุทุฑุฉ</label>
                        <input id="editRiskScore" type="number" class="w-full border rounded-xl p-2" value="${escapeHtml(risk.risk_score)}">
                    </div>
                    <div>
                        <label class="text-xs text-slate-500">ุงููุณุชูู</label>
                        <select id="editRiskLevel" class="w-full border rounded-xl p-2">
                            ${renderOptions(['LOW','MEDIUM','HIGH','CRITICAL'], risk.risk_level)}
                        </select>
                    </div>
                    <div class="md:col-span-2">
                        <label class="text-xs text-slate-500">ุงูุชูุตูุงุช</label>
                        <textarea id="editRiskNotes" class="w-full border rounded-xl p-2" rows="2">${escapeHtml(risk.recommendations || '')}</textarea>
                    </div>
                </div>
            `;
            const actions = `
                <button onclick="saveRiskEdit(${risk.risk_id})" class="px-4 py-2 rounded-full bg-emerald-600 text-white">ุญูุธ ุงูุชุนุฏููุงุช</button>
                <button onclick="closeModal()" class="px-4 py-2 rounded-full bg-slate-200">ุฅูุบุงุก</button>
            `;
            openModal('ุชุนุฏูู ุชูููู ุงููุฎุงุทุฑ', body, actions);
        }

        async function saveRiskEdit(riskId) {
            const payload = {
                entity_id: ENTITY_ID,
                customer_id: document.getElementById('editRiskCustomer').value,
                assessment_date: document.getElementById('editRiskDate').value,
                risk_score: document.getElementById('editRiskScore').value,
                risk_level: document.getElementById('editRiskLevel').value,
                recommendations: document.getElementById('editRiskNotes').value
            };

            const res = await fetch(`${API_BASE}/finance/ai-risk-scores/${riskId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json', ...CONTEXT_HEADERS },
                body: JSON.stringify(payload)
            });
            const data = await safeJson(res);
            if (!res.ok) {
                alert(`ุชุนุฐุฑ ุญูุธ ุงูุชุนุฏููุงุช: ${data.error || 'ุฎุทุฃ ุบูุฑ ูุนุฑูู'}`);
                return;
            }
            closeModal();
            await loadData();
        }

        async function deleteRisk(riskId) {
            if (!confirm('ูู ุชุฑูุฏ ุญุฐู ุชูููู ุงููุฎุงุทุฑุ')) return;
            const res = await fetch(`${API_BASE}/finance/ai-risk-scores/${riskId}?entity_id=${ENTITY_ID}`, {
                method: 'DELETE',
                headers: CONTEXT_HEADERS
            });
            const data = await safeJson(res);
            if (!res.ok) {
                alert(`ุชุนุฐุฑ ุญุฐู ุชูููู ุงููุฎุงุทุฑ: ${data.error || 'ุฎุทุฃ ุบูุฑ ูุนุฑูู'}`);
                return;
            }
            await loadData();
        }

        function openForecastView(forecastId) {
            const forecast = store.forecasts.find(f => String(f.forecast_id) === String(forecastId));
            if (!forecast) return;
            const body = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                    <div class="bg-slate-50 p-3 rounded-xl">ุงููุชุฑุฉ: ${sanitizeText(forecast.forecast_period)}</div>
                    <div class="bg-slate-50 p-3 rounded-xl">ุงูููุน: ${sanitizeText(forecast.forecast_type)}</div>
                    <div class="bg-slate-50 p-3 rounded-xl">ุงููููุฉ: ${formatMoney(forecast.forecast_amount)}</div>
                    <div class="bg-slate-50 p-3 rounded-xl">ุงูุซูุฉ: ${formatConfidence(forecast.confidence_level)}</div>
                    <div class="bg-slate-50 p-3 rounded-xl md:col-span-2">ููุงุญุธุงุช ุงูุฐูุงุก: ${sanitizeText(forecast.ai_model || 'ุบูุฑ ูุญุฏุฏ')}</div>
                </div>
            `;
            openModal('ูุนุงููุฉ ุงูุชููุน ุงูุฐูู', body, `<button onclick="closeModal()" class="px-4 py-2 rounded-full bg-slate-200">ุฅุบูุงู</button>`);
        }

        function openForecastEdit(forecastId) {
            const forecast = store.forecasts.find(f => String(f.forecast_id) === String(forecastId));
            if (!forecast) return;
            const body = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="text-xs text-slate-500">ูุชุฑุฉ ุงูุชููุน</label>
                        <input id="editForecastPeriod" type="text" class="w-full border rounded-xl p-2" value="${escapeHtml(forecast.forecast_period || '')}">
                    </div>
                    <div>
                        <label class="text-xs text-slate-500">ููุน ุงูุชููุน</label>
                        <input id="editForecastType" type="text" class="w-full border rounded-xl p-2" value="${escapeHtml(forecast.forecast_type || '')}">
                    </div>
                    <div>
                        <label class="text-xs text-slate-500">ูููุฉ ุงูุชููุน</label>
                        <input id="editForecastAmount" type="number" class="w-full border rounded-xl p-2" value="${escapeHtml(forecast.forecast_amount || '')}">
                    </div>
                    <div>
                        <label class="text-xs text-slate-500">ุงูุซูุฉ</label>
                        <input id="editForecastConfidence" type="number" step="0.01" class="w-full border rounded-xl p-2" value="${escapeHtml(forecast.confidence_level || '')}">
                    </div>
                    <div class="md:col-span-2">
                        <label class="text-xs text-slate-500">ุงููููุฐุฌ</label>
                        <input id="editForecastModel" type="text" class="w-full border rounded-xl p-2" value="${escapeHtml(forecast.ai_model || '')}">
                    </div>
                </div>
            `;
            const actions = `
                <button onclick="saveForecastEdit(${forecast.forecast_id})" class="px-4 py-2 rounded-full bg-emerald-600 text-white">ุญูุธ ุงูุชุนุฏููุงุช</button>
                <button onclick="closeModal()" class="px-4 py-2 rounded-full bg-slate-200">ุฅูุบุงุก</button>
            `;
            openModal('ุชุนุฏูู ุงูุชููุน ุงูุฐูู', body, actions);
        }

        async function saveForecastEdit(forecastId) {
            const payload = {
                entity_id: ENTITY_ID,
                forecast_period: document.getElementById('editForecastPeriod').value,
                forecast_type: document.getElementById('editForecastType').value,
                forecast_amount: document.getElementById('editForecastAmount').value,
                confidence_level: document.getElementById('editForecastConfidence').value,
                ai_model: document.getElementById('editForecastModel').value
            };

            const res = await fetch(`${API_BASE}/finance/ai-forecasts/${forecastId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json', ...CONTEXT_HEADERS },
                body: JSON.stringify(payload)
            });
            const data = await safeJson(res);
            if (!res.ok) {
                alert(`ุชุนุฐุฑ ุญูุธ ุงูุชุนุฏููุงุช: ${data.error || 'ุฎุทุฃ ุบูุฑ ูุนุฑูู'}`);
                return;
            }
            closeModal();
            await loadData();
        }

        async function deleteForecast(forecastId) {
            if (!confirm('ูู ุชุฑูุฏ ุญุฐู ุงูุชููุน ุงูุฐููุ')) return;
            const res = await fetch(`${API_BASE}/finance/ai-forecasts/${forecastId}?entity_id=${ENTITY_ID}`, {
                method: 'DELETE',
                headers: CONTEXT_HEADERS
            });
            const data = await safeJson(res);
            if (!res.ok) {
                alert(`ุชุนุฐุฑ ุญุฐู ุงูุชููุน: ${data.error || 'ุฎุทุฃ ุบูุฑ ูุนุฑูู'}`);
                return;
            }
            await loadData();
        }

        function renderOptions(options, selected) {
            return options.map(opt => {
                const isSelected = String(opt).toUpperCase() === String(selected || '').toUpperCase();
                return `<option value="${opt}" ${isSelected ? 'selected' : ''}>${translateOption(opt)}</option>`;
            }).join('');
        }

        function translateOption(value) {
            if (['ISSUED','PARTIAL','PAID','OVERDUE','DRAFT','CANCELLED'].includes(value)) {
                return translateInvoiceStatus(value);
            }
            if (['UNPAID','PARTIAL','PAID'].includes(value)) {
                return translatePaymentStatus(value);
            }
            if (['LOW','MEDIUM','HIGH','CRITICAL'].includes(value)) {
                return translateRiskLevel(value);
            }
            return sanitizeText(value);
        }

        document.addEventListener('DOMContentLoaded', loadData);
    </script>
</body>
</html>
