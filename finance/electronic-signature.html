<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ§¾ Ø§Ù„ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ - Ù†Ø¸Ø§Ù… Ù†Ø§ÙŠÙˆØ´</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            font-family: 'Cairo', sans-serif;
            background: linear-gradient(135deg, #0ea5e9 0%, #6366f1 50%, #14b8a6 100%);
            min-height: 100vh;
        }
        .card-glass {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
        }
        .stat-pill { border-radius: 999px; box-shadow: 0 18px 30px rgba(15, 23, 42, 0.15); }
        .stat-angled { border-radius: 28px 6px 28px 6px; }
        .stat-rounded { border-radius: 28px; }
        .stat-cut { border-radius: 6px 28px 6px 28px; }
        .table-scroll { max-height: 560px; overflow: auto; }
        .section-accent-sky { border-top: 4px solid #0ea5e9; }
        .section-accent-emerald { border-top: 4px solid #10b981; }
        .section-accent-amber { border-top: 4px solid #f59e0b; }
        .section-accent-violet { border-top: 4px solid #8b5cf6; }
        .section-accent-rose { border-top: 4px solid #f43f5e; }
        .chip { padding: 6px 12px; border-radius: 999px; font-weight: 700; }
    </style>
</head>
<body>
    <div class="container mx-auto px-4 py-8">
        <div class="mb-8 text-white">
            <h1 class="text-4xl font-bold mb-2">ğŸ§¾ Ø§Ù„ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</h1>
            <p class="text-lg opacity-90">Ø­ÙˆÙƒÙ…Ø© Ø§Ù„ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ø±Ù‚Ù…ÙŠ ÙˆØ³Ø¬Ù„ Ø§Ù„ÙˆØ«Ø§Ø¦Ù‚ Ø§Ù„Ù…Ø¹ØªÙ…Ø¯Ø©</p>
        </div>

        <div class="mb-6 flex flex-wrap gap-3">
            <button onclick="refreshData()" class="bg-white text-sky-700 px-6 py-3 rounded-full font-bold hover:shadow-lg transition flex items-center gap-2">
                <i class="fas fa-rotate"></i>
                ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            </button>
            <button onclick="downloadAllJSON()" class="bg-indigo-600 text-white px-6 py-3 rounded-full font-bold hover:shadow-lg transition flex items-center gap-2">
                <i class="fas fa-file-code"></i>
                ØªÙ†Ø²ÙŠÙ„ Ù…Ù„Ù Ø¨ÙŠØ§Ù†Ø§Øª Ø´Ø§Ù…Ù„
            </button>
            <button onclick="downloadAllCSV()" class="bg-emerald-600 text-white px-6 py-3 rounded-full font-bold hover:shadow-lg transition flex items-center gap-2">
                <i class="fas fa-file-csv"></i>
                ØªÙ†Ø²ÙŠÙ„ Ù…Ù„Ù Ø¬Ø¯ÙˆÙ„ÙŠ Ø´Ø§Ù…Ù„
            </button>
            <button onclick="printReport()" class="bg-rose-600 text-white px-6 py-3 rounded-full font-bold hover:shadow-lg transition flex items-center gap-2">
                <i class="fas fa-print"></i>
                Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ±
            </button>
        </div>

        <!-- Signature Overview -->
        <div class="card-glass rounded-3xl shadow-2xl p-6 mb-8 section-accent-sky">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-5">
                <div class="stat-pill bg-gradient-to-br from-sky-500 to-blue-600 text-white p-6">
                    <div class="flex justify-between mb-3"><span>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙˆØ«Ø§Ø¦Ù‚</span><i class="fas fa-folder-open text-2xl opacity-70"></i></div>
                    <div id="docsTotal" class="text-3xl font-bold"><div class="animate-pulse">...</div></div>
                </div>
                <div class="stat-angled bg-gradient-to-br from-emerald-500 to-teal-600 text-white p-6">
                    <div class="flex justify-between mb-3"><span>Ø§Ù„Ù…ÙˆÙ‚Ø¹Ø©</span><i class="fas fa-file-signature text-2xl opacity-70"></i></div>
                    <div id="docsSigned" class="text-3xl font-bold"><div class="animate-pulse">...</div></div>
                </div>
                <div class="stat-rounded bg-gradient-to-br from-amber-500 to-orange-600 text-white p-6">
                    <div class="flex justify-between mb-3"><span>Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±</span><i class="fas fa-hourglass-half text-2xl opacity-70"></i></div>
                    <div id="docsPending" class="text-3xl font-bold"><div class="animate-pulse">...</div></div>
                </div>
                <div class="stat-cut bg-gradient-to-br from-rose-500 to-pink-600 text-white p-6">
                    <div class="flex justify-between mb-3"><span>Ø§Ù„ØªØ­Ù‚Ù‚ Ø§Ù„Ù…ÙƒØªÙ…Ù„</span><i class="fas fa-shield-check text-2xl opacity-70"></i></div>
                    <div id="docsVerified" class="text-3xl font-bold"><div class="animate-pulse">...</div></div>
                </div>
            </div>
        </div>

        <!-- Signature Policies -->
        <div class="card-glass rounded-3xl shadow-2xl p-6 mb-8 section-accent-emerald">
            <h2 class="text-2xl font-bold text-slate-800 mb-4">ğŸ›¡ï¸ Ø®ØµØ§Ø¦Øµ ÙØ±ÙŠØ¯Ø© Ù„Ù„ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 text-sm">
                <div class="stat-pill bg-emerald-50 p-4">Ø¨ØµÙ…Ø© ØªÙˆÙ‚ÙŠØ¹ Ù„ÙƒÙ„ Ù…Ø³ØªÙ†Ø¯</div>
                <div class="stat-angled bg-sky-50 p-4">ØªØ­Ù‚Ù‚ ÙÙˆØ±ÙŠ Ù…ØªØ¹Ø¯Ø¯ Ø§Ù„Ø·Ø¨Ù‚Ø§Øª</div>
                <div class="stat-rounded bg-indigo-50 p-4">Ø³Ø¬Ù„ ØªØ¯Ù‚ÙŠÙ‚ Ø²Ù…Ù†ÙŠ ØºÙŠØ± Ù‚Ø§Ø¨Ù„ Ù„Ù„ØªØ¹Ø¯ÙŠÙ„</div>
                <div class="stat-cut bg-rose-50 p-4">ØªÙˆÙ‚ÙŠØ¹ Ø¢Ù…Ù† Ù…ØªØ¹Ø¯Ø¯ Ø§Ù„Ø¬Ù‡Ø§Øª</div>
                <div class="stat-pill bg-amber-50 p-4">ØªÙ†Ø¨ÙŠÙ‡Ø§Øª ÙÙˆØ±ÙŠØ© Ø¹Ù†Ø¯ Ø£ÙŠ ØªØºÙŠÙŠØ±</div>
                <div class="stat-angled bg-violet-50 p-4">ØªØ®Ø²ÙŠÙ† Ø¥Ø«Ø¨Ø§Øª Ø§Ù„ØªÙˆÙ‚ÙŠØ¹ Ù…Ø­Ù„ÙŠÙ‹Ø§</div>
            </div>
        </div>

        <!-- Signature Workflow -->
        <div class="card-glass rounded-3xl shadow-2xl p-6 mb-8 section-accent-violet">
            <h2 class="text-2xl font-bold text-slate-800 mb-4">ğŸ§­ Ø¯ÙˆØ±Ø© Ø§Ù„ØªÙˆÙ‚ÙŠØ¹ ÙˆØ§Ù„ØªØ­Ù‚Ù‚</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 text-sm">
                <div class="stat-rounded bg-violet-50 p-4">Ø¥Ù†Ø´Ø§Ø¡ Ø¨ØµÙ…Ø© Ø§Ù„Ù…Ø³ØªÙ†Ø¯</div>
                <div class="stat-angled bg-emerald-50 p-4">ØªØ£ÙƒÙŠØ¯ ØµØ§Ø­Ø¨ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©</div>
                <div class="stat-pill bg-amber-50 p-4">Ø¥ØµØ¯Ø§Ø± Ø´Ù‡Ø§Ø¯Ø© Ø§Ù„ØªÙˆÙ‚ÙŠØ¹</div>
                <div class="stat-cut bg-sky-50 p-4">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØªØ­Ù‚Ù‚ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ</div>
            </div>
        </div>

        <!-- Documents Table -->
        <div class="card-glass rounded-3xl shadow-2xl p-6 mb-8 section-accent-amber">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-xl font-bold text-slate-800">ğŸ“„ Ø¬Ø¯ÙˆÙ„ Ø§Ù„ÙˆØ«Ø§Ø¦Ù‚ Ø§Ù„Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„ØªÙˆÙ‚ÙŠØ¹</h3>
                <span id="docsCount" class="text-sm text-slate-500"></span>
            </div>
            <div class="table-scroll">
                <table class="w-full text-xs">
                    <thead class="bg-amber-50 text-amber-700">
                        <tr>
                            <th class="px-3 py-2 text-right">Ø±Ù‚Ù… Ø§Ù„Ù…Ø³ØªÙ†Ø¯</th>
                            <th class="px-3 py-2 text-right">Ø§Ù„Ù†ÙˆØ¹</th>
                            <th class="px-3 py-2 text-right">Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø£Ùˆ Ø§Ù„Ù…ÙˆØ¸Ù</th>
                            <th class="px-3 py-2 text-right">Ø§Ù„Ù‚ÙŠÙ…Ø©</th>
                            <th class="px-3 py-2 text-right">Ø§Ù„Ø­Ø§Ù„Ø©</th>
                            <th class="px-3 py-2 text-right">Ø­Ø§Ù„Ø© Ø§Ù„ØªÙˆÙ‚ÙŠØ¹</th>
                            <th class="px-3 py-2 text-right">Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«</th>
                            <th class="px-3 py-2 text-right">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                        </tr>
                    </thead>
                    <tbody id="docsTable" class="divide-y divide-slate-100">
                        <tr>
                            <td colspan="8" class="px-4 py-12 text-center text-slate-500">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Signature Log -->
        <div class="card-glass rounded-3xl shadow-2xl p-6 section-accent-rose">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-xl font-bold text-slate-800">ğŸ§¾ Ø³Ø¬Ù„ Ø§Ù„ØªÙˆÙ‚ÙŠØ¹Ø§Øª ÙˆØ§Ù„ØªØ­Ù‚Ù‚</h3>
                <span id="logCount" class="text-sm text-slate-500"></span>
            </div>
            <div class="table-scroll">
                <table class="w-full text-xs">
                    <thead class="bg-rose-50 text-rose-700">
                        <tr>
                            <th class="px-3 py-2 text-right">Ø±Ù‚Ù… Ø§Ù„Ø³Ø¬Ù„</th>
                            <th class="px-3 py-2 text-right">Ø±Ù‚Ù… Ø§Ù„Ù…Ø³ØªÙ†Ø¯</th>
                            <th class="px-3 py-2 text-right">Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡</th>
                            <th class="px-3 py-2 text-right">Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</th>
                            <th class="px-3 py-2 text-right">Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                            <th class="px-3 py-2 text-right">Ø§Ù„Ø¨ØµÙ…Ø©</th>
                        </tr>
                    </thead>
                    <tbody id="logTable" class="divide-y divide-slate-100">
                        <tr>
                            <td colspan="6" class="px-4 py-12 text-center text-slate-500">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª Ø¨Ø¹Ø¯</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = window.location.origin;
        const SIGNATURE_STORAGE_KEY = 'ØªÙˆÙ‚ÙŠØ¹Ø§Øª_Ø§Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ©';

        let invoices = [];
        let payments = [];
        let customers = [];
        let requests = [];
        let signatures = {};
        let logEntries = [];

        function loadSignatures() {
            const saved = localStorage.getItem(SIGNATURE_STORAGE_KEY);
            signatures = saved ? JSON.parse(saved) : {};
        }

        function saveSignatures() {
            localStorage.setItem(SIGNATURE_STORAGE_KEY, JSON.stringify(signatures));
        }

        async function loadData() {
            try {
                const [invoicesRes, paymentsRes, customersRes, requestsRes] = await Promise.all([
                    fetch(`${API_BASE}/finance/invoices`),
                    fetch(`${API_BASE}/finance/payments`),
                    fetch(`${API_BASE}/finance/customers`),
                    fetch(`${API_BASE}/api/employee-requests`)
                ]);

                const [invoicesData, paymentsData, customersData, requestsData] = await Promise.all([
                    invoicesRes.json(),
                    paymentsRes.json(),
                    customersRes.json(),
                    requestsRes.json()
                ]);

                invoices = invoicesData.invoices || [];
                payments = paymentsData.payments || [];
                customers = customersData.customers || customersData.rows || [];
                requests = Array.isArray(requestsData) ? requestsData : [];

                loadSignatures();
                buildLogsFromSignatures();
                renderStats();
                renderTables();
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', error);
                loadSignatures();
                buildLogsFromSignatures();
                renderStats();
                renderTables();
            }
        }

        function buildLogsFromSignatures() {
            logEntries = Object.keys(signatures).map((key, index) => {
                const entry = signatures[key];
                return {
                    id: index + 1,
                    document_id: entry.document_id,
                    action: entry.action,
                    user: entry.user,
                    date: entry.date,
                    fingerprint: entry.fingerprint
                };
            });
        }

        function renderStats() {
            const documents = collectDocuments();
            const total = documents.length;
            const signed = documents.filter(d => signatures[d.key]?.status === 'Ù…ÙˆÙ‚Ø¹').length;
            const verified = documents.filter(d => signatures[d.key]?.verified).length;
            const pending = total - signed;

            document.getElementById('docsTotal').textContent = total;
            document.getElementById('docsSigned').textContent = signed;
            document.getElementById('docsPending').textContent = pending;
            document.getElementById('docsVerified').textContent = verified;
        }

        function collectDocuments() {
            const docs = [];

            invoices.forEach(i => {
                docs.push({
                    key: `ÙØ§ØªÙˆØ±Ø©_${i.invoice_id || i.id}`,
                    document_id: i.invoice_id || i.id,
                    type: 'ÙØ§ØªÙˆØ±Ø©',
                    owner: i.customer_name || i.customer_id,
                    value: i.total_amount || i.amount,
                    status: i.status,
                    updated_at: i.updated_at || i.created_at
                });
            });

            payments.forEach(p => {
                docs.push({
                    key: `Ø¯ÙØ¹_${p.payment_id || p.id}`,
                    document_id: p.payment_id || p.id,
                    type: 'Ø¯ÙØ¹Ø©',
                    owner: p.customer_name || p.customer_id,
                    value: p.payment_amount || p.amount,
                    status: p.status || 'Ù…ÙƒØªÙ…Ù„',
                    updated_at: p.payment_date || p.created_at
                });
            });

            requests.forEach(r => {
                docs.push({
                    key: `Ø·Ù„Ø¨_${r.id}`,
                    document_id: r.id,
                    type: 'Ø·Ù„Ø¨ Ù…ÙˆØ¸Ù',
                    owner: r.employee_name || r.employee_id,
                    value: 0,
                    status: r.status,
                    updated_at: r.updated_at || r.created_at
                });
            });

            return docs;
        }

        function renderTables() {
            const docs = collectDocuments();
            const docsRows = docs.map(doc => {
                const signature = signatures[doc.key] || {};
                const signatureStatus = signature.status || 'ØºÙŠØ± Ù…ÙˆÙ‚Ø¹';
                return `
                    <tr class="hover:bg-amber-50">
                        <td class="px-3 py-2">${sanitizeText(doc.document_id)}</td>
                        <td class="px-3 py-2">${sanitizeText(doc.type)}</td>
                        <td class="px-3 py-2">${sanitizeText(doc.owner)}</td>
                        <td class="px-3 py-2">${formatMoney(doc.value)}</td>
                        <td class="px-3 py-2">${translateStatus(doc.status)}</td>
                        <td class="px-3 py-2">${signatureStatus}</td>
                        <td class="px-3 py-2">${formatDateTime(doc.updated_at)}</td>
                        <td class="px-3 py-2">
                            <div class="flex flex-wrap gap-2">
                                <button onclick="signDocument('${doc.key}')" class="bg-emerald-600 text-white px-2 py-1 rounded-lg text-xs font-bold">ØªÙˆÙ‚ÙŠØ¹</button>
                                <button onclick="verifySignature('${doc.key}')" class="bg-indigo-600 text-white px-2 py-1 rounded-lg text-xs font-bold">ØªØ­Ù‚Ù‚</button>
                                <button onclick="downloadCertificate('${doc.key}')" class="bg-amber-500 text-white px-2 py-1 rounded-lg text-xs font-bold">Ø´Ù‡Ø§Ø¯Ø©</button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');

            document.getElementById('docsTable').innerHTML = docsRows || `<tr><td colspan="8" class="px-4 py-12 text-center text-slate-500">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</td></tr>`;
            document.getElementById('docsCount').textContent = `Ø¹Ø¯Ø¯ Ø§Ù„ØµÙÙˆÙ: ${docs.length}`;

            const logRows = logEntries.map(l => `
                <tr class="hover:bg-rose-50">
                    <td class="px-3 py-2">${l.id}</td>
                    <td class="px-3 py-2">${sanitizeText(l.document_id)}</td>
                    <td class="px-3 py-2">${sanitizeText(l.action)}</td>
                    <td class="px-3 py-2">${sanitizeText(l.user)}</td>
                    <td class="px-3 py-2">${formatDateTime(l.date)}</td>
                    <td class="px-3 py-2">${sanitizeText(l.fingerprint)}</td>
                </tr>
            `).join('');

            document.getElementById('logTable').innerHTML = logRows || `<tr><td colspan="6" class="px-4 py-12 text-center text-slate-500">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª Ø¨Ø¹Ø¯</td></tr>`;
            document.getElementById('logCount').textContent = `Ø¹Ø¯Ø¯ Ø§Ù„Ø³Ø¬Ù„Ø§Øª: ${logEntries.length}`;
        }

        function signDocument(key) {
            const doc = collectDocuments().find(d => d.key === key);
            if (!doc) return;
            const fingerprint = createFingerprint(doc);
            signatures[key] = {
                document_id: doc.document_id,
                status: 'Ù…ÙˆÙ‚Ø¹',
                action: 'ØªÙˆÙ‚ÙŠØ¹',
                user: 'Ù…Ø³Ø¤ÙˆÙ„ Ø§Ù„ØªÙˆÙ‚ÙŠØ¹',
                date: new Date().toISOString(),
                fingerprint,
                verified: true
            };
            saveSignatures();
            buildLogsFromSignatures();
            renderStats();
            renderTables();
        }

        function verifySignature(key) {
            const signature = signatures[key];
            if (!signature) {
                alert('Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªÙˆÙ‚ÙŠØ¹ Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªÙ†Ø¯');
                return;
            }
            signatures[key].verified = true;
            signatures[key].action = 'ØªØ­Ù‚Ù‚';
            signatures[key].date = new Date().toISOString();
            saveSignatures();
            buildLogsFromSignatures();
            renderStats();
            renderTables();
        }

        function downloadCertificate(key) {
            const signature = signatures[key];
            if (!signature) {
                alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø´Ù‡Ø§Ø¯Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªÙ†Ø¯');
                return;
            }
            const payload = {
                Ø±Ù‚Ù…_Ø§Ù„Ù…Ø³ØªÙ†Ø¯: signature.document_id,
                Ø­Ø§Ù„Ø©_Ø§Ù„ØªÙˆÙ‚ÙŠØ¹: signature.status,
                Ø¢Ø®Ø±_Ø¥Ø¬Ø±Ø§Ø¡: signature.action,
                Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: signature.user,
                Ø§Ù„ØªØ§Ø±ÙŠØ®: signature.date,
                Ø§Ù„Ø¨ØµÙ…Ø©: signature.fingerprint
            };
            downloadBlob(JSON.stringify(payload, null, 2), `Ø´Ù‡Ø§Ø¯Ø©-ØªÙˆÙ‚ÙŠØ¹-${signature.document_id}.json`, 'application/json');
        }

        function createFingerprint(doc) {
            const base = `${doc.type}-${doc.document_id}-${doc.owner}-${doc.value || 0}`;
            let hash = 0;
            for (let i = 0; i < base.length; i++) {
                hash = ((hash << 5) - hash) + base.charCodeAt(i);
                hash |= 0;
            }
            return `Ø¨ØµÙ…Ø©-${Math.abs(hash)}`;
        }

        function translateStatus(value) {
            const map = {
                PENDING: 'Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©',
                APPROVED: 'Ù…Ø¹ØªÙ…Ø¯',
                REJECTED: 'Ù…Ø±ÙÙˆØ¶',
                COMPLETED: 'Ù…ÙƒØªÙ…Ù„',
                OVERDUE: 'Ù…ØªØ£Ø®Ø±'
            };
            return map[String(value || '').toUpperCase()] || sanitizeText(value) || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
        }

        function formatMoney(value) {
            const num = parseFloat(value || 0);
            return num.toLocaleString('ar-SA') + ' Ø±.Ø³';
        }

        function formatDateTime(value) {
            if (!value) return '-';
            return new Date(value).toLocaleString('ar-SA');
        }

        function sanitizeText(value) {
            if (value === null || value === undefined) return '-';
            const text = typeof value === 'string' ? value : JSON.stringify(value);
            const cleaned = text.replace(/[A-Za-z]+/g, '').replace(/\s{2,}/g, ' ').trim();
            return cleaned || '-';
        }

        function downloadAllJSON() {
            const payload = { invoices, payments, customers, requests, signatures };
            downloadBlob(JSON.stringify(payload, null, 2), 'Ø§Ù„ØªÙˆÙ‚ÙŠØ¹-Ø§Ù„Ø§Ù„ÙƒØªØ±ÙˆÙ†ÙŠ.json', 'application/json');
        }

        function downloadAllCSV() {
            const rows = [];
            rows.push(['Ø§Ù„ÙˆØ«Ø§Ø¦Ù‚']);
            rows.push(['Ø±Ù‚Ù… Ø§Ù„Ù…Ø³ØªÙ†Ø¯','Ø§Ù„Ù†ÙˆØ¹','Ø§Ù„Ù…Ø§Ù„Ùƒ','Ø§Ù„Ù‚ÙŠÙ…Ø©','Ø§Ù„Ø­Ø§Ù„Ø©','Ø­Ø§Ù„Ø© Ø§Ù„ØªÙˆÙ‚ÙŠØ¹']);
            collectDocuments().forEach(d => rows.push([
                d.document_id,
                d.type,
                sanitizeText(d.owner),
                d.value || 0,
                translateStatus(d.status),
                signatures[d.key]?.status || 'ØºÙŠØ± Ù…ÙˆÙ‚Ø¹'
            ]));

            rows.push([]);
            rows.push(['Ø³Ø¬Ù„ Ø§Ù„ØªÙˆÙ‚ÙŠØ¹Ø§Øª']);
            rows.push(['Ø±Ù‚Ù… Ø§Ù„Ø³Ø¬Ù„','Ø±Ù‚Ù… Ø§Ù„Ù…Ø³ØªÙ†Ø¯','Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡','Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…','Ø§Ù„ØªØ§Ø±ÙŠØ®','Ø§Ù„Ø¨ØµÙ…Ø©']);
            logEntries.forEach(l => rows.push([
                l.id,
                l.document_id,
                l.action,
                l.user,
                l.date,
                l.fingerprint
            ]));

            const csvContent = rows.map(r => r.map(v => `"${v ?? ''}"`).join(',')).join('\n');
            downloadBlob(csvContent, 'Ø³Ø¬Ù„-Ø§Ù„ØªÙˆÙ‚ÙŠØ¹Ø§Øª.csv', 'text/csv;charset=utf-8;');
        }

        function downloadBlob(content, filename, type) {
            const blob = new Blob([content], { type });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            link.click();
            URL.revokeObjectURL(url);
        }

        function printReport() {
            window.print();
        }

        function refreshData() {
            loadData();
        }

        document.addEventListener('DOMContentLoaded', loadData);
    </script>
</body>
</html>
