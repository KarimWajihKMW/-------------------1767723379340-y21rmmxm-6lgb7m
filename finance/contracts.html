<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ“œ Ø§Ù„Ø¹Ù‚ÙˆØ¯ - Ù†Ø¸Ø§Ù… Ù†Ø§ÙŠÙˆØ´</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: 'Cairo', sans-serif; background-color: #f9fafb; color: #0f172a; }
        .card-glass {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
        }
        .stat-pill { border-radius: 999px; box-shadow: 0 18px 30px rgba(15, 23, 42, 0.15); }
        .stat-angled { border-radius: 28px 6px 28px 6px; }
        .stat-rounded { border-radius: 28px; }
        .stat-cut { border-radius: 6px 28px 6px 28px; }
        .table-scroll { max-height: 560px; overflow: auto; }
        .section-accent-sky { border-top: 4px solid #0ea5e9; }
        .section-accent-emerald { border-top: 4px solid #10b981; }
        .section-accent-amber { border-top: 4px solid #f59e0b; }
        .section-accent-violet { border-top: 4px solid #8b5cf6; }
        .section-accent-rose { border-top: 4px solid #f43f5e; }
        .section-accent-slate { border-top: 4px solid #0f172a; }
        .chip { padding: 6px 12px; border-radius: 999px; font-weight: 700; }
    
        .card-gradient {
            background: linear-gradient(145deg, #ffffff, #f3f4f6);
            border: 1px solid #e2e8f0;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
    
    </style>
</head>
<body>
    <div class="container mx-auto px-4 py-8">
        <div class="mb-8 text-slate-900">
            <h1 class="text-4xl font-bold mb-2">ğŸ“œ Ø§Ù„Ø¹Ù‚ÙˆØ¯</h1>
            <p class="text-lg text-slate-600">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù‚ÙˆØ¯ ÙˆØ§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª ÙˆØ§Ù„Ø¬Ø¯ÙˆÙ„Ø© Ø§Ù„Ø°ÙƒÙŠØ©</p>
        </div>

        <div class="mb-6 flex flex-wrap gap-3">
            <button onclick="openContractModal()" class="bg-emerald-600 text-white px-6 py-3 rounded-full font-bold hover:shadow-lg transition flex items-center gap-2">
                <i class="fas fa-plus-circle"></i>
                Ø¥Ø¶Ø§ÙØ© Ø¹Ù‚Ø¯ Ø¬Ø¯ÙŠØ¯
            </button>
            <button onclick="refreshData()" class="bg-white text-slate-800 px-6 py-3 rounded-full font-bold hover:shadow-lg transition flex items-center gap-2">
                <i class="fas fa-rotate"></i>
                ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            </button>
            <button onclick="downloadAllJSON()" class="bg-indigo-600 text-white px-6 py-3 rounded-full font-bold hover:shadow-lg transition flex items-center gap-2">
                <i class="fas fa-file-code"></i>
                ØªÙ†Ø²ÙŠÙ„ Ù…Ù„Ù Ø¨ÙŠØ§Ù†Ø§Øª Ø´Ø§Ù…Ù„
            </button>
            <button onclick="downloadAllCSV()" class="bg-emerald-600 text-white px-6 py-3 rounded-full font-bold hover:shadow-lg transition flex items-center gap-2">
                <i class="fas fa-file-csv"></i>
                ØªÙ†Ø²ÙŠÙ„ Ù…Ù„Ù Ø¬Ø¯ÙˆÙ„ÙŠ Ø´Ø§Ù…Ù„
            </button>
            <button onclick="printReport()" class="bg-rose-600 text-white px-6 py-3 rounded-full font-bold hover:shadow-lg transition flex items-center gap-2">
                <i class="fas fa-print"></i>
                Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ±
            </button>
        </div>

        <div class="card-glass rounded-3xl shadow-2xl p-6 mb-8 section-accent-sky">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-5">
                <div class="stat-pill bg-gradient-to-br from-slate-700 to-slate-900 text-slate-900 p-6">
                    <div class="flex justify-between mb-3"><span>Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ù‚ÙˆØ¯</span><i class="fas fa-file-contract text-2xl opacity-70"></i></div>
                    <div id="contractsCount" class="text-3xl font-bold"><div class="animate-pulse">...</div></div>
                </div>
                <div class="stat-angled bg-gradient-to-br from-emerald-500 to-teal-600 text-slate-900 p-6">
                    <div class="flex justify-between mb-3"><span>Ù‚ÙŠÙ…Ø© Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª</span><i class="fas fa-scale-balanced text-2xl opacity-70"></i></div>
                    <div id="totalCommitments" class="text-3xl font-bold"><div class="animate-pulse">...</div></div>
                </div>
                <div class="stat-rounded bg-gradient-to-br from-amber-500 to-orange-600 text-slate-900 p-6">
                    <div class="flex justify-between mb-3"><span>Ù†Ø³Ø¨Ø© Ø§Ù„Ø¥ØºÙ„Ø§Ù‚</span><i class="fas fa-percent text-2xl opacity-70"></i></div>
                    <div id="closureRate" class="text-3xl font-bold"><div class="animate-pulse">...</div></div>
                </div>
                <div class="stat-cut bg-gradient-to-br from-violet-500 to-indigo-600 text-slate-900 p-6">
                    <div class="flex justify-between mb-3"><span>Ø¹Ù‚ÙˆØ¯ Ù†Ø´Ø·Ø©</span><i class="fas fa-circle-check text-2xl opacity-70"></i></div>
                    <div id="activeContracts" class="text-3xl font-bold"><div class="animate-pulse">...</div></div>
                </div>
            </div>
        </div>

        <div class="card-glass rounded-3xl shadow-2xl p-6 mb-8 section-accent-emerald">
            <h2 class="text-2xl font-bold text-slate-800 mb-4">âœ¨ Ø®ØµØ§Ø¦Øµ ØªØ¹Ø§Ù‚Ø¯ÙŠØ© ÙØ±ÙŠØ¯Ø©</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 text-sm">
                <div class="stat-pill bg-emerald-50 p-4">Ù…ØµÙÙˆÙØ© Ø§Ù„ØªØ²Ø§Ù…Ø§Øª Ø°ÙƒÙŠØ© Ø­Ø³Ø¨ Ø§Ù„Ù…Ø±Ø­Ù„Ø©</div>
                <div class="stat-angled bg-sky-50 p-4">ØªÙ†Ø¨ÙŠÙ‡ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„Ù…Ø®Ø§Ø·Ø± Ø§Ù„ØªØ£Ø®ÙŠØ±</div>
                <div class="stat-rounded bg-indigo-50 p-4">Ù„ÙˆØ­Ø© ØªÙ‚ÙŠÙŠÙ… Ø·Ø±ÙÙŠ Ø§Ù„Ø¹Ù‚Ø¯</div>
                <div class="stat-cut bg-rose-50 p-4">Ø£Ø±Ø´ÙØ© Ø¨Ù†ÙˆØ¯ ØºÙŠØ± Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„ØªØ¹Ø¯ÙŠÙ„</div>
                <div class="stat-pill bg-amber-50 p-4">Ø®Ø±ÙŠØ·Ø© Ø¹Ù„Ø§Ù‚Ø§Øª Ù…ØªØ¹Ø¯Ø¯Ø© Ø§Ù„Ø¹Ù‚ÙˆØ¯</div>
                <div class="stat-angled bg-violet-50 p-4">Ø¨ØµÙ…Ø© Ø§Ù…ØªØ«Ø§Ù„ Ù„ÙƒÙ„ Ø¹Ù‚Ø¯</div>
            </div>
        </div>

        <div class="card-glass rounded-3xl shadow-2xl p-6 mb-8 section-accent-violet">
            <h2 class="text-2xl font-bold text-slate-800 mb-4">ğŸ§­ Ø¯ÙˆØ±Ø© Ø­ÙŠØ§Ø© Ø§Ù„Ø¹Ù‚Ø¯</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 text-sm">
                <div class="stat-rounded bg-violet-50 p-4">ØµÙŠØ§ØºØ© ÙˆÙ…Ø±Ø§Ø¬Ø¹Ø©</div>
                <div class="stat-angled bg-emerald-50 p-4">Ù…ÙˆØ§ÙÙ‚Ø§Øª Ø¯Ø§Ø®Ù„ÙŠØ©</div>
                <div class="stat-pill bg-amber-50 p-4">ØªÙØ¹ÙŠÙ„ ÙˆÙ…ØªØ§Ø¨Ø¹Ø©</div>
                <div class="stat-cut bg-sky-50 p-4">ØªØ¬Ø¯ÙŠØ¯ ÙˆØ¥ØºÙ„Ø§Ù‚</div>
            </div>
        </div>

        <div class="card-glass rounded-3xl shadow-2xl p-6 mb-8 section-accent-amber">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-xl font-bold text-slate-800">ğŸ“‘ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¹Ù‚ÙˆØ¯</h3>
                <span id="contractsTableCount" class="text-sm text-slate-500"></span>
            </div>
            <div class="table-scroll">
                <table class="w-full text-xs">
                    <thead class="bg-amber-50 text-amber-700">
                        <tr>
                            <th class="px-3 py-2 text-right">Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯</th>
                            <th class="px-3 py-2 text-right">Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø£Ùˆ Ø§Ù„Ø¬Ù‡Ø©</th>
                            <th class="px-3 py-2 text-right">Ø§Ù„Ù‚ÙŠÙ…Ø©</th>
                            <th class="px-3 py-2 text-right">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡</th>
                            <th class="px-3 py-2 text-right">Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø®Ø¯Ù…Ø© %</th>
                            <th class="px-3 py-2 text-right">Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©</th>
                            <th class="px-3 py-2 text-right">Ø§Ù„Ù…Ø®Ø§Ø·Ø±</th>
                            <th class="px-3 py-2 text-right">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                        </tr>
                    </thead>
                    <tbody id="contractsTable" class="divide-y divide-slate-100">
                        <tr>
                            <td colspan="8" class="px-4 py-12 text-center text-slate-500">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="card-glass rounded-3xl shadow-2xl p-6 section-accent-rose">
            <div class="flex items-center justify-between mb-4">
                <div class="flex items-center gap-3">
                    <h3 class="text-xl font-bold text-slate-800">ğŸ§¾ Ø³Ø¬Ù„ Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯Ø§Øª ÙˆØ§Ù„Ù…ØªØ§Ø¨Ø¹Ø©</h3>
                    <button onclick="openLogModal()" class="bg-rose-600 text-white px-4 py-2 rounded-xl text-xs font-bold hover:shadow-lg flex items-center gap-1">
                        <i class="fas fa-plus"></i>
                        Ø¥Ø¶Ø§ÙØ© Ø³Ø¬Ù„
                    </button>
                </div>
                <span id="logCount" class="text-sm text-slate-500"></span>
            </div>
            <div class="table-scroll">
                <table class="w-full text-xs">
                    <thead class="bg-rose-50 text-rose-700">
                        <tr>
                            <th class="px-3 py-2 text-right">Ø±Ù‚Ù… Ø§Ù„Ø³Ø¬Ù„</th>
                            <th class="px-3 py-2 text-right">Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯</th>
                            <th class="px-3 py-2 text-right">Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡</th>
                            <th class="px-3 py-2 text-right">Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„</th>
                            <th class="px-3 py-2 text-right">Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                            <th class="px-3 py-2 text-right">Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©</th>
                            <th class="px-3 py-2 text-right">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                        </tr>
                    </thead>
                    <tbody id="logTable" class="divide-y divide-slate-100">
                        <tr>
                            <td colspan="7" class="px-4 py-12 text-center text-slate-500">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª Ø¨Ø¹Ø¯</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø¹Ù‚Ø¯ -->
    <div id="contractModal" class="fixed inset-0 bg-black/60 hidden items-center justify-center z-50 p-4">
        <div class="bg-white rounded-2xl w-full max-w-3xl p-6 shadow-2xl card-gradient">
            <div class="flex items-center justify-between mb-4">
                <div>
                    <h4 id="contractModalTitle" class="text-xl font-bold text-slate-800">Ø¥Ø¶Ø§ÙØ© Ø¹Ù‚Ø¯ Ø¬Ø¯ÙŠØ¯</h4>
                    <p class="text-slate-500 text-sm">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© Ù…Ø·Ù„ÙˆØ¨Ø© Ù„Ø¶Ù…Ø§Ù† Ø­ÙØ¸ Ø§Ù„Ø³Ø¬Ù„</p>
                </div>
                <button onclick="closeContractModal()" class="text-slate-500 hover:text-rose-600">
                    <i class="fas fa-times text-lg"></i>
                </button>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <label class="flex flex-col gap-2 text-sm font-bold text-slate-700">
                    Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø¯
                    <input id="contractName" class="border border-slate-200 rounded-xl px-3 py-2 focus:outline-none focus:ring-2 focus:ring-emerald-500" placeholder="Ù…Ø«Ù„: Ø¹Ù‚Ø¯ Ø®Ø¯Ù…Ø© Ø³Ù†ÙˆÙŠØ©" />
                </label>
                <label class="flex flex-col gap-2 text-sm font-bold text-slate-700">
                    Ø§Ù„Ø·Ø±Ù/Ø§Ù„Ø¹Ù…ÙŠÙ„
                    <input id="contractPartner" class="border border-slate-200 rounded-xl px-3 py-2 focus:outline-none focus:ring-2 focus:ring-emerald-500" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø£Ùˆ Ø§Ù„Ø¬Ù‡Ø©" />
                </label>
                <label class="flex flex-col gap-2 text-sm font-bold text-slate-700">
                    Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¹Ù‚Ø¯
                    <input id="contractValue" class="border border-slate-200 rounded-xl px-3 py-2 focus:outline-none focus:ring-2 focus:ring-emerald-500" placeholder="Ù…Ø«Ø§Ù„: 250000 Ø±ÙŠØ§Ù„" />
                </label>
                <label class="flex flex-col gap-2 text-sm font-bold text-slate-700">
                    ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡
                    <input id="contractExpiry" type="date" class="border border-slate-200 rounded-xl px-3 py-2 focus:outline-none focus:ring-2 focus:ring-emerald-500" />
                </label>
                <label class="flex flex-col gap-2 text-sm font-bold text-slate-700">
                    Ø§Ù„Ø­Ø§Ù„Ø©
                    <select id="contractStatus" class="border border-slate-200 rounded-xl px-3 py-2 focus:outline-none focus:ring-2 focus:ring-emerald-500">
                        <option value="Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©">Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</option>
                        <option value="Ù†Ø´Ø·">Ù†Ø´Ø·</option>
                        <option value="Ù…Ø¹ØªÙ…Ø¯">Ù…Ø¹ØªÙ…Ø¯</option>
                        <option value="Ù…ØºÙ„Ù‚">Ù…ØºÙ„Ù‚</option>
                        <option value="Ù…ØªØ£Ø®Ø±">Ù…ØªØ£Ø®Ø±</option>
                    </select>
                </label>
                <label class="flex flex-col gap-2 text-sm font-bold text-slate-700">
                    Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ù…Ø®Ø§Ø·Ø±
                    <select id="contractRisk" class="border border-slate-200 rounded-xl px-3 py-2 focus:outline-none focus:ring-2 focus:ring-emerald-500">
                        <option value="Ù…Ù†Ø®ÙØ¶">Ù…Ù†Ø®ÙØ¶</option>
                        <option value="Ù…ØªÙˆØ³Ø·">Ù…ØªÙˆØ³Ø·</option>
                        <option value="Ù…Ø±ØªÙØ¹">Ù…Ø±ØªÙØ¹</option>
                    </select>
                </label>
                <label class="flex flex-col gap-2 text-sm font-bold text-slate-700">
                    Ù†Ø³Ø¨Ø© Ø§Ù„Ø§Ù„ØªØ²Ø§Ù… Ø¨Ø§Ù„Ø®Ø¯Ù…Ø©
                    <input id="contractSLA" type="number" min="0" max="100" step="1" class="border border-slate-200 rounded-xl px-3 py-2 focus:outline-none focus:ring-2 focus:ring-emerald-500" placeholder="%" />
                </label>
                <label class="flex flex-col gap-2 text-sm font-bold text-slate-700 md:col-span-2">
                    ØªÙØ§ØµÙŠÙ„ Ù…Ø®ØªØµØ±Ø©
                    <textarea id="contractNote" rows="2" class="border border-slate-200 rounded-xl px-3 py-2 focus:outline-none focus:ring-2 focus:ring-emerald-500" placeholder="ØªÙ„Ø®ÙŠØµ Ø£Ù‡Ù… Ø¨Ù†ÙˆØ¯ Ø§Ù„Ø¹Ù‚Ø¯"></textarea>
                </label>
            </div>

            <div class="flex items-center justify-between">
                <div id="contractFormMessage" class="text-sm text-rose-600"></div>
                <div class="flex gap-3">
                    <button onclick="submitContractForm()" class="bg-emerald-600 text-white px-5 py-2 rounded-xl font-bold hover:shadow-lg">Ø­ÙØ¸</button>
                    <button onclick="closeContractModal()" class="bg-slate-100 text-slate-700 px-4 py-2 rounded-xl font-bold hover:shadow">Ø¥Ù„ØºØ§Ø¡</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Ù†Ù…ÙˆØ°Ø¬ Ø³Ø¬Ù„ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© -->
    <div id="logModal" class="fixed inset-0 bg-black/60 hidden items-center justify-center z-50 p-4">
        <div class="bg-white rounded-2xl w-full max-w-2xl p-6 shadow-2xl card-gradient">
            <div class="flex items-center justify-between mb-4">
                <div>
                    <h4 id="logModalTitle" class="text-xl font-bold text-slate-800">Ø¥Ø¶Ø§ÙØ© Ø³Ø¬Ù„ Ù…ØªØ§Ø¨Ø¹Ø©</h4>
                    <p class="text-slate-500 text-sm">Ø£Ø±ÙÙ‚ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ ÙˆØ§Ù„Ù…Ù„Ø§Ø­Ø¸Ø© ÙˆØ³ÙŠØªÙ… Ø­ÙØ¸Ù‡Ø§ ÙÙˆØ±Ø§ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</p>
                </div>
                <button onclick="closeLogModal()" class="text-slate-500 hover:text-rose-600">
                    <i class="fas fa-times text-lg"></i>
                </button>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <label class="flex flex-col gap-2 text-sm font-bold text-slate-700 md:col-span-2">
                    Ø§Ù„Ø¹Ù‚Ø¯ Ø§Ù„Ù…Ø±ØªØ¨Ø·
                    <select id="logContract" class="border border-slate-200 rounded-xl px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500"></select>
                </label>
                <label class="flex flex-col gap-2 text-sm font-bold text-slate-700">
                    Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡
                    <input id="logAction" class="border border-slate-200 rounded-xl px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="Ù…Ø«Ù„: ØªÙ… Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯" />
                </label>
                <label class="flex flex-col gap-2 text-sm font-bold text-slate-700">
                    Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
                    <input id="logStatus" class="border border-slate-200 rounded-xl px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="Ù…Ø«Ù„: Ù…Ø¹ØªÙ…Ø¯" />
                </label>
                <label class="flex flex-col gap-2 text-sm font-bold text-slate-700">
                    Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„
                    <input id="logUser" class="border border-slate-200 rounded-xl px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…" />
                </label>
                <label class="flex flex-col gap-2 text-sm font-bold text-slate-700 md:col-span-2">
                    Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©
                    <textarea id="logNote" rows="2" class="border border-slate-200 rounded-xl px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="ØªÙØ§ØµÙŠÙ„ Ù…Ø®ØªØµØ±Ø©"></textarea>
                </label>
            </div>

            <div class="flex items-center justify-between">
                <div id="logFormMessage" class="text-sm text-rose-600"></div>
                <div class="flex gap-3">
                    <button onclick="submitLogForm()" class="bg-indigo-600 text-white px-5 py-2 rounded-xl font-bold hover:shadow-lg">Ø­ÙØ¸</button>
                    <button onclick="closeLogModal()" class="bg-slate-100 text-slate-700 px-4 py-2 rounded-xl font-bold hover:shadow">Ø¥Ù„ØºØ§Ø¡</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ØªÙØ§ØµÙŠÙ„ -->
    <div id="viewModal" class="fixed inset-0 bg-black/60 hidden items-center justify-center z-50 p-4">
        <div class="bg-white rounded-2xl w-full max-w-2xl p-6 shadow-2xl card-gradient">
            <div class="flex items-center justify-between mb-4">
                <h4 id="viewModalTitle" class="text-xl font-bold text-slate-800">Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø¹Ù‚Ø¯</h4>
                <button onclick="closeViewModal()" class="text-slate-500 hover:text-rose-600">
                    <i class="fas fa-times text-lg"></i>
                </button>
            </div>
            <div id="viewModalBody" class="space-y-3 text-sm text-slate-700"></div>
            <div class="mt-4 flex justify-end">
                <button onclick="closeViewModal()" class="bg-slate-900 text-white px-5 py-2 rounded-xl font-bold hover:shadow-lg">Ø¥ØºÙ„Ø§Ù‚</button>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = window.location.origin;

        const apiHeaders = () => ({
            'Content-Type': 'application/json',
            ...(window.getFinanceHeaders ? window.getFinanceHeaders() : {})
        });

        let contracts = [];
        let contractLogs = [];
        let editingContractId = null;
        let editingLogId = null;
        let loading = false;

        const SEED_CONTRACTS = [
            {
                contract_name: 'Ø¹Ù‚Ø¯ Ø®Ø¯Ù…Ø© Ø³Ø­Ø§Ø¨ÙŠØ©',
                partner: 'Ù…Ø¤Ø³Ø³Ø© Ø§Ù„Ø­Ù„ÙˆÙ„ Ø§Ù„Ø°ÙƒÙŠØ©',
                value_text: '250000',
                expiry: '2025-12-31',
                status: 'Ù†Ø´Ø·',
                sla_percent: 98,
                risk_level: 'Ù…Ù†Ø®ÙØ¶',
                notes: 'ØªØ´ØºÙŠÙ„ ÙˆØ¯Ø¹Ù… Ø§Ù„Ù…Ù†ØµØ© Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠØ© Ù„Ù…Ø¯Ø© Ø¹Ø§Ù…'
            },
            {
                contract_name: 'Ø¹Ù‚Ø¯ ØªØ·ÙˆÙŠØ± Ù†Ø¸Ù…',
                partner: 'Ø´Ø±ÙƒØ© Ø§Ù„ØªÙ‚Ù†ÙŠØ© Ø§Ù„Ù…ØªØ­Ø¯Ø©',
                value_text: '380000',
                expiry: '2025-09-30',
                status: 'Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©',
                sla_percent: 95,
                risk_level: 'Ù…ØªÙˆØ³Ø·',
                notes: 'ØªØ·ÙˆÙŠØ± Ø®ØµØ§Ø¦Øµ Ø±Ù‚Ù…Ù†Ø© Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ù…Ø¹ Ø¶Ù…Ø§Ù† Ø¬ÙˆØ¯Ø©'
            },
            {
                contract_name: 'Ø§ØªÙØ§Ù‚ÙŠØ© Ø§Ø³ØªØ´Ø§Ø±Ø§Øª Ù…Ø§Ù„ÙŠØ©',
                partner: 'Ù…ÙƒØªØ¨ Ø®Ø¨Ø±Ø§Ø¡ Ø§Ù„Ù…Ø§Ù„',
                value_text: '120000',
                expiry: '2025-06-30',
                status: 'Ù…Ø¹ØªÙ…Ø¯',
                sla_percent: 92,
                risk_level: 'Ù…Ù†Ø®ÙØ¶',
                notes: 'Ø®Ø¯Ù…Ø§Øª Ø§Ø³ØªØ´Ø§Ø±ÙŠØ© ÙˆÙ…Ø±Ø§Ø¬Ø¹Ø© Ø¯ÙˆØ±ÙŠØ© Ù„Ù„Ø³ÙŠÙˆÙ„Ø©'
            }
        ];

        function sanitizeText(value) {
            if (value === null || value === undefined) return '-';
            const text = typeof value === 'string' ? value : JSON.stringify(value);
            return text.replace(/[<>]/g, '').trim() || '-';
        }

        function formatMoney(value) {
            const num = parseFloat(value || 0);
            if (isNaN(num)) return sanitizeText(value);
            return num.toLocaleString('ar-SA') + ' Ø±.Ø³';
        }

        function formatDateTime(value) {
            if (!value) return '-';
            return new Date(value).toLocaleString('ar-SA');
        }

        function setLoadingState() {
            if (loading) {
                document.getElementById('contractsTable').innerHTML = `<tr><td colspan="8" class="px-4 py-12 text-center text-slate-500">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ø¯ÙŠØ«...</td></tr>`;
                document.getElementById('logTable').innerHTML = `<tr><td colspan="7" class="px-4 py-12 text-center text-slate-500">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ø¯ÙŠØ«...</td></tr>`;
            }
        }

        async function fetchContracts() {
            const res = await fetch(`${API_BASE}/api/facilities/contracts`, { headers: apiHeaders() });
            if (!res.ok) throw new Error('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¹Ù‚ÙˆØ¯');
            contracts = await res.json();
        }

        async function fetchLogs(contractId = null) {
            const url = contractId ? `${API_BASE}/api/facilities/contract-logs?contract_id=${contractId}` : `${API_BASE}/api/facilities/contract-logs`;
            const res = await fetch(url, { headers: apiHeaders() });
            if (!res.ok) throw new Error('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø³Ø¬Ù„ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©');
            contractLogs = await res.json();
        }

        async function seedContractsIfEmpty() {
            if (contracts.length) return;
            for (const item of SEED_CONTRACTS) {
                try {
                    await fetch(`${API_BASE}/api/facilities/contracts`, {
                        method: 'POST',
                        headers: apiHeaders(),
                        body: JSON.stringify(item)
                    });
                } catch (error) {
                    console.warn('ØªØ¹Ø°Ø± Ø¥Ø¶Ø§ÙØ© Ø¨ÙŠØ§Ù†Ø§Øª ØªØ¬Ø±ÙŠØ¨ÙŠØ©:', error.message);
                }
            }
        }

        async function loadData() {
            loading = true;
            setLoadingState();
            try {
                await Promise.all([fetchContracts(), fetchLogs()]);
                await seedContractsIfEmpty();
                if (!contracts.length) {
                    await fetchContracts();
                }
                renderStats();
                renderTables();
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', error);
                document.getElementById('contractsTable').innerHTML = `<tr><td colspan="8" class="px-4 py-12 text-center text-rose-500">ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</td></tr>`;
            } finally {
                loading = false;
            }
        }

        function latestStatus(contract) {
            const log = contractLogs.find(l => String(l.contract_id) === String(contract.id));
            return (log && (log.status || log.action)) || contract.status || 'Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©';
        }

        function renderStats() {
            const totalValue = contracts.reduce((sum, c) => sum + (parseFloat(c.value_text) || 0), 0);
            const active = contracts.filter(c => (latestStatus(c) === 'Ù†Ø´Ø·') || (latestStatus(c) === 'Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©')).length;
            const closed = contracts.filter(c => latestStatus(c) === 'Ù…ØºÙ„Ù‚' || latestStatus(c) === 'Ù…ÙƒØªÙ…Ù„').length;
            const closureRate = contracts.length ? (closed / contracts.length) * 100 : 0;

            document.getElementById('contractsCount').textContent = contracts.length;
            document.getElementById('totalCommitments').textContent = formatMoney(totalValue);
            document.getElementById('closureRate').textContent = `${closureRate.toFixed(1)}%`;
            document.getElementById('activeContracts').textContent = active;
        }

        function renderTables() {
            const rows = contracts.map(c => {
                const status = latestStatus(c);
                return `
                    <tr class="hover:bg-amber-50">
                        <td class="px-3 py-2">${sanitizeText(c.id)}</td>
                        <td class="px-3 py-2">${sanitizeText(c.partner)}</td>
                        <td class="px-3 py-2">${formatMoney(c.value_text)}</td>
                        <td class="px-3 py-2">${formatDateTime(c.expiry)}</td>
                        <td class="px-3 py-2">${c.sla_percent ? `${c.sla_percent}%` : '-'}</td>
                        <td class="px-3 py-2">${sanitizeText(status)}</td>
                        <td class="px-3 py-2">${sanitizeText(c.risk_level)}</td>
                        <td class="px-3 py-2">
                            <div class="flex flex-wrap gap-2">
                                <button onclick="openViewModal(${c.id})" class="bg-slate-800 text-white px-2 py-1 rounded-lg text-xs font-bold">Ù…Ø¹Ø§ÙŠÙ†Ø©</button>
                                <button onclick="openContractModal(${c.id})" class="bg-indigo-600 text-white px-2 py-1 rounded-lg text-xs font-bold">ØªØ¹Ø¯ÙŠÙ„</button>
                                <button onclick="updateContractStatus(${c.id}, 'Ù…Ø¹ØªÙ…Ø¯', 'ØªÙ… Ø§Ø¹ØªÙ…Ø§Ø¯ Ø§Ù„Ø¹Ù‚Ø¯')" class="bg-emerald-600 text-white px-2 py-1 rounded-lg text-xs font-bold">Ø§Ø¹ØªÙ…Ø§Ø¯</button>
                                <button onclick="updateContractStatus(${c.id}, 'ØªÙ… Ø§Ù„ØªØ¬Ø¯ÙŠØ¯', 'ØªÙ… Ø§Ù„ØªØ¬Ø¯ÙŠØ¯')" class="bg-cyan-600 text-white px-2 py-1 rounded-lg text-xs font-bold">ØªØ¬Ø¯ÙŠØ¯</button>
                                <button onclick="updateContractStatus(${c.id}, 'Ù…ØºÙ„Ù‚', 'ØªÙ… Ø§Ù„Ø¥ØºÙ„Ø§Ù‚')" class="bg-rose-600 text-white px-2 py-1 rounded-lg text-xs font-bold">Ø¥ØºÙ„Ø§Ù‚</button>
                                <button onclick="deleteContract(${c.id})" class="bg-slate-200 text-slate-800 px-2 py-1 rounded-lg text-xs font-bold">Ø­Ø°Ù</button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');

            document.getElementById('contractsTable').innerHTML = rows || `<tr><td colspan="8" class="px-4 py-12 text-center text-slate-500">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</td></tr>`;
            document.getElementById('contractsTableCount').textContent = `Ø¹Ø¯Ø¯ Ø§Ù„ØµÙÙˆÙ: ${contracts.length}`;

            const logRows = contractLogs.map((l, idx) => `
                <tr class="hover:bg-rose-50">
                    <td class="px-3 py-2">${idx + 1}</td>
                    <td class="px-3 py-2">${sanitizeText(l.contract_id)}</td>
                    <td class="px-3 py-2">${sanitizeText(l.action)}</td>
                    <td class="px-3 py-2">${sanitizeText(l.user_name)}</td>
                    <td class="px-3 py-2">${formatDateTime(l.created_at)}</td>
                    <td class="px-3 py-2">${sanitizeText(l.note)}</td>
                    <td class="px-3 py-2">
                        <div class="flex flex-wrap gap-2">
                            <button onclick="openLogView(${l.id})" class="bg-slate-800 text-white px-2 py-1 rounded-lg text-xs font-bold">Ù…Ø¹Ø§ÙŠÙ†Ø©</button>
                            <button onclick="openLogModal(${l.id}, ${l.contract_id})" class="bg-indigo-600 text-white px-2 py-1 rounded-lg text-xs font-bold">ØªØ¹Ø¯ÙŠÙ„</button>
                            <button onclick="deleteLog(${l.id})" class="bg-rose-600 text-white px-2 py-1 rounded-lg text-xs font-bold">Ø­Ø°Ù</button>
                        </div>
                    </td>
                </tr>
            `).join('');
            document.getElementById('logTable').innerHTML = logRows || `<tr><td colspan="7" class="px-4 py-12 text-center text-slate-500">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª Ø¨Ø¹Ø¯</td></tr>`;
            document.getElementById('logCount').textContent = `Ø¹Ø¯Ø¯ Ø§Ù„Ø³Ø¬Ù„Ø§Øª: ${contractLogs.length}`;
        }

        function fillContractForm(contract) {
            document.getElementById('contractName').value = contract?.contract_name || '';
            document.getElementById('contractPartner').value = contract?.partner || '';
            document.getElementById('contractValue').value = contract?.value_text || '';
            document.getElementById('contractExpiry').value = contract?.expiry ? contract.expiry.split('T')[0] : '';
            document.getElementById('contractStatus').value = contract?.status || 'Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©';
            document.getElementById('contractRisk').value = contract?.risk_level || 'Ù…ØªÙˆØ³Ø·';
            document.getElementById('contractSLA').value = contract?.sla_percent || '';
            document.getElementById('contractNote').value = contract?.notes || '';
        }

        function openContractModal(id = null) {
            editingContractId = id;
            const contract = contracts.find(c => String(c.id) === String(id)) || null;
            fillContractForm(contract);
            document.getElementById('contractModalTitle').textContent = id ? 'ØªØ¹Ø¯ÙŠÙ„ Ø¹Ù‚Ø¯' : 'Ø¥Ø¶Ø§ÙØ© Ø¹Ù‚Ø¯ Ø¬Ø¯ÙŠØ¯';
            document.getElementById('contractFormMessage').textContent = '';
            document.getElementById('contractModal').classList.remove('hidden');
            document.getElementById('contractModal').classList.add('flex');
        }

        function closeContractModal() {
            editingContractId = null;
            fillContractForm(null);
            document.getElementById('contractModal').classList.add('hidden');
            document.getElementById('contractModal').classList.remove('flex');
        }

        function openViewModal(id) {
            const contract = contracts.find(c => String(c.id) === String(id));
            if (!contract) return;
            const status = latestStatus(contract);
            document.getElementById('viewModalTitle').textContent = 'Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø¹Ù‚Ø¯';
            document.getElementById('viewModalBody').innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                    <div><span class="font-bold">Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø¯:</span> ${sanitizeText(contract.contract_name)}</div>
                    <div><span class="font-bold">Ø§Ù„Ø¹Ù…ÙŠÙ„:</span> ${sanitizeText(contract.partner)}</div>
                    <div><span class="font-bold">Ø§Ù„Ù‚ÙŠÙ…Ø©:</span> ${formatMoney(contract.value_text)}</div>
                    <div><span class="font-bold">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡:</span> ${formatDateTime(contract.expiry)}</div>
                    <div><span class="font-bold">Ø§Ù„Ø­Ø§Ù„Ø©:</span> ${sanitizeText(status)}</div>
                    <div><span class="font-bold">Ø§Ù„Ù…Ø®Ø§Ø·Ø±:</span> ${sanitizeText(contract.risk_level)}</div>
                    <div><span class="font-bold">Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø®Ø¯Ù…Ø©:</span> ${contract.sla_percent ? `${contract.sla_percent}%` : '-'}</div>
                    <div><span class="font-bold">Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«:</span> ${formatDateTime(contract.updated_at)}</div>
                </div>
                <div class="mt-3">
                    <div class="font-bold mb-1">Ù…Ù„Ø§Ø­Ø¸Ø§Øª:</div>
                    <div class="bg-slate-50 rounded-xl p-3 text-slate-700">${sanitizeText(contract.notes || 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„Ø§Ø­Ø¸Ø§Øª')}</div>
                </div>
            `;
            document.getElementById('viewModal').classList.remove('hidden');
            document.getElementById('viewModal').classList.add('flex');
        }

        function openLogView(id) {
            const log = contractLogs.find(l => String(l.id) === String(id));
            if (!log) return;
            const related = contracts.find(c => String(c.id) === String(log.contract_id));
            document.getElementById('viewModalTitle').textContent = 'Ù…Ø¹Ø§ÙŠÙ†Ø© Ø³Ø¬Ù„ Ù…ØªØ§Ø¨Ø¹Ø©';
            document.getElementById('viewModalBody').innerHTML = `
                <div class="space-y-2 text-sm">
                    <div><span class="font-bold">Ø§Ù„Ø¹Ù‚Ø¯:</span> ${sanitizeText(related?.contract_name || log.contract_id)}</div>
                    <div><span class="font-bold">Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡:</span> ${sanitizeText(log.action)}</div>
                    <div><span class="font-bold">Ø§Ù„Ø­Ø§Ù„Ø©:</span> ${sanitizeText(log.status || log.action)}</div>
                    <div><span class="font-bold">Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„:</span> ${sanitizeText(log.user_name)}</div>
                    <div><span class="font-bold">Ø§Ù„ØªØ§Ø±ÙŠØ®:</span> ${formatDateTime(log.created_at)}</div>
                    <div>
                        <div class="font-bold mb-1">Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª:</div>
                        <div class="bg-slate-50 rounded-xl p-3 text-slate-700">${sanitizeText(log.note || 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„Ø§Ø­Ø¸Ø§Øª')}</div>
                    </div>
                </div>
            `;
            document.getElementById('viewModal').classList.remove('hidden');
            document.getElementById('viewModal').classList.add('flex');
        }

        function closeViewModal() {
            document.getElementById('viewModal').classList.add('hidden');
            document.getElementById('viewModal').classList.remove('flex');
        }

        async function submitContractForm() {
            const name = document.getElementById('contractName').value.trim();
            const partner = document.getElementById('contractPartner').value.trim();
            const valueText = document.getElementById('contractValue').value.trim();
            const expiry = document.getElementById('contractExpiry').value;
            const status = document.getElementById('contractStatus').value;
            const risk = document.getElementById('contractRisk').value;
            const sla = document.getElementById('contractSLA').value;
            const note = document.getElementById('contractNote').value.trim();

            if (!name || !partner || !valueText) {
                document.getElementById('contractFormMessage').textContent = 'Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„Ø·Ø±Ù ÙˆØ§Ù„Ù‚ÙŠÙ…Ø© Ø­Ù‚ÙˆÙ„ Ø£Ø³Ø§Ø³ÙŠØ©';
                return;
            }

            const payload = {
                contract_name: name,
                partner,
                value_text: valueText,
                expiry: expiry || null,
                status,
                risk_level: risk,
                sla_percent: sla ? Number(sla) : null,
                notes: note
            };

            try {
                const method = editingContractId ? 'PUT' : 'POST';
                const url = editingContractId ? `${API_BASE}/api/facilities/contracts/${editingContractId}` : `${API_BASE}/api/facilities/contracts`;
                const res = await fetch(url, { method, headers: apiHeaders(), body: JSON.stringify(payload) });
                if (!res.ok) throw new Error('ØªØ¹Ø°Ø± Ø­ÙØ¸ Ø§Ù„Ø¹Ù‚Ø¯');
                await loadData();
                closeContractModal();
            } catch (error) {
                document.getElementById('contractFormMessage').textContent = error.message;
            }
        }

        async function updateContractStatus(id, status, actionNote) {
            try {
                await fetch(`${API_BASE}/api/facilities/contracts/${id}`, {
                    method: 'PUT',
                    headers: apiHeaders(),
                    body: JSON.stringify({ status })
                });
                await recordLog(id, actionNote || status, `ØªÙ… Ø¶Ø¨Ø· Ø§Ù„Ø­Ø§Ù„Ø© Ø¥Ù„Ù‰ ${status}`, status);
                await loadData();
            } catch (error) {
                alert('ØªØ¹Ø°Ø± ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø¹Ù‚Ø¯');
            }
        }

        async function deleteContract(id) {
            const ok = confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù„Ø¹Ù‚Ø¯ ÙˆÙƒÙ„ Ø³Ø¬Ù„Ø§ØªÙ‡ØŸ');
            if (!ok) return;
            try {
                const res = await fetch(`${API_BASE}/api/facilities/contracts/${id}`, { method: 'DELETE', headers: apiHeaders() });
                if (!res.ok) throw new Error('ÙØ´Ù„ Ø§Ù„Ø­Ø°Ù');
                await loadData();
            } catch (error) {
                alert('ØªØ¹Ø°Ø± Ø­Ø°Ù Ø§Ù„Ø¹Ù‚Ø¯');
            }
        }

        function populateContractSelect(selectedId = null) {
            const select = document.getElementById('logContract');
            if (!contracts.length) {
                select.innerHTML = '<option disabled>Ø£Ø¶Ù Ø¹Ù‚Ø¯Ø§Ù‹ Ø£ÙˆÙ„Ø§Ù‹</option>';
                return;
            }
            select.innerHTML = contracts.map(c => `<option value="${c.id}" ${String(c.id) === String(selectedId) ? 'selected' : ''}>${sanitizeText(c.contract_name)} - ${sanitizeText(c.partner)}</option>`).join('');
        }

        function openLogModal(id = null, contractId = null) {
            editingLogId = id;
            populateContractSelect(contractId);
            const log = contractLogs.find(l => String(l.id) === String(id));
            document.getElementById('logModalTitle').textContent = id ? 'ØªØ¹Ø¯ÙŠÙ„ Ø³Ø¬Ù„ Ù…ØªØ§Ø¨Ø¹Ø©' : 'Ø¥Ø¶Ø§ÙØ© Ø³Ø¬Ù„ Ù…ØªØ§Ø¨Ø¹Ø©';
            document.getElementById('logAction').value = log?.action || '';
            document.getElementById('logStatus').value = log?.status || '';
            document.getElementById('logUser').value = log?.user_name || '';
            document.getElementById('logNote').value = log?.note || '';
            document.getElementById('logFormMessage').textContent = '';
            document.getElementById('logModal').classList.remove('hidden');
            document.getElementById('logModal').classList.add('flex');
        }

        function closeLogModal() {
            editingLogId = null;
            document.getElementById('logModal').classList.add('hidden');
            document.getElementById('logModal').classList.remove('flex');
        }

        async function submitLogForm() {
            const contractId = document.getElementById('logContract').value;
            const action = document.getElementById('logAction').value.trim();
            const status = document.getElementById('logStatus').value.trim();
            const user = document.getElementById('logUser').value.trim();
            const note = document.getElementById('logNote').value.trim();

            if (!contractId || !action) {
                document.getElementById('logFormMessage').textContent = 'Ø§Ù„Ø¹Ù‚Ø¯ ÙˆØ§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ù…Ø·Ù„ÙˆØ¨Ø§Ù†';
                return;
            }

            const payload = {
                contract_id: contractId,
                action,
                status: status || action,
                user_name: user || 'Ù…Ø³Ø¤ÙˆÙ„ Ø§Ù„Ø¹Ù‚ÙˆØ¯',
                note
            };

            try {
                const method = editingLogId ? 'PUT' : 'POST';
                const url = editingLogId ? `${API_BASE}/api/facilities/contract-logs/${editingLogId}` : `${API_BASE}/api/facilities/contract-logs`;
                const res = await fetch(url, { method, headers: apiHeaders(), body: JSON.stringify(payload) });
                if (!res.ok) throw new Error('ØªØ¹Ø°Ø± Ø­ÙØ¸ Ø§Ù„Ø³Ø¬Ù„');
                await loadData();
                closeLogModal();
            } catch (error) {
                document.getElementById('logFormMessage').textContent = error.message;
            }
        }

        async function deleteLog(id) {
            const ok = confirm('Ø­Ø°Ù Ø³Ø¬Ù„ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©ØŸ');
            if (!ok) return;
            try {
                const res = await fetch(`${API_BASE}/api/facilities/contract-logs/${id}`, { method: 'DELETE', headers: apiHeaders() });
                if (!res.ok) throw new Error('ÙØ´Ù„ Ø§Ù„Ø­Ø°Ù');
                await loadData();
            } catch (error) {
                alert('ØªØ¹Ø°Ø± Ø­Ø°Ù Ø§Ù„Ø³Ø¬Ù„');
            }
        }

        async function recordLog(contractId, action, note, status) {
            const res = await fetch(`${API_BASE}/api/facilities/contract-logs`, {
                method: 'POST',
                headers: apiHeaders(),
                body: JSON.stringify({
                    contract_id: contractId,
                    action,
                    note,
                    status: status || action,
                    user_name: 'Ù…Ø³Ø¤ÙˆÙ„ Ø§Ù„Ø¹Ù‚ÙˆØ¯'
                })
            });
            if (!res.ok) throw new Error('ØªØ¹Ø°Ø± Ø­ÙØ¸ Ø§Ù„Ø³Ø¬Ù„');
        }

        function downloadAllJSON() {
            const payload = { contracts, contractLogs };
            downloadBlob(JSON.stringify(payload, null, 2), 'Ø§Ù„Ø¹Ù‚ÙˆØ¯.json', 'application/json');
        }

        function downloadAllCSV() {
            const rows = [];
            rows.push(['Ø§Ù„Ø¹Ù‚ÙˆØ¯']);
            rows.push(['Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯','Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø¯','Ø§Ù„Ø¬Ù‡Ø©','Ø§Ù„Ù‚ÙŠÙ…Ø©','ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡','Ø§Ù„Ø­Ø§Ù„Ø©','Ø§Ù„Ù…Ø®Ø§Ø·Ø±','SLA','Ù…Ù„Ø§Ø­Ø¸Ø§Øª']);
            contracts.forEach(c => rows.push([
                c.id,
                c.contract_name,
                c.partner,
                c.value_text,
                c.expiry,
                latestStatus(c),
                c.risk_level,
                c.sla_percent,
                c.notes
            ]));

            rows.push([]);
            rows.push(['Ø³Ø¬Ù„ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©']);
            rows.push(['Ø±Ù‚Ù… Ø§Ù„Ø³Ø¬Ù„','Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯','Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡','Ø§Ù„Ø­Ø§Ù„Ø©','Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„','Ø§Ù„ØªØ§Ø±ÙŠØ®','Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©']);
            contractLogs.forEach((l, idx) => rows.push([
                idx + 1,
                l.contract_id,
                l.action,
                l.status,
                l.user_name,
                l.created_at,
                l.note
            ]));

            const csvContent = rows.map(r => r.map(v => `"${v ?? ''}"`).join(',')).join('\n');
            downloadBlob(csvContent, 'Ø§Ù„Ø¹Ù‚ÙˆØ¯.csv', 'text/csv;charset=utf-8;');
        }

        function downloadBlob(content, filename, type) {
            const blob = new Blob([content], { type });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            link.click();
            URL.revokeObjectURL(url);
        }

        function printReport() {
            window.print();
        }

        function refreshData() {
            loadData();
        }

        document.addEventListener('DOMContentLoaded', loadData);
    </script>
</body>
</html>
