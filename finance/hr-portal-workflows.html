<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>๐งญ ุจูุงุจุฉ ุงูุนูููุงุช ูุงูุทูุจุงุช ุงูุฅุฏุงุฑูุฉ ูุงูููุงุฑุฏ ุงูุจุดุฑูุฉ - ูุธุงู ูุงููุด</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: 'Cairo', sans-serif; background-color: #f9fafb; color: #0f172a; }
        .card-glass {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
        }
        .stat-pill { border-radius: 999px; box-shadow: 0 18px 30px rgba(15, 23, 42, 0.15); }
        .stat-angled { border-radius: 28px 6px 28px 6px; }
        .stat-rounded { border-radius: 28px; }
        .stat-cut { border-radius: 6px 28px 6px 28px; }
        .table-scroll { max-height: 560px; overflow: auto; }
        .section-accent-sky { border-top: 4px solid #0ea5e9; }
        .section-accent-emerald { border-top: 4px solid #10b981; }
        .section-accent-amber { border-top: 4px solid #f59e0b; }
        .section-accent-violet { border-top: 4px solid #8b5cf6; }
        .section-accent-rose { border-top: 4px solid #f43f5e; }
        .chip { padding: 6px 12px; border-radius: 999px; font-weight: 700; }
    
        .card-gradient {
            background: linear-gradient(145deg, #ffffff, #f3f4f6);
            border: 1px solid #e2e8f0;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        .badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 999px;
            font-weight: 700;
            background: #e2e8f0;
            color: #0f172a;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-weight: 800;
            border-radius: 999px;
            padding: 10px 14px;
            transition: all 0.2s ease;
            border: 1px solid transparent;
            box-shadow: 0 10px 25px -12px rgba(0,0,0,0.25);
        }

        .btn-ghost { background: #fff; color: #0f172a; border-color: #e2e8f0; }
        .btn-ghost:hover { box-shadow: 0 14px 30px -12px rgba(15,23,42,0.3); }
        .btn-primary { background: linear-gradient(135deg, #0ea5e9, #2563eb); color: #fff; }
        .btn-success { background: linear-gradient(135deg, #10b981, #22c55e); color: #fff; }
        .btn-danger { background: linear-gradient(135deg, #f43f5e, #ef4444); color: #fff; }
        .btn-warning { background: linear-gradient(135deg, #f59e0b, #f97316); color: #fff; }

        .pill { border-radius: 12px; border: 1px dashed #e2e8f0; background: #f8fafc; }
        .input { width: 100%; padding: 10px 12px; border: 1px solid #e2e8f0; border-radius: 12px; background: #fff; }
        .input:focus { outline: 2px solid #0ea5e9; border-color: transparent; }
        .label { font-size: 12px; color: #64748b; font-weight: 700; }

        .preview-card { border: 1px dashed #cbd5e1; }
        .hidden { display: none; }

        .table-actions button { font-size: 11px; padding: 6px 10px; }

        @media (max-width: 1024px) {
            .btn { width: 100%; }
        }
    
    </style>
</head>
<body>
    <div class="container mx-auto px-4 py-8">
        <div class="mb-8 text-slate-900">
            <h1 class="text-4xl font-bold mb-2">๐งญ ุจูุงุจุฉ ุงูุนูููุงุช ูุงูุทูุจุงุช ุงูุฅุฏุงุฑูุฉ ูุงูููุงุฑุฏ ุงูุจุดุฑูุฉ</h1>
            <p class="text-lg text-slate-600">ูุงุฆูุฉ ุงูุทูุจุงุช ูุงูุนูููุงุช ูุงููุฑุงุฑุงุช ูุงูุฑูุงุชุจ ูุงูุฎุฏูุงุช (ุงูุตูุญุฉ 43)</p>
        </div>

        <div class="mb-6 flex flex-wrap gap-3">
            <button onclick="refreshData()" class="bg-white text-sky-700 border border-sky-100 shadow-sm px-6 py-3 rounded-full font-bold hover:shadow-lg transition flex items-center gap-2">
                <i class="fas fa-rotate"></i>
                ุชุญุฏูุซ ุงูุจูุงูุงุช
            </button>
            <button onclick="downloadAllJSON()" class="bg-indigo-600 text-white px-6 py-3 rounded-full font-bold hover:shadow-lg transition flex items-center gap-2">
                <i class="fas fa-file-code"></i>
                ุชูุฒูู ููู ุจูุงูุงุช ุดุงูู
            </button>
            <button onclick="downloadAllCSV()" class="bg-emerald-600 text-white px-6 py-3 rounded-full font-bold hover:shadow-lg transition flex items-center gap-2">
                <i class="fas fa-file-csv"></i>
                ุชูุฒูู ููู ุฌุฏููู ุดุงูู
            </button>
            <button onclick="printReport()" class="bg-rose-600 text-white px-6 py-3 rounded-full font-bold hover:shadow-lg transition flex items-center gap-2">
                <i class="fas fa-print"></i>
                ุทุจุงุนุฉ ุงูุชูุฑูุฑ
            </button>
        </div>

        <!-- ููุญุฉ ุงูุณูุทุฑุฉ ุงูุณุฑูุนุฉ -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 mb-6">
            <div class="card-gradient rounded-3xl p-5">
                <div class="flex items-center justify-between">
                    <div>
                        <div class="text-sm text-slate-500">ุงูููุธููู</div>
                        <div id="statEmployees" class="text-3xl font-extrabold text-slate-900">0</div>
                    </div>
                    <button class="btn btn-ghost" onclick="scrollToSection('employeesForm')">
                        <i class="fas fa-user-plus"></i>
                        ุฅุถุงูุฉ
                    </button>
                </div>
                <p class="mt-2 text-xs text-slate-500">ุชุนุฏููุ ุญุฐูุ ุฃู ูุนุงููุฉ ุฃู ููุธู ุจุดูู ูุจุงุดุฑ.</p>
            </div>
            <div class="card-gradient rounded-3xl p-5">
                <div class="flex items-center justify-between">
                    <div>
                        <div class="text-sm text-slate-500">ุทูุจุงุช ุงูููุธููู</div>
                        <div id="statRequests" class="text-3xl font-extrabold text-slate-900">0</div>
                    </div>
                    <button class="btn btn-ghost" onclick="scrollToSection('requestForm')">
                        <i class="fas fa-plus-circle"></i>
                        ุทูุจ ุฌุฏูุฏ
                    </button>
                </div>
                <p class="mt-2 text-xs text-slate-500">ุฅุถุงูุฉุ ูุชุงุจุนุฉ ุงูุญุงูุฉุ ุฃู ุฅุบูุงู ุงูุทูุจุงุช ููุฑุงู.</p>
            </div>
            <div class="card-gradient rounded-3xl p-5">
                <div class="flex items-center justify-between">
                    <div>
                        <div class="text-sm text-slate-500">ุฃููุงุน ุงูุทูุจุงุช</div>
                        <div id="statTypes" class="text-3xl font-extrabold text-slate-900">0</div>
                    </div>
                    <button class="btn btn-ghost" onclick="scrollToSection('typeForm')">
                        <i class="fas fa-layer-group"></i>
                        ููุน ุฌุฏูุฏ
                    </button>
                </div>
                <p class="mt-2 text-xs text-slate-500">ุชูุนูู ุฃู ุชุฎุตูุต ุงูุฃููุงุน ูุชูุงุณุจ ูู ุณููุงุฑูู.</p>
            </div>
        </div>

        <!-- ูุฑุงูุฒ ุงูุฅุฏุงุฑุฉ ุงูุณุฑูุนุฉ -->
        <div class="card-glass rounded-3xl shadow-2xl p-6 mb-10 section-accent-amber" id="controlCenter">
            <div class="flex items-center justify-between mb-6">
                <div>
                    <h2 class="text-2xl font-bold text-slate-800">โก ุฅุฏุงุฑุฉ ููุฑูุฉ ุฌุงูุฒุฉ ููุนูู</h2>
                    <p class="text-sm text-slate-500">ูู ุฅุถุงูุฉ ุฃู ุชุนุฏูู ููุญูุธ ูุจุงุดุฑุฉ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช ุงูุญุงููุฉ.</p>
                </div>
                <div id="dataStatus" class="badge">ุฌุงูุฒ</div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
                <!-- ูููุฐุฌ ุทูุจ ููุธู -->
                <form id="requestForm" class="card-gradient rounded-2xl p-4 space-y-3" onsubmit="handleRequestSubmit(event)">
                    <div class="flex items-center justify-between">
                        <div>
                            <div class="text-sm text-slate-500">ุชุณุฌูู ุทูุจ</div>
                            <h3 class="text-lg font-bold text-slate-800">๐ ุทูุจ ููุธู</h3>
                        </div>
                        <button type="button" class="btn btn-ghost" onclick="resetRequestForm()">ุฌุฏูุฏ</button>
                    </div>
                    <input type="hidden" id="requestId">
                    <div class="space-y-2">
                        <label class="label" for="requestEmployee">ุงูููุธู</label>
                        <select id="requestEmployee" class="input"></select>
                    </div>
                    <div class="space-y-2">
                        <label class="label" for="requestEmployeeName">ุงุณู ุงูููุธู (ููุชุนุฏูู ุงููุฏูู)</label>
                        <input id="requestEmployeeName" class="input" placeholder="ูุซุงู: ุฃุญูุฏ ุงูุนุชูุจู">
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <div class="space-y-2">
                            <label class="label" for="requestType">ููุน ุงูุทูุจ</label>
                            <select id="requestType" class="input"></select>
                        </div>
                        <div class="space-y-2">
                            <label class="label" for="requestPriority">ุงูุฃููููุฉ</label>
                            <select id="requestPriority" class="input">
                                <option value="HIGH">ุนุงุฌู</option>
                                <option value="NORMAL" selected>ุนุงุฏู</option>
                                <option value="LOW">ููุฎูุถ</option>
                            </select>
                        </div>
                    </div>
                    <div class="space-y-2">
                        <label class="label" for="requestTitle">ุนููุงู ุงูุทูุจ</label>
                        <input id="requestTitle" class="input" placeholder="ุทูุจ ุฅุฌุงุฒุฉ ุณูููุฉ" required>
                    </div>
                    <div class="grid grid-cols-3 gap-3">
                        <div class="space-y-2">
                            <label class="label" for="requestedDate">ุชุงุฑูุฎ ุงูุทูุจ</label>
                            <input type="date" id="requestedDate" class="input">
                        </div>
                        <div class="space-y-2">
                            <label class="label" for="startDate">ุจุฏุงูุฉ ุงูุชูููุฐ</label>
                            <input type="date" id="startDate" class="input">
                        </div>
                        <div class="space-y-2">
                            <label class="label" for="endDate">ููุงูุฉ ุงูุชูููุฐ</label>
                            <input type="date" id="endDate" class="input">
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <div class="space-y-2">
                            <label class="label" for="requestStatus">ุงูุญุงูุฉ</label>
                            <select id="requestStatus" class="input">
                                <option value="PENDING">ููุฏ ุงููุนุงูุฌุฉ</option>
                                <option value="IN_PROGRESS">ููุฏ ุงูุชูููุฐ</option>
                                <option value="APPROVED">ูุนุชูุฏ</option>
                                <option value="COMPLETED">ููุชูู</option>
                                <option value="REJECTED">ูุฑููุถ</option>
                            </select>
                        </div>
                        <div class="space-y-2">
                            <label class="label" for="requestRequiresApproval">ุงูููุงููุฉ ูุทููุจุฉ</label>
                            <div class="pill px-3 py-2 flex items-center justify-between">
                                <span class="text-xs text-slate-600">ุชูุนูู ุณูุฑ ุงูุงุนุชูุงุฏ</span>
                                <input id="requestRequiresApproval" type="checkbox" class="h-4 w-4" checked>
                            </div>
                        </div>
                    </div>
                    <div class="space-y-2">
                        <label class="label" for="requestNotes">ููุงุญุธุงุช</label>
                        <textarea id="requestNotes" class="input" rows="2" placeholder="ุชูุงุตูู ุฃู ูุฑููุงุช ูุงูุฉ"></textarea>
                    </div>
                    <div class="flex flex-wrap gap-2 pt-2">
                        <button type="submit" class="btn btn-primary w-full lg:w-auto"><i class="fas fa-save"></i> ุญูุธ ุงูุทูุจ</button>
                        <button type="button" class="btn btn-warning w-full lg:w-auto" onclick="resetRequestForm()"><i class="fas fa-eraser"></i> ุชูุฑูุบ ุงูุญููู</button>
                    </div>
                </form>

                <!-- ูููุฐุฌ ุงูููุธู -->
                <form id="employeesForm" class="card-gradient rounded-2xl p-4 space-y-3" onsubmit="handleEmployeeSubmit(event)">
                    <div class="flex items-center justify-between">
                        <div>
                            <div class="text-sm text-slate-500">ุชุณุฌูู ููุธู</div>
                            <h3 class="text-lg font-bold text-slate-800">๐ค ุจูุงูุงุช ููุธู</h3>
                        </div>
                        <button type="button" class="btn btn-ghost" onclick="resetEmployeeForm()">ุฌุฏูุฏ</button>
                    </div>
                    <input type="hidden" id="employeeId">
                    <div class="grid grid-cols-2 gap-3">
                        <div class="space-y-2">
                            <label class="label" for="employeeNumber">ุฑูู ุงูููุธู</label>
                            <input id="employeeNumber" class="input" required>
                        </div>
                        <div class="space-y-2">
                            <label class="label" for="employeeName">ุงูุงุณู ุงููุงูู</label>
                            <input id="employeeName" class="input" required placeholder="ูุซุงู: ุณุงุฑุฉ ุงูุนุชูุจู">
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <div class="space-y-2">
                            <label class="label" for="employeeEmail">ุงูุจุฑูุฏ ุงูุฅููุชุฑููู</label>
                            <input id="employeeEmail" class="input" placeholder="name@example.com">
                        </div>
                        <div class="space-y-2">
                            <label class="label" for="employeeEntity">ุงูููุดุฃุฉ / ุงููุฑุน</label>
                            <select id="employeeEntity" class="input"></select>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <div class="space-y-2">
                            <label class="label" for="employeePosition">ุงูููุตุจ</label>
                            <input id="employeePosition" class="input" placeholder="ูุซุงู: ุฃุฎุตุงุฆู ููุงุฑุฏ ุจุดุฑูุฉ">
                        </div>
                        <div class="space-y-2">
                            <label class="label" for="employeeDepartment">ุงููุณู</label>
                            <input id="employeeDepartment" class="input" placeholder="ุงูููุงุฑุฏ ุงูุจุดุฑูุฉ">
                        </div>
                    </div>
                    <div class="grid grid-cols-3 gap-3">
                        <div class="space-y-2">
                            <label class="label" for="hireDate">ุชุงุฑูุฎ ุงูุชุนููู</label>
                            <input type="date" id="hireDate" class="input">
                        </div>
                        <div class="space-y-2">
                            <label class="label" for="salary">ุงูุฑุงุชุจ</label>
                            <input type="number" id="salary" class="input" step="0.01" min="0">
                        </div>
                        <div class="space-y-2">
                            <label class="label" for="employmentType">ููุน ุงูุชูุธูู</label>
                            <select id="employmentType" class="input">
                                <option value="FULL_TIME">ุฏูุงู ูุงูู</option>
                                <option value="PART_TIME">ุฏูุงู ุฌุฒุฆู</option>
                                <option value="CONTRACT">ุชุนุงูุฏ</option>
                                <option value="TEMPORARY">ูุคูุช</option>
                                <option value="INTERN">ุชุฏุฑูุจ</option>
                            </select>
                        </div>
                    </div>
                    <div class="pill px-3 py-2 flex items-center justify-between">
                        <span class="text-xs text-slate-600">ุงูููุธู ูุดุท ููุธูุฑ ูู ุงูุฌุฏุงูู</span>
                        <input id="employeeActive" type="checkbox" class="h-4 w-4" checked>
                    </div>
                    <div class="flex flex-wrap gap-2 pt-2">
                        <button type="submit" class="btn btn-success w-full lg:w-auto"><i class="fas fa-save"></i> ุญูุธ ุงูููุธู</button>
                        <button type="button" class="btn btn-warning w-full lg:w-auto" onclick="resetEmployeeForm()"><i class="fas fa-eraser"></i> ุชูุฑูุบ ุงูุญููู</button>
                    </div>
                </form>

                <!-- ูููุฐุฌ ููุน ุงูุทูุจ -->
                <form id="typeForm" class="card-gradient rounded-2xl p-4 space-y-3" onsubmit="handleTypeSubmit(event)">
                    <div class="flex items-center justify-between">
                        <div>
                            <div class="text-sm text-slate-500">ุชููุฆุฉ ุงูุฃููุงุน</div>
                            <h3 class="text-lg font-bold text-slate-800">๐ ููุน ุทูุจ</h3>
                        </div>
                        <button type="button" class="btn btn-ghost" onclick="resetTypeForm()">ุฌุฏูุฏ</button>
                    </div>
                    <input type="hidden" id="typeId">
                    <div class="grid grid-cols-2 gap-3">
                        <div class="space-y-2">
                            <label class="label" for="typeCode">ููุฏ ุงูููุน</label>
                            <input id="typeCode" class="input" required placeholder="vacation_request">
                        </div>
                        <div class="space-y-2">
                            <label class="label" for="typeNameAr">ุงุณู ุนุฑุจู</label>
                            <input id="typeNameAr" class="input" required placeholder="ุทูุจ ุฅุฌุงุฒุฉ">
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <div class="space-y-2">
                            <label class="label" for="typeCategory">ุงููุฆุฉ</label>
                            <select id="typeCategory" class="input">
                                <option value="hr">ุงูููุงุฑุฏ ุงูุจุดุฑูุฉ</option>
                                <option value="admin">ุฅุฏุงุฑู</option>
                                <option value="financial">ูุงูู</option>
                                <option value="training">ุชุฏุฑูุจ</option>
                                <option value="travel">ุณูุฑ</option>
                                <option value="procurement">ูุดุชุฑูุงุช</option>
                                <option value="general" selected>ุนุงู</option>
                            </select>
                        </div>
                        <div class="space-y-2">
                            <label class="label" for="typeOrder">ุฃููููุฉ ุงูุนุฑุถ</label>
                            <input type="number" id="typeOrder" class="input" min="0" value="0">
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <div class="pill px-3 py-2 flex items-center justify-between">
                            <span class="text-xs text-slate-600">ุงูููุน ูุดุท</span>
                            <input id="typeActive" type="checkbox" class="h-4 w-4" checked>
                        </div>
                        <div class="pill px-3 py-2 flex items-center justify-between">
                            <span class="text-xs text-slate-600">ูุญุชุงุฌ ููุงููุฉ</span>
                            <input id="typeNeedsApproval" type="checkbox" class="h-4 w-4" checked>
                        </div>
                    </div>
                    <div class="space-y-2">
                        <label class="label" for="typeDescription">ูุตู</label>
                        <textarea id="typeDescription" class="input" rows="3" placeholder="ุชูุงุตูู ูุจุณุทุฉ ุชุธูุฑ ูููุณุชุฎุฏู"></textarea>
                    </div>
                    <div class="flex flex-wrap gap-2 pt-2">
                        <button type="submit" class="btn btn-primary w-full lg:w-auto"><i class="fas fa-save"></i> ุญูุธ ุงูููุน</button>
                        <button type="button" class="btn btn-warning w-full lg:w-auto" onclick="resetTypeForm()"><i class="fas fa-eraser"></i> ุชูุฑูุบ ุงูุญููู</button>
                    </div>
                </form>
            </div>
        </div>

        <div id="previewPanel" class="card-glass preview-card rounded-3xl shadow-2xl p-6 mb-10 hidden">
            <div class="flex items-center justify-between mb-4">
                <div>
                    <div class="text-sm text-slate-500">ูุนุงููุฉ ุณุฑูุนุฉ</div>
                    <h3 id="previewTitle" class="text-xl font-bold text-slate-800"></h3>
                </div>
                <button class="btn btn-ghost" onclick="hidePreview()"><i class="fas fa-times"></i> ุฅุบูุงู</button>
            </div>
            <div id="previewBody" class="grid grid-cols-1 md:grid-cols-2 gap-3 text-sm"></div>
        </div>

        <!-- Requests & Forms -->
        <div class="card-glass rounded-3xl shadow-2xl p-6 mb-8 section-accent-sky">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-2xl font-bold text-slate-800">๐งพ ุงูุทูุจุงุช ูุงูููุงุฐุฌ</h2>
                <div class="text-sm text-slate-500">ูููุฐุฌ ูุจุงุดุฑ ููุทูุจุงุช ุงูุฃุณุงุณูุฉ</div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 text-sm">
                <div class="stat-pill bg-sky-50 p-4 text-slate-700">ุทูุจ ูุจุงุดุฑุฉ ุนูู</div>
                <div class="stat-angled bg-emerald-50 p-4 text-slate-700">ุทูุจ ุนูุฏุฉ</div>
                <div class="stat-rounded bg-indigo-50 p-4 text-slate-700">ุทูุจ ุจุฏูุงุช ุงูุฅุฌุงุฒุฉ</div>
                <div class="stat-cut bg-rose-50 p-4 text-slate-700">ุทูุจ ุฅุฌุงุฒุฉ</div>
                <div class="stat-pill bg-amber-50 p-4 text-slate-700">ุทูุจ ุชุนุฑูู ุจุงูุฑุงุชุจ</div>
                <div class="stat-angled bg-violet-50 p-4 text-slate-700">ุทูุจ ููุฏุงู ุจุตูุฉ</div>
                <div class="stat-rounded bg-sky-50 p-4 text-slate-700">ุทูุจ ุงุณุชุฆุฐุงู</div>
                <div class="stat-cut bg-emerald-50 p-4 text-slate-700">ุทูุจ ุชุนุฏูู ูุชุฑุฉ ุงูุนูู</div>
                <div class="stat-pill bg-indigo-50 p-4 text-slate-700">ุทูุจ ุฏูุงู ุฅุถุงูู</div>
                <div class="stat-angled bg-rose-50 p-4 text-slate-700">ุทูุจ ุชุฐุงูุฑ ุณูุฑ</div>
                <div class="stat-rounded bg-amber-50 p-4 text-slate-700">ุทูุจ ุงูุชุฏุงุจ</div>
                <div class="stat-cut bg-violet-50 p-4 text-slate-700">ุทูุจ ุชุนุฏูู ุจูุงูุงุช ุงูููุธู</div>
                <div class="stat-pill bg-sky-50 p-4 text-slate-700">ุทูุจ ูุดุชุฑูุงุช</div>
                <div class="stat-angled bg-emerald-50 p-4 text-slate-700">ุทูุจ ุณููุฉ</div>
                <div class="stat-rounded bg-indigo-50 p-4 text-slate-700">ุทูุจ ุตุฑู ูุฎุตุต</div>
                <div class="stat-cut bg-rose-50 p-4 text-slate-700">ุทูุจ ุฏูุงู ุฎุงุฑุฌ ุงูููุชุจ</div>
                <div class="stat-pill bg-amber-50 p-4 text-slate-700">ุทูุจ ุฏูุฑุฉ ุชุฏุฑูุจูุฉ</div>
                <div class="stat-angled bg-violet-50 p-4 text-slate-700">ุทูุจ ุงุณุชูุงูุฉ</div>
                <div class="stat-rounded bg-sky-50 p-4 text-slate-700">ุทูุจ ุดููู</div>
                <div class="stat-cut bg-emerald-50 p-4 text-slate-700">ุทูุจ ุชูุธูู</div>
                <div class="stat-pill bg-indigo-50 p-4 text-slate-700">ุทูุจ ุชุซุจูุช ุงูุฑุงุชุจ</div>
                <div class="stat-angled bg-rose-50 p-4 text-slate-700">ุทูุจ ุชุจุฏูู ููู ุฑุงุญุฉ</div>
            </div>
        </div>

        <!-- Employee Zone -->
        <div class="card-glass rounded-3xl shadow-2xl p-6 mb-8 section-accent-emerald">
            <h2 class="text-2xl font-bold text-slate-800 mb-4">๐ค ุงูููุธู</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 text-sm">
                <div class="stat-rounded bg-emerald-50 p-4">ุงูุญุถูุฑ ูุงูุงูุตุฑุงู</div>
                <div class="stat-angled bg-sky-50 p-4">ุงูุทูุจุงุช</div>
                <div class="stat-pill bg-indigo-50 p-4">ุงูุฅุฌุงุฒุงุช</div>
                <div class="stat-cut bg-rose-50 p-4">ุฑุตูุฏ ุงูุฅุฌุงุฒุงุช</div>
                <div class="stat-rounded bg-amber-50 p-4">ุงูุฅุดุนุงุฑุงุช ูุงูุฅูุฐุงุฑุงุช</div>
                <div class="stat-angled bg-violet-50 p-4">ุงููุฑุงุฑุงุช</div>
                <div class="stat-pill bg-sky-50 p-4">ูุฎุงููุงุช ุฃูุธูุฉ ุงูุดุฑูุฉ</div>
                <div class="stat-cut bg-emerald-50 p-4">ููุงุฐุฌ ุงูุชูููู</div>
                <div class="stat-rounded bg-indigo-50 p-4">ุงูุชุนุงููู</div>
                <div class="stat-angled bg-rose-50 p-4">ุงูุณูู ูุงูุฐูู</div>
                <div class="stat-pill bg-amber-50 p-4">ุงูุงุณุชุจูุงูุงุช</div>
                <div class="stat-cut bg-violet-50 p-4">ุฃูุดุทุฉ ุงูุฃุนูุงู</div>
                <div class="stat-rounded bg-sky-50 p-4">ุงูุฎุทุงุจุงุช</div>
                <div class="stat-angled bg-emerald-50 p-4">ุงูุนูุฏ</div>
                <div class="stat-pill bg-indigo-50 p-4">ูุณุงุฆู ุงูุฑุงุชุจ</div>
            </div>
        </div>

        <!-- Manager Zone -->
        <div class="card-glass rounded-3xl shadow-2xl p-6 mb-8 section-accent-amber">
            <h2 class="text-2xl font-bold text-slate-800 mb-4">๐ ุงููุฏูุฑ</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 text-sm">
                <div class="stat-pill bg-amber-50 p-4">ุงูุญุถูุฑ ูุงูุงูุตุฑุงู</div>
                <div class="stat-rounded bg-sky-50 p-4">ุทูุจุงุช ุงููุฑุคูุณูู</div>
                <div class="stat-angled bg-emerald-50 p-4">ุฅุดุนุงุฑุงุช ุงููุฑุคูุณูู</div>
                <div class="stat-cut bg-indigo-50 p-4">ุฎุทุฉ ุงูุฅุฌุงุฒุงุช</div>
                <div class="stat-pill bg-rose-50 p-4">ุฅุณูุงุฏ ุทูุจ</div>
                <div class="stat-rounded bg-violet-50 p-4">ููุงุฐุฌ ุชูููู ุงููุฑุคูุณูู</div>
                <div class="stat-angled bg-amber-50 p-4">ูุงุฆูุฉ ุงููุฑุคูุณูู</div>
            </div>
        </div>

        <!-- Pending Operations -->
        <div class="card-glass rounded-3xl shadow-2xl p-6 mb-8 section-accent-violet">
            <h2 class="text-2xl font-bold text-slate-800 mb-4">โณ ุนูููุงุช ุจุงูุชุธุงุฑ ุฅุฌุฑุงุก</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 text-sm">
                <div class="stat-rounded bg-violet-50 p-4">ุนูููุงุช ุจุงูุชุธุงุฑ ุฅุฌุฑุงุก</div>
                <div class="stat-angled bg-sky-50 p-4">ุทูุจุงุช ุจุงูุชุธุงุฑ ุฅุฌุฑุงุก</div>
                <div class="stat-pill bg-emerald-50 p-4">ูุฑุงุฑุงุช ุจุงูุชุธุงุฑ ุฅุฌุฑุงุก</div>
                <div class="stat-cut bg-rose-50 p-4">ูุตุฑููุงุช ุจุงูุชุธุงุฑ ุฅุฌุฑุงุก</div>
            </div>
        </div>

        <!-- HR Zone -->
        <div class="card-glass rounded-3xl shadow-2xl p-6 mb-8 section-accent-rose">
            <h2 class="text-2xl font-bold text-slate-800 mb-4">๐งฉ ุงูููุงุฑุฏ ุงูุจุดุฑูุฉ</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 text-sm">
                <div class="stat-rounded bg-rose-50 p-4">ุงูููุธููู</div>
                <div class="stat-angled bg-amber-50 p-4">ุงููููู ุงูุชูุธููู</div>
                <div class="stat-pill bg-emerald-50 p-4">ุงููููู ุงูุชูุธููู ููููุธููู</div>
                <div class="stat-cut bg-sky-50 p-4">ุงููููู ุงูุชูุธููู ููุฅุฏุงุฑุงุช</div>
                <div class="stat-rounded bg-indigo-50 p-4">ุงููุฎุตุตุงุช</div>
            </div>
        </div>

        <!-- Decisions & Payroll -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
            <div class="card-glass rounded-3xl shadow-2xl p-6 section-accent-indigo">
                <h2 class="text-2xl font-bold text-slate-800 mb-4">๐ ุงููุฑุงุฑุงุช</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3 text-sm">
                    <div class="stat-rounded bg-indigo-50 p-4">ุฅููุงุก ุฎุฏูุงุช ุงูููุธู</div>
                    <div class="stat-angled bg-emerald-50 p-4">ุฅููุงู ุฑุงุชุจ ููุธู</div>
                    <div class="stat-pill bg-rose-50 p-4">ุชุนุฏูู ุฑุงุชุจ</div>
                    <div class="stat-cut bg-amber-50 p-4">ูุฑุงุฑ ุชุฑููุฉ</div>
                    <div class="stat-rounded bg-sky-50 p-4">ุงุนุชูุงุฏ ูุณูุฑ ุงูุฑูุงุชุจ</div>
                    <div class="stat-angled bg-violet-50 p-4">ูุฑุงุฑ ุญุณู ุบูุงุจ ูุชุฃุฎูุฑ</div>
                    <div class="stat-pill bg-emerald-50 p-4">ูุฑุงุฑ ููู ููุธู</div>
                    <div class="stat-cut bg-indigo-50 p-4">ุฌููุน ุงููุฑุงุฑุงุช</div>
                </div>
            </div>
            <div class="card-glass rounded-3xl shadow-2xl p-6 section-accent-emerald">
                <h2 class="text-2xl font-bold text-slate-800 mb-4">๐ฐ ุงูุฑูุงุชุจ ูุงููุตุฑููุงุช</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3 text-sm">
                    <div class="stat-rounded bg-emerald-50 p-4">ูุณูุฑุงุช ุงูุฑูุงุชุจ</div>
                    <div class="stat-angled bg-rose-50 p-4">ุงูุญุณููุงุช</div>
                    <div class="stat-pill bg-amber-50 p-4">ุญุณููุงุช ูุชูุฑุฑุฉ</div>
                    <div class="stat-cut bg-sky-50 p-4">ุงูุฅุถุงูุงุช</div>
                    <div class="stat-rounded bg-violet-50 p-4">ุฅุถุงูุงุช ูุชูุฑุฑุฉ</div>
                    <div class="stat-angled bg-indigo-50 p-4">ุงูุณูู ูุงูุฐูู</div>
                    <div class="stat-pill bg-emerald-50 p-4">ุงููุตุฑููุงุช</div>
                </div>
            </div>
        </div>

        <!-- Government Services & Visas -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
            <div class="card-glass rounded-3xl shadow-2xl p-6 section-accent-sky">
                <h2 class="text-2xl font-bold text-slate-800 mb-4">๐๏ธ ุงูุฎุฏูุงุช ุงูุญููููุฉ</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3 text-sm">
                    <div class="stat-rounded bg-sky-50 p-4">ุงูุชุฃูููุงุช ุงูุงุฌุชูุงุนูุฉ</div>
                    <div class="stat-angled bg-emerald-50 p-4">ุฎุฏูุงุช ูููู</div>
                </div>
            </div>
            <div class="card-glass rounded-3xl shadow-2xl p-6 section-accent-amber">
                <h2 class="text-2xl font-bold text-slate-800 mb-4">๐ ุชุฃุดูุฑุงุช ุงูุฎุฑูุฌ ูุงูุนูุฏุฉ</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3 text-sm">
                    <div class="stat-pill bg-amber-50 p-4">ุฅุตุฏุงุฑ</div>
                    <div class="stat-rounded bg-rose-50 p-4">ุฅูุบุงุก</div>
                    <div class="stat-angled bg-sky-50 p-4">ุฅุนุงุฏุฉ ุทุจุงุนุฉ ุชุฃุดูุฑุฉ ุฎุฑูุฌ ูุนูุฏุฉ</div>
                    <div class="stat-cut bg-emerald-50 p-4">ุชุฃุดูุฑุงุช ุงูุฎุฑูุฌ ุงูููุงุฆู</div>
                    <div class="stat-pill bg-violet-50 p-4">ุฅุตุฏุงุฑ</div>
                    <div class="stat-rounded bg-indigo-50 p-4">ุฅูุบุงุก</div>
                    <div class="stat-angled bg-amber-50 p-4">ุฎุฏูุงุช ุงูุฌูุงุฒ</div>
                    <div class="stat-cut bg-rose-50 p-4">ุชุฌุฏูุฏ ุงูุฅูุงูุฉ</div>
                    <div class="stat-pill bg-sky-50 p-4">ุณุฌู ุงูุนูููุงุช</div>
                </div>
            </div>
        </div>

        <!-- Training & Notifications -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
            <div class="card-glass rounded-3xl shadow-2xl p-6 section-accent-violet">
                <h2 class="text-2xl font-bold text-slate-800 mb-4">๐ ุงูุชุฏุฑูุจ ูุงูุชุทููุฑ</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3 text-sm">
                    <div class="stat-rounded bg-violet-50 p-4">ุงูุฃุฏุงุก ูุงูุชูููู</div>
                    <div class="stat-angled bg-emerald-50 p-4">ุงูุฏูุฑุงุช ุงูุชุฏุฑูุจูุฉ</div>
                    <div class="stat-pill bg-amber-50 p-4">ูุฌูุฉ ุงูููุงุฑุงุช</div>
                    <div class="stat-cut bg-sky-50 p-4">ุงูุชุนุงูุจ ุงููุธููู</div>
                </div>
            </div>
            <div class="card-glass rounded-3xl shadow-2xl p-6 section-accent-rose">
                <h2 class="text-2xl font-bold text-slate-800 mb-4">๐ ุงูุชุนุงููู ูุงูุฅุดุนุงุฑุงุช</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3 text-sm">
                    <div class="stat-rounded bg-rose-50 p-4">ุงูุฅุดุนุงุฑุงุช</div>
                    <div class="stat-angled bg-amber-50 p-4">ุงูุฅูุฐุงุฑุงุช</div>
                    <div class="stat-pill bg-emerald-50 p-4">ุงูุชุนุงููู</div>
                </div>
            </div>
        </div>

        <!-- Policies & Recruitment -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
            <div class="card-glass rounded-3xl shadow-2xl p-6 section-accent-indigo">
                <h2 class="text-2xl font-bold text-slate-800 mb-4">๐ ุงูุณูุงุณุงุช</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3 text-sm">
                    <div class="stat-rounded bg-indigo-50 p-4">ุนุฑุถ ุงูุณูุงุณุงุช</div>
                    <div class="stat-angled bg-sky-50 p-4">ุฅุฏุงุฑุฉ ุงูุณูุงุณุงุช</div>
                </div>
            </div>
            <div class="card-glass rounded-3xl shadow-2xl p-6 section-accent-emerald">
                <h2 class="text-2xl font-bold text-slate-800 mb-4">๐ฅ ุงูุชูุธูู</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3 text-sm">
                    <div class="stat-rounded bg-emerald-50 p-4">ูุงุฆูุฉ ุงููุธุงุฆู</div>
                    <div class="stat-angled bg-amber-50 p-4">ุฅุถุงูุฉ ุดุงุบุฑ ูุธููู</div>
                    <div class="stat-pill bg-rose-50 p-4">ุชูููู ุงูููุงุจูุงุช ุงูุดุฎุตูุฉ</div>
                    <div class="stat-cut bg-sky-50 p-4">ุจูุงุจุฉ ุงูุชูุธูู</div>
                </div>
            </div>
        </div>

        <!-- Reports & Self Services -->
        <div class="card-glass rounded-3xl shadow-2xl p-6 mb-8 section-accent-sky">
            <h2 class="text-2xl font-bold text-slate-800 mb-4">๐ ุงูุชูุงุฑูุฑ ูุงูุฎุฏูุงุช ุงูุฐุงุชูุฉ</h2>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 text-sm">
                <div class="bg-slate-50 rounded-2xl p-5">
                    <h3 class="font-bold text-slate-800 mb-3">ุชูุงุฑูุฑ ูุงููุฉ</h3>
                    <ul class="space-y-2 text-slate-700">
                        <li>ุชูุฑูุฑ ุงูุญุณููุงุช ูุงูุฅุถุงูุงุช</li>
                        <li>ุชูุฑูุฑ ููุงูุฉ ุงูุฎุฏูุฉ</li>
                        <li>ุชูุฑูุฑ ูุฎุตุตุงุช ููุงูุฉ ุงูุฎุฏูุฉ</li>
                        <li>ุชูุฑูุฑ ูุณูุฑุงุช ุงูุฑูุงุชุจ</li>
                        <li>ุชูุฑูุฑ ุงููุฑููุงุช ุจูู ูุณูุฑุงุช ุงูุฑูุงุชุจ</li>
                        <li>ุชูุฑูุฑ ุงูุณูู ูุงูุฐูู</li>
                        <li>ุชูุฑูุฑ ุงููุตุฑููุงุช</li>
                    </ul>
                </div>
                <div class="bg-slate-50 rounded-2xl p-5">
                    <h3 class="font-bold text-slate-800 mb-3">ุงูุฎุฏูุงุช ุงูุฐุงุชูุฉ</h3>
                    <ul class="space-y-2 text-slate-700">
                        <li>ุชูุฑูุฑ ุงูุทูุจุงุช</li>
                        <li>ุชูุฑูุฑ ุทูุจุงุช ุงูุดุฑุงุก</li>
                        <li>ุชูุฑูุฑ ุงููุชูุฏููู</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Home Dashboard Note -->
        <div class="card-glass rounded-3xl shadow-2xl p-6 mb-8 section-accent-rose">
            <h2 class="text-2xl font-bold text-slate-800 mb-4">๐ ุงูุฑุฆูุณูุฉ</h2>
            <div class="bg-rose-50 rounded-2xl p-5 text-slate-700">
                ูู ุชูู ุจุฅุถุงูุฉ ุฃู ุนูุตุฑ ูููุญุฉ ุงูููุงุฏุฉ. ุจุฅููุงูู ุฅุถุงูุฉ ุนูุงุตุฑ ูููุญุฉ ุงูููุงุฏุฉ ูู ุฎูุงู ุงูุถุบุท ุนูู ุฒุฑ ุงูุฅุถุงูุฉ ุฃุนูู ุงูุดุงุดุฉ.
                ุนูุงุตุฑ ููุญุฉ ุงูููุงุฏุฉ ุชุนุทู ุฅุญุตุงุฆูุงุช ูุฃุฑูุงู ูุนุฏุฉ ููุงุถูุนุ ุชุณุงุนุฏ ูู ุฑูุน ุงูุฃุฏุงุก ูุชููุฑ ุงูููุช ูุงููุฌููุฏ.
            </div>
        </div>

        <!-- Data Tables -->
        <div class="card-glass rounded-3xl shadow-2xl p-6 mb-8 section-accent-emerald">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-xl font-bold text-slate-800">๐ฅ ุฌุฏูู ุงูููุธููู</h3>
                <span id="employeesCount" class="text-sm text-slate-500"></span>
            </div>
            <div class="table-scroll">
                <table class="w-full text-xs">
                    <thead class="bg-emerald-50 text-emerald-700">
                        <tr>
                            <th class="px-3 py-2 text-right">ุฑูู ุงูููุธู</th>
                            <th class="px-3 py-2 text-right">ุงูุงุณู</th>
                            <th class="px-3 py-2 text-right">ุงูุจุฑูุฏ</th>
                            <th class="px-3 py-2 text-right">ุงูููุตุจ</th>
                            <th class="px-3 py-2 text-right">ุงููุณู</th>
                            <th class="px-3 py-2 text-right">ุงูููุดุฃุฉ</th>
                            <th class="px-3 py-2 text-right">ุชุงุฑูุฎ ุงูุชุนููู</th>
                            <th class="px-3 py-2 text-right">ุงูุฑุงุชุจ</th>
                            <th class="px-3 py-2 text-right">ููุน ุงูุชูุธูู</th>
                            <th class="px-3 py-2 text-right">ุงูุญุงูุฉ</th>
                            <th class="px-3 py-2 text-right">ุฅุฌุฑุงุกุงุช</th>
                        </tr>
                    </thead>
                    <tbody id="employeesTable" class="divide-y divide-slate-100">
                        <tr>
                            <td colspan="11" class="px-4 py-12 text-center text-slate-500">ุฌุงุฑู ุชุญููู ุงูุจูุงูุงุช...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="card-glass rounded-3xl shadow-2xl p-6 mb-8 section-accent-violet">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-xl font-bold text-slate-800">๐จ ุฌุฏูู ุทูุจุงุช ุงูููุธููู</h3>
                <span id="requestsCount" class="text-sm text-slate-500"></span>
            </div>
            <div class="table-scroll">
                <table class="w-full text-xs">
                    <thead class="bg-violet-50 text-violet-700">
                        <tr>
                            <th class="px-3 py-2 text-right">ุฑูู ุงูุทูุจ</th>
                            <th class="px-3 py-2 text-right">ุงูููุธู</th>
                            <th class="px-3 py-2 text-right">ููุน ุงูุทูุจ</th>
                            <th class="px-3 py-2 text-right">ุงูุนููุงู</th>
                            <th class="px-3 py-2 text-right">ุงูุฃููููุฉ</th>
                            <th class="px-3 py-2 text-right">ุงูุญุงูุฉ</th>
                            <th class="px-3 py-2 text-right">ุชุงุฑูุฎ ุงูุทูุจ</th>
                            <th class="px-3 py-2 text-right">ุงูููุงููุฉ ูุทููุจุฉ</th>
                            <th class="px-3 py-2 text-right">ููุงุญุธุงุช</th>
                            <th class="px-3 py-2 text-right">ุชุงุฑูุฎ ุงูุฅูุดุงุก</th>
                            <th class="px-3 py-2 text-right">ุฅุฌุฑุงุกุงุช</th>
                        </tr>
                    </thead>
                    <tbody id="requestsTable" class="divide-y divide-slate-100">
                        <tr>
                            <td colspan="11" class="px-4 py-12 text-center text-slate-500">ุฌุงุฑู ุชุญููู ุงูุจูุงูุงุช...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="card-glass rounded-3xl shadow-2xl p-6 section-accent-rose">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-xl font-bold text-slate-800">๐ ุฌุฏูู ุฃููุงุน ุงูุทูุจุงุช</h3>
                <span id="typesCount" class="text-sm text-slate-500"></span>
            </div>
            <div class="table-scroll">
                <table class="w-full text-xs">
                    <thead class="bg-rose-50 text-rose-700">
                        <tr>
                            <th class="px-3 py-2 text-right">ุฑูู ุงูููุน</th>
                            <th class="px-3 py-2 text-right">ุงูุงุณู</th>
                            <th class="px-3 py-2 text-right">ุงููุฆุฉ</th>
                            <th class="px-3 py-2 text-right">ุงููุตู</th>
                            <th class="px-3 py-2 text-right">ูุชุทูุจ ููุงููุฉ</th>
                            <th class="px-3 py-2 text-right">ูุชุทูุจ ูุฏูุฑ</th>
                            <th class="px-3 py-2 text-right">ูุชุทูุจ ููุงุฑุฏ ุจุดุฑูุฉ</th>
                            <th class="px-3 py-2 text-right">ุงูุญุงูุฉ</th>
                            <th class="px-3 py-2 text-right">ุฅุฌุฑุงุกุงุช</th>
                        </tr>
                    </thead>
                    <tbody id="typesTable" class="divide-y divide-slate-100">
                        <tr>
                            <td colspan="9" class="px-4 py-12 text-center text-slate-500">ุฌุงุฑู ุชุญููู ุงูุจูุงูุงุช...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = window.location.origin;

        let employees = [];
        let requests = [];
        let requestTypes = [];
        let branches = [];
        let headquarters = [];

        const dataStatus = document.getElementById('dataStatus');
        const previewPanel = document.getElementById('previewPanel');
        const previewBody = document.getElementById('previewBody');
        const previewTitle = document.getElementById('previewTitle');

        document.addEventListener('DOMContentLoaded', () => {
            attachFormListeners();
            loadData();
        });

        function attachFormListeners() {
            const employeeSelect = document.getElementById('requestEmployee');
            if (employeeSelect) {
                employeeSelect.addEventListener('change', syncEmployeeName);
            }
        }

        function setStatus(text, tone = 'info') {
            if (!dataStatus) return;
            const palette = {
                info: { bg: '#eef2ff', color: '#3730a3', border: '#c7d2fe' },
                success: { bg: '#ecfdf3', color: '#15803d', border: '#bbf7d0' },
                danger: { bg: '#fef2f2', color: '#b91c1c', border: '#fecdd3' },
                warning: { bg: '#fff7ed', color: '#c2410c', border: '#fed7aa' }
            };
            const toneData = palette[tone] || palette.info;
            dataStatus.textContent = text;
            dataStatus.style.background = toneData.bg;
            dataStatus.style.color = toneData.color;
            dataStatus.style.borderColor = toneData.border;
        }

        async function fetchJSON(url, options = {}) {
            const response = await fetch(url, options);
            const data = await response.json();
            if (!response.ok) {
                throw new Error(data.error || 'ุชุนุฐุฑ ุชูููุฐ ุงูุทูุจ');
            }
            return data;
        }

        async function loadData() {
            setStatus('ุฌุงุฑู ุชุญููู ุงูุจูุงูุงุช...', 'info');
            try {
                const [employeesData, requestsData, typesData, branchesData, hqData] = await Promise.all([
                    fetchJSON(`${API_BASE}/api/employees`),
                    fetchJSON(`${API_BASE}/api/employee-requests`),
                    fetchJSON(`${API_BASE}/api/request-types`),
                    fetchJSON(`${API_BASE}/api/branches`),
                    fetchJSON(`${API_BASE}/api/headquarters`)
                ]);

                employees = Array.isArray(employeesData) ? employeesData : [];
                requests = Array.isArray(requestsData) ? requestsData : [];
                requestTypes = Array.isArray(typesData) ? typesData : [];
                branches = Array.isArray(branchesData) ? branchesData : [];
                headquarters = Array.isArray(hqData) ? hqData : [];

                populateSelectors();
                renderTables();
                resetRequestForm();
                resetEmployeeForm();
                resetTypeForm();
                setStatus('ุชู ุชุญุฏูุซ ุงูุจูุงูุงุช ุจูุฌุงุญ', 'success');
            } catch (error) {
                console.error('ุฎุทุฃ ูู ุชุญููู ุงูุจูุงูุงุช:', error);
                setStatus('ุชุนุฐุฑ ุชุญููู ุงูุจูุงูุงุช - ุชุญูู ูู ุงูุงุชุตุงู', 'danger');
                renderTables();
            }
        }

        function populateSelectors() {
            const requestEmployee = document.getElementById('requestEmployee');
            if (requestEmployee) {
                requestEmployee.innerHTML = '<option value="">ุจุฏูู ุฑุจุท ูุจุงุดุฑ</option>' +
                    employees.map(emp => `<option value="${emp.id}">${sanitizeText(emp.full_name)} - ${sanitizeText(emp.employee_number || 'ุจุฏูู ุฑูู')}</option>`).join('');
            }

            const requestTypeSelect = document.getElementById('requestType');
            if (requestTypeSelect) {
                requestTypeSelect.innerHTML = requestTypes.map(t => `<option value="${t.type_code}">${sanitizeText(t.type_name_ar)}</option>`).join('');
            }

            const entitySelect = document.getElementById('employeeEntity');
            if (entitySelect) {
                const options = getEntityOptions();
                entitySelect.innerHTML = options.map(opt => `<option value="${opt.value}">${sanitizeText(opt.label)}</option>`).join('');
            }
        }

        function getEntityOptions() {
            const options = [];
            (headquarters || []).forEach(hq => {
                options.push({ value: `HQ|${hq.id}|${hq.entity_id}`, label: `${hq.entity_id} - ${hq.name}` });
            });
            (branches || []).forEach(branch => {
                options.push({ value: `BRANCH|${branch.id}|${branch.entity_id}`, label: `${branch.entity_id} - ${branch.name}` });
            });
            if (!options.length) {
                options.push({ value: 'HQ|1|HQ001', label: 'HQ001 - ุงูููุฑ ุงูุฑุฆูุณู' });
            }
            return options;
        }

        function renderTables() {
            const employeeRows = employees.map(e => `
                <tr class="hover:bg-emerald-50">
                    <td class="px-3 py-2">${sanitizeText(e.employee_number || e.id)}</td>
                    <td class="px-3 py-2 font-semibold">${sanitizeText(e.full_name)}</td>
                    <td class="px-3 py-2">${sanitizeText(e.email)}</td>
                    <td class="px-3 py-2">${sanitizeText(e.position)}</td>
                    <td class="px-3 py-2">${sanitizeText(e.department)}</td>
                    <td class="px-3 py-2">${sanitizeText(e.entity_name || e.entity_id)}</td>
                    <td class="px-3 py-2">${formatDate(e.hire_date)}</td>
                    <td class="px-3 py-2">${formatMoney(e.salary)}</td>
                    <td class="px-3 py-2">${translateEmploymentType(e.employment_type)}</td>
                    <td class="px-3 py-2">${renderActiveBadge(e.is_active)}</td>
                    <td class="px-3 py-2 table-actions">${buildActions('employee', e.id)}</td>
                </tr>
            `).join('');
            document.getElementById('employeesTable').innerHTML = employeeRows || defaultRow(11);
            document.getElementById('employeesCount').textContent = `ุนุฏุฏ ุงูุตููู: ${employees.length}`;

            const requestRows = requests.map(r => `
                <tr class="hover:bg-violet-50">
                    <td class="px-3 py-2">${sanitizeText(r.id)}</td>
                    <td class="px-3 py-2">${sanitizeText(r.employee_name || r.employee_id)}</td>
                    <td class="px-3 py-2">${resolveRequestTypeName(r.request_type)}</td>
                    <td class="px-3 py-2">${sanitizeText(r.request_title)}</td>
                    <td class="px-3 py-2">${translatePriority(r.priority)}</td>
                    <td class="px-3 py-2">${normalizeStatus(r.status)}</td>
                    <td class="px-3 py-2">${formatDate(r.requested_date)}</td>
                    <td class="px-3 py-2">${r.requires_approval ? 'ูุนู' : 'ูุง'}</td>
                    <td class="px-3 py-2">${truncate(sanitizeText(r.notes))}</td>
                    <td class="px-3 py-2">${formatDateTime(r.created_at)}</td>
                    <td class="px-3 py-2 table-actions">${buildActions('request', r.id)}</td>
                </tr>
            `).join('');
            document.getElementById('requestsTable').innerHTML = requestRows || defaultRow(11);
            document.getElementById('requestsCount').textContent = `ุนุฏุฏ ุงูุตููู: ${requests.length}`;

            const typeRows = requestTypes.map(t => `
                <tr class="hover:bg-rose-50">
                    <td class="px-3 py-2">${sanitizeText(t.id)}</td>
                    <td class="px-3 py-2 font-semibold">${sanitizeText(t.type_name_ar)}</td>
                    <td class="px-3 py-2">${translateCategory(t.category)}</td>
                    <td class="px-3 py-2">${truncate(sanitizeText(t.description_ar))}</td>
                    <td class="px-3 py-2">${t.requires_approval ? 'ูุนู' : 'ูุง'}</td>
                    <td class="px-3 py-2">${t.requires_manager_approval ? 'ูุนู' : 'ูุง'}</td>
                    <td class="px-3 py-2">${t.requires_hr_approval ? 'ูุนู' : 'ูุง'}</td>
                    <td class="px-3 py-2">${renderActiveBadge(t.is_active)}</td>
                    <td class="px-3 py-2 table-actions">${buildActions('type', t.id)}</td>
                </tr>
            `).join('');
            document.getElementById('typesTable').innerHTML = typeRows || defaultRow(9);
            document.getElementById('typesCount').textContent = `ุนุฏุฏ ุงูุตููู: ${requestTypes.length}`;

            updateStats();
        }

        function buildActions(type, id) {
            const safeId = encodeURIComponent(id);
            if (type === 'employee') {
                return `
                    <div class="flex flex-wrap gap-2">
                        <button class="btn btn-ghost" onclick="showPreview('employee','${safeId}')"><i class="fas fa-eye"></i> ูุนุงููุฉ</button>
                        <button class="btn btn-warning" onclick="startEditEmployee('${safeId}')"><i class="fas fa-pen"></i> ุชุนุฏูู</button>
                        <button class="btn btn-danger" onclick="deleteEmployee('${safeId}')"><i class="fas fa-trash"></i> ุญุฐู</button>
                    </div>`;
            }
            if (type === 'request') {
                return `
                    <div class="flex flex-wrap gap-2">
                        <button class="btn btn-ghost" onclick="showPreview('request','${safeId}')"><i class="fas fa-eye"></i> ูุนุงููุฉ</button>
                        <button class="btn btn-warning" onclick="startEditRequest('${safeId}')"><i class="fas fa-pen"></i> ุชุนุฏูู</button>
                        <button class="btn btn-danger" onclick="deleteRequest('${safeId}')"><i class="fas fa-trash"></i> ุญุฐู</button>
                    </div>`;
            }
            return `
                <div class="flex flex-wrap gap-2">
                    <button class="btn btn-ghost" onclick="showPreview('type','${safeId}')"><i class="fas fa-eye"></i> ูุนุงููุฉ</button>
                    <button class="btn btn-warning" onclick="startEditType('${safeId}')"><i class="fas fa-pen"></i> ุชุนุฏูู</button>
                    <button class="btn btn-danger" onclick="deleteType('${safeId}')"><i class="fas fa-trash"></i> ุญุฐู</button>
                </div>`;
        }

        function renderActiveBadge(isActive) {
            return `<span class="badge" style="background:${isActive ? '#ecfdf3' : '#fef2f2'}; color:${isActive ? '#166534' : '#991b1b'}">${isActive ? 'ูุดุท' : 'ุบูุฑ ูุดุท'}</span>`;
        }

        function updateStats() {
            const employeesStat = document.getElementById('statEmployees');
            const requestsStat = document.getElementById('statRequests');
            const typesStat = document.getElementById('statTypes');
            if (employeesStat) employeesStat.textContent = employees.length.toLocaleString('ar-SA');
            if (requestsStat) requestsStat.textContent = requests.length.toLocaleString('ar-SA');
            if (typesStat) typesStat.textContent = requestTypes.length.toLocaleString('ar-SA');
        }

        function defaultRow(colspan) {
            return `<tr><td colspan="${colspan}" class="px-4 py-12 text-center text-slate-500">ูุง ุชูุฌุฏ ุจูุงูุงุช</td></tr>`;
        }

        function resolveRequestTypeName(code) {
            const match = requestTypes.find(t => t.type_code === code);
            return sanitizeText(match?.type_name_ar || code || 'ุบูุฑ ูุญุฏุฏ');
        }

        function normalizeStatus(value) {
            const map = {
                PENDING: 'ููุฏ ุงููุนุงูุฌุฉ',
                APPROVED: 'ูุนุชูุฏ',
                REJECTED: 'ูุฑููุถ',
                COMPLETED: 'ููุชูู',
                IN_PROGRESS: 'ููุฏ ุงูุชูููุฐ'
            };
            return map[String(value || '').toUpperCase()] || sanitizeText(value) || 'ุบูุฑ ูุญุฏุฏ';
        }

        function translatePriority(value) {
            const map = { HIGH: 'ุนุงุฌู', NORMAL: 'ุนุงุฏู', LOW: 'ููุฎูุถ' };
            return map[String(value || '').toUpperCase()] || sanitizeText(value) || 'ุบูุฑ ูุญุฏุฏ';
        }

        function translateEmploymentType(value) {
            const map = {
                FULL_TIME: 'ุฏูุงู ูุงูู',
                PART_TIME: 'ุฏูุงู ุฌุฒุฆู',
                CONTRACT: 'ุชุนุงูุฏ',
                TEMPORARY: 'ูุคูุช',
                INTERN: 'ุชุฏุฑูุจ'
            };
            return map[String(value || '').toUpperCase()] || sanitizeText(value) || 'ุบูุฑ ูุญุฏุฏ';
        }

        function translateCategory(value) {
            const map = {
                general: 'ุนุงู',
                leave: 'ุฅุฌุงุฒุงุช',
                payroll: 'ุฑูุงุชุจ',
                attendance: 'ุญุถูุฑ',
                hr: 'ููุงุฑุฏ ุจุดุฑูุฉ',
                admin: 'ุฅุฏุงุฑู',
                travel: 'ุณูุฑ',
                training: 'ุชุฏุฑูุจ',
                procurement: 'ูุดุชุฑูุงุช',
                financial: 'ูุงูู'
            };
            return map[String(value || '').toLowerCase()] || sanitizeText(value) || 'ุบูุฑ ูุญุฏุฏ';
        }

        function formatMoney(value) {
            const num = parseFloat(value || 0);
            if (Number.isNaN(num)) return '-';
            return num.toLocaleString('ar-SA') + ' ุฑ.ุณ';
        }

        function formatDate(value) {
            if (!value) return '-';
            return new Date(value).toLocaleDateString('ar-SA');
        }

        function formatDateTime(value) {
            if (!value) return '-';
            return new Date(value).toLocaleString('ar-SA');
        }

        function truncate(value) {
            if (value === null || value === undefined) return '-';
            const text = typeof value === 'string' ? value : JSON.stringify(value);
            return text.length > 120 ? text.slice(0, 120) + '...' : text;
        }

        function sanitizeText(value) {
            if (value === null || value === undefined) return '-';
            const text = typeof value === 'string' ? value : JSON.stringify(value);
            return text.replace(/[&<>"']/g, match => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[match]));
        }

        function syncEmployeeName() {
            const select = document.getElementById('requestEmployee');
            const nameInput = document.getElementById('requestEmployeeName');
            const match = employees.find(e => String(e.id) === select.value);
            if (match && nameInput) {
                nameInput.value = match.full_name || '';
            }
        }

        function generateEmployeeNumber() {
            const now = new Date();
            return `EMP-${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}-${String(now.getTime()).slice(-4)}`;
        }

        // ูุนุงูุฌุฉ ููุงุฐุฌ ุงูููุธููู
        function resetEmployeeForm() {
            document.getElementById('employeeId').value = '';
            document.getElementById('employeeNumber').value = generateEmployeeNumber();
            document.getElementById('employeeName').value = '';
            document.getElementById('employeeEmail').value = '';
            document.getElementById('employeePosition').value = '';
            document.getElementById('employeeDepartment').value = '';
            document.getElementById('hireDate').value = '';
            document.getElementById('salary').value = '';
            document.getElementById('employmentType').value = 'FULL_TIME';
            document.getElementById('employeeActive').checked = true;
            const entitySelect = document.getElementById('employeeEntity');
            const options = getEntityOptions();
            if (entitySelect && options.length) {
                entitySelect.value = options[0].value;
            }
        }

        async function handleEmployeeSubmit(event) {
            event.preventDefault();
            setStatus('ุฌุงุฑู ุญูุธ ุงูููุธู...', 'info');
            const entityParts = (document.getElementById('employeeEntity').value || '').split('|');
            const payload = {
                employee_number: document.getElementById('employeeNumber').value.trim(),
                full_name: document.getElementById('employeeName').value.trim(),
                email: document.getElementById('employeeEmail').value.trim() || null,
                position: document.getElementById('employeePosition').value.trim() || null,
                department: document.getElementById('employeeDepartment').value.trim() || null,
                assigned_entity_type: entityParts[0] || 'HQ',
                hq_id: entityParts[0] === 'HQ' ? Number(entityParts[1]) || null : null,
                branch_id: entityParts[0] === 'BRANCH' ? Number(entityParts[1]) || null : null,
                incubator_id: entityParts[0] === 'INCUBATOR' ? Number(entityParts[1]) || null : null,
                platform_id: entityParts[0] === 'PLATFORM' ? Number(entityParts[1]) || null : null,
                office_id: entityParts[0] === 'OFFICE' ? Number(entityParts[1]) || null : null,
                hire_date: document.getElementById('hireDate').value || null,
                salary: document.getElementById('salary').value ? Number(document.getElementById('salary').value) : null,
                employment_type: document.getElementById('employmentType').value || 'FULL_TIME',
                is_active: document.getElementById('employeeActive').checked
            };

            const employeeId = document.getElementById('employeeId').value;
            const method = employeeId ? 'PUT' : 'POST';
            const url = employeeId ? `${API_BASE}/api/employees/${employeeId}` : `${API_BASE}/api/employees`;

            const saved = await fetchJSON(url, {
                method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (employeeId) {
                employees = employees.map(emp => String(emp.id) === String(employeeId) ? saved : emp);
            } else {
                employees = [saved, ...employees];
            }

            renderTables();
            resetEmployeeForm();
            setStatus('ุชู ุญูุธ ุงูููุธู ุจูุฌุงุญ', 'success');
        }

        function startEditEmployee(id) {
            const cleanId = decodeURIComponent(id);
            const employee = employees.find(e => String(e.id) === String(cleanId));
            if (!employee) return;
            document.getElementById('employeeId').value = employee.id;
            document.getElementById('employeeNumber').value = employee.employee_number || '';
            document.getElementById('employeeName').value = employee.full_name || '';
            document.getElementById('employeeEmail').value = employee.email || '';
            document.getElementById('employeePosition').value = employee.position || '';
            document.getElementById('employeeDepartment').value = employee.department || '';
            document.getElementById('hireDate').value = employee.hire_date ? employee.hire_date.slice(0, 10) : '';
            document.getElementById('salary').value = employee.salary || '';
            document.getElementById('employmentType').value = employee.employment_type || 'FULL_TIME';
            document.getElementById('employeeActive').checked = employee.is_active !== false;

            const entitySelect = document.getElementById('employeeEntity');
            const entityValue = buildEntityValue(employee);
            if (entitySelect && entityValue) {
                entitySelect.value = entityValue;
            }
            scrollToSection('employeesForm');
            setStatus('ูุถุน ุงูุชุนุฏูู ููุนู ููููุธู ุงููุญุฏุฏ', 'warning');
        }

        function buildEntityValue(employee) {
            if (!employee) return null;
            if (employee.assigned_entity_type === 'HQ' && employee.hq_id) return `HQ|${employee.hq_id}|${employee.entity_id || 'HQ001'}`;
            if (employee.assigned_entity_type === 'BRANCH' && employee.branch_id) return `BRANCH|${employee.branch_id}|${employee.entity_id || 'BR001'}`;
            if (employee.assigned_entity_type === 'INCUBATOR' && employee.incubator_id) return `INCUBATOR|${employee.incubator_id}|${employee.entity_id || 'INC001'}`;
            if (employee.assigned_entity_type === 'PLATFORM' && employee.platform_id) return `PLATFORM|${employee.platform_id}|${employee.entity_id || 'PLT001'}`;
            if (employee.assigned_entity_type === 'OFFICE' && employee.office_id) return `OFFICE|${employee.office_id}|${employee.entity_id || 'OFF001'}`;
            return null;
        }

        async function deleteEmployee(id) {
            const cleanId = decodeURIComponent(id);
            if (!confirm('ูู ุฃูุช ูุชุฃูุฏ ูู ุญุฐู ูุฐุง ุงูููุธูุ')) return;
            await fetchJSON(`${API_BASE}/api/employees/${cleanId}`, { method: 'DELETE' });
            employees = employees.filter(e => String(e.id) !== String(cleanId));
            renderTables();
            setStatus('ุชู ุญุฐู ุงูููุธู ุจูุฌุงุญ', 'success');
        }

        // ูุนุงูุฌุฉ ููุงุฐุฌ ุงูุทูุจุงุช
        function resetRequestForm() {
            document.getElementById('requestId').value = '';
            document.getElementById('requestEmployee').value = '';
            document.getElementById('requestEmployeeName').value = '';
            document.getElementById('requestType').value = requestTypes[0]?.type_code || '';
            document.getElementById('requestPriority').value = 'NORMAL';
            document.getElementById('requestStatus').value = 'PENDING';
            document.getElementById('requestTitle').value = '';
            document.getElementById('requestedDate').value = new Date().toISOString().slice(0, 10);
            document.getElementById('startDate').value = '';
            document.getElementById('endDate').value = '';
            document.getElementById('requestRequiresApproval').checked = true;
            document.getElementById('requestNotes').value = '';
        }

        async function handleRequestSubmit(event) {
            event.preventDefault();
            setStatus('ุฌุงุฑู ุญูุธ ุงูุทูุจ...', 'info');
            const selectedEmployee = employees.find(e => String(e.id) === document.getElementById('requestEmployee').value);
            const requestId = document.getElementById('requestId').value.trim() || `REQ-${Date.now()}`;
            const existingRequest = requests.find(r => String(r.id) === requestId);
            const payload = {
                id: requestId,
                entityId: selectedEmployee?.entity_id || existingRequest?.entity_id || 'HQ001',
                employeeId: selectedEmployee?.id || null,
                employeeName: document.getElementById('requestEmployeeName').value.trim() || selectedEmployee?.full_name || existingRequest?.employee_name || 'ุบูุฑ ูุญุฏุฏ',
                requestType: document.getElementById('requestType').value,
                requestTitle: document.getElementById('requestTitle').value.trim(),
                description: document.getElementById('requestNotes').value.trim() || null,
                status: document.getElementById('requestStatus').value,
                priority: document.getElementById('requestPriority').value,
                requestData: {},
                requiresApproval: document.getElementById('requestRequiresApproval').checked,
                requestedDate: document.getElementById('requestedDate').value || new Date().toISOString(),
                startDate: document.getElementById('startDate').value || null,
                endDate: document.getElementById('endDate').value || null,
                notes: document.getElementById('requestNotes').value.trim() || null,
                createdBy: 'hr-portal'
            };

            const existing = document.getElementById('requestId').value.trim();
            const method = existing ? 'PUT' : 'POST';
            const url = existing ? `${API_BASE}/api/employee-requests/${requestId}` : `${API_BASE}/api/employee-requests`;

            const saved = await fetchJSON(url, {
                method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            const stored = saved.request || saved;
            if (existing) {
                requests = requests.map(req => String(req.id) === requestId ? stored : req);
            } else {
                requests = [stored, ...requests];
            }

            renderTables();
            resetRequestForm();
            setStatus('ุชู ุญูุธ ุงูุทูุจ ุจูุฌุงุญ', 'success');
        }

        function startEditRequest(id) {
            const cleanId = decodeURIComponent(id);
            const request = requests.find(r => String(r.id) === String(cleanId));
            if (!request) return;
            document.getElementById('requestId').value = request.id;
            document.getElementById('requestEmployee').value = request.employee_id || '';
            document.getElementById('requestEmployeeName').value = request.employee_name || '';
            document.getElementById('requestType').value = request.request_type || '';
            document.getElementById('requestPriority').value = request.priority || 'NORMAL';
            document.getElementById('requestStatus').value = request.status || 'PENDING';
            document.getElementById('requestTitle').value = request.request_title || '';
            document.getElementById('requestedDate').value = request.requested_date ? request.requested_date.slice(0, 10) : '';
            document.getElementById('startDate').value = request.start_date ? request.start_date.slice(0, 10) : '';
            document.getElementById('endDate').value = request.end_date ? request.end_date.slice(0, 10) : '';
            document.getElementById('requestRequiresApproval').checked = request.requires_approval !== false;
            document.getElementById('requestNotes').value = request.notes || request.description || '';
            scrollToSection('requestForm');
            setStatus('ูุถุน ุงูุชุนุฏูู ููุนู ููุทูุจ ุงููุญุฏุฏ', 'warning');
        }

        async function deleteRequest(id) {
            const cleanId = decodeURIComponent(id);
            if (!confirm('ูู ุชุฑูุฏ ุญุฐู ุงูุทูุจ ููุงุฆูุงูุ')) return;
            await fetchJSON(`${API_BASE}/api/employee-requests/${cleanId}`, { method: 'DELETE' });
            requests = requests.filter(r => String(r.id) !== String(cleanId));
            renderTables();
            setStatus('ุชู ุญุฐู ุงูุทูุจ ุจูุฌุงุญ', 'success');
        }

        // ูุนุงูุฌุฉ ููุงุฐุฌ ุฃููุงุน ุงูุทูุจุงุช
        function resetTypeForm() {
            document.getElementById('typeId').value = '';
            document.getElementById('typeCode').value = '';
            document.getElementById('typeNameAr').value = '';
            document.getElementById('typeCategory').value = 'general';
            document.getElementById('typeOrder').value = 0;
            document.getElementById('typeActive').checked = true;
            document.getElementById('typeNeedsApproval').checked = true;
            document.getElementById('typeDescription').value = '';
        }

        async function handleTypeSubmit(event) {
            event.preventDefault();
            setStatus('ุฌุงุฑู ุญูุธ ููุน ุงูุทูุจ...', 'info');
            const payload = {
                type_code: document.getElementById('typeCode').value.trim(),
                type_name_ar: document.getElementById('typeNameAr').value.trim(),
                category: document.getElementById('typeCategory').value,
                description_ar: document.getElementById('typeDescription').value.trim() || null,
                display_order: Number(document.getElementById('typeOrder').value) || 0,
                is_active: document.getElementById('typeActive').checked,
                requires_approval: document.getElementById('typeNeedsApproval').checked
            };

            const typeId = document.getElementById('typeId').value;
            const method = typeId ? 'PUT' : 'POST';
            const url = typeId ? `${API_BASE}/api/request-types/${typeId}` : `${API_BASE}/api/request-types`;

            const saved = await fetchJSON(url, {
                method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            const stored = saved.requestType || saved;
            if (typeId) {
                requestTypes = requestTypes.map(t => String(t.id) === String(typeId) ? stored : t);
            } else {
                requestTypes = [stored, ...requestTypes];
            }

            populateSelectors();
            renderTables();
            resetTypeForm();
            setStatus('ุชู ุญูุธ ููุน ุงูุทูุจ ุจูุฌุงุญ', 'success');
        }

        function startEditType(id) {
            const cleanId = decodeURIComponent(id);
            const type = requestTypes.find(t => String(t.id) === String(cleanId));
            if (!type) return;
            document.getElementById('typeId').value = type.id;
            document.getElementById('typeCode').value = type.type_code || '';
            document.getElementById('typeNameAr').value = type.type_name_ar || '';
            document.getElementById('typeCategory').value = type.category || 'general';
            document.getElementById('typeOrder').value = type.display_order || 0;
            document.getElementById('typeActive').checked = type.is_active !== false;
            document.getElementById('typeNeedsApproval').checked = type.requires_approval !== false;
            document.getElementById('typeDescription').value = type.description_ar || '';
            scrollToSection('typeForm');
            setStatus('ูุถุน ุงูุชุนุฏูู ููุนู ูููุน ุงูุทูุจ ุงููุญุฏุฏ', 'warning');
        }

        async function deleteType(id) {
            const cleanId = decodeURIComponent(id);
            if (!confirm('ุชุฃููุฏ ุญุฐู ููุน ุงูุทูุจุ')) return;
            await fetchJSON(`${API_BASE}/api/request-types/${cleanId}`, { method: 'DELETE' });
            requestTypes = requestTypes.filter(t => String(t.id) !== String(cleanId));
            populateSelectors();
            renderTables();
            setStatus('ุชู ุญุฐู ููุน ุงูุทูุจ ุจูุฌุงุญ', 'success');
        }

        // ุงููุนุงููุฉ
        function showPreview(type, id) {
            const cleanId = decodeURIComponent(id);
            let item = null;
            let title = '';
            if (type === 'employee') {
                item = employees.find(e => String(e.id) === String(cleanId));
                title = 'ุชูุงุตูู ุงูููุธู';
            } else if (type === 'request') {
                item = requests.find(r => String(r.id) === String(cleanId));
                title = 'ุชูุงุตูู ุงูุทูุจ';
            } else {
                item = requestTypes.find(t => String(t.id) === String(cleanId));
                title = 'ุชูุงุตูู ููุน ุงูุทูุจ';
            }
            if (!item) return;

            previewTitle.textContent = title;
            previewBody.innerHTML = buildPreviewGrid(type, item);
            previewPanel.classList.remove('hidden');
            previewPanel.scrollIntoView({ behavior: 'smooth' });
        }

        function hidePreview() {
            previewPanel.classList.add('hidden');
        }

        function buildPreviewGrid(type, item) {
            if (type === 'employee') {
                return renderPreviewRows([
                    ['ุฑูู ุงูููุธู', item.employee_number],
                    ['ุงูุงุณู', item.full_name],
                    ['ุงูููุตุจ', item.position],
                    ['ุงููุณู', item.department],
                    ['ุงูููุดุฃุฉ', item.entity_name || item.entity_id],
                    ['ุชุงุฑูุฎ ุงูุชุนููู', formatDate(item.hire_date)],
                    ['ููุน ุงูุชูุธูู', translateEmploymentType(item.employment_type)],
                    ['ุงูุญุงูุฉ', item.is_active ? 'ูุดุท' : 'ุบูุฑ ูุดุท']
                ]);
            }
            if (type === 'request') {
                return renderPreviewRows([
                    ['ุฑูู ุงูุทูุจ', item.id],
                    ['ุงูููุธู', item.employee_name || item.employee_id],
                    ['ููุน ุงูุทูุจ', resolveRequestTypeName(item.request_type)],
                    ['ุงูุนููุงู', item.request_title],
                    ['ุงูุฃููููุฉ', translatePriority(item.priority)],
                    ['ุงูุญุงูุฉ', normalizeStatus(item.status)],
                    ['ุชุงุฑูุฎ ุงูุทูุจ', formatDate(item.requested_date)],
                    ['ูู', formatDate(item.start_date)],
                    ['ุฅูู', formatDate(item.end_date)],
                    ['ููุงุญุธุงุช', item.notes || item.description]
                ]);
            }
            return renderPreviewRows([
                ['ุงูุงุณู', item.type_name_ar],
                ['ุงูููุฏ', item.type_code],
                ['ุงููุฆุฉ', translateCategory(item.category)],
                ['ุงููุตู', item.description_ar],
                ['ูุญุชุงุฌ ููุงููุฉ', item.requires_approval ? 'ูุนู' : 'ูุง'],
                ['ูุดุท', item.is_active ? 'ูุนู' : 'ูุง']
            ]);
        }

        function renderPreviewRows(rows) {
            return rows.map(([label, value]) => `
                <div class="bg-slate-50 rounded-2xl p-3">
                    <div class="text-xs text-slate-500">${sanitizeText(label)}</div>
                    <div class="text-sm font-semibold text-slate-800">${sanitizeText(value ?? '-')}</div>
                </div>
            `).join('');
        }

        // ุฃุฏูุงุช ูุชููุนุฉ
        function downloadAllJSON() {
            const payload = { employees, requests, request_types: requestTypes };
            downloadBlob(JSON.stringify(payload, null, 2), 'ุจูุงุจุฉ-ุงูุนูููุงุช-ูุงูุทูุจุงุช.json', 'application/json');
        }

        function downloadAllCSV() {
            const rows = [];
            rows.push(['ุงูููุธููู']);
            rows.push(['ุฑูู ุงูููุธู','ุงูุงุณู','ุงูุจุฑูุฏ','ุงูููุตุจ','ุงููุณู','ุงูููุดุฃุฉ','ุชุงุฑูุฎ ุงูุชุนููู','ุงูุฑุงุชุจ','ููุน ุงูุชูุธูู','ุงูุญุงูุฉ']);
            employees.forEach(e => rows.push([
                e.employee_number || e.id,
                e.full_name,
                e.email,
                e.position,
                e.department,
                e.entity_name || e.entity_id,
                e.hire_date,
                e.salary,
                translateEmploymentType(e.employment_type),
                e.is_active ? 'ูุดุท' : 'ุบูุฑ ูุดุท'
            ]));

            rows.push([]);
            rows.push(['ุทูุจุงุช ุงูููุธููู']);
            rows.push(['ุฑูู ุงูุทูุจ','ุงูููุธู','ููุน ุงูุทูุจ','ุงูุนููุงู','ุงูุฃููููุฉ','ุงูุญุงูุฉ','ุชุงุฑูุฎ ุงูุทูุจ','ุงูููุงููุฉ ูุทููุจุฉ','ููุงุญุธุงุช','ุชุงุฑูุฎ ุงูุฅูุดุงุก']);
            requests.forEach(r => rows.push([
                r.id,
                r.employee_name || r.employee_id,
                resolveRequestTypeName(r.request_type),
                r.request_title,
                translatePriority(r.priority),
                normalizeStatus(r.status),
                r.requested_date,
                r.requires_approval ? 'ูุนู' : 'ูุง',
                r.notes || r.description,
                r.created_at
            ]));

            rows.push([]);
            rows.push(['ุฃููุงุน ุงูุทูุจุงุช']);
            rows.push(['ุฑูู ุงูููุน','ุงูุงุณู','ุงููุฆุฉ','ุงููุตู','ูุชุทูุจ ููุงููุฉ','ูุชุทูุจ ูุฏูุฑ','ูุชุทูุจ ููุงุฑุฏ ุจุดุฑูุฉ','ุงูุญุงูุฉ']);
            requestTypes.forEach(t => rows.push([
                t.id,
                t.type_name_ar,
                translateCategory(t.category),
                t.description_ar,
                t.requires_approval ? 'ูุนู' : 'ูุง',
                t.requires_manager_approval ? 'ูุนู' : 'ูุง',
                t.requires_hr_approval ? 'ูุนู' : 'ูุง',
                t.is_active ? 'ูุดุท' : 'ุบูุฑ ูุดุท'
            ]));

            const csvContent = rows.map(r => r.map(v => `"${v ?? ''}"`).join(',')).join('\n');
            downloadBlob(csvContent, 'ุจูุงุจุฉ-ุงูุนูููุงุช-ูุงูุทูุจุงุช.csv', 'text/csv;charset=utf-8;');
        }

        function downloadBlob(content, filename, type) {
            const blob = new Blob([content], { type });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            link.click();
            URL.revokeObjectURL(url);
        }

        function printReport() {
            window.print();
        }

        function refreshData() {
            loadData();
        }

        function scrollToSection(id) {
            const el = document.getElementById(id);
            if (el) {
                el.scrollIntoView({ behavior: 'smooth' });
            }
        }
    </script>
</body>
</html>
