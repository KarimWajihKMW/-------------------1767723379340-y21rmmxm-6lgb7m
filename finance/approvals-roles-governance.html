<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>๐ ูุธุงู ุงูููุงููุงุช ูุงูุตูุงุญูุงุช ูุงูุญูููุฉ - ูุธุงู ูุงููุด</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: 'Cairo', sans-serif; background-color: #f9fafb; color: #0f172a; }
        .card-glass {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
        }
        .stat-pill {
            border-radius: 999px;
            box-shadow: 0 20px 35px rgba(15, 23, 42, 0.18);
        }
        .stat-angled {
            border-radius: 32px 8px 32px 8px;
        }
        .stat-rounded {
            border-radius: 32px;
        }
        .stat-cut {
            border-radius: 8px 32px 8px 32px;
        }
        .table-scroll {
            max-height: 550px;
            overflow: auto;
        }
        .section-accent-violet { border-top: 5px solid #8b5cf6; }
        .section-accent-indigo { border-top: 5px solid #6366f1; }
        .section-accent-purple { border-top: 5px solid #a855f7; }
        .section-accent-fuchsia { border-top: 5px solid #d946ef; }
        .section-accent-rose { border-top: 5px solid #f43f5e; }
        .level-card {
            transition: all 0.3s;
        }
        .level-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(0,0,0,0.15);
        }
        .badge {
            padding: 6px 14px;
            border-radius: 999px;
            font-weight: 700;
            font-size: 0.75rem;
        }
    
        .card-gradient {
            background: linear-gradient(145deg, #ffffff, #f3f4f6);
            border: 1px solid #e2e8f0;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
    
    </style>
</head>
<body>
    <div class="container mx-auto px-4 py-8">
        <div class="mb-8 text-slate-900">
            <h1 class="text-5xl font-bold mb-3">๐ ูุธุงู ุงูููุงููุงุช ูุงูุตูุงุญูุงุช ูุงูุญูููุฉ</h1>
            <p class="text-xl opacity-90">ูุธุงู ุงูููุงููุงุช - ุงูุตูุงุญูุงุช - ุญูููุฉ ุงูุจูุงูุงุช - ุญูููุฉ ุงูุชูุงุฑูุฑ - ุญูููุฉ ุงูุฐูุงุก ุงูุงุตุทูุงุนู - ุญูููุฉ ุงููุฎุงุทุฑ (ุงูุตูุญุฉ 41)</p>
        </div>

        <div class="mb-6 flex flex-wrap gap-3">
            <button onclick="refreshData()" class="bg-white text-purple-700 px-6 py-3 rounded-full font-bold hover:shadow-lg transition flex items-center gap-2">
                <i class="fas fa-rotate"></i>
                ุชุญุฏูุซ ุงูุจูุงูุงุช
            </button>
            <button onclick="downloadAllJSON()" class="bg-indigo-600 text-white px-6 py-3 rounded-full font-bold hover:shadow-lg transition flex items-center gap-2">
                <i class="fas fa-file-code"></i>
                ุชูุฒูู ุจูุงูุงุช ุดุงููุฉ
            </button>
            <button onclick="printReport()" class="bg-fuchsia-600 text-white px-6 py-3 rounded-full font-bold hover:shadow-lg transition flex items-center gap-2">
                <i class="fas fa-print"></i>
                ุทุจุงุนุฉ ุงูุชูุฑูุฑ
            </button>
            <button onclick="openRoleForm()" class="bg-emerald-600 text-white px-6 py-3 rounded-full font-bold hover:shadow-lg transition flex items-center gap-2">
                <i class="fas fa-user-plus"></i>
                ุฅุถุงูุฉ ุฏูุฑ ุฌุฏูุฏ
            </button>
            <button onclick="openAssignmentForm()" class="bg-blue-600 text-white px-6 py-3 rounded-full font-bold hover:shadow-lg transition flex items-center gap-2">
                <i class="fas fa-link"></i>
                ุฅุถุงูุฉ ุตูุงุญูุฉ ููุธุงู
            </button>
        </div>

        <div id="messageBox" class="hidden mb-6 p-4 rounded-2xl border text-sm font-bold"></div>

        <div id="previewCard" class="hidden card-glass rounded-3xl shadow-2xl p-6 mb-8 section-accent-purple">
            <div class="flex items-center justify-between mb-3">
                <div class="flex items-center gap-3">
                    <div class="w-12 h-12 rounded-2xl bg-purple-100 text-purple-700 flex items-center justify-center text-xl" id="previewIcon">๐</div>
                    <div>
                        <div class="text-xl font-bold" id="previewTitle">โ</div>
                        <div class="text-sm text-slate-500" id="previewSubtitle">โ</div>
                    </div>
                </div>
                <span class="badge bg-slate-100 text-slate-700" id="previewStatus">โ</span>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm" id="previewDetails"></div>
        </div>

        <!-- Approval System Overview -->
        <div class="card-glass rounded-3xl shadow-2xl p-6 mb-8 section-accent-violet">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-3xl font-bold text-slate-800">โ ูุธุงู ุงูููุงููุงุช ูุงูุตูุงุญูุงุช</h2>
                <div class="text-sm text-slate-500">ูุตุฏุฑ ุงูุจูุงูุงุช: ุฌุฏุงูู ุงูุตูุงุญูุงุช ูุงูุฃุฏูุงุฑ</div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-5 mb-8">
                <div class="stat-pill bg-gradient-to-br from-violet-500 to-purple-600 text-slate-900 p-6">
                    <div class="flex justify-between mb-3"><span>ุฅุฌูุงูู ุงูุฃุฏูุงุฑ</span><i class="fas fa-user-tag text-3xl opacity-70"></i></div>
                    <div id="totalRoles" class="text-4xl font-bold"><div class="animate-pulse">...</div></div>
                </div>
                <div class="stat-angled bg-gradient-to-br from-indigo-500 to-blue-600 text-slate-900 p-6">
                    <div class="flex justify-between mb-3"><span>ุฅุฌูุงูู ุงูุตูุงุญูุงุช</span><i class="fas fa-shield-halved text-3xl opacity-70"></i></div>
                    <div id="totalPermissions" class="text-4xl font-bold"><div class="animate-pulse">...</div></div>
                </div>
                <div class="stat-rounded bg-gradient-to-br from-fuchsia-500 to-pink-600 text-slate-900 p-6">
                    <div class="flex justify-between mb-3"><span>ุงููุณุชููุงุช ุงููุดุทุฉ</span><i class="fas fa-layer-group text-3xl opacity-70"></i></div>
                    <div id="activeLevels" class="text-4xl font-bold"><div class="animate-pulse">...</div></div>
                </div>
                <div class="stat-cut bg-gradient-to-br from-rose-500 to-red-600 text-slate-900 p-6">
                    <div class="flex justify-between mb-3"><span>ุงููุณุชุฎุฏููู ุงููุดุทูู</span><i class="fas fa-users text-3xl opacity-70"></i></div>
                    <div id="activeUsers" class="text-4xl font-bold"><div class="animate-pulse">...</div></div>
                </div>
            </div>
        </div>

        <!-- Approval Levels -->
        <div class="card-glass rounded-3xl shadow-2xl p-6 mb-8 section-accent-indigo">
            <h2 class="text-2xl font-bold text-slate-800 mb-6">๐ ูุณุชููุงุช ุงูููุงููุงุช</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                <!-- Level 1 -->
                <div class="level-card bg-gradient-to-br from-emerald-50 to-teal-50 rounded-2xl p-6 border-r-8 border-emerald-500">
                    <div class="flex items-center gap-3 mb-4">
                        <div class="bg-emerald-500 text-white w-12 h-12 rounded-full flex items-center justify-center text-xl font-bold">1</div>
                        <h3 class="text-xl font-bold text-slate-800">ูุญุงุณุจ</h3>
                    </div>
                    <div class="space-y-2 text-sm text-slate-700">
                        <div class="flex items-center gap-2">
                            <i class="fas fa-check-circle text-emerald-600"></i>
                            <span>ุฅุฏุฎุงู ูููุฏ</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <i class="fas fa-check-circle text-emerald-600"></i>
                            <span>ุชุณุฌูู ููุงุชูุฑ</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <i class="fas fa-check-circle text-emerald-600"></i>
                            <span>ุชุณุฌูู ูุตุฑููุงุช</span>
                        </div>
                    </div>
                </div>

                <!-- Level 2 -->
                <div class="level-card bg-gradient-to-br from-sky-50 to-blue-50 rounded-2xl p-6 border-r-8 border-sky-500">
                    <div class="flex items-center gap-3 mb-4">
                        <div class="bg-sky-500 text-white w-12 h-12 rounded-full flex items-center justify-center text-xl font-bold">2</div>
                        <h3 class="text-xl font-bold text-slate-800">ูุฏูุฑ ูุงูู</h3>
                    </div>
                    <div class="space-y-2 text-sm text-slate-700">
                        <div class="flex items-center gap-2">
                            <i class="fas fa-check-circle text-sky-600"></i>
                            <span>ุงุนุชูุงุฏ ุงูููุงุชูุฑ</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <i class="fas fa-check-circle text-sky-600"></i>
                            <span>ุงุนุชูุงุฏ ุงููุตุฑููุงุช</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <i class="fas fa-check-circle text-sky-600"></i>
                            <span>ุงุนุชูุงุฏ ุฎุทุท ุงูุฏูุน</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <i class="fas fa-check-circle text-sky-600"></i>
                            <span>ุชุนุฏูู ูููุฏ ูุจู ุงูุฅููุงู</span>
                        </div>
                    </div>
                </div>

                <!-- Level 3 -->
                <div class="level-card bg-gradient-to-br from-violet-50 to-purple-50 rounded-2xl p-6 border-r-8 border-violet-500">
                    <div class="flex items-center gap-3 mb-4">
                        <div class="bg-violet-500 text-white w-12 h-12 rounded-full flex items-center justify-center text-xl font-bold">3</div>
                        <h3 class="text-xl font-bold text-slate-800">ูุฏูุฑ ูุงูู ุชูููุฐู</h3>
                    </div>
                    <div class="space-y-2 text-sm text-slate-700">
                        <div class="flex items-center gap-2">
                            <i class="fas fa-check-circle text-violet-600"></i>
                            <span>ุงุนุชูุงุฏ ุงูููุฒุงููุงุช</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <i class="fas fa-check-circle text-violet-600"></i>
                            <span>ุงุนุชูุงุฏ ุงููุตุฑููุงุช ุงููุจูุฑุฉ</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <i class="fas fa-check-circle text-violet-600"></i>
                            <span>ุชุนุฏูู ุงููููุฏ ุจุนุฏ ุงูุฅููุงู</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <i class="fas fa-check-circle text-violet-600"></i>
                            <span>ุงุนุชูุงุฏ ุณูุงุณุงุช ูุงููุฉ</span>
                        </div>
                    </div>
                </div>

                <!-- Level 4 -->
                <div class="level-card bg-gradient-to-br from-rose-50 to-pink-50 rounded-2xl p-6 border-r-8 border-rose-500">
                    <div class="flex items-center gap-3 mb-4">
                        <div class="bg-rose-500 text-white w-12 h-12 rounded-full flex items-center justify-center text-xl font-bold">4</div>
                        <h3 class="text-xl font-bold text-slate-800">ูุฌูุณ ุงูุฅุฏุงุฑุฉ</h3>
                    </div>
                    <div class="space-y-2 text-sm text-slate-700">
                        <div class="flex items-center gap-2">
                            <i class="fas fa-check-circle text-rose-600"></i>
                            <span>ุงุนุชูุงุฏ ุงูููุฒุงููุฉ ุงูุณูููุฉ</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <i class="fas fa-check-circle text-rose-600"></i>
                            <span>ุงุนุชูุงุฏ ุงููุดุงุฑูุน ุงููุจุฑู</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <i class="fas fa-check-circle text-rose-600"></i>
                            <span>ุงุนุชูุงุฏ ุงูุชูุณุน ุงููุงูู</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Financial Data Governance -->
        <div class="card-glass rounded-3xl shadow-2xl p-6 mb-8 section-accent-purple">
            <h2 class="text-2xl font-bold text-slate-800 mb-6">๐ก๏ธ ุญูููุฉ ุงูุจูุงูุงุช ุงููุงููุฉ</h2>
            
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                <div class="bg-gradient-to-br from-purple-50 to-violet-50 rounded-2xl p-6 border-r-4 border-purple-500">
                    <h3 class="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2">
                        <i class="fas fa-file-shield text-purple-600"></i>
                        ุงูุณูุงุณุงุช
                    </h3>
                    <div class="space-y-3 text-sm text-slate-700">
                        <div class="bg-white p-3 rounded-xl flex items-start gap-2">
                            <i class="fas fa-calendar text-purple-600 mt-1"></i>
                            <span>ูู ุนูููุฉ ูุงููุฉ ูุฌุจ ุฃู ุชุญุชูู ุนูู: ุชุงุฑูุฎ - ูุณุชุฎุฏู - ูุตุฏุฑ - ูุฑููุงุช</span>
                        </div>
                        <div class="bg-white p-3 rounded-xl flex items-start gap-2">
                            <i class="fas fa-ban text-red-600 mt-1"></i>
                            <span>ูุง ููุณูุญ ุจุญุฐู ุฃู ุณุฌู ูุงูู</span>
                        </div>
                        <div class="bg-white p-3 rounded-xl flex items-start gap-2">
                            <i class="fas fa-edit text-blue-600 mt-1"></i>
                            <span>ุงูุชุนุฏูู ูุชู ุนุจุฑ: ุฅุดุนุงุฑ ุฏุงุฆู/ูุฏูู - ููุฏ ุนูุณู</span>
                        </div>
                    </div>
                </div>

                <div class="bg-gradient-to-br from-indigo-50 to-blue-50 rounded-2xl p-6 border-r-4 border-indigo-500">
                    <h3 class="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2">
                        <i class="fas fa-magnifying-glass-chart text-indigo-600"></i>
                        ุงูุชุฏููู
                    </h3>
                    <div class="space-y-3 text-sm text-slate-700">
                        <div class="bg-white p-3 rounded-xl flex items-center justify-between">
                            <span>ุชุฏููู ุดูุฑู ุฏุงุฎูู</span>
                            <span class="badge bg-green-100 text-green-700">ุดูุฑู</span>
                        </div>
                        <div class="bg-white p-3 rounded-xl flex items-center justify-between">
                            <span>ุชุฏููู ุฑุจุน ุณููู</span>
                            <span class="badge bg-blue-100 text-blue-700">ุฑุจุน ุณููู</span>
                        </div>
                        <div class="bg-white p-3 rounded-xl flex items-center justify-between">
                            <span>ุชุฏููู ุณููู ุฎุงุฑุฌู</span>
                            <span class="badge bg-purple-100 text-purple-700">ุณููู</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Reporting Governance -->
        <div class="card-glass rounded-3xl shadow-2xl p-6 mb-8 section-accent-fuchsia">
            <h2 class="text-2xl font-bold text-slate-800 mb-6">๐ ุญูููุฉ ุงูุชูุงุฑูุฑ ุงููุงููุฉ</h2>
            
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="bg-gradient-to-br from-fuchsia-50 to-pink-50 rounded-2xl p-6 border-r-4 border-fuchsia-500">
                    <h3 class="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2">
                        <i class="fas fa-chart-line text-fuchsia-600"></i>
                        ุฃููุงุน ุงูุชูุงุฑูุฑ
                    </h3>
                    <div class="space-y-3 text-sm">
                        <div class="bg-white p-4 rounded-xl flex items-center justify-between hover:shadow-md transition">
                            <span class="font-semibold text-slate-700">ุชูุงุฑูุฑ ุชุดุบูููุฉ</span>
                            <span class="badge bg-emerald-100 text-emerald-700">ูููู</span>
                        </div>
                        <div class="bg-white p-4 rounded-xl flex items-center justify-between hover:shadow-md transition">
                            <span class="font-semibold text-slate-700">ุชูุงุฑูุฑ ุชูุชูููุฉ</span>
                            <span class="badge bg-sky-100 text-sky-700">ุดูุฑู</span>
                        </div>
                        <div class="bg-white p-4 rounded-xl flex items-center justify-between hover:shadow-md transition">
                            <span class="font-semibold text-slate-700">ุชูุงุฑูุฑ ุงุณุชุฑุงุชูุฌูุฉ</span>
                            <span class="badge bg-violet-100 text-violet-700">ุณููู</span>
                        </div>
                    </div>
                </div>

                <div class="bg-gradient-to-br from-rose-50 to-red-50 rounded-2xl p-6 border-r-4 border-rose-500">
                    <h3 class="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2">
                        <i class="fas fa-list-check text-rose-600"></i>
                        ุณูุงุณุงุช ุงูุชูุงุฑูุฑ
                    </h3>
                    <div class="space-y-3 text-sm text-slate-700">
                        <div class="bg-white p-3 rounded-xl flex items-start gap-2">
                            <i class="fas fa-robot text-blue-600 mt-1"></i>
                            <span>ูู ุชูุฑูุฑ ูุฌุจ ุฃู ูููู ุขูู</span>
                        </div>
                        <div class="bg-white p-3 rounded-xl flex items-start gap-2">
                            <i class="fas fa-equals text-green-600 mt-1"></i>
                            <span>ูู ุชูุฑูุฑ ูุฌุจ ุฃู ูููู ููุญุฏ</span>
                        </div>
                        <div class="bg-white p-3 rounded-xl flex items-start gap-2">
                            <i class="fas fa-check-double text-purple-600 mt-1"></i>
                            <span>ูู ุชูุฑูุฑ ูุฌุจ ุฃู ูููู ูุงุจู ููุชุฏููู</span>
                        </div>
                        <div class="bg-white p-3 rounded-xl flex items-start gap-2">
                            <i class="fas fa-database text-orange-600 mt-1"></i>
                            <span>ูู ุชูุฑูุฑ ูุญุชูู ุนูู ูุตุฏุฑ ุงูุจูุงูุงุช</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- AI Governance -->
        <div class="card-glass rounded-3xl shadow-2xl p-6 mb-8 section-accent-indigo">
            <h2 class="text-2xl font-bold text-slate-800 mb-6">๐ค ุญูููุฉ ุงูุฐูุงุก ุงูุงุตุทูุงุนู ุงููุงูู</h2>
            
            <div class="bg-gradient-to-br from-indigo-50 to-purple-50 rounded-2xl p-6 border-r-4 border-indigo-500">
                <h3 class="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2">
                    <i class="fas fa-brain text-indigo-600"></i>
                    ุงูุณูุงุณุงุช
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm text-slate-700">
                    <div class="bg-white p-4 rounded-xl flex items-start gap-3">
                        <i class="fas fa-lightbulb text-amber-600 text-xl mt-1"></i>
                        <div>
                            <div class="font-bold mb-1">ุชูุตูุงุช ููุท</div>
                            <div>ุงูุฐูุงุก ุงูุงุตุทูุงุนู ููุฏู ุชูุตูุงุชุ ูุง ูุฑุงุฑุงุช ููุงุฆูุฉ</div>
                        </div>
                    </div>
                    <div class="bg-white p-4 rounded-xl flex items-start gap-3">
                        <i class="fas fa-glasses text-blue-600 text-xl mt-1"></i>
                        <div>
                            <div class="font-bold mb-1">ูุงุจููุฉ ุงูุชูุณูุฑ</div>
                            <div>ูู ุชูุตูุฉ ูุฌุจ ุฃู ุชููู ูุงุจูุฉ ููุชูุณูุฑ</div>
                        </div>
                    </div>
                    <div class="bg-white p-4 rounded-xl flex items-start gap-3">
                        <i class="fas fa-user-check text-green-600 text-xl mt-1"></i>
                        <div>
                            <div class="font-bold mb-1">ููุงููุฉ ุจุดุฑูุฉ</div>
                            <div>ูุง ุฅุฌุฑุงุก ูุงูู ุขูู ุฏูู ููุงููุฉ ุจุดุฑูุฉ</div>
                        </div>
                    </div>
                    <div class="bg-white p-4 rounded-xl flex items-start gap-3">
                        <i class="fas fa-broom text-purple-600 text-xl mt-1"></i>
                        <div>
                            <div class="font-bold mb-1">ุจูุงูุงุช ูุธููุฉ</div>
                            <div>ุชุฏุฑูุจ ุงูููุงุฐุฌ ุนูู ุจูุงูุงุช ูุธููุฉ ููุท</div>
                        </div>
                    </div>
                    <div class="bg-white p-4 rounded-xl flex items-start gap-3 md:col-span-2">
                        <i class="fas fa-calendar-check text-rose-600 text-xl mt-1"></i>
                        <div>
                            <div class="font-bold mb-1">ูุฑุงุฌุนุฉ ุฏูุฑูุฉ</div>
                            <div>ูุฑุงุฌุนุฉ ุฃุฏุงุก ุงููููุฐุฌ ูู 3 ุฃุดูุฑ</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Risk Governance -->
        <div class="card-glass rounded-3xl shadow-2xl p-6 mb-8 section-accent-rose">
            <h2 class="text-2xl font-bold text-slate-800 mb-6">โ๏ธ ุญูููุฉ ุงููุฎุงุทุฑ ุงููุงููุฉ</h2>
            
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="bg-gradient-to-br from-amber-50 to-orange-50 rounded-2xl p-6 border-r-4 border-amber-500">
                    <h3 class="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2">
                        <i class="fas fa-chart-simple text-amber-600"></i>
                        ุชุตููู ุงููุฎุงุทุฑ
                    </h3>
                    <div class="space-y-3">
                        <div class="bg-white p-4 rounded-xl flex items-center justify-between border-r-4 border-green-500">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 rounded-full bg-green-100 flex items-center justify-center">
                                    <i class="fas fa-circle-check text-green-600"></i>
                                </div>
                                <span class="font-bold text-slate-700">ููุฎูุถ</span>
                            </div>
                            <span class="badge bg-green-100 text-green-700">ุขูู</span>
                        </div>
                        <div class="bg-white p-4 rounded-xl flex items-center justify-between border-r-4 border-yellow-500">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 rounded-full bg-yellow-100 flex items-center justify-center">
                                    <i class="fas fa-circle-exclamation text-yellow-600"></i>
                                </div>
                                <span class="font-bold text-slate-700">ูุชูุณุท</span>
                            </div>
                            <span class="badge bg-yellow-100 text-yellow-700">ูุฑุงูุจุฉ</span>
                        </div>
                        <div class="bg-white p-4 rounded-xl flex items-center justify-between border-r-4 border-orange-500">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 rounded-full bg-orange-100 flex items-center justify-center">
                                    <i class="fas fa-triangle-exclamation text-orange-600"></i>
                                </div>
                                <span class="font-bold text-slate-700">ูุฑุชูุน</span>
                            </div>
                            <span class="badge bg-orange-100 text-orange-700">ุชุญุฐูุฑ</span>
                        </div>
                        <div class="bg-white p-4 rounded-xl flex items-center justify-between border-r-4 border-red-500">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 rounded-full bg-red-100 flex items-center justify-center">
                                    <i class="fas fa-circle-xmark text-red-600"></i>
                                </div>
                                <span class="font-bold text-slate-700">ุญุฑุฌ</span>
                            </div>
                            <span class="badge bg-red-100 text-red-700">ุนุงุฌู</span>
                        </div>
                    </div>
                </div>

                <div class="bg-gradient-to-br from-red-50 to-rose-50 rounded-2xl p-6 border-r-4 border-red-500">
                    <h3 class="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2">
                        <i class="fas fa-gears text-red-600"></i>
                        ุฅุฌุฑุงุกุงุช ุงูุชุนุงูู
                    </h3>
                    <div class="space-y-3 text-sm text-slate-700">
                        <div class="bg-white p-4 rounded-xl">
                            <div class="flex items-center justify-between mb-2">
                                <span class="font-bold text-green-700">ููุฎูุถ</span>
                                <i class="fas fa-bell text-green-600"></i>
                            </div>
                            <div>ุชุฐููุฑ ููุนููู ููุท</div>
                        </div>
                        <div class="bg-white p-4 rounded-xl">
                            <div class="flex items-center justify-between mb-2">
                                <span class="font-bold text-yellow-700">ูุชูุณุท</span>
                                <i class="fas fa-calendar-days text-yellow-600"></i>
                            </div>
                            <div>ุฅูุดุงุก ุฎุทุฉ ุฏูุน ููุนููู</div>
                        </div>
                        <div class="bg-white p-4 rounded-xl">
                            <div class="flex items-center justify-between mb-2">
                                <span class="font-bold text-orange-700">ูุฑุชูุน</span>
                                <i class="fas fa-user-tie text-orange-600"></i>
                            </div>
                            <div>ุชุฏุฎู ุฅุฏุงุฑู ูุจุงุดุฑ</div>
                        </div>
                        <div class="bg-white p-4 rounded-xl">
                            <div class="flex items-center justify-between mb-2">
                                <span class="font-bold text-red-700">ุญุฑุฌ</span>
                                <i class="fas fa-hand text-red-600"></i>
                            </div>
                            <div>ุฅููุงู ุฎุฏูุงุช + ุฎุทุฉ ุฏูุน ุฎุงุตุฉ</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Roles Table -->
        <div class="card-glass rounded-3xl shadow-2xl p-6 mb-8 section-accent-violet">
            <div class="flex items-center justify-between mb-4">
                <div>
                    <h3 class="text-xl font-bold text-slate-800">๐ ุฌุฏูู ุงูุฃุฏูุงุฑ</h3>
                    <p class="text-xs text-slate-500">ุฅุถุงูุฉ/ุชุนุฏูู/ุญุฐู ุงูุฃุฏูุงุฑ ูุน ุญูุธ ูุจุงุดุฑ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช</p>
                </div>
                <span id="rolesCount" class="text-sm text-slate-500"></span>
            </div>
            <div class="table-scroll">
                <table class="w-full text-xs">
                    <thead class="bg-violet-50 text-violet-700 sticky top-0">
                        <tr>
                            <th class="px-4 py-3 text-right">ุงูุฏูุฑ</th>
                            <th class="px-4 py-3 text-right">ุงููุณุชูู</th>
                            <th class="px-4 py-3 text-right">ุญุฏ ุงูููุงููุฉ</th>
                            <th class="px-4 py-3 text-right">ุงูุญุงูุฉ</th>
                            <th class="px-4 py-3 text-right">ุฃุถูู ูู</th>
                            <th class="px-4 py-3 text-right">ุฅุฌุฑุงุกุงุช</th>
                        </tr>
                    </thead>
                    <tbody id="rolesTable" class="divide-y divide-slate-100">
                        <tr>
                            <td colspan="6" class="px-4 py-12 text-center text-slate-500">ุฌุงุฑู ุชุญููู ุงูุจูุงูุงุช...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Permissions Assignments Table -->
        <div class="card-glass rounded-3xl shadow-2xl p-6 section-accent-indigo">
            <div class="flex items-center justify-between mb-4">
                <div>
                    <h3 class="text-xl font-bold text-slate-800">๐ ุฑุจุท ุงูุฃุฏูุงุฑ ุจุงูุฃูุธูุฉ</h3>
                    <p class="text-xs text-slate-500">ุฅุถุงูุฉ/ุชุนุฏูู/ุญุฐู ุตูุงุญูุงุช ุงููุธุงู ููู ุฏูุฑ</p>
                </div>
                <span id="permissionsCount" class="text-sm text-slate-500"></span>
            </div>
            <div class="table-scroll">
                <table class="w-full text-xs">
                    <thead class="bg-indigo-50 text-indigo-700 sticky top-0">
                        <tr>
                            <th class="px-4 py-3 text-right">ุงูุฏูุฑ</th>
                            <th class="px-4 py-3 text-right">ุงููุธุงู</th>
                            <th class="px-4 py-3 text-right">ูุณุชูู ุงูุตูุงุญูุฉ</th>
                            <th class="px-4 py-3 text-right">ุงูุญุงูุฉ</th>
                            <th class="px-4 py-3 text-right">ููุงุญุธุงุช</th>
                            <th class="px-4 py-3 text-right">ุขุฎุฑ ุชุญุฏูุซ</th>
                            <th class="px-4 py-3 text-right">ุฅุฌุฑุงุกุงุช</th>
                        </tr>
                    </thead>
                    <tbody id="permissionsTable" class="divide-y divide-slate-100">
                        <tr>
                            <td colspan="7" class="px-4 py-12 text-center text-slate-500">ุฌุงุฑู ุชุญููู ุงูุจูุงูุงุช...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- ูููุฐุฌ ุฅุฏุงุฑุฉ ุงูุฏูุฑ -->
    <div id="roleModal" class="fixed inset-0 bg-slate-900/70 backdrop-blur-sm flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-3xl shadow-2xl w-full max-w-3xl p-6">
            <div class="flex items-center justify-between mb-4">
                <div>
                    <h3 class="text-xl font-bold text-slate-800" id="roleModalTitle">ุฅุถุงูุฉ ุฏูุฑ ุฌุฏูุฏ</h3>
                    <p class="text-xs text-slate-500">ุฌููุน ุงูุญููู ุชุญูุธ ูุจุงุดุฑุฉ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช</p>
                </div>
                <button class="text-slate-500 hover:text-slate-800" onclick="toggleModal('roleModal', false)"><i class="fas fa-times text-lg"></i></button>
            </div>
            <form id="roleForm" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <input type="hidden" id="roleId">
                <div>
                    <label class="text-xs text-slate-500">ููุฏ ุงูุฏูุฑ (ุฅูุฌููุฒู)*</label>
                    <input id="roleCode" required class="w-full mt-1 rounded-xl border px-3 py-2 focus:ring-2 focus:ring-purple-500">
                </div>
                <div>
                    <label class="text-xs text-slate-500">ุงูุงุณู ุงูุนุฑุจู*</label>
                    <input id="roleNameAr" required class="w-full mt-1 rounded-xl border px-3 py-2 focus:ring-2 focus:ring-purple-500">
                </div>
                <div>
                    <label class="text-xs text-slate-500">ุงููุณูู ุงููุธููู*</label>
                    <input id="roleJobTitleAr" required class="w-full mt-1 rounded-xl border px-3 py-2 focus:ring-2 focus:ring-purple-500">
                </div>
                <div>
                    <label class="text-xs text-slate-500">ุงููุณุชูู (level)</label>
                    <select id="roleLevel" class="w-full mt-1 rounded-xl border px-3 py-2 focus:ring-2 focus:ring-purple-500">
                        <option value="HQ">ุงูููุชุจ ุงูุฑุฆูุณู</option>
                        <option value="BRANCH">ูุฑุน</option>
                        <option value="INCUBATOR">ุญุงุถูุฉ</option>
                        <option value="PLATFORM">ููุตุฉ</option>
                        <option value="OFFICE">ููุชุจ ุชูููุฐู</option>
                        <option value="EXECUTIVE_OFFICE">ุชูููุฐู ููุชุจ</option>
                        <option value="DEPARTMENT">ูุณู/ูุชุทูุน</option>
                    </select>
                </div>
                <div>
                    <label class="text-xs text-slate-500">ุงููุณุชูู ุงููุฑูู</label>
                    <select id="roleHierarchy" class="w-full mt-1 rounded-xl border px-3 py-2 focus:ring-2 focus:ring-purple-500">
                        <option value="0">0 - ุงูููุชุจ ุงูุฑุฆูุณู</option>
                        <option value="1">1 - ูุฑุน</option>
                        <option value="2">2 - ุญุงุถูุฉ</option>
                        <option value="3">3 - ููุตุฉ</option>
                        <option value="4">4 - ููุชุจ ุชูููุฐู</option>
                        <option value="5">5 - ูุณู / ูุชุทูุน</option>
                    </select>
                </div>
                <div>
                    <label class="text-xs text-slate-500">ุญุฏ ุงูููุงููุฉ ุงูุฃุฏูู</label>
                    <input id="roleMinLimit" type="number" step="0.01" class="w-full mt-1 rounded-xl border px-3 py-2 focus:ring-2 focus:ring-purple-500">
                </div>
                <div>
                    <label class="text-xs text-slate-500">ุญุฏ ุงูููุงููุฉ ุงูุฃูุตู</label>
                    <input id="roleMaxLimit" type="number" step="0.01" class="w-full mt-1 rounded-xl border px-3 py-2 focus:ring-2 focus:ring-purple-500">
                </div>
                <div>
                    <label class="text-xs text-slate-500">ููุงุญุธุงุช ุงูููุงููุฉ</label>
                    <textarea id="roleNotes" rows="3" class="w-full mt-1 rounded-xl border px-3 py-2 focus:ring-2 focus:ring-purple-500"></textarea>
                </div>
                <div>
                    <label class="text-xs text-slate-500">ูุตู ุงูุฏูุฑ</label>
                    <textarea id="roleDescription" rows="3" class="w-full mt-1 rounded-xl border px-3 py-2 focus:ring-2 focus:ring-purple-500"></textarea>
                </div>
                <div class="md:col-span-2 flex items-center justify-between">
                    <label class="flex items-center gap-2 text-sm text-slate-700">
                        <input type="checkbox" id="roleIsActive" class="rounded">
                        ูุดุท
                    </label>
                    <div class="flex gap-3">
                        <button type="button" onclick="toggleModal('roleModal', false)" class="px-4 py-2 rounded-xl border text-slate-600">ุฅูุบุงุก</button>
                        <button type="submit" class="px-5 py-2 rounded-xl bg-purple-600 text-white font-bold">ุญูุธ</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- ูููุฐุฌ ุฑุจุท ุงูุตูุงุญูุงุช -->
    <div id="assignmentModal" class="fixed inset-0 bg-slate-900/70 backdrop-blur-sm flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-3xl shadow-2xl w-full max-w-3xl p-6">
            <div class="flex items-center justify-between mb-4">
                <div>
                    <h3 class="text-xl font-bold text-slate-800" id="assignmentModalTitle">ุฅุถุงูุฉ ุตูุงุญูุฉ ููุธุงู</h3>
                    <p class="text-xs text-slate-500">ูุชู ุงูุญูุธ ููุฑุงู ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช</p>
                </div>
                <button class="text-slate-500 hover:text-slate-800" onclick="toggleModal('assignmentModal', false)"><i class="fas fa-times text-lg"></i></button>
            </div>
            <form id="assignmentForm" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <input type="hidden" id="assignmentId">
                <div>
                    <label class="text-xs text-slate-500">ุงุฎุชูุงุฑ ุงูุฏูุฑ*</label>
                    <select id="assignmentRole" required class="w-full mt-1 rounded-xl border px-3 py-2 focus:ring-2 focus:ring-indigo-500"></select>
                </div>
                <div>
                    <label class="text-xs text-slate-500">ุงุฎุชูุงุฑ ุงููุธุงู*</label>
                    <select id="assignmentSystem" required class="w-full mt-1 rounded-xl border px-3 py-2 focus:ring-2 focus:ring-indigo-500"></select>
                </div>
                <div>
                    <label class="text-xs text-slate-500">ูุณุชูู ุงูุตูุงุญูุฉ*</label>
                    <select id="assignmentLevel" required class="w-full mt-1 rounded-xl border px-3 py-2 focus:ring-2 focus:ring-indigo-500"></select>
                </div>
                <div>
                    <label class="text-xs text-slate-500">ููุงุญุธุงุช</label>
                    <textarea id="assignmentNotes" rows="3" class="w-full mt-1 rounded-xl border px-3 py-2 focus:ring-2 focus:ring-indigo-500"></textarea>
                </div>
                <div class="md:col-span-2 flex items-center justify-between">
                    <label class="flex items-center gap-2 text-sm text-slate-700">
                        <input type="checkbox" id="assignmentActive" class="rounded">
                        ูุดุท
                    </label>
                    <div class="flex gap-3">
                        <button type="button" onclick="toggleModal('assignmentModal', false)" class="px-4 py-2 rounded-xl border text-slate-600">ุฅูุบุงุก</button>
                        <button type="submit" class="px-5 py-2 rounded-xl bg-indigo-600 text-white font-bold">ุญูุธ</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <script>
        const API_BASE = window.location.origin;
        const hierarchyLabels = {
            0: 'ุงูููุชุจ ุงูุฑุฆูุณู',
            1: 'ูุฑุน',
            2: 'ุญุงุถูุฉ',
            3: 'ููุตุฉ',
            4: 'ููุชุจ ุชูููุฐู',
            5: 'ูุณู / ูุชุทูุน'
        };

        let roles = [];
        let stats = {};
        let assignments = [];
        let systems = [];
        let levels = [];
        let editingRoleId = null;
        let editingAssignmentId = null;

        const messageBox = document.getElementById('messageBox');
        const previewCard = document.getElementById('previewCard');

        async function loadData() {
            try {
                const [rolesRes, statsRes, assignmentsRes, systemsRes, levelsRes] = await Promise.all([
                    fetch(`${API_BASE}/api/permissions/roles`),
                    fetch(`${API_BASE}/api/permissions/stats`),
                    fetch(`${API_BASE}/api/permissions/assignments`),
                    fetch(`${API_BASE}/api/permissions/systems`),
                    fetch(`${API_BASE}/api/permissions/levels`)
                ]);

                const [rolesData, statsData, assignmentsData, systemsData, levelsData] = await Promise.all([
                    rolesRes.json(),
                    statsRes.json(),
                    assignmentsRes.json(),
                    systemsRes.json(),
                    levelsRes.json()
                ]);

                roles = rolesData.roles || [];
                stats = statsData.stats || {};
                assignments = assignmentsData.assignments || [];
                systems = systemsData.systems || [];
                levels = levelsData.levels || [];

                populateSelectors();
                renderStats();
                renderTables();
                showMessage('ุชู ุชุญุฏูุซ ุงูุจูุงูุงุช ุจูุฌุงุญ', 'success');
            } catch (error) {
                console.error('ุฎุทุฃ ูู ุชุญููู ุงูุจูุงูุงุช:', error);
                showMessage('ุชุนุฐุฑ ุชุญููู ุงูุจูุงูุงุชุ ุญุงูู ูุฌุฏุฏุงู', 'error');
            }
        }

        function renderStats() {
            document.getElementById('totalRoles').textContent = roles.length || 0;
            document.getElementById('totalPermissions').textContent = stats.total_permissions || assignments.length || 0;

            const uniqueLevels = new Set(roles.map(r => r.hierarchy_level).filter(l => l !== null && l !== undefined));
            document.getElementById('activeLevels').textContent = uniqueLevels.size || 4;
            document.getElementById('activeUsers').textContent = 'โ';
        }

        function renderTables() {
            const rolesRows = roles.map((r) => {
                const levelLabel = hierarchyLabels[r.hierarchy_level] || `ูุณุชูู ${r.hierarchy_level}`;
                const maxLimit = formatLimit(r.max_approval_limit);
                return `
                <tr class="hover:bg-violet-50 transition">
                    <td class="px-4 py-3">
                        <div class="font-bold text-slate-800">${escapeHTML(r.job_title_ar || r.name_ar)}</div>
                        <div class="text-[11px] text-slate-500">${escapeHTML(r.name)}</div>
                    </td>
                    <td class="px-4 py-3">
                        <span class="badge ${getLevelColor(r.hierarchy_level)}">${levelLabel}</span>
                    </td>
                    <td class="px-4 py-3">${maxLimit}</td>
                    <td class="px-4 py-3">${statusBadge(r.is_active)}</td>
                    <td class="px-4 py-3 text-slate-500">${formatDateTime(r.created_at)}</td>
                    <td class="px-4 py-3 flex flex-wrap gap-2">
                        <button class="text-xs px-3 py-2 rounded-lg bg-purple-50 text-purple-700" onclick="previewRole(${r.id})"><i class="fas fa-eye"></i> ูุนุงููุฉ</button>
                        <button class="text-xs px-3 py-2 rounded-lg bg-indigo-50 text-indigo-700" onclick="openRoleForm(${r.id})"><i class="fas fa-pen"></i> ุชุนุฏูู</button>
                        <button class="text-xs px-3 py-2 rounded-lg bg-rose-50 text-rose-700" onclick="confirmDeleteRole(${r.id})"><i class="fas fa-trash"></i> ุญุฐู</button>
                    </td>
                </tr>`;
            }).join('');

            document.getElementById('rolesTable').innerHTML = rolesRows || `<tr><td colspan="6" class="px-4 py-12 text-center text-slate-500">ูุง ุชูุฌุฏ ุจูุงูุงุช</td></tr>`;
            document.getElementById('rolesCount').textContent = `ุนุฏุฏ ุงูุฃุฏูุงุฑ: ${roles.length}`;

            const permissionsRows = assignments.map((p) => `
                <tr class="hover:bg-indigo-50 transition">
                    <td class="px-4 py-3">
                        <div class="font-bold">${escapeHTML(p.role_name_ar)}</div>
                        <div class="text-[11px] text-slate-500">${hierarchyLabels[p.hierarchy_level] || 'โ'}</div>
                    </td>
                    <td class="px-4 py-3">
                        <div class="font-semibold text-slate-800">${escapeHTML(p.system_name_ar)}</div>
                        <div class="text-[11px] text-slate-500">${escapeHTML(p.system_code)}</div>
                    </td>
                    <td class="px-4 py-3">
                        <span class="badge bg-indigo-100 text-indigo-700">${escapeHTML(p.level_name_ar)}</span>
                    </td>
                    <td class="px-4 py-3">${statusBadge(p.is_active)}</td>
                    <td class="px-4 py-3 text-slate-600">${escapeHTML(p.notes || 'โ')}</td>
                    <td class="px-4 py-3 text-slate-500">${formatDateTime(p.updated_at || p.created_at)}</td>
                    <td class="px-4 py-3 flex flex-wrap gap-2">
                        <button class="text-xs px-3 py-2 rounded-lg bg-purple-50 text-purple-700" onclick="openAssignmentForm(${p.id})"><i class="fas fa-eye"></i> ูุนุงููุฉ</button>
                        <button class="text-xs px-3 py-2 rounded-lg bg-indigo-50 text-indigo-700" onclick="openAssignmentForm(${p.id})"><i class="fas fa-pen"></i> ุชุนุฏูู</button>
                        <button class="text-xs px-3 py-2 rounded-lg bg-rose-50 text-rose-700" onclick="confirmDeleteAssignment(${p.id})"><i class="fas fa-trash"></i> ุญุฐู</button>
                    </td>
                </tr>
            `).join('');

            document.getElementById('permissionsTable').innerHTML = permissionsRows || `<tr><td colspan="7" class="px-4 py-12 text-center text-slate-500">ูุง ุชูุฌุฏ ุจูุงูุงุช</td></tr>`;
            document.getElementById('permissionsCount').textContent = `ุนุฏุฏ ุงูุณุฌูุงุช: ${assignments.length}`;
        }

        function statusBadge(isActive) {
            return `<span class="badge ${getStatusColor(isActive)}">${translateStatus(isActive)}</span>`;
        }

        function getLevelColor(level) {
            const colorMap = {
                0: 'bg-emerald-100 text-emerald-700',
                1: 'bg-sky-100 text-sky-700',
                2: 'bg-violet-100 text-violet-700',
                3: 'bg-blue-100 text-blue-700',
                4: 'bg-rose-100 text-rose-700',
                5: 'bg-amber-100 text-amber-700'
            };
            return colorMap[level] || 'bg-slate-100 text-slate-700';
        }

        function getStatusColor(isActive) {
            return isActive ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700';
        }

        function translateStatus(isActive) {
            return isActive ? 'ูุดุท' : 'ูุชููู';
        }

        function formatDateTime(value) {
            if (!value) return 'โ';
            return new Date(value).toLocaleString('ar-SA');
        }

        function formatLimit(value) {
            if (value === null || value === undefined) return 'โ';
            const num = Number(value);
            return Number.isNaN(num) ? 'โ' : num.toLocaleString('ar-EG', { minimumFractionDigits: 0 });
        }

        function escapeHTML(value) {
            if (value === null || value === undefined) return 'โ';
            return String(value)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');
        }

        function showMessage(text, type = 'success') {
            if (!messageBox) return;
            const styles = type === 'success'
                ? 'bg-emerald-50 border-emerald-200 text-emerald-700'
                : 'bg-rose-50 border-rose-200 text-rose-700';
            messageBox.className = `mb-6 p-4 rounded-2xl border text-sm font-bold ${styles}`;
            messageBox.textContent = text;
            messageBox.classList.remove('hidden');
            setTimeout(() => messageBox.classList.add('hidden'), 3000);
        }

        function toggleModal(id, show = true) {
            const el = document.getElementById(id);
            if (!el) return;
            if (show) {
                el.classList.remove('hidden');
            } else {
                el.classList.add('hidden');
            }
        }

        function populateSelectors() {
            const roleSelect = document.getElementById('assignmentRole');
            const systemSelect = document.getElementById('assignmentSystem');
            const levelSelect = document.getElementById('assignmentLevel');
            if (roleSelect) {
                roleSelect.innerHTML = roles.map(r => `<option value="${r.id}">${escapeHTML(r.job_title_ar || r.name_ar)}</option>`).join('');
            }
            if (systemSelect) {
                systemSelect.innerHTML = systems.map(s => `<option value="${s.id}">${escapeHTML(s.system_name_ar)} (${escapeHTML(s.system_code)})</option>`).join('');
            }
            if (levelSelect) {
                levelSelect.innerHTML = levels.map(l => `<option value="${l.id}">${escapeHTML(l.level_name_ar)} (${escapeHTML(l.level_code)})</option>`).join('');
            }
        }

        function openRoleForm(id = null) {
            editingRoleId = id;
            document.getElementById('roleModalTitle').textContent = id ? 'ุชุนุฏูู ุงูุฏูุฑ' : 'ุฅุถุงูุฉ ุฏูุฑ ุฌุฏูุฏ';
            const role = roles.find(r => r.id === id);
            document.getElementById('roleId').value = role?.id || '';
            document.getElementById('roleCode').value = role?.name || '';
            document.getElementById('roleNameAr').value = role?.name_ar || '';
            document.getElementById('roleJobTitleAr').value = role?.job_title_ar || '';
            document.getElementById('roleLevel').value = role?.level || 'HQ';
            document.getElementById('roleHierarchy').value = role?.hierarchy_level ?? 0;
            document.getElementById('roleMinLimit').value = role?.min_approval_limit ?? '';
            document.getElementById('roleMaxLimit').value = role?.max_approval_limit ?? '';
            document.getElementById('roleNotes').value = role?.approval_notes_ar || '';
            document.getElementById('roleDescription').value = role?.description || '';
            document.getElementById('roleIsActive').checked = role?.is_active ?? true;
            toggleModal('roleModal', true);
        }

        function previewRole(id) {
            const role = roles.find(r => r.id === id);
            if (!role) return;
            document.getElementById('previewTitle').textContent = role.job_title_ar || role.name_ar || 'โ';
            document.getElementById('previewSubtitle').textContent = role.name || 'โ';
            document.getElementById('previewStatus').textContent = translateStatus(role.is_active);
            document.getElementById('previewStatus').className = `badge ${getStatusColor(role.is_active)}`;
            document.getElementById('previewDetails').innerHTML = `
                <div class="bg-slate-50 p-3 rounded-xl">
                    <div class="text-[11px] text-slate-500">ุงููุณุชูู</div>
                    <div class="font-bold">${hierarchyLabels[role.hierarchy_level] || 'โ'}</div>
                </div>
                <div class="bg-slate-50 p-3 rounded-xl">
                    <div class="text-[11px] text-slate-500">ุญุฏ ุงูููุงููุฉ</div>
                    <div class="font-bold">${formatLimit(role.max_approval_limit)}</div>
                </div>
                <div class="bg-slate-50 p-3 rounded-xl">
                    <div class="text-[11px] text-slate-500">ุงููุตู</div>
                    <div class="font-bold">${escapeHTML(role.description || 'โ')}</div>
                </div>
            `;
            previewCard.classList.remove('hidden');
        }

        async function saveRole(event) {
            event.preventDefault();
            const payload = {
                role_code: document.getElementById('roleCode').value,
                name_ar: document.getElementById('roleNameAr').value,
                job_title_ar: document.getElementById('roleJobTitleAr').value,
                level: document.getElementById('roleLevel').value,
                hierarchy_level: Number(document.getElementById('roleHierarchy').value),
                min_approval_limit: document.getElementById('roleMinLimit').value,
                max_approval_limit: document.getElementById('roleMaxLimit').value,
                approval_notes_ar: document.getElementById('roleNotes').value,
                description: document.getElementById('roleDescription').value,
                is_active: document.getElementById('roleIsActive').checked
            };

            const method = editingRoleId ? 'PUT' : 'POST';
            const url = editingRoleId ? `${API_BASE}/api/permissions/roles/${editingRoleId}` : `${API_BASE}/api/permissions/roles`;

            const response = await fetch(url, {
                method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            const data = await response.json();
            if (!response.ok) throw new Error(data.error || 'ูุดู ุงูุญูุธ');

            showMessage('ุชู ุญูุธ ุงูุฏูุฑ ุจูุฌุงุญ', 'success');
            toggleModal('roleModal', false);
            loadData();
        }

        async function confirmDeleteRole(id) {
            if (!confirm('ุชุฃููุฏ ุญุฐู ุงูุฏูุฑุ ุณูุชู ุฅููุงูู ูุฅููุงู ุตูุงุญูุงุชู.')) return;
            const response = await fetch(`${API_BASE}/api/permissions/roles/${id}`, { method: 'DELETE' });
            const data = await response.json();
            if (!response.ok) throw new Error(data.error || 'ุชุนุฐุฑ ุงูุญุฐู');
            showMessage('ุชู ุฅููุงู ุงูุฏูุฑ ูุงูุตูุงุญูุงุช ุงููุฑุชุจุทุฉ ุจู', 'success');
            loadData();
        }

        function openAssignmentForm(id = null) {
            editingAssignmentId = id;
            const assignment = assignments.find(a => a.id === id);
            document.getElementById('assignmentModalTitle').textContent = id ? 'ุชุนุฏูู ุตูุงุญูุฉ' : 'ุฅุถุงูุฉ ุตูุงุญูุฉ ููุธุงู';
            document.getElementById('assignmentId').value = assignment?.id || '';
            document.getElementById('assignmentRole').value = assignment?.role_id || (roles[0]?.id || '');
            document.getElementById('assignmentSystem').value = assignment?.system_id || (systems[0]?.id || '');
            document.getElementById('assignmentLevel').value = assignment?.permission_level_id || (levels[0]?.id || '');
            document.getElementById('assignmentNotes').value = assignment?.notes || '';
            document.getElementById('assignmentActive').checked = assignment?.is_active ?? true;
            toggleModal('assignmentModal', true);
        }

        async function saveAssignment(event) {
            event.preventDefault();
            const payload = {
                role_id: Number(document.getElementById('assignmentRole').value),
                system_id: Number(document.getElementById('assignmentSystem').value),
                permission_level_id: Number(document.getElementById('assignmentLevel').value),
                notes: document.getElementById('assignmentNotes').value,
                is_active: document.getElementById('assignmentActive').checked
            };

            const method = editingAssignmentId ? 'PUT' : 'POST';
            const url = editingAssignmentId
                ? `${API_BASE}/api/permissions/assignments/${editingAssignmentId}`
                : `${API_BASE}/api/permissions/assignments`;

            const response = await fetch(url, {
                method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            const data = await response.json();
            if (!response.ok) throw new Error(data.error || 'ูุดู ุงูุญูุธ');
            showMessage('ุชู ุญูุธ ุงูุตูุงุญูุฉ ุจูุฌุงุญ', 'success');
            toggleModal('assignmentModal', false);
            loadData();
        }

        async function confirmDeleteAssignment(id) {
            if (!confirm('ุชุฃููุฏ ุญุฐู/ุชุนุทูู ูุฐู ุงูุตูุงุญูุฉุ')) return;
            const response = await fetch(`${API_BASE}/api/permissions/assignments/${id}`, { method: 'DELETE' });
            const data = await response.json();
            if (!response.ok) throw new Error(data.error || 'ุชุนุฐุฑ ุงูุญุฐู');
            showMessage('ุชู ุฅููุงู ุงูุตูุงุญูุฉ', 'success');
            loadData();
        }

        function downloadAllJSON() {
            const payload = {
                roles,
                assignments,
                stats,
                governance: {
                    data_governance: {
                        policies: [
                            'ูู ุนูููุฉ ูุงููุฉ ูุฌุจ ุฃู ุชุญุชูู ุนูู: ุชุงุฑูุฎ - ูุณุชุฎุฏู - ูุตุฏุฑ - ูุฑููุงุช',
                            'ูุง ููุณูุญ ุจุญุฐู ุฃู ุณุฌู ูุงูู',
                            'ุงูุชุนุฏูู ูุชู ุนุจุฑ: ุฅุดุนุงุฑ ุฏุงุฆู/ูุฏูู - ููุฏ ุนูุณู'
                        ],
                        audit: ['ุชุฏููู ุดูุฑู ุฏุงุฎูู', 'ุชุฏููู ุฑุจุน ุณููู', 'ุชุฏููู ุณููู ุฎุงุฑุฌู']
                    },
                    reporting_governance: {
                        types: ['ุชุดุบูููุฉ', 'ุชูุชูููุฉ', 'ุงุณุชุฑุงุชูุฌูุฉ'],
                        policies: ['ุขูู', 'ููุญุฏ', 'ูุงุจู ููุชุฏููู', 'ูุญุชูู ุนูู ูุตุฏุฑ ุงูุจูุงูุงุช']
                    },
                    ai_governance: {
                        policies: [
                            'ุงูุฐูุงุก ุงูุงุตุทูุงุนู ููุฏู ุชูุตูุงุชุ ูุง ูุฑุงุฑุงุช ููุงุฆูุฉ',
                            'ูู ุชูุตูุฉ ูุฌุจ ุฃู ุชููู ูุงุจูุฉ ููุชูุณูุฑ',
                            'ูุง ุฅุฌุฑุงุก ูุงูู ุขูู ุฏูู ููุงููุฉ ุจุดุฑูุฉ',
                            'ุชุฏุฑูุจ ุงูููุงุฐุฌ ุนูู ุจูุงูุงุช ูุธููุฉ ููุท',
                            'ูุฑุงุฌุนุฉ ุฃุฏุงุก ุงููููุฐุฌ ูู 3 ุฃุดูุฑ'
                        ]
                    },
                    risk_governance: {
                        classifications: ['ููุฎูุถ', 'ูุชูุณุท', 'ูุฑุชูุน', 'ุญุฑุฌ'],
                        actions: {
                            low: 'ุชุฐููุฑ',
                            medium: 'ุฎุทุฉ ุฏูุน',
                            high: 'ุชุฏุฎู ุฅุฏุงุฑู',
                            critical: 'ุฅููุงู ุฎุฏูุงุช + ุฎุทุฉ ุฏูุน ุฎุงุตุฉ'
                        }
                    }
                }
            };
            downloadBlob(JSON.stringify(payload, null, 2), 'ุงูููุงููุงุช-ูุงูุตูุงุญูุงุช-ูุงูุญูููุฉ.json', 'application/json');
        }

        function downloadBlob(content, filename, type) {
            const blob = new Blob([content], { type });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            link.click();
            URL.revokeObjectURL(url);
        }

        function printReport() {
            window.print();
        }

        function refreshData() {
            loadData();
        }

        document.getElementById('roleForm').addEventListener('submit', (e) => {
            saveRole(e).catch(err => {
                console.error(err);
                showMessage(err.message, 'error');
            });
        });

        document.getElementById('assignmentForm').addEventListener('submit', (e) => {
            saveAssignment(e).catch(err => {
                console.error(err);
                showMessage(err.message, 'error');
            });
        });

        document.addEventListener('DOMContentLoaded', loadData);
    </script>
</body>
</html>
