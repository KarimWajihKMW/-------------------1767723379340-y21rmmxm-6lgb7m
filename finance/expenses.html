<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ§¾ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª ÙˆØ§Ù„Ù…ÙˆØ±Ø¯ÙˆÙ† - Ù†Ø¸Ø§Ù… Ù†Ø§ÙŠÙˆØ´</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Cairo', sans-serif;
            background: #f9fafb; /* Slate-50 */
            min-height: 100vh;
        <script>
            const API_BASE = window.location.origin;
            const ENTITY_ID = window.getFinanceEntityId ? window.getFinanceEntityId() : 'HQ001';
            const DEFAULT_BRANCH_ID = 'BR001';
            const DEFAULT_INCUBATOR_ID = 'INC01';
            const EXPENSE_STATUS_LABELS = {
                approved: 'Ù…Ø¹ØªÙ…Ø¯',
                pending: 'Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©',
                rejected: 'Ù…Ø±ÙÙˆØ¶',
                paid: 'Ù…Ø¯ÙÙˆØ¹',
                draft: 'Ù…Ø³ÙˆØ¯Ø©'
            };
            const EXPENSE_CATEGORY_LABELS = {
                travel: 'Ø³ÙØ±',
                utilities: 'Ù…Ø±Ø§ÙÙ‚',
                marketing: 'ØªØ³ÙˆÙŠÙ‚',
                operations: 'ØªØ´ØºÙŠÙ„',
                logistics: 'Ù„ÙˆØ¬Ø³ØªÙŠØ§Øª',
                maintenance: 'ØµÙŠØ§Ù†Ø©',
                rent: 'Ø¥ÙŠØ¬Ø§Ø±',
                it: 'ØªÙ‚Ù†ÙŠØ© Ù…Ø¹Ù„ÙˆÙ…Ø§Øª',
                services: 'Ø®Ø¯Ù…Ø§Øª',
                supplies: 'Ù…Ø³ØªÙ„Ø²Ù…Ø§Øª'
            };
            const EXPENSE_TYPE_LABELS = {
                operational: 'ØªØ´ØºÙŠÙ„ÙŠ',
                capital: 'Ø±Ø£Ø³Ù…Ø§Ù„ÙŠ',
                administrative: 'Ø¥Ø¯Ø§Ø±ÙŠ',
                marketing: 'ØªØ³ÙˆÙŠÙ‚',
                utility: 'Ù…Ø±Ø§ÙÙ‚',
                logistics: 'Ù„ÙˆØ¬Ø³ØªÙŠØ§Øª'
            };
            let expenses = [];
            let vendors = [];
            let categoryChartInstance = null;
            let statusChartInstance = null;

            async function loadReport() {
                try {
                    const response = await fetch(`${API_BASE}/finance/expenses?entity_id=${ENTITY_ID}`, {
                        headers: window.getFinanceHeaders ? window.getFinanceHeaders() : {}
                    });
                    const data = await response.json();

                    if (!data.success) throw new Error(data.error || 'ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙ‚Ø±ÙŠØ±');

                    expenses = data.expenses || [];
                    vendors = data.vendors || [];

                    renderSummary(data.summary || {});
                    renderExpensesTable(expenses);
                    renderVendorsTable(vendors);
                    renderCharts(data.summary || {});
                    renderInfo(data.summary || {});
                } catch (error) {
                    console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙ‚Ø±ÙŠØ±:', error);
                    document.getElementById('expensesTable').innerHTML = `
                        <tr>
                            <td colspan="28" class="px-4 py-12 text-center text-red-500">
                                <i class="fas fa-exclamation-triangle text-4xl mb-3"></i>
                                <div>ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª</div>
                            </td>
                        </tr>
                    `;
                }
            }

            function applyFilters() {
                const params = new URLSearchParams({ entity_id: ENTITY_ID });
                const expenseNumber = document.getElementById('expenseNumber').value;
                const vendorName = document.getElementById('vendorName').value;
                const expenseCategory = document.getElementById('expenseCategory').value;
                const expenseType = document.getElementById('expenseType').value;
                const status = document.getElementById('status').value;
                const invoiceNumber = document.getElementById('invoiceNumber').value;
                const fromDate = document.getElementById('fromDate').value;
                const toDate = document.getElementById('toDate').value;

                if (expenseNumber) params.append('expense_number', expenseNumber);
                if (vendorName) params.append('vendor_name', vendorName);
                if (expenseCategory) params.append('expense_category', expenseCategory);
                if (expenseType) params.append('expense_type', expenseType);
                if (status) params.append('status', status);
                if (invoiceNumber) params.append('invoice_number', invoiceNumber);
                if (fromDate) params.append('from_date', fromDate);
                if (toDate) params.append('to_date', toDate);

                fetch(`${API_BASE}/finance/expenses?${params.toString()}`, {
                    headers: window.getFinanceHeaders ? window.getFinanceHeaders() : {}
                })
                    .then(res => res.json())
                    .then(data => {
                        if (!data.success) throw new Error(data.error || 'ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙ‚Ø±ÙŠØ±');
                        expenses = data.expenses || [];
                        vendors = data.vendors || [];
                        renderSummary(data.summary || {});
                        renderExpensesTable(expenses);
                        renderVendorsTable(vendors);
                        renderCharts(data.summary || {});
                        renderInfo(data.summary || {});
                    })
                    .catch(err => console.error('âŒ', err));
            }

            function resetFilters() {
                document.getElementById('expenseNumber').value = '';
                document.getElementById('vendorName').value = '';
                document.getElementById('expenseCategory').value = '';
                document.getElementById('expenseType').value = '';
                document.getElementById('status').value = '';
                document.getElementById('invoiceNumber').value = '';
                document.getElementById('fromDate').value = '';
                document.getElementById('toDate').value = '';
                applyFilters();
            }

            function renderSummary(summary) {
                document.getElementById('totalExpenses').textContent = summary.total_expenses ?? 0;
                document.getElementById('totalAmount').textContent = formatMoney(summary.total_amount || 0);
                document.getElementById('totalTax').textContent = formatMoney(summary.total_tax || 0);
                document.getElementById('totalVendors').textContent = summary.total_vendors ?? 0;
            }

            function renderExpensesTable(rows) {
                const body = rows.map(r => `
                    <tr class="hover:bg-emerald-50">
                        <td class="px-3 py-2">${r.expense_id ?? '-'}</td>
                        <td class="px-3 py-2">${r.expense_number ?? '-'}</td>
                        <td class="px-3 py-2">${formatDate(r.expense_date)}</td>
                        <td class="px-3 py-2">${translateExpenseCategory(r.expense_category)}</td>
                        <td class="px-3 py-2">${translateExpenseType(r.expense_type)}</td>
                        <td class="px-3 py-2">${r.vendor_id ?? '-'}</td>
                        <td class="px-3 py-2">${r.vendor_name ?? '-'}</td>
                        <td class="px-3 py-2 font-semibold text-emerald-700">${formatMoney(r.amount)}</td>
                        <td class="px-3 py-2">${formatMoney(r.tax_amount)}</td>
                        <td class="px-3 py-2">${formatMoney(r.total_amount)}</td>
                        <td class="px-3 py-2">${translateExpenseStatus(r.status)}</td>
                        <td class="px-3 py-2">${r.entity_type ?? '-'}</td>
                        <td class="px-3 py-2">${r.entity_id ?? '-'}</td>
                        <td class="px-3 py-2">${r.branch_id ?? '-'}</td>
                        <td class="px-3 py-2">${r.incubator_id ?? '-'}</td>
                        <td class="px-3 py-2">${r.platform_id ?? '-'}</td>
                        <td class="px-3 py-2">${r.journal_entry_id ?? '-'}</td>
                        <td class="px-3 py-2">${r.invoice_number ?? '-'}</td>
                        <td class="px-3 py-2">${r.receipt_file ?? '-'}</td>
                        <td class="px-3 py-2"><div class="json-pill">${renderJson(r.attachments)}</div></td>
                        <td class="px-3 py-2">${r.description ?? '-'}</td>
                        <td class="px-3 py-2">${r.notes ?? '-'}</td>
                        <td class="px-3 py-2">${formatDateTime(r.created_at)}</td>
                        <td class="px-3 py-2">${formatDateTime(r.updated_at)}</td>
                        <td class="px-3 py-2">${r.created_by ?? '-'}</td>
                        <td class="px-3 py-2">${r.approved_by ?? '-'}</td>
                        <td class="px-3 py-2">${formatDateTime(r.approved_at)}</td>
                        <td class="px-3 py-2">
                            <div class="flex gap-2">
                                <button onclick="openViewExpense(${r.expense_id})" class="p-2 text-indigo-600 hover:bg-indigo-50 rounded-lg transition" title="Ù…Ø¹Ø§ÙŠÙ†Ø©">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button onclick="openEditExpense(${r.expense_id})" class="p-2 text-blue-600 hover:bg-blue-50 rounded-lg transition" title="ØªØ¹Ø¯ÙŠÙ„">
                                    <i class="fas fa-pen"></i>
                                </button>
                                <button onclick="deleteExpense(${r.expense_id})" class="p-2 text-red-600 hover:bg-red-50 rounded-lg transition" title="Ø­Ø°Ù">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `).join('');

                document.getElementById('expensesTable').innerHTML = body.length ? body : `
                    <tr>
                        <td colspan="28" class="px-4 py-12 text-center text-gray-500">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</td>
                    </tr>
                `;
                document.getElementById('expensesCount').textContent = `Ø¹Ø¯Ø¯ Ø§Ù„ØµÙÙˆÙ: ${rows.length}`;
            }

            function renderVendorsTable(rows) {
                const body = rows.map(r => `
                    <tr class="hover:bg-indigo-50">
                        <td class="px-3 py-2">${r.vendor_id ?? '-'}</td>
                        <td class="px-3 py-2">${r.vendor_code ?? '-'}</td>
                        <td class="px-3 py-2">${r.vendor_name_ar ?? '-'}</td>
                        <td class="px-3 py-2">${r.vendor_name_en ?? '-'}</td>
                        <td class="px-3 py-2">${r.vendor_type ?? '-'}</td>
                        <td class="px-3 py-2">${r.email ?? '-'}</td>
                        <td class="px-3 py-2">${r.phone ?? '-'}</td>
                        <td class="px-3 py-2">${r.mobile ?? '-'}</td>
                        <td class="px-3 py-2">${r.address ?? '-'}</td>
                        <td class="px-3 py-2">${r.city ?? '-'}</td>
                        <td class="px-3 py-2">${r.country ?? '-'}</td>
                        <td class="px-3 py-2">${r.tax_number ?? '-'}</td>
                        <td class="px-3 py-2">${r.commercial_registration ?? '-'}</td>
                        <td class="px-3 py-2">${r.payment_terms ?? '-'}</td>
                        <td class="px-3 py-2">${r.payment_term_days ?? '-'}</td>
                        <td class="px-3 py-2">${r.entity_type ?? '-'}</td>
                        <td class="px-3 py-2">${r.entity_id ?? '-'}</td>
                        <td class="px-3 py-2">${r.is_active === true ? 'Ù†Ø¹Ù…' : r.is_active === false ? 'Ù„Ø§' : '-'}</td>
                        <td class="px-3 py-2">${formatDateTime(r.created_at)}</td>
                        <td class="px-3 py-2">${formatDateTime(r.updated_at)}</td>
                        <td class="px-3 py-2">${r.created_by ?? '-'}</td>
                        <td class="px-3 py-2">
                            <div class="flex gap-2">
                                <button onclick="openViewVendor(${r.vendor_id})" class="p-2 text-indigo-600 hover:bg-indigo-50 rounded-lg transition" title="Ù…Ø¹Ø§ÙŠÙ†Ø©">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button onclick="openEditVendor(${r.vendor_id})" class="p-2 text-blue-600 hover:bg-blue-50 rounded-lg transition" title="ØªØ¹Ø¯ÙŠÙ„">
                                    <i class="fas fa-pen"></i>
                                </button>
                                <button onclick="deleteVendor(${r.vendor_id})" class="p-2 text-red-600 hover:bg-red-50 rounded-lg transition" title="Ø­Ø°Ù">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `).join('');

                document.getElementById('vendorsTable').innerHTML = body.length ? body : `
                    <tr>
                        <td colspan="22" class="px-4 py-12 text-center text-gray-500">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</td>
                    </tr>
                `;
                document.getElementById('vendorsCount').textContent = `Ø¹Ø¯Ø¯ Ø§Ù„ØµÙÙˆÙ: ${rows.length}`;
            }

            function translateExpenseStatus(value) {
                if (!value) return '-';
                const key = value.toLowerCase();
                return EXPENSE_STATUS_LABELS[key] || value;
            }

            function translateExpenseCategory(value) {
                if (!value) return '-';
                const key = value.toLowerCase();
                return EXPENSE_CATEGORY_LABELS[key] || value;
            }

            function translateExpenseType(value) {
                if (!value) return '-';
                const key = value.toLowerCase();
                return EXPENSE_TYPE_LABELS[key] || value;
            }

            function openAddExpense() {
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black/40 flex items-start justify-center z-50 p-4 overflow-y-auto';
                modal.innerHTML = `
                    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl my-6">
                        <div class="p-5 border-b flex items-center justify-between">
                            <h3 class="font-bold text-lg">Ø¥Ø¶Ø§ÙØ© Ù…ØµØ±ÙˆÙ</h3>
                            <button onclick="this.closest('.fixed').remove()" class="text-gray-500 hover:text-gray-700"><i class="fas fa-times"></i></button>
                        </div>
                        <div class="p-5 grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                            <div>
                                <label class="block mb-1 text-gray-600">Ø±Ù‚Ù… Ø§Ù„Ù…ØµØ±ÙˆÙ</label>
                                <input id="add-expense-number" type="text" class="w-full border rounded-lg px-3 py-2" value="Ù…ØµØ±ÙˆÙ-${Date.now()}">
                            </div>
                            <div>
                                <label class="block mb-1 text-gray-600">ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ØµØ±ÙˆÙ</label>
                                <input id="add-expense-date" type="date" class="w-full border rounded-lg px-3 py-2">
                            </div>
                            <div>
                                <label class="block mb-1 text-gray-600">ÙØ¦Ø© Ø§Ù„Ù…ØµØ±ÙˆÙ</label>
                                <input id="add-expense-category" type="text" class="w-full border rounded-lg px-3 py-2" placeholder="Ø³ÙØ± / ØªØ´ØºÙŠÙ„ / ØµÙŠØ§Ù†Ø©">
                            </div>
                            <div>
                                <label class="block mb-1 text-gray-600">Ù†ÙˆØ¹ Ø§Ù„Ù…ØµØ±ÙˆÙ</label>
                                <input id="add-expense-type" type="text" class="w-full border rounded-lg px-3 py-2" placeholder="ØªØ´ØºÙŠÙ„ÙŠ / Ø±Ø£Ø³Ù…Ø§Ù„ÙŠ">
                            </div>
                            <div>
                                <label class="block mb-1 text-gray-600">Ø±Ù‚Ù… Ø§Ù„Ù…ÙˆØ±Ø¯</label>
                                <input id="add-expense-vendor-id" type="number" class="w-full border rounded-lg px-3 py-2">
                            </div>
                            <div>
                                <label class="block mb-1 text-gray-600">Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ±Ø¯</label>
                                <input id="add-expense-vendor-name" type="text" class="w-full border rounded-lg px-3 py-2">
                            </div>
                            <div>
                                <label class="block mb-1 text-gray-600">Ø§Ù„Ù…Ø¨Ù„Øº</label>
                                <input id="add-expense-amount" type="number" step="0.01" class="w-full border rounded-lg px-3 py-2">
                            </div>
                            <div>
                                <label class="block mb-1 text-gray-600">Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©</label>
                                <input id="add-expense-tax" type="number" step="0.01" class="w-full border rounded-lg px-3 py-2" value="0">
                            </div>
                            <div>
                                <label class="block mb-1 text-gray-600">Ø§Ù„Ø­Ø§Ù„Ø©</label>
                                <input id="add-expense-status" type="text" class="w-full border rounded-lg px-3 py-2" placeholder="Ù…Ø¹ØªÙ…Ø¯ / Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©">
                            </div>
                            <div>
                                <label class="block mb-1 text-gray-600">Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©</label>
                                <input id="add-expense-invoice" type="text" class="w-full border rounded-lg px-3 py-2" placeholder="ÙØ§ØªÙˆØ±Ø©-0001">
                            </div>
                            <div>
                                <label class="block mb-1 text-gray-600">Ø§Ù„ÙØ±Ø¹</label>
                                <input id="add-expense-branch" type="text" class="w-full border rounded-lg px-3 py-2" value="${DEFAULT_BRANCH_ID}">
                            </div>
                            <div>
                                <label class="block mb-1 text-gray-600">Ø§Ù„Ø­Ø§Ø¶Ù†Ø©</label>
                                <input id="add-expense-incubator" type="text" class="w-full border rounded-lg px-3 py-2" value="${DEFAULT_INCUBATOR_ID}">
                            </div>
                            <div class="md:col-span-2">
                                <label class="block mb-1 text-gray-600">Ø§Ù„ÙˆØµÙ</label>
                                <textarea id="add-expense-description" class="w-full border rounded-lg px-3 py-2" rows="2"></textarea>
                            </div>
                            <div class="md:col-span-2">
                                <label class="block mb-1 text-gray-600">Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label>
                                <textarea id="add-expense-notes" class="w-full border rounded-lg px-3 py-2" rows="2"></textarea>
                            </div>
                        </div>
                        <div class="p-5 border-t flex items-center justify-end gap-2">
                            <button onclick="this.closest('.fixed').remove()" class="px-4 py-2 rounded-lg border">Ø¥Ù„ØºØ§Ø¡</button>
                            <button onclick="submitAddExpense()" class="px-4 py-2 rounded-lg bg-emerald-600 text-white">Ø­ÙØ¸</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            }

            function openViewExpense(expenseId) {
                const expense = expenses.find(e => e.expense_id === expenseId);
                if (!expense) return;
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black/40 flex items-start justify-center z-50 p-4 overflow-y-auto';
                const details = [
                    ['Ø±Ù‚Ù… Ø§Ù„Ù…ØµØ±ÙˆÙ', expense.expense_number],
                    ['ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ØµØ±ÙˆÙ', formatDate(expense.expense_date)],
                    ['ÙØ¦Ø© Ø§Ù„Ù…ØµØ±ÙˆÙ', translateExpenseCategory(expense.expense_category)],
                    ['Ù†ÙˆØ¹ Ø§Ù„Ù…ØµØ±ÙˆÙ', translateExpenseType(expense.expense_type)],
                    ['Ø§Ù„Ù…ÙˆØ±Ø¯', expense.vendor_name || expense.vendor_id],
                    ['Ø§Ù„Ù…Ø¨Ù„Øº', formatMoney(expense.amount)],
                    ['Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©', formatMoney(expense.tax_amount)],
                    ['Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ', formatMoney(expense.total_amount)],
                    ['Ø§Ù„Ø­Ø§Ù„Ø©', translateExpenseStatus(expense.status)],
                    ['Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©', expense.invoice_number],
                    ['Ø§Ù„ÙˆØµÙ', expense.description],
                    ['Ù…Ù„Ø§Ø­Ø¸Ø§Øª', expense.notes]
                ];
                modal.innerHTML = `
                    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-xl my-6">
                        <div class="p-5 border-b flex items-center justify-between">
                            <h3 class="font-bold text-lg">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…ØµØ±ÙˆÙ</h3>
                            <button onclick="this.closest('.fixed').remove()" class="text-gray-500 hover:text-gray-700"><i class="fas fa-times"></i></button>
                        </div>
                        <div class="p-5 space-y-2 text-sm">
                            ${details.map(([label, value]) => `
                                <div class="flex items-center justify-between border-b pb-2">
                                    <span class="font-semibold text-gray-700">${label}</span>
                                    <span class="text-gray-900">${value ?? '-'}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            }

            async function submitAddExpense() {
                const payload = {
                    expense_number: document.getElementById('add-expense-number').value,
                    expense_date: document.getElementById('add-expense-date').value,
                    expense_category: document.getElementById('add-expense-category').value,
                    expense_type: document.getElementById('add-expense-type').value,
                    vendor_id: Number(document.getElementById('add-expense-vendor-id').value),
                    vendor_name: document.getElementById('add-expense-vendor-name').value,
                    amount: parseFloat(document.getElementById('add-expense-amount').value || 0),
                    tax_amount: parseFloat(document.getElementById('add-expense-tax').value || 0),
                    status: document.getElementById('add-expense-status').value,
                    invoice_number: document.getElementById('add-expense-invoice').value,
                    branch_id: document.getElementById('add-expense-branch').value,
                    incubator_id: document.getElementById('add-expense-incubator').value,
                    entity_type: 'HQ',
                    entity_id: ENTITY_ID,
                    description: document.getElementById('add-expense-description').value,
                    notes: document.getElementById('add-expense-notes').value,
                    created_by: 'Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…'
                };

                const res = await fetch(`${API_BASE}/finance/expenses`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', ...(window.getFinanceHeaders ? window.getFinanceHeaders() : {}) },
                    body: JSON.stringify(payload)
                });

                if (res.ok) {
                    document.querySelector('.fixed')?.remove();
                    await loadReport();
                } else {
                    alert('ØªØ¹Ø°Ø± Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…ØµØ±ÙˆÙ');
                }
            }

            function openEditExpense(expenseId) {
                const expense = expenses.find(e => e.expense_id === expenseId);
                if (!expense) return;
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black/40 flex items-start justify-center z-50 p-4 overflow-y-auto';
                modal.innerHTML = `
                    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg my-6">
                        <div class="p-5 border-b flex items-center justify-between">
                            <h3 class="font-bold text-lg">ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…ØµØ±ÙˆÙ ${expense.expense_number || ''}</h3>
                            <button onclick="this.closest('.fixed').remove()" class="text-gray-500 hover:text-gray-700"><i class="fas fa-times"></i></button>
                        </div>
                        <div class="p-5 space-y-4 text-sm">
                            <div>
                                <label class="block mb-1 text-gray-600">ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ØµØ±ÙˆÙ</label>
                                <input id="edit-expense-date" type="date" class="w-full border rounded-lg px-3 py-2" value="${(expense.expense_date || '').slice(0,10)}">
                            </div>
                            <div>
                                <label class="block mb-1 text-gray-600">Ø§Ù„Ù…Ø¨Ù„Øº</label>
                                <input id="edit-expense-amount" type="number" step="0.01" class="w-full border rounded-lg px-3 py-2" value="${expense.amount || 0}">
                            </div>
                            <div>
                                <label class="block mb-1 text-gray-600">Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©</label>
                                <input id="edit-expense-tax" type="number" step="0.01" class="w-full border rounded-lg px-3 py-2" value="${expense.tax_amount || 0}">
                            </div>
                            <div>
                                <label class="block mb-1 text-gray-600">Ø§Ù„Ø­Ø§Ù„Ø©</label>
                                <input id="edit-expense-status" type="text" class="w-full border rounded-lg px-3 py-2" value="${expense.status || ''}">
                            </div>
                            <div>
                                <label class="block mb-1 text-gray-600">Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label>
                                <textarea id="edit-expense-notes" class="w-full border rounded-lg px-3 py-2" rows="3">${expense.notes || ''}</textarea>
                            </div>
                        </div>
                        <div class="p-5 border-t flex items-center justify-end gap-2">
                            <button onclick="this.closest('.fixed').remove()" class="px-4 py-2 rounded-lg border">Ø¥Ù„ØºØ§Ø¡</button>
                            <button onclick="submitEditExpense(${expenseId})" class="px-4 py-2 rounded-lg bg-emerald-600 text-white">Ø­ÙØ¸</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            }

            async function submitEditExpense(expenseId) {
                const payload = {
                    expense_date: document.getElementById('edit-expense-date').value,
                    amount: parseFloat(document.getElementById('edit-expense-amount').value || 0),
                    tax_amount: parseFloat(document.getElementById('edit-expense-tax').value || 0),
                    status: document.getElementById('edit-expense-status').value,
                    notes: document.getElementById('edit-expense-notes').value
                };
                const res = await fetch(`${API_BASE}/finance/expenses/${expenseId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json', ...(window.getFinanceHeaders ? window.getFinanceHeaders() : {}) },
                    body: JSON.stringify(payload)
                });
                if (res.ok) {
                    document.querySelector('.fixed')?.remove();
                    await loadReport();
                } else {
                    alert('ØªØ¹Ø°Ø± ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ØµØ±ÙˆÙ');
                }
            }

            async function deleteExpense(expenseId) {
                if (!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…ØµØ±ÙˆÙØŸ')) return;
                const res = await fetch(`${API_BASE}/finance/expenses/${expenseId}`, {
                    method: 'DELETE',
                    headers: window.getFinanceHeaders ? window.getFinanceHeaders() : {}
                });
                if (res.ok) {
                    await loadReport();
                } else {
                    alert('ØªØ¹Ø°Ø± Ø­Ø°Ù Ø§Ù„Ù…ØµØ±ÙˆÙ');
                }
            }

            function openAddVendor() {
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black/40 flex items-start justify-center z-50 p-4 overflow-y-auto';
                modal.innerHTML = `
                    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl my-6">
                        <div class="p-5 border-b flex items-center justify-between">
                            <h3 class="font-bold text-lg">Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ±Ø¯</h3>
                            <button onclick="this.closest('.fixed').remove()" class="text-gray-500 hover:text-gray-700"><i class="fas fa-times"></i></button>
                        </div>
                        <div class="p-5 grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                            <div>
                                <label class="block mb-1 text-gray-600">ÙƒÙˆØ¯ Ø§Ù„Ù…ÙˆØ±Ø¯</label>
                                <input id="add-vendor-code" type="text" class="w-full border rounded-lg px-3 py-2" value="Ù…ÙˆØ±Ø¯-${Date.now()}">
                            </div>
                            <div>
                                <label class="block mb-1 text-gray-600">Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ±Ø¯ (Ø¹Ø±Ø¨ÙŠ)</label>
                                <input id="add-vendor-name-ar" type="text" class="w-full border rounded-lg px-3 py-2">
                            </div>
                            <div>
                                <label class="block mb-1 text-gray-600">Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ±Ø¯ (Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ)</label>
                                <input id="add-vendor-name-en" type="text" class="w-full border rounded-lg px-3 py-2">
                            </div>
                            <div>
                                <label class="block mb-1 text-gray-600">Ù†ÙˆØ¹ Ø§Ù„Ù…ÙˆØ±Ø¯</label>
                                <input id="add-vendor-type" type="text" class="w-full border rounded-lg px-3 py-2" placeholder="Ø®Ø¯Ù…Ø§Øª / ØªÙˆØ±ÙŠØ¯">
                            </div>
                            <div>
                                <label class="block mb-1 text-gray-600">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
                                <input id="add-vendor-email" type="email" class="w-full border rounded-lg px-3 py-2">
                            </div>
                            <div>
                                <label class="block mb-1 text-gray-600">Ø§Ù„Ù‡Ø§ØªÙ</label>
                                <input id="add-vendor-phone" type="text" class="w-full border rounded-lg px-3 py-2">
                            </div>
                            <div>
                                <label class="block mb-1 text-gray-600">Ø§Ù„Ø¬ÙˆØ§Ù„</label>
                                <input id="add-vendor-mobile" type="text" class="w-full border rounded-lg px-3 py-2">
                            </div>
                            <div>
                                <label class="block mb-1 text-gray-600">Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©</label>
                                <input id="add-vendor-city" type="text" class="w-full border rounded-lg px-3 py-2">
                            </div>
                            <div>
                                <label class="block mb-1 text-gray-600">Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</label>
                                <input id="add-vendor-address" type="text" class="w-full border rounded-lg px-3 py-2">
                            </div>
                            <div>
                                <label class="block mb-1 text-gray-600">Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø¶Ø±ÙŠØ¨ÙŠ</label>
                                <input id="add-vendor-tax" type="text" class="w-full border rounded-lg px-3 py-2">
                            </div>
                            <div>
                                <label class="block mb-1 text-gray-600">Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„ØªØ¬Ø§Ø±ÙŠ</label>
                                <input id="add-vendor-cr" type="text" class="w-full border rounded-lg px-3 py-2">
                            </div>
                            <div>
                                <label class="block mb-1 text-gray-600">Ø´Ø±ÙˆØ· Ø§Ù„Ø¯ÙØ¹</label>
                                <input id="add-vendor-terms" type="text" class="w-full border rounded-lg px-3 py-2" placeholder="ØµØ§ÙÙŠ 30 ÙŠÙˆÙ…">
                            </div>
                            <div>
                                <label class="block mb-1 text-gray-600">Ø£ÙŠØ§Ù… Ø§Ù„Ø³Ø¯Ø§Ø¯</label>
                                <input id="add-vendor-term-days" type="number" class="w-full border rounded-lg px-3 py-2" value="30">
                            </div>
                            <div>
                                <label class="block mb-1 text-gray-600">Ø§Ù„Ø­Ø§Ù„Ø©</label>
                                <input id="add-vendor-active" type="text" class="w-full border rounded-lg px-3 py-2" value="Ù†Ø¹Ù…">
                            </div>
                        </div>
                        <div class="p-5 border-t flex items-center justify-end gap-2">
                            <button onclick="this.closest('.fixed').remove()" class="px-4 py-2 rounded-lg border">Ø¥Ù„ØºØ§Ø¡</button>
                            <button onclick="submitAddVendor()" class="px-4 py-2 rounded-lg bg-indigo-600 text-white">Ø­ÙØ¸</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            }

            function openViewVendor(vendorId) {
                const vendor = vendors.find(v => v.vendor_id === vendorId);
                if (!vendor) return;
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black/40 flex items-start justify-center z-50 p-4 overflow-y-auto';
                const details = [
                    ['Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ±Ø¯', vendor.vendor_name_ar || vendor.vendor_name_en],
                    ['ÙƒÙˆØ¯ Ø§Ù„Ù…ÙˆØ±Ø¯', vendor.vendor_code],
                    ['Ù†ÙˆØ¹ Ø§Ù„Ù…ÙˆØ±Ø¯', vendor.vendor_type],
                    ['Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ', vendor.email],
                    ['Ø§Ù„Ù‡Ø§ØªÙ', vendor.phone],
                    ['Ø§Ù„Ø¬ÙˆØ§Ù„', vendor.mobile],
                    ['Ø§Ù„Ø¹Ù†ÙˆØ§Ù†', vendor.address],
                    ['Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©', vendor.city],
                    ['Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø¶Ø±ÙŠØ¨ÙŠ', vendor.tax_number],
                    ['Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„ØªØ¬Ø§Ø±ÙŠ', vendor.commercial_registration],
                    ['Ø´Ø±ÙˆØ· Ø§Ù„Ø¯ÙØ¹', vendor.payment_terms],
                    ['Ø£ÙŠØ§Ù… Ø§Ù„Ø³Ø¯Ø§Ø¯', vendor.payment_term_days],
                    ['Ù†Ø´Ø·', vendor.is_active === true ? 'Ù†Ø¹Ù…' : vendor.is_active === false ? 'Ù„Ø§' : '-']
                ];
                modal.innerHTML = `
                    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-xl my-6">
                        <div class="p-5 border-b flex items-center justify-between">
                            <h3 class="font-bold text-lg">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…ÙˆØ±Ø¯</h3>
                            <button onclick="this.closest('.fixed').remove()" class="text-gray-500 hover:text-gray-700"><i class="fas fa-times"></i></button>
                        </div>
                        <div class="p-5 space-y-2 text-sm">
                            ${details.map(([label, value]) => `
                                <div class="flex items-center justify-between border-b pb-2">
                                    <span class="font-semibold text-gray-700">${label}</span>
                                    <span class="text-gray-900">${value ?? '-'}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            }

            async function submitAddVendor() {
                const payload = {
                    vendor_code: document.getElementById('add-vendor-code').value,
                    vendor_name_ar: document.getElementById('add-vendor-name-ar').value,
                    vendor_name_en: document.getElementById('add-vendor-name-en').value,
                    vendor_type: document.getElementById('add-vendor-type').value,
                    email: document.getElementById('add-vendor-email').value,
                    phone: document.getElementById('add-vendor-phone').value,
                    mobile: document.getElementById('add-vendor-mobile').value,
                    city: document.getElementById('add-vendor-city').value,
                    address: document.getElementById('add-vendor-address').value,
                    tax_number: document.getElementById('add-vendor-tax').value,
                    commercial_registration: document.getElementById('add-vendor-cr').value,
                    payment_terms: document.getElementById('add-vendor-terms').value,
                    payment_term_days: Number(document.getElementById('add-vendor-term-days').value || 0),
                    is_active: document.getElementById('add-vendor-active').value,
                    entity_type: 'HQ',
                    entity_id: ENTITY_ID,
                    created_by: 'Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…'
                };

                const res = await fetch(`${API_BASE}/finance/vendors`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', ...(window.getFinanceHeaders ? window.getFinanceHeaders() : {}) },
                    body: JSON.stringify(payload)
                });

                if (res.ok) {
                    document.querySelector('.fixed')?.remove();
                    await loadReport();
                } else {
                    alert('ØªØ¹Ø°Ø± Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…ÙˆØ±Ø¯');
                }
            }

            function openEditVendor(vendorId) {
                const vendor = vendors.find(v => v.vendor_id === vendorId);
                if (!vendor) return;
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black/40 flex items-start justify-center z-50 p-4 overflow-y-auto';
                modal.innerHTML = `
                    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg my-6">
                        <div class="p-5 border-b flex items-center justify-between">
                            <h3 class="font-bold text-lg">ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…ÙˆØ±Ø¯ ${vendor.vendor_name_ar || ''}</h3>
                            <button onclick="this.closest('.fixed').remove()" class="text-gray-500 hover:text-gray-700"><i class="fas fa-times"></i></button>
                        </div>
                        <div class="p-5 space-y-4 text-sm">
                            <div>
                                <label class="block mb-1 text-gray-600">Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ±Ø¯ (Ø¹Ø±Ø¨ÙŠ)</label>
                                <input id="edit-vendor-name" type="text" class="w-full border rounded-lg px-3 py-2" value="${vendor.vendor_name_ar || ''}">
                            </div>
                            <div>
                                <label class="block mb-1 text-gray-600">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
                                <input id="edit-vendor-email" type="email" class="w-full border rounded-lg px-3 py-2" value="${vendor.email || ''}">
                            </div>
                            <div>
                                <label class="block mb-1 text-gray-600">Ø§Ù„Ù‡Ø§ØªÙ</label>
                                <input id="edit-vendor-phone" type="text" class="w-full border rounded-lg px-3 py-2" value="${vendor.phone || ''}">
                            </div>
                            <div>
                                <label class="block mb-1 text-gray-600">Ø§Ù„Ø­Ø§Ù„Ø©</label>
                                <input id="edit-vendor-active" type="text" class="w-full border rounded-lg px-3 py-2" value="${vendor.is_active === true ? 'Ù†Ø¹Ù…' : vendor.is_active === false ? 'Ù„Ø§' : ''}">
                            </div>
                        </div>
                        <div class="p-5 border-t flex items-center justify-end gap-2">
                            <button onclick="this.closest('.fixed').remove()" class="px-4 py-2 rounded-lg border">Ø¥Ù„ØºØ§Ø¡</button>
                            <button onclick="submitEditVendor(${vendorId})" class="px-4 py-2 rounded-lg bg-indigo-600 text-white">Ø­ÙØ¸</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            }

            async function submitEditVendor(vendorId) {
                const payload = {
                    vendor_name_ar: document.getElementById('edit-vendor-name').value,
                    email: document.getElementById('edit-vendor-email').value,
                    phone: document.getElementById('edit-vendor-phone').value,
                    is_active: document.getElementById('edit-vendor-active').value
                };
                const res = await fetch(`${API_BASE}/finance/vendors/${vendorId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json', ...(window.getFinanceHeaders ? window.getFinanceHeaders() : {}) },
                    body: JSON.stringify(payload)
                });
                if (res.ok) {
                    document.querySelector('.fixed')?.remove();
                    await loadReport();
                } else {
                    alert('ØªØ¹Ø°Ø± ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ÙˆØ±Ø¯');
                }
            }

            async function deleteVendor(vendorId) {
                if (!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…ÙˆØ±Ø¯ØŸ')) return;
                const res = await fetch(`${API_BASE}/finance/vendors/${vendorId}`, {
                    method: 'DELETE',
                    headers: window.getFinanceHeaders ? window.getFinanceHeaders() : {}
                });
                if (res.ok) {
                    await loadReport();
                } else {
                    alert('ØªØ¹Ø°Ø± Ø­Ø°Ù Ø§Ù„Ù…ÙˆØ±Ø¯');
                }
            }

            function renderCharts(summary) {
                const catData = summary.by_category || {};
                const catKeys = Object.keys(catData);
                const catLabels = catKeys.map(k => translateExpenseCategory(k));
                const catValues = catKeys.map(k => catData[k]);

                const catCtx = document.getElementById('categoryChart').getContext('2d');
                if (categoryChartInstance) categoryChartInstance.destroy();
                categoryChartInstance = new Chart(catCtx, {
                    type: 'bar',
                    data: {
                        labels: catLabels.length ? catLabels : ['Ù„Ø§ ÙŠÙˆØ¬Ø¯'],
                        datasets: [{
                            label: 'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª',
                            data: catValues.length ? catValues : [0],
                            backgroundColor: 'rgba(16, 185, 129, 0.7)'
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
                });

                const statusData = summary.by_status || {};
                const statusKeys = Object.keys(statusData);
                const statusLabels = statusKeys.map(k => translateExpenseStatus(k));
                const statusValues = statusKeys.map(k => statusData[k]);

                const statusCtx = document.getElementById('statusChart').getContext('2d');
                if (statusChartInstance) statusChartInstance.destroy();
                statusChartInstance = new Chart(statusCtx, {
                    type: 'doughnut',
                    data: {
                        labels: statusLabels.length ? statusLabels : ['Ù„Ø§ ÙŠÙˆØ¬Ø¯'],
                        datasets: [{
                            data: statusValues.length ? statusValues : [1],
                            backgroundColor: ['#06b6d4', '#f59e0b', '#ef4444', '#8b5cf6']
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: false }
                });
            }

            function renderInfo(summary) {
                document.getElementById('infoPanel').innerHTML = `
                    <div class="flex items-center gap-3 p-3 bg-gray-50 rounded-lg">
                        <i class="fas fa-warehouse text-emerald-600 text-xl"></i>
                        <div>
                            <div class="text-sm text-gray-600">Ø¹Ø¯Ø¯ Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ† Ø§Ù„Ù†Ø´Ø·ÙŠÙ†</div>
                            <div class="font-bold">${summary.active_vendors ?? 0}</div>
                        </div>
                    </div>
                    <div class="flex items-center gap-3 p-3 bg-gray-50 rounded-lg">
                        <i class="fas fa-building text-emerald-600 text-xl"></i>
                        <div>
                            <div class="text-sm text-gray-600">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ†</div>
                            <div class="font-bold">${summary.total_vendors ?? 0}</div>
                        </div>
                    </div>
                    <div class="flex items-center gap-3 p-3 bg-gray-50 rounded-lg">
                        <i class="fas fa-database text-emerald-600 text-xl"></i>
                        <div>
                            <div class="text-sm text-gray-600">Ø§Ù„ÙƒÙŠØ§Ù†</div>
                            <div class="font-bold">${summary.entity_id ?? '-'}</div>
                        </div>
                    </div>
                    <div class="flex items-center gap-3 p-3 bg-gray-50 rounded-lg">
                        <i class="fas fa-clock text-emerald-600 text-xl"></i>
                        <div>
                            <div class="text-sm text-gray-600">Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«</div>
                            <div class="font-bold">${summary.generated_at ? formatDateTime(summary.generated_at) : '-'}</div>
                        </div>
                    </div>
                `;
            }

            function renderJson(value) {
                if (!value) return '-';
                try {
                    return JSON.stringify(value);
                } catch (e) {
                    return String(value);
                }
            }

            function formatMoney(value) {
                const num = parseFloat(value || 0);
                return num.toLocaleString('ar-SA') + ' Ø±.Ø³';
            }

            function formatDate(value) {
                if (!value) return '-';
                return new Date(value).toLocaleDateString('ar-SA');
            }

            function formatDateTime(value) {
                if (!value) return '-';
                return new Date(value).toLocaleString('ar-SA');
            }

            function downloadCSV() {
                const rows = [
                    ['Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª'],
                    ['Ù…Ø¹Ø±Ù‘Ù Ø§Ù„Ù…ØµØ±ÙˆÙ','Ø±Ù‚Ù… Ø§Ù„Ù…ØµØ±ÙˆÙ','ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ØµØ±ÙˆÙ','ÙØ¦Ø© Ø§Ù„Ù…ØµØ±ÙˆÙ','Ù†ÙˆØ¹ Ø§Ù„Ù…ØµØ±ÙˆÙ','Ø±Ù‚Ù… Ø§Ù„Ù…ÙˆØ±Ø¯','Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ±Ø¯','Ø§Ù„Ù…Ø¨Ù„Øº','Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©','Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ','Ø­Ø§Ù„Ø© Ø§Ù„Ù…ØµØ±ÙˆÙ','Ù†ÙˆØ¹ Ø§Ù„ÙƒÙŠØ§Ù†','Ù…Ø¹Ø±Ù‘Ù Ø§Ù„ÙƒÙŠØ§Ù†','Ø§Ù„ÙØ±Ø¹','Ø§Ù„Ø­Ø§Ø¶Ù†Ø©','Ø§Ù„Ù…Ù†ØµØ©','Ù‚ÙŠØ¯ Ø§Ù„ÙŠÙˆÙ…ÙŠØ©','Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©','Ø§Ù„Ø¥ÙŠØµØ§Ù„','Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª','Ø§Ù„ÙˆØµÙ','Ù…Ù„Ø§Ø­Ø¸Ø§Øª','ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡','Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«','Ù…Ù†Ø´Ø£ Ø¨ÙˆØ§Ø³Ø·Ø©','Ù…ÙØ¹ØªÙ…Ø¯ Ø¨ÙˆØ§Ø³Ø·Ø©','ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯']
                ];
                expenses.forEach(e => rows.push([
                    e.expense_id, e.expense_number, e.expense_date, translateExpenseCategory(e.expense_category), translateExpenseType(e.expense_type), e.vendor_id,
                    e.vendor_name, e.amount, e.tax_amount, e.total_amount, translateExpenseStatus(e.status), e.entity_type, e.entity_id,
                    e.branch_id, e.incubator_id, e.platform_id, e.journal_entry_id, e.invoice_number, e.receipt_file,
                    JSON.stringify(e.attachments || {}), e.description, e.notes, e.created_at, e.updated_at,
                    e.created_by, e.approved_by, e.approved_at
                ]));

                rows.push([]);
                rows.push(['Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ†']);
                rows.push(['Ù…Ø¹Ø±Ù‘Ù Ø§Ù„Ù…ÙˆØ±Ø¯','ÙƒÙˆØ¯ Ø§Ù„Ù…ÙˆØ±Ø¯','Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ±Ø¯ (Ø¹Ø±Ø¨ÙŠ)','Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ±Ø¯ (Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ)','Ù†ÙˆØ¹ Ø§Ù„Ù…ÙˆØ±Ø¯','Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ','Ø§Ù„Ù‡Ø§ØªÙ','Ø§Ù„Ø¬ÙˆØ§Ù„','Ø§Ù„Ø¹Ù†ÙˆØ§Ù†','Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©','Ø§Ù„Ø¯ÙˆÙ„Ø©','Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø¶Ø±ÙŠØ¨ÙŠ','Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„ØªØ¬Ø§Ø±ÙŠ','Ø´Ø±ÙˆØ· Ø§Ù„Ø¯ÙØ¹','Ø£ÙŠØ§Ù… Ø§Ù„Ø³Ø¯Ø§Ø¯','Ù†ÙˆØ¹ Ø§Ù„ÙƒÙŠØ§Ù†','Ù…Ø¹Ø±Ù‘Ù Ø§Ù„ÙƒÙŠØ§Ù†','Ù†Ø´Ø·','ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡','Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«','Ù…Ù†Ø´Ø£ Ø¨ÙˆØ§Ø³Ø·Ø©']);
                vendors.forEach(v => rows.push([
                    v.vendor_id, v.vendor_code, v.vendor_name_ar, v.vendor_name_en, v.vendor_type, v.email, v.phone,
                    v.mobile, v.address, v.city, v.country, v.tax_number, v.commercial_registration, v.payment_terms,
                    v.payment_term_days, v.entity_type, v.entity_id, v.is_active, v.created_at, v.updated_at,
                    v.created_by
                ]));

                const csvContent = rows.map(r => r.map(v => `"${v ?? ''}"`).join(',')).join('\n');
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = 'ØªÙ‚Ø±ÙŠØ±-Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª-ÙˆØ§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ†.csv';
                link.click();
                URL.revokeObjectURL(url);
            }

            function downloadJSON() {
                const payload = { expenses, vendors };
                const blob = new Blob([JSON.stringify(payload, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = 'ØªÙ‚Ø±ÙŠØ±-Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª-ÙˆØ§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ†.json';
                link.click();
                URL.revokeObjectURL(url);
            }

            function printReport() {
                window.print();
            }

            function refreshData() {
                loadReport();
            }

            document.addEventListener('DOMContentLoaded', loadReport);
        </script>
</body>
</html>
