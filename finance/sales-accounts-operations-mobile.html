<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ§¾ Ù…Ù†Ø¸ÙˆÙ…Ø© Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª ÙˆØ§Ù„Ø­Ø³Ø§Ø¨Ø§Øª ÙˆØ§Ù„ØªØ´ØºÙŠÙ„ - Ù†Ø¸Ø§Ù… Ù†Ø§ÙŠÙˆØ´</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: 'Cairo', sans-serif; background-color: #f9fafb; color: #0f172a; }
        .card-glass {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
        }
        .stat-pill { border-radius: 999px; box-shadow: 0 18px 30px rgba(15, 23, 42, 0.15); }
        .stat-angled { border-radius: 28px 6px 28px 6px; }
        .stat-rounded { border-radius: 28px; }
        .stat-cut { border-radius: 6px 28px 6px 28px; }
        .table-scroll { max-height: 560px; overflow: auto; }
        .section-accent-sky { border-top: 4px solid #0ea5e9; }
        .section-accent-emerald { border-top: 4px solid #10b981; }
        .section-accent-amber { border-top: 4px solid #f59e0b; }
        .section-accent-violet { border-top: 4px solid #8b5cf6; }
        .section-accent-rose { border-top: 4px solid #f43f5e; }
        .chip { padding: 6px 12px; border-radius: 999px; font-weight: 700; }
    
        .card-gradient {
            background: linear-gradient(145deg, #ffffff, #f3f4f6);
            border: 1px solid #e2e8f0;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        .action-btn { padding: 8px 12px; border-radius: 12px; font-weight: 700; display: inline-flex; align-items: center; gap: 6px; }
        .modal-backdrop { background: rgba(15, 23, 42, 0.65); }
        .modal-card { border-radius: 24px; box-shadow: 0 20px 60px rgba(15, 23, 42, 0.35); }
        .pill { border-radius: 999px; padding: 6px 10px; font-weight: 700; }
    
    </style>
</head>
<body>
    <div class="container mx-auto px-4 py-8">
        <div class="mb-8 text-slate-900">
            <h1 class="text-4xl font-bold mb-2">ğŸ§¾ Ù…Ù†Ø¸ÙˆÙ…Ø© Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª ÙˆØ§Ù„Ø­Ø³Ø§Ø¨Ø§Øª ÙˆØ§Ù„ØªØ´ØºÙŠÙ„</h1>
            <p class="text-lg text-slate-600">Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª ÙˆØ§Ù„Ø¹Ù…Ù„Ø§Ø¡ ÙˆØ§Ù„Ù…Ø®Ø²ÙˆÙ† ÙˆØ§Ù„Ø­Ø³Ø§Ø¨Ø§Øª ÙˆØ§Ù„Ù…ÙˆØ§Ø±Ø¯ Ø§Ù„Ø¨Ø´Ø±ÙŠØ© ÙˆØ§Ù„ØªØ´ØºÙŠÙ„ ÙˆØ§Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª (Ø§Ù„ØµÙØ­Ø© 44)</p>
        </div>

        <div class="mb-6 flex flex-wrap gap-3">
            <button onclick="refreshData()" class="bg-white text-sky-700 border border-sky-100 shadow-sm px-6 py-3 rounded-full font-bold hover:shadow-lg transition flex items-center gap-2">
                <i class="fas fa-rotate"></i>
                ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            </button>
            <button onclick="downloadAllJSON()" class="bg-indigo-600 text-white px-6 py-3 rounded-full font-bold hover:shadow-lg transition flex items-center gap-2">
                <i class="fas fa-file-code"></i>
                ØªÙ†Ø²ÙŠÙ„ Ù…Ù„Ù Ø¨ÙŠØ§Ù†Ø§Øª Ø´Ø§Ù…Ù„
            </button>
            <button onclick="downloadAllCSV()" class="bg-emerald-600 text-white px-6 py-3 rounded-full font-bold hover:shadow-lg transition flex items-center gap-2">
                <i class="fas fa-file-csv"></i>
                ØªÙ†Ø²ÙŠÙ„ Ù…Ù„Ù Ø¬Ø¯ÙˆÙ„ÙŠ Ø´Ø§Ù…Ù„
            </button>
            <button onclick="printReport()" class="bg-rose-600 text-white px-6 py-3 rounded-full font-bold hover:shadow-lg transition flex items-center gap-2">
                <i class="fas fa-print"></i>
                Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ±
            </button>
            <button onclick="openInvoiceForm()" class="bg-amber-500 text-white px-6 py-3 rounded-full font-bold hover:shadow-lg transition flex items-center gap-2">
                <i class="fas fa-file-circle-plus"></i>
                Ø¥Ø¶Ø§ÙØ© ÙØ§ØªÙˆØ±Ø©
            </button>
            <button onclick="openPaymentForm()" class="bg-emerald-500 text-white px-6 py-3 rounded-full font-bold hover:shadow-lg transition flex items-center gap-2">
                <i class="fas fa-money-bill-wave"></i>
                Ø¥Ø¶Ø§ÙØ© Ù…Ø¯ÙÙˆØ¹Ø©
            </button>
            <button onclick="openCustomerForm()" class="bg-indigo-500 text-white px-6 py-3 rounded-full font-bold hover:shadow-lg transition flex items-center gap-2">
                <i class="fas fa-user-plus"></i>
                Ø¥Ø¶Ø§ÙØ© Ø¹Ù…ÙŠÙ„
            </button>
            <button onclick="openRequestForm()" class="bg-sky-600 text-white px-6 py-3 rounded-full font-bold hover:shadow-lg transition flex items-center gap-2">
                <i class="fas fa-clipboard-list"></i>
                Ø¥Ø¶Ø§ÙØ© Ø·Ù„Ø¨ Ù…ÙˆØ¸Ù
            </button>
        </div>

        <!-- Stats -->
        <div class="card-glass rounded-3xl shadow-2xl p-6 mb-8 section-accent-sky">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-5">
                <div class="stat-pill bg-gradient-to-br from-sky-500 to-blue-600 text-slate-900 p-6">
                    <div class="flex justify-between mb-3"><span>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙÙˆØ§ØªÙŠØ±</span><i class="fas fa-file-invoice text-2xl opacity-70"></i></div>
                    <div id="invoicesTotal" class="text-3xl font-bold"><div class="animate-pulse">...</div></div>
                </div>
                <div class="stat-angled bg-gradient-to-br from-emerald-500 to-teal-600 text-slate-900 p-6">
                    <div class="flex justify-between mb-3"><span>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª</span><i class="fas fa-hand-holding-dollar text-2xl opacity-70"></i></div>
                    <div id="paymentsTotal" class="text-3xl font-bold"><div class="animate-pulse">...</div></div>
                </div>
                <div class="stat-rounded bg-gradient-to-br from-indigo-500 to-purple-600 text-slate-900 p-6">
                    <div class="flex justify-between mb-3"><span>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</span><i class="fas fa-users text-2xl opacity-70"></i></div>
                    <div id="customersTotal" class="text-3xl font-bold"><div class="animate-pulse">...</div></div>
                </div>
                <div class="stat-cut bg-gradient-to-br from-rose-500 to-pink-600 text-slate-900 p-6">
                    <div class="flex justify-between mb-3"><span>Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</span><i class="fas fa-clipboard-list text-2xl opacity-70"></i></div>
                    <div id="requestsTotal" class="text-3xl font-bold"><div class="animate-pulse">...</div></div>
                </div>
            </div>
        </div>

        <!-- Sales & Inventory -->
        <div class="card-glass rounded-3xl shadow-2xl p-6 mb-8 section-accent-emerald">
            <h2 class="text-2xl font-bold text-slate-800 mb-4">ğŸ›’ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª ÙˆØ§Ù„Ø¹Ù…Ù„Ø§Ø¡ ÙˆØ§Ù„Ù…Ø®Ø²ÙˆÙ†</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 text-sm">
                <div class="stat-pill bg-emerald-50 p-4">Ø§Ù„ÙÙˆØ§ØªÙŠØ± ÙˆØ¹Ø±ÙˆØ¶ Ø§Ù„Ø£Ø³Ø¹Ø§Ø±</div>
                <div class="stat-angled bg-sky-50 p-4">Ù†Ù‚Ø§Ø· Ø§Ù„Ø¨ÙŠØ¹</div>
                <div class="stat-rounded bg-indigo-50 p-4">Ø§Ù„Ø¹Ø±ÙˆØ¶</div>
                <div class="stat-cut bg-rose-50 p-4">Ø§Ù„Ø£Ù‚Ø³Ø§Ø·</div>
                <div class="stat-pill bg-amber-50 p-4">Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„Ù…Ø³ØªÙ‡Ø¯ÙØ© ÙˆØ§Ù„Ø¹Ù…ÙˆÙ„Ø§Øª</div>
                <div class="stat-angled bg-violet-50 p-4">Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ© Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ©</div>
                <div class="stat-rounded bg-sky-50 p-4">Ù‡ÙŠØ¦Ø© Ø§Ù„Ø²ÙƒØ§Ø© ÙˆØ§Ù„Ø¯Ø®Ù„</div>
                <div class="stat-cut bg-emerald-50 p-4">Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ© Ø§Ù„Ù…ØµØ±ÙŠØ©</div>
                <div class="stat-pill bg-indigo-50 p-4">Ù…ØµÙ„Ø­Ø© Ø§Ù„Ø¶Ø±Ø§Ø¦Ø¨</div>
                <div class="stat-angled bg-rose-50 p-4">Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ© Ø§Ù„Ø£Ø±Ø¯Ù†ÙŠØ©</div>
                <div class="stat-rounded bg-amber-50 p-4">Ø¯Ø§Ø¦Ø±Ø© Ø¶Ø±ÙŠØ¨Ø© Ø§Ù„Ø¯Ø®Ù„ ÙˆØ§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</div>
                <div class="stat-cut bg-violet-50 p-4">Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</div>
                <div class="stat-pill bg-sky-50 p-4">Ù†Ù‚Ø§Ø· Ø§Ù„ÙˆÙ„Ø§Ø¡ Ù„Ù„Ø¹Ù…Ù„Ø§Ø¡</div>
                <div class="stat-angled bg-emerald-50 p-4">Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§Øª ÙˆØ§Ù„Ø¹Ø¶ÙˆÙŠØ§Øª</div>
                <div class="stat-rounded bg-indigo-50 p-4">Ø§Ù„Ù†Ù‚Ø§Ø· ÙˆØ§Ù„Ø£Ø±ØµØ¯Ø©</div>
                <div class="stat-cut bg-rose-50 p-4">Ø§Ù„ØªØ£Ù…ÙŠÙ†Ø§Øª</div>
                <div class="stat-pill bg-amber-50 p-4">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</div>
                <div class="stat-angled bg-violet-50 p-4">Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª</div>
                <div class="stat-rounded bg-sky-50 p-4">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ†</div>
                <div class="stat-cut bg-emerald-50 p-4">Ø¯ÙˆØ±Ø© Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª</div>
                <div class="stat-pill bg-indigo-50 p-4">Ø§Ù„Ø£Ø°ÙˆÙ† Ø§Ù„Ù…Ø®Ø²Ù†ÙŠØ©</div>
                <div class="stat-angled bg-rose-50 p-4">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¬Ø±Ø¯</div>
            </div>
        </div>

        <!-- Accounts, HR, Operations -->
        <div class="card-glass rounded-3xl shadow-2xl p-6 mb-8 section-accent-amber">
            <h2 class="text-2xl font-bold text-slate-800 mb-4">ğŸ“š Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª ÙˆØ§Ù„Ù…ÙˆØ§Ø±Ø¯ Ø§Ù„Ø¨Ø´Ø±ÙŠØ© ÙˆØ§Ù„ØªØ´ØºÙŠÙ„</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 text-sm">
                <div class="stat-rounded bg-amber-50 p-4">Ø¯Ù„ÙŠÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª</div>
                <div class="stat-angled bg-sky-50 p-4">Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª</div>
                <div class="stat-pill bg-emerald-50 p-4">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£ØµÙˆÙ„</div>
                <div class="stat-cut bg-rose-50 p-4">Ù…Ø±Ø§ÙƒØ² Ø§Ù„ØªÙƒÙ„ÙØ©</div>
                <div class="stat-rounded bg-indigo-50 p-4">Ø¯ÙˆØ±Ø© Ø§Ù„Ø´ÙŠÙƒØ§Øª</div>
                <div class="stat-angled bg-violet-50 p-4">Ø§Ù„Ø­Ø¶ÙˆØ± ÙˆØ§Ù„Ø§Ù†ØµØ±Ø§Ù</div>
                <div class="stat-pill bg-amber-50 p-4">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù‚ÙˆØ¯</div>
                <div class="stat-cut bg-sky-50 p-4">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø±ØªØ¨Ø§Øª</div>
                <div class="stat-rounded bg-emerald-50 p-4">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª</div>
                <div class="stat-angled bg-rose-50 p-4">Ø´Ø¤ÙˆÙ† Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</div>
                <div class="stat-pill bg-indigo-50 p-4">Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ø´ØºÙ„</div>
                <div class="stat-cut bg-amber-50 p-4">Ø¯ÙˆØ±Ø© Ø§Ù„Ø¹Ù…Ù„</div>
                <div class="stat-rounded bg-violet-50 p-4">Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª</div>
                <div class="stat-angled bg-sky-50 p-4">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¥ÙŠØ¬Ø§Ø±Ø§Øª ÙˆØ§Ù„ÙˆØ­Ø¯Ø§Øª</div>
                <div class="stat-pill bg-emerald-50 p-4">Ø¹Ù‚ÙˆØ¯ Ø§Ù„Ø¥ÙŠØ¬Ø§Ø±</div>
                <div class="stat-cut bg-rose-50 p-4">ØªØªØ¨Ø¹ Ø§Ù„ÙˆÙ‚Øª</div>
                <div class="stat-rounded bg-indigo-50 p-4">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªØµÙ†ÙŠØ¹</div>
            </div>
        </div>

        <!-- Mobile Apps -->
        <div class="card-glass rounded-3xl shadow-2xl p-6 mb-8 section-accent-violet">
            <h2 class="text-2xl font-bold text-slate-800 mb-4">ğŸ“± ØªØ·Ø¨ÙŠÙ‚Ø§Øª Ø§Ù„Ø¬ÙˆØ§Ù„</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 text-sm">
                <div class="stat-pill bg-violet-50 p-4">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø¹Ù…Ø§Ù„ Ù„Ù„Ø¬ÙˆØ§Ù„</div>
                <div class="stat-angled bg-sky-50 p-4">Ù†Ù‚Ø§Ø· Ø§Ù„Ø¨ÙŠØ¹ Ù„Ù„Ø¬ÙˆØ§Ù„</div>
                <div class="stat-rounded bg-emerald-50 p-4">Ù†Ù‚Ø§Ø· Ø§Ù„Ø¨ÙŠØ¹ Ø³Ø·Ø­ Ø§Ù„Ù…ÙƒØªØ¨</div>
                <div class="stat-cut bg-rose-50 p-4">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø¶ÙˆØ± Ù„Ù„Ø¬ÙˆØ§Ù„</div>
                <div class="stat-pill bg-amber-50 p-4">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª Ø§Ù„Ø³Ø±ÙŠØ¹ Ù„Ù„Ø¬ÙˆØ§Ù„</div>
                <div class="stat-angled bg-indigo-50 p-4">Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ© Ù„Ù„Ø¬ÙˆØ§Ù„</div>
                <div class="stat-rounded bg-violet-50 p-4">Ø¬Ø±Ø¯ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</div>
            </div>
        </div>

        <!-- Training -->
        <div class="card-glass rounded-3xl shadow-2xl p-6 mb-8 section-accent-rose">
            <h2 class="text-2xl font-bold text-slate-800 mb-4">ğŸ“ Ø§Ù„ØªØ¹Ù„ÙŠÙ… ÙˆØ§Ù„ØªØ¯Ø±ÙŠØ¨</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 text-sm">
                <div class="stat-rounded bg-rose-50 p-4">ØªØ¹Ù„Ù… ÙƒÙŠÙÙŠØ© Ø¥Ø¯Ø§Ø±Ø© Ø£Ø¹Ù…Ø§Ù„Ùƒ</div>
                <div class="stat-angled bg-amber-50 p-4">ØªØµÙØ­ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</div>
                <div class="stat-pill bg-emerald-50 p-4">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</div>
                <div class="stat-cut bg-sky-50 p-4">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª</div>
                <div class="stat-rounded bg-indigo-50 p-4">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø¹Ù…Ø§Ù„</div>
                <div class="stat-angled bg-violet-50 p-4">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</div>
                <div class="stat-pill bg-amber-50 p-4">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø®Ø§Ø²Ù†</div>
                <div class="stat-cut bg-rose-50 p-4">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ§Ø±Ø¯ Ø§Ù„Ø¨Ø´Ø±ÙŠØ©</div>
                <div class="stat-rounded bg-sky-50 p-4">Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</div>
                <div class="stat-angled bg-emerald-50 p-4">Ø§Ù„Ø´Ù‡Ø§Ø¯Ø§Øª</div>
            </div>
        </div>

        <!-- Tables -->
        <div class="card-glass rounded-3xl shadow-2xl p-6 mb-8 section-accent-emerald">
            <div class="flex items-center justify-between mb-4">
                <div class="flex items-center gap-3">
                    <h3 class="text-xl font-bold text-slate-800">ğŸ§¾ Ø¬Ø¯ÙˆÙ„ Ø§Ù„ÙÙˆØ§ØªÙŠØ±</h3>
                    <span id="invoicesCount" class="text-sm text-slate-500"></span>
                </div>
                <div class="flex items-center gap-2">
                    <button onclick="openInvoiceForm()" class="action-btn bg-amber-500 text-white hover:shadow-lg"><i class="fas fa-plus"></i>Ø¥Ø¶Ø§ÙØ©</button>
                </div>
            </div>
            <div class="table-scroll">
                <table class="w-full text-xs">
                    <thead class="bg-emerald-50 text-emerald-700">
                        <tr>
                            <th class="px-3 py-2 text-right">Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©</th>
                            <th class="px-3 py-2 text-right">Ø§Ù„Ø¹Ù…ÙŠÙ„</th>
                            <th class="px-3 py-2 text-right">Ø§Ù„Ù…Ø¨Ù„Øº</th>
                            <th class="px-3 py-2 text-right">Ø§Ù„Ø­Ø§Ù„Ø©</th>
                            <th class="px-3 py-2 text-right">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚</th>
                            <th class="px-3 py-2 text-right">Ø§Ù„Ù…Ù†Ø´Ø£Ø©</th>
                            <th class="px-3 py-2 text-right">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡</th>
                            <th class="px-3 py-2 text-right">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                        </tr>
                    </thead>
                    <tbody id="invoicesTable" class="divide-y divide-slate-100">
                        <tr>
                            <td colspan="8" class="px-4 py-12 text-center text-slate-500">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="card-glass rounded-3xl shadow-2xl p-6 mb-8 section-accent-violet">
            <div class="flex items-center justify-between mb-4">
                <div class="flex items-center gap-3">
                    <h3 class="text-xl font-bold text-slate-800">ğŸ’³ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª</h3>
                    <span id="paymentsCount" class="text-sm text-slate-500"></span>
                </div>
                <div class="flex items-center gap-2">
                    <button onclick="openPaymentForm()" class="action-btn bg-emerald-500 text-white hover:shadow-lg"><i class="fas fa-plus"></i>Ø¥Ø¶Ø§ÙØ©</button>
                </div>
            </div>
            <div class="table-scroll">
                <table class="w-full text-xs">
                    <thead class="bg-violet-50 text-violet-700">
                        <tr>
                            <th class="px-3 py-2 text-right">Ø±Ù‚Ù… Ø§Ù„Ø¯ÙØ¹</th>
                            <th class="px-3 py-2 text-right">Ø§Ù„Ø¹Ù…ÙŠÙ„</th>
                            <th class="px-3 py-2 text-right">Ø§Ù„Ù…Ø¨Ù„Øº</th>
                            <th class="px-3 py-2 text-right">Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹</th>
                            <th class="px-3 py-2 text-right">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¯ÙØ¹</th>
                            <th class="px-3 py-2 text-right">Ø§Ù„Ù…Ù†Ø´Ø£Ø©</th>
                            <th class="px-3 py-2 text-right">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                        </tr>
                    </thead>
                    <tbody id="paymentsTable" class="divide-y divide-slate-100">
                        <tr>
                            <td colspan="7" class="px-4 py-12 text-center text-slate-500">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="card-glass rounded-3xl shadow-2xl p-6 mb-8 section-accent-amber">
            <div class="flex items-center justify-between mb-4">
                <div class="flex items-center gap-3">
                    <h3 class="text-xl font-bold text-slate-800">ğŸ‘¥ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</h3>
                    <span id="customersCount" class="text-sm text-slate-500"></span>
                </div>
                <div class="flex items-center gap-2">
                    <button onclick="openCustomerForm()" class="action-btn bg-indigo-500 text-white hover:shadow-lg"><i class="fas fa-plus"></i>Ø¥Ø¶Ø§ÙØ©</button>
                </div>
            </div>
            <div class="table-scroll">
                <table class="w-full text-xs">
                    <thead class="bg-amber-50 text-amber-700">
                        <tr>
                            <th class="px-3 py-2 text-right">Ø±Ù‚Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„</th>
                            <th class="px-3 py-2 text-right">Ø§Ù„Ø§Ø³Ù…</th>
                            <th class="px-3 py-2 text-right">Ø§Ù„Ø¬ÙˆØ§Ù„</th>
                            <th class="px-3 py-2 text-right">Ø§Ù„Ø¨Ø±ÙŠØ¯</th>
                            <th class="px-3 py-2 text-right">Ø§Ù„Ø±ØµÙŠØ¯</th>
                            <th class="px-3 py-2 text-right">Ø§Ù„Ù…Ù†Ø´Ø£Ø©</th>
                            <th class="px-3 py-2 text-right">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                        </tr>
                    </thead>
                    <tbody id="customersTable" class="divide-y divide-slate-100">
                        <tr>
                            <td colspan="7" class="px-4 py-12 text-center text-slate-500">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="card-glass rounded-3xl shadow-2xl p-6 section-accent-rose">
            <div class="flex items-center justify-between mb-4">
                <div class="flex items-center gap-3">
                    <h3 class="text-xl font-bold text-slate-800">ğŸ“¨ Ø¬Ø¯ÙˆÙ„ Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</h3>
                    <span id="requestsCount" class="text-sm text-slate-500"></span>
                </div>
                <div class="flex items-center gap-2">
                    <button onclick="openRequestForm()" class="action-btn bg-sky-600 text-white hover:shadow-lg"><i class="fas fa-plus"></i>Ø¥Ø¶Ø§ÙØ©</button>
                </div>
            </div>
            <div class="table-scroll">
                <table class="w-full text-xs">
                    <thead class="bg-rose-50 text-rose-700">
                        <tr>
                            <th class="px-3 py-2 text-right">Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨</th>
                            <th class="px-3 py-2 text-right">Ø§Ù„Ù…ÙˆØ¸Ù</th>
                            <th class="px-3 py-2 text-right">Ù†ÙˆØ¹ Ø§Ù„Ø·Ù„Ø¨</th>
                            <th class="px-3 py-2 text-right">Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</th>
                            <th class="px-3 py-2 text-right">Ø§Ù„Ø­Ø§Ù„Ø©</th>
                            <th class="px-3 py-2 text-right">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø·Ù„Ø¨</th>
                            <th class="px-3 py-2 text-right">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                        </tr>
                    </thead>
                    <tbody id="requestsTable" class="divide-y divide-slate-100">
                        <tr>
                            <td colspan="7" class="px-4 py-12 text-center text-slate-500">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="actionModal" class="fixed inset-0 z-50 hidden place-items-center p-4">
        <div class="absolute inset-0 modal-backdrop" onclick="closeModal()"></div>
        <div class="relative bg-white modal-card w-full max-w-3xl p-6">
            <div class="flex items-start justify-between gap-4 mb-4">
                <div>
                    <p class="text-xs text-slate-500">Ù…Ù†Ø¸ÙˆÙ…Ø© Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª ÙˆØ§Ù„Ø­Ø³Ø§Ø¨Ø§Øª</p>
                    <h3 id="modalTitle" class="text-xl font-bold text-slate-800">Ù†Ù…ÙˆØ°Ø¬</h3>
                </div>
                <button onclick="closeModal()" class="text-slate-500 hover:text-rose-500 text-xl">&times;</button>
            </div>
            <div id="modalBody" class="max-h-[70vh] overflow-y-auto"></div>
        </div>
    </div>

    <div id="toast" class="fixed bottom-4 right-4 z-50 hidden bg-slate-900 text-white px-4 py-3 rounded-2xl shadow-2xl text-sm"></div>

    <script>
        const API_BASE = window.location.origin;
        const ENTITY_ID = window.getFinanceEntityId ? window.getFinanceEntityId() : 'HQ001';
        const ENTITY_TYPE = window.getFinanceEntityType ? window.getFinanceEntityType() : 'HQ';
        const defaultHeaders = {
            'Content-Type': 'application/json',
            'x-entity-id': ENTITY_ID,
            'x-entity-type': ENTITY_TYPE
        };

        let invoices = [];
        let payments = [];
        let customers = [];
        let requests = [];

        async function loadData() {
            try {
                const [invoicesRes, paymentsRes, customersRes, requestsRes] = await Promise.all([
                    fetch(`${API_BASE}/finance/invoices?entity_id=${ENTITY_ID}&limit=200`, { headers: defaultHeaders }),
                    fetch(`${API_BASE}/finance/payments?entity_id=${ENTITY_ID}&limit=200`, { headers: defaultHeaders }),
                    fetch(`${API_BASE}/finance/customers?entity_id=${ENTITY_ID}&limit=200`, { headers: defaultHeaders }),
                    fetch(`${API_BASE}/api/employee-requests?entity_id=${ENTITY_ID}`, { headers: defaultHeaders })
                ]);

                const [invoicesData, paymentsData, customersData, requestsData] = await Promise.all([
                    invoicesRes.json(),
                    paymentsRes.json(),
                    customersRes.json(),
                    requestsRes.json()
                ]);

                invoices = invoicesData.invoices || [];
                payments = paymentsData.payments || [];
                customers = customersData.customers || customersData.rows || [];
                requests = Array.isArray(requestsData) ? requestsData : [];

                renderStats();
                renderTables();
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', error);
                showToast('ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª - ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰', 'error');
                renderStats();
                renderTables();
            }
        }

        function renderStats() {
            const invoicesSum = invoices.reduce((sum, i) => sum + parseFloat(i.total_amount || i.amount || 0), 0);
            const paymentsSum = payments.reduce((sum, p) => sum + parseFloat(p.payment_amount || p.amount || 0), 0);

            document.getElementById('invoicesTotal').innerHTML = `
                <div class="flex items-baseline gap-2">
                    <span class="text-3xl font-bold">${invoices.length}</span>
                    <span class="text-xs bg-white/30 px-2 py-1 rounded-full">${formatMoney(invoicesSum)}</span>
                </div>`;
            document.getElementById('paymentsTotal').innerHTML = `
                <div class="flex items-baseline gap-2">
                    <span class="text-3xl font-bold">${payments.length}</span>
                    <span class="text-xs bg-white/30 px-2 py-1 rounded-full">${formatMoney(paymentsSum)}</span>
                </div>`;
            document.getElementById('customersTotal').textContent = customers.length;
            document.getElementById('requestsTotal').textContent = requests.length;
        }

        function renderTables() {
            const invoiceRows = invoices.map(i => `
                <tr class="hover:bg-emerald-50">
                    <td class="px-3 py-2">${sanitizeText(i.invoice_id || i.id)}</td>
                    <td class="px-3 py-2">${sanitizeText(i.customer_name || i.customer_id)}</td>
                    <td class="px-3 py-2">${formatMoney(i.total_amount || i.amount)}</td>
                    <td class="px-3 py-2"><span class="pill bg-emerald-100 text-emerald-700">${translateStatus(i.status)}</span></td>
                    <td class="px-3 py-2">${formatDate(i.due_date)}</td>
                    <td class="px-3 py-2">${sanitizeText(i.entity_id)}</td>
                    <td class="px-3 py-2">${formatDateTime(i.created_at)}</td>
                    <td class="px-3 py-2">
                        <div class="flex flex-wrap gap-1 justify-end">
                            <button class="action-btn bg-white border border-slate-200 text-slate-700" onclick='openDetails("Ù…Ø¹Ø§ÙŠÙ†Ø© ÙØ§ØªÙˆØ±Ø©", ${JSON.stringify(i)})'><i class="fas fa-eye"></i>Ù…Ø¹Ø§ÙŠÙ†Ø©</button>
                            <button class="action-btn bg-amber-500 text-white" onclick='openInvoiceForm(${JSON.stringify(i)})'><i class="fas fa-pen"></i>ØªØ¹Ø¯ÙŠÙ„</button>
                            <button class="action-btn bg-rose-500 text-white" onclick="confirmDelete('invoice', ${i.invoice_id || i.id})"><i class="fas fa-trash"></i>Ø­Ø°Ù</button>
                        </div>
                    </td>
                </tr>
            `).join('');
            document.getElementById('invoicesTable').innerHTML = invoiceRows || `<tr><td colspan="8" class="px-4 py-12 text-center text-slate-500">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</td></tr>`;
            document.getElementById('invoicesCount').textContent = `Ø¹Ø¯Ø¯ Ø§Ù„ØµÙÙˆÙ: ${invoices.length}`;

            const paymentRows = payments.map(p => `
                <tr class="hover:bg-violet-50">
                    <td class="px-3 py-2">${sanitizeText(p.payment_id || p.id)}</td>
                    <td class="px-3 py-2">${sanitizeText(p.customer_name || p.customer_id)}</td>
                    <td class="px-3 py-2">${formatMoney(p.payment_amount || p.amount)}</td>
                    <td class="px-3 py-2">${translatePaymentMethod(p.payment_method)}</td>
                    <td class="px-3 py-2">${formatDate(p.payment_date)}</td>
                    <td class="px-3 py-2">${sanitizeText(p.entity_id)}</td>
                    <td class="px-3 py-2">
                        <div class="flex flex-wrap gap-1 justify-end">
                            <button class="action-btn bg-white border border-slate-200 text-slate-700" onclick='openDetails("Ù…Ø¹Ø§ÙŠÙ†Ø© Ù…Ø¯ÙÙˆØ¹Ø©", ${JSON.stringify(p)})'><i class="fas fa-eye"></i>Ù…Ø¹Ø§ÙŠÙ†Ø©</button>
                            <button class="action-btn bg-emerald-500 text-white" onclick='openPaymentForm(${JSON.stringify(p)})'><i class="fas fa-pen"></i>ØªØ¹Ø¯ÙŠÙ„</button>
                            <button class="action-btn bg-rose-500 text-white" onclick="confirmDelete('payment', ${p.payment_id || p.id})"><i class="fas fa-trash"></i>Ø­Ø°Ù</button>
                        </div>
                    </td>
                </tr>
            `).join('');
            document.getElementById('paymentsTable').innerHTML = paymentRows || `<tr><td colspan="7" class="px-4 py-12 text-center text-slate-500">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</td></tr>`;
            document.getElementById('paymentsCount').textContent = `Ø¹Ø¯Ø¯ Ø§Ù„ØµÙÙˆÙ: ${payments.length}`;

            const customerRows = customers.map(c => `
                <tr class="hover:bg-amber-50">
                    <td class="px-3 py-2">${sanitizeText(c.customer_id || c.id)}</td>
                    <td class="px-3 py-2">${sanitizeText(c.customer_name || c.full_name || c.name)}</td>
                    <td class="px-3 py-2">${sanitizeText(c.phone || c.mobile)}</td>
                    <td class="px-3 py-2">${sanitizeText(c.email)}</td>
                    <td class="px-3 py-2">${formatMoney(c.balance || c.current_balance || 0)}</td>
                    <td class="px-3 py-2">${sanitizeText(c.entity_id)}</td>
                    <td class="px-3 py-2">
                        <div class="flex flex-wrap gap-1 justify-end">
                            <button class="action-btn bg-white border border-slate-200 text-slate-700" onclick='openDetails("Ù…Ø¹Ø§ÙŠÙ†Ø© Ø¹Ù…ÙŠÙ„", ${JSON.stringify(c)})'><i class="fas fa-eye"></i>Ù…Ø¹Ø§ÙŠÙ†Ø©</button>
                            <button class="action-btn bg-indigo-500 text-white" onclick='openCustomerForm(${JSON.stringify(c)})'><i class="fas fa-pen"></i>ØªØ¹Ø¯ÙŠÙ„</button>
                            <button class="action-btn bg-rose-500 text-white" onclick="confirmDelete('customer', ${c.customer_id || c.id})"><i class="fas fa-trash"></i>Ø­Ø°Ù</button>
                        </div>
                    </td>
                </tr>
            `).join('');
            document.getElementById('customersTable').innerHTML = customerRows || `<tr><td colspan="7" class="px-4 py-12 text-center text-slate-500">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</td></tr>`;
            document.getElementById('customersCount').textContent = `Ø¹Ø¯Ø¯ Ø§Ù„ØµÙÙˆÙ: ${customers.length}`;

            const requestRows = requests.map(r => `
                <tr class="hover:bg-rose-50">
                    <td class="px-3 py-2">${sanitizeText(r.id)}</td>
                    <td class="px-3 py-2">${sanitizeText(r.employee_name || r.employee_id)}</td>
                    <td class="px-3 py-2">${sanitizeText(r.request_type)}</td>
                    <td class="px-3 py-2">${sanitizeText(r.request_title)}</td>
                    <td class="px-3 py-2"><span class="pill bg-rose-100 text-rose-700">${translateStatus(r.status)}</span></td>
                    <td class="px-3 py-2">${formatDate(r.requested_date)}</td>
                    <td class="px-3 py-2">
                        <div class="flex flex-wrap gap-1 justify-end">
                            <button class="action-btn bg-white border border-slate-200 text-slate-700" onclick='openDetails("Ù…Ø¹Ø§ÙŠÙ†Ø© Ø·Ù„Ø¨", ${JSON.stringify(r)})'><i class="fas fa-eye"></i>Ù…Ø¹Ø§ÙŠÙ†Ø©</button>
                            <button class="action-btn bg-sky-600 text-white" onclick='openRequestForm(${JSON.stringify(r)})'><i class="fas fa-pen"></i>ØªØ¹Ø¯ÙŠÙ„</button>
                            <button class="action-btn bg-rose-500 text-white" onclick="confirmDelete('request', '${r.id}')"><i class="fas fa-trash"></i>Ø­Ø°Ù</button>
                        </div>
                    </td>
                </tr>
            `).join('');
            document.getElementById('requestsTable').innerHTML = requestRows || `<tr><td colspan="7" class="px-4 py-12 text-center text-slate-500">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</td></tr>`;
            document.getElementById('requestsCount').textContent = `Ø¹Ø¯Ø¯ Ø§Ù„ØµÙÙˆÙ: ${requests.length}`;
        }

        function translateStatus(value) {
            const map = {
                PENDING: 'Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©',
                APPROVED: 'Ù…Ø¹ØªÙ…Ø¯',
                REJECTED: 'Ù…Ø±ÙÙˆØ¶',
                COMPLETED: 'Ù…ÙƒØªÙ…Ù„',
                OVERDUE: 'Ù…ØªØ£Ø®Ø±',
                IN_PROGRESS: 'Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°',
                CANCELLED: 'Ù…Ù„ØºÙŠ',
                URGENT: 'Ø¹Ø§Ø¬Ù„',
                HIGH: 'Ù…Ø±ØªÙØ¹',
                NORMAL: 'Ø¹Ø§Ø¯ÙŠ',
                LOW: 'Ù…Ù†Ø®ÙØ¶'
            };
            return map[String(value || '').toUpperCase()] || sanitizeText(value) || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
        }

        function translatePaymentMethod(value) {
            const map = {
                CASH: 'Ù†Ù‚Ø¯ÙŠ',
                BANK: 'ØªØ­ÙˆÙŠÙ„ Ø¨Ù†ÙƒÙŠ',
                BANK_TRANSFER: 'ØªØ­ÙˆÙŠÙ„ Ø¨Ù†ÙƒÙŠ',
                CARD: 'Ø¨Ø·Ø§Ù‚Ø©',
                TRANSFER: 'ØªØ­ÙˆÙŠÙ„',
                ONLINE: 'Ø¯ÙØ¹ Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ',
                CHECK: 'Ø´ÙŠÙƒ'
            };
            return map[String(value || '').toUpperCase()] || sanitizeText(value) || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
        }

        function translatePriority(value) {
            const map = {
                LOW: 'Ù…Ù†Ø®ÙØ¶Ø©',
                NORMAL: 'Ø¹Ø§Ø¯ÙŠØ©',
                HIGH: 'Ù…Ø±ØªÙØ¹Ø©',
                URGENT: 'Ø¹Ø§Ø¬Ù„Ø©'
            };
            return map[String(value || '').toUpperCase()] || sanitizeText(value) || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
        }

        function formatMoney(value) {
            const num = parseFloat(value || 0);
            return num.toLocaleString('ar-SA') + ' Ø±.Ø³';
        }

        function formatDate(value) {
            if (!value) return '-';
            return new Date(value).toLocaleDateString('ar-SA');
        }

        function formatDateTime(value) {
            if (!value) return '-';
            return new Date(value).toLocaleString('ar-SA');
        }

        function sanitizeText(value) {
            if (value === null || value === undefined) return '-';
            const text = typeof value === 'string' ? value : JSON.stringify(value);
            const cleaned = text.replace(/[A-Za-z]+/g, '').replace(/\s{2,}/g, ' ').trim();
            return cleaned || '-';
        }

        function escapeHtml(str = '') {
            return String(str)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');
        }

        function openDetails(title, data) {
            const modal = document.getElementById('actionModal');
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalBody').innerHTML = `
                <pre class="bg-slate-50 border border-slate-100 p-4 rounded-2xl text-xs whitespace-pre-wrap leading-6">${escapeHtml(JSON.stringify(data, null, 2))}</pre>
            `;
            modal.classList.remove('hidden');
        }

        function openInvoiceForm(existing) {
            const isEdit = !!existing;
            const title = isEdit ? 'ØªØ¹Ø¯ÙŠÙ„ ÙØ§ØªÙˆØ±Ø©' : 'Ø¥Ø¶Ø§ÙØ© ÙØ§ØªÙˆØ±Ø© Ø¬Ø¯ÙŠØ¯Ø©';
            const modal = document.getElementById('actionModal');
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalBody').innerHTML = `
                <form id="invoiceForm" class="grid grid-cols-1 md:grid-cols-2 gap-4" onsubmit="submitInvoiceForm(event, ${existing ? existing.invoice_id || existing.id : null})">
                    <div>
                        <label class="block text-sm text-slate-600 mb-1">Ø§Ù„Ø¹Ù…ÙŠÙ„</label>
                        <select name="customer_id" class="w-full border rounded-xl px-3 py-2" required>
                            <option value="">Ø§Ø®ØªØ± Ø¹Ù…ÙŠÙ„</option>
                            ${customers.map(c => `<option value="${c.customer_id || c.id}" ${existing && (existing.customer_id || existing.id) === (c.customer_id || c.id) ? 'selected' : ''}>${sanitizeText(c.customer_name || c.customer_name_ar || c.name || c.customer_code)}</option>`).join('')}
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm text-slate-600 mb-1">ØªØ§Ø±ÙŠØ® Ø§Ù„ÙØ§ØªÙˆØ±Ø©</label>
                        <input type="date" name="invoice_date" class="w-full border rounded-xl px-3 py-2" value="${existing?.invoice_date ? existing.invoice_date.split('T')[0] : ''}" required />
                    </div>
                    <div>
                        <label class="block text-sm text-slate-600 mb-1">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚</label>
                        <input type="date" name="due_date" class="w-full border rounded-xl px-3 py-2" value="${existing?.due_date ? existing.due_date.split('T')[0] : ''}" required />
                    </div>
                    <div>
                        <label class="block text-sm text-slate-600 mb-1">Ø§Ù„Ø¹Ù†ØµØ± / Ø§Ù„Ø®Ø¯Ù…Ø©</label>
                        <input type="text" name="item_name" class="w-full border rounded-xl px-3 py-2" value="${existing?.item_name || existing?.notes || ''}" placeholder="Ù…Ø«Ø§Ù„: Ø§Ø³ØªØ´Ø§Ø±Ø© ØªØ´ØºÙŠÙ„ÙŠØ©" required />
                    </div>
                    <div>
                        <label class="block text-sm text-slate-600 mb-1">Ø§Ù„ÙƒÙ…ÙŠØ©</label>
                        <input type="number" step="0.01" name="quantity" class="w-full border rounded-xl px-3 py-2" value="${existing ? 1 : 1}" required />
                    </div>
                    <div>
                        <label class="block text-sm text-slate-600 mb-1">Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø©</label>
                        <input type="number" step="0.01" name="unit_price" class="w-full border rounded-xl px-3 py-2" value="${existing?.total_amount || ''}" placeholder="Ù…Ø«Ø§Ù„: 1500" required />
                    </div>
                    <div>
                        <label class="block text-sm text-slate-600 mb-1">Ù†Ø³Ø¨Ø© Ø§Ù„Ø¶Ø±ÙŠØ¨Ø© (%)</label>
                        <input type="number" step="0.01" name="tax_percentage" class="w-full border rounded-xl px-3 py-2" value="15" />
                    </div>
                    <div>
                        <label class="block text-sm text-slate-600 mb-1">Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label>
                        <textarea name="notes" class="w-full border rounded-xl px-3 py-2" rows="2">${existing?.notes || ''}</textarea>
                    </div>
                    ${isEdit ? `
                    <div>
                        <label class="block text-sm text-slate-600 mb-1">Ø­Ø§Ù„Ø© Ø§Ù„ÙØ§ØªÙˆØ±Ø©</label>
                        <select name="status" class="w-full border rounded-xl px-3 py-2">
                            ${['ISSUED','PAID','PARTIAL','OVERDUE','COMPLETED'].map(s => `<option value="${s}" ${existing?.status === s ? 'selected' : ''}>${translateStatus(s)}</option>`).join('')}
                        </select>
                    </div>
                    ` : ''}
                    <div class="md:col-span-2 flex justify-end gap-2 mt-2">
                        <button type="button" class="action-btn bg-slate-100 text-slate-700" onclick="closeModal()">Ø¥Ù„ØºØ§Ø¡</button>
                        <button type="submit" class="action-btn bg-amber-500 text-white"><i class="fas fa-save"></i>${isEdit ? 'ØªØ­Ø¯ÙŠØ«' : 'Ø­ÙØ¸'}</button>
                    </div>
                </form>
            `;
            modal.classList.remove('hidden');
        }

        async function submitInvoiceForm(event, invoiceId) {
            event.preventDefault();
            const form = event.target;
            const payload = invoiceId ? {
                customer_id: form.customer_id.value,
                invoice_date: form.invoice_date.value,
                due_date: form.due_date.value,
                notes: form.notes.value,
                status: form.status ? form.status.value : undefined
            } : {
                customer_id: form.customer_id.value,
                invoice_date: form.invoice_date.value,
                due_date: form.due_date.value,
                entity_type: ENTITY_TYPE,
                entity_id: ENTITY_ID,
                allow_partial_payment: true,
                allow_installments: false,
                notes: form.notes.value,
                lines: [{
                    item_code: 'SRV-1',
                    item_name: form.item_name.value,
                    description: form.notes.value,
                    quantity: parseFloat(form.quantity.value || 1),
                    unit_price: parseFloat(form.unit_price.value || 0),
                    tax_percentage: parseFloat(form.tax_percentage.value || 15),
                    discount_percentage: 0,
                    discount_amount: 0,
                    revenue_account_id: null
                }]
            };

            const endpoint = invoiceId ? `${API_BASE}/finance/invoices/${invoiceId}` : `${API_BASE}/finance/invoices`;
            const method = invoiceId ? 'PUT' : 'POST';
            const res = await fetch(endpoint, { method, headers: defaultHeaders, body: JSON.stringify(payload) });
            if (!res.ok) {
                showToast('ØªØ¹Ø°Ø± Ø­ÙØ¸ Ø§Ù„ÙØ§ØªÙˆØ±Ø©', 'error');
                return;
            }
            showToast('ØªÙ… Ø­ÙØ¸ Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø¨Ù†Ø¬Ø§Ø­');
            closeModal();
            refreshData();
        }

        function openPaymentForm(existing) {
            const isEdit = !!existing;
            document.getElementById('modalTitle').textContent = isEdit ? 'ØªØ¹Ø¯ÙŠÙ„ Ù…Ø¯ÙÙˆØ¹Ø©' : 'Ø¥Ø¶Ø§ÙØ© Ù…Ø¯ÙÙˆØ¹Ø© Ø¬Ø¯ÙŠØ¯Ø©';
            document.getElementById('modalBody').innerHTML = `
                <form id="paymentForm" class="grid grid-cols-1 md:grid-cols-2 gap-4" onsubmit="submitPaymentForm(event, ${existing ? existing.payment_id || existing.id : null})">
                    <div>
                        <label class="block text-sm text-slate-600 mb-1">Ø§Ù„Ø¹Ù…ÙŠÙ„</label>
                        <select name="customer_id" class="w-full border rounded-xl px-3 py-2" required>
                            <option value="">Ø§Ø®ØªØ± Ø¹Ù…ÙŠÙ„</option>
                            ${customers.map(c => `<option value="${c.customer_id || c.id}" ${existing && (existing.customer_id || existing.id) === (c.customer_id || c.id) ? 'selected' : ''}>${sanitizeText(c.customer_name || c.customer_name_ar || c.name || c.customer_code)}</option>`).join('')}
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm text-slate-600 mb-1">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¯ÙØ¹</label>
                        <input type="date" name="payment_date" class="w-full border rounded-xl px-3 py-2" value="${existing?.payment_date ? existing.payment_date.split('T')[0] : ''}" required />
                    </div>
                    <div>
                        <label class="block text-sm text-slate-600 mb-1">Ø§Ù„Ù…Ø¨Ù„Øº</label>
                        <input type="number" step="0.01" name="payment_amount" class="w-full border rounded-xl px-3 py-2" value="${existing?.payment_amount || ''}" required />
                    </div>
                    <div>
                        <label class="block text-sm text-slate-600 mb-1">Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹</label>
                        <select name="payment_method" class="w-full border rounded-xl px-3 py-2" required>
                            ${['CASH','BANK_TRANSFER','CARD','ONLINE','CHECK'].map(m => `<option value="${m}" ${existing?.payment_method === m ? 'selected' : ''}>${translatePaymentMethod(m)}</option>`).join('')}
                        </select>
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-sm text-slate-600 mb-1">Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label>
                        <textarea name="notes" class="w-full border rounded-xl px-3 py-2" rows="2">${existing?.notes || ''}</textarea>
                    </div>
                    ${isEdit ? `
                    <div>
                        <label class="block text-sm text-slate-600 mb-1">Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø©</label>
                        <select name="status" class="w-full border rounded-xl px-3 py-2">
                            ${['COMPLETED','PENDING','FAILED','CANCELLED'].map(s => `<option value="${s}" ${existing?.status === s ? 'selected' : ''}>${translateStatus(s)}</option>`).join('')}
                        </select>
                    </div>` : ''}
                    <div class="md:col-span-2 flex justify-end gap-2 mt-2">
                        <button type="button" class="action-btn bg-slate-100 text-slate-700" onclick="closeModal()">Ø¥Ù„ØºØ§Ø¡</button>
                        <button type="submit" class="action-btn bg-emerald-500 text-white"><i class="fas fa-save"></i>${isEdit ? 'ØªØ­Ø¯ÙŠØ«' : 'Ø­ÙØ¸'}</button>
                    </div>
                </form>
            `;
            document.getElementById('actionModal').classList.remove('hidden');
        }

        async function submitPaymentForm(event, paymentId) {
            event.preventDefault();
            const form = event.target;
            const payload = paymentId ? {
                customer_id: form.customer_id.value,
                payment_date: form.payment_date.value,
                payment_amount: parseFloat(form.payment_amount.value || 0),
                payment_method: form.payment_method.value,
                status: form.status ? form.status.value : undefined,
                notes: form.notes.value
            } : {
                customer_id: form.customer_id.value,
                customer_name: customers.find(c => (c.customer_id || c.id) == form.customer_id.value)?.customer_name_ar,
                payment_date: form.payment_date.value,
                payment_amount: parseFloat(form.payment_amount.value || 0),
                payment_method: form.payment_method.value,
                entity_type: ENTITY_TYPE,
                entity_id: ENTITY_ID,
                payment_type: 'FULL',
                notes: form.notes.value,
                allocations: []
            };

            const endpoint = paymentId ? `${API_BASE}/finance/payments/${paymentId}` : `${API_BASE}/finance/payments`;
            const method = paymentId ? 'PUT' : 'POST';
            const res = await fetch(endpoint, { method, headers: defaultHeaders, body: JSON.stringify(payload) });
            if (!res.ok) {
                showToast('ØªØ¹Ø°Ø± Ø­ÙØ¸ Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø©', 'error');
                return;
            }
            showToast('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø© Ø¨Ù†Ø¬Ø§Ø­');
            closeModal();
            refreshData();
        }

        function openCustomerForm(existing) {
            const isEdit = !!existing;
            document.getElementById('modalTitle').textContent = isEdit ? 'ØªØ¹Ø¯ÙŠÙ„ Ø¹Ù…ÙŠÙ„' : 'Ø¥Ø¶Ø§ÙØ© Ø¹Ù…ÙŠÙ„ Ø¬Ø¯ÙŠØ¯';
            document.getElementById('modalBody').innerHTML = `
                <form id="customerForm" class="grid grid-cols-1 md:grid-cols-2 gap-4" onsubmit="submitCustomerForm(event, ${existing ? existing.customer_id || existing.id : null})">
                    <div class="md:col-span-2">
                        <label class="block text-sm text-slate-600 mb-1">Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„</label>
                        <input type="text" name="customer_name_ar" class="w-full border rounded-xl px-3 py-2" value="${existing?.customer_name || existing?.customer_name_ar || ''}" required />
                    </div>
                    <div>
                        <label class="block text-sm text-slate-600 mb-1">Ø§Ù„Ø¬ÙˆØ§Ù„</label>
                        <input type="text" name="phone" class="w-full border rounded-xl px-3 py-2" value="${existing?.phone || existing?.mobile || ''}" />
                    </div>
                    <div>
                        <label class="block text-sm text-slate-600 mb-1">Ø§Ù„Ø¨Ø±ÙŠØ¯</label>
                        <input type="email" name="email" class="w-full border rounded-xl px-3 py-2" value="${existing?.email || ''}" />
                    </div>
                    <div class="md:col-span-2 flex justify-end gap-2 mt-2">
                        <button type="button" class="action-btn bg-slate-100 text-slate-700" onclick="closeModal()">Ø¥Ù„ØºØ§Ø¡</button>
                        <button type="submit" class="action-btn bg-indigo-500 text-white"><i class="fas fa-save"></i>${isEdit ? 'ØªØ­Ø¯ÙŠØ«' : 'Ø­ÙØ¸'}</button>
                    </div>
                </form>
            `;
            document.getElementById('actionModal').classList.remove('hidden');
        }

        async function submitCustomerForm(event, customerId) {
            event.preventDefault();
            const form = event.target;
            const payload = {
                customer_name_ar: form.customer_name_ar.value,
                phone: form.phone.value,
                email: form.email.value,
                entity_id: ENTITY_ID,
                entity_type: ENTITY_TYPE
            };

            const endpoint = customerId ? `${API_BASE}/finance/customers/${customerId}` : `${API_BASE}/finance/customers`;
            const method = customerId ? 'PUT' : 'POST';
            const res = await fetch(endpoint + (customerId ? '' : ''), { method, headers: defaultHeaders, body: JSON.stringify(payload) });
            if (!res.ok) {
                showToast('ØªØ¹Ø°Ø± Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„', 'error');
                return;
            }
            showToast('ØªÙ… Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­');
            closeModal();
            refreshData();
        }

        function openRequestForm(existing) {
            const isEdit = !!existing;
            document.getElementById('modalTitle').textContent = isEdit ? 'ØªØ¹Ø¯ÙŠÙ„ Ø·Ù„Ø¨ Ù…ÙˆØ¸Ù' : 'Ø¥Ø¶Ø§ÙØ© Ø·Ù„Ø¨ Ù…ÙˆØ¸Ù';
            document.getElementById('modalBody').innerHTML = `
                <form id="requestForm" class="grid grid-cols-1 md:grid-cols-2 gap-4" onsubmit="submitRequestForm(event, '${existing ? existing.id : ''}')">
                    <div>
                        <label class="block text-sm text-slate-600 mb-1">Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù</label>
                        <input type="text" name="employee_name" class="w-full border rounded-xl px-3 py-2" value="${existing?.employee_name || ''}" required />
                    </div>
                    <div>
                        <label class="block text-sm text-slate-600 mb-1">Ù†ÙˆØ¹ Ø§Ù„Ø·Ù„Ø¨</label>
                        <input type="text" name="request_type" class="w-full border rounded-xl px-3 py-2" value="${existing?.request_type || ''}" required />
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-sm text-slate-600 mb-1">Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø·Ù„Ø¨</label>
                        <input type="text" name="request_title" class="w-full border rounded-xl px-3 py-2" value="${existing?.request_title || ''}" required />
                    </div>
                    <div>
                        <label class="block text-sm text-slate-600 mb-1">Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ©</label>
                        <select name="priority" class="w-full border rounded-xl px-3 py-2">
                            ${['LOW','NORMAL','HIGH','URGENT'].map(p => `<option value="${p}" ${existing?.priority === p ? 'selected' : ''}>${translatePriority(p)}</option>`).join('')}
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm text-slate-600 mb-1">Ø§Ù„Ø­Ø§Ù„Ø©</label>
                        <select name="status" class="w-full border rounded-xl px-3 py-2">
                            ${['PENDING','APPROVED','IN_PROGRESS','COMPLETED','REJECTED'].map(s => `<option value="${s}" ${existing?.status === s ? 'selected' : ''}>${translateStatus(s)}</option>`).join('')}
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm text-slate-600 mb-1">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø·Ù„Ø¨</label>
                        <input type="date" name="requested_date" class="w-full border rounded-xl px-3 py-2" value="${existing?.requested_date ? existing.requested_date.split('T')[0] : ''}" required />
                    </div>
                    <div>
                        <label class="block text-sm text-slate-600 mb-1">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©</label>
                        <input type="date" name="start_date" class="w-full border rounded-xl px-3 py-2" value="${existing?.start_date ? existing.start_date.split('T')[0] : ''}" />
                    </div>
                    <div>
                        <label class="block text-sm text-slate-600 mb-1">ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ©</label>
                        <input type="date" name="end_date" class="w-full border rounded-xl px-3 py-2" value="${existing?.end_date ? existing.end_date.split('T')[0] : ''}" />
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-sm text-slate-600 mb-1">Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label>
                        <textarea name="notes" class="w-full border rounded-xl px-3 py-2" rows="2">${existing?.notes || ''}</textarea>
                    </div>
                    <div class="md:col-span-2 flex justify-end gap-2 mt-2">
                        <button type="button" class="action-btn bg-slate-100 text-slate-700" onclick="closeModal()">Ø¥Ù„ØºØ§Ø¡</button>
                        <button type="submit" class="action-btn bg-sky-600 text-white"><i class="fas fa-save"></i>${isEdit ? 'ØªØ­Ø¯ÙŠØ«' : 'Ø­ÙØ¸'}</button>
                    </div>
                </form>
            `;
            document.getElementById('actionModal').classList.remove('hidden');
        }

        async function submitRequestForm(event, requestId) {
            event.preventDefault();
            const form = event.target;
            const payload = {
                id: requestId || `REQ-${Date.now()}`,
                entityId: ENTITY_ID,
                employeeName: form.employee_name.value,
                requestType: form.request_type.value,
                requestTitle: form.request_title.value,
                status: form.status.value,
                priority: form.priority.value,
                requestedDate: form.requested_date.value,
                startDate: form.start_date.value || null,
                endDate: form.end_date.value || null,
                notes: form.notes.value,
                createdBy: 'system'
            };

            const endpoint = requestId ? `${API_BASE}/api/employee-requests/${requestId}` : `${API_BASE}/api/employee-requests`;
            const method = requestId ? 'PUT' : 'POST';
            const res = await fetch(endpoint, { method, headers: defaultHeaders, body: JSON.stringify(payload) });
            if (!res.ok) {
                showToast('ØªØ¹Ø°Ø± Ø­ÙØ¸ Ø·Ù„Ø¨ Ø§Ù„Ù…ÙˆØ¸Ù', 'error');
                return;
            }
            showToast('ØªÙ… Ø­ÙØ¸ Ø·Ù„Ø¨ Ø§Ù„Ù…ÙˆØ¸Ù');
            closeModal();
            refreshData();
        }

        async function confirmDelete(type, id) {
            if (!id) return;
            if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø­Ø°ÙØŸ')) return;
            let endpoint = '';
            if (type === 'invoice') endpoint = `${API_BASE}/finance/invoices/${id}`;
            if (type === 'payment') endpoint = `${API_BASE}/finance/payments/${id}`;
            if (type === 'customer') endpoint = `${API_BASE}/finance/customers/${id}?entity_id=${ENTITY_ID}`;
            if (type === 'request') endpoint = `${API_BASE}/api/employee-requests/${id}`;
            const res = await fetch(endpoint, { method: 'DELETE', headers: defaultHeaders });
            if (!res.ok) {
                showToast('ÙØ´Ù„ Ø§Ù„Ø­Ø°ÙØŒ Ø±Ø§Ø¬Ø¹ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø©', 'error');
                return;
            }
            showToast('ØªÙ… Ø§Ù„Ø­Ø°Ù Ø¨Ù†Ø¬Ø§Ø­');
            refreshData();
        }

        function closeModal() {
            document.getElementById('actionModal').classList.add('hidden');
        }

        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `fixed bottom-4 right-4 z-50 px-4 py-3 rounded-2xl shadow-2xl text-sm ${type === 'error' ? 'bg-rose-600 text-white' : 'bg-emerald-600 text-white'}`;
            toast.classList.remove('hidden');
            setTimeout(() => toast.classList.add('hidden'), 3200);
        }

        function downloadAllJSON() {
            const payload = { invoices, payments, customers, employee_requests: requests };
            downloadBlob(JSON.stringify(payload, null, 2), 'Ù…Ù†Ø¸ÙˆÙ…Ø©-Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª-ÙˆØ§Ù„Ø­Ø³Ø§Ø¨Ø§Øª.json', 'application/json');
        }

        function downloadAllCSV() {
            const rows = [];
            rows.push(['Ø§Ù„ÙÙˆØ§ØªÙŠØ±']);
            rows.push(['Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©','Ø§Ù„Ø¹Ù…ÙŠÙ„','Ø§Ù„Ù…Ø¨Ù„Øº','Ø§Ù„Ø­Ø§Ù„Ø©','ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚','Ø§Ù„Ù…Ù†Ø´Ø£Ø©','ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡']);
            invoices.forEach(i => rows.push([
                i.invoice_id || i.id,
                sanitizeText(i.customer_name || i.customer_id),
                i.total_amount || i.amount,
                translateStatus(i.status),
                i.due_date,
                i.entity_id,
                i.created_at
            ]));

            rows.push([]);
            rows.push(['Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª']);
            rows.push(['Ø±Ù‚Ù… Ø§Ù„Ø¯ÙØ¹','Ø§Ù„Ø¹Ù…ÙŠÙ„','Ø§Ù„Ù…Ø¨Ù„Øº','Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹','ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¯ÙØ¹','Ø§Ù„Ù…Ù†Ø´Ø£Ø©']);
            payments.forEach(p => rows.push([
                p.payment_id || p.id,
                sanitizeText(p.customer_name || p.customer_id),
                p.payment_amount || p.amount,
                translatePaymentMethod(p.payment_method),
                p.payment_date,
                p.entity_id
            ]));

            rows.push([]);
            rows.push(['Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡']);
            rows.push(['Ø±Ù‚Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„','Ø§Ù„Ø§Ø³Ù…','Ø§Ù„Ø¬ÙˆØ§Ù„','Ø§Ù„Ø¨Ø±ÙŠØ¯','Ø§Ù„Ø±ØµÙŠØ¯','Ø§Ù„Ù…Ù†Ø´Ø£Ø©']);
            customers.forEach(c => rows.push([
                c.customer_id || c.id,
                sanitizeText(c.customer_name || c.full_name || c.name),
                sanitizeText(c.phone || c.mobile),
                sanitizeText(c.email),
                c.balance || c.current_balance || 0,
                c.entity_id
            ]));

            rows.push([]);
            rows.push(['Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†']);
            rows.push(['Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨','Ø§Ù„Ù…ÙˆØ¸Ù','Ù†ÙˆØ¹ Ø§Ù„Ø·Ù„Ø¨','Ø§Ù„Ø¹Ù†ÙˆØ§Ù†','Ø§Ù„Ø­Ø§Ù„Ø©','ØªØ§Ø±ÙŠØ® Ø§Ù„Ø·Ù„Ø¨']);
            requests.forEach(r => rows.push([
                r.id,
                sanitizeText(r.employee_name || r.employee_id),
                sanitizeText(r.request_type),
                sanitizeText(r.request_title),
                translateStatus(r.status),
                r.requested_date
            ]));

            const csvContent = rows.map(r => r.map(v => `"${v ?? ''}"`).join(',')).join('\n');
            downloadBlob(csvContent, 'Ù…Ù†Ø¸ÙˆÙ…Ø©-Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª-ÙˆØ§Ù„Ø­Ø³Ø§Ø¨Ø§Øª.csv', 'text/csv;charset=utf-8;');
        }

        function downloadBlob(content, filename, type) {
            const blob = new Blob([content], { type });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            link.click();
            URL.revokeObjectURL(url);
        }

        function printReport() {
            window.print();
        }

        function refreshData() {
            loadData();
        }

        document.addEventListener('DOMContentLoaded', loadData);
    </script>
</body>
</html>
