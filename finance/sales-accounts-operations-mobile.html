<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>๐งพ ููุธููุฉ ุงููุจูุนุงุช ูุงูุญุณุงุจุงุช ูุงูุชุดุบูู - ูุธุงู ูุงููุด</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            font-family: 'Cairo', sans-serif;
            background: linear-gradient(135deg, #0ea5e9 0%, #6366f1 50%, #14b8a6 100%);
            min-height: 100vh;
        }
        .card-glass {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
        }
        .stat-pill { border-radius: 999px; box-shadow: 0 18px 30px rgba(15, 23, 42, 0.15); }
        .stat-angled { border-radius: 28px 6px 28px 6px; }
        .stat-rounded { border-radius: 28px; }
        .stat-cut { border-radius: 6px 28px 6px 28px; }
        .table-scroll { max-height: 560px; overflow: auto; }
        .section-accent-sky { border-top: 4px solid #0ea5e9; }
        .section-accent-emerald { border-top: 4px solid #10b981; }
        .section-accent-amber { border-top: 4px solid #f59e0b; }
        .section-accent-violet { border-top: 4px solid #8b5cf6; }
        .section-accent-rose { border-top: 4px solid #f43f5e; }
        .chip { padding: 6px 12px; border-radius: 999px; font-weight: 700; }
    </style>
</head>
<body>
    <div class="container mx-auto px-4 py-8">
        <div class="mb-8 text-white">
            <h1 class="text-4xl font-bold mb-2">๐งพ ููุธููุฉ ุงููุจูุนุงุช ูุงูุญุณุงุจุงุช ูุงูุชุดุบูู</h1>
            <p class="text-lg opacity-90">ุงููุจูุนุงุช ูุงูุนููุงุก ูุงููุฎุฒูู ูุงูุญุณุงุจุงุช ูุงูููุงุฑุฏ ุงูุจุดุฑูุฉ ูุงูุชุดุบูู ูุงูุชุทุจููุงุช (ุงูุตูุญุฉ 44)</p>
        </div>

        <div class="mb-6 flex flex-wrap gap-3">
            <button onclick="refreshData()" class="bg-white text-sky-700 px-6 py-3 rounded-full font-bold hover:shadow-lg transition flex items-center gap-2">
                <i class="fas fa-rotate"></i>
                ุชุญุฏูุซ ุงูุจูุงูุงุช
            </button>
            <button onclick="downloadAllJSON()" class="bg-indigo-600 text-white px-6 py-3 rounded-full font-bold hover:shadow-lg transition flex items-center gap-2">
                <i class="fas fa-file-code"></i>
                ุชูุฒูู ููู ุจูุงูุงุช ุดุงูู
            </button>
            <button onclick="downloadAllCSV()" class="bg-emerald-600 text-white px-6 py-3 rounded-full font-bold hover:shadow-lg transition flex items-center gap-2">
                <i class="fas fa-file-csv"></i>
                ุชูุฒูู ููู ุฌุฏููู ุดุงูู
            </button>
            <button onclick="printReport()" class="bg-rose-600 text-white px-6 py-3 rounded-full font-bold hover:shadow-lg transition flex items-center gap-2">
                <i class="fas fa-print"></i>
                ุทุจุงุนุฉ ุงูุชูุฑูุฑ
            </button>
        </div>

        <!-- Stats -->
        <div class="card-glass rounded-3xl shadow-2xl p-6 mb-8 section-accent-sky">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-5">
                <div class="stat-pill bg-gradient-to-br from-sky-500 to-blue-600 text-white p-6">
                    <div class="flex justify-between mb-3"><span>ุฅุฌูุงูู ุงูููุงุชูุฑ</span><i class="fas fa-file-invoice text-2xl opacity-70"></i></div>
                    <div id="invoicesTotal" class="text-3xl font-bold"><div class="animate-pulse">...</div></div>
                </div>
                <div class="stat-angled bg-gradient-to-br from-emerald-500 to-teal-600 text-white p-6">
                    <div class="flex justify-between mb-3"><span>ุฅุฌูุงูู ุงููุฏููุนุงุช</span><i class="fas fa-hand-holding-dollar text-2xl opacity-70"></i></div>
                    <div id="paymentsTotal" class="text-3xl font-bold"><div class="animate-pulse">...</div></div>
                </div>
                <div class="stat-rounded bg-gradient-to-br from-indigo-500 to-purple-600 text-white p-6">
                    <div class="flex justify-between mb-3"><span>ุฅุฌูุงูู ุงูุนููุงุก</span><i class="fas fa-users text-2xl opacity-70"></i></div>
                    <div id="customersTotal" class="text-3xl font-bold"><div class="animate-pulse">...</div></div>
                </div>
                <div class="stat-cut bg-gradient-to-br from-rose-500 to-pink-600 text-white p-6">
                    <div class="flex justify-between mb-3"><span>ุทูุจุงุช ุงูููุธููู</span><i class="fas fa-clipboard-list text-2xl opacity-70"></i></div>
                    <div id="requestsTotal" class="text-3xl font-bold"><div class="animate-pulse">...</div></div>
                </div>
            </div>
        </div>

        <!-- Sales & Inventory -->
        <div class="card-glass rounded-3xl shadow-2xl p-6 mb-8 section-accent-emerald">
            <h2 class="text-2xl font-bold text-slate-800 mb-4">๐ ุงููุจูุนุงุช ูุงูุนููุงุก ูุงููุฎุฒูู</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 text-sm">
                <div class="stat-pill bg-emerald-50 p-4">ุงูููุงุชูุฑ ูุนุฑูุถ ุงูุฃุณุนุงุฑ</div>
                <div class="stat-angled bg-sky-50 p-4">ููุงุท ุงูุจูุน</div>
                <div class="stat-rounded bg-indigo-50 p-4">ุงูุนุฑูุถ</div>
                <div class="stat-cut bg-rose-50 p-4">ุงูุฃูุณุงุท</div>
                <div class="stat-pill bg-amber-50 p-4">ุงููุจูุนุงุช ุงููุณุชูุฏูุฉ ูุงูุนูููุงุช</div>
                <div class="stat-angled bg-violet-50 p-4">ุงููุงุชูุฑุฉ ุงูุฅููุชุฑูููุฉ ุงูุณุนูุฏูุฉ</div>
                <div class="stat-rounded bg-sky-50 p-4">ููุฆุฉ ุงูุฒูุงุฉ ูุงูุฏุฎู</div>
                <div class="stat-cut bg-emerald-50 p-4">ุงููุงุชูุฑุฉ ุงูุฅููุชุฑูููุฉ ุงููุตุฑูุฉ</div>
                <div class="stat-pill bg-indigo-50 p-4">ูุตูุญุฉ ุงูุถุฑุงุฆุจ</div>
                <div class="stat-angled bg-rose-50 p-4">ุงููุงุชูุฑุฉ ุงูุฅููุชุฑูููุฉ ุงูุฃุฑุฏููุฉ</div>
                <div class="stat-rounded bg-amber-50 p-4">ุฏุงุฆุฑุฉ ุถุฑูุจุฉ ุงูุฏุฎู ูุงููุจูุนุงุช</div>
                <div class="stat-cut bg-violet-50 p-4">ูุชุงุจุนุฉ ุงูุนููุงุก</div>
                <div class="stat-pill bg-sky-50 p-4">ููุงุท ุงูููุงุก ููุนููุงุก</div>
                <div class="stat-angled bg-emerald-50 p-4">ุงูุงุดุชุฑุงูุงุช ูุงูุนุถููุงุช</div>
                <div class="stat-rounded bg-indigo-50 p-4">ุงูููุงุท ูุงูุฃุฑุตุฏุฉ</div>
                <div class="stat-cut bg-rose-50 p-4">ุงูุชุฃูููุงุช</div>
                <div class="stat-pill bg-amber-50 p-4">ุฅุฏุงุฑุฉ ุงูููุชุฌุงุช</div>
                <div class="stat-angled bg-violet-50 p-4">ุงููุดุชุฑูุงุช</div>
                <div class="stat-rounded bg-sky-50 p-4">ุฅุฏุงุฑุฉ ุงูููุฑุฏูู</div>
                <div class="stat-cut bg-emerald-50 p-4">ุฏูุฑุฉ ุงููุดุชุฑูุงุช</div>
                <div class="stat-pill bg-indigo-50 p-4">ุงูุฃุฐูู ุงููุฎุฒููุฉ</div>
                <div class="stat-angled bg-rose-50 p-4">ุฅุฏุงุฑุฉ ุงูุฌุฑุฏ</div>
            </div>
        </div>

        <!-- Accounts, HR, Operations -->
        <div class="card-glass rounded-3xl shadow-2xl p-6 mb-8 section-accent-amber">
            <h2 class="text-2xl font-bold text-slate-800 mb-4">๐ ุงูุญุณุงุจุงุช ูุงูููุงุฑุฏ ุงูุจุดุฑูุฉ ูุงูุชุดุบูู</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 text-sm">
                <div class="stat-rounded bg-amber-50 p-4">ุฏููู ุงูุญุณุงุจุงุช</div>
                <div class="stat-angled bg-sky-50 p-4">ุงููุตุฑููุงุช</div>
                <div class="stat-pill bg-emerald-50 p-4">ุฅุฏุงุฑุฉ ุงูุฃุตูู</div>
                <div class="stat-cut bg-rose-50 p-4">ูุฑุงูุฒ ุงูุชูููุฉ</div>
                <div class="stat-rounded bg-indigo-50 p-4">ุฏูุฑุฉ ุงูุดููุงุช</div>
                <div class="stat-angled bg-violet-50 p-4">ุงูุญุถูุฑ ูุงูุงูุตุฑุงู</div>
                <div class="stat-pill bg-amber-50 p-4">ุฅุฏุงุฑุฉ ุงูุนููุฏ</div>
                <div class="stat-cut bg-sky-50 p-4">ุฅุฏุงุฑุฉ ุงููุฑุชุจุงุช</div>
                <div class="stat-rounded bg-emerald-50 p-4">ุฅุฏุงุฑุฉ ุงูุทูุจุงุช</div>
                <div class="stat-angled bg-rose-50 p-4">ุดุคูู ุงูููุธููู</div>
                <div class="stat-pill bg-indigo-50 p-4">ุฃูุงูุฑ ุงูุดุบู</div>
                <div class="stat-cut bg-amber-50 p-4">ุฏูุฑุฉ ุงูุนูู</div>
                <div class="stat-rounded bg-violet-50 p-4">ุงูุญุฌูุฒุงุช</div>
                <div class="stat-angled bg-sky-50 p-4">ุฅุฏุงุฑุฉ ุงูุฅูุฌุงุฑุงุช ูุงููุญุฏุงุช</div>
                <div class="stat-pill bg-emerald-50 p-4">ุนููุฏ ุงูุฅูุฌุงุฑ</div>
                <div class="stat-cut bg-rose-50 p-4">ุชุชุจุน ุงูููุช</div>
                <div class="stat-rounded bg-indigo-50 p-4">ุฅุฏุงุฑุฉ ุงูุชุตููุน</div>
            </div>
        </div>

        <!-- Mobile Apps -->
        <div class="card-glass rounded-3xl shadow-2xl p-6 mb-8 section-accent-violet">
            <h2 class="text-2xl font-bold text-slate-800 mb-4">๐ฑ ุชุทุจููุงุช ุงูุฌูุงู</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 text-sm">
                <div class="stat-pill bg-violet-50 p-4">ุฅุฏุงุฑุฉ ุงูุฃุนูุงู ููุฌูุงู</div>
                <div class="stat-angled bg-sky-50 p-4">ููุงุท ุงูุจูุน ููุฌูุงู</div>
                <div class="stat-rounded bg-emerald-50 p-4">ููุงุท ุงูุจูุน ุณุทุญ ุงูููุชุจ</div>
                <div class="stat-cut bg-rose-50 p-4">ุชุณุฌูู ุงูุญุถูุฑ ููุฌูุงู</div>
                <div class="stat-pill bg-amber-50 p-4">ุชุณุฌูู ุงููุตุฑููุงุช ุงูุณุฑูุน ููุฌูุงู</div>
                <div class="stat-angled bg-indigo-50 p-4">ูุฑุงุกุฉ ุงููุงุชูุฑุฉ ุงูุฅููุชุฑูููุฉ ููุฌูุงู</div>
                <div class="stat-rounded bg-violet-50 p-4">ุฌุฑุฏ ุงููุฎุฒูู</div>
            </div>
        </div>

        <!-- Training -->
        <div class="card-glass rounded-3xl shadow-2xl p-6 mb-8 section-accent-rose">
            <h2 class="text-2xl font-bold text-slate-800 mb-4">๐ ุงูุชุนููู ูุงูุชุฏุฑูุจ</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 text-sm">
                <div class="stat-rounded bg-rose-50 p-4">ุชุนูู ููููุฉ ุฅุฏุงุฑุฉ ุฃุนูุงูู</div>
                <div class="stat-angled bg-amber-50 p-4">ุชุตูุญ ุงูุฃูุณุงู</div>
                <div class="stat-pill bg-emerald-50 p-4">ุฌููุน ุงูุฃูุณุงู</div>
                <div class="stat-cut bg-sky-50 p-4">ุฅุฏุงุฑุฉ ุงูุญุณุงุจุงุช</div>
                <div class="stat-rounded bg-indigo-50 p-4">ุฅุฏุงุฑุฉ ุงูุฃุนูุงู</div>
                <div class="stat-angled bg-violet-50 p-4">ุฅุฏุงุฑุฉ ุงููุจูุนุงุช</div>
                <div class="stat-pill bg-amber-50 p-4">ุฅุฏุงุฑุฉ ุงููุฎุงุฒู</div>
                <div class="stat-cut bg-rose-50 p-4">ุฅุฏุงุฑุฉ ุงูููุงุฑุฏ ุงูุจุดุฑูุฉ</div>
                <div class="stat-rounded bg-sky-50 p-4">ุงูุนููุงุก</div>
                <div class="stat-angled bg-emerald-50 p-4">ุงูุดูุงุฏุงุช</div>
            </div>
        </div>

        <!-- Tables -->
        <div class="card-glass rounded-3xl shadow-2xl p-6 mb-8 section-accent-emerald">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-xl font-bold text-slate-800">๐งพ ุฌุฏูู ุงูููุงุชูุฑ</h3>
                <span id="invoicesCount" class="text-sm text-slate-500"></span>
            </div>
            <div class="table-scroll">
                <table class="w-full text-xs">
                    <thead class="bg-emerald-50 text-emerald-700">
                        <tr>
                            <th class="px-3 py-2 text-right">ุฑูู ุงููุงุชูุฑุฉ</th>
                            <th class="px-3 py-2 text-right">ุงูุนููู</th>
                            <th class="px-3 py-2 text-right">ุงููุจูุบ</th>
                            <th class="px-3 py-2 text-right">ุงูุญุงูุฉ</th>
                            <th class="px-3 py-2 text-right">ุชุงุฑูุฎ ุงูุงุณุชุญูุงู</th>
                            <th class="px-3 py-2 text-right">ุงูููุดุฃุฉ</th>
                            <th class="px-3 py-2 text-right">ุชุงุฑูุฎ ุงูุฅูุดุงุก</th>
                        </tr>
                    </thead>
                    <tbody id="invoicesTable" class="divide-y divide-slate-100">
                        <tr>
                            <td colspan="7" class="px-4 py-12 text-center text-slate-500">ุฌุงุฑู ุชุญููู ุงูุจูุงูุงุช...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="card-glass rounded-3xl shadow-2xl p-6 mb-8 section-accent-violet">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-xl font-bold text-slate-800">๐ณ ุฌุฏูู ุงููุฏููุนุงุช</h3>
                <span id="paymentsCount" class="text-sm text-slate-500"></span>
            </div>
            <div class="table-scroll">
                <table class="w-full text-xs">
                    <thead class="bg-violet-50 text-violet-700">
                        <tr>
                            <th class="px-3 py-2 text-right">ุฑูู ุงูุฏูุน</th>
                            <th class="px-3 py-2 text-right">ุงูุนููู</th>
                            <th class="px-3 py-2 text-right">ุงููุจูุบ</th>
                            <th class="px-3 py-2 text-right">ุทุฑููุฉ ุงูุฏูุน</th>
                            <th class="px-3 py-2 text-right">ุชุงุฑูุฎ ุงูุฏูุน</th>
                            <th class="px-3 py-2 text-right">ุงูููุดุฃุฉ</th>
                        </tr>
                    </thead>
                    <tbody id="paymentsTable" class="divide-y divide-slate-100">
                        <tr>
                            <td colspan="6" class="px-4 py-12 text-center text-slate-500">ุฌุงุฑู ุชุญููู ุงูุจูุงูุงุช...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="card-glass rounded-3xl shadow-2xl p-6 mb-8 section-accent-amber">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-xl font-bold text-slate-800">๐ฅ ุฌุฏูู ุงูุนููุงุก</h3>
                <span id="customersCount" class="text-sm text-slate-500"></span>
            </div>
            <div class="table-scroll">
                <table class="w-full text-xs">
                    <thead class="bg-amber-50 text-amber-700">
                        <tr>
                            <th class="px-3 py-2 text-right">ุฑูู ุงูุนููู</th>
                            <th class="px-3 py-2 text-right">ุงูุงุณู</th>
                            <th class="px-3 py-2 text-right">ุงูุฌูุงู</th>
                            <th class="px-3 py-2 text-right">ุงูุจุฑูุฏ</th>
                            <th class="px-3 py-2 text-right">ุงูุฑุตูุฏ</th>
                            <th class="px-3 py-2 text-right">ุงูููุดุฃุฉ</th>
                        </tr>
                    </thead>
                    <tbody id="customersTable" class="divide-y divide-slate-100">
                        <tr>
                            <td colspan="6" class="px-4 py-12 text-center text-slate-500">ุฌุงุฑู ุชุญููู ุงูุจูุงูุงุช...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="card-glass rounded-3xl shadow-2xl p-6 section-accent-rose">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-xl font-bold text-slate-800">๐จ ุฌุฏูู ุทูุจุงุช ุงูููุธููู</h3>
                <span id="requestsCount" class="text-sm text-slate-500"></span>
            </div>
            <div class="table-scroll">
                <table class="w-full text-xs">
                    <thead class="bg-rose-50 text-rose-700">
                        <tr>
                            <th class="px-3 py-2 text-right">ุฑูู ุงูุทูุจ</th>
                            <th class="px-3 py-2 text-right">ุงูููุธู</th>
                            <th class="px-3 py-2 text-right">ููุน ุงูุทูุจ</th>
                            <th class="px-3 py-2 text-right">ุงูุนููุงู</th>
                            <th class="px-3 py-2 text-right">ุงูุญุงูุฉ</th>
                            <th class="px-3 py-2 text-right">ุชุงุฑูุฎ ุงูุทูุจ</th>
                        </tr>
                    </thead>
                    <tbody id="requestsTable" class="divide-y divide-slate-100">
                        <tr>
                            <td colspan="6" class="px-4 py-12 text-center text-slate-500">ุฌุงุฑู ุชุญููู ุงูุจูุงูุงุช...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = window.location.origin;

        let invoices = [];
        let payments = [];
        let customers = [];
        let requests = [];

        async function loadData() {
            try {
                const [invoicesRes, paymentsRes, customersRes, requestsRes] = await Promise.all([
                    fetch(`${API_BASE}/finance/invoices`),
                    fetch(`${API_BASE}/finance/payments`),
                    fetch(`${API_BASE}/finance/customers`),
                    fetch(`${API_BASE}/api/employee-requests`)
                ]);

                const [invoicesData, paymentsData, customersData, requestsData] = await Promise.all([
                    invoicesRes.json(),
                    paymentsRes.json(),
                    customersRes.json(),
                    requestsRes.json()
                ]);

                invoices = invoicesData.invoices || [];
                payments = paymentsData.payments || [];
                customers = customersData.customers || customersData.rows || [];
                requests = Array.isArray(requestsData) ? requestsData : [];

                renderStats();
                renderTables();
            } catch (error) {
                console.error('ุฎุทุฃ ูู ุชุญููู ุงูุจูุงูุงุช:', error);
                renderStats();
                renderTables();
            }
        }

        function renderStats() {
            document.getElementById('invoicesTotal').textContent = invoices.length;
            document.getElementById('paymentsTotal').textContent = payments.length;
            document.getElementById('customersTotal').textContent = customers.length;
            document.getElementById('requestsTotal').textContent = requests.length;
        }

        function renderTables() {
            const invoiceRows = invoices.map(i => `
                <tr class="hover:bg-emerald-50">
                    <td class="px-3 py-2">${sanitizeText(i.invoice_id || i.id)}</td>
                    <td class="px-3 py-2">${sanitizeText(i.customer_name || i.customer_id)}</td>
                    <td class="px-3 py-2">${formatMoney(i.total_amount || i.amount)}</td>
                    <td class="px-3 py-2">${translateStatus(i.status)}</td>
                    <td class="px-3 py-2">${formatDate(i.due_date)}</td>
                    <td class="px-3 py-2">${sanitizeText(i.entity_id)}</td>
                    <td class="px-3 py-2">${formatDateTime(i.created_at)}</td>
                </tr>
            `).join('');
            document.getElementById('invoicesTable').innerHTML = invoiceRows || `<tr><td colspan="7" class="px-4 py-12 text-center text-slate-500">ูุง ุชูุฌุฏ ุจูุงูุงุช</td></tr>`;
            document.getElementById('invoicesCount').textContent = `ุนุฏุฏ ุงูุตููู: ${invoices.length}`;

            const paymentRows = payments.map(p => `
                <tr class="hover:bg-violet-50">
                    <td class="px-3 py-2">${sanitizeText(p.payment_id || p.id)}</td>
                    <td class="px-3 py-2">${sanitizeText(p.customer_name || p.customer_id)}</td>
                    <td class="px-3 py-2">${formatMoney(p.payment_amount || p.amount)}</td>
                    <td class="px-3 py-2">${translatePaymentMethod(p.payment_method)}</td>
                    <td class="px-3 py-2">${formatDate(p.payment_date)}</td>
                    <td class="px-3 py-2">${sanitizeText(p.entity_id)}</td>
                </tr>
            `).join('');
            document.getElementById('paymentsTable').innerHTML = paymentRows || `<tr><td colspan="6" class="px-4 py-12 text-center text-slate-500">ูุง ุชูุฌุฏ ุจูุงูุงุช</td></tr>`;
            document.getElementById('paymentsCount').textContent = `ุนุฏุฏ ุงูุตููู: ${payments.length}`;

            const customerRows = customers.map(c => `
                <tr class="hover:bg-amber-50">
                    <td class="px-3 py-2">${sanitizeText(c.customer_id || c.id)}</td>
                    <td class="px-3 py-2">${sanitizeText(c.customer_name || c.full_name || c.name)}</td>
                    <td class="px-3 py-2">${sanitizeText(c.phone || c.mobile)}</td>
                    <td class="px-3 py-2">${sanitizeText(c.email)}</td>
                    <td class="px-3 py-2">${formatMoney(c.balance || c.current_balance || 0)}</td>
                    <td class="px-3 py-2">${sanitizeText(c.entity_id)}</td>
                </tr>
            `).join('');
            document.getElementById('customersTable').innerHTML = customerRows || `<tr><td colspan="6" class="px-4 py-12 text-center text-slate-500">ูุง ุชูุฌุฏ ุจูุงูุงุช</td></tr>`;
            document.getElementById('customersCount').textContent = `ุนุฏุฏ ุงูุตููู: ${customers.length}`;

            const requestRows = requests.map(r => `
                <tr class="hover:bg-rose-50">
                    <td class="px-3 py-2">${sanitizeText(r.id)}</td>
                    <td class="px-3 py-2">${sanitizeText(r.employee_name || r.employee_id)}</td>
                    <td class="px-3 py-2">${sanitizeText(r.request_type)}</td>
                    <td class="px-3 py-2">${sanitizeText(r.request_title)}</td>
                    <td class="px-3 py-2">${translateStatus(r.status)}</td>
                    <td class="px-3 py-2">${formatDate(r.requested_date)}</td>
                </tr>
            `).join('');
            document.getElementById('requestsTable').innerHTML = requestRows || `<tr><td colspan="6" class="px-4 py-12 text-center text-slate-500">ูุง ุชูุฌุฏ ุจูุงูุงุช</td></tr>`;
            document.getElementById('requestsCount').textContent = `ุนุฏุฏ ุงูุตููู: ${requests.length}`;
        }

        function translateStatus(value) {
            const map = {
                PENDING: 'ููุฏ ุงููุนุงูุฌุฉ',
                APPROVED: 'ูุนุชูุฏ',
                REJECTED: 'ูุฑููุถ',
                COMPLETED: 'ููุชูู',
                OVERDUE: 'ูุชุฃุฎุฑ'
            };
            return map[String(value || '').toUpperCase()] || sanitizeText(value) || 'ุบูุฑ ูุญุฏุฏ';
        }

        function translatePaymentMethod(value) {
            const map = {
                CASH: 'ููุฏู',
                BANK: 'ุชุญููู ุจููู',
                CARD: 'ุจุทุงูุฉ',
                TRANSFER: 'ุชุญููู',
                ONLINE: 'ุฏูุน ุฅููุชุฑููู'
            };
            return map[String(value || '').toUpperCase()] || sanitizeText(value) || 'ุบูุฑ ูุญุฏุฏ';
        }

        function formatMoney(value) {
            const num = parseFloat(value || 0);
            return num.toLocaleString('ar-SA') + ' ุฑ.ุณ';
        }

        function formatDate(value) {
            if (!value) return '-';
            return new Date(value).toLocaleDateString('ar-SA');
        }

        function formatDateTime(value) {
            if (!value) return '-';
            return new Date(value).toLocaleString('ar-SA');
        }

        function sanitizeText(value) {
            if (value === null || value === undefined) return '-';
            const text = typeof value === 'string' ? value : JSON.stringify(value);
            const cleaned = text.replace(/[A-Za-z]+/g, '').replace(/\s{2,}/g, ' ').trim();
            return cleaned || '-';
        }

        function downloadAllJSON() {
            const payload = { invoices, payments, customers, employee_requests: requests };
            downloadBlob(JSON.stringify(payload, null, 2), 'ููุธููุฉ-ุงููุจูุนุงุช-ูุงูุญุณุงุจุงุช.json', 'application/json');
        }

        function downloadAllCSV() {
            const rows = [];
            rows.push(['ุงูููุงุชูุฑ']);
            rows.push(['ุฑูู ุงููุงุชูุฑุฉ','ุงูุนููู','ุงููุจูุบ','ุงูุญุงูุฉ','ุชุงุฑูุฎ ุงูุงุณุชุญูุงู','ุงูููุดุฃุฉ','ุชุงุฑูุฎ ุงูุฅูุดุงุก']);
            invoices.forEach(i => rows.push([
                i.invoice_id || i.id,
                sanitizeText(i.customer_name || i.customer_id),
                i.total_amount || i.amount,
                translateStatus(i.status),
                i.due_date,
                i.entity_id,
                i.created_at
            ]));

            rows.push([]);
            rows.push(['ุงููุฏููุนุงุช']);
            rows.push(['ุฑูู ุงูุฏูุน','ุงูุนููู','ุงููุจูุบ','ุทุฑููุฉ ุงูุฏูุน','ุชุงุฑูุฎ ุงูุฏูุน','ุงูููุดุฃุฉ']);
            payments.forEach(p => rows.push([
                p.payment_id || p.id,
                sanitizeText(p.customer_name || p.customer_id),
                p.payment_amount || p.amount,
                translatePaymentMethod(p.payment_method),
                p.payment_date,
                p.entity_id
            ]));

            rows.push([]);
            rows.push(['ุงูุนููุงุก']);
            rows.push(['ุฑูู ุงูุนููู','ุงูุงุณู','ุงูุฌูุงู','ุงูุจุฑูุฏ','ุงูุฑุตูุฏ','ุงูููุดุฃุฉ']);
            customers.forEach(c => rows.push([
                c.customer_id || c.id,
                sanitizeText(c.customer_name || c.full_name || c.name),
                sanitizeText(c.phone || c.mobile),
                sanitizeText(c.email),
                c.balance || c.current_balance || 0,
                c.entity_id
            ]));

            rows.push([]);
            rows.push(['ุทูุจุงุช ุงูููุธููู']);
            rows.push(['ุฑูู ุงูุทูุจ','ุงูููุธู','ููุน ุงูุทูุจ','ุงูุนููุงู','ุงูุญุงูุฉ','ุชุงุฑูุฎ ุงูุทูุจ']);
            requests.forEach(r => rows.push([
                r.id,
                sanitizeText(r.employee_name || r.employee_id),
                sanitizeText(r.request_type),
                sanitizeText(r.request_title),
                translateStatus(r.status),
                r.requested_date
            ]));

            const csvContent = rows.map(r => r.map(v => `"${v ?? ''}"`).join(',')).join('\n');
            downloadBlob(csvContent, 'ููุธููุฉ-ุงููุจูุนุงุช-ูุงูุญุณุงุจุงุช.csv', 'text/csv;charset=utf-8;');
        }

        function downloadBlob(content, filename, type) {
            const blob = new Blob([content], { type });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            link.click();
            URL.revokeObjectURL(url);
        }

        function printReport() {
            window.print();
        }

        function refreshData() {
            loadData();
        }

        document.addEventListener('DOMContentLoaded', loadData);
    </script>
</body>
</html>
