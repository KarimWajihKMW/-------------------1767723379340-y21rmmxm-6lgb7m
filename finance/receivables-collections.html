<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>๐ณ ุงูุฐูู ูุงูุชุญุตูู + ุงูููุงุชูุฑ ูุฎุทุท ุงูุฏูุน - ูุธุงู ูุงููุด</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        html, body {
            height: 100%;
        }
        body {
            font-family: 'Cairo', sans-serif;
            background: #f9fafb; /* Slate-50 */
            min-height: 100vh;
            overflow-y: auto;
        }
        .card-gradient {
            background: #f9fafb; /* Slate-50 */
            backdrop-filter: blur(10px);
        }
        .stat-card {
            transition: transform 0.3s, box-shadow 0.3s;
        }
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
        }
        .chart-container {
            position: relative;
            height: 280px;
        }
        .table-scroll {
            max-height: 520px;
            overflow: auto;
        }
        .section-accent-sky { border-top: 4px solid #0ea5e9; }
        .section-accent-emerald { border-top: 4px solid #10b981; }
        .section-accent-amber { border-top: 4px solid #f59e0b; }
        .section-accent-violet { border-top: 4px solid #8b5cf6; }
        .section-accent-indigo { border-top: 4px solid #6366f1; }
        .json-pill {
            max-width: 260px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
    </style>
</head>
<body>
    <div class="container mx-auto px-4 py-8">
        <div class="mb-8 bg-slate-900 text-white rounded-2xl p-6 shadow-lg">
            <h1 class="text-4xl font-bold mb-2">๐ณ ุงูุฐูู ูุงูุชุญุตูู ูุงูููุงุชูุฑ ูุฎุทุท ุงูุฏูุน</h1>
            <p class="text-lg opacity-90">ููุทูุฉ ุงูุฐูู ูุงูุชุญุตูู ูููุทูุฉ ุงูููุงุชูุฑ ูุฎุทุท ุงูุฏูุน (ุงูุตูุญุฉ 26)</p>
        </div>

        <div class="mb-6 flex gap-3 flex-wrap">
            <button onclick="downloadCSV()" class="bg-white text-gray-800 px-6 py-3 rounded-xl font-bold shadow-sm hover:shadow-md hover:bg-gray-50 transition flex items-center gap-3 border border-gray-200 hover:border-blue-500 group">
                <i class="fas fa-file-csv text-xl text-blue-600 group-hover:text-blue-700 transition"></i>
                ุชูุฒูู ููู ุงูุฌุฏูู
            </button>
            <button onclick="downloadJSON()" class="bg-white text-gray-800 px-6 py-3 rounded-xl font-bold shadow-sm hover:shadow-md hover:bg-gray-50 transition flex items-center gap-3 border border-gray-200 hover:border-purple-500 group">
                <i class="fas fa-file-code text-xl text-purple-600 group-hover:text-purple-700 transition"></i>
                ุชูุฒูู ููู ุงูุจูุงูุงุช
            </button>
            <button onclick="printReport()" class="bg-purple-600 text-white px-6 py-3 rounded-lg font-bold hover:shadow-lg transition flex items-center gap-2">
                <i class="fas fa-print"></i>
                ุทุจุงุนุฉ
            </button>
            <button onclick="refreshData()" class="bg-emerald-600 text-white px-6 py-3 rounded-lg font-bold hover:shadow-lg transition flex items-center gap-2">
                <i class="fas fa-rotate"></i>
                ุชุญุฏูุซ ุงูุจูุงูุงุช
            </button>
        </div>

        <!-- Receivables Zone KPIs -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div class="stat-card bg-gradient-to-br from-sky-500 to-blue-600 rounded-2xl p-6 text-white shadow-xl">
                <div class="flex items-center justify-between mb-4">
                    <i class="fas fa-file-invoice-dollar text-4xl opacity-70"></i>
                    <span class="text-sm opacity-90">ุฅุฌูุงูู ุงูุฐูู</span>
                </div>
                <div id="totalAR" class="text-4xl font-bold"><div class="animate-pulse">ุฌุงุฑู ุงูุชุญููู...</div></div>
            </div>
            <div class="stat-card bg-gradient-to-br from-indigo-500 to-violet-600 rounded-2xl p-6 text-white shadow-xl">
                <div class="flex items-center justify-between mb-4">
                    <i class="fas fa-file-invoice text-4xl opacity-70"></i>
                    <span class="text-sm opacity-90">ุนุฏุฏ ุงูููุงุชูุฑ ุงูููุชูุญุฉ</span>
                </div>
                <div id="openInvoices" class="text-4xl font-bold"><div class="animate-pulse">ุฌุงุฑู ุงูุชุญููู...</div></div>
            </div>
            <div class="stat-card bg-gradient-to-br from-emerald-500 to-teal-600 rounded-2xl p-6 text-white shadow-xl">
                <div class="flex items-center justify-between mb-4">
                    <i class="fas fa-sack-dollar text-4xl opacity-70"></i>
                    <span class="text-sm opacity-90">ุชุญุตูู ุงูููู</span>
                </div>
                <div id="dailyCollections" class="text-4xl font-bold"><div class="animate-pulse">ุฌุงุฑู ุงูุชุญููู...</div></div>
            </div>
            <div class="stat-card bg-gradient-to-br from-amber-500 to-orange-600 rounded-2xl p-6 text-white shadow-xl">
                <div class="flex items-center justify-between mb-4">
                    <i class="fas fa-calendar-week text-4xl opacity-70"></i>
                    <span class="text-sm opacity-90">ุชุญุตูู ุงูุฃุณุจูุน</span>
                </div>
                <div id="weeklyCollections" class="text-4xl font-bold"><div class="animate-pulse">ุฌุงุฑู ุงูุชุญููู...</div></div>
            </div>
        </div>

        <!-- Filters -->
        <div class="card-gradient rounded-2xl shadow-2xl p-6 mb-8 section-accent-sky">
            <div class="flex flex-wrap items-center justify-between mb-4 gap-3">
                <h3 class="text-lg font-bold text-gray-800">๐ ููุงุชุฑ ุงูุฐูู ูุงูููุงุชูุฑ</h3>
                <button onclick="resetFilters()" class="text-sm text-sky-700 hover:text-sky-900 font-semibold">ุฅุนุงุฏุฉ ุถุจุท ุงูููุงุชุฑ</button>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-2">ุฑูู ุงููุงุชูุฑุฉ</label>
                    <input id="invoiceNumber" type="text" placeholder="ูุงุชูุฑุฉ-0001" class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-sky-500 outline-none" oninput="applyFilters()">
                </div>
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-2">ุงุณู ุงูุนููู</label>
                    <input id="customerName" type="text" placeholder="ุงุณู ุงูุนููู" class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-sky-500 outline-none" oninput="applyFilters()">
                </div>
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-2">ููุฏ ุงูุนููู</label>
                    <input id="customerCode" type="text" placeholder="ุนููู-0001" class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-sky-500 outline-none" oninput="applyFilters()">
                </div>
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-2">ุญุงูุฉ ุงููุงุชูุฑุฉ</label>
                    <input id="invoiceStatus" type="text" placeholder="ูุชุฃุฎุฑุฉ / ูุตุฏุฑุฉ" class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-sky-500 outline-none" oninput="applyFilters()">
                </div>
            </div>
        </div>

        <!-- Charts -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
            <div class="card-gradient rounded-2xl shadow-2xl p-6 section-accent-emerald">
                <h3 class="text-xl font-bold text-gray-800 mb-4">๐ ุงูุฐูู ุญุณุจ ุงูุนูุฑ</h3>
                <div class="chart-container">
                    <canvas id="agingChart"></canvas>
                </div>
            </div>
            <div class="card-gradient rounded-2xl shadow-2xl p-6 section-accent-amber">
                <h3 class="text-xl font-bold text-gray-800 mb-4">๐ณ ุงูุชุญุตูู ุญุณุจ ุงููููุงุช</h3>
                <div class="chart-container">
                    <canvas id="collectionMethodChart"></canvas>
                </div>
            </div>
            <div class="card-gradient rounded-2xl shadow-2xl p-6 section-accent-violet">
                <h3 class="text-xl font-bold text-gray-800 mb-4">๐ข ุงูุชุญุตูู ุญุณุจ ุงููุฑูุน</h3>
                <div class="chart-container">
                    <canvas id="collectionBranchChart"></canvas>
                </div>
            </div>
        </div>

        <!-- AI Insights -->
        <div class="card-gradient rounded-2xl shadow-2xl p-6 mb-8 section-accent-indigo">
            <h3 class="text-xl font-bold text-gray-800 mb-4">๐ค ููุฎุต ุงูุฐูุงุก ุงูุงุตุทูุงุนู</h3>
            <div id="aiInsights" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="animate-pulse text-gray-500">ุฌุงุฑู ุงูุชุญููู...</div>
            </div>
        </div>

        <!-- Invoices & Plans KPIs -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-6 mb-8">
            <div class="stat-card bg-gradient-to-br from-rose-500 to-red-600 rounded-2xl p-6 text-white shadow-xl">
                <div class="flex items-center justify-between mb-4">
                    <i class="fas fa-file-invoice text-4xl opacity-70"></i>
                    <span class="text-sm opacity-90">ุงูููุงุชูุฑ ุงููุชุฃุฎุฑุฉ</span>
                </div>
                <div id="overdueInvoices" class="text-4xl font-bold"><div class="animate-pulse">ุฌุงุฑู ุงูุชุญููู...</div></div>
            </div>
            <div class="stat-card bg-gradient-to-br from-emerald-500 to-teal-600 rounded-2xl p-6 text-white shadow-xl">
                <div class="flex items-center justify-between mb-4">
                    <i class="fas fa-check-double text-4xl opacity-70"></i>
                    <span class="text-sm opacity-90">ุงูููุงุชูุฑ ุงููุฏููุนุฉ</span>
                </div>
                <div id="paidInvoices" class="text-4xl font-bold"><div class="animate-pulse">ุฌุงุฑู ุงูุชุญููู...</div></div>
            </div>
            <div class="stat-card bg-gradient-to-br from-indigo-500 to-purple-600 rounded-2xl p-6 text-white shadow-xl">
                <div class="flex items-center justify-between mb-4">
                    <i class="fas fa-chart-line text-4xl opacity-70"></i>
                    <span class="text-sm opacity-90">ูุชูุณุท ูููุฉ ุงููุงุชูุฑุฉ</span>
                </div>
                <div id="avgInvoiceValue" class="text-4xl font-bold"><div class="animate-pulse">ุฌุงุฑู ุงูุชุญููู...</div></div>
            </div>
            <div class="stat-card bg-gradient-to-br from-sky-500 to-cyan-600 rounded-2xl p-6 text-white shadow-xl">
                <div class="flex items-center justify-between mb-4">
                    <i class="fas fa-calendar-day text-4xl opacity-70"></i>
                    <span class="text-sm opacity-90">ูุชูุณุท ูุฏุฉ ุงูุณุฏุงุฏ</span>
                </div>
                <div id="avgTerms" class="text-4xl font-bold"><div class="animate-pulse">ุฌุงุฑู ุงูุชุญููู...</div></div>
            </div>
            <div class="stat-card bg-gradient-to-br from-amber-500 to-orange-600 rounded-2xl p-6 text-white shadow-xl">
                <div class="flex items-center justify-between mb-4">
                    <i class="fas fa-handshake text-4xl opacity-70"></i>
                    <span class="text-sm opacity-90">ูุณุจุฉ ุงูุงูุชุฒุงู ุจุงูุฎุทุท</span>
                </div>
                <div id="planCompliance" class="text-4xl font-bold"><div class="animate-pulse">ุฌุงุฑู ุงูุชุญููู...</div></div>
            </div>
        </div>

        <!-- Top Lists -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
            <div class="card-gradient rounded-2xl shadow-2xl p-6 section-accent-emerald">
                <h3 class="text-xl font-bold text-gray-800 mb-4">๐ ุงูุนููุงุก ุงูุฃูุซุฑ ุงูุชุฒุงููุง</h3>
                <div id="topCommitted" class="space-y-3">
                    <div class="animate-pulse text-gray-500">ุฌุงุฑู ุงูุชุญููู...</div>
                </div>
            </div>
            <div class="card-gradient rounded-2xl shadow-2xl p-6 section-accent-amber">
                <h3 class="text-xl font-bold text-gray-800 mb-4">โ๏ธ ุงูุนููุงุก ุงูุฃูุซุฑ ุชุนุซุฑูุง</h3>
                <div id="topDelinquent" class="space-y-3">
                    <div class="animate-pulse text-gray-500">ุฌุงุฑู ุงูุชุญููู...</div>
                </div>
            </div>
        </div>

        <!-- AR Aging Table -->
        <div class="card-gradient rounded-2xl shadow-2xl overflow-hidden mb-8 section-accent-sky">
            <div class="p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-xl font-bold text-gray-800">๐ ุฌุฏูู ุฃุนูุงุฑ ุงูุฐูู</h3>
                    <div class="flex items-center gap-3">
                        <span id="agingCount" class="text-sm text-gray-600"></span>
                        <button onclick="openAddAgingInvoice()" class="bg-slate-900 text-white px-4 py-2 rounded-lg text-sm font-bold hover:bg-slate-800 transition flex items-center gap-2">
                            <i class="fas fa-plus"></i>
                            ุฅุถุงูุฉ ูุงุชูุฑุฉ ุฐูู
                        </button>
                    </div>
                </div>
                <div class="table-scroll">
                    <table class="w-full">
                        <thead class="bg-slate-50 text-slate-700 text-xs">
                            <tr>
                                <th class="px-3 py-2 text-right">ูุนุฑูู ุงููุงุชูุฑุฉ</th>
                                <th class="px-3 py-2 text-right">ุฑูู ุงููุงุชูุฑุฉ</th>
                                <th class="px-3 py-2 text-right">ุชุงุฑูุฎ ุงููุงุชูุฑุฉ</th>
                                <th class="px-3 py-2 text-right">ุชุงุฑูุฎ ุงูุงุณุชุญูุงู</th>
                                <th class="px-3 py-2 text-right">ุฑูู ุงูุนููู</th>
                                <th class="px-3 py-2 text-right">ููุฏ ุงูุนููู</th>
                                <th class="px-3 py-2 text-right">ุงุณู ุงูุนููู (ุนุฑุจู)</th>
                                <th class="px-3 py-2 text-right">ุงุณู ุงูุนููู (ุฅูุฌููุฒู)</th>
                                <th class="px-3 py-2 text-right">ููุน ุงูุนููู</th>
                                <th class="px-3 py-2 text-right">ุฅุฌูุงูู ุงููุงุชูุฑุฉ</th>
                                <th class="px-3 py-2 text-right">ุงููุฏููุน</th>
                                <th class="px-3 py-2 text-right">ุงููุชุจูู</th>
                                <th class="px-3 py-2 text-right">ุญุงูุฉ ุงููุงุชูุฑุฉ</th>
                                <th class="px-3 py-2 text-right">ุญุงูุฉ ุงูุณุฏุงุฏ</th>
                                <th class="px-3 py-2 text-right">ุฃูุงู ุงูุชุฃุฎูุฑ</th>
                                <th class="px-3 py-2 text-right">ูุฆุฉ ุงูุนูุฑ</th>
                                <th class="px-3 py-2 text-right">ููุน ุงูููุงู</th>
                                <th class="px-3 py-2 text-right">ูุนุฑูู ุงูููุงู</th>
                                <th class="px-3 py-2 text-right">ุงููุฑุน</th>
                                <th class="px-3 py-2 text-right">ุงูุญุงุถูุฉ</th>
                                <th class="px-3 py-2 text-right">ุฅุฌุฑุงุกุงุช</th>
                            </tr>
                        </thead>
                        <tbody id="agingTable" class="text-xs divide-y divide-gray-100">
                            <tr>
                                <td colspan="21" class="px-4 py-12 text-center text-gray-500">
                                    <i class="fas fa-spinner fa-spin text-4xl mb-3 opacity-30"></i>
                                    <div>ุฌุงุฑู ุชุญููู ุงูุจูุงูุงุช...</div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Invoices Table -->
        <div class="card-gradient rounded-2xl shadow-2xl overflow-hidden mb-8 section-accent-indigo">
            <div class="p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-xl font-bold text-gray-800">๐งพ ุฌุฏูู ุงูููุงุชูุฑ</h3>
                    <div class="flex items-center gap-3">
                        <span id="invoicesCount" class="text-sm text-gray-600"></span>
                        <button onclick="openAddInvoice()" class="bg-indigo-600 text-white px-4 py-2 rounded-lg text-sm font-bold hover:bg-indigo-700 transition flex items-center gap-2">
                            <i class="fas fa-plus"></i>
                            ุฅุถุงูุฉ ูุงุชูุฑุฉ
                        </button>
                    </div>
                </div>
                <div class="table-scroll">
                    <table class="w-full">
                        <thead class="bg-indigo-50 text-indigo-700 text-xs">
                            <tr>
                                <th class="px-3 py-2 text-right">ูุนุฑูู ุงููุงุชูุฑุฉ</th>
                                <th class="px-3 py-2 text-right">ุฑูู ุงููุงุชูุฑุฉ</th>
                                <th class="px-3 py-2 text-right">ุชุงุฑูุฎ ุงููุงุชูุฑุฉ</th>
                                <th class="px-3 py-2 text-right">ุชุงุฑูุฎ ุงูุงุณุชุญูุงู</th>
                                <th class="px-3 py-2 text-right">ุฑูู ุงูุนููู</th>
                                <th class="px-3 py-2 text-right">ุงุณู ุงูุนููู</th>
                                <th class="px-3 py-2 text-right">ุงุณู ุงูุนููู (ุนุฑุจู)</th>
                                <th class="px-3 py-2 text-right">ููุฏ ุงูุนููู</th>
                                <th class="px-3 py-2 text-right">ูุณุชูู ุงููุฎุงุทุฑ</th>
                                <th class="px-3 py-2 text-right">ุงูุฅุฌูุงูู ูุจู ุงูุถุฑูุจุฉ</th>
                                <th class="px-3 py-2 text-right">ุงูุถุฑูุจุฉ</th>
                                <th class="px-3 py-2 text-right">ุงูุฎุตู</th>
                                <th class="px-3 py-2 text-right">ุฅุฌูุงูู ุงููุงุชูุฑุฉ</th>
                                <th class="px-3 py-2 text-right">ุงููุฏููุน</th>
                                <th class="px-3 py-2 text-right">ุงููุชุจูู</th>
                                <th class="px-3 py-2 text-right">ุญุงูุฉ ุงููุงุชูุฑุฉ</th>
                                <th class="px-3 py-2 text-right">ุญุงูุฉ ุงูุณุฏุงุฏ</th>
                                <th class="px-3 py-2 text-right">ูุณูุญ ุจุณุฏุงุฏ ุฌุฒุฆู</th>
                                <th class="px-3 py-2 text-right">ูุณูุญ ุจุงูุชูุณูุท</th>
                                <th class="px-3 py-2 text-right">ุงูุจุฑูุงูุฌ</th>
                                <th class="px-3 py-2 text-right">ุงูุฎุฏูุฉ</th>
                                <th class="px-3 py-2 text-right">ููุน ุงูููุงู</th>
                                <th class="px-3 py-2 text-right">ูุนุฑูู ุงูููุงู</th>
                                <th class="px-3 py-2 text-right">ุงููุฑุน</th>
                                <th class="px-3 py-2 text-right">ุงูุญุงุถูุฉ</th>
                                <th class="px-3 py-2 text-right">ุงูููุตุฉ</th>
                                <th class="px-3 py-2 text-right">ุงูููุชุจ</th>
                                <th class="px-3 py-2 text-right">ููุฏ ุงูููููุฉ</th>
                                <th class="px-3 py-2 text-right">ููุงุญุธุงุช</th>
                                <th class="px-3 py-2 text-right">ุดุฑูุท ูุฃุญูุงู</th>
                                <th class="px-3 py-2 text-right">ุชุงุฑูุฎ ุงูุฅูุดุงุก</th>
                                <th class="px-3 py-2 text-right">ุขุฎุฑ ุชุญุฏูุซ</th>
                                <th class="px-3 py-2 text-right">ููุดุฃ ุจูุงุณุทุฉ</th>
                                <th class="px-3 py-2 text-right">ูุญุฏูุซ ุจูุงุณุทุฉ</th>
                                <th class="px-3 py-2 text-right">ููุบู ุจูุงุณุทุฉ</th>
                                <th class="px-3 py-2 text-right">ุชุงุฑูุฎ ุงูุฅูุบุงุก</th>
                                <th class="px-3 py-2 text-right">ุณุจุจ ุงูุฅูุบุงุก</th>
                                <th class="px-3 py-2 text-right">ุฅุฌุฑุงุกุงุช</th>
                            </tr>
                        </thead>
                        <tbody id="invoicesTable" class="text-xs divide-y divide-gray-100">
                            <tr>
                                <td colspan="38" class="px-4 py-12 text-center text-gray-500">
                                    <i class="fas fa-spinner fa-spin text-4xl mb-3 opacity-30"></i>
                                    <div>ุฌุงุฑู ุชุญููู ุงูุจูุงูุงุช...</div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Payments Table -->
        <div class="card-gradient rounded-2xl shadow-2xl overflow-hidden mb-8 section-accent-emerald">
            <div class="p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-xl font-bold text-gray-800">๐ต ุฌุฏูู ุงูุชุญุตูู (ุงููุฏููุนุงุช)</h3>
                    <div class="flex items-center gap-3">
                        <span id="paymentsCount" class="text-sm text-gray-600"></span>
                        <button onclick="openAddPayment()" class="bg-emerald-600 text-white px-4 py-2 rounded-lg text-sm font-bold hover:bg-emerald-700 transition flex items-center gap-2">
                            <i class="fas fa-plus"></i>
                            ุฅุถุงูุฉ ูุฏููุนุฉ
                        </button>
                    </div>
                </div>
                <div class="table-scroll">
                    <table class="w-full">
                        <thead class="bg-emerald-50 text-emerald-700 text-xs">
                            <tr>
                                <th class="px-3 py-2 text-right">ูุนุฑูู ุงููุฏููุนุฉ</th>
                                <th class="px-3 py-2 text-right">ุฑูู ุงููุฏููุนุฉ</th>
                                <th class="px-3 py-2 text-right">ุชุงุฑูุฎ ุงูุณุฏุงุฏ</th>
                                <th class="px-3 py-2 text-right">ุฑูู ุงูุนููู</th>
                                <th class="px-3 py-2 text-right">ุงุณู ุงูุนููู</th>
                                <th class="px-3 py-2 text-right">ุงุณู ุงูุนููู (ุนุฑุจู)</th>
                                <th class="px-3 py-2 text-right">ููุฏ ุงูุนููู</th>
                                <th class="px-3 py-2 text-right">ูุจูุบ ุงูุณุฏุงุฏ</th>
                                <th class="px-3 py-2 text-right">ุทุฑููุฉ ุงูุณุฏุงุฏ</th>
                                <th class="px-3 py-2 text-right">ููุน ุงูุณุฏุงุฏ</th>
                                <th class="px-3 py-2 text-right">ุงูุจูู</th>
                                <th class="px-3 py-2 text-right">ุฑูู ุงูุดูู</th>
                                <th class="px-3 py-2 text-right">ูุฑุฌุน ุงูุนูููุฉ</th>
                                <th class="px-3 py-2 text-right">ุงูุญุงูุฉ</th>
                                <th class="px-3 py-2 text-right">ููุน ุงูููุงู</th>
                                <th class="px-3 py-2 text-right">ูุนุฑูู ุงูููุงู</th>
                                <th class="px-3 py-2 text-right">ุงููุฑุน</th>
                                <th class="px-3 py-2 text-right">ุงูุญุงุถูุฉ</th>
                                <th class="px-3 py-2 text-right">ุงูููุตุฉ</th>
                                <th class="px-3 py-2 text-right">ููุฏ ุงูููููุฉ</th>
                                <th class="px-3 py-2 text-right">ููุงุญุธุงุช</th>
                                <th class="px-3 py-2 text-right">ุชุงุฑูุฎ ุงูุฅูุดุงุก</th>
                                <th class="px-3 py-2 text-right">ุขุฎุฑ ุชุญุฏูุซ</th>
                                <th class="px-3 py-2 text-right">ููุดุฃ ุจูุงุณุทุฉ</th>
                                <th class="px-3 py-2 text-right">ููุนุชูุฏ ุจูุงุณุทุฉ</th>
                                <th class="px-3 py-2 text-right">ุชุงุฑูุฎ ุงูุงุนุชูุงุฏ</th>
                                <th class="px-3 py-2 text-right">ุฅุฌุฑุงุกุงุช</th>
                            </tr>
                        </thead>
                        <tbody id="paymentsTable" class="text-xs divide-y divide-gray-100">
                            <tr>
                                <td colspan="27" class="px-4 py-12 text-center text-gray-500">
                                    <i class="fas fa-spinner fa-spin text-4xl mb-3 opacity-30"></i>
                                    <div>ุฌุงุฑู ุชุญููู ุงูุจูุงูุงุช...</div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Payment Plans Table -->
        <div class="card-gradient rounded-2xl shadow-2xl overflow-hidden section-accent-violet">
            <div class="p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-xl font-bold text-gray-800">๐ ุฌุฏูู ุฎุทุท ุงูุฏูุน</h3>
                    <div class="flex items-center gap-3">
                        <span id="plansCount" class="text-sm text-gray-600"></span>
                        <button onclick="openAddPlan()" class="bg-violet-600 text-white px-4 py-2 rounded-lg text-sm font-bold hover:bg-violet-700 transition flex items-center gap-2">
                            <i class="fas fa-plus"></i>
                            ุฅุถุงูุฉ ุฎุทุฉ ุฏูุน
                        </button>
                    </div>
                </div>
                <div class="table-scroll">
                    <table class="w-full">
                        <thead class="bg-violet-50 text-violet-700 text-xs">
                            <tr>
                                <th class="px-3 py-2 text-right">ูุนุฑูู ุงูุฎุทุฉ</th>
                                <th class="px-3 py-2 text-right">ุฑูู ุงูุฎุทุฉ</th>
                                <th class="px-3 py-2 text-right">ุฑูู ุงูุนููู</th>
                                <th class="px-3 py-2 text-right">ุงุณู ุงูุนููู (ุนุฑุจู)</th>
                                <th class="px-3 py-2 text-right">ุงุณู ุงูุนููู (ุฅูุฌููุฒู)</th>
                                <th class="px-3 py-2 text-right">ููุฏ ุงูุนููู</th>
                                <th class="px-3 py-2 text-right">ููุน ุงูุนููู</th>
                                <th class="px-3 py-2 text-right">ูุนุฑูู ุงููุงุชูุฑุฉ</th>
                                <th class="px-3 py-2 text-right">ุฑูู ุงููุงุชูุฑุฉ</th>
                                <th class="px-3 py-2 text-right">ุชุงุฑูุฎ ุงููุงุชูุฑุฉ</th>
                                <th class="px-3 py-2 text-right">ุญุงูุฉ ุงููุงุชูุฑุฉ</th>
                                <th class="px-3 py-2 text-right">ุญุงูุฉ ุณุฏุงุฏ ุงููุงุชูุฑุฉ</th>
                                <th class="px-3 py-2 text-right">ุชุงุฑูุฎ ุงูุจุฏุงูุฉ</th>
                                <th class="px-3 py-2 text-right">ุชุงุฑูุฎ ุงูููุงูุฉ</th>
                                <th class="px-3 py-2 text-right">ุฅุฌูุงูู ุงูุฎุทุฉ</th>
                                <th class="px-3 py-2 text-right">ุงููุฏููุน</th>
                                <th class="px-3 py-2 text-right">ุงููุชุจูู</th>
                                <th class="px-3 py-2 text-right">ุนุฏุฏ ุงูุฃูุณุงุท</th>
                                <th class="px-3 py-2 text-right">ูููุฉ ุงููุณุท</th>
                                <th class="px-3 py-2 text-right">ุฏูุฑูุฉ ุงูุณุฏุงุฏ</th>
                                <th class="px-3 py-2 text-right">ุญุงูุฉ ุงูุฎุทุฉ</th>
                                <th class="px-3 py-2 text-right">ุฏุฑุฌุฉ ุงููุฎุงุทุฑ</th>
                                <th class="px-3 py-2 text-right">ูุณุชูู ุงููุฎุงุทุฑ</th>
                                <th class="px-3 py-2 text-right">ููุน ุงูููุงู</th>
                                <th class="px-3 py-2 text-right">ูุนุฑูู ุงูููุงู</th>
                                <th class="px-3 py-2 text-right">ุงููุฑุน</th>
                                <th class="px-3 py-2 text-right">ุงูุญุงุถูุฉ</th>
                                <th class="px-3 py-2 text-right">ุชุงุฑูุฎ ุงูุฅูุดุงุก</th>
                                <th class="px-3 py-2 text-right">ุขุฎุฑ ุชุญุฏูุซ</th>
                                <th class="px-3 py-2 text-right">ููุดุฃ ุจูุงุณุทุฉ</th>
                                <th class="px-3 py-2 text-right">ููุนุชูุฏ ุจูุงุณุทุฉ</th>
                                <th class="px-3 py-2 text-right">ุชุงุฑูุฎ ุงูุงุนุชูุงุฏ</th>
                                <th class="px-3 py-2 text-right">ุฅุฌุฑุงุกุงุช</th>
                            </tr>
                        </thead>
                        <tbody id="plansTable" class="text-xs divide-y divide-gray-100">
                            <tr>
                                <td colspan="33" class="px-4 py-12 text-center text-gray-500">
                                    <i class="fas fa-spinner fa-spin text-4xl mb-3 opacity-30"></i>
                                    <div>ุฌุงุฑู ุชุญููู ุงูุจูุงูุงุช...</div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = window.location.origin;
        const ENTITY_ID = window.getFinanceEntityId ? window.getFinanceEntityId() : 'HQ001';
        const ENTITY_TYPE = window.getFinanceEntityType ? window.getFinanceEntityType() : 'HQ';

        const INVOICE_STATUS_LABELS = {
            ISSUED: 'ูุตุฏุฑุฉ',
            PARTIAL: 'ูุฏููุนุฉ ุฌุฒุฆูุงู',
            OVERDUE: 'ูุชุฃุฎุฑุฉ',
            DRAFT: 'ูุณูุฏุฉ',
            CANCELLED: 'ููุบุงุฉ',
            PAID: 'ูุฏููุนุฉ'
        };
        const PAYMENT_STATUS_LABELS = {
            UNPAID: 'ุบูุฑ ูุฏููุนุฉ',
            PARTIAL: 'ูุฏููุนุฉ ุฌุฒุฆูุงู',
            PAID: 'ูุฏููุนุฉ'
        };
        const PLAN_STATUS_LABELS = {
            active: 'ูุดุทุฉ',
            paused: 'ูููููุฉ',
            completed: 'ููุชููุฉ',
            cancelled: 'ููุบุงุฉ'
        };
        const PAYMENT_METHOD_LABELS = {
            CASH: 'ููุฏู',
            BANK: 'ุชุญููู ุจููู',
            CARD: 'ุจุทุงูุฉ',
            CHECK: 'ุดูู',
            ONLINE: 'ุฏูุน ุฅููุชุฑููู'
        };
        const PAYMENT_EXEC_STATUS_LABELS = {
            APPROVED: 'ูุนุชูุฏุฉ',
            COMPLETED: 'ููุชููุฉ',
            PENDING: 'ูุนููุฉ',
            CANCELLED: 'ููุบุงุฉ',
            FAILED: 'ูุงุดูุฉ'
        };
        const PAYMENT_TYPE_LABELS = {
            FULL: 'ูุงููุฉ',
            PARTIAL: 'ุฌุฒุฆูุฉ',
            ADVANCE: 'ููุฏูุฉ'
        };
        const INSTALLMENT_FREQUENCY_LABELS = {
            MONTHLY: 'ุดูุฑู',
            WEEKLY: 'ุฃุณุจูุนู',
            QUARTERLY: 'ุฑุจุน ุณููู',
            YEARLY: 'ุณููู'
        };

        function translateInvoiceStatus(value) {
            if (!value) return '-';
            const key = String(value).toUpperCase();
            return INVOICE_STATUS_LABELS[key] || value;
        }

        function translatePaymentStatus(value) {
            if (!value) return '-';
            const key = String(value).toUpperCase();
            return PAYMENT_STATUS_LABELS[key] || value;
        }

        function translatePlanStatus(value) {
            if (!value) return '-';
            const key = String(value).toLowerCase();
            return PLAN_STATUS_LABELS[key] || value;
        }

        function translatePaymentMethod(value) {
            if (!value) return '-';
            const key = String(value).toUpperCase();
            return PAYMENT_METHOD_LABELS[key] || value;
        }

        function translatePaymentExecutionStatus(value) {
            if (!value) return '-';
            const key = String(value).toUpperCase();
            return PAYMENT_EXEC_STATUS_LABELS[key] || value;
        }

        function translatePaymentType(value) {
            if (!value) return '-';
            const key = String(value).toUpperCase();
            return PAYMENT_TYPE_LABELS[key] || value;
        }

        function translateInstallmentFrequency(value) {
            if (!value) return '-';
            const key = String(value).toUpperCase();
            return INSTALLMENT_FREQUENCY_LABELS[key] || value;
        }

        function normalizeInvoiceStatus(value) {
            if (!value) return value;
            const v = String(value).trim();
            const map = {
                'ูุตุฏุฑุฉ': 'ISSUED',
                'ูุฏููุนุฉ ุฌุฒุฆูุงู': 'PARTIAL',
                'ูุฏููุนุฉ ุฌุฒุฆูุง': 'PARTIAL',
                'ูุชุฃุฎุฑุฉ': 'OVERDUE',
                'ูุชุงุฎุฑ': 'OVERDUE',
                'ูุชุฃุฎุฑ': 'OVERDUE',
                'ูุณูุฏุฉ': 'DRAFT',
                'ููุบุงุฉ': 'CANCELLED',
                'ูุฏููุนุฉ': 'PAID'
            };
            return map[v] || v;
        }

        function normalizePaymentStatus(value) {
            if (!value) return value;
            const v = String(value).trim();
            const map = {
                'ุบูุฑ ูุฏููุนุฉ': 'UNPAID',
                'ุบูุฑ ูุฏููุนู': 'UNPAID',
                'ุบูุฑ ูุฏููุน': 'UNPAID',
                'ูุฏููุนุฉ ุฌุฒุฆูุงู': 'PARTIAL',
                'ูุฏููุนุฉ ุฌุฒุฆูุง': 'PARTIAL',
                'ูุฏููุนุฉ': 'PAID'
            };
            return map[v] || v;
        }

        function normalizePlanStatus(value) {
            if (!value) return value;
            const v = String(value).trim();
            const map = {
                'ูุดุทุฉ': 'active',
                'ูููููุฉ': 'paused',
                'ููุชููุฉ': 'completed',
                'ููุบุงุฉ': 'cancelled'
            };
            return map[v] || v;
        }

        function normalizePaymentMethod(value) {
            if (!value) return value;
            const v = String(value).trim();
            const map = {
                'ููุฏู': 'CASH',
                'ุชุญููู ุจููู': 'BANK',
                'ุจุทุงูุฉ': 'CARD',
                'ุดูู': 'CHECK',
                'ุฏูุน ุฅููุชุฑููู': 'ONLINE'
            };
            return map[v] || v;
        }

        function normalizePaymentExecutionStatus(value) {
            if (!value) return value;
            const v = String(value).trim();
            const map = {
                'ูุนุชูุฏุฉ': 'APPROVED',
                'ููุชููุฉ': 'COMPLETED',
                'ูุนููุฉ': 'PENDING',
                'ููุบุงุฉ': 'CANCELLED',
                'ูุงุดูุฉ': 'FAILED'
            };
            return map[v] || v;
        }

        function normalizePaymentType(value) {
            if (!value) return value;
            const v = String(value).trim();
            const map = {
                'ูุงููุฉ': 'FULL',
                'ุฌุฒุฆูุฉ': 'PARTIAL',
                'ููุฏูุฉ': 'ADVANCE'
            };
            return map[v] || v;
        }

        function normalizeInstallmentFrequency(value) {
            if (!value) return value;
            const v = String(value).trim();
            const map = {
                'ุดูุฑู': 'MONTHLY',
                'ุฃุณุจูุนู': 'WEEKLY',
                'ุฑุจุน ุณููู': 'QUARTERLY',
                'ุณููู': 'YEARLY'
            };
            return map[v] || v;
        }

        let arRows = [];
        let invoices = [];
        let payments = [];
        let plans = [];
        let customers = [];

        let agingChartInstance = null;
        let methodChartInstance = null;
        let branchChartInstance = null;

        async function loadData() {
            try {
                const [arRes, invRes, payRes, planRes, customersRes] = await Promise.all([
                    fetch(`${API_BASE}/finance/ar-aging?entity_id=${ENTITY_ID}`, {
                        headers: window.getFinanceHeaders ? window.getFinanceHeaders() : {}
                    }),
                    fetch(`${API_BASE}/finance/invoices?entity_id=${ENTITY_ID}`, {
                        headers: window.getFinanceHeaders ? window.getFinanceHeaders() : {}
                    }),
                    fetch(`${API_BASE}/finance/payments?entity_id=${ENTITY_ID}`, {
                        headers: window.getFinanceHeaders ? window.getFinanceHeaders() : {}
                    }),
                    fetch(`${API_BASE}/finance/payment-plans?entity_id=${ENTITY_ID}`, {
                        headers: window.getFinanceHeaders ? window.getFinanceHeaders() : {}
                    }),
                    fetch(`${API_BASE}/finance/customers`, {
                        headers: window.getFinanceHeaders ? window.getFinanceHeaders() : {}
                    })
                ]);

                const [arData, invData, payData, planData, customersData] = await Promise.all([
                    arRes.json(), invRes.json(), payRes.json(), planRes.json(), customersRes.json()
                ]);

                if (!arData.success) throw new Error(arData.error || 'ุชุนุฐุฑ ุชุญููู ุฃุนูุงุฑ ุงูุฐูู');
                if (!invData.success) throw new Error(invData.error || 'ุชุนุฐุฑ ุชุญููู ุงูููุงุชูุฑ');
                if (!payData.success) throw new Error(payData.error || 'ุชุนุฐุฑ ุชุญููู ุงููุฏููุนุงุช');
                if (!planData.success) throw new Error(planData.error || 'ุชุนุฐุฑ ุชุญููู ุฎุทุท ุงูุฏูุน');

                arRows = arData.rows || [];
                invoices = invData.invoices || [];
                payments = payData.payments || [];
                plans = planData.plans || [];
                customers = (customersData && customersData.success && customersData.customers) ? customersData.customers : [];

                applyFilters();
            } catch (error) {
                console.error('โ ุฎุทุฃ ูู ุชุญููู ุงูุจูุงูุงุช:', error);
            }
        }

        function applyFilters() {
            const invoiceNumber = document.getElementById('invoiceNumber').value.trim();
            const customerName = document.getElementById('customerName').value.trim();
            const customerCode = document.getElementById('customerCode').value.trim();
            const invoiceStatus = document.getElementById('invoiceStatus').value.trim();

            const filteredAr = arRows.filter(r => {
                const matchInvoice = !invoiceNumber || (r.invoice_number || '').toString().includes(invoiceNumber);
                const matchCustomer = !customerName || ((r.customer_name_ar || '').includes(customerName) || (r.customer_name_en || '').includes(customerName));
                const matchCode = !customerCode || ((r.customer_code || '').includes(customerCode));
                const statusValue = (r.status || '').toString();
                const statusLabel = translateInvoiceStatus(statusValue);
                const matchStatus = !invoiceStatus || statusValue.toLowerCase().includes(invoiceStatus.toLowerCase()) || statusLabel.toLowerCase().includes(invoiceStatus.toLowerCase());
                return matchInvoice && matchCustomer && matchCode && matchStatus;
            });

            renderSummary(filteredAr, invoices, payments, plans);
            renderCharts(filteredAr, payments);
            renderAIInsights(filteredAr);
            renderTopCustomers(plans);
            renderAgingTable(filteredAr);
            renderInvoicesTable(invoices);
            renderPaymentsTable(payments);
            renderPlansTable(plans);
        }

        function resetFilters() {
            document.getElementById('invoiceNumber').value = '';
            document.getElementById('customerName').value = '';
            document.getElementById('customerCode').value = '';
            document.getElementById('invoiceStatus').value = '';
            applyFilters();
        }

        function renderSummary(arData, invData, payData, planData) {
            const totalAR = arData.reduce((sum, r) => sum + parseFloat(r.remaining_amount || 0), 0);
            const openInvoices = arData.length;
            const today = new Date();

            const daily = payData.filter(p => isWithinDays(p.payment_date, 1)).reduce((sum, p) => sum + parseFloat(p.payment_amount || 0), 0);
            const weekly = payData.filter(p => isWithinDays(p.payment_date, 7)).reduce((sum, p) => sum + parseFloat(p.payment_amount || 0), 0);

            document.getElementById('totalAR').textContent = formatMoney(totalAR);
            document.getElementById('openInvoices').textContent = openInvoices;
            document.getElementById('dailyCollections').textContent = formatMoney(daily);
            document.getElementById('weeklyCollections').textContent = formatMoney(weekly);

            const overdue = invData.filter(i => (i.status || '').toUpperCase() === 'OVERDUE').length;
            const paid = invData.filter(i => (i.status || '').toUpperCase() === 'PAID').length;
            const avgInvoice = invData.length ? invData.reduce((sum, i) => sum + parseFloat(i.total_amount || 0), 0) / invData.length : 0;
            const avgTerms = invData.length ? invData.reduce((sum, i) => sum + diffDays(i.invoice_date, i.due_date), 0) / invData.length : 0;

            document.getElementById('overdueInvoices').textContent = overdue;
            document.getElementById('paidInvoices').textContent = paid;
            document.getElementById('avgInvoiceValue').textContent = formatMoney(avgInvoice);
            document.getElementById('avgTerms').textContent = `${avgTerms.toFixed(0)} ููู`;

            const totalPlanAmount = planData.reduce((sum, p) => sum + parseFloat(p.total_amount || 0), 0);
            const totalPlanPaid = planData.reduce((sum, p) => sum + parseFloat(p.paid_amount || 0), 0);
            const compliance = totalPlanAmount > 0 ? (totalPlanPaid / totalPlanAmount) * 100 : 0;
            document.getElementById('planCompliance').textContent = `${compliance.toFixed(1)}%`;
        }

        function renderCharts(arData, payData) {
            const bucketTotals = groupSum(arData, 'aging_category', 'remaining_amount');
            const bucketLabels = Object.keys(bucketTotals);
            const bucketValues = bucketLabels.map(k => bucketTotals[k]);

            const agingCtx = document.getElementById('agingChart').getContext('2d');
            if (agingChartInstance) agingChartInstance.destroy();
            agingChartInstance = new Chart(agingCtx, {
                type: 'bar',
                data: {
                    labels: bucketLabels.length ? bucketLabels : ['ูุง ููุฌุฏ'],
                    datasets: [{
                        label: 'ุงูุฑุตูุฏ ุงููุชุจูู',
                        data: bucketValues.length ? bucketValues : [0],
                        backgroundColor: 'rgba(14, 165, 233, 0.7)'
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
            });

            const methodTotals = groupSum(payData, 'payment_method', 'payment_amount');
            const methodLabels = Object.keys(methodTotals);
            const methodValues = methodLabels.map(k => methodTotals[k]);
            const methodCtx = document.getElementById('collectionMethodChart').getContext('2d');
            if (methodChartInstance) methodChartInstance.destroy();
            methodChartInstance = new Chart(methodCtx, {
                type: 'doughnut',
                data: {
                    labels: methodLabels.length ? methodLabels : ['ูุง ููุฌุฏ'],
                    datasets: [{
                        data: methodValues.length ? methodValues : [1],
                        backgroundColor: ['#0ea5e9', '#22c55e', '#f59e0b', '#8b5cf6', '#ef4444']
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });

            const branchTotals = groupSum(payData, 'branch_id', 'payment_amount');
            const branchLabels = Object.keys(branchTotals).map(k => k || 'ุบูุฑ ูุญุฏุฏ');
            const branchValues = Object.values(branchTotals);
            const branchCtx = document.getElementById('collectionBranchChart').getContext('2d');
            if (branchChartInstance) branchChartInstance.destroy();
            branchChartInstance = new Chart(branchCtx, {
                type: 'bar',
                data: {
                    labels: branchLabels.length ? branchLabels : ['ูุง ููุฌุฏ'],
                    datasets: [{
                        label: 'ุงูุชุญุตูู',
                        data: branchValues.length ? branchValues : [0],
                        backgroundColor: 'rgba(16, 185, 129, 0.7)'
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
            });
        }

        function renderAIInsights(arData) {
            const riskyInvoices = arData.filter(r => ['61-90_DAYS', 'OVER_90_DAYS'].includes(String(r.aging_category || '').toUpperCase()));
            const riskyCustomers = new Set(riskyInvoices.map(r => r.customer_id)).size;
            const reminders = arData.filter(r => String(r.aging_category || '').toUpperCase() !== 'CURRENT').length;

            document.getElementById('aiInsights').innerHTML = `
                <div class="flex items-center gap-3 p-3 bg-gray-50 rounded-lg">
                    <i class="fas fa-triangle-exclamation text-amber-600 text-xl"></i>
                    <div>
                        <div class="text-sm text-gray-600">ุนููุงุก ูุนุฑุถูู ููุชุนุซุฑ</div>
                        <div class="font-bold">${riskyCustomers} ุนููู</div>
                    </div>
                </div>
                <div class="flex items-center gap-3 p-3 bg-gray-50 rounded-lg">
                    <i class="fas fa-bell text-emerald-600 text-xl"></i>
                    <div>
                        <div class="text-sm text-gray-600">ููุงุชูุฑ ุชุญุชุงุฌ ุชุฐููุฑ</div>
                        <div class="font-bold">${reminders} ูุงุชูุฑุฉ</div>
                    </div>
                </div>
            `;
        }

        function renderTopCustomers(planData) {
            const grouped = {};
            planData.forEach(p => {
                const key = p.customer_name_ar || p.customer_name_en || `ุนููู ${p.customer_id}`;
                const total = parseFloat(p.total_amount || 0);
                const paid = parseFloat(p.paid_amount || 0);
                if (!grouped[key]) grouped[key] = { total: 0, paid: 0 };
                grouped[key].total += total;
                grouped[key].paid += paid;
            });

            const ranked = Object.entries(grouped).map(([name, vals]) => ({
                name,
                ratio: vals.total > 0 ? vals.paid / vals.total : 0,
                total: vals.total,
                paid: vals.paid
            }));

            const committed = ranked.sort((a, b) => b.ratio - a.ratio).slice(0, 5);
            const delinquent = ranked.sort((a, b) => a.ratio - b.ratio).slice(0, 5);

            document.getElementById('topCommitted').innerHTML = committed.length ? committed.map(c => `
                <div class="flex items-center justify-between bg-emerald-50 p-3 rounded-lg">
                    <div>${c.name}</div>
                    <div class="font-bold">${(c.ratio * 100).toFixed(1)}%</div>
                </div>
            `).join('') : '<div class="text-gray-500 text-center">ูุง ุชูุฌุฏ ุจูุงูุงุช</div>';

            document.getElementById('topDelinquent').innerHTML = delinquent.length ? delinquent.map(c => `
                <div class="flex items-center justify-between bg-amber-50 p-3 rounded-lg">
                    <div>${c.name}</div>
                    <div class="font-bold">${(c.ratio * 100).toFixed(1)}%</div>
                </div>
            `).join('') : '<div class="text-gray-500 text-center">ูุง ุชูุฌุฏ ุจูุงูุงุช</div>';
        }

        function renderAgingTable(rowsData) {
            const body = rowsData.map(r => `
                <tr class="hover:bg-slate-50">
                    <td class="px-3 py-2">${r.invoice_id ?? '-'}</td>
                    <td class="px-3 py-2">${r.invoice_number ?? '-'}</td>
                    <td class="px-3 py-2">${formatDate(r.invoice_date)}</td>
                    <td class="px-3 py-2">${formatDate(r.due_date)}</td>
                    <td class="px-3 py-2">${r.customer_id ?? '-'}</td>
                    <td class="px-3 py-2">${r.customer_code ?? '-'}</td>
                    <td class="px-3 py-2">${r.customer_name_ar ?? '-'}</td>
                    <td class="px-3 py-2">${r.customer_name_en ?? '-'}</td>
                    <td class="px-3 py-2">${r.customer_type ?? '-'}</td>
                    <td class="px-3 py-2 font-semibold text-emerald-700">${formatMoney(r.total_amount)}</td>
                    <td class="px-3 py-2">${formatMoney(r.paid_amount)}</td>
                    <td class="px-3 py-2">${formatMoney(r.remaining_amount)}</td>
                    <td class="px-3 py-2">${translateInvoiceStatus(r.status)}</td>
                    <td class="px-3 py-2">${translatePaymentStatus(r.payment_status)}</td>
                    <td class="px-3 py-2">${r.days_overdue ?? '-'}</td>
                    <td class="px-3 py-2">${r.aging_category ?? '-'}</td>
                    <td class="px-3 py-2">${r.entity_type ?? '-'}</td>
                    <td class="px-3 py-2">${r.entity_id ?? '-'}</td>
                    <td class="px-3 py-2">${r.branch_id ?? '-'}</td>
                    <td class="px-3 py-2">${r.incubator_id ?? '-'}</td>
                    <td class="px-3 py-2">
                        <div class="flex gap-2">
                            <button onclick="openViewAgingInvoice(${r.invoice_id})" class="p-2 text-indigo-600 hover:bg-indigo-50 rounded-lg transition" title="ูุนุงููุฉ">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button onclick="openEditAgingInvoice(${r.invoice_id})" class="p-2 text-blue-600 hover:bg-blue-50 rounded-lg transition" title="ุชุนุฏูู">
                                <i class="fas fa-pen"></i>
                            </button>
                            <button onclick="deleteAgingInvoice(${r.invoice_id})" class="p-2 text-red-600 hover:bg-red-50 rounded-lg transition" title="ุญุฐู">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');

            document.getElementById('agingTable').innerHTML = body.length ? body : `
                <tr><td colspan="21" class="px-4 py-12 text-center text-gray-500">ูุง ุชูุฌุฏ ุจูุงูุงุช</td></tr>
            `;
            document.getElementById('agingCount').textContent = `ุนุฏุฏ ุงูุตููู: ${rowsData.length}`;
        }

        function renderInvoicesTable(rows) {
            const body = rows.map(r => `
                <tr class="hover:bg-indigo-50">
                    <td class="px-3 py-2">${r.invoice_id ?? '-'}</td>
                    <td class="px-3 py-2">${r.invoice_number ?? '-'}</td>
                    <td class="px-3 py-2">${formatDate(r.invoice_date)}</td>
                    <td class="px-3 py-2">${formatDate(r.due_date)}</td>
                    <td class="px-3 py-2">${r.customer_id ?? '-'}</td>
                    <td class="px-3 py-2">${r.customer_name ?? '-'}</td>
                    <td class="px-3 py-2">${r.customer_name_ar ?? '-'}</td>
                    <td class="px-3 py-2">${r.customer_code ?? '-'}</td>
                    <td class="px-3 py-2">${r.risk_level ?? '-'}</td>
                    <td class="px-3 py-2">${formatMoney(r.subtotal)}</td>
                    <td class="px-3 py-2">${formatMoney(r.tax_amount)}</td>
                    <td class="px-3 py-2">${formatMoney(r.discount_amount)}</td>
                    <td class="px-3 py-2 font-semibold text-emerald-700">${formatMoney(r.total_amount)}</td>
                    <td class="px-3 py-2">${formatMoney(r.paid_amount)}</td>
                    <td class="px-3 py-2">${formatMoney(r.remaining_amount)}</td>
                    <td class="px-3 py-2">${translateInvoiceStatus(r.status)}</td>
                    <td class="px-3 py-2">${translatePaymentStatus(r.payment_status)}</td>
                    <td class="px-3 py-2">${formatBoolean(r.allow_partial_payment)}</td>
                    <td class="px-3 py-2">${formatBoolean(r.allow_installments)}</td>
                    <td class="px-3 py-2">${r.program_id ?? '-'}</td>
                    <td class="px-3 py-2">${r.service_id ?? '-'}</td>
                    <td class="px-3 py-2">${r.entity_type ?? '-'}</td>
                    <td class="px-3 py-2">${r.entity_id ?? '-'}</td>
                    <td class="px-3 py-2">${r.branch_id ?? '-'}</td>
                    <td class="px-3 py-2">${r.incubator_id ?? '-'}</td>
                    <td class="px-3 py-2">${r.platform_id ?? '-'}</td>
                    <td class="px-3 py-2">${r.office_id ?? '-'}</td>
                    <td class="px-3 py-2">${r.journal_entry_id ?? '-'}</td>
                    <td class="px-3 py-2">${r.notes ?? '-'}</td>
                    <td class="px-3 py-2"><div class="json-pill">${r.terms_conditions ?? '-'}</div></td>
                    <td class="px-3 py-2">${formatDateTime(r.created_at)}</td>
                    <td class="px-3 py-2">${formatDateTime(r.updated_at)}</td>
                    <td class="px-3 py-2">${r.created_by ?? '-'}</td>
                    <td class="px-3 py-2">${r.updated_by ?? '-'}</td>
                    <td class="px-3 py-2">${r.cancelled_by ?? '-'}</td>
                    <td class="px-3 py-2">${formatDateTime(r.cancelled_at)}</td>
                    <td class="px-3 py-2"><div class="json-pill">${r.cancelled_reason ?? '-'}</div></td>
                    <td class="px-3 py-2">
                        <div class="flex gap-2">
                            <button onclick="openViewInvoice(${r.invoice_id})" class="p-2 text-indigo-600 hover:bg-indigo-50 rounded-lg transition" title="ูุนุงููุฉ">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button onclick="openEditInvoice(${r.invoice_id})" class="p-2 text-blue-600 hover:bg-blue-50 rounded-lg transition" title="ุชุนุฏูู">
                                <i class="fas fa-pen"></i>
                            </button>
                            <button onclick="deleteInvoice(${r.invoice_id})" class="p-2 text-red-600 hover:bg-red-50 rounded-lg transition" title="ุญุฐู">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');

            document.getElementById('invoicesTable').innerHTML = body.length ? body : `
                <tr><td colspan="38" class="px-4 py-12 text-center text-gray-500">ูุง ุชูุฌุฏ ุจูุงูุงุช</td></tr>
            `;
            document.getElementById('invoicesCount').textContent = `ุนุฏุฏ ุงูุตููู: ${rows.length}`;
        }

        function renderPaymentsTable(rows) {
            const body = rows.map(r => `
                <tr class="hover:bg-emerald-50">
                    <td class="px-3 py-2">${r.payment_id ?? '-'}</td>
                    <td class="px-3 py-2">${r.payment_number ?? '-'}</td>
                    <td class="px-3 py-2">${formatDate(r.payment_date)}</td>
                    <td class="px-3 py-2">${r.customer_id ?? '-'}</td>
                    <td class="px-3 py-2">${r.customer_name ?? '-'}</td>
                    <td class="px-3 py-2">${r.customer_name_ar ?? '-'}</td>
                    <td class="px-3 py-2">${r.customer_code ?? '-'}</td>
                    <td class="px-3 py-2 font-semibold text-emerald-700">${formatMoney(r.payment_amount)}</td>
                    <td class="px-3 py-2">${translatePaymentMethod(r.payment_method)}</td>
                    <td class="px-3 py-2">${translatePaymentType(r.payment_type)}</td>
                    <td class="px-3 py-2">${r.bank_name ?? '-'}</td>
                    <td class="px-3 py-2">${r.check_number ?? '-'}</td>
                    <td class="px-3 py-2">${r.transaction_reference ?? '-'}</td>
                    <td class="px-3 py-2">${translatePaymentExecutionStatus(r.status)}</td>
                    <td class="px-3 py-2">${r.entity_type ?? '-'}</td>
                    <td class="px-3 py-2">${r.entity_id ?? '-'}</td>
                    <td class="px-3 py-2">${r.branch_id ?? '-'}</td>
                    <td class="px-3 py-2">${r.incubator_id ?? '-'}</td>
                    <td class="px-3 py-2">${r.platform_id ?? '-'}</td>
                    <td class="px-3 py-2">${r.journal_entry_id ?? '-'}</td>
                    <td class="px-3 py-2">${r.notes ?? '-'}</td>
                    <td class="px-3 py-2">${formatDateTime(r.created_at)}</td>
                    <td class="px-3 py-2">${formatDateTime(r.updated_at)}</td>
                    <td class="px-3 py-2">${r.created_by ?? '-'}</td>
                    <td class="px-3 py-2">${r.approved_by ?? '-'}</td>
                    <td class="px-3 py-2">${formatDateTime(r.approved_at)}</td>
                    <td class="px-3 py-2">
                        <div class="flex gap-2">
                            <button onclick="openViewPayment(${r.payment_id})" class="p-2 text-indigo-600 hover:bg-indigo-50 rounded-lg transition" title="ูุนุงููุฉ">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button onclick="openEditPayment(${r.payment_id})" class="p-2 text-blue-600 hover:bg-blue-50 rounded-lg transition" title="ุชุนุฏูู">
                                <i class="fas fa-pen"></i>
                            </button>
                            <button onclick="deletePayment(${r.payment_id})" class="p-2 text-red-600 hover:bg-red-50 rounded-lg transition" title="ุญุฐู">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');

            document.getElementById('paymentsTable').innerHTML = body.length ? body : `
                <tr><td colspan="27" class="px-4 py-12 text-center text-gray-500">ูุง ุชูุฌุฏ ุจูุงูุงุช</td></tr>
            `;
            document.getElementById('paymentsCount').textContent = `ุนุฏุฏ ุงูุตููู: ${rows.length}`;
        }

        function renderPlansTable(rows) {
            const body = rows.map(r => `
                <tr class="hover:bg-violet-50">
                    <td class="px-3 py-2">${r.plan_id ?? '-'}</td>
                    <td class="px-3 py-2">${r.plan_number ?? '-'}</td>
                    <td class="px-3 py-2">${r.customer_id ?? '-'}</td>
                    <td class="px-3 py-2">${r.customer_name_ar ?? '-'}</td>
                    <td class="px-3 py-2">${r.customer_name_en ?? '-'}</td>
                    <td class="px-3 py-2">${r.customer_code ?? '-'}</td>
                    <td class="px-3 py-2">${r.customer_type ?? '-'}</td>
                    <td class="px-3 py-2">${r.invoice_id ?? '-'}</td>
                    <td class="px-3 py-2">${r.invoice_number ?? '-'}</td>
                    <td class="px-3 py-2">${formatDate(r.invoice_date)}</td>
                    <td class="px-3 py-2">${translateInvoiceStatus(r.invoice_status)}</td>
                    <td class="px-3 py-2">${translatePaymentStatus(r.invoice_payment_status)}</td>
                    <td class="px-3 py-2">${formatDate(r.start_date)}</td>
                    <td class="px-3 py-2">${formatDate(r.end_date)}</td>
                    <td class="px-3 py-2 font-semibold text-emerald-700">${formatMoney(r.total_amount)}</td>
                    <td class="px-3 py-2">${formatMoney(r.paid_amount)}</td>
                    <td class="px-3 py-2">${formatMoney(r.remaining_amount)}</td>
                    <td class="px-3 py-2">${r.number_of_installments ?? '-'}</td>
                    <td class="px-3 py-2">${formatMoney(r.installment_amount)}</td>
                    <td class="px-3 py-2">${translateInstallmentFrequency(r.installment_frequency)}</td>
                    <td class="px-3 py-2">${translatePlanStatus(r.status)}</td>
                    <td class="px-3 py-2">${r.risk_score_at_creation ?? '-'}</td>
                    <td class="px-3 py-2">${r.risk_level_at_creation ?? '-'}</td>
                    <td class="px-3 py-2">${r.entity_type ?? '-'}</td>
                    <td class="px-3 py-2">${r.entity_id ?? '-'}</td>
                    <td class="px-3 py-2">${r.branch_id ?? '-'}</td>
                    <td class="px-3 py-2">${r.incubator_id ?? '-'}</td>
                    <td class="px-3 py-2">${formatDateTime(r.created_at)}</td>
                    <td class="px-3 py-2">${formatDateTime(r.updated_at)}</td>
                    <td class="px-3 py-2">${r.created_by ?? '-'}</td>
                    <td class="px-3 py-2">${r.approved_by ?? '-'}</td>
                    <td class="px-3 py-2">${formatDateTime(r.approved_at)}</td>
                    <td class="px-3 py-2">
                        <div class="flex gap-2">
                            <button onclick="openViewPlan(${r.plan_id})" class="p-2 text-indigo-600 hover:bg-indigo-50 rounded-lg transition" title="ูุนุงููุฉ">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button onclick="openEditPlan(${r.plan_id})" class="p-2 text-blue-600 hover:bg-blue-50 rounded-lg transition" title="ุชุนุฏูู">
                                <i class="fas fa-pen"></i>
                            </button>
                            <button onclick="deletePlan(${r.plan_id})" class="p-2 text-red-600 hover:bg-red-50 rounded-lg transition" title="ุญุฐู">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');

            document.getElementById('plansTable').innerHTML = body.length ? body : `
                <tr><td colspan="33" class="px-4 py-12 text-center text-gray-500">ูุง ุชูุฌุฏ ุจูุงูุงุช</td></tr>
            `;
            document.getElementById('plansCount').textContent = `ุนุฏุฏ ุงูุตููู: ${rows.length}`;
        }

        function buildCustomerOptions(selectedId) {
            if (!customers.length) {
                return '<option value="">ูุง ุชูุฌุฏ ุจูุงูุงุช ุนููุงุก</option>';
            }
            return customers.map(c => `
                <option value="${c.customer_id}" ${String(c.customer_id) === String(selectedId) ? 'selected' : ''}>
                    ${c.customer_name_ar || c.customer_name_en || 'ุนููู'} ${c.customer_code ? `- ${c.customer_code}` : ''}
                </option>
            `).join('');
        }

        function buildInvoiceOptions(selectedId) {
            if (!invoices.length) {
                return '<option value="">ูุง ุชูุฌุฏ ููุงุชูุฑ</option>';
            }
            return invoices.map(i => `
                <option value="${i.invoice_id}" ${String(i.invoice_id) === String(selectedId) ? 'selected' : ''}>
                    ${i.invoice_number || 'ูุงุชูุฑุฉ'} - ${i.customer_name_ar || i.customer_name || ''}
                </option>
            `).join('');
        }

        function buildSelectOptions(options, selectedValue) {
            return options.map(opt => `
                <option value="${opt}" ${String(opt) === String(selectedValue) ? 'selected' : ''}>${opt}</option>
            `).join('');
        }

        function openAddAgingInvoice() {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay fixed inset-0 bg-black/40 flex items-start justify-center z-50 p-4 overflow-y-auto';
            modal.innerHTML = `
                <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl my-6">
                    <div class="p-5 border-b flex items-center justify-between">
                        <h3 class="font-bold text-lg">ุฅุถุงูุฉ ูุงุชูุฑุฉ ุฐูู</h3>
                        <button onclick="this.closest('.modal-overlay').remove()" class="text-gray-500 hover:text-gray-700"><i class="fas fa-times"></i></button>
                    </div>
                    <div class="p-5 grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                        <div>
                            <label class="block mb-1 text-gray-600">ุงูุนููู</label>
                            <select id="aging-add-customer-id" class="w-full border rounded-lg px-3 py-2">
                                ${buildCustomerOptions()}
                            </select>
                        </div>
                        <div>
                            <label class="block mb-1 text-gray-600">ุชุงุฑูุฎ ุงููุงุชูุฑุฉ</label>
                            <input id="aging-add-invoice-date" type="date" class="w-full border rounded-lg px-3 py-2">
                        </div>
                        <div>
                            <label class="block mb-1 text-gray-600">ุชุงุฑูุฎ ุงูุงุณุชุญูุงู</label>
                            <input id="aging-add-due-date" type="date" class="w-full border rounded-lg px-3 py-2">
                        </div>
                        <div>
                            <label class="block mb-1 text-gray-600">ุฅุฌูุงูู ุงููุงุชูุฑุฉ</label>
                            <input id="aging-add-total-amount" type="number" step="0.01" class="w-full border rounded-lg px-3 py-2">
                        </div>
                        <div>
                            <label class="block mb-1 text-gray-600">ุงููุฏููุน</label>
                            <input id="aging-add-paid-amount" type="number" step="0.01" class="w-full border rounded-lg px-3 py-2" value="0">
                        </div>
                        <div>
                            <label class="block mb-1 text-gray-600">ุญุงูุฉ ุงููุงุชูุฑุฉ</label>
                            <select id="aging-add-status" class="w-full border rounded-lg px-3 py-2">
                                ${buildSelectOptions(Object.values(INVOICE_STATUS_LABELS), 'ูุตุฏุฑุฉ')}
                            </select>
                        </div>
                        <div>
                            <label class="block mb-1 text-gray-600">ุญุงูุฉ ุงูุณุฏุงุฏ</label>
                            <select id="aging-add-payment-status" class="w-full border rounded-lg px-3 py-2">
                                ${buildSelectOptions(Object.values(PAYMENT_STATUS_LABELS), 'ุบูุฑ ูุฏููุนุฉ')}
                            </select>
                        </div>
                        <div class="md:col-span-2">
                            <label class="block mb-1 text-gray-600">ููุงุญุธุงุช</label>
                            <textarea id="aging-add-notes" class="w-full border rounded-lg px-3 py-2" rows="2"></textarea>
                        </div>
                    </div>
                    <div class="p-5 border-t flex items-center justify-end gap-2">
                        <button onclick="this.closest('.modal-overlay').remove()" class="px-4 py-2 rounded-lg border">ุฅูุบุงุก</button>
                        <button onclick="submitAddAgingInvoice()" class="px-4 py-2 rounded-lg bg-slate-900 text-white">ุญูุธ</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function openViewAgingInvoice(invoiceId) {
            const invoice = arRows.find(r => r.invoice_id === invoiceId);
            if (!invoice) return;
            const modal = document.createElement('div');
            modal.className = 'modal-overlay fixed inset-0 bg-black/40 flex items-start justify-center z-50 p-4 overflow-y-auto';
            const details = [
                ['ุฑูู ุงููุงุชูุฑุฉ', invoice.invoice_number],
                ['ุชุงุฑูุฎ ุงููุงุชูุฑุฉ', formatDate(invoice.invoice_date)],
                ['ุชุงุฑูุฎ ุงูุงุณุชุญูุงู', formatDate(invoice.due_date)],
                ['ุงุณู ุงูุนููู', invoice.customer_name_ar],
                ['ุฅุฌูุงูู ุงููุงุชูุฑุฉ', formatMoney(invoice.total_amount)],
                ['ุงููุฏููุน', formatMoney(invoice.paid_amount)],
                ['ุงููุชุจูู', formatMoney(invoice.remaining_amount)],
                ['ุญุงูุฉ ุงููุงุชูุฑุฉ', translateInvoiceStatus(invoice.status)],
                ['ุญุงูุฉ ุงูุณุฏุงุฏ', translatePaymentStatus(invoice.payment_status)],
                ['ุฃูุงู ุงูุชุฃุฎูุฑ', invoice.days_overdue ?? '-']
            ];
            modal.innerHTML = `
                <div class="bg-white rounded-2xl shadow-2xl w-full max-w-xl my-6">
                    <div class="p-5 border-b flex items-center justify-between">
                        <h3 class="font-bold text-lg">ุชูุงุตูู ูุงุชูุฑุฉ ุงูุฐูู</h3>
                        <button onclick="this.closest('.modal-overlay').remove()" class="text-gray-500 hover:text-gray-700"><i class="fas fa-times"></i></button>
                    </div>
                    <div class="p-5 space-y-2 text-sm">
                        ${details.map(([label, value]) => `
                            <div class="flex items-center justify-between border-b pb-2">
                                <span class="font-semibold text-gray-700">${label}</span>
                                <span class="text-gray-900">${value ?? '-'}</span>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function openEditAgingInvoice(invoiceId) {
            const invoice = arRows.find(r => r.invoice_id === invoiceId);
            if (!invoice) return;
            const modal = document.createElement('div');
            modal.className = 'modal-overlay fixed inset-0 bg-black/40 flex items-start justify-center z-50 p-4 overflow-y-auto';
            modal.innerHTML = `
                <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl my-6">
                    <div class="p-5 border-b flex items-center justify-between">
                        <h3 class="font-bold text-lg">ุชุนุฏูู ูุงุชูุฑุฉ ุฐูู</h3>
                        <button onclick="this.closest('.modal-overlay').remove()" class="text-gray-500 hover:text-gray-700"><i class="fas fa-times"></i></button>
                    </div>
                    <div class="p-5 grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                        <div>
                            <label class="block mb-1 text-gray-600">ุชุงุฑูุฎ ุงููุงุชูุฑุฉ</label>
                            <input id="aging-edit-invoice-date" type="date" class="w-full border rounded-lg px-3 py-2" value="${invoice.invoice_date ? new Date(invoice.invoice_date).toISOString().slice(0,10) : ''}">
                        </div>
                        <div>
                            <label class="block mb-1 text-gray-600">ุชุงุฑูุฎ ุงูุงุณุชุญูุงู</label>
                            <input id="aging-edit-due-date" type="date" class="w-full border rounded-lg px-3 py-2" value="${invoice.due_date ? new Date(invoice.due_date).toISOString().slice(0,10) : ''}">
                        </div>
                        <div>
                            <label class="block mb-1 text-gray-600">ุฅุฌูุงูู ุงููุงุชูุฑุฉ</label>
                            <input id="aging-edit-total-amount" type="number" step="0.01" class="w-full border rounded-lg px-3 py-2" value="${invoice.total_amount ?? 0}">
                        </div>
                        <div>
                            <label class="block mb-1 text-gray-600">ุงููุฏููุน</label>
                            <input id="aging-edit-paid-amount" type="number" step="0.01" class="w-full border rounded-lg px-3 py-2" value="${invoice.paid_amount ?? 0}">
                        </div>
                        <div>
                            <label class="block mb-1 text-gray-600">ุญุงูุฉ ุงููุงุชูุฑุฉ</label>
                            <select id="aging-edit-status" class="w-full border rounded-lg px-3 py-2">
                                ${buildSelectOptions(Object.values(INVOICE_STATUS_LABELS), translateInvoiceStatus(invoice.status))}
                            </select>
                        </div>
                        <div>
                            <label class="block mb-1 text-gray-600">ุญุงูุฉ ุงูุณุฏุงุฏ</label>
                            <select id="aging-edit-payment-status" class="w-full border rounded-lg px-3 py-2">
                                ${buildSelectOptions(Object.values(PAYMENT_STATUS_LABELS), translatePaymentStatus(invoice.payment_status))}
                            </select>
                        </div>
                        <div class="md:col-span-2">
                            <label class="block mb-1 text-gray-600">ููุงุญุธุงุช</label>
                            <textarea id="aging-edit-notes" class="w-full border rounded-lg px-3 py-2" rows="2">${invoice.notes ?? ''}</textarea>
                        </div>
                    </div>
                    <div class="p-5 border-t flex items-center justify-end gap-2">
                        <button onclick="this.closest('.modal-overlay').remove()" class="px-4 py-2 rounded-lg border">ุฅูุบุงุก</button>
                        <button onclick="submitEditAgingInvoice(${invoiceId})" class="px-4 py-2 rounded-lg bg-slate-900 text-white">ุญูุธ</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        async function submitAddAgingInvoice() {
            const customerIdValue = document.getElementById('aging-add-customer-id').value;
            const invoiceDateValue = document.getElementById('aging-add-invoice-date').value;
            const dueDateValue = document.getElementById('aging-add-due-date').value;
            const totalValue = parseFloat(document.getElementById('aging-add-total-amount').value || 0);
            const paidValue = parseFloat(document.getElementById('aging-add-paid-amount').value || 0);

            if (!customerIdValue) {
                alert('ุงุฎุชุฑ ุงูุนููู ุฃููุงู');
                return;
            }
            if (!invoiceDateValue || !dueDateValue) {
                alert('ุฃุฏุฎู ุชุงุฑูุฎ ุงููุงุชูุฑุฉ ูุชุงุฑูุฎ ุงูุงุณุชุญูุงู');
                return;
            }
            if (!Number.isFinite(totalValue) || totalValue <= 0) {
                alert('ุฅุฌูุงูู ุงููุงุชูุฑุฉ ูุฌุจ ุฃู ูููู ุฃูุจุฑ ูู ุตูุฑ');
                return;
            }
            if (!Number.isFinite(paidValue) || paidValue < 0) {
                alert('ูููุฉ ุงููุฏููุน ุบูุฑ ุตุญูุญุฉ');
                return;
            }
            if (paidValue >= totalValue) {
                alert('ูููุฉ ุงููุฏููุน ูุฌุจ ุฃู ุชููู ุฃูู ูู ุงูุฅุฌูุงูู ููุธูุฑ ูู ุฌุฏูู ุฃุนูุงุฑ ุงูุฐูู');
                return;
            }

            const payload = {
                customer_id: Number(customerIdValue),
                invoice_date: invoiceDateValue,
                due_date: dueDateValue,
                total_amount: totalValue,
                paid_amount: paidValue,
                status: normalizeInvoiceStatus(document.getElementById('aging-add-status').value),
                payment_status: normalizePaymentStatus(document.getElementById('aging-add-payment-status').value),
                entity_type: ENTITY_TYPE,
                entity_id: ENTITY_ID,
                notes: document.getElementById('aging-add-notes').value,
                created_by: 'ููุญุฉ ุงูุชุญูู'
            };

            const res = await fetch(`${API_BASE}/finance/ar-aging/invoices`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', ...(window.getFinanceHeaders ? window.getFinanceHeaders() : {}) },
                body: JSON.stringify(payload)
            });

            if (res.ok) {
                document.querySelector('.modal-overlay')?.remove();
                await loadData();
            } else {
                let message = 'ุชุนุฐุฑ ุฅุถุงูุฉ ุงููุงุชูุฑุฉ';
                try {
                    const data = await res.json();
                    if (data && data.error) message = data.error;
                } catch (e) {
                    // ignore
                }
                alert(message);
            }
        }

        async function submitEditAgingInvoice(invoiceId) {
            const payload = {
                invoice_date: document.getElementById('aging-edit-invoice-date').value,
                due_date: document.getElementById('aging-edit-due-date').value,
                total_amount: parseFloat(document.getElementById('aging-edit-total-amount').value || 0),
                paid_amount: parseFloat(document.getElementById('aging-edit-paid-amount').value || 0),
                status: normalizeInvoiceStatus(document.getElementById('aging-edit-status').value),
                payment_status: normalizePaymentStatus(document.getElementById('aging-edit-payment-status').value),
                notes: document.getElementById('aging-edit-notes').value
            };

            const res = await fetch(`${API_BASE}/finance/ar-aging/invoices/${invoiceId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json', ...(window.getFinanceHeaders ? window.getFinanceHeaders() : {}) },
                body: JSON.stringify(payload)
            });

            if (res.ok) {
                document.querySelector('.modal-overlay')?.remove();
                await loadData();
            } else {
                let message = 'ุชุนุฐุฑ ุชุญุฏูุซ ุงููุงุชูุฑุฉ';
                try {
                    const data = await res.json();
                    if (data && data.error) message = data.error;
                } catch (e) {
                    // ignore
                }
                alert(message);
            }
        }

        async function deleteAgingInvoice(invoiceId) {
            if (!confirm('ูู ุชุฑูุฏ ุญุฐู ูุฐู ุงููุงุชูุฑุฉุ')) return;
            const res = await fetch(`${API_BASE}/finance/ar-aging/invoices/${invoiceId}`, {
                method: 'DELETE',
                headers: window.getFinanceHeaders ? window.getFinanceHeaders() : {}
            });

            if (res.ok) {
                await loadData();
            } else {
                let message = 'ุชุนุฐุฑ ุญุฐู ุงููุงุชูุฑุฉ';
                try {
                    const data = await res.json();
                    if (data && data.error) message = data.error;
                } catch (e) {
                    // ignore
                }
                alert(message);
            }
        }

        function openAddInvoice() {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay fixed inset-0 bg-black/40 flex items-start justify-center z-50 p-4 overflow-y-auto';
            modal.innerHTML = `
                <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl my-6">
                    <div class="p-5 border-b flex items-center justify-between">
                        <h3 class="font-bold text-lg">ุฅุถุงูุฉ ูุงุชูุฑุฉ</h3>
                        <button onclick="this.closest('.modal-overlay').remove()" class="text-gray-500 hover:text-gray-700"><i class="fas fa-times"></i></button>
                    </div>
                    <div class="p-5 grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                        <div>
                            <label class="block mb-1 text-gray-600">ุงูุนููู</label>
                            <select id="inv-add-customer-id" class="w-full border rounded-lg px-3 py-2">
                                ${buildCustomerOptions()}
                            </select>
                        </div>
                        <div>
                            <label class="block mb-1 text-gray-600">ุชุงุฑูุฎ ุงููุงุชูุฑุฉ</label>
                            <input id="inv-add-invoice-date" type="date" class="w-full border rounded-lg px-3 py-2">
                        </div>
                        <div>
                            <label class="block mb-1 text-gray-600">ุชุงุฑูุฎ ุงูุงุณุชุญูุงู</label>
                            <input id="inv-add-due-date" type="date" class="w-full border rounded-lg px-3 py-2">
                        </div>
                        <div>
                            <label class="block mb-1 text-gray-600">ุฅุฌูุงูู ุงููุงุชูุฑุฉ</label>
                            <input id="inv-add-total-amount" type="number" step="0.01" class="w-full border rounded-lg px-3 py-2">
                        </div>
                        <div class="md:col-span-2">
                            <label class="block mb-1 text-gray-600">ูุตู ุงูุจูุฏ</label>
                            <input id="inv-add-line-desc" type="text" class="w-full border rounded-lg px-3 py-2" placeholder="ุฎุฏูุฉ ุฃู ููุชุฌ">
                        </div>
                        <div class="md:col-span-2">
                            <label class="block mb-1 text-gray-600">ููุงุญุธุงุช</label>
                            <textarea id="inv-add-notes" class="w-full border rounded-lg px-3 py-2" rows="2"></textarea>
                        </div>
                    </div>
                    <div class="p-5 border-t flex items-center justify-end gap-2">
                        <button onclick="this.closest('.modal-overlay').remove()" class="px-4 py-2 rounded-lg border">ุฅูุบุงุก</button>
                        <button onclick="submitAddInvoice()" class="px-4 py-2 rounded-lg bg-indigo-600 text-white">ุญูุธ</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function openViewInvoice(invoiceId) {
            const invoice = invoices.find(r => r.invoice_id === invoiceId);
            if (!invoice) return;
            const modal = document.createElement('div');
            modal.className = 'modal-overlay fixed inset-0 bg-black/40 flex items-start justify-center z-50 p-4 overflow-y-auto';
            const details = [
                ['ุฑูู ุงููุงุชูุฑุฉ', invoice.invoice_number],
                ['ุชุงุฑูุฎ ุงููุงุชูุฑุฉ', formatDate(invoice.invoice_date)],
                ['ุชุงุฑูุฎ ุงูุงุณุชุญูุงู', formatDate(invoice.due_date)],
                ['ุงุณู ุงูุนููู', invoice.customer_name_ar || invoice.customer_name],
                ['ุฅุฌูุงูู ุงููุงุชูุฑุฉ', formatMoney(invoice.total_amount)],
                ['ุงููุฏููุน', formatMoney(invoice.paid_amount)],
                ['ุงููุชุจูู', formatMoney(invoice.remaining_amount)],
                ['ุญุงูุฉ ุงููุงุชูุฑุฉ', translateInvoiceStatus(invoice.status)],
                ['ุญุงูุฉ ุงูุณุฏุงุฏ', translatePaymentStatus(invoice.payment_status)]
            ];
            modal.innerHTML = `
                <div class="bg-white rounded-2xl shadow-2xl w-full max-w-xl my-6">
                    <div class="p-5 border-b flex items-center justify-between">
                        <h3 class="font-bold text-lg">ุชูุงุตูู ุงููุงุชูุฑุฉ</h3>
                        <button onclick="this.closest('.modal-overlay').remove()" class="text-gray-500 hover:text-gray-700"><i class="fas fa-times"></i></button>
                    </div>
                    <div class="p-5 space-y-2 text-sm">
                        ${details.map(([label, value]) => `
                            <div class="flex items-center justify-between border-b pb-2">
                                <span class="font-semibold text-gray-700">${label}</span>
                                <span class="text-gray-900">${value ?? '-'}</span>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function openEditInvoice(invoiceId) {
            const invoice = invoices.find(r => r.invoice_id === invoiceId);
            if (!invoice) return;
            const modal = document.createElement('div');
            modal.className = 'modal-overlay fixed inset-0 bg-black/40 flex items-start justify-center z-50 p-4 overflow-y-auto';
            modal.innerHTML = `
                <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl my-6">
                    <div class="p-5 border-b flex items-center justify-between">
                        <h3 class="font-bold text-lg">ุชุนุฏูู ูุงุชูุฑุฉ</h3>
                        <button onclick="this.closest('.modal-overlay').remove()" class="text-gray-500 hover:text-gray-700"><i class="fas fa-times"></i></button>
                    </div>
                    <div class="p-5 grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                        <div>
                            <label class="block mb-1 text-gray-600">ุชุงุฑูุฎ ุงููุงุชูุฑุฉ</label>
                            <input type="date" class="w-full border rounded-lg px-3 py-2 bg-gray-50" value="${invoice.invoice_date ? new Date(invoice.invoice_date).toISOString().slice(0,10) : ''}" disabled>
                        </div>
                        <div>
                            <label class="block mb-1 text-gray-600">ุชุงุฑูุฎ ุงูุงุณุชุญูุงู</label>
                            <input id="inv-edit-due-date" type="date" class="w-full border rounded-lg px-3 py-2" value="${invoice.due_date ? new Date(invoice.due_date).toISOString().slice(0,10) : ''}">
                        </div>
                        <div>
                            <label class="block mb-1 text-gray-600">ุฅุฌูุงูู ุงููุงุชูุฑุฉ</label>
                            <input id="inv-edit-total-amount" type="number" step="0.01" class="w-full border rounded-lg px-3 py-2" value="${invoice.total_amount ?? 0}">
                        </div>
                        <div>
                            <label class="block mb-1 text-gray-600">ุญุงูุฉ ุงููุงุชูุฑุฉ</label>
                            <select id="inv-edit-status" class="w-full border rounded-lg px-3 py-2">
                                ${buildSelectOptions(Object.values(INVOICE_STATUS_LABELS), translateInvoiceStatus(invoice.status))}
                            </select>
                        </div>
                        <div class="md:col-span-2">
                            <label class="block mb-1 text-gray-600">ููุงุญุธุงุช</label>
                            <textarea id="inv-edit-notes" class="w-full border rounded-lg px-3 py-2" rows="2">${invoice.notes ?? ''}</textarea>
                        </div>
                    </div>
                    <div class="p-5 border-t flex items-center justify-end gap-2">
                        <button onclick="this.closest('.modal-overlay').remove()" class="px-4 py-2 rounded-lg border">ุฅูุบุงุก</button>
                        <button onclick="submitEditInvoice(${invoiceId})" class="px-4 py-2 rounded-lg bg-indigo-600 text-white">ุญูุธ</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        async function submitAddInvoice() {
            const customerIdValue = document.getElementById('inv-add-customer-id').value;
            const invoiceDateValue = document.getElementById('inv-add-invoice-date').value;
            const dueDateValue = document.getElementById('inv-add-due-date').value;
            const totalValue = parseFloat(document.getElementById('inv-add-total-amount').value || 0);
            const descValue = document.getElementById('inv-add-line-desc').value.trim() || 'ุฎุฏูุฉ';

            if (!customerIdValue) {
                alert('ุงุฎุชุฑ ุงูุนููู ุฃููุงู');
                return;
            }
            if (!invoiceDateValue || !dueDateValue) {
                alert('ุฃุฏุฎู ุชุงุฑูุฎ ุงููุงุชูุฑุฉ ูุชุงุฑูุฎ ุงูุงุณุชุญูุงู');
                return;
            }
            if (!Number.isFinite(totalValue) || totalValue <= 0) {
                alert('ุฅุฌูุงูู ุงููุงุชูุฑุฉ ูุฌุจ ุฃู ูููู ุฃูุจุฑ ูู ุตูุฑ');
                return;
            }

            const payload = {
                customer_id: Number(customerIdValue),
                invoice_date: invoiceDateValue,
                due_date: dueDateValue,
                entity_type: ENTITY_TYPE,
                entity_id: ENTITY_ID,
                allow_partial_payment: true,
                allow_installments: false,
                notes: document.getElementById('inv-add-notes').value,
                lines: [
                    {
                        description: descValue,
                        quantity: 1,
                        unit_price: totalValue,
                        tax_percentage: 0,
                        discount_percentage: 0
                    }
                ]
            };

            const res = await fetch(`${API_BASE}/finance/invoices`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', ...(window.getFinanceHeaders ? window.getFinanceHeaders() : {}) },
                body: JSON.stringify(payload)
            });

            if (res.ok) {
                document.querySelector('.modal-overlay')?.remove();
                await loadData();
            } else {
                let message = 'ุชุนุฐุฑ ุฅุถุงูุฉ ุงููุงุชูุฑุฉ';
                try {
                    const data = await res.json();
                    if (data && data.error) message = data.error;
                } catch (e) {
                    // ignore
                }
                alert(message);
            }
        }

        async function submitEditInvoice(invoiceId) {
            const payload = {
                due_date: document.getElementById('inv-edit-due-date').value,
                total_amount: parseFloat(document.getElementById('inv-edit-total-amount').value || 0),
                status: normalizeInvoiceStatus(document.getElementById('inv-edit-status').value),
                notes: document.getElementById('inv-edit-notes').value
            };

            const res = await fetch(`${API_BASE}/finance/invoices/${invoiceId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json', ...(window.getFinanceHeaders ? window.getFinanceHeaders() : {}) },
                body: JSON.stringify(payload)
            });

            if (res.ok) {
                document.querySelector('.modal-overlay')?.remove();
                await loadData();
            } else {
                let message = 'ุชุนุฐุฑ ุชุญุฏูุซ ุงููุงุชูุฑุฉ';
                try {
                    const data = await res.json();
                    if (data && data.error) message = data.error;
                } catch (e) {
                    // ignore
                }
                alert(message);
            }
        }

        async function deleteInvoice(invoiceId) {
            if (!confirm('ูู ุชุฑูุฏ ุญุฐู ูุฐู ุงููุงุชูุฑุฉุ')) return;
            const res = await fetch(`${API_BASE}/finance/invoices/${invoiceId}`, {
                method: 'DELETE',
                headers: window.getFinanceHeaders ? window.getFinanceHeaders() : {}
            });

            if (res.ok) {
                await loadData();
            } else {
                let message = 'ุชุนุฐุฑ ุญุฐู ุงููุงุชูุฑุฉ';
                try {
                    const data = await res.json();
                    if (data && data.error) message = data.error;
                } catch (e) {
                    // ignore
                }
                alert(message);
            }
        }

        function openAddPayment() {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay fixed inset-0 bg-black/40 flex items-start justify-center z-50 p-4 overflow-y-auto';
            modal.innerHTML = `
                <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl my-6">
                    <div class="p-5 border-b flex items-center justify-between">
                        <h3 class="font-bold text-lg">ุฅุถุงูุฉ ุฏูุนุฉ</h3>
                        <button onclick="this.closest('.modal-overlay').remove()" class="text-gray-500 hover:text-gray-700"><i class="fas fa-times"></i></button>
                    </div>
                    <div class="p-5 grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                        <div>
                            <label class="block mb-1 text-gray-600">ุงูุนููู</label>
                            <select id="pay-add-customer-id" class="w-full border rounded-lg px-3 py-2">
                                ${buildCustomerOptions()}
                            </select>
                        </div>
                        <div>
                            <label class="block mb-1 text-gray-600">ุชุงุฑูุฎ ุงูุฏูุน</label>
                            <input id="pay-add-date" type="date" class="w-full border rounded-lg px-3 py-2">
                        </div>
                        <div>
                            <label class="block mb-1 text-gray-600">ุงููุจูุบ</label>
                            <input id="pay-add-amount" type="number" step="0.01" class="w-full border rounded-lg px-3 py-2">
                        </div>
                        <div>
                            <label class="block mb-1 text-gray-600">ุทุฑููุฉ ุงูุฏูุน</label>
                            <select id="pay-add-method" class="w-full border rounded-lg px-3 py-2">
                                ${buildSelectOptions(Object.values(PAYMENT_METHOD_LABELS), 'ุชุญููู ุจููู')}
                            </select>
                        </div>
                        <div>
                            <label class="block mb-1 text-gray-600">ููุน ุงูุฏูุน</label>
                            <select id="pay-add-type" class="w-full border rounded-lg px-3 py-2">
                                ${buildSelectOptions(Object.values(PAYMENT_TYPE_LABELS), 'ูุงููุฉ')}
                            </select>
                        </div>
                        <div class="md:col-span-2">
                            <label class="block mb-1 text-gray-600">ููุงุญุธุงุช</label>
                            <textarea id="pay-add-notes" class="w-full border rounded-lg px-3 py-2" rows="2"></textarea>
                        </div>
                    </div>
                    <div class="p-5 border-t flex items-center justify-end gap-2">
                        <button onclick="this.closest('.modal-overlay').remove()" class="px-4 py-2 rounded-lg border">ุฅูุบุงุก</button>
                        <button onclick="submitAddPayment()" class="px-4 py-2 rounded-lg bg-emerald-600 text-white">ุญูุธ</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function openViewPayment(paymentId) {
            const payment = payments.find(r => r.payment_id === paymentId);
            if (!payment) return;
            const modal = document.createElement('div');
            modal.className = 'modal-overlay fixed inset-0 bg-black/40 flex items-start justify-center z-50 p-4 overflow-y-auto';
            const details = [
                ['ุฑูู ุงูุฏูุนุฉ', payment.payment_number],
                ['ุชุงุฑูุฎ ุงูุฏูุน', formatDate(payment.payment_date)],
                ['ุงุณู ุงูุนููู', payment.customer_name_ar || payment.customer_name],
                ['ูููุฉ ุงูุฏูุน', formatMoney(payment.payment_amount)],
                ['ุทุฑููุฉ ุงูุฏูุน', translatePaymentMethod(payment.payment_method)],
                ['ููุน ุงูุฏูุน', translatePaymentType(payment.payment_type)],
                ['ุงูุญุงูุฉ', translatePaymentExecutionStatus(payment.status)]
            ];
            modal.innerHTML = `
                <div class="bg-white rounded-2xl shadow-2xl w-full max-w-xl my-6">
                    <div class="p-5 border-b flex items-center justify-between">
                        <h3 class="font-bold text-lg">ุชูุงุตูู ุงูุฏูุนุฉ</h3>
                        <button onclick="this.closest('.modal-overlay').remove()" class="text-gray-500 hover:text-gray-700"><i class="fas fa-times"></i></button>
                    </div>
                    <div class="p-5 space-y-2 text-sm">
                        ${details.map(([label, value]) => `
                            <div class="flex items-center justify-between border-b pb-2">
                                <span class="font-semibold text-gray-700">${label}</span>
                                <span class="text-gray-900">${value ?? '-'}</span>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function openEditPayment(paymentId) {
            const payment = payments.find(r => r.payment_id === paymentId);
            if (!payment) return;
            const modal = document.createElement('div');
            modal.className = 'modal-overlay fixed inset-0 bg-black/40 flex items-start justify-center z-50 p-4 overflow-y-auto';
            modal.innerHTML = `
                <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl my-6">
                    <div class="p-5 border-b flex items-center justify-between">
                        <h3 class="font-bold text-lg">ุชุนุฏูู ุฏูุนุฉ</h3>
                        <button onclick="this.closest('.modal-overlay').remove()" class="text-gray-500 hover:text-gray-700"><i class="fas fa-times"></i></button>
                    </div>
                    <div class="p-5 grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                        <div>
                            <label class="block mb-1 text-gray-600">ุชุงุฑูุฎ ุงูุฏูุน</label>
                            <input id="pay-edit-date" type="date" class="w-full border rounded-lg px-3 py-2" value="${payment.payment_date ? new Date(payment.payment_date).toISOString().slice(0,10) : ''}">
                        </div>
                        <div>
                            <label class="block mb-1 text-gray-600">ุงููุจูุบ</label>
                            <input id="pay-edit-amount" type="number" step="0.01" class="w-full border rounded-lg px-3 py-2" value="${payment.payment_amount ?? 0}">
                        </div>
                        <div>
                            <label class="block mb-1 text-gray-600">ุทุฑููุฉ ุงูุฏูุน</label>
                            <select id="pay-edit-method" class="w-full border rounded-lg px-3 py-2">
                                ${buildSelectOptions(Object.values(PAYMENT_METHOD_LABELS), translatePaymentMethod(payment.payment_method))}
                            </select>
                        </div>
                        <div>
                            <label class="block mb-1 text-gray-600">ุงูุญุงูุฉ</label>
                            <select id="pay-edit-status" class="w-full border rounded-lg px-3 py-2">
                                ${buildSelectOptions(Object.values(PAYMENT_EXEC_STATUS_LABELS), translatePaymentExecutionStatus(payment.status))}
                            </select>
                        </div>
                        <div class="md:col-span-2">
                            <label class="block mb-1 text-gray-600">ููุงุญุธุงุช</label>
                            <textarea id="pay-edit-notes" class="w-full border rounded-lg px-3 py-2" rows="2">${payment.notes ?? ''}</textarea>
                        </div>
                    </div>
                    <div class="p-5 border-t flex items-center justify-end gap-2">
                        <button onclick="this.closest('.modal-overlay').remove()" class="px-4 py-2 rounded-lg border">ุฅูุบุงุก</button>
                        <button onclick="submitEditPayment(${paymentId})" class="px-4 py-2 rounded-lg bg-emerald-600 text-white">ุญูุธ</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        async function submitAddPayment() {
            const customerIdValue = document.getElementById('pay-add-customer-id').value;
            const dateValue = document.getElementById('pay-add-date').value;
            const amountValue = parseFloat(document.getElementById('pay-add-amount').value || 0);
            const methodValue = normalizePaymentMethod(document.getElementById('pay-add-method').value);
            const typeValue = normalizePaymentType(document.getElementById('pay-add-type').value);

            if (!customerIdValue) {
                alert('ุงุฎุชุฑ ุงูุนููู ุฃููุงู');
                return;
            }
            if (!dateValue) {
                alert('ุฃุฏุฎู ุชุงุฑูุฎ ุงูุฏูุน');
                return;
            }
            if (!Number.isFinite(amountValue) || amountValue <= 0) {
                alert('ูููุฉ ุงูุฏูุน ูุฌุจ ุฃู ุชููู ุฃูุจุฑ ูู ุตูุฑ');
                return;
            }
            if (!methodValue) {
                alert('ุงุฎุชุฑ ุทุฑููุฉ ุงูุฏูุน');
                return;
            }

            const payload = {
                customer_id: Number(customerIdValue),
                payment_date: dateValue,
                payment_amount: amountValue,
                payment_method: methodValue,
                payment_type: typeValue || 'FULL',
                entity_type: ENTITY_TYPE,
                entity_id: ENTITY_ID,
                notes: document.getElementById('pay-add-notes').value
            };

            const res = await fetch(`${API_BASE}/finance/payments`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', ...(window.getFinanceHeaders ? window.getFinanceHeaders() : {}) },
                body: JSON.stringify(payload)
            });

            if (res.ok) {
                document.querySelector('.modal-overlay')?.remove();
                await loadData();
            } else {
                let message = 'ุชุนุฐุฑ ุฅุถุงูุฉ ุงูุฏูุนุฉ';
                try {
                    const data = await res.json();
                    if (data && data.error) message = data.error;
                } catch (e) {
                    // ignore
                }
                alert(message);
            }
        }

        async function submitEditPayment(paymentId) {
            const payload = {
                payment_date: document.getElementById('pay-edit-date').value,
                payment_amount: parseFloat(document.getElementById('pay-edit-amount').value || 0),
                payment_method: normalizePaymentMethod(document.getElementById('pay-edit-method').value),
                status: normalizePaymentExecutionStatus(document.getElementById('pay-edit-status').value),
                notes: document.getElementById('pay-edit-notes').value
            };

            const res = await fetch(`${API_BASE}/finance/payments/${paymentId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json', ...(window.getFinanceHeaders ? window.getFinanceHeaders() : {}) },
                body: JSON.stringify(payload)
            });

            if (res.ok) {
                document.querySelector('.modal-overlay')?.remove();
                await loadData();
            } else {
                let message = 'ุชุนุฐุฑ ุชุญุฏูุซ ุงูุฏูุนุฉ';
                try {
                    const data = await res.json();
                    if (data && data.error) message = data.error;
                } catch (e) {
                    // ignore
                }
                alert(message);
            }
        }

        async function deletePayment(paymentId) {
            if (!confirm('ูู ุชุฑูุฏ ุญุฐู ูุฐู ุงูุฏูุนุฉุ')) return;
            const res = await fetch(`${API_BASE}/finance/payments/${paymentId}`, {
                method: 'DELETE',
                headers: window.getFinanceHeaders ? window.getFinanceHeaders() : {}
            });

            if (res.ok) {
                await loadData();
            } else {
                let message = 'ุชุนุฐุฑ ุญุฐู ุงูุฏูุนุฉ';
                try {
                    const data = await res.json();
                    if (data && data.error) message = data.error;
                } catch (e) {
                    // ignore
                }
                alert(message);
            }
        }

        function openAddPlan() {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay fixed inset-0 bg-black/40 flex items-start justify-center z-50 p-4 overflow-y-auto';
            modal.innerHTML = `
                <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl my-6">
                    <div class="p-5 border-b flex items-center justify-between">
                        <h3 class="font-bold text-lg">ุฅุถุงูุฉ ุฎุทุฉ ุณุฏุงุฏ</h3>
                        <button onclick="this.closest('.modal-overlay').remove()" class="text-gray-500 hover:text-gray-700"><i class="fas fa-times"></i></button>
                    </div>
                    <div class="p-5 grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                        <div>
                            <label class="block mb-1 text-gray-600">ุฑูู ุงูุฎุทุฉ</label>
                            <input id="plan-add-number" type="text" class="w-full border rounded-lg px-3 py-2" placeholder="ุฎุทุฉ-0001">
                        </div>
                        <div>
                            <label class="block mb-1 text-gray-600">ุงูุนููู</label>
                            <select id="plan-add-customer-id" class="w-full border rounded-lg px-3 py-2">
                                ${buildCustomerOptions()}
                            </select>
                        </div>
                        <div>
                            <label class="block mb-1 text-gray-600">ุงููุงุชูุฑุฉ</label>
                            <select id="plan-add-invoice-id" class="w-full border rounded-lg px-3 py-2">
                                ${buildInvoiceOptions()}
                            </select>
                        </div>
                        <div>
                            <label class="block mb-1 text-gray-600">ุชุงุฑูุฎ ุงูุจุฏุงูุฉ</label>
                            <input id="plan-add-start" type="date" class="w-full border rounded-lg px-3 py-2">
                        </div>
                        <div>
                            <label class="block mb-1 text-gray-600">ุชุงุฑูุฎ ุงูููุงูุฉ</label>
                            <input id="plan-add-end" type="date" class="w-full border rounded-lg px-3 py-2">
                        </div>
                        <div>
                            <label class="block mb-1 text-gray-600">ุฅุฌูุงูู ุงูุฎุทุฉ</label>
                            <input id="plan-add-total" type="number" step="0.01" class="w-full border rounded-lg px-3 py-2">
                        </div>
                        <div>
                            <label class="block mb-1 text-gray-600">ุนุฏุฏ ุงูุฏูุนุงุช</label>
                            <input id="plan-add-installments" type="number" class="w-full border rounded-lg px-3 py-2">
                        </div>
                        <div>
                            <label class="block mb-1 text-gray-600">ูููุฉ ุงูุฏูุนุฉ</label>
                            <input id="plan-add-installment-amount" type="number" step="0.01" class="w-full border rounded-lg px-3 py-2">
                        </div>
                        <div>
                            <label class="block mb-1 text-gray-600">ุชูุฑุงุฑ ุงูุฏูุนุฉ</label>
                            <select id="plan-add-frequency" class="w-full border rounded-lg px-3 py-2">
                                ${buildSelectOptions(Object.values(INSTALLMENT_FREQUENCY_LABELS), 'ุดูุฑู')}
                            </select>
                        </div>
                        <div>
                            <label class="block mb-1 text-gray-600">ุญุงูุฉ ุงูุฎุทุฉ</label>
                            <select id="plan-add-status" class="w-full border rounded-lg px-3 py-2">
                                ${buildSelectOptions(Object.values(PLAN_STATUS_LABELS), 'ูุดุทุฉ')}
                            </select>
                        </div>
                    </div>
                    <div class="p-5 border-t flex items-center justify-end gap-2">
                        <button onclick="this.closest('.modal-overlay').remove()" class="px-4 py-2 rounded-lg border">ุฅูุบุงุก</button>
                        <button onclick="submitAddPlan()" class="px-4 py-2 rounded-lg bg-violet-600 text-white">ุญูุธ</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function openViewPlan(planId) {
            const plan = plans.find(r => r.plan_id === planId);
            if (!plan) return;
            const modal = document.createElement('div');
            modal.className = 'modal-overlay fixed inset-0 bg-black/40 flex items-start justify-center z-50 p-4 overflow-y-auto';
            const details = [
                ['ุฑูู ุงูุฎุทุฉ', plan.plan_number],
                ['ุงูุนููู', plan.customer_name_ar || plan.customer_name_en],
                ['ุงููุงุชูุฑุฉ', plan.invoice_number],
                ['ุฅุฌูุงูู ุงูุฎุทุฉ', formatMoney(plan.total_amount)],
                ['ุงููุฏููุน', formatMoney(plan.paid_amount)],
                ['ุงููุชุจูู', formatMoney(plan.remaining_amount)],
                ['ุญุงูุฉ ุงูุฎุทุฉ', translatePlanStatus(plan.status)],
                ['ุชูุฑุงุฑ ุงูุฏูุนุฉ', translateInstallmentFrequency(plan.installment_frequency)]
            ];
            modal.innerHTML = `
                <div class="bg-white rounded-2xl shadow-2xl w-full max-w-xl my-6">
                    <div class="p-5 border-b flex items-center justify-between">
                        <h3 class="font-bold text-lg">ุชูุงุตูู ุฎุทุฉ ุงูุณุฏุงุฏ</h3>
                        <button onclick="this.closest('.modal-overlay').remove()" class="text-gray-500 hover:text-gray-700"><i class="fas fa-times"></i></button>
                    </div>
                    <div class="p-5 space-y-2 text-sm">
                        ${details.map(([label, value]) => `
                            <div class="flex items-center justify-between border-b pb-2">
                                <span class="font-semibold text-gray-700">${label}</span>
                                <span class="text-gray-900">${value ?? '-'}</span>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function openEditPlan(planId) {
            const plan = plans.find(r => r.plan_id === planId);
            if (!plan) return;
            const modal = document.createElement('div');
            modal.className = 'modal-overlay fixed inset-0 bg-black/40 flex items-start justify-center z-50 p-4 overflow-y-auto';
            modal.innerHTML = `
                <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl my-6">
                    <div class="p-5 border-b flex items-center justify-between">
                        <h3 class="font-bold text-lg">ุชุนุฏูู ุฎุทุฉ ุณุฏุงุฏ</h3>
                        <button onclick="this.closest('.modal-overlay').remove()" class="text-gray-500 hover:text-gray-700"><i class="fas fa-times"></i></button>
                    </div>
                    <div class="p-5 grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                        <div>
                            <label class="block mb-1 text-gray-600">ุฑูู ุงูุฎุทุฉ</label>
                            <input id="plan-edit-number" type="text" class="w-full border rounded-lg px-3 py-2" value="${plan.plan_number ?? ''}">
                        </div>
                        <div>
                            <label class="block mb-1 text-gray-600">ุงูุนููู</label>
                            <select id="plan-edit-customer-id" class="w-full border rounded-lg px-3 py-2">
                                ${buildCustomerOptions(plan.customer_id)}
                            </select>
                        </div>
                        <div>
                            <label class="block mb-1 text-gray-600">ุงููุงุชูุฑุฉ</label>
                            <select id="plan-edit-invoice-id" class="w-full border rounded-lg px-3 py-2">
                                ${buildInvoiceOptions(plan.invoice_id)}
                            </select>
                        </div>
                        <div>
                            <label class="block mb-1 text-gray-600">ุชุงุฑูุฎ ุงูุจุฏุงูุฉ</label>
                            <input id="plan-edit-start" type="date" class="w-full border rounded-lg px-3 py-2" value="${plan.start_date ? new Date(plan.start_date).toISOString().slice(0,10) : ''}">
                        </div>
                        <div>
                            <label class="block mb-1 text-gray-600">ุชุงุฑูุฎ ุงูููุงูุฉ</label>
                            <input id="plan-edit-end" type="date" class="w-full border rounded-lg px-3 py-2" value="${plan.end_date ? new Date(plan.end_date).toISOString().slice(0,10) : ''}">
                        </div>
                        <div>
                            <label class="block mb-1 text-gray-600">ุฅุฌูุงูู ุงูุฎุทุฉ</label>
                            <input id="plan-edit-total" type="number" step="0.01" class="w-full border rounded-lg px-3 py-2" value="${plan.total_amount ?? 0}">
                        </div>
                        <div>
                            <label class="block mb-1 text-gray-600">ุงููุฏููุน</label>
                            <input id="plan-edit-paid" type="number" step="0.01" class="w-full border rounded-lg px-3 py-2" value="${plan.paid_amount ?? 0}">
                        </div>
                        <div>
                            <label class="block mb-1 text-gray-600">ุนุฏุฏ ุงูุฏูุนุงุช</label>
                            <input id="plan-edit-installments" type="number" class="w-full border rounded-lg px-3 py-2" value="${plan.number_of_installments ?? 0}">
                        </div>
                        <div>
                            <label class="block mb-1 text-gray-600">ูููุฉ ุงูุฏูุนุฉ</label>
                            <input id="plan-edit-installment-amount" type="number" step="0.01" class="w-full border rounded-lg px-3 py-2" value="${plan.installment_amount ?? 0}">
                        </div>
                        <div>
                            <label class="block mb-1 text-gray-600">ุชูุฑุงุฑ ุงูุฏูุนุฉ</label>
                            <select id="plan-edit-frequency" class="w-full border rounded-lg px-3 py-2">
                                ${buildSelectOptions(Object.values(INSTALLMENT_FREQUENCY_LABELS), translateInstallmentFrequency(plan.installment_frequency))}
                            </select>
                        </div>
                        <div>
                            <label class="block mb-1 text-gray-600">ุญุงูุฉ ุงูุฎุทุฉ</label>
                            <select id="plan-edit-status" class="w-full border rounded-lg px-3 py-2">
                                ${buildSelectOptions(Object.values(PLAN_STATUS_LABELS), translatePlanStatus(plan.status))}
                            </select>
                        </div>
                    </div>
                    <div class="p-5 border-t flex items-center justify-end gap-2">
                        <button onclick="this.closest('.modal-overlay').remove()" class="px-4 py-2 rounded-lg border">ุฅูุบุงุก</button>
                        <button onclick="submitEditPlan(${planId})" class="px-4 py-2 rounded-lg bg-violet-600 text-white">ุญูุธ</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        async function submitAddPlan() {
            const customerIdValue = document.getElementById('plan-add-customer-id').value;
            const invoiceIdValue = document.getElementById('plan-add-invoice-id').value;
            const startValue = document.getElementById('plan-add-start').value;
            const totalValue = parseFloat(document.getElementById('plan-add-total').value || 0);
            const installmentsValue = parseInt(document.getElementById('plan-add-installments').value || 0, 10);
            const installmentAmountValue = parseFloat(document.getElementById('plan-add-installment-amount').value || 0);
            const planNumberValue = document.getElementById('plan-add-number').value.trim() || `PLAN-${Date.now()}`;

            if (!customerIdValue) {
                alert('ุงุฎุชุฑ ุงูุนููู ุฃููุงู');
                return;
            }
            if (!invoiceIdValue) {
                alert('ุงุฎุชุฑ ุงููุงุชูุฑุฉ ุฃููุงู');
                return;
            }
            if (!startValue) {
                alert('ุฃุฏุฎู ุชุงุฑูุฎ ุจุฏุงูุฉ ุงูุฎุทุฉ');
                return;
            }
            if (!Number.isFinite(totalValue) || totalValue <= 0) {
                alert('ุฅุฌูุงูู ุงูุฎุทุฉ ูุฌุจ ุฃู ูููู ุฃูุจุฑ ูู ุตูุฑ');
                return;
            }
            if (!Number.isFinite(installmentsValue) || installmentsValue <= 0) {
                alert('ุนุฏุฏ ุงูุฏูุนุงุช ูุฌุจ ุฃู ูููู ุฃูุจุฑ ูู ุตูุฑ');
                return;
            }
            if (!Number.isFinite(installmentAmountValue) || installmentAmountValue <= 0) {
                alert('ูููุฉ ุงูุฏูุนุฉ ูุฌุจ ุฃู ุชููู ุฃูุจุฑ ูู ุตูุฑ');
                return;
            }

            const payload = {
                plan_number: planNumberValue,
                customer_id: Number(customerIdValue),
                invoice_id: Number(invoiceIdValue),
                start_date: startValue,
                end_date: document.getElementById('plan-add-end').value || null,
                total_amount: totalValue,
                paid_amount: 0,
                number_of_installments: installmentsValue,
                installment_amount: installmentAmountValue,
                installment_frequency: normalizeInstallmentFrequency(document.getElementById('plan-add-frequency').value),
                status: normalizePlanStatus(document.getElementById('plan-add-status').value),
                entity_type: ENTITY_TYPE,
                entity_id: ENTITY_ID,
                created_by: 'ููุญุฉ ุงูุชุญูู'
            };

            const res = await fetch(`${API_BASE}/finance/payment-plans`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', ...(window.getFinanceHeaders ? window.getFinanceHeaders() : {}) },
                body: JSON.stringify(payload)
            });

            if (res.ok) {
                document.querySelector('.modal-overlay')?.remove();
                await loadData();
            } else {
                let message = 'ุชุนุฐุฑ ุฅุถุงูุฉ ุงูุฎุทุฉ';
                try {
                    const data = await res.json();
                    if (data && data.error) message = data.error;
                } catch (e) {
                    // ignore
                }
                alert(message);
            }
        }

        async function submitEditPlan(planId) {
            const payload = {
                plan_number: document.getElementById('plan-edit-number').value.trim(),
                customer_id: Number(document.getElementById('plan-edit-customer-id').value),
                invoice_id: Number(document.getElementById('plan-edit-invoice-id').value),
                start_date: document.getElementById('plan-edit-start').value,
                end_date: document.getElementById('plan-edit-end').value || null,
                total_amount: parseFloat(document.getElementById('plan-edit-total').value || 0),
                paid_amount: parseFloat(document.getElementById('plan-edit-paid').value || 0),
                number_of_installments: parseInt(document.getElementById('plan-edit-installments').value || 0, 10),
                installment_amount: parseFloat(document.getElementById('plan-edit-installment-amount').value || 0),
                installment_frequency: normalizeInstallmentFrequency(document.getElementById('plan-edit-frequency').value),
                status: normalizePlanStatus(document.getElementById('plan-edit-status').value),
                entity_type: ENTITY_TYPE,
                entity_id: ENTITY_ID
            };

            const res = await fetch(`${API_BASE}/finance/payment-plans/${planId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json', ...(window.getFinanceHeaders ? window.getFinanceHeaders() : {}) },
                body: JSON.stringify(payload)
            });

            if (res.ok) {
                document.querySelector('.modal-overlay')?.remove();
                await loadData();
            } else {
                let message = 'ุชุนุฐุฑ ุชุญุฏูุซ ุงูุฎุทุฉ';
                try {
                    const data = await res.json();
                    if (data && data.error) message = data.error;
                } catch (e) {
                    // ignore
                }
                alert(message);
            }
        }

        async function deletePlan(planId) {
            if (!confirm('ูู ุชุฑูุฏ ุญุฐู ูุฐู ุงูุฎุทุฉุ')) return;
            const res = await fetch(`${API_BASE}/finance/payment-plans/${planId}`, {
                method: 'DELETE',
                headers: window.getFinanceHeaders ? window.getFinanceHeaders() : {}
            });

            if (res.ok) {
                await loadData();
            } else {
                let message = 'ุชุนุฐุฑ ุญุฐู ุงูุฎุทุฉ';
                try {
                    const data = await res.json();
                    if (data && data.error) message = data.error;
                } catch (e) {
                    // ignore
                }
                alert(message);
            }
        }

        function isWithinDays(dateValue, days) {
            if (!dateValue) return false;
            const target = new Date(dateValue);
            const now = new Date();
            const diff = (now - target) / (1000 * 60 * 60 * 24);
            return diff <= days;
        }

        function diffDays(start, end) {
            if (!start || !end) return 0;
            return (new Date(end) - new Date(start)) / (1000 * 60 * 60 * 24);
        }

        function groupSum(rows, key, valueKey) {
            return rows.reduce((acc, row) => {
                const label = row[key] ?? 'ุบูุฑ ูุญุฏุฏ';
                acc[label] = (acc[label] || 0) + parseFloat(row[valueKey] || 0);
                return acc;
            }, {});
        }

        function formatMoney(value) {
            const num = parseFloat(value || 0);
            return num.toLocaleString('ar-SA') + ' ุฑ.ุณ';
        }

        function formatDate(value) {
            if (!value) return '-';
            return new Date(value).toLocaleDateString('ar-SA');
        }

        function formatDateTime(value) {
            if (!value) return '-';
            return new Date(value).toLocaleString('ar-SA');
        }

        function formatBoolean(value) {
            if (value === null || value === undefined) return '-';
            return value ? 'ูุนู' : 'ูุง';
        }

        function downloadCSV() {
            const rows = [];
            rows.push(['AR_AGING_TABLE']);
            rows.push(['invoice_id','invoice_number','invoice_date','due_date','customer_id','customer_code','customer_name_ar','customer_name_en','customer_type','total_amount','paid_amount','remaining_amount','status','payment_status','days_overdue','aging_category','entity_type','entity_id','branch_id','incubator_id']);
            arRows.forEach(r => rows.push([
                r.invoice_id, r.invoice_number, r.invoice_date, r.due_date, r.customer_id, r.customer_code,
                r.customer_name_ar, r.customer_name_en, r.customer_type, r.total_amount, r.paid_amount,
                r.remaining_amount, r.status, r.payment_status, r.days_overdue, r.aging_category, r.entity_type,
                r.entity_id, r.branch_id, r.incubator_id
            ]));

            rows.push([]);
            rows.push(['INVOICES_TABLE']);
            rows.push(['invoice_id','invoice_number','invoice_date','due_date','customer_id','customer_name','customer_name_ar','customer_code','risk_level','subtotal','tax_amount','discount_amount','total_amount','paid_amount','remaining_amount','status','payment_status','allow_partial_payment','allow_installments','program_id','service_id','entity_type','entity_id','branch_id','incubator_id','platform_id','office_id','journal_entry_id','notes','terms_conditions','created_at','updated_at','created_by','updated_by','cancelled_by','cancelled_at','cancelled_reason']);
            invoices.forEach(i => rows.push([
                i.invoice_id, i.invoice_number, i.invoice_date, i.due_date, i.customer_id, i.customer_name,
                i.customer_name_ar, i.customer_code, i.risk_level, i.subtotal, i.tax_amount, i.discount_amount,
                i.total_amount, i.paid_amount, i.remaining_amount, i.status, i.payment_status, i.allow_partial_payment,
                i.allow_installments, i.program_id, i.service_id, i.entity_type, i.entity_id, i.branch_id, i.incubator_id,
                i.platform_id, i.office_id, i.journal_entry_id, i.notes, i.terms_conditions, i.created_at, i.updated_at,
                i.created_by, i.updated_by, i.cancelled_by, i.cancelled_at, i.cancelled_reason
            ]));

            rows.push([]);
            rows.push(['PAYMENTS_TABLE']);
            rows.push(['payment_id','payment_number','payment_date','customer_id','customer_name','customer_name_ar','customer_code','payment_amount','payment_method','payment_type','bank_name','check_number','transaction_reference','status','entity_type','entity_id','branch_id','incubator_id','platform_id','journal_entry_id','notes','created_at','updated_at','created_by','approved_by','approved_at']);
            payments.forEach(p => rows.push([
                p.payment_id, p.payment_number, p.payment_date, p.customer_id, p.customer_name, p.customer_name_ar,
                p.customer_code, p.payment_amount, p.payment_method, p.payment_type, p.bank_name, p.check_number,
                p.transaction_reference, p.status, p.entity_type, p.entity_id, p.branch_id, p.incubator_id, p.platform_id,
                p.journal_entry_id, p.notes, p.created_at, p.updated_at, p.created_by, p.approved_by, p.approved_at
            ]));

            rows.push([]);
            rows.push(['PAYMENT_PLANS_TABLE']);
            rows.push(['plan_id','plan_number','customer_id','customer_name_ar','customer_name_en','customer_code','customer_type','invoice_id','invoice_number','invoice_date','invoice_status','invoice_payment_status','start_date','end_date','total_amount','paid_amount','remaining_amount','number_of_installments','installment_amount','installment_frequency','status','risk_score_at_creation','risk_level_at_creation','entity_type','entity_id','branch_id','incubator_id','created_at','updated_at','created_by','approved_by','approved_at']);
            plans.forEach(p => rows.push([
                p.plan_id, p.plan_number, p.customer_id, p.customer_name_ar, p.customer_name_en, p.customer_code,
                p.customer_type, p.invoice_id, p.invoice_number, p.invoice_date, p.invoice_status, p.invoice_payment_status,
                p.start_date, p.end_date, p.total_amount, p.paid_amount, p.remaining_amount, p.number_of_installments,
                p.installment_amount, p.installment_frequency, p.status, p.risk_score_at_creation, p.risk_level_at_creation,
                p.entity_type, p.entity_id, p.branch_id, p.incubator_id, p.created_at, p.updated_at, p.created_by,
                p.approved_by, p.approved_at
            ]));

            const csvContent = rows.map(r => r.map(v => `"${v ?? ''}"`).join(',')).join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'receivables-collections-report.csv';
            link.click();
            URL.revokeObjectURL(url);
        }

        function downloadJSON() {
            const payload = {
                ar_aging: arRows,
                invoices,
                payments,
                payment_plans: plans
            };
            const blob = new Blob([JSON.stringify(payload, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'receivables-collections-report.json';
            link.click();
            URL.revokeObjectURL(url);
        }

        function printReport() {
            window.print();
        }

        function refreshData() {
            loadData();
        }

        document.addEventListener('DOMContentLoaded', loadData);
    </script>
</body>
</html>
