<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ›¡ï¸ ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ù…Ø®Ø§Ø·Ø± Ø§Ù„Ø°ÙƒÙŠ - Ù†Ø¸Ø§Ù… Ù†Ø§ÙŠÙˆØ´</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Cairo', sans-serif;
            background: linear-gradient(135deg, #1e3a8a 0%, #7c3aed 100%);
            min-height: 100vh;
        }
        .card-gradient {
            background: linear-gradient(135deg, rgba(255,255,255,0.95), rgba(255,255,255,0.98));
            backdrop-filter: blur(10px);
        }
        .stat-card {
            transition: transform 0.3s, box-shadow 0.3s;
        }
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
        }
        .chart-container {
            position: relative;
            height: 280px;
        }
        .json-pill {
            max-width: 320px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
    </style>
</head>
<body>
    <div class="container mx-auto px-4 py-8">
        <div class="mb-8 text-white">
            <h1 class="text-4xl font-bold mb-2">ğŸ›¡ï¸ ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ù…Ø®Ø§Ø·Ø± Ø§Ù„Ø°ÙƒÙŠ</h1>
            <p class="text-lg opacity-90">ØªØ­Ù„ÙŠÙ„ Ø´Ø§Ù…Ù„ Ù„Ø¯Ø±Ø¬Ø§Øª Ø§Ù„Ù…Ø®Ø§Ø·Ø± ÙˆØ§Ù„ØªÙˆØµÙŠØ§Øª</p>
        </div>

        <div class="mb-6 flex gap-3 flex-wrap">
            <button onclick="downloadCSV()" class="bg-white text-purple-700 px-6 py-3 rounded-lg font-bold hover:shadow-lg transition flex items-center gap-2">
                <i class="fas fa-file-csv"></i>
                ØªÙ†Ø²ÙŠÙ„ CSV
            </button>
            <button onclick="downloadJSON()" class="bg-emerald-600 text-white px-6 py-3 rounded-lg font-bold hover:shadow-lg transition flex items-center gap-2">
                <i class="fas fa-file-code"></i>
                ØªÙ†Ø²ÙŠÙ„ JSON
            </button>
            <button onclick="printReport()" class="bg-indigo-600 text-white px-6 py-3 rounded-lg font-bold hover:shadow-lg transition flex items-center gap-2">
                <i class="fas fa-print"></i>
                Ø·Ø¨Ø§Ø¹Ø©
            </button>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div class="stat-card bg-gradient-to-br from-rose-500 to-red-600 rounded-2xl p-6 text-white shadow-xl">
                <div class="flex items-center justify-between mb-4">
                    <i class="fas fa-triangle-exclamation text-4xl opacity-70"></i>
                    <span class="text-sm opacity-90">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª</span>
                </div>
                <div id="totalScores" class="text-4xl font-bold">
                    <div class="animate-pulse">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
                </div>
            </div>
            <div class="stat-card bg-gradient-to-br from-amber-400 to-orange-600 rounded-2xl p-6 text-white shadow-xl">
                <div class="flex items-center justify-between mb-4">
                    <i class="fas fa-gauge-high text-4xl opacity-70"></i>
                    <span class="text-sm opacity-90">Ù…ØªÙˆØ³Ø· Ø§Ù„Ø¯Ø±Ø¬Ø©</span>
                </div>
                <div id="avgScore" class="text-4xl font-bold">
                    <div class="animate-pulse">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
                </div>
            </div>
            <div class="stat-card bg-gradient-to-br from-emerald-400 to-teal-600 rounded-2xl p-6 text-white shadow-xl">
                <div class="flex items-center justify-between mb-4">
                    <i class="fas fa-users text-4xl opacity-70"></i>
                    <span class="text-sm opacity-90">Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</span>
                </div>
                <div id="uniqueCustomers" class="text-4xl font-bold">
                    <div class="animate-pulse">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
                </div>
            </div>
            <div class="stat-card bg-gradient-to-br from-blue-500 to-indigo-600 rounded-2xl p-6 text-white shadow-xl">
                <div class="flex items-center justify-between mb-4">
                    <i class="fas fa-chart-line text-4xl opacity-70"></i>
                    <span class="text-sm opacity-90">Ø£Ù‚ØµÙ‰ Ø¯Ø±Ø¬Ø©</span>
                </div>
                <div id="maxScore" class="text-4xl font-bold">
                    <div class="animate-pulse">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
                </div>
            </div>
        </div>

        <div class="card-gradient rounded-2xl shadow-2xl p-6 mb-8">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-2">Ù…Ù† ØªØ§Ø±ÙŠØ®</label>
                    <input id="fromDate" type="date" class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-purple-500 outline-none" onchange="applyFilters()">
                </div>
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-2">Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ®</label>
                    <input id="toDate" type="date" class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-purple-500 outline-none" onchange="applyFilters()">
                </div>
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-2">Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ù…Ø®Ø§Ø·Ø±</label>
                    <select id="riskLevel" class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-purple-500 outline-none" onchange="applyFilters()">
                        <option value="">Ø§Ù„ÙƒÙ„</option>
                        <option value="Low">Ù…Ù†Ø®ÙØ¶</option>
                        <option value="Medium">Ù…ØªÙˆØ³Ø·</option>
                        <option value="High">Ù…Ø±ØªÙØ¹</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-2">Ø±Ù‚Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„</label>
                    <input id="customerId" type="number" placeholder="Ù…Ø«Ø§Ù„: 101" class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-purple-500 outline-none" oninput="applyFilters()">
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
            <div class="card-gradient rounded-2xl shadow-2xl p-6">
                <h3 class="text-xl font-bold text-gray-800 mb-4">ğŸ“Š ØªÙˆØ²ÙŠØ¹ Ù…Ø³ØªÙˆÙŠØ§Øª Ø§Ù„Ù…Ø®Ø§Ø·Ø±</h3>
                <div class="chart-container">
                    <canvas id="levelsChart"></canvas>
                </div>
            </div>
            <div class="card-gradient rounded-2xl shadow-2xl p-6">
                <h3 class="text-xl font-bold text-gray-800 mb-4">ğŸ“ˆ Ø§ØªØ¬Ø§Ù‡ Ø§Ù„Ø¯Ø±Ø¬Ø§Øª</h3>
                <div class="chart-container">
                    <canvas id="trendChart"></canvas>
                </div>
            </div>
        </div>

        <div class="card-gradient rounded-2xl shadow-2xl overflow-hidden">
            <div class="p-6">
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-100 text-gray-600 text-sm">
                            <tr>
                                <th class="px-4 py-3 text-right">#</th>
                                <th class="px-4 py-3 text-right">Ø¹Ù…ÙŠÙ„</th>
                                <th class="px-4 py-3 text-right">Ø§Ù„ØªÙ‚ÙŠÙŠÙ…</th>
                                <th class="px-4 py-3 text-right">Ø§Ù„Ø¯Ø±Ø¬Ø©</th>
                                <th class="px-4 py-3 text-right">Ø§Ù„Ù…Ø³ØªÙˆÙ‰</th>
                                <th class="px-4 py-3 text-right">Ø¹ÙˆØ§Ù…Ù„ Ø§Ù„Ù…Ø®Ø§Ø·Ø±</th>
                                <th class="px-4 py-3 text-right">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨</th>
                                <th class="px-4 py-3 text-right">ØªÙˆØµÙŠØ§Øª</th>
                                <th class="px-4 py-3 text-right">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ù…Ù‚ØªØ±Ø­Ø©</th>
                                <th class="px-4 py-3 text-right">Ù†ÙˆØ¹ Ø§Ù„ÙƒÙŠØ§Ù†</th>
                                <th class="px-4 py-3 text-right">Ù…Ø¹Ø±Ù Ø§Ù„ÙƒÙŠØ§Ù†</th>
                                <th class="px-4 py-3 text-right">Ù†Ø³Ø®Ø© Ø§Ù„Ù†Ù…ÙˆØ°Ø¬</th>
                                <th class="px-4 py-3 text-right">ØªÙ… Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡</th>
                            </tr>
                        </thead>
                        <tbody id="riskTable" class="text-sm divide-y divide-gray-100">
                            <tr>
                                <td colspan="13" class="px-4 py-12 text-center text-gray-500">
                                    <i class="fas fa-spinner fa-spin text-4xl mb-3 opacity-30"></i>
                                    <div>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙ‚Ø±ÙŠØ±...</div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div class="mt-4 text-sm text-gray-600" id="tableCount"></div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = window.location.origin;
        const ENTITY_ID = '1';
        let allRows = [];
        let levelsChartInstance = null;
        let trendChartInstance = null;

        async function loadReport() {
            try {
                const response = await fetch(`${API_BASE}/finance/ai-risk-scores?entity_id=${ENTITY_ID}`);
                const data = await response.json();

                if (!data.success) {
                    throw new Error(data.error || 'Failed to load report');
                }

                allRows = data.rows || [];
                renderSummary(data.summary || {});
                renderTable(allRows);
                renderCharts(data.summary || {}, allRows);
            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙ‚Ø±ÙŠØ±:', error);
                document.getElementById('riskTable').innerHTML = `
                    <tr>
                        <td colspan="13" class="px-4 py-12 text-center text-red-500">
                            <i class="fas fa-exclamation-triangle text-4xl mb-3"></i>
                            <div>ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙ‚Ø±ÙŠØ±</div>
                        </td>
                    </tr>
                `;
            }
        }

        function applyFilters() {
            const fromDate = document.getElementById('fromDate').value;
            const toDate = document.getElementById('toDate').value;
            const riskLevel = document.getElementById('riskLevel').value;
            const customerId = document.getElementById('customerId').value;

            const params = new URLSearchParams({ entity_id: ENTITY_ID });
            if (fromDate) params.append('from_date', fromDate);
            if (toDate) params.append('to_date', toDate);
            if (riskLevel) params.append('risk_level', riskLevel);
            if (customerId) params.append('customer_id', customerId);

            fetch(`${API_BASE}/finance/ai-risk-scores?${params.toString()}`)
                .then(res => res.json())
                .then(data => {
                    if (!data.success) throw new Error(data.error || 'Failed to load report');
                    allRows = data.rows || [];
                    renderSummary(data.summary || {});
                    renderTable(allRows);
                    renderCharts(data.summary || {}, allRows);
                })
                .catch(err => console.error('âŒ', err));
        }

        function renderSummary(summary) {
            document.getElementById('totalScores').textContent = summary.total_scores ?? 0;
            document.getElementById('avgScore').textContent = formatScore(summary.avg_score || 0);
            document.getElementById('uniqueCustomers').textContent = summary.unique_customers ?? 0;
            document.getElementById('maxScore').textContent = formatScore(summary.max_score || 0);
        }

        function renderTable(rows) {
            const body = rows.map(r => `
                <tr class="hover:bg-gray-50">
                    <td class="px-4 py-3 font-mono text-gray-600">${r.risk_id}</td>
                    <td class="px-4 py-3">${r.customer_id ?? '-'}</td>
                    <td class="px-4 py-3">${formatDate(r.assessment_date)}</td>
                    <td class="px-4 py-3 font-bold text-indigo-600">${formatScore(r.risk_score)}</td>
                    <td class="px-4 py-3">${renderLevel(r.risk_level)}</td>
                    <td class="px-4 py-3"><div class="json-pill">${renderJson(r.risk_factors)}</div></td>
                    <td class="px-4 py-3"><div class="json-pill">${renderJson(r.calculation_details)}</div></td>
                    <td class="px-4 py-3">${r.recommendations || '-'}</td>
                    <td class="px-4 py-3"><div class="json-pill">${renderJson(r.suggested_actions)}</div></td>
                    <td class="px-4 py-3">${r.entity_type || '-'}</td>
                    <td class="px-4 py-3">${r.entity_id || '-'}</td>
                    <td class="px-4 py-3">${r.model_version || '-'}</td>
                    <td class="px-4 py-3">${formatDateTime(r.created_at)}</td>
                </tr>
            `).join('');

            document.getElementById('riskTable').innerHTML = body.length ? body : `
                <tr>
                    <td colspan="13" class="px-4 py-12 text-center text-gray-500">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</td>
                </tr>
            `;
            document.getElementById('tableCount').textContent = `Ø¹Ø¯Ø¯ Ø§Ù„ØµÙÙˆÙ Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶Ø©: ${rows.length}`;
        }

        function renderCharts(summary, rows) {
            const levels = summary.levels || {};
            const levelLabels = Object.keys(levels);
            const levelData = levelLabels.map(l => levels[l]);

            const levelCtx = document.getElementById('levelsChart').getContext('2d');
            if (levelsChartInstance) levelsChartInstance.destroy();

            levelsChartInstance = new Chart(levelCtx, {
                type: 'doughnut',
                data: {
                    labels: levelLabels.length ? levelLabels : ['Ù„Ø§ ÙŠÙˆØ¬Ø¯'],
                    datasets: [{
                        data: levelData.length ? levelData : [1],
                        backgroundColor: ['#ef4444', '#f59e0b', '#10b981', '#6366f1']
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });

            const trendData = rows
                .filter(r => r.assessment_date)
                .sort((a, b) => new Date(a.assessment_date) - new Date(b.assessment_date));

            const trendLabels = trendData.map(r => formatDate(r.assessment_date));
            const trendScores = trendData.map(r => parseFloat(r.risk_score || 0));

            const trendCtx = document.getElementById('trendChart').getContext('2d');
            if (trendChartInstance) trendChartInstance.destroy();

            trendChartInstance = new Chart(trendCtx, {
                type: 'line',
                data: {
                    labels: trendLabels.length ? trendLabels : ['-'],
                    datasets: [{
                        label: 'Ø¯Ø±Ø¬Ø© Ø§Ù„Ù…Ø®Ø§Ø·Ø±',
                        data: trendScores.length ? trendScores : [0],
                        borderColor: '#6366f1',
                        backgroundColor: 'rgba(99, 102, 241, 0.2)',
                        fill: true,
                        tension: 0.3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } }
                }
            });
        }

        function renderLevel(level) {
            const value = (level || 'Unknown').toLowerCase();
            const map = {
                low: 'bg-emerald-100 text-emerald-700',
                medium: 'bg-amber-100 text-amber-700',
                high: 'bg-red-100 text-red-700'
            };
            const label = value === 'low' ? 'Ù…Ù†Ø®ÙØ¶' : value === 'medium' ? 'Ù…ØªÙˆØ³Ø·' : value === 'high' ? 'Ù…Ø±ØªÙØ¹' : level;
            const cls = map[value] || 'bg-gray-100 text-gray-700';
            return `<span class="px-2 py-1 rounded text-xs font-bold ${cls}">${label}</span>`;
        }

        function renderJson(value) {
            if (!value) return '-';
            try {
                return JSON.stringify(value);
            } catch (e) {
                return String(value);
            }
        }

        function formatScore(value) {
            const num = parseFloat(value || 0);
            return num.toFixed(1);
        }

        function formatDate(value) {
            if (!value) return '-';
            const date = new Date(value);
            return date.toLocaleDateString('ar-SA');
        }

        function formatDateTime(value) {
            if (!value) return '-';
            const date = new Date(value);
            return date.toLocaleString('ar-SA');
        }

        function downloadCSV() {
            if (!allRows.length) return;
            const rows = [[
                'risk_id','customer_id','assessment_date','risk_score','risk_level','risk_factors','calculation_details','recommendations','suggested_actions','entity_type','entity_id','model_version','created_at'
            ]];
            allRows.forEach(r => {
                rows.push([
                    r.risk_id,
                    r.customer_id,
                    r.assessment_date,
                    r.risk_score,
                    r.risk_level,
                    JSON.stringify(r.risk_factors || {}),
                    JSON.stringify(r.calculation_details || {}),
                    r.recommendations,
                    JSON.stringify(r.suggested_actions || {}),
                    r.entity_type,
                    r.entity_id,
                    r.model_version,
                    r.created_at
                ]);
            });
            const csvContent = rows.map(r => r.map(v => `"${v ?? ''}"`).join(',')).join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'ai-risk-scores.csv';
            link.click();
            URL.revokeObjectURL(url);
        }

        function downloadJSON() {
            if (!allRows.length) return;
            const blob = new Blob([JSON.stringify(allRows, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'ai-risk-scores.json';
            link.click();
            URL.revokeObjectURL(url);
        }

        function printReport() {
            window.print();
        }

        document.addEventListener('DOMContentLoaded', loadReport);
    </script>
</body>
</html>
