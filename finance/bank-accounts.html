<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>๐ฆ ุญุณุงุจุงุช ุงูุจููู - ูุธุงู ูุงููุด</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            font-family: 'Cairo', sans-serif;
            background: #f9fafb;
            color: #111827;
            min-height: 100vh;
        }
        .card {
            background: #ffffff;
            border: 1px solid #e5e7eb;
            box-shadow: 0 10px 25px rgba(15, 23, 42, 0.08);
        }
        .chip {
            border-radius: 999px;
            padding: 4px 12px;
            font-weight: 700;
            font-size: 12px;
        }
        .banner {
            background: #fef2f2;
            border: 1px dashed #ef4444;
            color: #991b1b;
        }
        .soft-scroll::-webkit-scrollbar {
            width: 6px;
        }
        .soft-scroll::-webkit-scrollbar-track {
            background: #f3f4f6;
        }
        .soft-scroll::-webkit-scrollbar-thumb {
            background: #d1d5db;
            border-radius: 999px;
        }
    </style>
</head>
<body>
    <div class="container mx-auto px-4 py-8">
        <div class="mb-8">
            <h1 class="text-4xl font-bold mb-2">๐ฆ ุญุณุงุจุงุช ุงูุจููู</h1>
            <p class="text-lg text-slate-600">ููุญุฉ ุฅุฏุงุฑุฉ ุงูุญุณุงุจุงุช ุงูุจูููุฉุ ุงููุฑุงูุจุฉ ุงูุฐููุฉุ ูุงูุชูุจููุงุช ุงูุงุณุชุจุงููุฉ</p>
        </div>

        <div class="flex flex-wrap gap-3 mb-6">
            <button onclick="loadBankAccounts()" class="bg-white text-slate-800 border border-slate-200 px-6 py-3 rounded-full font-bold hover:shadow-lg transition flex items-center gap-2">
                <i class="fas fa-rotate"></i>
                ุชุญุฏูุซ ุงูุจูุงูุงุช
            </button>
            <button onclick="openAddBankModal()" class="bg-black text-white px-6 py-3 rounded-full font-bold hover:shadow-lg transition flex items-center gap-2">
                <i class="fas fa-plus"></i>
                ุฅุถุงูุฉ ุจูู
            </button>
            <button onclick="exportBankAccounts()" class="bg-slate-900 text-white px-6 py-3 rounded-full font-bold hover:shadow-lg transition flex items-center gap-2">
                <i class="fas fa-file-export"></i>
                ุชุตุฏูุฑ ุงูุจูุงูุงุช
            </button>
        </div>

        <div id="demoBanner" class="banner hidden mb-6 rounded-2xl p-4 text-sm">
            ุชู ุชุญููู ุจูุงูุงุช ุชุฌุฑูุจูุฉ ูุฃู ุงูุงุชุตุงู ุจุงูุจูุงูุงุช ุงููุนููุฉ ุบูุฑ ูุชุงุญ ุญุงููุงู.
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-6 mb-8">
            <div class="card rounded-2xl p-6">
                <div class="flex items-center justify-between mb-3">
                    <div class="text-sm text-slate-500">ุฅุฌูุงูู ุงูุญุณุงุจุงุช ุงูุจูููุฉ</div>
                    <span class="chip bg-black text-white">ูุดุท</span>
                </div>
                <div class="text-3xl font-bold" id="totalBanks">0</div>
                <div class="text-xs text-slate-500 mt-2">ุนุฏุฏ ุงูุญุณุงุจุงุช ุงูุชู ุชู ุฑุจุทูุง ุจุงูููุดุฃุฉ</div>
            </div>
            <div class="card rounded-2xl p-6">
                <div class="flex items-center justify-between mb-3">
                    <div class="text-sm text-slate-500">ุฅุฌูุงูู ุงูุฑุตูุฏ ุงูุจููู</div>
                    <span class="chip bg-red-100 text-red-700">ุณูููุฉ</span>
                </div>
                <div class="text-3xl font-bold" id="totalBalance">0 ุฑ.ุณ</div>
                <div class="text-xs text-slate-500 mt-2">ุงูุฑุตูุฏ ุงููุชุงุญ ุจุนุฏ ุงูุชุณููุงุช</div>
            </div>
            <div class="card rounded-2xl p-6">
                <div class="flex items-center justify-between mb-3">
                    <div class="text-sm text-slate-500">ูุคุดุฑ ุงูุชุฑูุฒ ุงูุจููู</div>
                    <span class="chip bg-slate-100 text-slate-700">ุชุญููู</span>
                </div>
                <div class="text-3xl font-bold" id="concentrationIndex">0%</div>
                <div class="text-xs text-slate-500 mt-2">ูุณุจุฉ ุฃูุจุฑ ุญุณุงุจ ุฅูู ุฅุฌูุงูู ุงูุฑุตูุฏ</div>
            </div>
            <div class="card rounded-2xl p-6">
                <div class="flex items-center justify-between mb-3">
                    <div class="text-sm text-slate-500">ุขุฎุฑ ุชุณููุฉ ุจูููุฉ</div>
                    <span class="chip bg-black text-white">ูุจุงุดุฑ</span>
                </div>
                <div class="text-2xl font-bold" id="lastReconciled">-</div>
                <div class="text-xs text-slate-500 mt-2">ุขุฎุฑ ุชุงุฑูุฎ ูุฑุงุฌุนุฉ ููุญุณุงุจุงุช ุงูุจูููุฉ</div>
            </div>
        </div>

        <div class="grid grid-cols-1 xl:grid-cols-3 gap-6 mb-8">
            <div class="card rounded-2xl p-6 xl:col-span-2">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-xl font-bold">๐ ููุญุฉ ุงููุคุดุฑุงุช ุงูุจูููุฉ ุงููุชูุฏูุฉ</h2>
                    <span class="chip bg-slate-100 text-slate-700">ุชุญุณููุงุช ุบูุฑ ูุณุจููุฉ</span>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                    <div class="bg-slate-50 rounded-xl p-4">
                        <div class="text-slate-500">ูุนุฏู ุชุบุทูุฉ ุงูุงูุชุฒุงูุงุช</div>
                        <div class="text-2xl font-bold" id="coverageRatio">0%</div>
                        <div class="text-xs text-slate-500">ูููุณ ูุฏุฑุฉ ุงูุญุณุงุจุงุช ุงูุจูููุฉ ุนูู ุชุบุทูุฉ ุงููุตุฑููุงุช ุงูุดูุฑูุฉ</div>
                    </div>
                    <div class="bg-slate-50 rounded-xl p-4">
                        <div class="text-slate-500">ุชูุจูู ุงูุณูููุฉ ุงูุญุฑุฌุฉ</div>
                        <div class="text-2xl font-bold text-red-600" id="criticalAlert">-</div>
                        <div class="text-xs text-slate-500">ูุนุชูุฏ ุนูู ุญุฏูุฏ ุงูุฅูุฐุงุฑ ุงููุญุฏุฏุฉ ููู ุญุณุงุจ</div>
                    </div>
                    <div class="bg-slate-50 rounded-xl p-4">
                        <div class="text-slate-500">ูุคุดุฑ ุงูุงุณุชูุฑุงุฑ ุงูุจููู</div>
                        <div class="text-2xl font-bold" id="stabilityIndex">0%</div>
                        <div class="text-xs text-slate-500">ููุงุฒู ุจูู ุงูุชุฑูุฒ ูุงูุชูููุน ุงูุจููู</div>
                    </div>
                    <div class="bg-slate-50 rounded-xl p-4">
                        <div class="text-slate-500">ุฑุตูุฏ ุงูุงุญุชูุงุทู ุงูุงุณุชุฑุงุชูุฌู</div>
                        <div class="text-2xl font-bold" id="reserveBuffer">0 ุฑ.ุณ</div>
                        <div class="text-xs text-slate-500">ุงูุฑุตูุฏ ุงูููุตู ุจุญุฌุฒู ููุญุงูุงุช ุงูุทุงุฑุฆุฉ</div>
                    </div>
                </div>
            </div>
            <div class="card rounded-2xl p-6">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-xl font-bold">๐ค ุชูุตูุงุช ุฐููุฉ</h2>
                </div>
                <div id="aiInsights" class="space-y-3 text-sm text-slate-700">
                    <div class="animate-pulse text-slate-400">ุฌุงุฑู ุงูุชุญููู...</div>
                </div>
            </div>
        </div>

        <div class="card rounded-2xl p-6">
            <div class="flex flex-wrap items-center justify-between gap-3 mb-4">
                <h2 class="text-xl font-bold">๐ณ ูุงุฆูุฉ ุงูุญุณุงุจุงุช ุงูุจูููุฉ</h2>
                <div class="flex items-center gap-2">
                    <input id="searchInput" oninput="renderTable()" class="border border-slate-200 rounded-lg px-3 py-2 text-sm" placeholder="ุจุญุซ ุจุงุณู ุงูุจูู ุฃู ุงูุญุณุงุจ">
                    <select id="statusFilter" onchange="renderTable()" class="border border-slate-200 rounded-lg px-3 py-2 text-sm">
                        <option value="all">ูู ุงูุญุงูุงุช</option>
                        <option value="active">ูุดุท</option>
                        <option value="paused">ูุฌููุฏ</option>
                    </select>
                </div>
            </div>
            <div class="overflow-auto soft-scroll">
                <table class="w-full text-sm">
                    <thead class="bg-slate-100 text-slate-700">
                        <tr>
                            <th class="px-3 py-2 text-right">ููุฏ ุงูุญุณุงุจ</th>
                            <th class="px-3 py-2 text-right">ุงูุจูู</th>
                            <th class="px-3 py-2 text-right">ุงูุญุณุงุจ</th>
                            <th class="px-3 py-2 text-right">ุงูุฑุตูุฏ</th>
                            <th class="px-3 py-2 text-right">ุงูุนููุฉ</th>
                            <th class="px-3 py-2 text-right">IBAN</th>
                            <th class="px-3 py-2 text-right">ุงูุญุงูุฉ</th>
                            <th class="px-3 py-2 text-right">ุขุฎุฑ ุชุณููุฉ</th>
                        </tr>
                    </thead>
                    <tbody id="bankTable" class="divide-y divide-slate-100">
                        <tr>
                            <td colspan="8" class="px-4 py-8 text-center text-slate-500">ุฌุงุฑู ุชุญููู ุงูุจูุงูุงุช...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="bankModal" class="fixed inset-0 bg-black/40 hidden items-center justify-center z-50">
        <div class="bg-white rounded-2xl w-full max-w-3xl p-6">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-xl font-bold">ุฅุถุงูุฉ ุจูู ุฌุฏูุฏ</h3>
                <button onclick="closeAddBankModal()" class="text-slate-500 hover:text-slate-800">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                <div>
                    <label class="text-slate-600">ุงุณู ุงูุจูู</label>
                    <input id="bankNameInput" class="w-full border border-slate-200 rounded-lg px-3 py-2" placeholder="ูุซุงู: ุงูุจูู ุงูุฃููู">
                </div>
                <div>
                    <label class="text-slate-600">ุงุณู ุงูุญุณุงุจ</label>
                    <input id="accountNameInput" class="w-full border border-slate-200 rounded-lg px-3 py-2" placeholder="ุญุณุงุจ ุงูุชุดุบูู ุงูุฑุฆูุณู">
                </div>
                <div>
                    <label class="text-slate-600">ููุฏ ุงูุญุณุงุจ</label>
                    <input id="accountCodeInput" class="w-full border border-slate-200 rounded-lg px-3 py-2" placeholder="1120xxxx">
                </div>
                <div>
                    <label class="text-slate-600">ุงูุนููุฉ</label>
                    <input id="currencyInput" class="w-full border border-slate-200 rounded-lg px-3 py-2" value="SAR">
                </div>
                <div>
                    <label class="text-slate-600">IBAN</label>
                    <input id="ibanInput" class="w-full border border-slate-200 rounded-lg px-3 py-2" placeholder="SA...">
                </div>
                <div>
                    <label class="text-slate-600">SWIFT</label>
                    <input id="swiftInput" class="w-full border border-slate-200 rounded-lg px-3 py-2" placeholder="XXXXSA">
                </div>
                <div>
                    <label class="text-slate-600">ุฑูู ุงูุญุณุงุจ</label>
                    <input id="accountNumberInput" class="w-full border border-slate-200 rounded-lg px-3 py-2" placeholder="000123456">
                </div>
                <div>
                    <label class="text-slate-600">ุงููุฑุน</label>
                    <input id="branchInput" class="w-full border border-slate-200 rounded-lg px-3 py-2" placeholder="ูุฑุน ุงูุฑูุงุถ">
                </div>
                <div>
                    <label class="text-slate-600">ุญุฏ ุงูุฅูุฐุงุฑ</label>
                    <input id="alertThresholdInput" class="w-full border border-slate-200 rounded-lg px-3 py-2" type="number" placeholder="100000">
                </div>
                <div>
                    <label class="text-slate-600">ุชุงุฑูุฎ ุขุฎุฑ ุชุณููุฉ</label>
                    <input id="reconcileInput" class="w-full border border-slate-200 rounded-lg px-3 py-2" type="date">
                </div>
                <div class="md:col-span-2">
                    <label class="text-slate-600">ููุงุญุธุงุช</label>
                    <textarea id="notesInput" class="w-full border border-slate-200 rounded-lg px-3 py-2" rows="3" placeholder="ููุงุญุธุงุช ุชุดุบูููุฉ ุฃู ุชุนูููุงุช ุฎุงุตุฉ"></textarea>
                </div>
            </div>
            <div class="flex items-center justify-end gap-3 mt-6">
                <button onclick="closeAddBankModal()" class="px-5 py-2 rounded-lg border border-slate-200">ุฅูุบุงุก</button>
                <button onclick="submitBankAccount()" class="px-5 py-2 rounded-lg bg-black text-white">ุญูุธ ุงูุจูู</button>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = window.location.origin;
        const ENTITY_ID = 'HQ001';

        let bankAccounts = [];
        let demoMode = false;

        function formatMoney(value) {
            const num = parseFloat(value || 0);
            return num.toLocaleString('ar-SA') + ' ุฑ.ุณ';
        }

        function parseMetadata(description) {
            if (!description) return {};
            try {
                return JSON.parse(description);
            } catch {
                return { note: description };
            }
        }

        function maskIban(iban) {
            if (!iban) return '-';
            if (iban.length < 8) return iban;
            return iban.slice(0, 4) + 'โขโขโขโขโขโข' + iban.slice(-4);
        }

        function getStatusChip(status) {
            if (status === 'paused') {
                return '<span class="chip bg-red-100 text-red-700">ูุฌููุฏ</span>';
            }
            return '<span class="chip bg-black text-white">ูุดุท</span>';
        }

        async function fetchJsonSafe(url, fallback) {
            try {
                const res = await fetch(url);
                if (!res.ok) return fallback;
                return await res.json();
            } catch {
                return fallback;
            }
        }

        async function loadBankAccounts() {
            const banner = document.getElementById('demoBanner');
            try {
                const balanceData = await fetchJsonSafe(`${API_BASE}/finance/account-balances?entity_id=${ENTITY_ID}&account_type=ASSET`, null);
                if (!balanceData || !balanceData.success) {
                    throw new Error('no data');
                }
                demoMode = false;
                if (banner) banner.classList.add('hidden');

                const rows = balanceData.rows || [];
                bankAccounts = rows.filter(row => {
                        const name = String(row.account_name_ar || '');
                        const code = String(row.account_code || '');
                        return name.includes('ุจูู') || code.startsWith('1120') || code.startsWith('112');
                    })
                    .map(row => ({
                        account_id: row.account_id,
                        account_code: row.account_code,
                        bank_name: row.account_name_ar,
                        account_name: row.account_name_ar,
                        balance: row.balance || 0,
                        currency: 'SAR',
                        status: 'active',
                        reconciled_at: null,
                        metadata: {}
                    }));

                if (!bankAccounts.length) {
                    applyDemoData();
                }
            } catch {
                applyDemoData();
                demoMode = true;
                if (banner) banner.classList.remove('hidden');
            }

            renderInsights();
            renderSummary();
            renderTable();
        }

        function applyDemoData() {
            bankAccounts = [
                {
                    account_code: '112001',
                    bank_name: 'ุงูุจูู ุงูุฃููู',
                    account_name: 'ุญุณุงุจ ุงูุชุดุบูู ุงูุฑุฆูุณู',
                    balance: 920000,
                    currency: 'SAR',
                    status: 'active',
                    reconciled_at: '2026-01-25',
                    metadata: { iban: 'SA3800000000608010167519', swift: 'NCBKSARI', threshold: 150000 }
                },
                {
                    account_code: '112002',
                    bank_name: 'ุจูู ุงูุฑูุงุถ',
                    account_name: 'ุญุณุงุจ ุงูุฑูุงุชุจ',
                    balance: 420000,
                    currency: 'SAR',
                    status: 'active',
                    reconciled_at: '2026-01-24',
                    metadata: { iban: 'SA2500000000701123456789', swift: 'RIBLSARI', threshold: 120000 }
                },
                {
                    account_code: '112003',
                    bank_name: 'ูุตุฑู ุงูุฅููุงุก',
                    account_name: 'ุญุณุงุจ ุงูุงุญุชูุงุทู',
                    balance: 310000,
                    currency: 'SAR',
                    status: 'paused',
                    reconciled_at: '2026-01-20',
                    metadata: { iban: 'SA1900000000801123123123', swift: 'INMASARI', threshold: 80000 }
                }
            ];
        }

        function renderSummary() {
            const totalBanks = bankAccounts.length;
            const totalBalance = bankAccounts.reduce((sum, a) => sum + parseFloat(a.balance || 0), 0);
            const topBalance = bankAccounts.reduce((max, a) => Math.max(max, parseFloat(a.balance || 0)), 0);
            const concentration = totalBalance ? ((topBalance / totalBalance) * 100) : 0;
            const lastRec = bankAccounts.map(a => a.reconciled_at).filter(Boolean).sort().pop();

            document.getElementById('totalBanks').textContent = totalBanks;
            document.getElementById('totalBalance').textContent = formatMoney(totalBalance);
            document.getElementById('concentrationIndex').textContent = `${concentration.toFixed(1)}%`;
            document.getElementById('lastReconciled').textContent = lastRec || '-';

            const coverageRatio = totalBalance ? Math.min(100, (totalBalance / 1200000) * 100) : 0;
            document.getElementById('coverageRatio').textContent = `${coverageRatio.toFixed(1)}%`;

            const critical = bankAccounts.some(a => parseFloat(a.balance || 0) < parseFloat(a.metadata?.threshold || 0)) ? 'ูุฑุชูุน' : 'ูุณุชูุฑ';
            document.getElementById('criticalAlert').textContent = critical;

            const stability = Math.max(10, 100 - concentration);
            document.getElementById('stabilityIndex').textContent = `${stability.toFixed(0)}%`;

            const reserve = totalBalance * 0.18;
            document.getElementById('reserveBuffer').textContent = formatMoney(reserve);
        }

        function renderInsights() {
            const totalBalance = bankAccounts.reduce((sum, a) => sum + parseFloat(a.balance || 0), 0);
            const top = bankAccounts.slice().sort((a, b) => b.balance - a.balance)[0];
            const insights = [];

            if (top) {
                insights.push(`ุฃูุจุฑ ุญุณุงุจ ุจููู ูู ${top.bank_name} ุจุฑุตูุฏ ${formatMoney(top.balance)}.`);
            }
            if (totalBalance < 500000) {
                insights.push('ุงูุณูููุฉ ุงูุจูููุฉ ุฃูู ูู ุงูุญุฏ ุงูุขูู ุงูููุชุฑุญ. ููุตู ุจุฑูุน ุงูุงุญุชูุงุทู.' );
            } else {
                insights.push('ุงูุณูููุฉ ุงูุจูููุฉ ุถูู ุงููุทุงู ุงูุขูู ููููู ุงุณุชุซูุงุฑ ุงููุงุฆุถ ูุตูุฑ ุงูุฃุฌู.' );
            }
            if (bankAccounts.filter(a => a.status === 'paused').length) {
                insights.push('ููุฌุฏ ุญุณุงุจุงุช ูุฌูุฏุฉ ุชุญุชุงุฌ ูุฑุงุฌุนุฉ ุถูุงุจุท ุงูุชุดุบูู.' );
            }

            const insightsEl = document.getElementById('aiInsights');
            insightsEl.innerHTML = insights.map(text => `<div class="bg-slate-50 rounded-xl p-3">${text}</div>`).join('') || '<div class="text-slate-500">ูุง ุชูุฌุฏ ุชูุตูุงุช ุฅุถุงููุฉ ุญุงููุงู</div>';
        }

        function renderTable() {
            const searchValue = document.getElementById('searchInput').value.trim();
            const statusFilter = document.getElementById('statusFilter').value;

            const filtered = bankAccounts.filter(acc => {
                const matchesSearch = !searchValue || `${acc.bank_name} ${acc.account_name}`.includes(searchValue);
                const matchesStatus = statusFilter === 'all' || acc.status === statusFilter;
                return matchesSearch && matchesStatus;
            });

            const rows = filtered.map(acc => {
                const meta = acc.metadata || {};
                const iban = meta.iban || acc.iban || '-';
                return `
                    <tr class="hover:bg-slate-50">
                        <td class="px-3 py-3">${acc.account_code || '-'}</td>
                        <td class="px-3 py-3">${acc.bank_name || '-'}</td>
                        <td class="px-3 py-3">${acc.account_name || '-'}</td>
                        <td class="px-3 py-3 font-bold">${formatMoney(acc.balance)}</td>
                        <td class="px-3 py-3">${acc.currency || 'SAR'}</td>
                        <td class="px-3 py-3">${maskIban(iban)}</td>
                        <td class="px-3 py-3">${getStatusChip(acc.status)}</td>
                        <td class="px-3 py-3">${acc.reconciled_at || '-'}</td>
                    </tr>
                `;
            }).join('');

            document.getElementById('bankTable').innerHTML = rows || `<tr><td colspan="8" class="px-4 py-8 text-center text-slate-500">ูุง ุชูุฌุฏ ุญุณุงุจุงุช ูุทุงุจูุฉ</td></tr>`;
        }

        function openAddBankModal() {
            document.getElementById('bankModal').classList.remove('hidden');
            document.getElementById('bankModal').classList.add('flex');
        }

        function closeAddBankModal() {
            document.getElementById('bankModal').classList.add('hidden');
            document.getElementById('bankModal').classList.remove('flex');
        }

        function nextBankCode() {
            const codes = bankAccounts.map(a => parseInt(String(a.account_code || '').replace(/\D/g, ''), 10)).filter(Boolean);
            const maxCode = codes.length ? Math.max(...codes) : 112000;
            return String(maxCode + 1);
        }

        async function submitBankAccount() {
            const bankName = document.getElementById('bankNameInput').value.trim();
            const accountName = document.getElementById('accountNameInput').value.trim();
            const accountCode = document.getElementById('accountCodeInput').value.trim() || nextBankCode();
            const currency = document.getElementById('currencyInput').value.trim() || 'SAR';
            const iban = document.getElementById('ibanInput').value.trim();
            const swift = document.getElementById('swiftInput').value.trim();
            const accountNumber = document.getElementById('accountNumberInput').value.trim();
            const branch = document.getElementById('branchInput').value.trim();
            const threshold = parseFloat(document.getElementById('alertThresholdInput').value || 0);
            const reconciled = document.getElementById('reconcileInput').value;
            const notes = document.getElementById('notesInput').value.trim();

            if (!bankName || !accountName) {
                alert('ูุฑุฌู ุฅุฏุฎุงู ุงุณู ุงูุจูู ูุงุณู ุงูุญุณุงุจ');
                return;
            }

            const metadata = {
                bank_name: bankName,
                iban,
                swift,
                account_number: accountNumber,
                branch,
                currency,
                threshold,
                reconciled_at: reconciled,
                notes
            };

            try {
                const response = await fetch(`${API_BASE}/finance/accounts`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        account_code: accountCode,
                        account_name_ar: accountName,
                        account_name_en: accountName,
                        account_type: 'ASSET',
                        parent_account_id: null,
                        level: 4,
                        is_header: false,
                        normal_balance: 'DEBIT',
                        description: JSON.stringify(metadata),
                        entity_type: 'HQ',
                        entity_id: ENTITY_ID,
                        branch_id: null,
                        incubator_id: null
                    })
                });

                const data = await response.json();
                if (!data.success) {
                    throw new Error(data.error || 'ุชุนุฐุฑ ุญูุธ ุงูุญุณุงุจ');
                }

                closeAddBankModal();
                await loadBankAccounts();
                alert('ุชูุช ุฅุถุงูุฉ ุงูุญุณุงุจ ุงูุจููู ุจูุฌุงุญ');
            } catch (error) {
                console.error(error);
                // fallback to local append to keep UI responsive
                bankAccounts.unshift({
                    account_code: accountCode,
                    bank_name: bankName,
                    account_name: accountName,
                    balance: 0,
                    currency,
                    status: 'active',
                    reconciled_at: reconciled,
                    metadata
                });
                closeAddBankModal();
                renderSummary();
                renderTable();
                renderInsights();
                alert('ุชู ุฅุถุงูุฉ ุงูุญุณุงุจ ูุญููุงูุ ุชุญูู ูู ุฑุจุท API ูุงุญูุงู');
            }
        }

        function exportBankAccounts() {
            const rows = [
                ['ููุฏ ุงูุญุณุงุจ', 'ุงูุจูู', 'ุงูุญุณุงุจ', 'ุงูุฑุตูุฏ', 'ุงูุนููุฉ', 'IBAN', 'SWIFT', 'ุงูุญุงูุฉ', 'ุขุฎุฑ ุชุณููุฉ']
            ];
            bankAccounts.forEach(acc => {
                const meta = acc.metadata || {};
                rows.push([
                    acc.account_code || '',
                    acc.bank_name || '',
                    acc.account_name || '',
                    acc.balance || 0,
                    acc.currency || 'SAR',
                    meta.iban || '',
                    meta.swift || '',
                    acc.status || 'active',
                    acc.reconciled_at || ''
                ]);
            });
            const csv = rows.map(r => r.map(v => `"${String(v).replace(/"/g, '""')}"`).join(',')).join('\n');
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'bank-accounts.csv';
            link.click();
            URL.revokeObjectURL(url);
        }

        document.addEventListener('DOMContentLoaded', loadBankAccounts);
    </script>
</body>
</html>
