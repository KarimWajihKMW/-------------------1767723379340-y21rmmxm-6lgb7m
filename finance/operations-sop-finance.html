<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>๐งญ ุฅุฌุฑุงุกุงุช ุงูุชุดุบูู ุงููุงูู - ูุธุงู ูุงููุด</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Cairo', sans-serif;
            background: linear-gradient(135deg, #1d4ed8 0%, #0ea5e9 55%, #14b8a6 100%);
            min-height: 100vh;
        }
        .glass { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(12px); }
        .shape-rounded { border-radius: 26px; }
        .shape-angled { border-radius: 34px 10px 34px 10px; }
        .shape-pill { border-radius: 999px; }
        .shape-cut { border-radius: 18px 18px 42px 8px; }
        .table-scroll { max-height: 520px; overflow: auto; }
        .chart-box { position: relative; height: 260px; }
        .accent-sky { border-top: 4px solid #0ea5e9; }
        .accent-indigo { border-top: 4px solid #6366f1; }
        .accent-emerald { border-top: 4px solid #10b981; }
        .accent-rose { border-top: 4px solid #f43f5e; }
        .accent-amber { border-top: 4px solid #f59e0b; }
    </style>
</head>
<body>
    <div class="container mx-auto px-4 py-8">
        <div class="text-white mb-8">
            <h1 class="text-4xl font-bold mb-2">๐งญ ุฅุฌุฑุงุกุงุช ุงูุชุดุบูู ุงููุงูู</h1>
            <p class="text-lg opacity-90">ุฅุตุฏุงุฑ ุงูููุงุชูุฑ ูุงูุชุญุตูู ูุงููุตุฑููุงุช ูุงูุฅููุงู ุงูุดูุฑู (ุงูุตูุญุฉ 40)</p>
        </div>

        <div class="mb-6 flex flex-wrap gap-3">
            <button onclick="refreshData()" class="bg-white text-sky-700 px-6 py-3 rounded-full font-bold hover:shadow-lg transition flex items-center gap-2">
                <i class="fas fa-rotate"></i>
                ุชุญุฏูุซ ุงูุจูุงูุงุช
            </button>
            <button onclick="downloadAllJSON()" class="bg-indigo-600 text-white px-6 py-3 rounded-full font-bold hover:shadow-lg transition flex items-center gap-2">
                <i class="fas fa-file-code"></i>
                ุชูุฒูู ููู ุจูุงูุงุช ุดุงูู
            </button>
            <button onclick="downloadAllCSV()" class="bg-emerald-600 text-white px-6 py-3 rounded-full font-bold hover:shadow-lg transition flex items-center gap-2">
                <i class="fas fa-file-csv"></i>
                ุชูุฒูู ููู ุฌุฏููู ุดุงูู
            </button>
            <button onclick="printPage()" class="bg-rose-600 text-white px-6 py-3 rounded-full font-bold hover:shadow-lg transition flex items-center gap-2">
                <i class="fas fa-print"></i>
                ุทุจุงุนุฉ ุงูุตูุญุฉ
            </button>
            <button onclick="copySummary()" class="bg-amber-500 text-white px-6 py-3 rounded-full font-bold hover:shadow-lg transition flex items-center gap-2">
                <i class="fas fa-copy"></i>
                ูุณุฎ ููุฎุต ุงูุฅุฌุฑุงุกุงุช
            </button>
        </div>

        <div class="glass shape-rounded shadow-2xl p-6 mb-8 accent-sky">
            <div class="flex flex-wrap items-center justify-between gap-3 mb-6">
                <h2 class="text-2xl font-bold text-slate-800">๐งพ ุฅุตุฏุงุฑ ุงูููุงุชูุฑ</h2>
                <span class="text-sm text-slate-500">ุถูุงู ููุงุชูุฑ ุฏูููุฉ ูููุญุฏุฉ ููุงุจูุฉ ููุชุชุจุน</span>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5">
                <div class="glass shape-angled p-5 shadow-lg border border-sky-100">
                    <h3 class="font-bold text-slate-800 mb-2">ุงููุฏู</h3>
                    <p class="text-sm text-slate-600">ุถูุงู ุฅุตุฏุงุฑ ููุงุชูุฑ ุฏูููุฉ ูููุญุฏุฉ ููุงุจูุฉ ููุชุชุจุน.</p>
                </div>
                <div class="glass shape-cut p-5 shadow-lg border border-emerald-100">
                    <h3 class="font-bold text-slate-800 mb-2">ุงููุทุงู</h3>
                    <p class="text-sm text-slate-600">ุฌููุน ุงููุฑูุน ูุงูุญุงุถูุงุช ูุงูุจุฑุงูุฌ.</p>
                </div>
                <div class="glass shape-pill p-5 shadow-lg border border-rose-100">
                    <h3 class="font-bold text-slate-800 mb-2">ุงููุณุคูููุงุช</h3>
                    <ul class="text-sm text-slate-600 space-y-1">
                        <li>ููุธู ุงูุจุฑูุงูุฌ: ุฅุฏุฎุงู ุงูุทูุจ</li>
                        <li>ุงููุงููุฉ: ุงููุฑุงุฌุนุฉ</li>
                        <li>ุงููุธุงู: ุฅุตุฏุงุฑ ุงููุงุชูุฑุฉ</li>
                    </ul>
                </div>
            </div>
            <div class="mt-6 grid grid-cols-1 md:grid-cols-2 gap-5">
                <div class="glass shape-rounded p-5 border border-sky-100">
                    <h4 class="font-bold text-slate-800 mb-2">ุงูุฅุฌุฑุงุกุงุช</h4>
                    <ol class="text-sm text-slate-600 space-y-1 list-decimal list-inside">
                        <li>ุงุณุชูุงู ุทูุจ ุฎุฏูุฉ ูู ุงูุนููู</li>
                        <li>ุงูุชุญูู ูู ุจูุงูุงุช ุงูุนููู</li>
                        <li>ุฅุฏุฎุงู ุชูุงุตูู ุงูุฎุฏูุฉ</li>
                        <li>ุชุญุฏูุฏ ุณูุงุณุฉ ุงูุฏูุน (ูุงูู/ุฌุฒุฆู/ุฎุทุฉ ุฏูุน)</li>
                        <li>ุฅุตุฏุงุฑ ุงููุงุชูุฑุฉ</li>
                        <li>ุฅุฑุณุงููุง ููุนููู ุนุจุฑ ุงูุจุฑูุฏ ูููุญุฉ ุงูุนููู</li>
                        <li>ุชุณุฌูููุง ูู ุงูุฏูุชุฑ ุงูุนุงู</li>
                    </ol>
                </div>
                <div class="glass shape-rounded p-5 border border-emerald-100">
                    <h4 class="font-bold text-slate-800 mb-2">ููุฎุต ุงูููุงุชูุฑ ุงูุญุงููุฉ</h4>
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
                        <div class="bg-sky-50 rounded-xl p-3">
                            <div class="text-xs text-slate-500">ุฅุฌูุงูู ุงูููุงุชูุฑ</div>
                            <div id="totalInvoices" class="text-lg font-bold text-slate-800">0</div>
                        </div>
                        <div class="bg-rose-50 rounded-xl p-3">
                            <div class="text-xs text-slate-500">ููุงุชูุฑ ูุชุฃุฎุฑุฉ</div>
                            <div id="overdueInvoices" class="text-lg font-bold text-slate-800">0</div>
                        </div>
                        <div class="bg-emerald-50 rounded-xl p-3">
                            <div class="text-xs text-slate-500">ุฅุฌูุงูู ุงููุฏููุน</div>
                            <div id="totalPaid" class="text-lg font-bold text-slate-800">0</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="glass shape-rounded shadow-2xl p-6 mb-8 accent-emerald">
            <div class="flex flex-wrap items-center justify-between gap-3 mb-6">
                <h2 class="text-2xl font-bold text-slate-800">๐ณ ุงูุชุญุตูู</h2>
                <span class="text-sm text-slate-500">ุชุญุตูู ูุณุชุญูุงุช ูุงููุด ุจููุงุกุฉ ูุดูุงููุฉ</span>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5">
                <div class="glass shape-angled p-5 shadow-lg border border-emerald-100">
                    <h3 class="font-bold text-slate-800 mb-2">ุฎุทูุงุช ุงูุชุญุตูู</h3>
                    <ol class="text-sm text-slate-600 space-y-1 list-decimal list-inside">
                        <li>ูุชุญ ุดุงุดุฉ ุงูุชุญุตูู</li>
                        <li>ุงูุจุญุซ ุนู ุงูุนููู</li>
                        <li>ุนุฑุถ ุงูููุงุชูุฑ ุงูููุชูุญุฉ</li>
                        <li>ุงุฎุชูุงุฑ ููุน ุงูุฏูุน (ูุงูู/ุฌุฒุฆู/ุฎุทุฉ ุฏูุน)</li>
                        <li>ุฅุฏุฎุงู ุงููุจูุบ ูุชุญุฏูุฏ ูุณููุฉ ุงูุฏูุน</li>
                        <li>ุชุฃููุฏ ุงูุนูููุฉ</li>
                    </ol>
                </div>
                <div class="glass shape-cut p-5 shadow-lg border border-amber-100">
                    <h3 class="font-bold text-slate-800 mb-2">ุงููุธุงู ูููู ุจู</h3>
                    <ul class="text-sm text-slate-600 space-y-1">
                        <li>ุชุณุฌูู ุงูุฏูุนุฉ</li>
                        <li>ุชุญุฏูุซ ุงูุฑุตูุฏ</li>
                        <li>ุฅูุดุงุก ุงูููุฏ ุงููุญุงุณุจู</li>
                        <li>ุฅุฑุณุงู ุฅูุตุงู ููุนููู</li>
                    </ul>
                </div>
                <div class="glass shape-pill p-5 shadow-lg border border-rose-100">
                    <h3 class="font-bold text-slate-800 mb-2">ูุคุดุฑุงุช ุงูุชุญุตูู</h3>
                    <div class="text-sm text-slate-600 space-y-2">
                        <div>ุฅุฌูุงูู ุงููุฏููุนุงุช: <span id="totalPayments" class="font-bold">0</span></div>
                        <div>ุฎุทุท ุงูุณุฏุงุฏ: <span id="plansCount" class="font-bold">0</span></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="glass shape-rounded shadow-2xl p-6 mb-8 accent-amber">
            <div class="flex flex-wrap items-center justify-between gap-3 mb-6">
                <h2 class="text-2xl font-bold text-slate-800">๐งพ ุงููุตุฑููุงุช</h2>
                <span class="text-sm text-slate-500">ูุนุงูุฌุฉ ุงููุตุฑููุงุช ุฎุทูุฉ ุจุฎุทูุฉ</span>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5">
                <div class="glass shape-angled p-5 shadow-lg border border-amber-100">
                    <h3 class="font-bold text-slate-800 mb-2">ุงูุฅุฌุฑุงุกุงุช</h3>
                    <ol class="text-sm text-slate-600 space-y-1 list-decimal list-inside">
                        <li>ุชูุฏูู ุทูุจ ุดุฑุงุก</li>
                        <li>ูุฑุงุฌุนุฉ ุงูุทูุจ</li>
                        <li>ุงูุญุตูู ุนูู ุนุฑูุถ ุฃุณุนุงุฑ</li>
                        <li>ุงุนุชูุงุฏ ุงูุทูุจ</li>
                        <li>ุงุณุชูุงู ุงููุงุชูุฑุฉ</li>
                        <li>ุชุณุฌูููุง ูู ุงููุธุงู</li>
                        <li>ุฅุตุฏุงุฑ ุฃูุฑ ุฏูุน</li>
                        <li>ุฅูุดุงุก ุงูููุฏ ุงููุญุงุณุจู</li>
                    </ol>
                </div>
                <div class="glass shape-cut p-5 shadow-lg border border-emerald-100">
                    <h3 class="font-bold text-slate-800 mb-2">ูุคุดุฑุงุช ุงููุตุฑููุงุช</h3>
                    <div class="text-sm text-slate-600 space-y-2">
                        <div>ุฅุฌูุงูู ุงููุตุฑููุงุช: <span id="totalExpenses" class="font-bold">0</span></div>
                        <div>ุนุฏุฏ ุงููุตุฑููุงุช: <span id="expensesCountSummary" class="font-bold">0</span></div>
                    </div>
                </div>
                <div class="glass shape-pill p-5 shadow-lg border border-rose-100">
                    <h3 class="font-bold text-slate-800 mb-2">ููุฎุต ุงูุงุนุชูุงุฏ</h3>
                    <p class="text-sm text-slate-600">ุชูุนุชูุฏ ุงููุตุฑููุงุช ููู ุงูุทูุจุงุช ูุงูุนุฑูุถ ูุงูููุงุชูุฑ ุงููุนุชูุฏุฉ.</p>
                </div>
            </div>
        </div>

        <div class="glass shape-rounded shadow-2xl p-6 mb-8 accent-rose">
            <div class="flex flex-wrap items-center justify-between gap-3 mb-6">
                <h2 class="text-2xl font-bold text-slate-800">๐ ุงูุฅููุงู ุงูุดูุฑู</h2>
                <span class="text-sm text-slate-500">ุชูููุฐ ุงูุฅููุงู ุจุงูุชุธุงู ูุงูุถุจุงุท</span>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5">
                <div class="glass shape-angled p-5 shadow-lg border border-rose-100">
                    <h3 class="font-bold text-slate-800 mb-2">ุงูุฅุฌุฑุงุกุงุช</h3>
                    <ol class="text-sm text-slate-600 space-y-1 list-decimal list-inside">
                        <li>ุชุณููุฉ ุงูุจูู</li>
                        <li>ุชุณููุฉ ุงูุฐูู</li>
                        <li>ุชุณููุฉ ุงูุนูุฏ</li>
                        <li>ุงุญุชุณุงุจ ุงูุฅููุงู</li>
                        <li>ูุฑุงุฌุนุฉ ุงููููุฏ</li>
                        <li>ุฅุนุฏุงุฏ ููุฒุงู ุงููุฑุงุฌุนุฉ</li>
                        <li>ุงุนุชูุงุฏ ุงูุฅููุงู</li>
                    </ol>
                </div>
                <div class="glass shape-cut p-5 shadow-lg border border-emerald-100">
                    <h3 class="font-bold text-slate-800 mb-2">ูุคุดุฑุงุช ุงูุฅููุงู</h3>
                    <div class="text-sm text-slate-600 space-y-2">
                        <div>ุนุฏุฏ ุงููููุฏ: <span id="totalEntries" class="font-bold">0</span></div>
                        <div>ุฅุฌูุงูู ุงูุฅููุงู: <span id="totalDepreciation" class="font-bold">0</span></div>
                    </div>
                </div>
                <div class="glass shape-pill p-5 shadow-lg border border-amber-100">
                    <h3 class="font-bold text-slate-800 mb-2">ุงูุถุจุงุท ุงูุฅููุงู</h3>
                    <p class="text-sm text-slate-600">ูุง ูุชู ุฅุฏุฎุงู ูููุฏ ุจุนุฏ ุงูุฅููุงู ุฅูุง ููู ุงูููุงููุงุช ุงููุนุชูุฏุฉ.</p>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
            <div class="glass shape-rounded shadow-2xl p-6 accent-sky">
                <h3 class="text-lg font-bold text-slate-800 mb-4">๐ ุชูุฒูุน ุญุงูุงุช ุงูููุงุชูุฑ</h3>
                <div class="chart-box"><canvas id="invoiceStatusChart"></canvas></div>
            </div>
            <div class="glass shape-rounded shadow-2xl p-6 accent-emerald">
                <h3 class="text-lg font-bold text-slate-800 mb-4">๐ณ ุชูุฒูุน ุทุฑู ุงูุชุญุตูู</h3>
                <div class="chart-box"><canvas id="paymentMethodChart"></canvas></div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
            <div class="glass shape-rounded shadow-2xl p-6 accent-amber">
                <h3 class="text-lg font-bold text-slate-800 mb-4">๐งพ ุชูุฒูุน ุฃููุงุน ุงููุตุฑููุงุช</h3>
                <div class="chart-box"><canvas id="expensesTypeChart"></canvas></div>
            </div>
            <div class="glass shape-rounded shadow-2xl p-6 accent-indigo">
                <h3 class="text-lg font-bold text-slate-800 mb-4">๐ข ููุฎุต ุงูุฃุตูู ูุงูุฅููุงู</h3>
                <div class="chart-box"><canvas id="assetsChart"></canvas></div>
            </div>
        </div>

        <div class="glass shape-rounded shadow-2xl p-6 mb-8 accent-sky">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-xl font-bold text-slate-800">๐ ุฌุฏูู ุงูููุงุชูุฑ</h3>
                <span id="invoicesCount" class="text-sm text-slate-500"></span>
            </div>
            <div class="table-scroll">
                <table class="w-full text-xs">
                    <thead class="bg-sky-50 text-sky-700">
                        <tr>
                            <th class="px-3 py-2 text-right">ุฑูู ุงููุงุชูุฑุฉ</th>
                            <th class="px-3 py-2 text-right">ุชุงุฑูุฎ ุงูุฅุตุฏุงุฑ</th>
                            <th class="px-3 py-2 text-right">ุชุงุฑูุฎ ุงูุงุณุชุญูุงู</th>
                            <th class="px-3 py-2 text-right">ุงูุนููู</th>
                            <th class="px-3 py-2 text-right">ุงูุฅุฌูุงูู</th>
                            <th class="px-3 py-2 text-right">ุงููุชุจูู</th>
                            <th class="px-3 py-2 text-right">ุงูุญุงูุฉ</th>
                        </tr>
                    </thead>
                    <tbody id="invoicesTable" class="divide-y divide-slate-100">
                        <tr><td colspan="7" class="px-4 py-10 text-center text-slate-500">ุฌุงุฑู ุชุญููู ุงูุจูุงูุงุช...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="glass shape-rounded shadow-2xl p-6 mb-8 accent-emerald">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-xl font-bold text-slate-800">๐ณ ุฌุฏูู ุงููุฏููุนุงุช</h3>
                <span id="paymentsCount" class="text-sm text-slate-500"></span>
            </div>
            <div class="table-scroll">
                <table class="w-full text-xs">
                    <thead class="bg-emerald-50 text-emerald-700">
                        <tr>
                            <th class="px-3 py-2 text-right">ุฑูู ุงูุฏูุนุฉ</th>
                            <th class="px-3 py-2 text-right">ุงูุนููู</th>
                            <th class="px-3 py-2 text-right">ูููุฉ ุงูุฏูุนุฉ</th>
                            <th class="px-3 py-2 text-right">ุชุงุฑูุฎ ุงูุฏูุนุฉ</th>
                            <th class="px-3 py-2 text-right">ุทุฑููุฉ ุงูุชุญุตูู</th>
                            <th class="px-3 py-2 text-right">ุงูุญุงูุฉ</th>
                        </tr>
                    </thead>
                    <tbody id="paymentsTable" class="divide-y divide-slate-100">
                        <tr><td colspan="6" class="px-4 py-10 text-center text-slate-500">ุฌุงุฑู ุชุญููู ุงูุจูุงูุงุช...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="glass shape-rounded shadow-2xl p-6 mb-8 accent-amber">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-xl font-bold text-slate-800">๐งพ ุฌุฏูู ุงููุตุฑููุงุช</h3>
                <span id="expensesCount" class="text-sm text-slate-500"></span>
            </div>
            <div class="table-scroll">
                <table class="w-full text-xs">
                    <thead class="bg-amber-50 text-amber-700">
                        <tr>
                            <th class="px-3 py-2 text-right">ุฑูู ุงููุตุฑูู</th>
                            <th class="px-3 py-2 text-right">ุชุงุฑูุฎ ุงููุตุฑูู</th>
                            <th class="px-3 py-2 text-right">ุงูููุน</th>
                            <th class="px-3 py-2 text-right">ุงูููุฑุฏ</th>
                            <th class="px-3 py-2 text-right">ุงูุฅุฌูุงูู</th>
                            <th class="px-3 py-2 text-right">ุงูุญุงูุฉ</th>
                        </tr>
                    </thead>
                    <tbody id="expensesTable" class="divide-y divide-slate-100">
                        <tr><td colspan="6" class="px-4 py-10 text-center text-slate-500">ุฌุงุฑู ุชุญููู ุงูุจูุงูุงุช...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="glass shape-rounded shadow-2xl p-6 mb-8 accent-indigo">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-xl font-bold text-slate-800">๐ข ุฌุฏูู ุงูุฃุตูู ุงูุซุงุจุชุฉ</h3>
                <span id="assetsCount" class="text-sm text-slate-500"></span>
            </div>
            <div class="table-scroll">
                <table class="w-full text-xs">
                    <thead class="bg-indigo-50 text-indigo-700">
                        <tr>
                            <th class="px-3 py-2 text-right">ุฑูู ุงูุฃุตู</th>
                            <th class="px-3 py-2 text-right">ุงุณู ุงูุฃุตู</th>
                            <th class="px-3 py-2 text-right">ุชุงุฑูุฎ ุงูุดุฑุงุก</th>
                            <th class="px-3 py-2 text-right">ุชูููุฉ ุงูุดุฑุงุก</th>
                            <th class="px-3 py-2 text-right">ุงููููุฉ ุงูุฏูุชุฑูุฉ</th>
                            <th class="px-3 py-2 text-right">ุงูุญุงูุฉ</th>
                        </tr>
                    </thead>
                    <tbody id="assetsTable" class="divide-y divide-slate-100">
                        <tr><td colspan="6" class="px-4 py-10 text-center text-slate-500">ุฌุงุฑู ุชุญููู ุงูุจูุงูุงุช...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = window.location.origin;
        const ENTITY_ID = '1';

        let store = {
            invoices: [],
            payments: [],
            expenses: [],
            assets: [],
            plans: [],
            entries: []
        };

        let invoiceChartInstance = null;
        let paymentChartInstance = null;
        let expensesChartInstance = null;
        let assetsChartInstance = null;

        async function loadData() {
            try {
                const [invoiceRes, paymentRes, expenseRes, assetRes, planRes, entryRes] = await Promise.all([
                    fetch(`${API_BASE}/finance/invoices`),
                    fetch(`${API_BASE}/finance/payments`),
                    fetch(`${API_BASE}/finance/expenses?entity_id=${ENTITY_ID}`),
                    fetch(`${API_BASE}/finance/fixed-assets?entity_id=${ENTITY_ID}`),
                    fetch(`${API_BASE}/finance/payment-plans?entity_id=${ENTITY_ID}`),
                    fetch(`${API_BASE}/finance/journal/entries?entity_id=${ENTITY_ID}`)
                ]);

                const [invoiceData, paymentData, expenseData, assetData, planData, entryData] = await Promise.all([
                    invoiceRes.json(),
                    paymentRes.json(),
                    expenseRes.json(),
                    assetRes.json(),
                    planRes.json(),
                    entryRes.json()
                ]);

                store.invoices = invoiceData.invoices || [];
                store.payments = paymentData.payments || [];
                store.expenses = expenseData.expenses || [];
                store.assets = assetData.assets || [];
                store.plans = planData.plans || [];
                store.entries = entryData.entries || entryData.rows || [];

                renderStats();
                renderCharts();
                renderTables();
                renderSummaryInsights();
            } catch (error) {
                console.error('ุฎุทุฃ ูู ุชุญููู ุงูุจูุงูุงุช:', error);
            }
        }

        function renderStats() {
            const totalInvoices = store.invoices.length;
            const overdueInvoices = store.invoices.filter(i => String(i.status || '').toUpperCase() === 'OVERDUE').length;
            const totalPaid = sum(store.invoices, 'paid_amount');
            const totalPayments = sum(store.payments, 'payment_amount');
            const totalExpenses = sum(store.expenses, 'total_amount');
            const totalAssets = store.assets.length;
            const totalDep = sum(store.assets, 'accumulated_depreciation');
            const totalPlans = store.plans.length;
            const totalEntries = store.entries.length;

            document.getElementById('totalInvoices').textContent = totalInvoices.toLocaleString('ar-SA');
            document.getElementById('overdueInvoices').textContent = overdueInvoices.toLocaleString('ar-SA');
            document.getElementById('totalPaid').textContent = formatMoney(totalPaid);
            document.getElementById('totalPayments').textContent = formatMoney(totalPayments);
            document.getElementById('plansCount').textContent = totalPlans.toLocaleString('ar-SA');
            document.getElementById('totalExpenses').textContent = formatMoney(totalExpenses);
            document.getElementById('expensesCountSummary').textContent = store.expenses.length.toLocaleString('ar-SA');
            document.getElementById('totalEntries').textContent = totalEntries.toLocaleString('ar-SA');
            document.getElementById('totalDepreciation').textContent = formatMoney(totalDep);
            document.getElementById('invoicesCount').textContent = `ุนุฏุฏ ุงูุตููู: ${totalInvoices}`;
            document.getElementById('paymentsCount').textContent = `ุนุฏุฏ ุงูุตููู: ${store.payments.length}`;
            document.getElementById('expensesCount').textContent = `ุนุฏุฏ ุงูุตููู: ${store.expenses.length}`;
            document.getElementById('assetsCount').textContent = `ุนุฏุฏ ุงูุตููู: ${store.assets.length}`;
            document.getElementById('totalAssets').textContent = totalAssets.toLocaleString('ar-SA');
        }

        function renderSummaryInsights() {
            // ุงูุญูุงุธ ุนูู ุงููุตูุต ุนุฑุจูุฉ ููุท
        }

        function renderCharts() {
            const statusCounts = store.invoices.reduce((acc, inv) => {
                const status = translateStatus(inv.status);
                acc[status] = (acc[status] || 0) + 1;
                return acc;
            }, {});

            const invoiceCtx = document.getElementById('invoiceStatusChart').getContext('2d');
            if (invoiceChartInstance) invoiceChartInstance.destroy();
            invoiceChartInstance = new Chart(invoiceCtx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(statusCounts).length ? Object.keys(statusCounts) : ['ูุง ุชูุฌุฏ ุจูุงูุงุช'],
                    datasets: [{
                        data: Object.values(statusCounts).length ? Object.values(statusCounts) : [0],
                        backgroundColor: ['#0ea5e9', '#f59e0b', '#10b981', '#ef4444', '#6366f1']
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });

            const methodCounts = store.payments.reduce((acc, p) => {
                const method = translatePaymentMethod(p.payment_method);
                acc[method] = (acc[method] || 0) + 1;
                return acc;
            }, {});

            const paymentCtx = document.getElementById('paymentMethodChart').getContext('2d');
            if (paymentChartInstance) paymentChartInstance.destroy();
            paymentChartInstance = new Chart(paymentCtx, {
                type: 'bar',
                data: {
                    labels: Object.keys(methodCounts).length ? Object.keys(methodCounts) : ['ูุง ุชูุฌุฏ ุจูุงูุงุช'],
                    datasets: [{
                        data: Object.values(methodCounts).length ? Object.values(methodCounts) : [0],
                        backgroundColor: '#10b981'
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
            });

            const expenseTypeCounts = store.expenses.reduce((acc, e) => {
                const type = sanitizeText(e.expense_type || e.expense_category);
                acc[type] = (acc[type] || 0) + 1;
                return acc;
            }, {});

            const expensesCtx = document.getElementById('expensesTypeChart').getContext('2d');
            if (expensesChartInstance) expensesChartInstance.destroy();
            expensesChartInstance = new Chart(expensesCtx, {
                type: 'bar',
                data: {
                    labels: Object.keys(expenseTypeCounts).length ? Object.keys(expenseTypeCounts) : ['ูุง ุชูุฌุฏ ุจูุงูุงุช'],
                    datasets: [{
                        data: Object.values(expenseTypeCounts).length ? Object.values(expenseTypeCounts) : [0],
                        backgroundColor: '#f59e0b'
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
            });

            const assetsSummary = {
                total: store.assets.length,
                active: store.assets.filter(a => String(a.status || '').toUpperCase() === 'ACTIVE').length,
                disposed: store.assets.filter(a => String(a.status || '').toUpperCase() === 'DISPOSED').length
            };

            const assetsCtx = document.getElementById('assetsChart').getContext('2d');
            if (assetsChartInstance) assetsChartInstance.destroy();
            assetsChartInstance = new Chart(assetsCtx, {
                type: 'doughnut',
                data: {
                    labels: ['ุฅุฌูุงูู ุงูุฃุตูู', 'ุฃุตูู ูุดุทุฉ', 'ุฃุตูู ูุณุชุจุนุฏุฉ'],
                    datasets: [{
                        data: [assetsSummary.total, assetsSummary.active, assetsSummary.disposed],
                        backgroundColor: ['#6366f1', '#10b981', '#ef4444']
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });
        }

        function renderTables() {
            const invoiceRows = store.invoices.map(inv => `
                <tr class="hover:bg-sky-50">
                    <td class="px-3 py-2">${sanitizeText(inv.invoice_number)}</td>
                    <td class="px-3 py-2">${formatDate(inv.invoice_date)}</td>
                    <td class="px-3 py-2">${formatDate(inv.due_date)}</td>
                    <td class="px-3 py-2">${sanitizeText(inv.customer_name_ar || inv.customer_name)}</td>
                    <td class="px-3 py-2 font-semibold text-emerald-700">${formatMoney(inv.total_amount)}</td>
                    <td class="px-3 py-2">${formatMoney(inv.remaining_amount)}</td>
                    <td class="px-3 py-2">${translateStatus(inv.status)}</td>
                </tr>
            `).join('');
            document.getElementById('invoicesTable').innerHTML = invoiceRows || `<tr><td colspan="7" class="px-4 py-10 text-center text-slate-500">ูุง ุชูุฌุฏ ุจูุงูุงุช</td></tr>`;

            const paymentRows = store.payments.map(p => `
                <tr class="hover:bg-emerald-50">
                    <td class="px-3 py-2">${sanitizeText(p.payment_number || p.payment_id)}</td>
                    <td class="px-3 py-2">${sanitizeText(p.customer_name_ar || p.customer_name || p.customer_id)}</td>
                    <td class="px-3 py-2 font-semibold text-emerald-700">${formatMoney(p.payment_amount)}</td>
                    <td class="px-3 py-2">${formatDate(p.payment_date)}</td>
                    <td class="px-3 py-2">${translatePaymentMethod(p.payment_method)}</td>
                    <td class="px-3 py-2">${translateStatus(p.status)}</td>
                </tr>
            `).join('');
            document.getElementById('paymentsTable').innerHTML = paymentRows || `<tr><td colspan="6" class="px-4 py-10 text-center text-slate-500">ูุง ุชูุฌุฏ ุจูุงูุงุช</td></tr>`;

            const expenseRows = store.expenses.map(e => `
                <tr class="hover:bg-amber-50">
                    <td class="px-3 py-2">${sanitizeText(e.expense_number || e.expense_id)}</td>
                    <td class="px-3 py-2">${formatDate(e.expense_date)}</td>
                    <td class="px-3 py-2">${sanitizeText(e.expense_type || e.expense_category)}</td>
                    <td class="px-3 py-2">${sanitizeText(e.vendor_name)}</td>
                    <td class="px-3 py-2 font-semibold text-emerald-700">${formatMoney(e.total_amount || e.amount)}</td>
                    <td class="px-3 py-2">${translateStatus(e.status)}</td>
                </tr>
            `).join('');
            document.getElementById('expensesTable').innerHTML = expenseRows || `<tr><td colspan="6" class="px-4 py-10 text-center text-slate-500">ูุง ุชูุฌุฏ ุจูุงูุงุช</td></tr>`;

            const assetRows = store.assets.map(a => `
                <tr class="hover:bg-indigo-50">
                    <td class="px-3 py-2">${sanitizeText(a.asset_code || a.asset_id)}</td>
                    <td class="px-3 py-2">${sanitizeText(a.asset_name_ar || a.asset_name_en || a.asset_name)}</td>
                    <td class="px-3 py-2">${formatDate(a.purchase_date)}</td>
                    <td class="px-3 py-2 font-semibold text-emerald-700">${formatMoney(a.purchase_cost)}</td>
                    <td class="px-3 py-2">${formatMoney(a.net_book_value)}</td>
                    <td class="px-3 py-2">${translateStatus(a.status)}</td>
                </tr>
            `).join('');
            document.getElementById('assetsTable').innerHTML = assetRows || `<tr><td colspan="6" class="px-4 py-10 text-center text-slate-500">ูุง ุชูุฌุฏ ุจูุงูุงุช</td></tr>`;
        }

        function translateStatus(value) {
            const map = {
                PAID: 'ูุฏููุนุฉ',
                UNPAID: 'ุบูุฑ ูุฏููุนุฉ',
                PARTIAL: 'ูุฏููุนุฉ ุฌุฒุฆููุง',
                OVERDUE: 'ูุชุฃุฎุฑุฉ',
                ACTIVE: 'ูุดุทุฉ',
                CLOSED: 'ูุบููุฉ',
                PENDING: 'ููุฏ ุงููุฑุงุฌุนุฉ',
                APPROVED: 'ูุนุชูุฏุฉ',
                REJECTED: 'ูุฑููุถุฉ',
                DISPOSED: 'ูุณุชุจุนุฏุฉ'
            };
            return map[String(value || '').toUpperCase()] || 'ุบูุฑ ูุญุฏุฏ';
        }

        function translatePaymentMethod(value) {
            const map = {
                BANK_TRANSFER: 'ุชุญููู ุจููู',
                CARD: 'ุจุทุงูุฉ',
                POS: 'ููุงุท ุจูุน',
                CASH: 'ููุฏ',
                GATEWAY: 'ุจูุงุจุฉ ุงูุฏูุน',
                CHEQUE: 'ุดูู'
            };
            return map[String(value || '').toUpperCase()] || 'ุบูุฑ ูุญุฏุฏ';
        }

        function formatMoney(value) {
            const num = parseFloat(value || 0);
            return num.toLocaleString('ar-SA') + ' ุฑ.ุณ';
        }

        function formatDate(value) {
            if (!value) return '-';
            return new Date(value).toLocaleDateString('ar-SA');
        }

        function sanitizeText(value) {
            if (value === null || value === undefined) return 'ุบูุฑ ูุญุฏุฏ';
            const text = typeof value === 'string' ? value : JSON.stringify(value);
            const cleaned = text.replace(/[A-Za-z]+/g, '').replace(/\s{2,}/g, ' ').trim();
            return cleaned || 'ุบูุฑ ูุญุฏุฏ';
        }

        function sum(rows, key) {
            return rows.reduce((acc, row) => acc + parseFloat(row[key] || 0), 0);
        }

        function downloadAllJSON() {
            const payload = {
                invoices: store.invoices,
                payments: store.payments,
                expenses: store.expenses,
                fixed_assets: store.assets,
                payment_plans: store.plans,
                journal_entries: store.entries
            };
            downloadBlob(JSON.stringify(payload, null, 2), 'ุฅุฌุฑุงุกุงุช-ุงูุชุดุบูู-ุงููุงูู.json', 'application/json');
        }

        function downloadAllCSV() {
            const rows = [];
            rows.push(['ุงูููุงุชูุฑ']);
            rows.push(['ุฑูู ุงููุงุชูุฑุฉ','ุชุงุฑูุฎ ุงูุฅุตุฏุงุฑ','ุชุงุฑูุฎ ุงูุงุณุชุญูุงู','ุงูุนููู','ุงูุฅุฌูุงูู','ุงููุชุจูู','ุงูุญุงูุฉ']);
            store.invoices.forEach(inv => rows.push([
                sanitizeText(inv.invoice_number), inv.invoice_date, inv.due_date, sanitizeText(inv.customer_name_ar || inv.customer_name),
                inv.total_amount, inv.remaining_amount, translateStatus(inv.status)
            ]));

            rows.push([]);
            rows.push(['ุงููุฏููุนุงุช']);
            rows.push(['ุฑูู ุงูุฏูุนุฉ','ุงูุนููู','ูููุฉ ุงูุฏูุนุฉ','ุชุงุฑูุฎ ุงูุฏูุนุฉ','ุทุฑููุฉ ุงูุชุญุตูู','ุงูุญุงูุฉ']);
            store.payments.forEach(p => rows.push([
                p.payment_number || p.payment_id, sanitizeText(p.customer_name_ar || p.customer_name || p.customer_id), p.payment_amount,
                p.payment_date, translatePaymentMethod(p.payment_method), translateStatus(p.status)
            ]));

            rows.push([]);
            rows.push(['ุงููุตุฑููุงุช']);
            rows.push(['ุฑูู ุงููุตุฑูู','ุชุงุฑูุฎ ุงููุตุฑูู','ุงูููุน','ุงูููุฑุฏ','ุงูุฅุฌูุงูู','ุงูุญุงูุฉ']);
            store.expenses.forEach(e => rows.push([
                e.expense_number || e.expense_id, e.expense_date, sanitizeText(e.expense_type || e.expense_category), sanitizeText(e.vendor_name),
                e.total_amount || e.amount, translateStatus(e.status)
            ]));

            rows.push([]);
            rows.push(['ุงูุฃุตูู ุงูุซุงุจุชุฉ']);
            rows.push(['ุฑูู ุงูุฃุตู','ุงุณู ุงูุฃุตู','ุชุงุฑูุฎ ุงูุดุฑุงุก','ุชูููุฉ ุงูุดุฑุงุก','ุงููููุฉ ุงูุฏูุชุฑูุฉ','ุงูุญุงูุฉ']);
            store.assets.forEach(a => rows.push([
                a.asset_code || a.asset_id, sanitizeText(a.asset_name_ar || a.asset_name_en || a.asset_name), a.purchase_date,
                a.purchase_cost, a.net_book_value, translateStatus(a.status)
            ]));

            const csv = rows.map(r => r.map(v => `"${v ?? ''}"`).join(',')).join('\n');
            downloadBlob(csv, 'ุฅุฌุฑุงุกุงุช-ุงูุชุดุบูู-ุงููุงูู.csv', 'text/csv;charset=utf-8;');
        }

        function copySummary() {
            const summary = `ููุฎุต ุฅุฌุฑุงุกุงุช ุงูุชุดุบูู ุงููุงูู\n` +
                `ุฅุฌูุงูู ุงูููุงุชูุฑ: ${store.invoices.length}\n` +
                `ุงูููุงุชูุฑ ุงููุชุฃุฎุฑุฉ: ${store.invoices.filter(i => String(i.status || '').toUpperCase() === 'OVERDUE').length}\n` +
                `ุฅุฌูุงูู ุงููุฏููุนุงุช: ${formatMoney(sum(store.payments, 'payment_amount'))}\n` +
                `ุฅุฌูุงูู ุงููุตุฑููุงุช: ${formatMoney(sum(store.expenses, 'total_amount'))}\n` +
                `ุนุฏุฏ ุงูุฃุตูู: ${store.assets.length}\n` +
                `ุนุฏุฏ ุงููููุฏ: ${store.entries.length}`;
            navigator.clipboard.writeText(summary).catch(() => {});
        }

        function downloadBlob(content, filename, type) {
            const blob = new Blob([content], { type });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            link.click();
            URL.revokeObjectURL(url);
        }

        function printPage() {
            window.print();
        }

        function refreshData() {
            loadData();
        }

        document.addEventListener('DOMContentLoaded', loadData);
    </script>
</body>
</html>
