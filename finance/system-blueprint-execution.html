<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ§­ Ø§Ù„Ù…Ø®Ø·Ø· Ø§Ù„ØªÙ†ÙÙŠØ°ÙŠ Ù„Ù†Ø¸Ø§Ù… Ù†Ø§ÙŠÙˆØ´</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Cairo', sans-serif;
            background: linear-gradient(135deg, #0ea5e9 0%, #6366f1 50%, #10b981 100%);
            min-height: 100vh;
        }
        .glass { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); }
        .shape-a { border-radius: 26px 8px 26px 8px; }
        .shape-b { border-radius: 999px; }
        .shape-c { border-radius: 28px 28px 6px 28px; }
        .shape-d { border-radius: 18px 40px 18px 40px; }
        .shape-e { border-radius: 12px 40px 12px 40px; }
        .stat-card { transition: transform 0.3s, box-shadow 0.3s; }
        .stat-card:hover { transform: translateY(-4px); box-shadow: 0 14px 28px rgba(15,23,42,0.15); }
        .table-scroll { max-height: 520px; overflow: auto; }
        .chart-container { position: relative; height: 280px; }
        .section-accent-sky { border-top: 4px solid #0ea5e9; }
        .section-accent-emerald { border-top: 4px solid #10b981; }
        .section-accent-amber { border-top: 4px solid #f59e0b; }
        .section-accent-indigo { border-top: 4px solid #6366f1; }
        .section-accent-rose { border-top: 4px solid #f43f5e; }
        .toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); padding: 0.75rem 1.5rem; border-radius: 999px; color: white; font-weight: 700; z-index: 60; }
        .toast-success { background: #10b981; }
        .toast-info { background: #6366f1; }
    </style>
</head>
<body>
    <div class="container mx-auto px-4 py-8">
        <div class="mb-8 text-white">
            <h1 class="text-4xl font-bold mb-2">ğŸ§­ Ø§Ù„Ù…Ø®Ø·Ø· Ø§Ù„ØªÙ†ÙÙŠØ°ÙŠ Ù„Ù†Ø¸Ø§Ù… Ù†Ø§ÙŠÙˆØ´</h1>
            <p class="text-lg opacity-90">ØªØ¹Ø±ÙŠÙ Ø§Ù„ÙˆØ­Ø¯Ø§Øª ÙˆØ§Ù„Ø¬Ø¯Ø§ÙˆÙ„ ÙˆØ§Ù„ØªØ¯ÙÙ‚Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© (Ø§Ù„ØµÙØ­Ø© 35)</p>
        </div>

        <div class="mb-6 flex flex-wrap gap-3">
            <button onclick="refreshData()" class="bg-white text-sky-700 px-6 py-3 rounded-full font-bold hover:shadow-lg transition flex items-center gap-2">
                <i class="fas fa-rotate"></i>
                ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            </button>
            <button onclick="downloadJSON()" class="bg-indigo-600 text-white px-6 py-3 rounded-full font-bold hover:shadow-lg transition flex items-center gap-2">
                <i class="fas fa-file-code"></i>
                ØªÙ†Ø²ÙŠÙ„ Ù…Ù„Ù Ø¨ÙŠØ§Ù†Ø§Øª
            </button>
            <button onclick="downloadCSV()" class="bg-emerald-600 text-white px-6 py-3 rounded-full font-bold hover:shadow-lg transition flex items-center gap-2">
                <i class="fas fa-file-csv"></i>
                ØªÙ†Ø²ÙŠÙ„ Ù…Ù„Ù Ø¬Ø¯ÙˆÙ„ÙŠ
            </button>
            <button onclick="printReport()" class="bg-rose-600 text-white px-6 py-3 rounded-full font-bold hover:shadow-lg transition flex items-center gap-2">
                <i class="fas fa-print"></i>
                Ø·Ø¨Ø§Ø¹Ø©
            </button>
            <button onclick="showToast('ØªÙ… Ù†Ø³Ø® Ø§Ù„Ù…Ø®Ø·Ø· (Ù…Ø­Ø§ÙƒØ§Ø©)', 'success')" class="bg-slate-700 text-white px-6 py-3 rounded-full font-bold hover:shadow-lg transition flex items-center gap-2">
                <i class="fas fa-copy"></i>
                Ù†Ø³Ø® Ø§Ù„Ù…Ø®Ø·Ø·
            </button>
        </div>

        <div class="glass rounded-3xl shadow-2xl p-6 mb-8 section-accent-sky">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-2xl font-bold text-slate-800">âœ… ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù†Ù…Ø§Ø°Ø¬ Ø¥Ù„Ù‰ Ù…Ø®Ø·Ø· Ø¬Ø§Ù‡Ø² Ù„Ù„ØªÙ†ÙÙŠØ°</h2>
                <span class="text-sm text-slate-500">ÙˆØ­Ø¯Ø§ØªØŒ Ø¬Ø¯Ø§ÙˆÙ„ØŒ ÙˆØªØ¯ÙÙ‚Ø§Øª Ø£Ø³Ø§Ø³ÙŠØ©</span>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-5">
                <div class="stat-card shape-b bg-gradient-to-br from-sky-500 to-blue-600 text-white p-5">
                    <div class="flex justify-between mb-3"><span>Ø¹Ø¯Ø¯ Ø§Ù„ÙˆØ­Ø¯Ø§Øª</span><i class="fas fa-layer-group text-2xl opacity-70"></i></div>
                    <div id="modulesCount" class="text-3xl font-bold"><div class="animate-pulse">...</div></div>
                </div>
                <div class="stat-card shape-a bg-gradient-to-br from-emerald-500 to-teal-600 text-white p-5">
                    <div class="flex justify-between mb-3"><span>Ø¹Ø¯Ø¯ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©</span><i class="fas fa-table text-2xl opacity-70"></i></div>
                    <div id="tablesCount" class="text-3xl font-bold"><div class="animate-pulse">...</div></div>
                </div>
                <div class="stat-card shape-c bg-gradient-to-br from-amber-500 to-orange-600 text-white p-5">
                    <div class="flex justify-between mb-3"><span>Ø¹Ø¯Ø¯ Ø§Ù„ØªØ¯ÙÙ‚Ø§Øª</span><i class="fas fa-route text-2xl opacity-70"></i></div>
                    <div id="flowsCount" class="text-3xl font-bold"><div class="animate-pulse">...</div></div>
                </div>
                <div class="stat-card shape-d bg-gradient-to-br from-indigo-500 to-purple-600 text-white p-5">
                    <div class="flex justify-between mb-3"><span>Ø¹Ø¯Ø¯ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ø­ÙŠØ©</span><i class="fas fa-database text-2xl opacity-70"></i></div>
                    <div id="recordsCount" class="text-3xl font-bold"><div class="animate-pulse">...</div></div>
                </div>
            </div>
        </div>

        <div class="glass rounded-3xl shadow-2xl p-6 mb-8 section-accent-emerald">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-2xl font-bold text-slate-800">ğŸ§© Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© Ø¯Ø§Ø®Ù„ Ø§Ù„Ù†Ø¸Ø§Ù…</h2>
                <span class="text-sm text-slate-500">Ù‡ÙŠÙƒÙ„ ÙˆØ­Ø¯Ø© Ù…ØªÙƒØ§Ù…Ù„</span>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4" id="modulesGrid"></div>
        </div>

        <div class="glass rounded-3xl shadow-2xl p-6 mb-8 section-accent-indigo">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-2xl font-bold text-slate-800">ğŸ§± Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ Ø§Ù„Ø¬ÙˆÙ‡Ø±ÙŠØ© (Ù…Ø³ØªÙˆÙ‰ Ø£ÙˆÙ„)</h2>
                <span class="text-sm text-slate-500">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span>
            </div>
            <div class="table-scroll">
                <table class="w-full text-xs">
                    <thead class="bg-indigo-50 text-indigo-700">
                        <tr>
                            <th class="px-3 py-2 text-right">Ø§Ù„Ø¬Ø¯ÙˆÙ„</th>
                            <th class="px-3 py-2 text-right">Ø­Ù‚ÙˆÙ„ Ø£Ø³Ø§Ø³ÙŠØ©</th>
                            <th class="px-3 py-2 text-right">Ø¹Ø¯Ø¯ Ø§Ù„Ø³Ø¬Ù„Ø§Øª</th>
                        </tr>
                    </thead>
                    <tbody id="coreTables" class="divide-y divide-slate-100"></tbody>
                </table>
            </div>
        </div>

        <div class="glass rounded-3xl shadow-2xl p-6 mb-8 section-accent-rose">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-2xl font-bold text-slate-800">ğŸ” Ø§Ù„ØªØ¯ÙÙ‚Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©</h2>
                <span class="text-sm text-slate-500">Ø±Ø¨Ø· Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª ÙˆØ§Ù„Ù‚ÙŠÙˆØ¯ ÙˆØ§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</span>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6" id="flowsGrid"></div>
        </div>

        <div class="space-y-6">
            <details class="glass rounded-3xl shadow-2xl p-6 section-accent-sky" open>
                <summary class="text-xl font-bold text-slate-800">ğŸ“‹ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</summary>
                <div class="mt-4">
                    <div class="flex justify-between mb-2"><h4 class="font-bold text-slate-700">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</h4><span id="customersCount" class="text-sm text-slate-500"></span></div>
                    <div class="table-scroll">
                        <table class="w-full text-xs">
                            <thead id="customersHead" class="bg-sky-50 text-sky-700"></thead>
                            <tbody id="customersTable" class="divide-y divide-slate-100"></tbody>
                        </table>
                    </div>
                </div>
            </details>

            <details class="glass rounded-3xl shadow-2xl p-6 section-accent-emerald">
                <summary class="text-xl font-bold text-slate-800">ğŸ§¾ Ø¬Ø¯ÙˆÙ„ Ø§Ù„ÙÙˆØ§ØªÙŠØ±</summary>
                <div class="mt-4">
                    <div class="flex justify-between mb-2"><h4 class="font-bold text-slate-700">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙÙˆØ§ØªÙŠØ±</h4><span id="invoicesCount" class="text-sm text-slate-500"></span></div>
                    <div class="table-scroll">
                        <table class="w-full text-xs">
                            <thead id="invoicesHead" class="bg-emerald-50 text-emerald-700"></thead>
                            <tbody id="invoicesTable" class="divide-y divide-slate-100"></tbody>
                        </table>
                    </div>
                </div>
            </details>

            <details class="glass rounded-3xl shadow-2xl p-6 section-accent-amber">
                <summary class="text-xl font-bold text-slate-800">ğŸ’³ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª</summary>
                <div class="mt-4">
                    <div class="flex justify-between mb-2"><h4 class="font-bold text-slate-700">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª</h4><span id="paymentsCount" class="text-sm text-slate-500"></span></div>
                    <div class="table-scroll">
                        <table class="w-full text-xs">
                            <thead id="paymentsHead" class="bg-amber-50 text-amber-700"></thead>
                            <tbody id="paymentsTable" class="divide-y divide-slate-100"></tbody>
                        </table>
                    </div>
                </div>
            </details>

            <details class="glass rounded-3xl shadow-2xl p-6 section-accent-indigo">
                <summary class="text-xl font-bold text-slate-800">ğŸ“† Ø¬Ø¯ÙˆÙ„ Ø®Ø·Ø· Ø§Ù„Ø³Ø¯Ø§Ø¯</summary>
                <div class="mt-4">
                    <div class="flex justify-between mb-2"><h4 class="font-bold text-slate-700">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø®Ø·Ø·</h4><span id="plansCount" class="text-sm text-slate-500"></span></div>
                    <div class="table-scroll">
                        <table class="w-full text-xs">
                            <thead id="plansHead" class="bg-indigo-50 text-indigo-700"></thead>
                            <tbody id="plansTable" class="divide-y divide-slate-100"></tbody>
                        </table>
                    </div>
                </div>
            </details>

            <details class="glass rounded-3xl shadow-2xl p-6 section-accent-rose">
                <summary class="text-xl font-bold text-slate-800">ğŸ“š Ø´Ø¬Ø±Ø© Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª</summary>
                <div class="mt-4">
                    <div class="flex justify-between mb-2"><h4 class="font-bold text-slate-700">Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©</h4><span id="accountsCount" class="text-sm text-slate-500"></span></div>
                    <div class="table-scroll">
                        <table class="w-full text-xs">
                            <thead id="accountsHead" class="bg-rose-50 text-rose-700"></thead>
                            <tbody id="accountsTable" class="divide-y divide-slate-100"></tbody>
                        </table>
                    </div>
                </div>
            </details>

            <details class="glass rounded-3xl shadow-2xl p-6 section-accent-sky">
                <summary class="text-xl font-bold text-slate-800">ğŸ§¾ Ø§Ù„Ù‚ÙŠÙˆØ¯ Ø§Ù„Ù…Ø­Ø§Ø³Ø¨ÙŠØ©</summary>
                <div class="mt-4">
                    <div class="flex justify-between mb-2"><h4 class="font-bold text-slate-700">Ø§Ù„Ù‚ÙŠÙˆØ¯ Ø§Ù„Ù…Ø³Ø¬Ù„Ø©</h4><span id="entriesCount" class="text-sm text-slate-500"></span></div>
                    <div class="table-scroll">
                        <table class="w-full text-xs">
                            <thead id="entriesHead" class="bg-sky-50 text-sky-700"></thead>
                            <tbody id="entriesTable" class="divide-y divide-slate-100"></tbody>
                        </table>
                    </div>
                </div>
            </details>

            <details class="glass rounded-3xl shadow-2xl p-6 section-accent-emerald">
                <summary class="text-xl font-bold text-slate-800">ğŸ§¾ Ø³Ø·ÙˆØ± Ø§Ù„Ù‚ÙŠÙˆØ¯</summary>
                <div class="mt-4">
                    <div class="flex justify-between mb-2"><h4 class="font-bold text-slate-700">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø³Ø·ÙˆØ±</h4><span id="linesCount" class="text-sm text-slate-500"></span></div>
                    <div class="table-scroll">
                        <table class="w-full text-xs">
                            <thead id="linesHead" class="bg-emerald-50 text-emerald-700"></thead>
                            <tbody id="linesTable" class="divide-y divide-slate-100"></tbody>
                        </table>
                    </div>
                </div>
            </details>

            <details class="glass rounded-3xl shadow-2xl p-6 section-accent-amber">
                <summary class="text-xl font-bold text-slate-800">ğŸ“Š Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ§Øª ÙˆØ§Ù„Ø§Ù†Ø­Ø±Ø§ÙØ§Øª</summary>
                <div class="mt-4 space-y-6">
                    <div>
                        <div class="flex justify-between mb-2"><h4 class="font-bold text-slate-700">Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ§Øª</h4><span id="budgetsCount" class="text-sm text-slate-500"></span></div>
                        <div class="table-scroll">
                            <table class="w-full text-xs">
                                <thead id="budgetsHead" class="bg-amber-50 text-amber-700"></thead>
                                <tbody id="budgetsTable" class="divide-y divide-slate-100"></tbody>
                            </table>
                        </div>
                    </div>
                    <div>
                        <div class="flex justify-between mb-2"><h4 class="font-bold text-slate-700">Ø³Ø·ÙˆØ± Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ©</h4><span id="budgetLinesCount" class="text-sm text-slate-500"></span></div>
                        <div class="table-scroll">
                            <table class="w-full text-xs">
                                <thead id="budgetLinesHead" class="bg-indigo-50 text-indigo-700"></thead>
                                <tbody id="budgetLinesTable" class="divide-y divide-slate-100"></tbody>
                            </table>
                        </div>
                    </div>
                    <div>
                        <div class="flex justify-between mb-2"><h4 class="font-bold text-slate-700">ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø§Ù†Ø­Ø±Ø§Ù</h4><span id="variancesCount" class="text-sm text-slate-500"></span></div>
                        <div class="table-scroll">
                            <table class="w-full text-xs">
                                <thead id="variancesHead" class="bg-rose-50 text-rose-700"></thead>
                                <tbody id="variancesTable" class="divide-y divide-slate-100"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </details>

            <details class="glass rounded-3xl shadow-2xl p-6 section-accent-indigo">
                <summary class="text-xl font-bold text-slate-800">ğŸ¤– Ø°ÙƒØ§Ø¡ Ù…Ø§Ù„ÙŠ</summary>
                <div class="mt-4 space-y-6">
                    <div>
                        <div class="flex justify-between mb-2"><h4 class="font-bold text-slate-700">ØªÙ‚ÙŠÙŠÙ…Ø§Øª Ø§Ù„Ù…Ø®Ø§Ø·Ø±</h4><span id="risksCount" class="text-sm text-slate-500"></span></div>
                        <div class="table-scroll">
                            <table class="w-full text-xs">
                                <thead id="risksHead" class="bg-indigo-50 text-indigo-700"></thead>
                                <tbody id="risksTable" class="divide-y divide-slate-100"></tbody>
                            </table>
                        </div>
                    </div>
                    <div>
                        <div class="flex justify-between mb-2"><h4 class="font-bold text-slate-700">Ø§Ù„ØªÙˆÙ‚Ø¹Ø§Øª Ø§Ù„Ø°ÙƒÙŠØ©</h4><span id="forecastsCount" class="text-sm text-slate-500"></span></div>
                        <div class="table-scroll">
                            <table class="w-full text-xs">
                                <thead id="forecastsHead" class="bg-emerald-50 text-emerald-700"></thead>
                                <tbody id="forecastsTable" class="divide-y divide-slate-100"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </details>
        </div>
    </div>

    <script>
        const API_BASE = window.location.origin;
        const ENTITY_ID = '1';

        const store = {
            customers: [],
            invoices: [],
            payments: [],
            plans: [],
            accounts: [],
            entries: [],
            lines: [],
            budgets: [],
            budgetLines: [],
            variances: [],
            risks: [],
            forecasts: []
        };

        const modulesList = [
            { title: 'ÙˆØ­Ø¯Ø© Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©', icon: 'fa-book', color: 'from-sky-500 to-blue-600', key: 'accounts' },
            { title: 'ÙˆØ­Ø¯Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ ÙˆØ§Ù„Ø°Ù…Ù… Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©', icon: 'fa-users', color: 'from-emerald-500 to-teal-600', key: 'customers' },
            { title: 'ÙˆØ­Ø¯Ø© Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ† ÙˆØ§Ù„Ø°Ù…Ù… Ø§Ù„Ø¯Ø§Ø¦Ù†Ø©', icon: 'fa-hand-holding-dollar', color: 'from-amber-500 to-orange-600', key: 'payments' },
            { title: 'ÙˆØ­Ø¯Ø© Ø§Ù„ÙÙˆØªØ±Ø© ÙˆØ§Ù„ØªØ­ØµÙŠÙ„', icon: 'fa-file-invoice', color: 'from-indigo-500 to-purple-600', key: 'invoices' },
            { title: 'ÙˆØ­Ø¯Ø© Ø§Ù„Ø£ØµÙˆÙ„ Ø§Ù„Ø«Ø§Ø¨ØªØ©', icon: 'fa-industry', color: 'from-rose-500 to-red-600', key: 'assets' },
            { title: 'ÙˆØ­Ø¯Ø© Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ§Øª', icon: 'fa-coins', color: 'from-cyan-500 to-sky-600', key: 'budgets' },
            { title: 'ÙˆØ­Ø¯Ø© Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ù…Ø§Ù„ÙŠØ©', icon: 'fa-chart-line', color: 'from-fuchsia-500 to-pink-600', key: 'reports' },
            { title: 'ÙˆØ­Ø¯Ø© Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ù…Ø§Ù„ÙŠ', icon: 'fa-robot', color: 'from-slate-600 to-slate-800', key: 'forecasts' }
        ];

        const coreTablesList = [
            { name: 'Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡', fields: 'Ø§Ù„Ø¹Ù…ÙŠÙ„ØŒ Ø§Ù„ØªØµÙ†ÙŠÙØŒ Ø§Ù„Ø­Ø§Ø¶Ù†Ø©ØŒ Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬ØŒ Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ù…Ø®Ø§Ø·Ø±', key: 'customers' },
            { name: 'Ø§Ù„ÙÙˆØ§ØªÙŠØ±', fields: 'Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©ØŒ Ø§Ù„Ø¹Ù…ÙŠÙ„ØŒ Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬ØŒ Ø§Ù„Ù…Ø¨Ù„ØºØŒ Ø§Ù„Ø­Ø§Ù„Ø©ØŒ Ø§Ù„Ø³Ø¯Ø§Ø¯ Ø§Ù„Ø¬Ø²Ø¦ÙŠ', key: 'invoices' },
            { name: 'Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª', fields: 'Ø±Ù‚Ù… Ø§Ù„Ø¯ÙØ¹Ø©ØŒ Ù†ÙˆØ¹ Ø§Ù„Ø¯ÙØ¹ØŒ Ø§Ù„Ù…Ø¨Ù„ØºØŒ Ø§Ù„ÙˆØ³ÙŠÙ„Ø©ØŒ Ø§Ù„Ø±Ø¨Ø· Ø¨Ø§Ù„ÙÙˆØ§ØªÙŠØ±', key: 'payments' },
            { name: 'Ø®Ø·Ø· Ø§Ù„Ø³Ø¯Ø§Ø¯', fields: 'Ø§Ù„Ø®Ø·Ø©ØŒ Ø¹Ø¯Ø¯ Ø§Ù„Ø¯ÙØ¹Ø§ØªØŒ Ø§Ù„ØªÙˆØ§Ø±ÙŠØ®ØŒ Ø§Ù„Ù…Ø¨Ù„ØºØŒ Ø§Ù„Ø­Ø§Ù„Ø©ØŒ Ø§Ù„Ù…Ø®Ø§Ø·Ø±', key: 'plans' },
            { name: 'Ø´Ø¬Ø±Ø© Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª', fields: 'Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©', key: 'accounts' },
            { name: 'Ø§Ù„Ù‚ÙŠÙˆØ¯ ÙˆØ§Ù„Ø³Ø·ÙˆØ±', fields: 'Ø§Ù„Ù‚ÙŠÙˆØ¯ ÙˆØ³Ø·ÙˆØ±Ù‡Ø§', key: 'entries' },
            { name: 'Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ§Øª', fields: 'Ù†ÙˆØ¹ Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ©ØŒ Ø§Ù„Ø³Ù†Ø©ØŒ Ø§Ù„Ø³ÙŠÙ†Ø§Ø±ÙŠÙˆØŒ Ø§Ù„Ø­Ø§Ù„Ø©', key: 'budgets' },
            { name: 'Ø³Ø·ÙˆØ± Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ©', fields: 'Ø§Ù„Ø­Ø³Ø§Ø¨ØŒ Ù…Ø¨Ù„Øº Ø³Ù†ÙˆÙŠ/Ø´Ù‡Ø±ÙŠØŒ ÙØ±Ø¹ØŒ Ø­Ø§Ø¶Ù†Ø©ØŒ Ø¨Ø±Ù†Ø§Ù…Ø¬', key: 'budgetLines' },
            { name: 'ØªÙ‚ÙŠÙŠÙ…Ø§Øª Ø§Ù„Ù…Ø®Ø§Ø·Ø±', fields: 'Ø§Ù„Ø¹Ù…ÙŠÙ„ØŒ Ø§Ù„ØªØ§Ø±ÙŠØ®ØŒ Ø§Ù„Ø¯Ø±Ø¬Ø©ØŒ Ø§Ù„Ø£Ø³Ø¨Ø§Ø¨', key: 'risks' },
            { name: 'Ø§Ù„ØªÙˆÙ‚Ø¹Ø§Øª Ø§Ù„Ø°ÙƒÙŠØ©', fields: 'Ù†ÙˆØ¹ Ø§Ù„ØªÙˆÙ‚Ø¹ØŒ Ø§Ù„ÙØªØ±Ø©ØŒ Ø§Ù„Ù‚ÙŠÙ…Ø©ØŒ Ø§Ù„Ø«Ù‚Ø©', key: 'forecasts' }
        ];

        const flowsList = [
            {
                title: 'Ø§Ù„ØªØ¯ÙÙ‚ 1: Ù…Ù† Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø¥Ù„Ù‰ Ø§Ù„Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø­Ø§Ø³Ø¨ÙŠ',
                steps: [
                    'Ø¥Ù†Ø´Ø§Ø¡ ÙØ§ØªÙˆØ±Ø©',
                    'Ø¥Ù†Ø´Ø§Ø¡ Ù‚ÙŠÙˆØ¯ Ø¥ÙŠØ±Ø§Ø¯ ÙˆØ°Ù…Ù… Ù…Ø¯ÙŠÙ†Ø©',
                    'Ø§Ù„Ø¸Ù‡ÙˆØ± ÙÙŠ ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ø°Ù…Ù… ÙˆØ§Ù„Ø£Ø³ØªØ§Ø° Ø§Ù„Ø¹Ø§Ù…'
                ]
            },
            {
                title: 'Ø§Ù„ØªØ¯ÙÙ‚ 2: Ù…Ù† Ø§Ù„Ø¯ÙØ¹Ø© Ø¥Ù„Ù‰ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ÙØ§ØªÙˆØ±Ø©',
                steps: [
                    'ØªØ³Ø¬ÙŠÙ„ Ø¯ÙØ¹Ø© ÙƒØ§Ù…Ù„Ø© Ø£Ùˆ Ø¬Ø²Ø¦ÙŠØ©',
                    'Ø±Ø¨Ø· Ø§Ù„Ø¯ÙØ¹Ø© Ø¨Ø§Ù„ÙØ§ØªÙˆØ±Ø©',
                    'ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±ØµÙŠØ¯ ÙˆØ¥Ù†Ø´Ø§Ø¡ Ù‚ÙŠØ¯ Ù†Ù‚Ø¯ÙŠ',
                    'ØªØ­Ø¯ÙŠØ« ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ø°Ù…Ù… ÙˆØ§Ù„ØªØ¯ÙÙ‚Ø§Øª'
                ]
            },
            {
                title: 'Ø§Ù„ØªØ¯ÙÙ‚ 3: Ù…Ù† Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ© Ø¥Ù„Ù‰ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±',
                steps: [
                    'Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ© ÙˆØªÙˆØ²ÙŠØ¹Ù‡Ø§',
                    'Ù…Ù‚Ø§Ø±Ù†Ø© Ø§Ù„ÙØ¹Ù„ÙŠ Ø¨Ø§Ù„Ù…Ø®Ø·Ø·',
                    'ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø§Ù†Ø­Ø±Ø§ÙØ§Øª Ù„Ø¹Ø±Ø¶Ù‡Ø§ ÙÙŠ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±'
                ]
            },
            {
                title: 'Ø§Ù„ØªØ¯ÙÙ‚ 4: Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ù„Ù‰ Ø§Ù„ØªÙˆÙ‚Ø¹Ø§Øª Ø§Ù„Ø°ÙƒÙŠØ©',
                steps: [
                    'Ø³Ø­Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø¢Ø®Ø± 12 Ø¥Ù„Ù‰ 36 Ø´Ù‡Ø±',
                    'ØªØºØ°ÙŠØ© Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ù…Ø§Ù„ÙŠ',
                    'ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù†ØªØ§Ø¦Ø¬ ÙˆØ¹Ø±Ø¶Ù‡Ø§ ÙÙŠ Ø§Ù„Ù„ÙˆØ­Ø§Øª'
                ]
            }
        ];

        async function fetchJson(url) {
            const res = await fetch(url);
            const data = await res.json();
            return { ok: res.ok, data };
        }

        async function loadData() {
            try {
                const [customersRes, invoicesRes, paymentsRes, plansRes, accountsRes, entriesRes, linesRes, budgetsRes, risksRes, forecastsRes] = await Promise.all([
                    fetchJson(`${API_BASE}/finance/customers`),
                    fetchJson(`${API_BASE}/finance/invoices`),
                    fetchJson(`${API_BASE}/finance/payments`),
                    fetchJson(`${API_BASE}/finance/payment-plans?entity_id=${ENTITY_ID}`),
                    fetchJson(`${API_BASE}/finance/accounts?entity_id=${ENTITY_ID}`),
                    fetchJson(`${API_BASE}/finance/journal/entries?entity_id=${ENTITY_ID}`),
                    fetchJson(`${API_BASE}/finance/journal-lines?entity_id=${ENTITY_ID}`),
                    fetchJson(`${API_BASE}/finance/budgets?entity_id=${ENTITY_ID}`),
                    fetchJson(`${API_BASE}/finance/ai-risk-scores?entity_id=${ENTITY_ID}`),
                    fetchJson(`${API_BASE}/finance/ai-forecasts?entity_id=${ENTITY_ID}`)
                ]);

                store.customers = customersRes.data.customers || [];
                store.invoices = invoicesRes.data.invoices || [];
                store.payments = paymentsRes.data.payments || [];
                store.plans = plansRes.data.plans || [];
                store.accounts = accountsRes.data.accounts || accountsRes.data.rows || [];
                store.entries = entriesRes.data.entries || [];
                store.lines = linesRes.data.lines || [];
                store.budgets = budgetsRes.data.budgets || [];
                store.budgetLines = budgetsRes.data.lines || [];
                store.variances = budgetsRes.data.variances || [];
                store.risks = risksRes.data.rows || [];
                store.forecasts = forecastsRes.data.forecasts || [];

                renderKPIs();
                renderModules();
                renderCoreTables();
                renderFlows();
                renderAllTables();
            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', error);
            }
        }

        function renderKPIs() {
            const moduleCount = modulesList.length;
            const tableCount = coreTablesList.length;
            const flowsCount = flowsList.length;
            const recordsCount = store.customers.length + store.invoices.length + store.payments.length + store.plans.length + store.accounts.length + store.entries.length + store.lines.length + store.budgets.length + store.budgetLines.length + store.variances.length + store.risks.length + store.forecasts.length;

            document.getElementById('modulesCount').textContent = moduleCount.toLocaleString('ar-SA');
            document.getElementById('tablesCount').textContent = tableCount.toLocaleString('ar-SA');
            document.getElementById('flowsCount').textContent = flowsCount.toLocaleString('ar-SA');
            document.getElementById('recordsCount').textContent = recordsCount.toLocaleString('ar-SA');
        }

        function renderModules() {
            const grid = document.getElementById('modulesGrid');
            grid.innerHTML = modulesList.map((m, idx) => {
                const count = getModuleCount(m.key);
                const shape = idx % 3 === 0 ? 'shape-a' : idx % 3 === 1 ? 'shape-c' : 'shape-d';
                return `
                    <div class="stat-card ${shape} bg-gradient-to-br ${m.color} text-white p-5">
                        <div class="flex justify-between mb-3"><span>${m.title}</span><i class="fas ${m.icon} text-2xl opacity-70"></i></div>
                        <div class="text-2xl font-bold">${count.toLocaleString('ar-SA')}</div>
                        <div class="text-xs opacity-90">Ø¹Ø¯Ø¯ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø©</div>
                    </div>
                `;
            }).join('');
        }

        function renderCoreTables() {
            const body = document.getElementById('coreTables');
            body.innerHTML = coreTablesList.map(row => `
                <tr class="hover:bg-indigo-50">
                    <td class="px-3 py-2">${row.name}</td>
                    <td class="px-3 py-2">${row.fields}</td>
                    <td class="px-3 py-2">${getModuleCount(row.key).toLocaleString('ar-SA')}</td>
                </tr>
            `).join('');
        }

        function renderFlows() {
            const grid = document.getElementById('flowsGrid');
            grid.innerHTML = flowsList.map((flow, idx) => `
                <div class="glass p-5 shadow-lg ${idx % 2 === 0 ? 'shape-b' : 'shape-e'}">
                    <div class="font-bold text-slate-800 mb-3">${flow.title}</div>
                    <ul class="text-sm text-slate-700 space-y-2">
                        ${flow.steps.map(step => `<li>â€¢ ${step}</li>`).join('')}
                    </ul>
                </div>
            `).join('');
        }

        function renderAllTables() {
            renderDynamicTable('customersHead', 'customersTable', store.customers, 'customersCount');
            renderDynamicTable('invoicesHead', 'invoicesTable', store.invoices, 'invoicesCount');
            renderDynamicTable('paymentsHead', 'paymentsTable', store.payments, 'paymentsCount');
            renderDynamicTable('plansHead', 'plansTable', store.plans, 'plansCount');
            renderDynamicTable('accountsHead', 'accountsTable', store.accounts, 'accountsCount');
            renderDynamicTable('entriesHead', 'entriesTable', store.entries, 'entriesCount');
            renderDynamicTable('linesHead', 'linesTable', store.lines, 'linesCount');
            renderDynamicTable('budgetsHead', 'budgetsTable', store.budgets, 'budgetsCount');
            renderDynamicTable('budgetLinesHead', 'budgetLinesTable', store.budgetLines, 'budgetLinesCount');
            renderDynamicTable('variancesHead', 'variancesTable', store.variances, 'variancesCount');
            renderDynamicTable('risksHead', 'risksTable', store.risks, 'risksCount');
            renderDynamicTable('forecastsHead', 'forecastsTable', store.forecasts, 'forecastsCount');
        }

        function renderDynamicTable(headId, bodyId, rows, countId) {
            const head = document.getElementById(headId);
            const body = document.getElementById(bodyId);
            const count = document.getElementById(countId);
            count.textContent = `Ø¹Ø¯Ø¯ Ø§Ù„ØµÙÙˆÙ: ${rows.length}`;

            if (!rows.length) {
                head.innerHTML = '';
                body.innerHTML = `<tr><td class="px-4 py-8 text-center text-slate-500">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</td></tr>`;
                return;
            }

            const columns = Array.from(new Set(rows.flatMap(row => Object.keys(row))));
            head.innerHTML = `<tr>${columns.map(c => `<th class="px-3 py-2 text-right">${translateHeader(c)}</th>`).join('')}</tr>`;
            body.innerHTML = rows.map(row => `
                <tr class="hover:bg-slate-50">
                    ${columns.map(c => `<td class="px-3 py-2">${formatValue(c, row[c])}</td>`).join('')}
                </tr>
            `).join('');
        }

        function translateHeader(key) {
            const map = {
                customer_id: 'Ø±Ù‚Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„',
                customer_name_ar: 'Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„',
                customer_name_en: 'Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„',
                customer_code: 'ÙƒÙˆØ¯ Ø§Ù„Ø¹Ù…ÙŠÙ„',
                customer_type: 'Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù…ÙŠÙ„',
                invoice_id: 'Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©',
                invoice_number: 'Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©',
                invoice_date: 'ØªØ§Ø±ÙŠØ® Ø§Ù„ÙØ§ØªÙˆØ±Ø©',
                due_date: 'ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚',
                total_amount: 'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨Ù„Øº',
                paid_amount: 'Ø§Ù„Ù…Ø¯ÙÙˆØ¹',
                remaining_amount: 'Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ',
                status: 'Ø§Ù„Ø­Ø§Ù„Ø©',
                payment_status: 'Ø­Ø§Ù„Ø© Ø§Ù„Ø³Ø¯Ø§Ø¯',
                payment_id: 'Ø±Ù‚Ù… Ø§Ù„Ø¯ÙØ¹Ø©',
                payment_number: 'Ø±Ù‚Ù… Ø§Ù„Ø¯ÙØ¹Ø©',
                payment_date: 'ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¯ÙØ¹',
                payment_amount: 'Ù…Ø¨Ù„Øº Ø§Ù„Ø¯ÙØ¹',
                payment_method: 'ÙˆØ³ÙŠÙ„Ø© Ø§Ù„Ø¯ÙØ¹',
                payment_type: 'Ù†ÙˆØ¹ Ø§Ù„Ø¯ÙØ¹',
                plan_id: 'Ø±Ù‚Ù… Ø§Ù„Ø®Ø·Ø©',
                plan_number: 'Ø±Ù‚Ù… Ø§Ù„Ø®Ø·Ø©',
                plan_status: 'Ø­Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø©',
                number_of_installments: 'Ø¹Ø¯Ø¯ Ø§Ù„Ø¯ÙØ¹Ø§Øª',
                installment_amount: 'Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¯ÙØ¹Ø©',
                installment_frequency: 'ØªÙƒØ±Ø§Ø± Ø§Ù„Ø¯ÙØ¹Ø§Øª',
                account_id: 'Ø±Ù‚Ù… Ø§Ù„Ø­Ø³Ø§Ø¨',
                account_code: 'ÙƒÙˆØ¯ Ø§Ù„Ø­Ø³Ø§Ø¨',
                account_name: 'Ø§Ø³Ù… Ø§Ù„Ø­Ø³Ø§Ø¨',
                account_name_ar: 'Ø§Ø³Ù… Ø§Ù„Ø­Ø³Ø§Ø¨',
                account_type: 'Ù†ÙˆØ¹ Ø§Ù„Ø­Ø³Ø§Ø¨',
                entry_id: 'Ø±Ù‚Ù… Ø§Ù„Ù‚ÙŠØ¯',
                entry_number: 'Ø±Ù‚Ù… Ø§Ù„Ù‚ÙŠØ¯',
                entry_date: 'ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‚ÙŠØ¯',
                entry_type: 'Ù†ÙˆØ¹ Ø§Ù„Ù‚ÙŠØ¯',
                debit_amount: 'Ù…Ø¯ÙŠÙ†',
                credit_amount: 'Ø¯Ø§Ø¦Ù†',
                budget_id: 'Ø±Ù‚Ù… Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ©',
                budget_code: 'ÙƒÙˆØ¯ Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ©',
                budget_name_ar: 'Ø§Ø³Ù… Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ©',
                budget_name_en: 'Ø§Ø³Ù… Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ©',
                budget_type: 'Ù†ÙˆØ¹ Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ©',
                fiscal_year: 'Ø§Ù„Ø³Ù†Ø© Ø§Ù„Ù…Ø§Ù„ÙŠØ©',
                fiscal_period: 'Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ù…Ø§Ù„ÙŠØ©',
                scenario: 'Ø§Ù„Ø³ÙŠÙ†Ø§Ø±ÙŠÙˆ',
                period_name: 'Ø§Ø³Ù… Ø§Ù„ÙØªØ±Ø©',
                budgeted_amount: 'Ø§Ù„Ù…Ø®Ø·Ø·',
                actual_amount: 'Ø§Ù„ÙØ¹Ù„ÙŠ',
                variance_amount: 'Ø§Ù„Ø§Ù†Ø­Ø±Ø§Ù',
                variance_percentage: 'Ù†Ø³Ø¨Ø© Ø§Ù„Ø§Ù†Ø­Ø±Ø§Ù',
                variance_type: 'Ù†ÙˆØ¹ Ø§Ù„Ø§Ù†Ø­Ø±Ø§Ù',
                significance_level: 'Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø£Ù‡Ù…ÙŠØ©',
                risk_id: 'Ø±Ù‚Ù… Ø§Ù„Ù…Ø®Ø§Ø·Ø±',
                risk_level: 'Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ù…Ø®Ø§Ø·Ø±',
                risk_score: 'Ø¯Ø±Ø¬Ø© Ø§Ù„Ù…Ø®Ø§Ø·Ø±',
                forecast_id: 'Ø±Ù‚Ù… Ø§Ù„ØªÙˆÙ‚Ø¹',
                forecast_type: 'Ù†ÙˆØ¹ Ø§Ù„ØªÙˆÙ‚Ø¹',
                forecast_period: 'ÙØªØ±Ø© Ø§Ù„ØªÙˆÙ‚Ø¹',
                forecast_amount: 'Ù‚ÙŠÙ…Ø© Ø§Ù„ØªÙˆÙ‚Ø¹',
                confidence_level: 'Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø«Ù‚Ø©',
                entity_type: 'Ù†ÙˆØ¹ Ø§Ù„Ù…Ù†Ø´Ø£Ø©',
                entity_id: 'Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ù†Ø´Ø£Ø©',
                created_at: 'ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡',
                updated_at: 'ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ­Ø¯ÙŠØ«'
            };
            return map[key] || 'Ø­Ù‚Ù„ Ø¥Ø¶Ø§ÙÙŠ';
        }

        function formatValue(key, value) {
            if (value === null || value === undefined || value === '') return '-';
            if (key.includes('date') || key.endsWith('_at')) return formatDateTime(value);
            if (key.includes('amount') || key.includes('total') || key.includes('balance') || key.includes('cost') || key.includes('value') || key.includes('budgeted') || key.includes('actual') || key.includes('variance')) return formatMoney(value);
            if (key.includes('percentage') || key.includes('rate') || key.includes('score') || key.includes('confidence')) return formatPercent(value);
            if (key === 'status') return translateStatus(value);
            if (key === 'payment_status') return translateStatus(value);
            if (key === 'payment_type') return translatePaymentType(value);
            if (key === 'payment_method') return translatePaymentMethod(value);
            if (key === 'account_type') return translateAccountType(value);
            if (key === 'entry_type') return translateEntryType(value);
            if (key === 'budget_type') return translateBudgetType(value);
            if (key === 'scenario') return translateScenario(value);
            if (key === 'risk_level') return translateRiskLevel(value);
            if (key === 'forecast_type') return translateForecastType(value);
            if (key === 'entity_type') return translateEntityType(value);
            if (typeof value === 'boolean') return value ? 'Ù†Ø¹Ù…' : 'Ù„Ø§';
            return sanitizeText(value);
        }

        function translateStatus(value) {
            const map = { PAID: 'Ù…Ø¯ÙÙˆØ¹', OVERDUE: 'Ù…ØªØ£Ø®Ø±', PARTIAL: 'Ø¬Ø²Ø¦ÙŠ', OPEN: 'Ù…ÙØªÙˆØ­', APPROVED: 'Ù…Ø¹ØªÙ…Ø¯', POSTED: 'Ù…Ø±Ø­Ù„', ACTIVE: 'Ù†Ø´Ø·', CLOSED: 'Ù…ØºÙ„Ù‚', DRAFT: 'Ù…Ø³ÙˆØ¯Ø©', CANCELLED: 'Ù…Ù„ØºÙŠ' };
            return map[String(value || '').toUpperCase()] || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
        }

        function translatePaymentType(value) {
            const map = { FULL: 'ÙƒØ§Ù…Ù„', PARTIAL: 'Ø¬Ø²Ø¦ÙŠ', INSTALLMENT: 'Ø£Ù‚Ø³Ø§Ø·' };
            return map[String(value || '').toUpperCase()] || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
        }

        function translatePaymentMethod(value) {
            const map = { CASH: 'Ù†Ù‚Ø¯ÙŠ', BANK_TRANSFER: 'ØªØ­ÙˆÙŠÙ„ Ø¨Ù†ÙƒÙŠ', CARD: 'Ø¨Ø·Ø§Ù‚Ø©', CHECK: 'Ø´ÙŠÙƒ', ONLINE: 'Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ' };
            return map[String(value || '').toUpperCase()] || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
        }

        function translateAccountType(value) {
            const map = { REVENUE: 'Ø¥ÙŠØ±Ø§Ø¯Ø§Øª', EXPENSE: 'Ù…ØµØ±ÙˆÙØ§Øª', ASSET: 'Ø£ØµÙˆÙ„', LIABILITY: 'Ø§Ù„ØªØ²Ø§Ù…Ø§Øª', EQUITY: 'Ø­Ù‚ÙˆÙ‚ Ù…Ù„ÙƒÙŠØ©' };
            return map[String(value || '').toUpperCase()] || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
        }

        function translateEntryType(value) {
            const map = { AUTO: 'Ø¢Ù„ÙŠ', MANUAL: 'ÙŠØ¯ÙˆÙŠ' };
            return map[String(value || '').toUpperCase()] || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
        }

        function translateBudgetType(value) {
            const map = { REVENUE: 'Ù…ÙŠØ²Ø§Ù†ÙŠØ© Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª', EXPENSE: 'Ù…ÙŠØ²Ø§Ù†ÙŠØ© Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª', CASHFLOW: 'Ù…ÙŠØ²Ø§Ù†ÙŠØ© Ø§Ù„ØªØ¯ÙÙ‚Ø§Øª', CAPITAL: 'Ù…ÙŠØ²Ø§Ù†ÙŠØ© Ø±Ø£Ø³ Ø§Ù„Ù…Ø§Ù„' };
            return map[String(value || '').toUpperCase()] || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
        }

        function translateScenario(value) {
            const map = { CONSERVATIVE: 'Ù…ØªØ­ÙØ¸', OPTIMISTIC: 'Ù…ØªÙØ§Ø¦Ù„', BASE: 'Ø£Ø³Ø§Ø³ÙŠ', BASIC: 'Ø£Ø³Ø§Ø³ÙŠ' };
            return map[String(value || '').toUpperCase()] || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
        }

        function translateRiskLevel(value) {
            const map = { HIGH: 'Ù…Ø±ØªÙØ¹', MEDIUM: 'Ù…ØªÙˆØ³Ø·', LOW: 'Ù…Ù†Ø®ÙØ¶', CRITICAL: 'Ø­Ø±Ø¬' };
            return map[String(value || '').toUpperCase()] || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
        }

        function translateForecastType(value) {
            const map = { REVENUE: 'Ø¥ÙŠØ±Ø§Ø¯Ø§Øª', EXPENSE: 'Ù…ØµØ±ÙˆÙØ§Øª', CASHFLOW: 'ØªØ¯ÙÙ‚Ø§Øª Ù†Ù‚Ø¯ÙŠØ©', DEFAULT: 'ØªØ¹Ø«Ø±' };
            return map[String(value || '').toUpperCase()] || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
        }

        function translateEntityType(value) {
            const map = { HQ: 'Ù…Ø±ÙƒØ² Ø±Ø¦ÙŠØ³ÙŠ', BRANCH: 'ÙØ±Ø¹', PLATFORM: 'Ù…Ù†ØµØ©', INCUBATOR: 'Ø­Ø§Ø¶Ù†Ø©', PROGRAM: 'Ø¨Ø±Ù†Ø§Ù…Ø¬' };
            return map[String(value || '').toUpperCase()] || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
        }

        function formatMoney(value) {
            const num = parseFloat(value || 0);
            return num.toLocaleString('ar-SA') + ' Ø±.Ø³';
        }

        function formatPercent(value) {
            const num = parseFloat(value || 0);
            return `${num.toFixed(1)}%`;
        }

        function formatDateTime(value) {
            if (!value) return '-';
            return new Date(value).toLocaleString('ar-SA');
        }

        function sanitizeText(value) {
            if (value === null || value === undefined || value === '') return '-';
            const text = typeof value === 'string' ? value : JSON.stringify(value);
            const cleaned = text.replace(/[A-Za-z]+/g, '').replace(/\s{2,}/g, ' ').trim();
            return cleaned || '-';
        }

        function getModuleCount(key) {
            const map = {
                customers: store.customers.length,
                invoices: store.invoices.length,
                payments: store.payments.length,
                plans: store.plans.length,
                accounts: store.accounts.length,
                budgets: store.budgets.length,
                entries: store.entries.length,
                risks: store.risks.length,
                forecasts: store.forecasts.length,
                assets: 0,
                reports: store.variances.length
            };
            return map[key] || 0;
        }

        function downloadJSON() {
            downloadBlob(JSON.stringify(store, null, 2), 'Ø§Ù„Ù…Ø®Ø·Ø·-Ø§Ù„ØªÙ†ÙÙŠØ°ÙŠ-Ù„Ù†Ø¸Ø§Ù…-Ù†Ø§ÙŠÙˆØ´.json', 'application/json');
        }

        function downloadCSV() {
            const rows = [];
            rows.push(['Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡']);
            rows.push(['Ø±Ù‚Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„','Ø§Ù„Ø§Ø³Ù…','Ø§Ù„ØªØµÙ†ÙŠÙ']);
            store.customers.forEach(c => rows.push([c.customer_id, c.customer_name_ar || c.customer_name_en, c.customer_type]));

            rows.push([]);
            rows.push(['Ø§Ù„ÙÙˆØ§ØªÙŠØ±']);
            rows.push(['Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©','Ø§Ù„Ø¹Ù…ÙŠÙ„','Ø§Ù„Ù…Ø¨Ù„Øº','Ø§Ù„Ø­Ø§Ù„Ø©']);
            store.invoices.forEach(i => rows.push([i.invoice_number, i.customer_name_ar || i.customer_name, i.total_amount, translateStatus(i.status)]));

            rows.push([]);
            rows.push(['Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª']);
            rows.push(['Ø±Ù‚Ù… Ø§Ù„Ø¯ÙØ¹Ø©','Ø§Ù„Ù…Ø¨Ù„Øº','Ø§Ù„ÙˆØ³ÙŠÙ„Ø©','Ø§Ù„Ø­Ø§Ù„Ø©']);
            store.payments.forEach(p => rows.push([p.payment_number, p.payment_amount, translatePaymentMethod(p.payment_method), translateStatus(p.status)]));

            rows.push([]);
            rows.push(['Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ§Øª']);
            rows.push(['ÙƒÙˆØ¯ Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ©','Ø§Ù„Ù†ÙˆØ¹','Ø§Ù„Ø³Ù†Ø©','Ø§Ù„Ø­Ø§Ù„Ø©']);
            store.budgets.forEach(b => rows.push([b.budget_code, translateBudgetType(b.budget_type), b.fiscal_year, translateStatus(b.status)]));

            rows.push([]);
            rows.push(['ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø§Ù†Ø­Ø±Ø§Ù']);
            rows.push(['Ø§Ù„ÙØªØ±Ø©','Ø§Ù„Ø­Ø³Ø§Ø¨','Ø§Ù„Ø§Ù†Ø­Ø±Ø§Ù','Ø§Ù„Ù†Ø³Ø¨Ø©']);
            store.variances.forEach(v => rows.push([v.period_name, v.account_code, v.variance_amount, v.variance_percentage]));

            const csvContent = rows.map(r => r.map(v => `"${sanitizeText(v) ?? ''}"`).join(',')).join('\n');
            downloadBlob(csvContent, 'Ø§Ù„Ù…Ø®Ø·Ø·-Ø§Ù„ØªÙ†ÙÙŠØ°ÙŠ-Ù„Ù†Ø¸Ø§Ù…-Ù†Ø§ÙŠÙˆØ´.csv', 'text/csv;charset=utf-8;');
        }

        function downloadBlob(content, filename, type) {
            const blob = new Blob([content], { type });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            link.click();
            URL.revokeObjectURL(url);
        }

        function showToast(message, type) {
            const toast = document.createElement('div');
            toast.className = `toast ${type === 'success' ? 'toast-success' : 'toast-info'}`;
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 2000);
        }

        function printReport() { window.print(); }
        function refreshData() { loadData(); }

        document.addEventListener('DOMContentLoaded', loadData);
    </script>
</body>
</html>
