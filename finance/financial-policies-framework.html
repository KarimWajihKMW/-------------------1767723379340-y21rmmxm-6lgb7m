<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>๐ ุงูุณูุงุณุงุช ุงููุงููุฉ ุงูุฃุณุงุณูุฉ - ูุธุงู ูุงููุด</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Cairo', sans-serif; background-color: #f9fafb; color: #0f172a; }
        
        .card-gradient {
            background: linear-gradient(145deg, #ffffff, #f3f4f6);
            border: 1px solid #e2e8f0;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
    
        .shape-rounded { border-radius: 26px; }
        .shape-angled { border-radius: 34px 10px 34px 10px; }
        .shape-pill { border-radius: 999px; }
        .shape-cut { border-radius: 18px 18px 42px 8px; }
        .table-scroll { max-height: 520px; overflow: auto; }
        .chart-box { position: relative; height: 260px; }
        .accent-sky { border-top: 4px solid #0ea5e9; }
        .accent-indigo { border-top: 4px solid #6366f1; }
        .accent-emerald { border-top: 4px solid #10b981; }
        .accent-rose { border-top: 4px solid #f43f5e; }
        .accent-amber { border-top: 4px solid #f59e0b; }
        .modal-backdrop { position: fixed; inset: 0; background: rgba(15, 23, 42, 0.35); display: flex; align-items: center; justify-content: center; z-index: 50; }
        .modal-box { background: #fff; border-radius: 18px; width: min(900px, 96%); max-height: 90vh; overflow: auto; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); }
        .badge { display: inline-flex; align-items: center; gap: 6px; padding: 4px 10px; border-radius: 999px; font-size: 12px; font-weight: 700; }
        .action-btn { border: 1px solid #e2e8f0; padding: 6px 10px; border-radius: 10px; font-weight: 700; transition: all 0.15s ease; }
        .action-btn:hover { transform: translateY(-1px); box-shadow: 0 6px 14px -6px rgba(0,0,0,0.35); }
    </style>
</head>
<body>
    <div class="container mx-auto px-4 py-8">
        <div class="text-slate-900 mb-8">
            <h1 class="text-4xl font-bold mb-2">๐ ุงูุณูุงุณุงุช ุงููุงููุฉ ุงูุฃุณุงุณูุฉ</h1>
            <p class="text-lg text-slate-600">ุญูููุฉ ุงูููุชุฑุฉ ูุงูุชุญุตูู ูุงููุตุฑููุงุช ูุงูุฃุตูู ูุงูุฅููุงู (ุงูุตูุญุฉ 39)</p>
        </div>

        <div class="mb-6 flex flex-wrap gap-3">
            <button onclick="refreshData()" class="bg-white text-sky-700 border border-sky-100 shadow-sm px-6 py-3 rounded-full font-bold hover:shadow-lg transition flex items-center gap-2">
                <i class="fas fa-rotate"></i>
                ุชุญุฏูุซ ุงูุจูุงูุงุช
            </button>
            <button onclick="downloadAllJSON()" class="bg-indigo-600 text-white px-6 py-3 rounded-full font-bold hover:shadow-lg transition flex items-center gap-2">
                <i class="fas fa-file-code"></i>
                ุชูุฒูู ููู ุจูุงูุงุช ุดุงูู
            </button>
            <button onclick="downloadAllCSV()" class="bg-emerald-600 text-white px-6 py-3 rounded-full font-bold hover:shadow-lg transition flex items-center gap-2">
                <i class="fas fa-file-csv"></i>
                ุชูุฒูู ููู ุฌุฏููู ุดุงูู
            </button>
            <button onclick="printPage()" class="bg-rose-600 text-white px-6 py-3 rounded-full font-bold hover:shadow-lg transition flex items-center gap-2">
                <i class="fas fa-print"></i>
                ุทุจุงุนุฉ ุงูุตูุญุฉ
            </button>
            <button onclick="copySummary()" class="bg-amber-500 text-white px-6 py-3 rounded-full font-bold hover:shadow-lg transition flex items-center gap-2">
                <i class="fas fa-copy"></i>
                ูุณุฎ ููุฎุต ุงูุณูุงุณุงุช
            </button>
        </div>

        <div class="card-gradient shape-rounded shadow-2xl p-6 mb-8 accent-sky">
            <div class="flex flex-wrap items-center justify-between gap-3 mb-6">
                <h2 class="text-2xl font-bold text-slate-800">๐งพ ุณูุงุณุฉ ุงูููุชุฑุฉ</h2>
                <span class="text-sm text-slate-500">ุดุฑูุท ุฅุตุฏุงุฑ ุงูููุงุชูุฑ ูุงูุชุนุฏูู</span>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5">
                <div class="card-gradient shape-angled p-5 shadow-lg border border-sky-100">
                    <h3 class="font-bold text-slate-800 mb-2">ุดุฑูุท ุงูุฅุตุฏุงุฑ</h3>
                    <ul class="text-sm text-slate-600 space-y-1">
                        <li>ูุฌูุฏ ุนูุฏ ุฃู ุทูุจ ุฎุฏูุฉ</li>
                        <li>ุชุญุฏูุฏ ุงูุจุฑูุงูุฌ ูุงูุญุงุถูุฉ</li>
                        <li>ุชุณุฌูู ุงูุนููู ูู ุงููุธุงู</li>
                    </ul>
                </div>
                <div class="card-gradient shape-cut p-5 shadow-lg border border-emerald-100">
                    <h3 class="font-bold text-slate-800 mb-2">ูุญุชูู ุงููุงุชูุฑุฉ</h3>
                    <ul class="text-sm text-slate-600 space-y-1">
                        <li>ุฑูู ูุฑูุฏ ูุชุงุฑูุฎ ุฅุตุฏุงุฑ</li>
                        <li>ุชุงุฑูุฎ ุงูุงุณุชุญูุงู</li>
                        <li>ุชูุงุตูู ุงูุฎุฏูุฉ ูุณูุงุณุฉ ุงูุฏูุน ุงูุฌุฒุฆู</li>
                    </ul>
                </div>
                <div class="card-gradient shape-pill p-5 shadow-lg border border-rose-100">
                    <h3 class="font-bold text-slate-800 mb-2">ุณูุงุณุฉ ุงูุชุนุฏูู</h3>
                    <ul class="text-sm text-slate-600 space-y-1">
                        <li>ูุง ุชุนุฏูู ุจุนุฏ ุงูุฅุตุฏุงุฑ ุฅูุง ุจุฅุดุนุงุฑ ุฏุงุฆู/ูุฏูู</li>
                        <li>ููุงููุฉ ูุฏูุฑ ุงููุงููุฉ</li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="card-gradient shape-rounded shadow-2xl p-6 mb-8 accent-emerald">
            <div class="flex flex-wrap items-center justify-between gap-3 mb-6">
                <h2 class="text-2xl font-bold text-slate-800">๐ณ ุณูุงุณุฉ ุงูุชุญุตูู</h2>
                <span class="text-sm text-slate-500">ูููุงุช ุงูุฏูุน ูุถูุงุจุท ุงูุฅุบูุงู</span>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5">
                <div class="card-gradient shape-angled p-5 shadow-lg border border-emerald-100">
                    <h3 class="font-bold text-slate-800 mb-2">ูููุงุช ุงูุชุญุตูู ุงููุนุชูุฏุฉ</h3>
                    <ul class="text-sm text-slate-600 space-y-1">
                        <li>ุจูุงุจุฉ ุงูุฏูุน</li>
                        <li>ุงูุชุญููู ุงูุจููู</li>
                        <li>ููุงุท ุงูุจูุน</li>
                        <li>ุงูููุฏ ุถูู ุญุฏูุฏ ูุนุชูุฏุฉ</li>
                    </ul>
                </div>
                <div class="card-gradient shape-cut p-5 shadow-lg border border-amber-100">
                    <h3 class="font-bold text-slate-800 mb-2">ุงูุฏูุน ุงูุฌุฒุฆู</h3>
                    <ul class="text-sm text-slate-600 space-y-1">
                        <li>ุญุณุจ ููุน ุงูุจุฑูุงูุฌ</li>
                        <li>ุญุณุจ ุณูุงุณุฉ ุงูุญุงุถูุฉ</li>
                        <li>ููู ุฏุฑุฌุฉ ุงููุฎุงุทุฑ</li>
                    </ul>
                </div>
                <div class="card-gradient shape-pill p-5 shadow-lg border border-rose-100">
                    <h3 class="font-bold text-slate-800 mb-2">ุถูุงุจุท ุงูุฅุบูุงู</h3>
                    <ul class="text-sm text-slate-600 space-y-1">
                        <li>ูุง ููุณูุญ ุจุฅุบูุงู ูุงุชูุฑุฉ ูุฏูููุง</li>
                        <li>ูู ุฏูุนุฉ ุชูููุฏ ููุฏูุง ูุญุงุณุจููุง ุชููุงุฆููุง</li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="card-gradient shape-rounded shadow-2xl p-6 mb-8 accent-amber">
            <div class="flex flex-wrap items-center justify-between gap-3 mb-6">
                <h2 class="text-2xl font-bold text-slate-800">๐งพ ุณูุงุณุฉ ุงููุตุฑููุงุช</h2>
                <span class="text-sm text-slate-500">ุชุตููู ุงููุตุฑููุงุช ูุงุนุชูุงุฏูุง</span>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5">
                <div class="card-gradient shape-angled p-5 shadow-lg border border-amber-100">
                    <h3 class="font-bold text-slate-800 mb-2">ุชุตููู ุงููุตุฑููุงุช</h3>
                    <ul class="text-sm text-slate-600 space-y-1">
                        <li>ุชุดุบูููุฉ</li>
                        <li>ุฅุฏุงุฑูุฉ</li>
                        <li>ุจุฑุงูุฌ</li>
                        <li>ุชูููุฉ</li>
                        <li>ุชุณููู</li>
                    </ul>
                </div>
                <div class="card-gradient shape-cut p-5 shadow-lg border border-emerald-100">
                    <h3 class="font-bold text-slate-800 mb-2">ูุชุทูุจุงุช ุงูุงุนุชูุงุฏ</h3>
                    <ul class="text-sm text-slate-600 space-y-1">
                        <li>ุทูุจ ุดุฑุงุก</li>
                        <li>ุนุฑุถ ุณุนุฑ</li>
                        <li>ูุงุชูุฑุฉ ููุฑุฏ</li>
                    </ul>
                </div>
                <div class="card-gradient shape-pill p-5 shadow-lg border border-rose-100">
                    <h3 class="font-bold text-slate-800 mb-2">ุญุฏูุฏ ุงูููุงููุฉ</h3>
                    <p class="text-sm text-slate-600">ุงููุตุฑููุงุช ุงููุจูุฑุฉ ุชุญุชุงุฌ ููุงููุฉ ูุฏูุฑ ุงููุงููุฉ ูุงููุฏูุฑ ุงููุงูู ูููุฌููุนุฉ.</p>
                </div>
            </div>
        </div>

        <div class="card-gradient shape-rounded shadow-2xl p-6 mb-8 accent-indigo">
            <div class="flex flex-wrap items-center justify-between gap-3 mb-6">
                <h2 class="text-2xl font-bold text-slate-800">๐ข ุณูุงุณุฉ ุงูุฃุตูู ุงูุซุงุจุชุฉ</h2>
                <span class="text-sm text-slate-500">ุฅุซุจุงุช ุงูุฃุตูู ูุงูุฅููุงู</span>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5">
                <div class="card-gradient shape-angled p-5 shadow-lg border border-indigo-100">
                    <h3 class="font-bold text-slate-800 mb-2">ููุงุนุฏ ุงูุชุณุฌูู</h3>
                    <ul class="text-sm text-slate-600 space-y-1">
                        <li>ูู ุฃุตู ุจุฑูู ูุฑูุฏ</li>
                        <li>ุชูุซูู ูููุน ุงูุฃุตู ููุณุคูู ุงูุนูุฏุฉ</li>
                    </ul>
                </div>
                <div class="card-gradient shape-cut p-5 shadow-lg border border-emerald-100">
                    <h3 class="font-bold text-slate-800 mb-2">ุงูุฅููุงู</h3>
                    <ul class="text-sm text-slate-600 space-y-1">
                        <li>ุงุญุชุณุงุจ ุดูุฑู ุชููุงุฆู</li>
                        <li>ุชุญุฏูุซ ุงููููุฉ ุงูุฏูุชุฑูุฉ</li>
                    </ul>
                </div>
                <div class="card-gradient shape-pill p-5 shadow-lg border border-rose-100">
                    <h3 class="font-bold text-slate-800 mb-2">ุงูุชุตุฑู ุจุงูุฃุตู</h3>
                    <p class="text-sm text-slate-600">ุจูุน ุฃู ุฅุชูุงู ุฃู ุฃุตู ูุญุชุงุฌ ููุงููุฉ ุงูุฅุฏุงุฑุฉ ุงูุนููุง.</p>
                </div>
            </div>
        </div>

        <div class="card-gradient shape-rounded shadow-2xl p-6 mb-8 accent-rose">
            <div class="flex flex-wrap items-center justify-between gap-3 mb-6">
                <h2 class="text-2xl font-bold text-slate-800">๐ ุณูุงุณุฉ ุงูุฅููุงู ุงููุญุงุณุจู</h2>
                <span class="text-sm text-slate-500">ุงูุถุจุงุท ุงูุฅููุงู ุงูุดูุฑู ูุงูุณููู</span>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5">
                <div class="card-gradient shape-angled p-5 shadow-lg border border-rose-100">
                    <h3 class="font-bold text-slate-800 mb-2">ุงูุฅููุงู ุงูุดูุฑู</h3>
                    <p class="text-sm text-slate-600">ูุชู ุฎูุงู 5 ุฃูุงู ุนูู ูู ููุงูุฉ ุงูุดูุฑ.</p>
                </div>
                <div class="card-gradient shape-cut p-5 shadow-lg border border-amber-100">
                    <h3 class="font-bold text-slate-800 mb-2">ุงูุฅููุงู ุงูุณููู</h3>
                    <p class="text-sm text-slate-600">ูุชู ุฎูุงู 20 ููููุง ูู ููุงูุฉ ุงูุณูุฉ ุงููุงููุฉ.</p>
                </div>
                <div class="card-gradient shape-pill p-5 shadow-lg border border-emerald-100">
                    <h3 class="font-bold text-slate-800 mb-2">ุถูุงุจุท ูุง ุจุนุฏ ุงูุฅููุงู</h3>
                    <p class="text-sm text-slate-600">ูุง ูููุฏ ุจุนุฏ ุงูุฅููุงู ุฅูุง ุจููุงููุฉ ุงููุฏูุฑ ุงููุงูู ูููุฌููุนุฉ.</p>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-5 mb-8">
            <div class="card-gradient shape-angled p-5 shadow-lg accent-sky">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-sm text-slate-600">ุฅุฌูุงูู ุงูููุงุชูุฑ</span>
                    <i class="fas fa-file-invoice text-sky-500 text-2xl"></i>
                </div>
                <div id="totalInvoices" class="text-3xl font-bold text-slate-800">0</div>
            </div>
            <div class="card-gradient shape-cut p-5 shadow-lg accent-rose">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-sm text-slate-600">ููุงุชูุฑ ูุชุฃุฎุฑุฉ</span>
                    <i class="fas fa-triangle-exclamation text-rose-500 text-2xl"></i>
                </div>
                <div id="overdueInvoices" class="text-3xl font-bold text-slate-800">0</div>
            </div>
            <div class="card-gradient shape-rounded p-5 shadow-lg accent-emerald">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-sm text-slate-600">ุฅุฌูุงูู ุงููุฏููุนุงุช</span>
                    <i class="fas fa-credit-card text-emerald-500 text-2xl"></i>
                </div>
                <div id="totalPayments" class="text-3xl font-bold text-slate-800">0</div>
            </div>
            <div class="card-gradient shape-pill p-5 shadow-lg accent-amber">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-sm text-slate-600">ุฅุฌูุงูู ุงููุตุฑููุงุช</span>
                    <i class="fas fa-receipt text-amber-500 text-2xl"></i>
                </div>
                <div id="totalExpenses" class="text-3xl font-bold text-slate-800">0</div>
            </div>
            <div class="card-gradient shape-angled p-5 shadow-lg accent-indigo">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-sm text-slate-600">ุนุฏุฏ ุงูุฃุตูู</span>
                    <i class="fas fa-industry text-indigo-500 text-2xl"></i>
                </div>
                <div id="totalAssets" class="text-3xl font-bold text-slate-800">0</div>
            </div>
            <div class="card-gradient shape-cut p-5 shadow-lg accent-emerald">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-sm text-slate-600">ุฅุฌูุงูู ุงูุฅููุงู</span>
                    <i class="fas fa-chart-area text-emerald-500 text-2xl"></i>
                </div>
                <div id="totalDepreciation" class="text-3xl font-bold text-slate-800">0</div>
            </div>
            <div class="card-gradient shape-rounded p-5 shadow-lg accent-rose">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-sm text-slate-600">ุฎุทุท ุงูุณุฏุงุฏ</span>
                    <i class="fas fa-calendar-check text-rose-500 text-2xl"></i>
                </div>
                <div id="totalPlans" class="text-3xl font-bold text-slate-800">0</div>
            </div>
            <div class="card-gradient shape-pill p-5 shadow-lg accent-sky">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-sm text-slate-600">ุนุฏุฏ ุงููููุฏ</span>
                    <i class="fas fa-book text-sky-500 text-2xl"></i>
                </div>
                <div id="totalEntries" class="text-3xl font-bold text-slate-800">0</div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
            <div class="card-gradient shape-rounded shadow-2xl p-6 accent-sky">
                <h3 class="text-lg font-bold text-slate-800 mb-4">๐ ุชูุฒูุน ุญุงูุงุช ุงูููุงุชูุฑ</h3>
                <div class="chart-box"><canvas id="invoiceStatusChart"></canvas></div>
            </div>
            <div class="card-gradient shape-rounded shadow-2xl p-6 accent-emerald">
                <h3 class="text-lg font-bold text-slate-800 mb-4">๐ณ ุชูุฒูุน ุทุฑู ุงูุชุญุตูู</h3>
                <div class="chart-box"><canvas id="paymentMethodChart"></canvas></div>
            </div>
        </div>

        <div class="card-gradient shape-rounded shadow-2xl p-6 mb-8 accent-sky">
            <div class="flex items-center justify-between mb-4">
                <div class="flex items-center gap-3">
                    <h3 class="text-xl font-bold text-slate-800">๐ ุฌุฏูู ุงูููุงุชูุฑ</h3>
                    <button onclick="openForm('invoice','create')" class="action-btn bg-white text-sky-700 hover:border-sky-200 hover:bg-sky-50">โ ุฅุถุงูุฉ ูุงุชูุฑุฉ</button>
                </div>
                <span id="invoicesCount" class="text-sm text-slate-500"></span>
            </div>
            <div class="table-scroll">
                <table class="w-full text-xs">
                    <thead class="bg-sky-50 text-sky-700">
                        <tr>
                            <th class="px-3 py-2 text-right">ุฑูู ุงููุงุชูุฑุฉ</th>
                            <th class="px-3 py-2 text-right">ุชุงุฑูุฎ ุงูุฅุตุฏุงุฑ</th>
                            <th class="px-3 py-2 text-right">ุชุงุฑูุฎ ุงูุงุณุชุญูุงู</th>
                            <th class="px-3 py-2 text-right">ุงูุนููู</th>
                            <th class="px-3 py-2 text-right">ุงูุฅุฌูุงูู</th>
                            <th class="px-3 py-2 text-right">ุงููุชุจูู</th>
                            <th class="px-3 py-2 text-right">ุงูุญุงูุฉ</th>
                            <th class="px-3 py-2 text-right">ุฅุฌุฑุงุกุงุช</th>
                        </tr>
                    </thead>
                    <tbody id="invoicesTable" class="divide-y divide-slate-100">
                        <tr><td colspan="7" class="px-4 py-10 text-center text-slate-500">ุฌุงุฑู ุชุญููู ุงูุจูุงูุงุช...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="card-gradient shape-rounded shadow-2xl p-6 mb-8 accent-emerald">
            <div class="flex items-center justify-between mb-4">
                <div class="flex items-center gap-3">
                    <h3 class="text-xl font-bold text-slate-800">๐ณ ุฌุฏูู ุงููุฏููุนุงุช</h3>
                    <button onclick="openForm('payment','create')" class="action-btn bg-white text-emerald-700 hover:border-emerald-200 hover:bg-emerald-50">โ ุฅุถุงูุฉ ุฏูุนุฉ</button>
                </div>
                <span id="paymentsCount" class="text-sm text-slate-500"></span>
            </div>
            <div class="table-scroll">
                <table class="w-full text-xs">
                    <thead class="bg-emerald-50 text-emerald-700">
                        <tr>
                            <th class="px-3 py-2 text-right">ุฑูู ุงูุฏูุนุฉ</th>
                            <th class="px-3 py-2 text-right">ุงูุนููู</th>
                            <th class="px-3 py-2 text-right">ูููุฉ ุงูุฏูุนุฉ</th>
                            <th class="px-3 py-2 text-right">ุชุงุฑูุฎ ุงูุฏูุนุฉ</th>
                            <th class="px-3 py-2 text-right">ุทุฑููุฉ ุงูุชุญุตูู</th>
                            <th class="px-3 py-2 text-right">ุงูุญุงูุฉ</th>
                            <th class="px-3 py-2 text-right">ุฅุฌุฑุงุกุงุช</th>
                        </tr>
                    </thead>
                    <tbody id="paymentsTable" class="divide-y divide-slate-100">
                        <tr><td colspan="6" class="px-4 py-10 text-center text-slate-500">ุฌุงุฑู ุชุญููู ุงูุจูุงูุงุช...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="card-gradient shape-rounded shadow-2xl p-6 mb-8 accent-amber">
            <div class="flex items-center justify-between mb-4">
                <div class="flex items-center gap-3">
                    <h3 class="text-xl font-bold text-slate-800">๐งพ ุฌุฏูู ุงููุตุฑููุงุช</h3>
                    <button onclick="openForm('expense','create')" class="action-btn bg-white text-amber-700 hover:border-amber-200 hover:bg-amber-50">โ ุฅุถุงูุฉ ูุตุฑูู</button>
                </div>
                <span id="expensesCount" class="text-sm text-slate-500"></span>
            </div>
            <div class="table-scroll">
                <table class="w-full text-xs">
                    <thead class="bg-amber-50 text-amber-700">
                        <tr>
                            <th class="px-3 py-2 text-right">ุฑูู ุงููุตุฑูู</th>
                            <th class="px-3 py-2 text-right">ุชุงุฑูุฎ ุงููุตุฑูู</th>
                            <th class="px-3 py-2 text-right">ุงูููุน</th>
                            <th class="px-3 py-2 text-right">ุงูููุฑุฏ</th>
                            <th class="px-3 py-2 text-right">ุงูุฅุฌูุงูู</th>
                            <th class="px-3 py-2 text-right">ุงูุญุงูุฉ</th>
                            <th class="px-3 py-2 text-right">ุฅุฌุฑุงุกุงุช</th>
                        </tr>
                    </thead>
                    <tbody id="expensesTable" class="divide-y divide-slate-100">
                        <tr><td colspan="6" class="px-4 py-10 text-center text-slate-500">ุฌุงุฑู ุชุญููู ุงูุจูุงูุงุช...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="card-gradient shape-rounded shadow-2xl p-6 mb-8 accent-indigo">
            <div class="flex items-center justify-between mb-4">
                <div class="flex items-center gap-3">
                    <h3 class="text-xl font-bold text-slate-800">๐ข ุฌุฏูู ุงูุฃุตูู ุงูุซุงุจุชุฉ</h3>
                    <button onclick="openForm('asset','create')" class="action-btn bg-white text-indigo-700 hover:border-indigo-200 hover:bg-indigo-50">โ ุฅุถุงูุฉ ุฃุตู</button>
                </div>
                <span id="assetsCount" class="text-sm text-slate-500"></span>
            </div>
            <div class="table-scroll">
                <table class="w-full text-xs">
                    <thead class="bg-indigo-50 text-indigo-700">
                        <tr>
                            <th class="px-3 py-2 text-right">ุฑูู ุงูุฃุตู</th>
                            <th class="px-3 py-2 text-right">ุงุณู ุงูุฃุตู</th>
                            <th class="px-3 py-2 text-right">ุชุงุฑูุฎ ุงูุดุฑุงุก</th>
                            <th class="px-3 py-2 text-right">ุชูููุฉ ุงูุดุฑุงุก</th>
                            <th class="px-3 py-2 text-right">ุงููููุฉ ุงูุฏูุชุฑูุฉ</th>
                            <th class="px-3 py-2 text-right">ุงูุญุงูุฉ</th>
                            <th class="px-3 py-2 text-right">ุฅุฌุฑุงุกุงุช</th>
                        </tr>
                    </thead>
                    <tbody id="assetsTable" class="divide-y divide-slate-100">
                        <tr><td colspan="6" class="px-4 py-10 text-center text-slate-500">ุฌุงุฑู ุชุญููู ุงูุจูุงูุงุช...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="formModal" class="modal-backdrop hidden">
        <div class="modal-box p-6">
            <div class="flex items-center justify-between border-b border-slate-100 pb-3 mb-4">
                <div>
                    <p class="text-xs text-slate-500">ูููุฐุฌ ุชุญุฑูุฑ ุณุฑูุน</p>
                    <h4 id="modalTitle" class="text-xl font-bold text-slate-800">ุนููุงู ุงููููุฐุฌ</h4>
                </div>
                <button onclick="closeFormModal()" class="text-slate-500 hover:text-rose-600 font-bold">โ</button>
            </div>
            <form id="dynamicForm" class="grid grid-cols-1 md:grid-cols-2 gap-4"></form>
            <div class="flex items-center justify-between mt-4">
                <div class="text-xs text-slate-500" id="modalHint"></div>
                <div class="flex gap-2">
                    <button type="button" onclick="closeFormModal()" class="action-btn bg-slate-50 text-slate-700">ุฅูุบุงุก</button>
                    <button id="submitBtn" type="submit" form="dynamicForm" class="action-btn bg-sky-600 text-white border-sky-600">ุญูุธ</button>
                </div>
            </div>
        </div>
    </div>

    <div id="viewModal" class="modal-backdrop hidden">
        <div class="modal-box p-6">
            <div class="flex items-center justify-between border-b border-slate-100 pb-3 mb-4">
                <h4 class="text-lg font-bold text-slate-800">ูุนุงููุฉ ุงูุณุฌู</h4>
                <button onclick="closeViewModal()" class="text-slate-500 hover:text-rose-600 font-bold">โ</button>
            </div>
            <pre id="viewContent" class="bg-slate-50 rounded-xl p-4 text-xs text-slate-700 overflow-auto"></pre>
        </div>
    </div>

    <div id="toast" class="fixed bottom-6 left-1/2 -translate-x-1/2 bg-slate-900 text-white px-4 py-2 rounded-full shadow-lg hidden"></div>

    <script>
        const API_BASE = window.location.origin;
        const ENTITY_ID = '1';

        let store = {
            invoices: [],
            payments: [],
            expenses: [],
            assets: [],
            plans: [],
            entries: []
        };

        const TYPE_INFO = {
            invoice: { label: 'ูุงุชูุฑุฉ', collection: 'invoices', idKey: 'invoice_id' },
            payment: { label: 'ุฏูุนุฉ', collection: 'payments', idKey: 'payment_id' },
            expense: { label: 'ูุตุฑูู', collection: 'expenses', idKey: 'expense_id' },
            asset: { label: 'ุฃุตู ุซุงุจุช', collection: 'assets', idKey: 'asset_id' }
        };

        let invoiceChartInstance = null;
        let paymentChartInstance = null;

        async function loadData() {
            try {
                const [invoiceRes, paymentRes, expenseRes, assetRes, planRes, entryRes] = await Promise.all([
                    fetch(`${API_BASE}/finance/invoices`),
                    fetch(`${API_BASE}/finance/payments`),
                    fetch(`${API_BASE}/finance/expenses?entity_id=${ENTITY_ID}`),
                    fetch(`${API_BASE}/finance/fixed-assets?entity_id=${ENTITY_ID}`),
                    fetch(`${API_BASE}/finance/payment-plans?entity_id=${ENTITY_ID}`),
                    fetch(`${API_BASE}/finance/journal/entries?entity_id=${ENTITY_ID}`)
                ]);

                const [invoiceData, paymentData, expenseData, assetData, planData, entryData] = await Promise.all([
                    invoiceRes.json(),
                    paymentRes.json(),
                    expenseRes.json(),
                    assetRes.json(),
                    planRes.json(),
                    entryRes.json()
                ]);

                store.invoices = invoiceData.invoices || [];
                store.payments = paymentData.payments || [];
                store.expenses = expenseData.expenses || [];
                store.assets = assetData.assets || [];
                store.plans = planData.plans || [];
                store.entries = entryData.entries || entryData.rows || [];

                renderStats();
                renderCharts();
                renderTables();
            } catch (error) {
                console.error('ุฎุทุฃ ูู ุชุญููู ุงูุจูุงูุงุช:', error);
            }
        }

        function renderStats() {
            const totalInvoices = store.invoices.length;
            const overdueInvoices = store.invoices.filter(i => String(i.status || '').toUpperCase() === 'OVERDUE').length;
            const totalPayments = sum(store.payments, 'payment_amount');
            const totalExpenses = sum(store.expenses, 'total_amount');
            const totalAssets = store.assets.length;
            const totalDep = sum(store.assets, 'accumulated_depreciation');
            const totalPlans = store.plans.length;
            const totalEntries = store.entries.length;

            document.getElementById('totalInvoices').textContent = totalInvoices.toLocaleString('ar-SA');
            document.getElementById('overdueInvoices').textContent = overdueInvoices.toLocaleString('ar-SA');
            document.getElementById('totalPayments').textContent = formatMoney(totalPayments);
            document.getElementById('totalExpenses').textContent = formatMoney(totalExpenses);
            document.getElementById('totalAssets').textContent = totalAssets.toLocaleString('ar-SA');
            document.getElementById('totalDepreciation').textContent = formatMoney(totalDep);
            document.getElementById('totalPlans').textContent = totalPlans.toLocaleString('ar-SA');
            document.getElementById('totalEntries').textContent = totalEntries.toLocaleString('ar-SA');
        }

        function renderCharts() {
            const statusCounts = store.invoices.reduce((acc, inv) => {
                const status = translateStatus(inv.status);
                acc[status] = (acc[status] || 0) + 1;
                return acc;
            }, {});

            const invoiceCtx = document.getElementById('invoiceStatusChart').getContext('2d');
            if (invoiceChartInstance) invoiceChartInstance.destroy();
            invoiceChartInstance = new Chart(invoiceCtx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(statusCounts).length ? Object.keys(statusCounts) : ['ูุง ุชูุฌุฏ ุจูุงูุงุช'],
                    datasets: [{
                        data: Object.values(statusCounts).length ? Object.values(statusCounts) : [0],
                        backgroundColor: ['#0ea5e9', '#f59e0b', '#10b981', '#ef4444', '#6366f1']
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });

            const methodCounts = store.payments.reduce((acc, p) => {
                const method = translatePaymentMethod(p.payment_method);
                acc[method] = (acc[method] || 0) + 1;
                return acc;
            }, {});

            const paymentCtx = document.getElementById('paymentMethodChart').getContext('2d');
            if (paymentChartInstance) paymentChartInstance.destroy();
            paymentChartInstance = new Chart(paymentCtx, {
                type: 'bar',
                data: {
                    labels: Object.keys(methodCounts).length ? Object.keys(methodCounts) : ['ูุง ุชูุฌุฏ ุจูุงูุงุช'],
                    datasets: [{
                        data: Object.values(methodCounts).length ? Object.values(methodCounts) : [0],
                        backgroundColor: '#10b981'
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
            });
        }

        function renderTables() {
            const invoiceRows = store.invoices.map((inv, idx) => `
                <tr class="hover:bg-sky-50">
                    <td class="px-3 py-2">${sanitizeText(inv.invoice_number)}</td>
                    <td class="px-3 py-2">${formatDate(inv.invoice_date)}</td>
                    <td class="px-3 py-2">${formatDate(inv.due_date)}</td>
                    <td class="px-3 py-2">${sanitizeText(inv.customer_name_ar || inv.customer_name)}</td>
                    <td class="px-3 py-2 font-semibold text-emerald-700">${formatMoney(inv.total_amount)}</td>
                    <td class="px-3 py-2">${formatMoney(inv.remaining_amount)}</td>
                    <td class="px-3 py-2">${translateStatus(inv.status)}</td>
                    <td class="px-3 py-2">
                        <div class="flex flex-wrap gap-2 justify-end">
                            <button class="action-btn text-slate-700" onclick="viewRecord('invoice', ${idx})">ูุนุงููุฉ</button>
                            <button class="action-btn text-sky-700" onclick="openForm('invoice','edit', ${idx})">ุชุนุฏูู</button>
                            <button class="action-btn text-rose-700" onclick="deleteRecord('invoice', ${idx})">ุญุฐู</button>
                        </div>
                    </td>
                </tr>
            `).join('');
            document.getElementById('invoicesTable').innerHTML = invoiceRows || `<tr><td colspan="7" class="px-4 py-10 text-center text-slate-500">ูุง ุชูุฌุฏ ุจูุงูุงุช</td></tr>`;
            document.getElementById('invoicesCount').textContent = `ุนุฏุฏ ุงูุตููู: ${store.invoices.length}`;

            const paymentRows = store.payments.map((p, idx) => `
                <tr class="hover:bg-emerald-50">
                    <td class="px-3 py-2">${sanitizeText(p.payment_number || p.payment_id)}</td>
                    <td class="px-3 py-2">${sanitizeText(p.customer_name_ar || p.customer_name || p.customer_id)}</td>
                    <td class="px-3 py-2 font-semibold text-emerald-700">${formatMoney(p.payment_amount)}</td>
                    <td class="px-3 py-2">${formatDate(p.payment_date)}</td>
                    <td class="px-3 py-2">${translatePaymentMethod(p.payment_method)}</td>
                    <td class="px-3 py-2">${translateStatus(p.status)}</td>
                    <td class="px-3 py-2">
                        <div class="flex flex-wrap gap-2 justify-end">
                            <button class="action-btn text-slate-700" onclick="viewRecord('payment', ${idx})">ูุนุงููุฉ</button>
                            <button class="action-btn text-emerald-700" onclick="openForm('payment','edit', ${idx})">ุชุนุฏูู</button>
                            <button class="action-btn text-rose-700" onclick="deleteRecord('payment', ${idx})">ุญุฐู</button>
                        </div>
                    </td>
                </tr>
            `).join('');
            document.getElementById('paymentsTable').innerHTML = paymentRows || `<tr><td colspan="6" class="px-4 py-10 text-center text-slate-500">ูุง ุชูุฌุฏ ุจูุงูุงุช</td></tr>`;
            document.getElementById('paymentsCount').textContent = `ุนุฏุฏ ุงูุตููู: ${store.payments.length}`;

            const expenseRows = store.expenses.map((e, idx) => `
                <tr class="hover:bg-amber-50">
                    <td class="px-3 py-2">${sanitizeText(e.expense_number || e.expense_id)}</td>
                    <td class="px-3 py-2">${formatDate(e.expense_date)}</td>
                    <td class="px-3 py-2">${sanitizeText(e.expense_type || e.expense_category)}</td>
                    <td class="px-3 py-2">${sanitizeText(e.vendor_name)}</td>
                    <td class="px-3 py-2 font-semibold text-emerald-700">${formatMoney(e.total_amount || e.amount)}</td>
                    <td class="px-3 py-2">${translateStatus(e.status)}</td>
                    <td class="px-3 py-2">
                        <div class="flex flex-wrap gap-2 justify-end">
                            <button class="action-btn text-slate-700" onclick="viewRecord('expense', ${idx})">ูุนุงููุฉ</button>
                            <button class="action-btn text-amber-700" onclick="openForm('expense','edit', ${idx})">ุชุนุฏูู</button>
                            <button class="action-btn text-rose-700" onclick="deleteRecord('expense', ${idx})">ุญุฐู</button>
                        </div>
                    </td>
                </tr>
            `).join('');
            document.getElementById('expensesTable').innerHTML = expenseRows || `<tr><td colspan="6" class="px-4 py-10 text-center text-slate-500">ูุง ุชูุฌุฏ ุจูุงูุงุช</td></tr>`;
            document.getElementById('expensesCount').textContent = `ุนุฏุฏ ุงูุตููู: ${store.expenses.length}`;

            const assetRows = store.assets.map((a, idx) => `
                <tr class="hover:bg-indigo-50">
                    <td class="px-3 py-2">${sanitizeText(a.asset_code || a.asset_id)}</td>
                    <td class="px-3 py-2">${sanitizeText(a.asset_name_ar || a.asset_name_en || a.asset_name)}</td>
                    <td class="px-3 py-2">${formatDate(a.purchase_date)}</td>
                    <td class="px-3 py-2 font-semibold text-emerald-700">${formatMoney(a.purchase_cost)}</td>
                    <td class="px-3 py-2">${formatMoney(a.net_book_value)}</td>
                    <td class="px-3 py-2">${translateStatus(a.status)}</td>
                    <td class="px-3 py-2">
                        <div class="flex flex-wrap gap-2 justify-end">
                            <button class="action-btn text-slate-700" onclick="viewRecord('asset', ${idx})">ูุนุงููุฉ</button>
                            <button class="action-btn text-indigo-700" onclick="openForm('asset','edit', ${idx})">ุชุนุฏูู</button>
                            <button class="action-btn text-rose-700" onclick="deleteRecord('asset', ${idx})">ุญุฐู</button>
                        </div>
                    </td>
                </tr>
            `).join('');
            document.getElementById('assetsTable').innerHTML = assetRows || `<tr><td colspan="6" class="px-4 py-10 text-center text-slate-500">ูุง ุชูุฌุฏ ุจูุงูุงุช</td></tr>`;
            document.getElementById('assetsCount').textContent = `ุนุฏุฏ ุงูุตููู: ${store.assets.length}`;
        }

        function getRecord(type, index) {
            const info = TYPE_INFO[type];
            if (!info) return null;
            return store[info.collection]?.[index] || null;
        }

        function closeFormModal() {
            document.getElementById('formModal').classList.add('hidden');
            document.getElementById('dynamicForm').innerHTML = '';
        }

        function closeViewModal() {
            document.getElementById('viewModal').classList.add('hidden');
            document.getElementById('viewContent').textContent = '';
        }

        function showToast(message, tone = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `fixed bottom-6 left-1/2 -translate-x-1/2 px-4 py-2 rounded-full shadow-lg text-white ${tone === 'error' ? 'bg-rose-600' : 'bg-slate-900'}`;
            toast.classList.remove('hidden');
            setTimeout(() => toast.classList.add('hidden'), 2200);
        }

        function viewRecord(type, index) {
            const record = getRecord(type, index);
            if (!record) return;
            document.getElementById('viewContent').textContent = JSON.stringify(record, null, 2);
            document.getElementById('viewModal').classList.remove('hidden');
        }

        function buildField(label, name, value = '', options = {}) {
            const { type = 'text', placeholder = '', required = false, rows = 3 } = options;
            if (type === 'textarea') {
                return `
                    <label class="text-sm text-slate-700 font-semibold flex flex-col gap-1 col-span-1 md:col-span-2">
                        ${label}
                        <textarea name="${name}" rows="${rows}" class="w-full border border-slate-200 rounded-xl px-3 py-2 focus:border-sky-400 focus:ring-1 focus:ring-sky-400" ${required ? 'required' : ''}>${value || ''}</textarea>
                    </label>
                `;
            }
            return `
                <label class="text-sm text-slate-700 font-semibold flex flex-col gap-1">
                    ${label}
                    <input name="${name}" type="${type}" value="${value || ''}" placeholder="${placeholder}" class="w-full border border-slate-200 rounded-xl px-3 py-2 focus:border-sky-400 focus:ring-1 focus:ring-sky-400" ${required ? 'required' : ''} />
                </label>
            `;
        }

        function openForm(type, mode = 'create', index = null) {
            const info = TYPE_INFO[type];
            if (!info) return;
            const record = index !== null ? getRecord(type, index) : {};
            const form = document.getElementById('dynamicForm');
            const hint = document.getElementById('modalHint');
            document.getElementById('modalTitle').textContent = `${mode === 'create' ? 'ุฅุถุงูุฉ' : 'ุชุนุฏูู'} ${info.label}`;
            document.getElementById('submitBtn').textContent = mode === 'create' ? 'ุญูุธ' : 'ุชุญุฏูุซ';

            let fields = '';

            if (type === 'invoice') {
                fields += buildField('ุฑูู ุงููุงุชูุฑุฉ', 'invoice_number', record.invoice_number || '');
                fields += buildField('ูุนุฑู ุงูุนููู', 'customer_id', record.customer_id || '', { required: true });
                fields += buildField('ุชุงุฑูุฎ ุงูุฅุตุฏุงุฑ', 'invoice_date', record.invoice_date ? record.invoice_date.substring(0,10) : '', { type: 'date', required: true });
                fields += buildField('ุชุงุฑูุฎ ุงูุงุณุชุญูุงู', 'due_date', record.due_date ? record.due_date.substring(0,10) : '', { type: 'date', required: true });
                fields += buildField('ุงูุฅุฌูุงูู', 'total_amount', record.total_amount || '', { type: 'number', required: true });
                fields += buildField('ุงููุฏููุน', 'paid_amount', record.paid_amount || record.total_amount || 0, { type: 'number' });
                fields += buildField('ุญุงูุฉ ุงููุงุชูุฑุฉ', 'status', record.status || 'ISSUED');
                fields += buildField('ุญุงูุฉ ุงูุชุญุตูู', 'payment_status', record.payment_status || 'UNPAID');
                fields += buildField('ููุงุญุธุงุช', 'notes', record.notes || '', { type: 'textarea', rows: 3 });
                hint.textContent = 'ูุชู ุงูุญูุธ ูู ุฌุฏูู finance_invoices ุนุจุฑ ูุงุฌูุฉ /finance/ar-aging/invoices';
            }

            if (type === 'payment') {
                fields += buildField('ุฑูู ุงูุฏูุนุฉ', 'payment_number', record.payment_number || '');
                fields += buildField('ูุนุฑู ุงูุนููู', 'customer_id', record.customer_id || '', { required: true });
                fields += buildField('ูููุฉ ุงูุฏูุนุฉ', 'payment_amount', record.payment_amount || '', { type: 'number', required: true });
                fields += buildField('ุชุงุฑูุฎ ุงูุฏูุนุฉ', 'payment_date', record.payment_date ? record.payment_date.substring(0,10) : '', { type: 'date', required: true });
                fields += buildField('ุทุฑููุฉ ุงูุชุญุตูู', 'payment_method', record.payment_method || 'BANK_TRANSFER', { required: true });
                fields += buildField('ุญุงูุฉ ุงูุฏูุนุฉ', 'status', record.status || 'COMPLETED');
                fields += buildField('ููุงุญุธุงุช', 'notes', record.notes || '', { type: 'textarea', rows: 3 });
                hint.textContent = 'ูุชู ุงูุญูุธ ูู ุฌุฏูู finance_payments ุนุจุฑ ูุงุฌูุฉ /finance/payments';
            }

            if (type === 'expense') {
                fields += buildField('ุฑูู ุงููุตุฑูู', 'expense_number', record.expense_number || '', { required: true });
                fields += buildField('ุชุงุฑูุฎ ุงููุตุฑูู', 'expense_date', record.expense_date ? record.expense_date.substring(0,10) : '', { type: 'date', required: true });
                fields += buildField('ูุฆุฉ ุงููุตุฑูู', 'expense_category', record.expense_category || '', { required: true });
                fields += buildField('ููุน ุงููุตุฑูู', 'expense_type', record.expense_type || '', { required: true });
                fields += buildField('ูุนุฑู ุงูููุฑุฏ', 'vendor_id', record.vendor_id || '', { required: true });
                fields += buildField('ุงุณู ุงูููุฑุฏ', 'vendor_name', record.vendor_name || '', { required: true });
                fields += buildField('ุงููุจูุบ', 'amount', record.amount || record.total_amount || '', { type: 'number', required: true });
                fields += buildField('ุงูุถุฑูุจุฉ', 'tax_amount', record.tax_amount || 0, { type: 'number' });
                fields += buildField('ุญุงูุฉ ุงููุตุฑูู', 'status', record.status || 'approved');
                fields += buildField('ููุงุญุธุงุช', 'notes', record.notes || '', { type: 'textarea', rows: 3 });
                hint.textContent = 'ูุชู ุงูุญูุธ ูู ุฌุฏูู finance_expenses ุนุจุฑ ูุงุฌูุฉ /finance/expenses';
            }

            if (type === 'asset') {
                fields += buildField('ููุฏ ุงูุฃุตู', 'asset_code', record.asset_code || '', { required: true });
                fields += buildField('ุงุณู ุงูุฃุตู', 'asset_name_ar', record.asset_name_ar || record.asset_name || '', { required: true });
                fields += buildField('ุชุตููู ุงูุฃุตู', 'asset_category', record.asset_category || 'ูุนุฏุงุช', { required: true });
                fields += buildField('ููุน ุงูุฃุตู', 'asset_type', record.asset_type || 'ุชุดุบููู', { required: true });
                fields += buildField('ุชุงุฑูุฎ ุงูุดุฑุงุก', 'purchase_date', record.purchase_date ? record.purchase_date.substring(0,10) : '', { type: 'date', required: true });
                fields += buildField('ุชูููุฉ ุงูุดุฑุงุก', 'purchase_cost', record.purchase_cost || '', { type: 'number', required: true });
                fields += buildField('ุทุฑููุฉ ุงูุฅููุงู', 'depreciation_method', record.depreciation_method || 'straight_line', { required: true });
                fields += buildField('ุงูุนูุฑ ุงูุฅูุชุงุฌู (ุณููุงุช)', 'useful_life_years', record.useful_life_years || 5, { type: 'number', required: true });
                fields += buildField('ูููุฉ ุงูุฎุฑุฏุฉ', 'salvage_value', record.salvage_value || 0, { type: 'number' });
                fields += buildField('ุงูุฅููุงู ุงูุชุฑุงููู', 'accumulated_depreciation', record.accumulated_depreciation || 0, { type: 'number' });
                fields += buildField('ุญุงูุฉ ุงูุฃุตู', 'status', record.status || 'ACTIVE');
                hint.textContent = 'ูุชู ุงูุญูุธ ูู ุฌุฏูู finance_fixed_assets ุนุจุฑ ูุงุฌูุฉ /finance/fixed-assets';
            }

            form.innerHTML = fields;
            form.dataset.type = type;
            form.dataset.mode = mode;
            form.dataset.index = index ?? '';
            document.getElementById('formModal').classList.remove('hidden');
        }

        async function handleFormSubmit(event) {
            event.preventDefault();
            const form = event.target;
            const type = form.dataset.type;
            const mode = form.dataset.mode;
            const index = form.dataset.index === '' ? null : Number(form.dataset.index);
            const info = TYPE_INFO[type];
            if (!info) return;

            const record = index !== null ? getRecord(type, index) : {};
            const fd = new FormData(form);

            const toNumber = (key) => parseFloat(fd.get(key) || 0);
            const payload = {};
            let url = '';
            let method = mode === 'create' ? 'POST' : 'PUT';

            if (type === 'invoice') {
                payload.invoice_number = fd.get('invoice_number') || undefined;
                payload.customer_id = fd.get('customer_id');
                payload.invoice_date = fd.get('invoice_date');
                payload.due_date = fd.get('due_date');
                payload.total_amount = toNumber('total_amount');
                payload.paid_amount = toNumber('paid_amount');
                payload.status = fd.get('status') || 'ISSUED';
                payload.payment_status = fd.get('payment_status') || 'UNPAID';
                payload.entity_id = ENTITY_ID;
                payload.entity_type = 'HQ';
                payload.notes = fd.get('notes') || null;
                url = mode === 'create'
                    ? `${API_BASE}/finance/ar-aging/invoices`
                    : `${API_BASE}/finance/ar-aging/invoices/${record?.invoice_id}`;
            }

            if (type === 'payment') {
                payload.payment_number = fd.get('payment_number') || undefined;
                payload.customer_id = fd.get('customer_id');
                payload.payment_amount = toNumber('payment_amount');
                payload.payment_date = fd.get('payment_date');
                payload.payment_method = fd.get('payment_method');
                payload.status = fd.get('status') || 'COMPLETED';
                payload.entity_id = ENTITY_ID;
                payload.entity_type = 'HQ';
                payload.notes = fd.get('notes') || null;
                url = mode === 'create'
                    ? `${API_BASE}/finance/payments`
                    : `${API_BASE}/finance/payments/${record?.payment_id}`;
            }

            if (type === 'expense') {
                payload.expense_number = fd.get('expense_number');
                payload.expense_date = fd.get('expense_date');
                payload.expense_category = fd.get('expense_category');
                payload.expense_type = fd.get('expense_type');
                payload.vendor_id = fd.get('vendor_id');
                payload.vendor_name = fd.get('vendor_name');
                payload.amount = toNumber('amount');
                payload.tax_amount = toNumber('tax_amount');
                payload.status = fd.get('status') || 'approved';
                payload.entity_id = ENTITY_ID;
                payload.entity_type = 'HQ';
                payload.total_amount = payload.amount + payload.tax_amount;
                payload.notes = fd.get('notes') || null;
                url = mode === 'create'
                    ? `${API_BASE}/finance/expenses`
                    : `${API_BASE}/finance/expenses/${record?.expense_id}`;
            }

            if (type === 'asset') {
                payload.asset_code = fd.get('asset_code');
                payload.asset_name_ar = fd.get('asset_name_ar');
                payload.asset_category = fd.get('asset_category');
                payload.asset_type = fd.get('asset_type');
                payload.purchase_date = fd.get('purchase_date');
                payload.purchase_cost = toNumber('purchase_cost');
                payload.depreciation_method = fd.get('depreciation_method');
                payload.useful_life_years = toNumber('useful_life_years');
                payload.salvage_value = toNumber('salvage_value');
                payload.accumulated_depreciation = toNumber('accumulated_depreciation');
                payload.entity_id = ENTITY_ID;
                payload.entity_type = 'HQ';
                payload.status = fd.get('status') || 'ACTIVE';
                url = mode === 'create'
                    ? `${API_BASE}/finance/fixed-assets`
                    : `${API_BASE}/finance/fixed-assets/${record?.asset_id}`;
            }

            try {
                const res = await fetch(url, {
                    method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const data = await res.json().catch(() => ({}));
                if (!res.ok) {
                    throw new Error(data.error || 'ุชุนุฐุฑ ุญูุธ ุงูุจูุงูุงุช');
                }
                showToast('ุชู ุงูุญูุธ ุจูุฌุงุญ');
                closeFormModal();
                await loadData();
            } catch (error) {
                console.error(error);
                showToast(error.message, 'error');
            }
        }

        async function deleteRecord(type, index) {
            const info = TYPE_INFO[type];
            if (!info) return;
            const record = getRecord(type, index);
            if (!record) return;
            if (!confirm('ูู ุฃูุช ูุชุฃูุฏ ูู ุงูุญุฐูุ')) return;

            const idKey = info.idKey;
            const id = record[idKey];
            let url = '';
            if (type === 'invoice') url = `${API_BASE}/finance/ar-aging/invoices/${id}`;
            if (type === 'payment') url = `${API_BASE}/finance/payments/${id}`;
            if (type === 'expense') url = `${API_BASE}/finance/expenses/${id}`;
            if (type === 'asset') url = `${API_BASE}/finance/fixed-assets/${id}`;

            try {
                const res = await fetch(url, { method: 'DELETE' });
                const data = await res.json().catch(() => ({}));
                if (!res.ok) throw new Error(data.error || 'ุชุนุฐุฑ ุงูุญุฐู');
                showToast('ุชู ุงูุญุฐู');
                await loadData();
            } catch (error) {
                console.error(error);
                showToast(error.message, 'error');
            }
        }

        document.getElementById('dynamicForm').addEventListener('submit', handleFormSubmit);

        function translateStatus(value) {
            const map = {
                PAID: 'ูุฏููุนุฉ',
                UNPAID: 'ุบูุฑ ูุฏููุนุฉ',
                PARTIAL: 'ูุฏููุนุฉ ุฌุฒุฆููุง',
                OVERDUE: 'ูุชุฃุฎุฑุฉ',
                ACTIVE: 'ูุดุทุฉ',
                CLOSED: 'ูุบููุฉ',
                PENDING: 'ููุฏ ุงููุฑุงุฌุนุฉ',
                APPROVED: 'ูุนุชูุฏุฉ',
                REJECTED: 'ูุฑููุถุฉ'
            };
            return map[String(value || '').toUpperCase()] || 'ุบูุฑ ูุญุฏุฏ';
        }

        function translatePaymentMethod(value) {
            const map = {
                BANK_TRANSFER: 'ุชุญููู ุจููู',
                CARD: 'ุจุทุงูุฉ',
                POS: 'ููุงุท ุจูุน',
                CASH: 'ููุฏ',
                GATEWAY: 'ุจูุงุจุฉ ุงูุฏูุน',
                CHEQUE: 'ุดูู'
            };
            return map[String(value || '').toUpperCase()] || 'ุบูุฑ ูุญุฏุฏ';
        }

        function formatMoney(value) {
            const num = parseFloat(value || 0);
            return num.toLocaleString('ar-SA') + ' ุฑ.ุณ';
        }

        function formatDate(value) {
            if (!value) return '-';
            return new Date(value).toLocaleDateString('ar-SA');
        }

        function sanitizeText(value) {
            if (value === null || value === undefined) return 'ุบูุฑ ูุญุฏุฏ';
            const text = typeof value === 'string' ? value : JSON.stringify(value);
            const cleaned = text.replace(/[A-Za-z]+/g, '').replace(/\s{2,}/g, ' ').trim();
            return cleaned || 'ุบูุฑ ูุญุฏุฏ';
        }

        function sum(rows, key) {
            return rows.reduce((acc, row) => acc + parseFloat(row[key] || 0), 0);
        }

        function downloadAllJSON() {
            const payload = {
                invoices: store.invoices,
                payments: store.payments,
                expenses: store.expenses,
                fixed_assets: store.assets,
                payment_plans: store.plans,
                journal_entries: store.entries
            };
            downloadBlob(JSON.stringify(payload, null, 2), 'ุงูุณูุงุณุงุช-ุงููุงููุฉ-ุงูุฃุณุงุณูุฉ.json', 'application/json');
        }

        function downloadAllCSV() {
            const rows = [];
            rows.push(['ุงูููุงุชูุฑ']);
            rows.push(['ุฑูู ุงููุงุชูุฑุฉ','ุชุงุฑูุฎ ุงูุฅุตุฏุงุฑ','ุชุงุฑูุฎ ุงูุงุณุชุญูุงู','ุงูุนููู','ุงูุฅุฌูุงูู','ุงููุชุจูู','ุงูุญุงูุฉ']);
            store.invoices.forEach(inv => rows.push([
                sanitizeText(inv.invoice_number), inv.invoice_date, inv.due_date, sanitizeText(inv.customer_name_ar || inv.customer_name),
                inv.total_amount, inv.remaining_amount, translateStatus(inv.status)
            ]));

            rows.push([]);
            rows.push(['ุงููุฏููุนุงุช']);
            rows.push(['ุฑูู ุงูุฏูุนุฉ','ุงูุนููู','ูููุฉ ุงูุฏูุนุฉ','ุชุงุฑูุฎ ุงูุฏูุนุฉ','ุทุฑููุฉ ุงูุชุญุตูู','ุงูุญุงูุฉ']);
            store.payments.forEach(p => rows.push([
                p.payment_number || p.payment_id, sanitizeText(p.customer_name_ar || p.customer_name || p.customer_id), p.payment_amount,
                p.payment_date, translatePaymentMethod(p.payment_method), translateStatus(p.status)
            ]));

            rows.push([]);
            rows.push(['ุงููุตุฑููุงุช']);
            rows.push(['ุฑูู ุงููุตุฑูู','ุชุงุฑูุฎ ุงููุตุฑูู','ุงูููุน','ุงูููุฑุฏ','ุงูุฅุฌูุงูู','ุงูุญุงูุฉ']);
            store.expenses.forEach(e => rows.push([
                e.expense_number || e.expense_id, e.expense_date, sanitizeText(e.expense_type || e.expense_category), sanitizeText(e.vendor_name),
                e.total_amount || e.amount, translateStatus(e.status)
            ]));

            rows.push([]);
            rows.push(['ุงูุฃุตูู ุงูุซุงุจุชุฉ']);
            rows.push(['ุฑูู ุงูุฃุตู','ุงุณู ุงูุฃุตู','ุชุงุฑูุฎ ุงูุดุฑุงุก','ุชูููุฉ ุงูุดุฑุงุก','ุงููููุฉ ุงูุฏูุชุฑูุฉ','ุงูุญุงูุฉ']);
            store.assets.forEach(a => rows.push([
                a.asset_code || a.asset_id, sanitizeText(a.asset_name_ar || a.asset_name_en || a.asset_name), a.purchase_date,
                a.purchase_cost, a.net_book_value, translateStatus(a.status)
            ]));

            const csv = rows.map(r => r.map(v => `"${v ?? ''}"`).join(',')).join('\n');
            downloadBlob(csv, 'ุงูุณูุงุณุงุช-ุงููุงููุฉ-ุงูุฃุณุงุณูุฉ.csv', 'text/csv;charset=utf-8;');
        }

        function copySummary() {
            const summary = `ููุฎุต ุงูุณูุงุณุงุช ุงููุงููุฉ\n` +
                `ุฅุฌูุงูู ุงูููุงุชูุฑ: ${store.invoices.length}\n` +
                `ุงูููุงุชูุฑ ุงููุชุฃุฎุฑุฉ: ${store.invoices.filter(i => String(i.status || '').toUpperCase() === 'OVERDUE').length}\n` +
                `ุฅุฌูุงูู ุงููุฏููุนุงุช: ${formatMoney(sum(store.payments, 'payment_amount'))}\n` +
                `ุฅุฌูุงูู ุงููุตุฑููุงุช: ${formatMoney(sum(store.expenses, 'total_amount'))}\n` +
                `ุนุฏุฏ ุงูุฃุตูู: ${store.assets.length}`;
            navigator.clipboard.writeText(summary).catch(() => {});
        }

        function downloadBlob(content, filename, type) {
            const blob = new Blob([content], { type });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            link.click();
            URL.revokeObjectURL(url);
        }

        function printPage() {
            window.print();
        }

        function refreshData() {
            loadData();
        }

        document.addEventListener('DOMContentLoaded', loadData);
    </script>
</body>
</html>
