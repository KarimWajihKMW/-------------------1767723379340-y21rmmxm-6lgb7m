<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>๐ก๏ธ ุงูุญูููุฉ ุงููุงููุฉ ูุงูุตูุงุญูุงุช ูุงูุชูุงุฑูุฑ - ูุธุงู ูุงููุด</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Cairo', sans-serif;
            background: linear-gradient(135deg, #1d4ed8 0%, #0ea5e9 55%, #14b8a6 100%);
            min-height: 100vh;
        }
        .glass {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(12px);
        }
        .shape-rounded { border-radius: 28px; }
        .shape-angled { border-radius: 32px 8px 32px 8px; }
        .shape-pill { border-radius: 999px; }
        .shape-cut { border-radius: 18px 18px 40px 8px; }
        .chart-box { position: relative; height: 260px; }
        .table-scroll { max-height: 520px; overflow: auto; }
        .accent-sky { border-top: 4px solid #0ea5e9; }
        .accent-indigo { border-top: 4px solid #6366f1; }
        .accent-emerald { border-top: 4px solid #10b981; }
        .accent-rose { border-top: 4px solid #f43f5e; }
        .accent-amber { border-top: 4px solid #f59e0b; }
    </style>
</head>
<body>
    <div class="container mx-auto px-4 py-8">
        <div class="text-white mb-8">
            <h1 class="text-4xl font-bold mb-2">๐ก๏ธ ุงูุญูููุฉ ุงููุงููุฉ ูุงูุตูุงุญูุงุช ูุงูุชูุงุฑูุฑ</h1>
            <p class="text-lg opacity-90">ุจูุงุก ูุธุงู ุงูุญูููุฉ ุงููุงููุฉ ูุฑุจุท ุงูุตูุงุญูุงุช ูุงูููุงููุงุช ูุงูุชูุงุฑูุฑ (ุงูุตูุญุฉ 36)</p>
        </div>

        <div class="mb-6 flex flex-wrap gap-3">
            <button onclick="refreshData()" class="bg-white text-sky-700 px-6 py-3 rounded-full font-bold hover:shadow-lg transition flex items-center gap-2">
                <i class="fas fa-rotate"></i>
                ุชุญุฏูุซ ุงูุจูุงูุงุช
            </button>
            <button onclick="downloadAllJSON()" class="bg-indigo-600 text-white px-6 py-3 rounded-full font-bold hover:shadow-lg transition flex items-center gap-2">
                <i class="fas fa-file-code"></i>
                ุชูุฒูู ููู ุจูุงูุงุช ุดุงูู
            </button>
            <button onclick="downloadAllCSV()" class="bg-emerald-600 text-white px-6 py-3 rounded-full font-bold hover:shadow-lg transition flex items-center gap-2">
                <i class="fas fa-file-csv"></i>
                ุชูุฒูู ููู ุฌุฏููู ุดุงูู
            </button>
            <button onclick="printPage()" class="bg-rose-600 text-white px-6 py-3 rounded-full font-bold hover:shadow-lg transition flex items-center gap-2">
                <i class="fas fa-print"></i>
                ุทุจุงุนุฉ ุงูุตูุญุฉ
            </button>
            <button onclick="copySummary()" class="bg-amber-500 text-white px-6 py-3 rounded-full font-bold hover:shadow-lg transition flex items-center gap-2">
                <i class="fas fa-copy"></i>
                ูุณุฎ ููุฎุต ุงูุญูููุฉ
            </button>
        </div>

        <div class="glass shape-rounded shadow-2xl p-6 mb-8 accent-sky">
            <div class="flex flex-wrap items-center justify-between mb-6 gap-3">
                <h2 class="text-2xl font-bold text-slate-800">๐งฉ ูุณุชููุงุช ุงูุตูุงุญูุงุช</h2>
                <span class="text-sm text-slate-500">ุฑุจุท ุงููุญุฏุงุช ููู ุงูุฃุฏูุงุฑ ูุงููุณุคูููุงุช</span>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-5">
                <div class="glass shape-angled p-5 shadow-lg border border-sky-100">
                    <h3 class="font-bold text-slate-800 mb-2">ุงููุฏูุฑ ุงููุงูู ูููุฌููุนุฉ</h3>
                    <ul class="text-sm text-slate-600 space-y-1">
                        <li>ูุฑู ูู ุงููุฑูุน ูุงูุญุงุถูุงุช ูุงูุจุฑุงูุฌ</li>
                        <li>ูุนุชูุฏ ุงูููุฒุงููุงุช ุงูููุงุฆูุฉ</li>
                        <li>ููุฑู ุณูุงุณุงุช ุงูุชุญุตูู ูุงูุฎุตู ูุฎุทุท ุงูุฏูุน</li>
                    </ul>
                </div>
                <div class="glass shape-cut p-5 shadow-lg border border-indigo-100">
                    <h3 class="font-bold text-slate-800 mb-2">ูุฏูุฑ ูุงููุฉ ุงููุฑุน/ุงูุญุงุถูุฉ</h3>
                    <ul class="text-sm text-slate-600 space-y-1">
                        <li>ูุฑูุน ููุฒุงููุฉ ููุชุฑุญุฉ</li>
                        <li>ูุชุงุจุน ุงูุชุญุตูู ุงููููู</li>
                        <li>ูุชุนุงูู ูุน ุงูุนููุงุก ุงููุชุฃุฎุฑูู</li>
                    </ul>
                </div>
                <div class="glass shape-rounded p-5 shadow-lg border border-emerald-100">
                    <h3 class="font-bold text-slate-800 mb-2">ูุญุงุณุจ</h3>
                    <ul class="text-sm text-slate-600 space-y-1">
                        <li>ุฅุฏุฎุงู ุงููููุฏ ุงููุญุงุณุจูุฉ</li>
                        <li>ูุฑุงุฌุนุฉ ุงูููุงุชูุฑ ูุงููุฏููุนุงุช</li>
                        <li>ุชุณููุงุช ููุงูุฉ ุงูุดูุฑ</li>
                    </ul>
                </div>
                <div class="glass shape-pill p-5 shadow-lg border border-rose-100">
                    <h3 class="font-bold text-slate-800 mb-2">ูุณุคูู ุงูุชุญุตูู</h3>
                    <ul class="text-sm text-slate-600 space-y-1">
                        <li>ุงูุชุนุงูู ูุน ุดุงุดุฉ ุงูุชุญุตูู ูุฎุทุท ุงูุฏูุน</li>
                        <li>ูุชููู ุฅุดุนุงุฑุงุช ุงูุชุนุซุฑ</li>
                        <li>ูุชุงุจุนุฉ ุงูุชุฒุงู ุงูุนููุงุก</li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="glass shape-rounded shadow-2xl p-6 mb-8 accent-indigo">
            <div class="flex flex-wrap items-center justify-between mb-6 gap-3">
                <h2 class="text-2xl font-bold text-slate-800">๐ ุณูุงุณุงุช ุงูุนูู</h2>
                <span class="text-sm text-slate-500">ุญูููุฉ ุงูููุชุฑุฉ ูุงูุชุญุตูู ูุงูุฅููุงู ูุงูุฐูุงุก ุงูุงุตุทูุงุนู</span>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-5">
                <div class="glass shape-angled p-5 shadow-lg border border-amber-100">
                    <h4 class="font-bold text-slate-800 mb-2">ุณูุงุณุฉ ุงูููุชุฑุฉ</h4>
                    <ul class="text-sm text-slate-600 space-y-1">
                        <li>ูุง ุชูุตุฏุฑ ูุงุชูุฑุฉ ุฅูุง ูุฑุชุจุทุฉ: ุนููู + ุจุฑูุงูุฌ/ุฎุฏูุฉ + ุญุงุถูุฉ/ูุฑุน</li>
                        <li>ูุง ุชูุนุฏูู ูุงุชูุฑุฉ ุจุนุฏ ุฅุตุฏุงุฑูุง ุฅูุง ุจุตูุงุญูุฉ ุฃุนูู ูุน ุฃุซุฑ ูุญุงุณุจู ูุงุถุญ</li>
                    </ul>
                </div>
                <div class="glass shape-cut p-5 shadow-lg border border-sky-100">
                    <h4 class="font-bold text-slate-800 mb-2">ุณูุงุณุฉ ุงูุชุญุตูู</h4>
                    <ul class="text-sm text-slate-600 space-y-1">
                        <li>ูุณุจุฉ ุฎุตู ูุตูู ุชุดุฌูุนูุฉ ุชุนุชูุฏูุง ุงูุฅุฏุงุฑุฉ ุงููุงููุฉ ูููุฌููุนุฉ</li>
                        <li>ูุง ูููุดุฃ ุฎุทุฉ ุฏูุน ุฅูุง ุจุนุฏ ุชุญูู ุงูุญุฏ ุงูุฃุฏูู ูุณูุงุณุฉ ุงูุจุฑูุงูุฌ</li>
                    </ul>
                </div>
                <div class="glass shape-rounded p-5 shadow-lg border border-emerald-100">
                    <h4 class="font-bold text-slate-800 mb-2">ุณูุงุณุฉ ุงูุฅููุงู ุงูุดูุฑู</h4>
                    <ul class="text-sm text-slate-600 space-y-1">
                        <li>ุฅููุงู ุฅุฏุฎุงู ุงููููุฏ ุจุนุฏ ููู ูุญุฏุฏ ูู ุงูุดูุฑ ุงูุชุงูู ุฅูุง ุจุณูุงุญ ุฎุงุต</li>
                        <li>ูุฑุถ ุชุณููุงุช ุจูู/ุฐูู/ุฃุตูู ูุจู ุงุนุชูุงุฏ ุงูุชูุงุฑูุฑ ุงูุดูุฑูุฉ</li>
                    </ul>
                </div>
                <div class="glass shape-pill p-5 shadow-lg border border-rose-100">
                    <h4 class="font-bold text-slate-800 mb-2">ุณูุงุณุฉ ุงูุฐูุงุก ุงูุงุตุทูุงุนู</h4>
                    <ul class="text-sm text-slate-600 space-y-1">
                        <li>ุงูุฐูุงุก ุงูุงุตุทูุงุนู ููุฏู ุชูุตูุงุช ูุฏุฑุฌุงุช ูุฎุงุทุฑ ููุท</li>
                        <li>ูุง ูุชู ุฅููุงู ุฎุฏูุฉ ุนููู ุฏูู ููุงููุฉ ุจุดุฑูุฉ</li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="glass shape-rounded shadow-2xl p-6 mb-8 accent-emerald">
            <div class="flex flex-wrap items-center justify-between mb-6 gap-3">
                <h2 class="text-2xl font-bold text-slate-800">โ ุฏูุฑุฉ ุงูููุงููุงุช</h2>
                <span class="text-sm text-slate-500">ุณูุฑ ุงูุนูู ุงููุนุชูุฏ ููููุงููุงุช</span>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-5">
                <div class="glass shape-angled p-5 shadow-lg border border-emerald-100">
                    <h4 class="font-bold text-slate-800 mb-2">ูุงุชูุฑุฉ ูุจูุฑุฉ ููู ุญุฏ ูุนูู</h4>
                    <p class="text-sm text-slate-600">ุชุญุชุงุฌ ููุงููุฉ ูุฏูุฑ ุงููุฑุน + ุงููุงููุฉ ุงููุฑูุฒูุฉ.</p>
                </div>
                <div class="glass shape-cut p-5 shadow-lg border border-indigo-100">
                    <h4 class="font-bold text-slate-800 mb-2">ุฎุทุฉ ุฏูุน ูุนููู ุนุงูู ุงููุฎุงุทุฑ</h4>
                    <p class="text-sm text-slate-600">ููุงููุฉ ูุฒุฏูุฌุฉ: ุงูุชุญุตูู + ูุฏูุฑ ุงููุงููุฉ.</p>
                </div>
                <div class="glass shape-pill p-5 shadow-lg border border-amber-100">
                    <h4 class="font-bold text-slate-800 mb-2">ุชุนุฏูู ููุฒุงููุฉ ุจุนุฏ ุงูุงุนุชูุงุฏ</h4>
                    <p class="text-sm text-slate-600">ุทูุจ ุชุบููุฑ ุฑุณูู + ุณุจุจ + ุฃุซุฑ ุนูู ุงูุชุฏููุงุช + ููุงููุฉ ุงูุฅุฏุงุฑุฉ ุงููุงููุฉ ูููุฌููุนุฉ.</p>
                </div>
            </div>
        </div>

        <div class="glass shape-rounded shadow-2xl p-6 mb-8 accent-rose">
            <div class="flex flex-wrap items-center justify-between mb-6 gap-3">
                <h2 class="text-2xl font-bold text-slate-800">๐ ุทุจูุงุช ุงูุชูุงุฑูุฑ ุงูุฐููุฉ</h2>
                <span class="text-sm text-slate-500">ุชุดุบูููุฉ โข ุชูุชูููุฉ โข ุงุณุชุฑุงุชูุฌูุฉ</span>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-5">
                <div class="glass shape-angled p-5 shadow-lg border border-sky-100">
                    <h4 class="font-bold text-slate-800 mb-2">ุชูุงุฑูุฑ ุชุดุบูููุฉ (ูููู/ุฃุณุจูุนู)</h4>
                    <ul class="text-sm text-slate-600 space-y-1">
                        <li>ุชูุฑูุฑ ุงูุชุญุตูู ุงููููู ููุงุจู ุงููุฏู</li>
                        <li>ุงูููุงุชูุฑ ุงููุณุฏุฏุฉ ุฌุฒุฆููุง</li>
                        <li>ุงูููุงุชูุฑ ุงููุชุฃุฎุฑุฉ ุฐุงุช ูุคุดุฑ ุฎุทุฑ</li>
                        <li>ุชูุฑูุฑ ุฃุนูุงุฑ ุงูุฐูู ุญุณุจ ุงููุฑุน ูุงูุญุงุถูุฉ ูุงูุจุฑูุงูุฌ</li>
                    </ul>
                </div>
                <div class="glass shape-cut p-5 shadow-lg border border-indigo-100">
                    <h4 class="font-bold text-slate-800 mb-2">ุชูุงุฑูุฑ ุชูุชูููุฉ (ุดูุฑู/ุฑุจุน ุณููู)</h4>
                    <ul class="text-sm text-slate-600 space-y-1">
                        <li>ุฅูุฑุงุฏุงุช ูุนููุฉ ููุงุจู ุงูููุฒุงููุฉ</li>
                        <li>ูุตุฑููุงุช ูุนููุฉ ููุงุจู ุงูููุฒุงููุฉ</li>
                        <li>ุตุงูู ูุงูุด ุงูุฑุจุญ</li>
                        <li>ูุณุจุฉ ุงูุชุญุตูู ููุณุจุฉ ุงูุชุนุซุฑ</li>
                    </ul>
                </div>
                <div class="glass shape-pill p-5 shadow-lg border border-rose-100">
                    <h4 class="font-bold text-slate-800 mb-2">ุชูุงุฑูุฑ ุงุณุชุฑุงุชูุฌูุฉ (ููุฅุฏุงุฑุฉ ุงูุนููุง)</h4>
                    <ul class="text-sm text-slate-600 space-y-1">
                        <li>ุงูุญุฑุงู ุงูููุฒุงููุฉ ููู ุญุณุงุจ ุฑุฆูุณู</li>
                        <li>ุงูุญุฑุงู ุงูููุฒุงููุฉ ููู ุจุฑูุงูุฌ ุฑุฆูุณู</li>
                        <li>ุชูุณูุฑ ุขูู ููุงูุญุฑุงูุงุช ุงุนุชูุงุฏูุง ุนูู ุงูุฃููุงุท</li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-5 mb-8">
            <div class="glass shape-angled p-5 shadow-lg accent-sky">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-sm text-slate-600">ุฅุฌูุงูู ุงูููุงุชูุฑ</span>
                    <i class="fas fa-file-invoice text-sky-500 text-2xl"></i>
                </div>
                <div id="totalInvoices" class="text-3xl font-bold text-slate-800">0</div>
            </div>
            <div class="glass shape-cut p-5 shadow-lg accent-rose">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-sm text-slate-600">ููุงุชูุฑ ูุชุฃุฎุฑุฉ</span>
                    <i class="fas fa-triangle-exclamation text-rose-500 text-2xl"></i>
                </div>
                <div id="overdueInvoices" class="text-3xl font-bold text-slate-800">0</div>
            </div>
            <div class="glass shape-rounded p-5 shadow-lg accent-emerald">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-sm text-slate-600">ุฎุทุท ุณุฏุงุฏ ูุดุทุฉ</span>
                    <i class="fas fa-calendar-check text-emerald-500 text-2xl"></i>
                </div>
                <div id="totalPlans" class="text-3xl font-bold text-slate-800">0</div>
            </div>
            <div class="glass shape-pill p-5 shadow-lg accent-indigo">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-sm text-slate-600">ุชููููุงุช ุงููุฎุงุทุฑ</span>
                    <i class="fas fa-shield-halved text-indigo-500 text-2xl"></i>
                </div>
                <div id="totalRisks" class="text-3xl font-bold text-slate-800">0</div>
            </div>
            <div class="glass shape-angled p-5 shadow-lg accent-amber">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-sm text-slate-600">ุงูุนููุงุก ุงููุฑุชุจุทูู</span>
                    <i class="fas fa-users text-amber-500 text-2xl"></i>
                </div>
                <div id="totalCustomers" class="text-3xl font-bold text-slate-800">0</div>
            </div>
            <div class="glass shape-cut p-5 shadow-lg accent-sky">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-sm text-slate-600">ุฅุฌูุงูู ุงููุฏููุนุงุช</span>
                    <i class="fas fa-credit-card text-sky-500 text-2xl"></i>
                </div>
                <div id="totalPayments" class="text-3xl font-bold text-slate-800">0</div>
            </div>
            <div class="glass shape-rounded p-5 shadow-lg accent-emerald">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-sm text-slate-600">ุงูููุฒุงููุงุช ุงููุนุชูุฏุฉ</span>
                    <i class="fas fa-file-invoice-dollar text-emerald-500 text-2xl"></i>
                </div>
                <div id="totalBudgets" class="text-3xl font-bold text-slate-800">0</div>
            </div>
            <div class="glass shape-pill p-5 shadow-lg accent-indigo">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-sm text-slate-600">ุงูุชููุนุงุช ุงูุฐููุฉ</span>
                    <i class="fas fa-brain text-indigo-500 text-2xl"></i>
                </div>
                <div id="totalForecasts" class="text-3xl font-bold text-slate-800">0</div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
            <div class="glass shape-rounded shadow-2xl p-6 accent-sky">
                <h3 class="text-lg font-bold text-slate-800 mb-4">๐ ุชูุฒูุน ุญุงูุงุช ุงูููุงุชูุฑ</h3>
                <div class="chart-box"><canvas id="invoiceStatusChart"></canvas></div>
            </div>
            <div class="glass shape-rounded shadow-2xl p-6 accent-rose">
                <h3 class="text-lg font-bold text-slate-800 mb-4">๐งญ ุชูุฒูุน ูุณุชููุงุช ุงููุฎุงุทุฑ</h3>
                <div class="chart-box"><canvas id="riskLevelChart"></canvas></div>
            </div>
        </div>

        <div class="glass shape-rounded shadow-2xl p-6 mb-8 accent-sky">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-xl font-bold text-slate-800">๐ ุฌุฏูู ุงูููุงุชูุฑ ุงูุฎุงุถุนุฉ ููุญูููุฉ</h3>
                <span id="invoicesCount" class="text-sm text-slate-500"></span>
            </div>
            <div class="table-scroll">
                <table class="w-full text-xs">
                    <thead class="bg-sky-50 text-sky-700">
                        <tr>
                            <th class="px-3 py-2 text-right">ุฑูู ุงููุงุชูุฑุฉ</th>
                            <th class="px-3 py-2 text-right">ุชุงุฑูุฎ ุงููุงุชูุฑุฉ</th>
                            <th class="px-3 py-2 text-right">ุฑูู ุงูุนููู</th>
                            <th class="px-3 py-2 text-right">ุงุณู ุงูุนููู</th>
                            <th class="px-3 py-2 text-right">ุงููุจูุบ ุงูุฅุฌูุงูู</th>
                            <th class="px-3 py-2 text-right">ุงููุฏููุน</th>
                            <th class="px-3 py-2 text-right">ุงููุชุจูู</th>
                            <th class="px-3 py-2 text-right">ุงูุญุงูุฉ</th>
                            <th class="px-3 py-2 text-right">ุงููุฑุน</th>
                            <th class="px-3 py-2 text-right">ุงูุจุฑูุงูุฌ</th>
                        </tr>
                    </thead>
                    <tbody id="invoicesTable" class="divide-y divide-slate-100">
                        <tr>
                            <td colspan="10" class="px-4 py-12 text-center text-slate-500">ุฌุงุฑู ุชุญููู ุงูุจูุงูุงุช...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="glass shape-rounded shadow-2xl p-6 mb-8 accent-indigo">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-xl font-bold text-slate-800">๐ ุฌุฏูู ุฎุทุท ุงูุณุฏุงุฏ ุงููุนุชูุฏุฉ</h3>
                <span id="plansCount" class="text-sm text-slate-500"></span>
            </div>
            <div class="table-scroll">
                <table class="w-full text-xs">
                    <thead class="bg-indigo-50 text-indigo-700">
                        <tr>
                            <th class="px-3 py-2 text-right">ุฑูู ุงูุฎุทุฉ</th>
                            <th class="px-3 py-2 text-right">ุฑูู ุงูุนููู</th>
                            <th class="px-3 py-2 text-right">ุงุณู ุงูุนููู</th>
                            <th class="px-3 py-2 text-right">ุฑูู ุงููุงุชูุฑุฉ</th>
                            <th class="px-3 py-2 text-right">ุชุงุฑูุฎ ุงูุจุฏุงูุฉ</th>
                            <th class="px-3 py-2 text-right">ุชุงุฑูุฎ ุงูููุงูุฉ</th>
                            <th class="px-3 py-2 text-right">ุฅุฌูุงูู ุงูุฎุทุฉ</th>
                            <th class="px-3 py-2 text-right">ุงููุชุจูู</th>
                            <th class="px-3 py-2 text-right">ุนุฏุฏ ุงูุฃูุณุงุท</th>
                            <th class="px-3 py-2 text-right">ุงูุญุงูุฉ</th>
                            <th class="px-3 py-2 text-right">ูุณุชูู ุงููุฎุงุทุฑ</th>
                        </tr>
                    </thead>
                    <tbody id="plansTable" class="divide-y divide-slate-100">
                        <tr>
                            <td colspan="11" class="px-4 py-12 text-center text-slate-500">ุฌุงุฑู ุชุญููู ุงูุจูุงูุงุช...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="glass shape-rounded shadow-2xl p-6 mb-8 accent-emerald">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-xl font-bold text-slate-800">๐ ุฌุฏูู ุงูููุฒุงููุงุช ูุงูุงูุญุฑุงูุงุช</h3>
                <span id="budgetsCount" class="text-sm text-slate-500"></span>
            </div>
            <div class="table-scroll">
                <table class="w-full text-xs">
                    <thead class="bg-emerald-50 text-emerald-700">
                        <tr>
                            <th class="px-3 py-2 text-right">ููุฏ ุงูููุฒุงููุฉ</th>
                            <th class="px-3 py-2 text-right">ุงุณู ุงูููุฒุงููุฉ</th>
                            <th class="px-3 py-2 text-right">ุงูููุน</th>
                            <th class="px-3 py-2 text-right">ุงูุณูุฉ ุงููุงููุฉ</th>
                            <th class="px-3 py-2 text-right">ุงูุญุงูุฉ</th>
                            <th class="px-3 py-2 text-right">ุงูุณููุงุฑูู</th>
                        </tr>
                    </thead>
                    <tbody id="budgetsTable" class="divide-y divide-slate-100">
                        <tr>
                            <td colspan="6" class="px-4 py-12 text-center text-slate-500">ุฌุงุฑู ุชุญููู ุงูุจูุงูุงุช...</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="mt-6">
                <div class="flex items-center justify-between mb-2">
                    <h4 class="text-lg font-bold text-slate-800">๐ ุฌุฏูู ุงูุงูุญุฑุงูุงุช</h4>
                    <span id="variancesCount" class="text-sm text-slate-500"></span>
                </div>
                <div class="table-scroll">
                    <table class="w-full text-xs">
                        <thead class="bg-emerald-100 text-emerald-800">
                            <tr>
                                <th class="px-3 py-2 text-right">ุงููุชุฑุฉ</th>
                                <th class="px-3 py-2 text-right">ุงูุญุณุงุจ</th>
                                <th class="px-3 py-2 text-right">ุงููุฎุทุท</th>
                                <th class="px-3 py-2 text-right">ุงููุนูู</th>
                                <th class="px-3 py-2 text-right">ุงูุงูุญุฑุงู</th>
                                <th class="px-3 py-2 text-right">ุงููุณุจุฉ</th>
                                <th class="px-3 py-2 text-right">ูุณุชูู ุงูุฃูููุฉ</th>
                            </tr>
                        </thead>
                        <tbody id="variancesTable" class="divide-y divide-slate-100">
                            <tr>
                                <td colspan="7" class="px-4 py-12 text-center text-slate-500">ุฌุงุฑู ุชุญููู ุงูุจูุงูุงุช...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="glass shape-rounded shadow-2xl p-6 mb-8 accent-rose">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-xl font-bold text-slate-800">๐ก๏ธ ุฌุฏูู ุชููููุงุช ุงููุฎุงุทุฑ ูุงูุชููุนุงุช</h3>
                <span id="risksCount" class="text-sm text-slate-500"></span>
            </div>
            <div class="table-scroll mb-6">
                <table class="w-full text-xs">
                    <thead class="bg-rose-50 text-rose-700">
                        <tr>
                            <th class="px-3 py-2 text-right">ุฑูู ุงููุฎุงุทุฑ</th>
                            <th class="px-3 py-2 text-right">ุฑูู ุงูุนููู</th>
                            <th class="px-3 py-2 text-right">ุชุงุฑูุฎ ุงูุชูููู</th>
                            <th class="px-3 py-2 text-right">ุฏุฑุฌุฉ ุงููุฎุงุทุฑุฉ</th>
                            <th class="px-3 py-2 text-right">ูุณุชูู ุงููุฎุงุทุฑุฉ</th>
                            <th class="px-3 py-2 text-right">ุงูุชูุตูุงุช</th>
                        </tr>
                    </thead>
                    <tbody id="risksTable" class="divide-y divide-slate-100">
                        <tr>
                            <td colspan="6" class="px-4 py-12 text-center text-slate-500">ุฌุงุฑู ุชุญููู ุงูุจูุงูุงุช...</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="flex items-center justify-between mb-2">
                <h4 class="text-lg font-bold text-slate-800">๐ฎ ุฌุฏูู ุงูุชููุนุงุช ุงูุฐููุฉ</h4>
                <span id="forecastsCount" class="text-sm text-slate-500"></span>
            </div>
            <div class="table-scroll">
                <table class="w-full text-xs">
                    <thead class="bg-rose-100 text-rose-800">
                        <tr>
                            <th class="px-3 py-2 text-right">ุฑูู ุงูุชููุน</th>
                            <th class="px-3 py-2 text-right">ูุชุฑุฉ ุงูุชููุน</th>
                            <th class="px-3 py-2 text-right">ููุน ุงูุชููุน</th>
                            <th class="px-3 py-2 text-right">ูููุฉ ุงูุชููุน</th>
                            <th class="px-3 py-2 text-right">ูุณุชูู ุงูุซูุฉ</th>
                            <th class="px-3 py-2 text-right">ููุงุญุธุงุช ุงูุฐูุงุก</th>
                        </tr>
                    </thead>
                    <tbody id="forecastsTable" class="divide-y divide-slate-100">
                        <tr>
                            <td colspan="6" class="px-4 py-12 text-center text-slate-500">ุฌุงุฑู ุชุญููู ุงูุจูุงูุงุช...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = window.location.origin;
        const ENTITY_ID = '1';

        let store = {
            invoices: [],
            payments: [],
            plans: [],
            budgets: [],
            variances: [],
            risks: [],
            forecasts: [],
            customers: []
        };

        let invoiceChartInstance = null;
        let riskChartInstance = null;

        async function loadData() {
            try {
                const [invoiceRes, paymentRes, planRes, budgetRes, riskRes, forecastRes, customerRes] = await Promise.all([
                    fetch(`${API_BASE}/finance/invoices`),
                    fetch(`${API_BASE}/finance/payments`),
                    fetch(`${API_BASE}/finance/payment-plans?entity_id=${ENTITY_ID}`),
                    fetch(`${API_BASE}/finance/budgets?entity_id=${ENTITY_ID}`),
                    fetch(`${API_BASE}/finance/ai-risk-scores?entity_id=${ENTITY_ID}`),
                    fetch(`${API_BASE}/finance/ai-forecasts?entity_id=${ENTITY_ID}`),
                    fetch(`${API_BASE}/finance/customers`)
                ]);

                const [invoiceData, paymentData, planData, budgetData, riskData, forecastData, customerData] = await Promise.all([
                    invoiceRes.json(),
                    paymentRes.json(),
                    planRes.json(),
                    budgetRes.json(),
                    riskRes.json(),
                    forecastRes.json(),
                    customerRes.json()
                ]);

                store.invoices = invoiceData.invoices || [];
                store.payments = paymentData.payments || [];
                store.plans = planData.plans || [];
                store.budgets = budgetData.budgets || [];
                store.variances = budgetData.variances || [];
                store.risks = riskData.rows || [];
                store.forecasts = forecastData.forecasts || [];
                store.customers = customerData.customers || customerData.rows || [];

                renderStats();
                renderCharts();
                renderTables();
            } catch (error) {
                console.error('ุฎุทุฃ ูู ุชุญููู ุงูุจูุงูุงุช:', error);
            }
        }

        function renderStats() {
            const totalInvoices = store.invoices.length;
            const overdueInvoices = store.invoices.filter(i => String(i.status || '').toUpperCase() === 'OVERDUE').length;
            const totalPlans = store.plans.length;
            const totalRisks = store.risks.length;
            const totalCustomers = store.customers.length;
            const totalPayments = sum(store.payments, 'payment_amount');
            const totalBudgets = store.budgets.length;
            const totalForecasts = store.forecasts.length;

            document.getElementById('totalInvoices').textContent = totalInvoices.toLocaleString('ar-SA');
            document.getElementById('overdueInvoices').textContent = overdueInvoices.toLocaleString('ar-SA');
            document.getElementById('totalPlans').textContent = totalPlans.toLocaleString('ar-SA');
            document.getElementById('totalRisks').textContent = totalRisks.toLocaleString('ar-SA');
            document.getElementById('totalCustomers').textContent = totalCustomers.toLocaleString('ar-SA');
            document.getElementById('totalPayments').textContent = formatMoney(totalPayments);
            document.getElementById('totalBudgets').textContent = totalBudgets.toLocaleString('ar-SA');
            document.getElementById('totalForecasts').textContent = totalForecasts.toLocaleString('ar-SA');
        }

        function renderCharts() {
            const statusCounts = store.invoices.reduce((acc, inv) => {
                const status = translateStatus(inv.status);
                acc[status] = (acc[status] || 0) + 1;
                return acc;
            }, {});

            const statusLabels = Object.keys(statusCounts);
            const statusValues = Object.values(statusCounts);

            const invoiceCtx = document.getElementById('invoiceStatusChart').getContext('2d');
            if (invoiceChartInstance) invoiceChartInstance.destroy();
            invoiceChartInstance = new Chart(invoiceCtx, {
                type: 'doughnut',
                data: {
                    labels: statusLabels.length ? statusLabels : ['ูุง ุชูุฌุฏ ุจูุงูุงุช'],
                    datasets: [{
                        data: statusValues.length ? statusValues : [0],
                        backgroundColor: ['#0ea5e9', '#f59e0b', '#10b981', '#ef4444', '#6366f1']
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });

            const riskCounts = store.risks.reduce((acc, r) => {
                const level = translateRiskLevel(r.risk_level) || 'ุบูุฑ ูุญุฏุฏ';
                acc[level] = (acc[level] || 0) + 1;
                return acc;
            }, {});

            const riskLabels = Object.keys(riskCounts);
            const riskValues = Object.values(riskCounts);

            const riskCtx = document.getElementById('riskLevelChart').getContext('2d');
            if (riskChartInstance) riskChartInstance.destroy();
            riskChartInstance = new Chart(riskCtx, {
                type: 'bar',
                data: {
                    labels: riskLabels.length ? riskLabels : ['ูุง ุชูุฌุฏ ุจูุงูุงุช'],
                    datasets: [{
                        data: riskValues.length ? riskValues : [0],
                        backgroundColor: ['#ef4444', '#f59e0b', '#10b981', '#6366f1']
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
            });
        }

        function renderTables() {
            const invoiceRows = store.invoices.map(inv => `
                <tr class="hover:bg-sky-50">
                    <td class="px-3 py-2">${sanitizeText(inv.invoice_number)}</td>
                    <td class="px-3 py-2">${formatDate(inv.invoice_date)}</td>
                    <td class="px-3 py-2">${sanitizeText(inv.customer_id)}</td>
                    <td class="px-3 py-2">${sanitizeText(inv.customer_name_ar || inv.customer_name)}</td>
                    <td class="px-3 py-2 font-semibold text-emerald-700">${formatMoney(inv.total_amount)}</td>
                    <td class="px-3 py-2">${formatMoney(inv.paid_amount)}</td>
                    <td class="px-3 py-2">${formatMoney(inv.remaining_amount)}</td>
                    <td class="px-3 py-2">${translateStatus(inv.status)}</td>
                    <td class="px-3 py-2">${sanitizeText(inv.branch_id)}</td>
                    <td class="px-3 py-2">${sanitizeText(inv.program_id)}</td>
                </tr>
            `).join('');

            document.getElementById('invoicesTable').innerHTML = invoiceRows || `<tr><td colspan="10" class="px-4 py-12 text-center text-slate-500">ูุง ุชูุฌุฏ ุจูุงูุงุช</td></tr>`;
            document.getElementById('invoicesCount').textContent = `ุนุฏุฏ ุงูุตููู: ${store.invoices.length}`;

            const planRows = store.plans.map(plan => `
                <tr class="hover:bg-indigo-50">
                    <td class="px-3 py-2">${plan.plan_number ?? plan.plan_id ?? '-'}</td>
                    <td class="px-3 py-2">${plan.customer_id ?? '-'}</td>
                    <td class="px-3 py-2">${sanitizeText(plan.customer_name_ar || plan.customer_name_en)}</td>
                    <td class="px-3 py-2">${sanitizeText(plan.invoice_number)}</td>
                    <td class="px-3 py-2">${formatDate(plan.start_date)}</td>
                    <td class="px-3 py-2">${formatDate(plan.end_date)}</td>
                    <td class="px-3 py-2 font-semibold text-emerald-700">${formatMoney(plan.total_amount)}</td>
                    <td class="px-3 py-2">${formatMoney(plan.remaining_amount)}</td>
                    <td class="px-3 py-2">${plan.number_of_installments ?? '-'}</td>
                    <td class="px-3 py-2">${translateStatus(plan.status)}</td>
                    <td class="px-3 py-2">${translateRiskLevel(plan.risk_level_at_creation)}</td>
                </tr>
            `).join('');

            document.getElementById('plansTable').innerHTML = planRows || `<tr><td colspan="11" class="px-4 py-12 text-center text-slate-500">ูุง ุชูุฌุฏ ุจูุงูุงุช</td></tr>`;
            document.getElementById('plansCount').textContent = `ุนุฏุฏ ุงูุตููู: ${store.plans.length}`;

            const budgetRows = store.budgets.map(b => `
                <tr class="hover:bg-emerald-50">
                    <td class="px-3 py-2">${sanitizeText(b.budget_code)}</td>
                    <td class="px-3 py-2">${sanitizeText(b.budget_name_ar || b.budget_name_en)}</td>
                    <td class="px-3 py-2">${translateBudgetType(b.budget_type)}</td>
                    <td class="px-3 py-2">${b.fiscal_year ?? '-'}</td>
                    <td class="px-3 py-2">${translateStatus(b.status)}</td>
                    <td class="px-3 py-2">${sanitizeText(b.scenario)}</td>
                </tr>
            `).join('');

            document.getElementById('budgetsTable').innerHTML = budgetRows || `<tr><td colspan="6" class="px-4 py-12 text-center text-slate-500">ูุง ุชูุฌุฏ ุจูุงูุงุช</td></tr>`;
            document.getElementById('budgetsCount').textContent = `ุนุฏุฏ ุงูุตููู: ${store.budgets.length}`;

            const varianceRows = store.variances.map(v => `
                <tr class="hover:bg-emerald-50">
                    <td class="px-3 py-2">${sanitizeText(v.period_name) || `${v.fiscal_year || ''}-${v.fiscal_period || ''}`}</td>
                    <td class="px-3 py-2">${sanitizeText(v.account_code)} ${sanitizeText(v.account_id)}</td>
                    <td class="px-3 py-2">${formatMoney(v.budgeted_amount)}</td>
                    <td class="px-3 py-2">${formatMoney(v.actual_amount)}</td>
                    <td class="px-3 py-2">${formatMoney(v.variance_amount)}</td>
                    <td class="px-3 py-2">${formatPercent(v.variance_percentage)}</td>
                    <td class="px-3 py-2">${sanitizeText(v.significance_level)}</td>
                </tr>
            `).join('');

            document.getElementById('variancesTable').innerHTML = varianceRows || `<tr><td colspan="7" class="px-4 py-12 text-center text-slate-500">ูุง ุชูุฌุฏ ุจูุงูุงุช</td></tr>`;
            document.getElementById('variancesCount').textContent = `ุนุฏุฏ ุงูุตููู: ${store.variances.length}`;

            const riskRows = store.risks.map(r => `
                <tr class="hover:bg-rose-50">
                    <td class="px-3 py-2">${r.risk_id ?? '-'}</td>
                    <td class="px-3 py-2">${r.customer_id ?? '-'}</td>
                    <td class="px-3 py-2">${formatDate(r.assessment_date)}</td>
                    <td class="px-3 py-2">${formatPercent(r.risk_score)}</td>
                    <td class="px-3 py-2">${translateRiskLevel(r.risk_level)}</td>
                    <td class="px-3 py-2">${truncate(sanitizeText(r.recommendations))}</td>
                </tr>
            `).join('');

            document.getElementById('risksTable').innerHTML = riskRows || `<tr><td colspan="6" class="px-4 py-12 text-center text-slate-500">ูุง ุชูุฌุฏ ุจูุงูุงุช</td></tr>`;
            document.getElementById('risksCount').textContent = `ุนุฏุฏ ุงูุตููู: ${store.risks.length}`;

            const forecastRows = store.forecasts.map(f => `
                <tr class="hover:bg-rose-50">
                    <td class="px-3 py-2">${f.forecast_id ?? '-'}</td>
                    <td class="px-3 py-2">${sanitizeText(f.forecast_period)}</td>
                    <td class="px-3 py-2">${translateForecastType(f.forecast_type)}</td>
                    <td class="px-3 py-2">${formatMoney(f.forecast_amount)}</td>
                    <td class="px-3 py-2">${formatPercent(f.confidence_level)}</td>
                    <td class="px-3 py-2">${truncate(sanitizeText(f.ai_insights))}</td>
                </tr>
            `).join('');

            document.getElementById('forecastsTable').innerHTML = forecastRows || `<tr><td colspan="6" class="px-4 py-12 text-center text-slate-500">ูุง ุชูุฌุฏ ุจูุงูุงุช</td></tr>`;
            document.getElementById('forecastsCount').textContent = `ุนุฏุฏ ุงูุตููู: ${store.forecasts.length}`;
        }

        function translateStatus(value) {
            const map = {
                PAID: 'ูุฏููุนุฉ',
                UNPAID: 'ุบูุฑ ูุฏููุนุฉ',
                PARTIAL: 'ูุฏููุนุฉ ุฌุฒุฆููุง',
                OVERDUE: 'ูุชุฃุฎุฑุฉ',
                ACTIVE: 'ูุดุทุฉ',
                CLOSED: 'ูุบููุฉ',
                PENDING: 'ููุฏ ุงููุฑุงุฌุนุฉ',
                APPROVED: 'ูุนุชูุฏุฉ',
                REJECTED: 'ูุฑููุถุฉ'
            };
            return map[String(value || '').toUpperCase()] || 'ุบูุฑ ูุญุฏุฏ';
        }

        function translateRiskLevel(value) {
            const map = { HIGH: 'ูุฑุชูุน', MEDIUM: 'ูุชูุณุท', LOW: 'ููุฎูุถ', CRITICAL: 'ุญุฑุฌ' };
            return map[String(value || '').toUpperCase()] || 'ุบูุฑ ูุญุฏุฏ';
        }

        function translateBudgetType(value) {
            const map = {
                OPERATING: 'ุชุดุบูููุฉ',
                CAPITAL: 'ุฑุฃุณูุงููุฉ',
                MASTER: 'ุดุงููุฉ',
                PROJECT: 'ูุดุฑูุน'
            };
            return map[String(value || '').toUpperCase()] || 'ุบูุฑ ูุญุฏุฏ';
        }

        function translateForecastType(value) {
            const map = { REVENUE: 'ุฅูุฑุงุฏุงุช', EXPENSE: 'ูุตุฑููุงุช', CASHFLOW: 'ุชุฏููุงุช ููุฏูุฉ', DEFAULT: 'ุชุนุซุฑ' };
            return map[String(value || '').toUpperCase()] || 'ุบูุฑ ูุญุฏุฏ';
        }

        function formatMoney(value) {
            const num = parseFloat(value || 0);
            return num.toLocaleString('ar-SA') + ' ุฑ.ุณ';
        }

        function formatDate(value) {
            if (!value) return '-';
            return new Date(value).toLocaleDateString('ar-SA');
        }

        function formatPercent(value) {
            if (value === null || value === undefined || value === '') return '-';
            const num = parseFloat(value || 0);
            return `${num.toFixed(1)}%`;
        }

        function truncate(value) {
            if (value === null || value === undefined) return '-';
            const text = typeof value === 'string' ? value : JSON.stringify(value);
            return text.length > 120 ? text.slice(0, 120) + '...' : text;
        }

        function sanitizeText(value) {
            if (value === null || value === undefined) return '-';
            const text = typeof value === 'string' ? value : JSON.stringify(value);
            const cleaned = text.replace(/[A-Za-z]+/g, '').replace(/\s{2,}/g, ' ').trim();
            return cleaned || '-';
        }

        function sum(rows, key) {
            return rows.reduce((acc, row) => acc + parseFloat(row[key] || 0), 0);
        }

        function downloadAllJSON() {
            const payload = {
                invoices: store.invoices,
                payments: store.payments,
                payment_plans: store.plans,
                budgets: store.budgets,
                variances: store.variances,
                risk_scores: store.risks,
                forecasts: store.forecasts,
                customers: store.customers
            };
            downloadBlob(JSON.stringify(payload, null, 2), 'ุญูููุฉ-ูุงููุฉ-ูุตูุงุญูุงุช-ูุชูุงุฑูุฑ.json', 'application/json');
        }

        function downloadAllCSV() {
            const rows = [];
            rows.push(['ุงูููุงุชูุฑ']);
            rows.push(['ุฑูู ุงููุงุชูุฑุฉ','ุชุงุฑูุฎ ุงููุงุชูุฑุฉ','ุฑูู ุงูุนููู','ุงุณู ุงูุนููู','ุงููุจูุบ ุงูุฅุฌูุงูู','ุงููุฏููุน','ุงููุชุจูู','ุงูุญุงูุฉ','ุงููุฑุน','ุงูุจุฑูุงูุฌ']);
            store.invoices.forEach(inv => rows.push([
                sanitizeText(inv.invoice_number), inv.invoice_date, inv.customer_id, sanitizeText(inv.customer_name_ar || inv.customer_name), inv.total_amount,
                inv.paid_amount, inv.remaining_amount, translateStatus(inv.status), inv.branch_id, inv.program_id
            ]));

            rows.push([]);
            rows.push(['ุฎุทุท ุงูุณุฏุงุฏ']);
            rows.push(['ุฑูู ุงูุฎุทุฉ','ุฑูู ุงูุนููู','ุงุณู ุงูุนููู','ุฑูู ุงููุงุชูุฑุฉ','ุชุงุฑูุฎ ุงูุจุฏุงูุฉ','ุชุงุฑูุฎ ุงูููุงูุฉ','ุฅุฌูุงูู ุงูุฎุทุฉ','ุงููุชุจูู','ุนุฏุฏ ุงูุฃูุณุงุท','ุงูุญุงูุฉ','ูุณุชูู ุงููุฎุงุทุฑ']);
            store.plans.forEach(plan => rows.push([
                plan.plan_number ?? plan.plan_id, plan.customer_id, sanitizeText(plan.customer_name_ar || plan.customer_name_en), sanitizeText(plan.invoice_number),
                plan.start_date, plan.end_date, plan.total_amount, plan.remaining_amount, plan.number_of_installments,
                translateStatus(plan.status), translateRiskLevel(plan.risk_level_at_creation)
            ]));

            rows.push([]);
            rows.push(['ุงูููุฒุงููุงุช']);
            rows.push(['ููุฏ ุงูููุฒุงููุฉ','ุงุณู ุงูููุฒุงููุฉ','ุงูููุน','ุงูุณูุฉ ุงููุงููุฉ','ุงูุญุงูุฉ','ุงูุณููุงุฑูู']);
            store.budgets.forEach(b => rows.push([
                sanitizeText(b.budget_code), sanitizeText(b.budget_name_ar || b.budget_name_en), translateBudgetType(b.budget_type), b.fiscal_year,
                translateStatus(b.status), sanitizeText(b.scenario)
            ]));

            rows.push([]);
            rows.push(['ุงูุงูุญุฑุงูุงุช']);
            rows.push(['ุงููุชุฑุฉ','ุงูุญุณุงุจ','ุงููุฎุทุท','ุงููุนูู','ุงูุงูุญุฑุงู','ุงููุณุจุฉ','ูุณุชูู ุงูุฃูููุฉ']);
            store.variances.forEach(v => rows.push([
                sanitizeText(v.period_name) || `${v.fiscal_year || ''}-${v.fiscal_period || ''}`, `${sanitizeText(v.account_code)} ${sanitizeText(v.account_id)}`,
                v.budgeted_amount, v.actual_amount, v.variance_amount, v.variance_percentage, sanitizeText(v.significance_level)
            ]));

            rows.push([]);
            rows.push(['ุงููุฎุงุทุฑ']);
            rows.push(['ุฑูู ุงููุฎุงุทุฑ','ุฑูู ุงูุนููู','ุชุงุฑูุฎ ุงูุชูููู','ุฏุฑุฌุฉ ุงููุฎุงุทุฑุฉ','ูุณุชูู ุงููุฎุงุทุฑุฉ','ุงูุชูุตูุงุช']);
            store.risks.forEach(r => rows.push([
                r.risk_id, r.customer_id, r.assessment_date, r.risk_score, translateRiskLevel(r.risk_level), sanitizeText(r.recommendations)
            ]));

            rows.push([]);
            rows.push(['ุงูุชููุนุงุช ุงูุฐููุฉ']);
            rows.push(['ุฑูู ุงูุชููุน','ูุชุฑุฉ ุงูุชููุน','ููุน ุงูุชููุน','ูููุฉ ุงูุชููุน','ูุณุชูู ุงูุซูุฉ','ููุงุญุธุงุช ุงูุฐูุงุก']);
            store.forecasts.forEach(f => rows.push([
                f.forecast_id, sanitizeText(f.forecast_period), translateForecastType(f.forecast_type), f.forecast_amount, f.confidence_level, sanitizeText(f.ai_insights)
            ]));

            const csv = rows.map(r => r.map(v => `"${v ?? ''}"`).join(',')).join('\n');
            downloadBlob(csv, 'ุญูููุฉ-ูุงููุฉ-ูุตูุงุญูุงุช-ูุชูุงุฑูุฑ.csv', 'text/csv;charset=utf-8;');
        }

        function downloadBlob(content, filename, type) {
            const blob = new Blob([content], { type });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            link.click();
            URL.revokeObjectURL(url);
        }

        function printPage() {
            window.print();
        }

        function copySummary() {
            const summary = `ููุฎุต ุงูุญูููุฉ\n` +
                `ุฅุฌูุงูู ุงูููุงุชูุฑ: ${store.invoices.length}\n` +
                `ุงูููุงุชูุฑ ุงููุชุฃุฎุฑุฉ: ${store.invoices.filter(i => String(i.status || '').toUpperCase() === 'OVERDUE').length}\n` +
                `ุฎุทุท ุงูุณุฏุงุฏ: ${store.plans.length}\n` +
                `ุงูููุฒุงููุงุช: ${store.budgets.length}\n` +
                `ุชููููุงุช ุงููุฎุงุทุฑ: ${store.risks.length}\n` +
                `ุงูุชููุนุงุช ุงูุฐููุฉ: ${store.forecasts.length}`;
            navigator.clipboard.writeText(summary).catch(() => {});
        }

        function refreshData() {
            loadData();
        }

        document.addEventListener('DOMContentLoaded', loadData);
    </script>
</body>
</html>
