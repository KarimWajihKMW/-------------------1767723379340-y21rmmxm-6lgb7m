<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ“˜ Ø¯Ù„ÙŠÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª - Ù†Ø¸Ø§Ù… Ù†Ø§ÙŠÙˆØ´</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            font-family: 'Cairo', sans-serif;
            background-color: #f9fafb;
            color: #1e293b;
        }
        .stat-card {
            transition: all 0.3s ease;
            background: white;
            border: 1px solid #e2e8f0;
        }
        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
    </style>
</head>
<body>
    <div class="container mx-auto px-4 py-8">
        <!-- Header -->
        <div class="mb-8">
            <h1 class="text-3xl font-bold text-slate-900 mb-2">ğŸ“˜ Ø¯Ù„ÙŠÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª (Chart of Accounts)</h1>
            <p class="text-slate-600">Ø¹Ø±Ø¶ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ù…Ø­Ø§Ø³Ø¨ÙŠØ© ÙˆØ£Ø±ØµØ¯Ø© Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª</p>
        </div>

        <!-- Action Buttons -->
        <div class="mb-6 flex gap-3 flex-wrap">
            <button onclick="openAccountModal('create')" class="bg-blue-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-blue-700 transition flex items-center gap-2 shadow-sm">
                <i class="fas fa-plus"></i>
                Ø¥Ø¶Ø§ÙØ© Ø­Ø³Ø§Ø¨
            </button>
            <button onclick="downloadCSV()" class="bg-white border border-slate-200 text-slate-700 px-4 py-2 rounded-lg font-bold hover:bg-slate-50 transition flex items-center gap-2 shadow-sm">
                <i class="fas fa-file-csv text-green-600"></i>
                ØªÙ†Ø²ÙŠÙ„ CSV
            </button>
            <button onclick="downloadJSON()" class="bg-white border border-slate-200 text-slate-700 px-4 py-2 rounded-lg font-bold hover:bg-slate-50 transition flex items-center gap-2 shadow-sm">
                <i class="fas fa-file-code text-blue-600"></i>
                ØªÙ†Ø²ÙŠÙ„ JSON
            </button>
            <button onclick="printAccounts()" class="bg-white border border-slate-200 text-slate-700 px-4 py-2 rounded-lg font-bold hover:bg-slate-50 transition flex items-center gap-2 shadow-sm">
                <i class="fas fa-print text-slate-600"></i>
                Ø·Ø¨Ø§Ø¹Ø©
            </button>
        </div>

        <!-- Summary Stats -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-6 mb-8">
            <div class="stat-card p-6 rounded-xl border-t-4 border-blue-500 shadow-sm">
                <div class="flex items-center justify-between mb-4">
                    <div>
                        <p class="text-sm font-medium text-slate-500 mb-1">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª</p>
                        <h3 id="totalAccounts" class="text-2xl font-bold text-slate-800">
                             <div class="animate-pulse h-8 w-24 bg-slate-200 rounded"></div>
                        </h3>
                    </div>
                    <div class="p-3 bg-blue-50 rounded-lg">
                        <i class="fas fa-list text-xl text-blue-600"></i>
                    </div>
                </div>
            </div>

            <div class="stat-card p-6 rounded-xl border-t-4 border-emerald-500 shadow-sm">
                <div class="flex items-center justify-between mb-4">
                    <div>
                        <p class="text-sm font-medium text-slate-500 mb-1">Ø§Ù„Ø£ØµÙˆÙ„</p>
                        <h3 id="assetCount" class="text-2xl font-bold text-slate-800">
                             <div class="animate-pulse h-8 w-24 bg-slate-200 rounded"></div>
                        </h3>
                    </div>
                    <div class="p-3 bg-emerald-50 rounded-lg">
                         <i class="fas fa-building text-xl text-emerald-600"></i>
                    </div>
                </div>
            </div>

            <div class="stat-card p-6 rounded-xl border-t-4 border-red-500 shadow-sm">
                <div class="flex items-center justify-between mb-4">
                    <div>
                        <p class="text-sm font-medium text-slate-500 mb-1">Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª</p>
                        <h3 id="liabilityCount" class="text-2xl font-bold text-slate-800">
                             <div class="animate-pulse h-8 w-24 bg-slate-200 rounded"></div>
                        </h3>
                    </div>
                    <div class="p-3 bg-red-50 rounded-lg">
                        <i class="fas fa-exclamation-triangle text-xl text-red-600"></i>
                    </div>
                </div>
            </div>

            <div class="stat-card p-6 rounded-xl border-t-4 border-purple-500 shadow-sm">
                <div class="flex items-center justify-between mb-4">
                    <div>
                        <p class="text-sm font-medium text-slate-500 mb-1">Ø­Ù‚ÙˆÙ‚ Ø§Ù„Ù…Ù„ÙƒÙŠØ©</p>
                        <h3 id="equityCount" class="text-2xl font-bold text-slate-800">
                             <div class="animate-pulse h-8 w-24 bg-slate-200 rounded"></div>
                        </h3>
                    </div>
                    <div class="p-3 bg-purple-50 rounded-lg">
                        <i class="fas fa-hand-holding-usd text-xl text-purple-600"></i>
                    </div>
                </div>
            </div>

            <div class="stat-card p-6 rounded-xl border-t-4 border-cyan-500 shadow-sm">
                <div class="flex items-center justify-between mb-4">
                    <div>
                        <p class="text-sm font-medium text-slate-500 mb-1">Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª/Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª</p>
                        <h3 id="incomeExpenseCount" class="text-2xl font-bold text-slate-800">
                             <div class="animate-pulse h-8 w-24 bg-slate-200 rounded"></div>
                        </h3>
                    </div>
                    <div class="p-3 bg-cyan-50 rounded-lg">
                        <i class="fas fa-chart-line text-xl text-cyan-600"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filters -->
        <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 mb-8">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div>
                    <label class="block text-sm font-bold text-slate-700 mb-2">Ø§Ù„ÙƒÙŠØ§Ù†</label>
                    <input id="entityIdInput" type="text" placeholder="Ù…Ø«Ø§Ù„: HQ001" class="w-full border border-slate-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 outline-none">
                </div>
                <div>
                    <label class="block text-sm font-bold text-slate-700 mb-2">Ø¨Ø­Ø«</label>
                    <input id="searchInput" type="text" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„ÙƒÙˆØ¯ Ø£Ùˆ Ø§Ù„Ø§Ø³Ù…" class="w-full border border-slate-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 outline-none" oninput="applyFilters()">
                </div>
                <div>
                    <label class="block text-sm font-bold text-slate-700 mb-2">Ù†ÙˆØ¹ Ø§Ù„Ø­Ø³Ø§Ø¨</label>
                    <select id="typeFilter" class="w-full border border-slate-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 outline-none" onchange="applyFilters()">
                        <option value="">ÙƒÙ„ Ø§Ù„Ø£Ù†ÙˆØ§Ø¹</option>
                        <option value="ASSET">Ø§Ù„Ø£ØµÙˆÙ„</option>
                        <option value="LIABILITY">Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª</option>
                        <option value="EQUITY">Ø­Ù‚ÙˆÙ‚ Ø§Ù„Ù…Ù„ÙƒÙŠØ©</option>
                        <option value="REVENUE">Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª</option>
                        <option value="EXPENSE">Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-bold text-slate-700 mb-2">Ø§Ù„Ø­Ø§Ù„Ø©</label>
                    <select id="statusFilter" class="w-full border border-slate-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 outline-none" onchange="applyFilters()">
                        <option value="">Ø§Ù„ÙƒÙ„</option>
                        <option value="active">Ù†Ø´Ø·</option>
                        <option value="inactive">ØºÙŠØ± Ù†Ø´Ø·</option>
                    </select>
                </div>
            </div>
            <div class="mt-4 flex gap-2">
                <button id="applyFiltersBtn" onclick="applyFilters(true)" class="bg-slate-800 text-white px-4 py-2 rounded-lg font-bold hover:bg-slate-900 transition">ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
                <button onclick="resetFilters()" class="bg-slate-100 text-slate-800 px-4 py-2 rounded-lg font-bold hover:bg-slate-200 transition">Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†</button>
            </div>
        </div>

        <!-- Accounts Table -->
        <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
            <div class="p-0">
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-slate-50 text-slate-600 text-sm border-b border-slate-200">
                            <tr>
                                <th class="px-4 py-3 text-right">Ø±Ù…Ø² Ø§Ù„Ø­Ø³Ø§Ø¨</th>
                                <th class="px-4 py-3 text-right">Ø§Ø³Ù… Ø§Ù„Ø­Ø³Ø§Ø¨</th>
                                <th class="px-4 py-3 text-right">Ù†ÙˆØ¹ Ø§Ù„Ø­Ø³Ø§Ø¨</th>
                                <th class="px-4 py-3 text-right">Ù…Ø¯ÙŠÙ†</th>
                                <th class="px-4 py-3 text-right">Ø¯Ø§Ø¦Ù†</th>
                                <th class="px-4 py-3 text-right">Ø§Ù„Ø±ØµÙŠØ¯</th>
                                <th class="px-4 py-3 text-right">Ø§Ù„Ø­Ø§Ù„Ø©</th>
                                <th class="px-4 py-3 text-right">Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                            </tr>
                        </thead>
                        <tbody id="accountsTable" class="text-sm divide-y divide-gray-100">
                            <tr>
                                <td colspan="8" class="px-4 py-12 text-center text-gray-500">
                                    <i class="fas fa-spinner fa-spin text-4xl mb-3 opacity-30"></i>
                                    <div>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª...</div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div class="p-4 border-t border-slate-200 text-sm text-slate-600" id="tableCount"></div>
            </div>
        </div>
    </div>

    <!-- Account Modal -->
    <div id="accountModal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/40">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-3xl mx-4 max-h-[90vh] flex flex-col">
            <div class="flex items-center justify-between px-6 py-4 border-b">
                <h3 id="accountModalTitle" class="text-lg font-bold text-gray-800">Ø¥Ø¶Ø§ÙØ© Ø­Ø³Ø§Ø¨</h3>
                <button onclick="closeAccountModal()" class="text-gray-400 hover:text-gray-700">
                    <i class="fas fa-xmark text-xl"></i>
                </button>
            </div>
            <div class="p-6 space-y-6 overflow-y-auto">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm text-slate-700 mb-1">Ø±Ù…Ø² Ø§Ù„Ø­Ø³Ø§Ø¨</label>
                        <input id="accountCode" type="text" class="w-full border rounded-lg px-3 py-2" placeholder="Ù…Ø«Ø§Ù„: 4000">
                    </div>
                    <div>
                        <label class="block text-sm text-slate-700 mb-1">Ø§Ø³Ù… Ø§Ù„Ø­Ø³Ø§Ø¨ (Ø¹Ø±Ø¨ÙŠ)</label>
                        <input id="accountNameAr" type="text" class="w-full border rounded-lg px-3 py-2" placeholder="Ø§Ø³Ù… Ø§Ù„Ø­Ø³Ø§Ø¨">
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm text-slate-700 mb-1">Ø§Ø³Ù… Ø§Ù„Ø­Ø³Ø§Ø¨ (English)</label>
                        <input id="accountNameEn" type="text" class="w-full border rounded-lg px-3 py-2" placeholder="Account Name">
                    </div>
                    <div>
                        <label class="block text-sm text-slate-700 mb-1">Ù†ÙˆØ¹ Ø§Ù„Ø­Ø³Ø§Ø¨</label>
                        <select id="accountType" class="w-full border rounded-lg px-3 py-2">
                            <option value="ASSET">Ø£ØµÙˆÙ„</option>
                            <option value="LIABILITY">Ø§Ù„ØªØ²Ø§Ù…Ø§Øª</option>
                            <option value="EQUITY">Ø­Ù‚ÙˆÙ‚ Ù…Ù„ÙƒÙŠØ©</option>
                            <option value="REVENUE">Ø¥ÙŠØ±Ø§Ø¯Ø§Øª</option>
                            <option value="EXPENSE">Ù…ØµØ±ÙˆÙØ§Øª</option>
                        </select>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm text-slate-700 mb-1">Ø·Ø¨ÙŠØ¹Ø© Ø§Ù„Ø±ØµÙŠØ¯</label>
                        <select id="normalBalance" class="w-full border rounded-lg px-3 py-2">
                            <option value="">ØªÙ„Ù‚Ø§Ø¦ÙŠ</option>
                            <option value="DEBIT">Ù…Ø¯ÙŠÙ†</option>
                            <option value="CREDIT">Ø¯Ø§Ø¦Ù†</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm text-slate-700 mb-1">Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø­Ø³Ø§Ø¨</label>
                        <input id="accountLevel" type="number" min="1" class="w-full border rounded-lg px-3 py-2" value="1">
                    </div>
                    <div>
                        <label class="block text-sm text-slate-700 mb-1">Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ</label>
                        <select id="parentAccount" class="w-full border rounded-lg px-3 py-2">
                            <option value="">Ø¨Ø¯ÙˆÙ†</option>
                        </select>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="flex items-center gap-2">
                        <input id="accountActive" type="checkbox" class="h-4 w-4" checked>
                        <label class="text-sm text-slate-700">Ù†Ø´Ø·</label>
                    </div>
                    <div class="flex items-center gap-2">
                        <input id="accountHeader" type="checkbox" class="h-4 w-4">
                        <label class="text-sm text-slate-700">Ø­Ø³Ø§Ø¨ Ø±Ø¦ÙŠØ³ÙŠ</label>
                    </div>
                </div>
                <div>
                    <label class="block text-sm text-slate-700 mb-1">Ø§Ù„ÙˆØµÙ</label>
                    <textarea id="accountDescription" class="w-full border rounded-lg px-3 py-2" rows="2"></textarea>
                </div>
                <div>
                    <label class="block text-sm text-slate-700 mb-1">Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label>
                    <textarea id="accountNotes" class="w-full border rounded-lg px-3 py-2" rows="2"></textarea>
                </div>
            </div>
            <div class="p-5 border-t flex items-center justify-end gap-2">
                <button onclick="closeAccountModal()" class="px-4 py-2 rounded-lg border">Ø¥Ù„ØºØ§Ø¡</button>
                <button id="accountModalSave" onclick="submitAccount()" class="px-4 py-2 rounded-lg bg-blue-600 text-white">Ø­ÙØ¸</button>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = window.location.origin;
        const ENTITY_ID = '1';
        let currentEntityId = localStorage.getItem('coa_entity_id') || ENTITY_ID;
        let allAccounts = [];
        let modalMode = 'create';
        let editingAccountId = null;

        async function loadAccounts() {
            try {
            const response = await fetch(`${API_BASE}/finance/chart-of-accounts?entity_id=${encodeURIComponent(currentEntityId)}`);
                const data = await response.json();

                if (!data.success) {
                    throw new Error(data.error || 'Failed to load accounts');
                }

                allAccounts = data.accounts || [];
                populateParentAccounts();
                renderSummary(data.summary || {});
                renderTable(allAccounts);
            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª:', error);
                document.getElementById('accountsTable').innerHTML = `
                    <tr>
                        <td colspan="8" class="px-4 py-12 text-center text-red-500">
                            <i class="fas fa-exclamation-triangle text-4xl mb-3"></i>
                            <div>ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª</div>
                        </td>
                    </tr>
                `;
            }
        }

        function renderSummary(summary) {
            document.getElementById('totalAccounts').textContent = summary.total_accounts ?? '0';
            document.getElementById('assetCount').textContent = summary.asset_accounts ?? '0';
            document.getElementById('liabilityCount').textContent = summary.liability_accounts ?? '0';
            document.getElementById('equityCount').textContent = summary.equity_accounts ?? '0';
            const incomeExpense = (summary.revenue_accounts || 0) + (summary.expense_accounts || 0);
            document.getElementById('incomeExpenseCount').textContent = incomeExpense;
        }

        function renderTable(accounts) {
            const rows = accounts.map(acc => {
                const statusBadge = acc.is_active
                    ? '<span class="px-2 py-1 rounded-full text-xs font-bold bg-green-100 text-green-700">Ù†Ø´Ø·</span>'
                    : '<span class="px-2 py-1 rounded-full text-xs font-bold bg-slate-100 text-slate-700">ØºÙŠØ± Ù†Ø´Ø·</span>';

                return `
                    <tr class="hover:bg-slate-50 border-b border-slate-100 last:border-0">
                        <td class="px-4 py-3 font-mono text-slate-600">${acc.account_code}</td>
                        <td class="px-4 py-3 font-medium text-slate-900">${acc.account_name_ar || '-'}</td>
                        <td class="px-4 py-3">
                            <span class="px-2 py-1 rounded text-xs font-bold bg-blue-100 text-blue-700">${translateType(acc.account_type)}</span>
                        </td>
                        <td class="px-4 py-3 font-bold text-red-600">${formatMoney(acc.total_debit)}</td>
                        <td class="px-4 py-3 font-bold text-green-600">${formatMoney(acc.total_credit)}</td>
                        <td class="px-4 py-3 font-bold text-slate-700">${formatMoney(acc.balance)}</td>
                        <td class="px-4 py-3">${statusBadge}</td>
                        <td class="px-4 py-3">
                            <div class="flex gap-2">
                                <button onclick="openAccountModal('view', ${acc.account_id})" class="text-blue-600 hover:text-blue-800">Ù…Ø¹Ø§ÙŠÙ†Ø©</button>
                                <button onclick="openAccountModal('edit', ${acc.account_id})" class="text-amber-600 hover:text-amber-800">ØªØ¹Ø¯ÙŠÙ„</button>
                                <button onclick="deleteAccount(${acc.account_id})" class="text-red-600 hover:text-red-800">Ø­Ø°Ù</button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');

            document.getElementById('accountsTable').innerHTML = rows.length ? rows : `
                <tr>
                    <td colspan="8" class="px-4 py-12 text-center text-slate-500">
                        Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø³Ø§Ø¨Ø§Øª
                    </td>
                </tr>
            `;
            document.getElementById('tableCount').textContent = `Ø¹Ø¯Ø¯ Ø§Ù„ØµÙÙˆÙ Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶Ø©: ${accounts.length}`;
        }

        function applyFilters(refresh = false) {
            const search = document.getElementById('searchInput').value.trim().toLowerCase();
            const type = document.getElementById('typeFilter').value;
            const status = document.getElementById('statusFilter').value;
            const entityInput = document.getElementById('entityIdInput');
            if (refresh && entityInput) {
                currentEntityId = (entityInput.value || '').trim() || ENTITY_ID;
                localStorage.setItem('coa_entity_id', currentEntityId);
                loadAccounts();
                return;
            }

            const filtered = allAccounts.filter(acc => {
                const matchesSearch = !search ||
                    (acc.account_code || '').toLowerCase().includes(search) ||
                    (acc.account_name_ar || '').toLowerCase().includes(search);

                const matchesType = !type || acc.account_type === type;
                const matchesStatus = !status || (status === 'active' ? acc.is_active : !acc.is_active);

                return matchesSearch && matchesType && matchesStatus;
            });

            renderTable(filtered);
        }

        function resetFilters() {
            currentEntityId = ENTITY_ID;
            const entityInput = document.getElementById('entityIdInput');
            if (entityInput) entityInput.value = ENTITY_ID;
            document.getElementById('searchInput').value = '';
            document.getElementById('typeFilter').value = '';
            document.getElementById('statusFilter').value = '';
            localStorage.setItem('coa_entity_id', currentEntityId);
            loadAccounts();
        }

        function translateType(type) {
            const types = {
                'ASSET': 'Ø£ØµÙˆÙ„',
                'LIABILITY': 'Ø§Ù„ØªØ²Ø§Ù…Ø§Øª',
                'EQUITY': 'Ø­Ù‚ÙˆÙ‚ Ù…Ù„ÙƒÙŠØ©',
                'REVENUE': 'Ø¥ÙŠØ±Ø§Ø¯Ø§Øª',
                'EXPENSE': 'Ù…ØµØ±ÙˆÙØ§Øª'
            };
            return types[type] || type;
        }

        function formatMoney(value) {
            const num = parseFloat(value || 0);
            return num.toLocaleString('ar-SA') + ' Ø±.Ø³';
        }

        function downloadCSV() {
            if (!allAccounts.length) return;
            const rows = [
                ['Ø±Ù…Ø² Ø§Ù„Ø­Ø³Ø§Ø¨', 'Ø§Ø³Ù… Ø§Ù„Ø­Ø³Ø§Ø¨', 'Ù†ÙˆØ¹ Ø§Ù„Ø­Ø³Ø§Ø¨', 'Ù…Ø¯ÙŠÙ†', 'Ø¯Ø§Ø¦Ù†', 'Ø§Ù„Ø±ØµÙŠØ¯', 'Ø§Ù„Ø­Ø§Ù„Ø©']
            ];

            allAccounts.forEach(acc => {
                rows.push([
                    acc.account_code,
                    acc.account_name_ar,
                    translateType(acc.account_type),
                    acc.total_debit,
                    acc.total_credit,
                    acc.balance,
                    acc.is_active ? 'Ù†Ø´Ø·' : 'ØºÙŠØ± Ù†Ø´Ø·'
                ]);
            });

            const csvContent = rows.map(r => r.map(v => `"${v ?? ''}"`).join(',')).join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'chart-of-accounts.csv';
            link.click();
            URL.revokeObjectURL(url);
        }

        function downloadJSON() {
            if (!allAccounts.length) return;
            const blob = new Blob([JSON.stringify(allAccounts, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'chart-of-accounts.json';
            link.click();
            URL.revokeObjectURL(url);
        }

        function printAccounts() {
            window.print();
        }

        function populateParentAccounts() {
            const select = document.getElementById('parentAccount');
            if (!select) return;
            const options = ['<option value="">Ø¨Ø¯ÙˆÙ†</option>'];
            allAccounts
                .filter(acc => acc.is_header)
                .forEach(acc => {
                    options.push(`<option value="${acc.account_id}">${acc.account_code} - ${acc.account_name_ar}</option>`);
                });
            select.innerHTML = options.join('');
        }

        function openAccountModal(mode, accountId = null) {
            modalMode = mode;
            editingAccountId = accountId;
            const modal = document.getElementById('accountModal');
            const title = document.getElementById('accountModalTitle');
            const saveButton = document.getElementById('accountModalSave');

            title.textContent = mode === 'view' ? 'Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø­Ø³Ø§Ø¨' : mode === 'edit' ? 'ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨' : 'Ø¥Ø¶Ø§ÙØ© Ø­Ø³Ø§Ø¨';
            saveButton.textContent = mode === 'edit' ? 'Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„' : 'Ø­ÙØ¸ Ø§Ù„Ø­Ø³Ø§Ø¨';
            saveButton.classList.toggle('hidden', mode === 'view');

            resetAccountForm();
            setAccountFormDisabled(mode === 'view');

            if (mode !== 'create' && accountId) {
                fetchAccountDetails(accountId)
                    .then(account => {
                        fillAccountForm(account);
                        modal.classList.remove('hidden');
                        modal.classList.add('flex');
                    })
                    .catch(error => {
                        alert(error.message || 'ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨');
                    });
                return;
            }

            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        function closeAccountModal() {
            const modal = document.getElementById('accountModal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }

        function resetAccountForm() {
            document.getElementById('accountCode').value = '';
            document.getElementById('accountNameAr').value = '';
            document.getElementById('accountNameEn').value = '';
            document.getElementById('accountType').value = 'ASSET';
            document.getElementById('normalBalance').value = '';
            document.getElementById('accountLevel').value = 1;
            document.getElementById('parentAccount').value = '';
            document.getElementById('accountActive').checked = true;
            document.getElementById('accountHeader').checked = false;
            document.getElementById('accountDescription').value = '';
            document.getElementById('accountNotes').value = '';
        }

        function fillAccountForm(account) {
            document.getElementById('accountCode').value = account.account_code || '';
            document.getElementById('accountNameAr').value = account.account_name_ar || '';
            document.getElementById('accountNameEn').value = account.account_name_en || '';
            document.getElementById('accountType').value = account.account_type || 'ASSET';
            document.getElementById('normalBalance').value = account.normal_balance || '';
            document.getElementById('accountLevel').value = account.level || 1;
            document.getElementById('parentAccount').value = account.parent_account_id || '';
            document.getElementById('accountActive').checked = Boolean(account.is_active);
            document.getElementById('accountHeader').checked = Boolean(account.is_header);
            document.getElementById('accountDescription').value = account.description || '';
            document.getElementById('accountNotes').value = account.notes || '';
        }

        function setAccountFormDisabled(disabled) {
            [
                'accountCode',
                'accountNameAr',
                'accountNameEn',
                'accountType',
                'normalBalance',
                'accountLevel',
                'parentAccount',
                'accountActive',
                'accountHeader',
                'accountDescription',
                'accountNotes'
            ].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.disabled = disabled;
            });
        }

        async function fetchAccountDetails(accountId) {
            const response = await fetch(`${API_BASE}/finance/chart-of-accounts/${accountId}?entity_id=${encodeURIComponent(currentEntityId)}`);
            const data = await response.json();
            if (!data.success) {
                throw new Error(data.error || 'ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨');
            }
            return data.account;
        }

        async function submitAccount() {
            const payload = {
                entity_id: currentEntityId,
                account_code: document.getElementById('accountCode').value.trim(),
                account_name_ar: document.getElementById('accountNameAr').value.trim(),
                account_name_en: document.getElementById('accountNameEn').value.trim(),
                account_type: document.getElementById('accountType').value,
                parent_account_id: document.getElementById('parentAccount').value || null,
                level: parseInt(document.getElementById('accountLevel').value || 1, 10),
                is_active: document.getElementById('accountActive').checked,
                is_header: document.getElementById('accountHeader').checked,
                normal_balance: document.getElementById('normalBalance').value || null,
                description: document.getElementById('accountDescription').value.trim(),
                notes: document.getElementById('accountNotes').value.trim()
            };

            if (!payload.account_code || !payload.account_name_ar || !payload.account_type) {
                alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù…Ø² Ø§Ù„Ø­Ø³Ø§Ø¨ ÙˆØ§Ø³Ù… Ø§Ù„Ø­Ø³Ø§Ø¨ ÙˆÙ†ÙˆØ¹ Ø§Ù„Ø­Ø³Ø§Ø¨');
                return;
            }

            try {
                const url = modalMode === 'edit'
                    ? `${API_BASE}/finance/chart-of-accounts/${editingAccountId}`
                    : `${API_BASE}/finance/chart-of-accounts`;
                const method = modalMode === 'edit' ? 'PUT' : 'POST';

                const response = await fetch(url, {
                    method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const data = await response.json();
                if (!data.success) {
                    throw new Error(data.error || 'ØªØ¹Ø°Ø± Ø­ÙØ¸ Ø§Ù„Ø­Ø³Ø§Ø¨');
                }

                closeAccountModal();
                await loadAccounts();
                alert(modalMode === 'edit' ? 'ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨' : 'ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø­Ø³Ø§Ø¨');
            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø­Ø³Ø§Ø¨:', error);
                alert(error.message || 'ØªØ¹Ø°Ø± Ø­ÙØ¸ Ø§Ù„Ø­Ø³Ø§Ø¨');
            }
        }

        async function deleteAccount(accountId) {
            if (!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø­Ø³Ø§Ø¨ØŸ')) return;
            try {
                const response = await fetch(`${API_BASE}/finance/chart-of-accounts/${accountId}?entity_id=${encodeURIComponent(currentEntityId)}`, {
                    method: 'DELETE'
                });
                const data = await response.json();
                if (!data.success) {
                    throw new Error(data.error || 'ØªØ¹Ø°Ø± Ø­Ø°Ù Ø§Ù„Ø­Ø³Ø§Ø¨');
                }
                await loadAccounts();
            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ø­Ø³Ø§Ø¨:', error);
                alert(error.message || 'ØªØ¹Ø°Ø± Ø­Ø°Ù Ø§Ù„Ø­Ø³Ø§Ø¨');
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            const entityInput = document.getElementById('entityIdInput');
            if (entityInput) entityInput.value = currentEntityId;
            loadAccounts();
        });
    </script>
</body>
</html>
