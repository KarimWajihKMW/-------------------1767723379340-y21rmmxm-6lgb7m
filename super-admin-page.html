<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Super Admin - إدارة الأدوار والصلاحيات</title>
    
    <!-- External Resources -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Cairo', 'sans-serif'],
                    },
                    colors: {
                        brand: {
                            50: '#fff5f5',  // 255 245 245
                            100: '#fde1e1', // 253 225 225
                            200: '#fca5a5', // Estimated
                            300: '#e55050', // Mapped to 400 from style.css for better gradient
                            400: '#e55050', // 229 80 80
                            500: '#bb1226', // 187 18 38
                            600: '#990e1e', // 153 14 30
                            700: '#7a0b16', // primary-red-dark
                            800: '#59060f', // 89 6 15
                            900: '#340309', // 52 3 9
                        }
                    }
                }
            }
        }
    </script>

    <style>
        body {
            font-family: 'Cairo', sans-serif;
            background-color: #f8fafc;
        }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f5f9; 
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8; 
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.3s ease-in-out;
        }
        .tab-content.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .modal {
            transition: opacity 0.3s ease;
            opacity: 0;
            pointer-events: none;
        }
        .modal.active {
            opacity: 1;
            pointer-events: auto;
        }
        
        .glass-effect {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 antialiased min-h-screen">

    <!-- Navbar -->
    <nav class="bg-white shadow-sm border-b border-slate-200 sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center gap-3">
                    <div class="bg-brand-600 text-white p-2 rounded-lg shadow-lg shadow-brand-200">
                        <i class="fas fa-shield-alt text-xl"></i>
                    </div>
                    <div>
                        <h1 class="text-xl font-bold text-slate-800">Super Admin</h1>
                        <p class="text-xs text-slate-500">نظام التحكم الكامل والصلاحيات</p>
                    </div>
                </div>
                <div class="flex items-center gap-4">
                    <div class="hidden md:flex items-center gap-2 text-sm text-slate-600 bg-slate-100 px-3 py-1 rounded-full">
                        <i class="fas fa-user-circle"></i>
                        <span>المسؤول العام</span>
                    </div>
                    <a href="index.html" class="text-slate-500 hover:text-brand-600 transition-colors">
                        <i class="fas fa-home text-lg"></i>
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        
        <!-- Stats Cards -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <!-- Roles Stat -->
            <div class="bg-white rounded-xl shadow-sm border border-slate-100 p-6 flex items-center justify-between hover:shadow-md transition-shadow">
                <div>
                    <p class="text-sm font-medium text-slate-500 mb-1">إجمالي الأدوار</p>
                    <h3 class="text-3xl font-bold text-brand-600" id="totalRoles">0</h3>
                </div>
                <div class="w-12 h-12 bg-brand-50 rounded-lg flex items-center justify-center text-brand-600">
                    <i class="fas fa-id-badge text-xl"></i>
                </div>
            </div>
            
            <!-- Systems Stat -->
            <div class="bg-white rounded-xl shadow-sm border border-slate-100 p-6 flex items-center justify-between hover:shadow-md transition-shadow">
                <div>
                    <p class="text-sm font-medium text-slate-500 mb-1">الأنظمة التشغيلية</p>
                    <h3 class="text-3xl font-bold text-blue-600" id="totalSystems">8</h3>
                </div>
                <div class="w-12 h-12 bg-blue-50 rounded-lg flex items-center justify-center text-blue-600">
                    <i class="fas fa-server text-xl"></i>
                </div>
            </div>
            
            <!-- Permissions Stat -->
            <div class="bg-white rounded-xl shadow-sm border border-slate-100 p-6 flex items-center justify-between hover:shadow-md transition-shadow">
                <div>
                    <p class="text-sm font-medium text-slate-500 mb-1">الصلاحيات النشطة</p>
                    <h3 class="text-3xl font-bold text-emerald-600" id="totalPermissions">0</h3>
                </div>
                <div class="w-12 h-12 bg-emerald-50 rounded-lg flex items-center justify-center text-emerald-600">
                    <i class="fas fa-key text-xl"></i>
                </div>
            </div>
            
            <!-- Users Stat -->
            <div class="bg-white rounded-xl shadow-sm border border-slate-100 p-6 flex items-center justify-between hover:shadow-md transition-shadow">
                <div>
                    <p class="text-sm font-medium text-slate-500 mb-1">المستخدمين</p>
                    <h3 class="text-3xl font-bold text-violet-600" id="totalUsers">0</h3>
                </div>
                <div class="w-12 h-12 bg-violet-50 rounded-lg flex items-center justify-center text-violet-600">
                    <i class="fas fa-users text-xl"></i>
                </div>
            </div>
        </div>

        <!-- Navigation Tabs -->
        <div class="bg-white rounded-xl shadow-sm border border-slate-100 mb-6 overflow-hidden">
            <div class="flex border-b border-slate-100 overflow-x-auto">
                <button class="tab active px-6 py-4 text-sm font-bold text-brand-600 border-b-2 border-brand-600 hover:bg-slate-50 flex items-center gap-2 transition-all whitespace-nowrap" onclick="switchTab('roles', this)">
                    <i class="fas fa-clipboard-list"></i> إدارة الأدوار
                </button>
                <button class="tab px-6 py-4 text-sm font-medium text-slate-500 hover:text-brand-600 hover:bg-slate-50 flex items-center gap-2 transition-all whitespace-nowrap" onclick="switchTab('permissions', this)">
                    <i class="fas fa-lock"></i> الصلاحيات
                </button>
                <button class="tab px-6 py-4 text-sm font-medium text-slate-500 hover:text-brand-600 hover:bg-slate-50 flex items-center gap-2 transition-all whitespace-nowrap" onclick="switchTab('users', this)">
                    <i class="fas fa-user-tag"></i> تعيين الأدوار
                </button>
                <button class="tab px-6 py-4 text-sm font-medium text-slate-500 hover:text-brand-600 hover:bg-slate-50 flex items-center gap-2 transition-all whitespace-nowrap" onclick="switchTab('audit', this)">
                    <i class="fas fa-history"></i> سجل العمليات
                </button>
            </div>
        </div>

        <!-- Tab 1: Roles Management -->
        <div id="rolesTab" class="tab-content active">
            <div class="bg-white rounded-xl shadow-sm border border-slate-100 overflow-hidden">
                <div class="p-6 border-b border-slate-100 flex flex-col md:flex-row justify-between items-center gap-4">
                    <div class="relative w-full md:w-96">
                        <input type="text" id="roleSearch" placeholder="بحث عن دور..." onkeyup="filterRoles()"
                            class="w-full pl-4 pr-10 py-2 rounded-lg border border-slate-200 focus:border-brand-500 focus:ring-1 focus:ring-brand-500 transition-colors">
                        <i class="fas fa-search absolute left-3 top-3 text-slate-400"></i>
                    </div>
                    <button onclick="showCreateRoleModal()" class="w-full md:w-auto bg-brand-600 hover:bg-brand-700 text-white px-6 py-2 rounded-lg shadow-md shadow-brand-200 transition-all flex items-center justify-center gap-2">
                        <i class="fas fa-plus"></i> إضافة دور جديد
                    </button>
                </div>
                
                <div class="overflow-x-auto">
                    <div id="rolesLoading" class="p-12 text-center text-slate-500">
                        <i class="fas fa-circle-notch fa-spin text-3xl mb-3 text-brand-500"></i>
                        <p>جاري تحميل البيانات...</p>
                    </div>
                    
                    <div id="rolesError" class="hidden m-6 p-4 bg-red-50 text-red-700 rounded-lg border border-red-100 flex items-center gap-3">
                        <i class="fas fa-exclamation-circle text-xl"></i>
                        <span id="rolesErrorMessage">حدث خطأ</span>
                    </div>

                    <table id="rolesTable" class="w-full hidden">
                        <thead class="bg-slate-50 text-slate-600 text-sm border-b border-slate-100">
                            <tr>
                                <th class="py-4 px-6 text-right font-semibold">الكود</th>
                                <th class="py-4 px-6 text-right font-semibold">المسمى الوظيفي</th>
                                <th class="py-4 px-6 text-right font-semibold">المستوى</th>
                                <th class="py-4 px-6 text-right font-semibold">حد الموافقة</th>
                                <th class="py-4 px-6 text-center font-semibold">المستخدمين</th>
                                <th class="py-4 px-6 text-center font-semibold">الأنظمة</th>
                                <th class="py-4 px-6 text-center font-semibold">الحالة</th>
                                <th class="py-4 px-6 text-center font-semibold">الإجراءات</th>
                            </tr>
                        </thead>
                        <tbody id="rolesTableBody" class="divide-y divide-slate-100 text-sm text-slate-700">
                            <!-- Roles populated via JS -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Tab 2: Permissions Matrix -->
        <div id="permissionsTab" class="tab-content">
            <div class="bg-white rounded-xl shadow-sm border border-slate-100 p-6">
                <div class="max-w-3xl mx-auto">
                    <div class="text-center mb-8">
                        <h2 class="text-2xl font-bold text-slate-800 mb-2">مصفوفة الصلاحيات</h2>
                        <p class="text-slate-500">تحكم دقيق في صلاحيات الوصول لكل نظام</p>
                    </div>

                    <div class="bg-slate-50 p-6 rounded-xl border border-slate-100 mb-8">
                        <label class="block text-sm font-semibold text-slate-700 mb-2">اختر الدور لتعديل صلاحياته</label>
                        <select id="permissionRoleSelect" onchange="loadRolePermissions()" 
                            class="w-full p-3 rounded-lg border border-slate-200 focus:border-brand-500 focus:ring-1 focus:ring-brand-500 bg-white">
                            <option value="">-- اختر دوراً --</option>
                        </select>
                    </div>

                    <div id="permissionsLoading" class="hidden text-center py-12">
                        <i class="fas fa-circle-notch fa-spin text-3xl text-brand-500 mb-3"></i>
                        <p class="text-slate-500">جاري جلب الصلاحيات...</p>
                    </div>

                    <div id="permissionsContent" class="hidden">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-8" id="permissionsGrid">
                            <!-- Permissions populated here -->
                        </div>
                        
                        <div class="flex justify-end pt-6 border-t border-slate-100">
                            <button onclick="savePermissions()" class="bg-brand-600 hover:bg-brand-700 text-white px-8 py-3 rounded-lg shadow-lg shadow-brand-200 transition-all flex items-center gap-2">
                                <i class="fas fa-save"></i> حفظ التغييرات
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab 3: Assign Users -->
        <div id="usersTab" class="tab-content">
            <div class="bg-white rounded-xl shadow-sm border border-slate-100 p-6">
                <div class="max-w-2xl mx-auto">
                    <div class="text-center mb-8">
                        <h2 class="text-2xl font-bold text-slate-800 mb-2">تعيين الأدوار</h2>
                        <p class="text-slate-500">إدارة وصول المستخدمين للأدوار المختلفة</p>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <div>
                            <label class="block text-sm font-semibold text-slate-700 mb-2">معرف المستخدم</label>
                            <div class="flex gap-2">
                                <input type="number" id="userIdInput" placeholder="ID" onblur="fetchUserInfo()"
                                    class="w-full p-3 rounded-lg border border-slate-200 focus:border-brand-500 focus:ring-1 focus:ring-brand-500">
                                <button onclick="fetchUserInfo()" class="bg-slate-100 hover:bg-slate-200 text-slate-600 px-4 rounded-lg transition-colors">
                                    <i class="fas fa-search"></i>
                                </button>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-slate-700 mb-2">الدور الجديد</label>
                            <select id="userRoleSelect" class="w-full p-3 rounded-lg border border-slate-200 focus:border-brand-500 focus:ring-1 focus:ring-brand-500">
                                <option value="">-- اختر دوراً --</option>
                            </select>
                        </div>
                    </div>

                    <div id="userInfoDisplay" class="hidden bg-blue-50 border border-blue-100 rounded-xl p-6 mb-6">
                        <h3 class="font-bold text-blue-800 mb-4 flex items-center gap-2">
                            <i class="fas fa-info-circle"></i> معلومات المستخدم
                        </h3>
                        <div class="grid grid-cols-2 gap-4 text-sm">
                            <div><span class="text-blue-500 block text-xs">الاسم</span> <span id="displayUserName" class="font-medium text-slate-700">-</span></div>
                            <div><span class="text-blue-500 block text-xs">البريد</span> <span id="displayUserEmail" class="font-medium text-slate-700">-</span></div>
                            <div><span class="text-blue-500 block text-xs">الجهة</span> <span id="displayUserEntity" class="font-medium text-slate-700">-</span></div>
                            <div><span class="text-blue-500 block text-xs">الحالة</span> <span id="displayUserStatus" class="font-medium text-slate-700">-</span></div>
                            <div class="col-span-2 border-t border-blue-100 pt-3 mt-1">
                                <span class="text-blue-500 block text-xs">الدور الحالي</span> 
                                <span id="displayUserRole" class="font-bold text-brand-600 text-lg">-</span>
                            </div>
                        </div>
                    </div>

                    <div class="flex gap-4">
                        <button onclick="assignRole()" class="flex-1 bg-green-600 hover:bg-green-700 text-white py-3 rounded-lg shadow-md transition-colors font-semibold">
                            <i class="fas fa-check-circle ml-2"></i> تعيين الدور
                        </button>
                        <button onclick="revokeRole()" class="flex-1 bg-white border border-red-200 text-red-600 hover:bg-red-50 py-3 rounded-lg transition-colors font-semibold">
                            <i class="fas fa-ban ml-2"></i> إلغاء الدور
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab 4: Audit Log -->
        <div id="auditTab" class="tab-content">
            <div class="bg-white rounded-xl shadow-sm border border-slate-100 overflow-hidden">
                <div class="p-6 border-b border-slate-100">
                    <h2 class="text-xl font-bold text-slate-800">سجل العمليات</h2>
                </div>
                
                <div id="auditLoading" class="hidden p-12 text-center text-slate-500">
                    <i class="fas fa-circle-notch fa-spin text-3xl mb-3 text-brand-500"></i>
                    <p>جاري تحميل السجل...</p>
                </div>

                <div class="overflow-x-auto">
                    <table id="auditTable" class="w-full hidden">
                        <thead class="bg-slate-50 text-slate-600 text-sm">
                            <tr>
                                <th class="py-3 px-6 text-right">التاريخ</th>
                                <th class="py-3 px-6 text-right">النوع</th>
                                <th class="py-3 px-6 text-right">المعرف</th>
                                <th class="py-3 px-6 text-right">العملية</th>
                                <th class="py-3 px-6 text-right">نفذ بواسطة</th>
                            </tr>
                        </thead>
                        <tbody id="auditTableBody" class="divide-y divide-slate-100 text-sm text-slate-600"></tbody>
                    </table>
                </div>
            </div>
        </div>
        
    </main>

    <!-- Modals -->
    <!-- Create Role Modal -->
    <div id="createRoleModal" class="modal fixed inset-0 z-50 flex items-center justify-center bg-slate-900/60 backdrop-blur-sm">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl transform transition-all m-4 flex flex-col max-h-[90vh]">
            <div class="p-6 border-b border-slate-100 flex justify-between items-center">
                <h3 class="text-xl font-bold text-slate-800">إنشاء دور جديد</h3>
                <button onclick="closeModal('createRoleModal')" class="text-slate-400 hover:text-red-500 transition-colors">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <div class="p-6 overflow-y-auto custom-scrollbar space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="col-span-1 md:col-span-2">
                        <label class="block text-sm font-medium text-slate-700 mb-1">رمز الدور (Code)</label>
                        <input type="text" id="newRoleCode" placeholder="مثال: HR_MANAGER" 
                            class="w-full px-4 py-2 rounded-lg border border-slate-200 focus:border-brand-500 focus:ring-1 focus:ring-brand-500 uppercase">
                        <p class="text-xs text-slate-500 mt-1">يجب أن يكون بالإنجليزية وحروف كبيرة</p>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">الاسم (عربي)</label>
                        <input type="text" id="newRoleTitleAr" placeholder="مدير الموارد البشرية" 
                            class="w-full px-4 py-2 rounded-lg border border-slate-200 focus:border-brand-500 focus:ring-1 focus:ring-brand-500">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">الاسم (انجليزي)</label>
                        <input type="text" id="newRoleTitleEn" placeholder="HR Manager" 
                            class="w-full px-4 py-2 rounded-lg border border-slate-200 focus:border-brand-500 focus:ring-1 focus:ring-brand-500">
                    </div>

                    <div class="col-span-1 md:col-span-2">
                        <label class="block text-sm font-medium text-slate-700 mb-1">الوصف</label>
                        <textarea id="newRoleDescription" rows="2" 
                            class="w-full px-4 py-2 rounded-lg border border-slate-200 focus:border-brand-500 focus:ring-1 focus:ring-brand-500"></textarea>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">المستوى الهرمي</label>
                        <select id="newRoleHierarchy" class="w-full px-4 py-2 rounded-lg border border-slate-200 focus:border-brand-500 focus:ring-1 focus:ring-brand-500">
                            <option value="0">0 - القيادة العليا</option>
                            <option value="1">1 - الإدارة العليا</option>
                            <option value="2">2 - الإدارة الوسطى</option>
                            <option value="3">3 - الإدارة التنفيذية</option>
                            <option value="4">4 - الموظفين</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">الحد الأقصى للموافقة</label>
                        <input type="number" id="newRoleMaxLimit" value="0" min="0" 
                            class="w-full px-4 py-2 rounded-lg border border-slate-200 focus:border-brand-500 focus:ring-1 focus:ring-brand-500">
                    </div>
                </div>
            </div>
            
            <div class="p-6 border-t border-slate-100 bg-slate-50 rounded-b-2xl flex justify-end gap-3">
                <button onclick="closeModal('createRoleModal')" class="px-5 py-2 text-slate-600 hover:text-slate-800 font-medium">إلغاء</button>
                <button onclick="createRole()" class="bg-brand-600 hover:bg-brand-700 text-white px-6 py-2 rounded-lg shadow-md transition-colors">إنشاء الدور</button>
            </div>
        </div>
    </div>

    <!-- Edit Role Modal -->
    <div id="editRoleModal" class="modal fixed inset-0 z-50 flex items-center justify-center bg-slate-900/60 backdrop-blur-sm">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl transform transition-all m-4 flex flex-col max-h-[90vh]">
            <div class="p-6 border-b border-slate-100 flex justify-between items-center">
                <h3 class="text-xl font-bold text-slate-800">تعديل الدور</h3>
                <button onclick="closeModal('editRoleModal')" class="text-slate-400 hover:text-red-500 transition-colors">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <div class="p-6 overflow-y-auto custom-scrollbar space-y-4">
                <div class="bg-blue-50 p-4 rounded-lg flex items-center gap-3">
                    <div class="bg-blue-100 p-2 rounded text-blue-600 font-bold font-mono text-sm" id="editRoleCodeDisplay">CODE</div>
                    <span class="text-blue-700 text-sm">رمز الدور لا يمكن تغييره</span>
                    <input type="hidden" id="editRoleCode">
                </div>
            
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">الاسم (عربي)</label>
                        <input type="text" id="editRoleTitleAr" class="w-full px-4 py-2 rounded-lg border border-slate-200 focus:border-brand-500">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">الاسم (انجليزي)</label>
                        <input type="text" id="editRoleTitleEn" class="w-full px-4 py-2 rounded-lg border border-slate-200 focus:border-brand-500">
                    </div>

                    <div class="col-span-1 md:col-span-2">
                        <label class="block text-sm font-medium text-slate-700 mb-1">الوصف</label>
                        <textarea id="editRoleDescription" rows="2" class="w-full px-4 py-2 rounded-lg border border-slate-200 focus:border-brand-500"></textarea>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">المستوى الهرمي</label>
                        <select id="editRoleHierarchy" class="w-full px-4 py-2 rounded-lg border border-slate-200 focus:border-brand-500">
                            <option value="0">0 - القيادة العليا</option>
                            <option value="1">1 - الإدارة العليا</option>
                            <option value="2">2 - الإدارة الوسطى</option>
                            <option value="3">3 - الإدارة التنفيذية</option>
                            <option value="4">4 - الموظفين</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">الحالة</label>
                        <select id="editRoleActive" class="w-full px-4 py-2 rounded-lg border border-slate-200 focus:border-brand-500">
                            <option value="true">نشط</option>
                            <option value="false">غير نشط</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">الحد الأدنى</label>
                        <input type="number" id="editRoleMinLimit" class="w-full px-4 py-2 rounded-lg border border-slate-200 focus:border-brand-500">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">الحد الأقصى</label>
                        <input type="number" id="editRoleMaxLimit" class="w-full px-4 py-2 rounded-lg border border-slate-200 focus:border-brand-500">
                    </div>
                </div>
            </div>
            
            <div class="p-6 border-t border-slate-100 bg-slate-50 rounded-b-2xl flex justify-end gap-3">
                <button onclick="closeModal('editRoleModal')" class="px-5 py-2 text-slate-600 hover:text-slate-800 font-medium">إلغاء</button>
                <button onclick="updateRole()" class="bg-brand-600 hover:bg-brand-700 text-white px-6 py-2 rounded-lg shadow-md transition-colors">حفظ التغييرات</button>
            </div>
        </div>
    </div>

    <!-- JavaScript Logic -->
    <script>
        const API_BASE = '/api/admin';
        const USER_ID = 1;

        let rolesData = [];
        let systemsData = [];
        let permissionLevelsData = [];
        let currentRolePermissions = [];

        // Tab Switching Logic
        function switchTab(tabName, btnElement) {
            // UI Update
            document.querySelectorAll('.tab').forEach(t => {
                t.classList.remove('active', 'text-brand-600', 'border-b-2', 'border-brand-600');
                t.classList.add('text-slate-500');
            });
            btnElement.classList.add('active', 'text-brand-600', 'border-b-2', 'border-brand-600');
            btnElement.classList.remove('text-slate-500');

            // Content Update
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(tabName + 'Tab').classList.add('active');

            if (tabName === 'audit') loadAuditLog();
        }

        // Modal Logic
        function openModal(modalId) {
            document.getElementById(modalId).classList.add('active');
        }
        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }
        function showCreateRoleModal() {
            openModal('createRoleModal');
        }

        // Initialization
        window.onload = async function() {
            await loadMetadata();
            await loadRoles();
            populateRoleSelects();
        };

        // Data Loading Functions
        async function loadMetadata() {
            try {
                const response = await fetch(`${API_BASE}/metadata`, { headers: { 'x-user-id': USER_ID } });
                const data = await response.json();
                if (data.success) {
                    systemsData = data.systems;
                    permissionLevelsData = data.permission_levels;
                    document.getElementById('totalSystems').textContent = data.systems.length;
                    
                    // Animate Numbers
                    animateValue("totalSystems", 0, data.systems.length, 1000);
                }
            } catch (error) { console.error('Error loading metadata:', error); }
        }

        async function loadRoles() {
            const loading = document.getElementById('rolesLoading');
            const table = document.getElementById('rolesTable');
            const errorDiv = document.getElementById('rolesError');
            
            loading.classList.remove('hidden');
            table.classList.add('hidden');
            errorDiv.classList.add('hidden');

            try {
                const response = await fetch(`${API_BASE}/roles`, { headers: { 'x-user-id': USER_ID } });
                const data = await response.json();

                if (data.success) {
                    rolesData = data.roles;
                    displayRoles(rolesData);
                    updateStats();
                } else {
                    showRolesError(data.message);
                }
            } catch (error) {
                showRolesError('فشل الاتصال بالخادم');
            } finally {
                loading.classList.add('hidden');
            }
        }

        function showRolesError(msg) {
            const errorDiv = document.getElementById('rolesError');
            document.getElementById('rolesErrorMessage').textContent = msg;
            errorDiv.classList.remove('hidden');
        }

        function displayRoles(roles) {
            const tbody = document.getElementById('rolesTableBody');
            tbody.innerHTML = '';
            
            roles.forEach(role => {
                const limit = role.max_approval_limit ? role.max_approval_limit.toLocaleString() : '∞';
                const statusBadge = role.is_active 
                    ? '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">نشط</span>' 
                    : '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">غير نشط</span>';
                
                const tr = document.createElement('tr');
                tr.className = 'hover:bg-slate-50 transition-colors';
                tr.innerHTML = `
                    <td class="py-4 px-6 text-right font-mono text-xs font-bold text-slate-500">${role.code}</td>
                    <td class="py-4 px-6 text-right font-medium text-slate-800">${role.title_ar}</td>
                    <td class="py-4 px-6 text-right">
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-slate-100 text-slate-800 border border-slate-200">
                            مستوى ${role.hierarchy_level}
                        </span>
                    </td>
                    <td class="py-4 px-6 text-right font-mono text-sm">${limit}</td>
                    <td class="py-4 px-6 text-center">
                        <span class="inline-flex items-center justify-center w-6 h-6 rounded-full bg-blue-50 text-blue-600 text-xs font-bold">${role.users_count || 0}</span>
                    </td>
                    <td class="py-4 px-6 text-center">
                        <span class="inline-flex items-center justify-center w-6 h-6 rounded-full bg-emerald-50 text-emerald-600 text-xs font-bold">${role.systems_count || 0}</span>
                    </td>
                    <td class="py-4 px-6 text-center">${statusBadge}</td>
                    <td class="py-4 px-6 text-center">
                        <div class="flex items-center justify-center gap-2">
                            <button onclick="editRole('${role.code}')" class="text-slate-400 hover:text-brand-600 transition-colors p-1" title="تعديل">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="confirmDeleteRole('${role.code}')" class="text-slate-400 hover:text-red-600 transition-colors p-1" title="حذف">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });
            document.getElementById('rolesTable').classList.remove('hidden');
        }

        // Stats & Filter Logic
        function updateStats() {
            animateValue("totalRoles", 0, rolesData.length, 1000);
            
            const totalUsers = rolesData.reduce((sum, role) => sum + parseInt(role.users_count || 0), 0);
            const totalPerms = rolesData.reduce((sum, role) => sum + parseInt(role.systems_count || 0), 0);
            
            animateValue("totalUsers", 0, totalUsers, 1000);
            animateValue("totalPermissions", 0, totalPerms, 1000);
        }

        function filterRoles() {
            const search = document.getElementById('roleSearch').value.toLowerCase();
            const filtered = rolesData.filter(role => 
                role.code.toLowerCase().includes(search) ||
                role.title_ar.includes(search) ||
                role.title_en.toLowerCase().includes(search)
            );
            displayRoles(filtered);
        }

        // Role Actions
        async function editRole(roleCode) {
            try {
                const response = await fetch(`${API_BASE}/roles/${roleCode}`, { headers: { 'x-user-id': USER_ID } });
                const data = await response.json();
                if (data.success) {
                    const role = data.role;
                    document.getElementById('editRoleCode').value = role.code;
                    document.getElementById('editRoleCodeDisplay').textContent = role.code;
                    document.getElementById('editRoleTitleAr').value = role.title_ar;
                    document.getElementById('editRoleTitleEn').value = role.title_en;
                    document.getElementById('editRoleDescription').value = role.description || '';
                    document.getElementById('editRoleHierarchy').value = role.hierarchy_level;
                    document.getElementById('editRoleActive').value = role.is_active.toString();
                    document.getElementById('editRoleMinLimit').value = role.min_approval_limit || 0;
                    document.getElementById('editRoleMaxLimit').value = role.max_approval_limit || 0;
                    openModal('editRoleModal');
                }
            } catch (error) { alert('خطأ في الاتصال'); }
        }

        async function updateRole() {
            const roleCode = document.getElementById('editRoleCode').value;
            const data = {
                title_ar: document.getElementById('editRoleTitleAr').value,
                title_en: document.getElementById('editRoleTitleEn').value,
                description: document.getElementById('editRoleDescription').value,
                hierarchy_level: parseInt(document.getElementById('editRoleHierarchy').value),
                is_active: document.getElementById('editRoleActive').value === 'true',
                min_approval_limit: parseFloat(document.getElementById('editRoleMinLimit').value) || 0,
                max_approval_limit: parseFloat(document.getElementById('editRoleMaxLimit').value) || 0
            };

            try {
                const response = await fetch(`${API_BASE}/roles/${roleCode}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json', 'x-user-id': USER_ID },
                    body: JSON.stringify(data)
                });
                const result = await response.json();
                if (result.success) {
                    closeModal('editRoleModal');
                    loadRoles();
                    showToast('تم تحديث الدور بنجاح', 'success');
                } else { alert(result.message); }
            } catch (e) { alert('Error updating role'); }
        }

        async function createRole() {
            const data = {
                code: document.getElementById('newRoleCode').value.toUpperCase(),
                title_ar: document.getElementById('newRoleTitleAr').value,
                title_en: document.getElementById('newRoleTitleEn').value,
                description: document.getElementById('newRoleDescription').value,
                hierarchy_level: parseInt(document.getElementById('newRoleHierarchy').value),
                min_approval_limit: 0,
                max_approval_limit: parseFloat(document.getElementById('newRoleMaxLimit').value) || 0
            };

            if (!data.code || !data.title_ar) { alert('بيانات ناقصة'); return; }

            try {
                const response = await fetch(`${API_BASE}/roles`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'x-user-id': USER_ID },
                    body: JSON.stringify(data)
                });
                const result = await response.json();
                if (result.success) {
                    closeModal('createRoleModal');
                    loadRoles();
                    showToast('تم إنشاء الدور بنجاح', 'success');
                } else { alert(result.message); }
            } catch (e) { alert('Error creating role'); }
        }
        
        function confirmDeleteRole(code) {
           if(confirm('هل أنت متأكد من الحذف؟')) {
               fetch(`${API_BASE}/roles/${code}`, { method: 'DELETE', headers: { 'x-user-id': USER_ID } })
                   .then(res => res.json())
                   .then(data => {
                       if(data.success) { loadRoles(); showToast('تم الحذف', 'success'); }
                       else alert(data.message);
                   });
           }
        }

        // Permissions Logic
        async function loadRolePermissions() {
            const roleCode = document.getElementById('permissionRoleSelect').value;
            const container = document.getElementById('permissionsContent');
            const loading = document.getElementById('permissionsLoading');
            
            if (!roleCode) { container.classList.add('hidden'); return; }
            
            container.classList.add('hidden');
            loading.classList.remove('hidden');

            try {
                const response = await fetch(`${API_BASE}/roles/${roleCode}`, { headers: { 'x-user-id': USER_ID } });
                const data = await response.json();
                if (data.success) {
                    currentRolePermissions = data.permissions;
                    displayPermissions();
                    loading.classList.add('hidden');
                    container.classList.remove('hidden');
                }
            } catch (error) { loading.classList.add('hidden'); }
        }

        function displayPermissions() {
            const grid = document.getElementById('permissionsGrid');
            grid.innerHTML = '';
            
            systemsData.forEach(system => {
                const currentPerm = currentRolePermissions.find(p => p.system_code === system.code);
                const currentLevel = currentPerm ? currentPerm.permission_level : 'NONE';
                
                // Color coding for levels
                let borderClass = 'border-slate-200';
                if(currentLevel === 'FULL_ACCESS') borderClass = 'border-red-200 bg-red-50';
                else if(currentLevel !== 'NONE') borderClass = 'border-blue-200 bg-blue-50';

                const div = document.createElement('div');
                div.className = `p-4 rounded-lg border ${borderClass} transition-all hover:shadow-md`;
                div.innerHTML = `
                    <div class="flex justify-between items-center mb-3">
                        <h4 class="font-bold text-slate-800">${system.name_ar}</h4>
                        <i class="fas fa-cogs text-slate-400"></i>
                    </div>
                    <select class="permission-select w-full p-2 text-sm rounded border border-slate-200 focus:border-brand-500 bg-white" 
                            data-system="${system.code}">
                        ${permissionLevelsData.map(level => `
                            <option value="${level.code}" ${level.code === currentLevel ? 'selected' : ''}>
                                ${level.name_ar}
                            </option>
                        `).join('')}
                    </select>
                `;
                grid.appendChild(div);
            });
        }

        async function savePermissions() {
            const roleCode = document.getElementById('permissionRoleSelect').value;
            const permissions = Array.from(document.querySelectorAll('.permission-select')).map(s => ({
                system_code: s.dataset.system,
                permission_level: s.value
            }));

            try {
                const response = await fetch(`${API_BASE}/roles/${roleCode}/permissions`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json', 'x-user-id': USER_ID },
                    body: JSON.stringify({ permissions })
                });
                const result = await response.json();
                if (result.success) showToast('تم حفظ الصلاحيات بنجاح', 'success');
                else alert(result.message);
            } catch(e) { alert('Error saving'); }
        }

        // Users & Helper Functions
        function populateRoleSelects() {
            const selects = ['permissionRoleSelect', 'userRoleSelect'];
            selects.forEach(id => {
                const s = document.getElementById(id);
                s.innerHTML = '<option value="">-- اختر دوراً --</option>';
                rolesData.forEach(r => {
                    const opt = document.createElement('option');
                    opt.value = r.code;
                    opt.textContent = `${r.title_ar} (${r.code})`;
                    s.appendChild(opt);
                });
            });
        }

        function showToast(msg, type='info') {
            const toast = document.createElement('div');
            toast.className = `fixed bottom-4 left-4 px-6 py-3 rounded-lg text-white shadow-lg transform transition-all translate-y-10 opacity-0 z-50 ${type === 'success' ? 'bg-green-600' : 'bg-slate-800'}`;
            toast.textContent = msg;
            document.body.appendChild(toast);
            
            requestAnimationFrame(() => {
                toast.classList.remove('translate-y-10', 'opacity-0');
                toast.style.opacity = '1';
                toast.style.transform = 'translateY(0)';
            });

            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateY(10px)';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }
        
        // Users Functions
        async function fetchUserInfo() {
             const userId = document.getElementById('userIdInput').value;
             const userInfoDisplay = document.getElementById('userInfoDisplay');
             if (!userId) {
                 userInfoDisplay.classList.add('hidden');
                 return;
             }

             try {
                 const response = await fetch(`${API_BASE}/users/${userId}`, {
                     headers: { 'x-user-id': USER_ID }
                 });
                 const result = await response.json();

                 if (result.success) {
                     const user = result.user;
                     document.getElementById('displayUserName').textContent = user.name || 'غير متوفر';
                     document.getElementById('displayUserEmail').textContent = user.email || 'غير متوفر';
                     document.getElementById('displayUserEntity').textContent = `${user.entity_name || 'غير متوفر'} (${user.entity_id || 'N/A'})`;
                     document.getElementById('displayUserStatus').textContent = user.is_active ? '✅ نشط' : '❌ غير نشط';
                     document.getElementById('displayUserRole').textContent = user.current_role ? `${user.current_role.role_name} (${user.current_role.role_id})` : '❌ لا يوجد دور';
                     
                     userInfoDisplay.classList.remove('hidden');
                 } else {
                     userInfoDisplay.classList.add('hidden');
                     alert(result.message || 'المستخدم غير موجود');
                 }
             } catch (error) {
                 console.error(error);
             }
        }

        async function assignRole() {
            const userId = document.getElementById('userIdInput').value;
            const roleCode = document.getElementById('userRoleSelect').value;

            if (!userId || !roleCode) {
                alert('الرجاء اختيار مستخدم ودور');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/users/${userId}/role`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'x-user-id': USER_ID },
                    body: JSON.stringify({ role_code: roleCode })
                });

                const result = await response.json();
                if (result.success) {
                    showToast('تم تعيين الدور بنجاح', 'success');
                    fetchUserInfo();
                } else {
                    alert(result.message);
                }
            } catch (error) {
                alert('خطأ في الاتصال');
            }
        }

        async function revokeRole() {
            const userId = document.getElementById('userIdInput').value;
            if (!userId) return;

             if (confirm('هل أنت متأكد من إلغاء الدور؟')) {
                 try {
                     const response = await fetch(`${API_BASE}/users/${userId}/role`, {
                         method: 'DELETE',
                         headers: { 'x-user-id': USER_ID }
                     });
                     
                     const result = await response.json();
                     if (result.success) {
                         showToast('تم إلغاء الدور', 'success');
                         fetchUserInfo();
                     } else {
                         alert(result.message);
                     }
                 } catch (e) { alert('خطأ'); }
             }
        }

        // Audit Log
        async function loadAuditLog() {
            const loading = document.getElementById('auditLoading');
            const table = document.getElementById('auditTable');
            const tbody = document.getElementById('auditTableBody');
            
            loading.classList.remove('hidden');
            table.classList.add('hidden');

            try {
                const response = await fetch(`${API_BASE}/audit-log?limit=50`, {
                    headers: { 'x-user-id': USER_ID }
                });
                const data = await response.json();

                if (data.success) {
                    tbody.innerHTML = '';
                    data.logs.forEach(log => {
                        const tr = document.createElement('tr');
                        tr.className = 'hover:bg-slate-50 transition-colors';
                        const badgeColor = log.action === 'CREATE' ? 'bg-green-100 text-green-800' : 
                                         log.action === 'DELETE' ? 'bg-red-100 text-red-800' : 'bg-blue-100 text-blue-800';
                        
                        tr.innerHTML = `
                            <td class="py-3 px-6 text-right whitespace-nowrap">${new Date(log.created_at).toLocaleString('ar-EG')}</td>
                            <td class="py-3 px-6 text-right"><span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium ${badgeColor}">${log.action}</span></td>
                            <td class="py-3 px-6 text-right font-mono text-xs">${log.ENTITY_ID_PLACEHOLDER_OR_VALUE}</td>
                            <td class="py-3 px-6 text-right text-xs truncate max-w-xs" title='${JSON.stringify(log.details)}'>${log.details ? 'تفاصيل...' : '-'}</td>
                            <td class="py-3 px-6 text-right text-xs">${log.performed_by}</td>
                        `;
                        // Note: I used placeholders above to fix syntax. 
                        // Correcting data mapping from original:
                        // Original: date, log.entity_type, log.entity_id, log.action, log.performed_by
                        tr.innerHTML = `
                            <td class="py-3 px-6 text-right whitespace-nowrap">${new Date(log.created_at).toLocaleString('ar-EG')}</td>
                            <td class="py-3 px-6 text-right"><span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-slate-100 text-slate-800">${log.entity_type}</span></td>
                            <td class="py-3 px-6 text-right font-mono text-xs">${log.entity_id || '-'}</td>
                            <td class="py-3 px-6 text-right"><span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-blue-100 text-blue-800">${log.action}</span></td>
                            <td class="py-3 px-6 text-right text-xs">${log.performed_by}</td>
                        `;
                        tbody.appendChild(tr);
                    });
                    table.classList.remove('hidden');
                }
            } catch (error) {
                console.error(error);
            } finally {
                loading.classList.add('hidden');
            }
        }

        // Animation Helper
        function animateValue(id, start, end, duration) {
            const obj = document.getElementById(id);
            if(!obj) return;
            let startTimestamp = null;
            const step = (timestamp) => {
                if (!startTimestamp) startTimestamp = timestamp;
                const progress = Math.min((timestamp - startTimestamp) / duration, 1);
                obj.innerHTML = Math.floor(progress * (end - start) + start);
                if (progress < 1) window.requestAnimationFrame(step);
            };
            window.requestAnimationFrame(step);
        }
    </script>
</body>
</html>