const { Pool } = require('pg');
const bcrypt = require('bcryptjs');

const pool = new Pool({
    connectionString: 'postgresql://postgres:PddzJpAQYezqknsntSzmCUlQYuYJldcT@crossover.proxy.rlwy.net:44255/railway',
    ssl: { rejectUnauthorized: false }
});

async function simulateLogin(email, password) {
    const client = await pool.connect();
    
    try {
        console.log(`\nðŸ” Ù…Ø­Ø§ÙƒØ§Ø© ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„: ${email}`);
        console.log('â”'.repeat(60));
        
        // 1. Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Ù†ÙØ³ Ù…Ù†Ø·Ù‚ auth-api.js)
        const credQuery = `
            SELECT uc.id as cred_id, uc.user_id, uc.password_hash, 
                   uc.is_active, uc.failed_attempts, uc.locked_until,
                   u.id, u.name, u.email, u.entity_id, u.entity_name,
                   u.role, u.tenant_type, u.is_active as user_active
            FROM user_credentials uc
            JOIN users u ON uc.user_id = u.id
            WHERE u.email = $1
        `;
        
        const credResult = await client.query(credQuery, [email]);
        
        if (credResult.rows.length === 0) {
            console.log('âŒ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ø£Ùˆ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©');
            return { success: false, message: 'Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ø£Ùˆ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©' };
        }
        
        const credential = credResult.rows[0];
        console.log(`âœ… ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: ${credential.name}`);
        
        // 2. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø­Ø³Ø§Ø¨ Ù…Ù‚ÙÙ„
        if (credential.locked_until && new Date(credential.locked_until) > new Date()) {
            console.log('âŒ Ø§Ù„Ø­Ø³Ø§Ø¨ Ù…Ù‚ÙÙ„ Ù…Ø¤Ù‚ØªØ§Ù‹');
            return { success: false, message: 'Ø§Ù„Ø­Ø³Ø§Ø¨ Ù…Ù‚ÙÙ„ Ù…Ø¤Ù‚ØªØ§Ù‹' };
        }
        
        // 3. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø­Ø³Ø§Ø¨ Ù†Ø´Ø·
        if (!credential.is_active || !credential.user_active) {
            console.log('âŒ Ø§Ù„Ø­Ø³Ø§Ø¨ ØºÙŠØ± Ù†Ø´Ø·');
            return { success: false, message: 'Ø§Ù„Ø­Ø³Ø§Ø¨ ØºÙŠØ± Ù†Ø´Ø·' };
        }
        console.log('âœ… Ø§Ù„Ø­Ø³Ø§Ø¨ Ù†Ø´Ø·');
        
        // 4. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±
        const isPasswordValid = await bcrypt.compare(password, credential.password_hash);
        
        if (!isPasswordValid) {
            console.log('âŒ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©');
            return { success: false, message: 'Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ø£Ùˆ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©' };
        }
        console.log('âœ… ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØµØ­ÙŠØ­Ø©');
        
        // 5. Ø¬Ù„Ø¨ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª
        const rolesQuery = `
            SELECT r.id, r.name, r.name_ar, r.job_title_ar, r.hierarchy_level
            FROM user_roles ur
            JOIN roles r ON ur.role_id = r.id
            WHERE ur.user_id = $1 AND ur.is_active = true
        `;
        const rolesResult = await client.query(rolesQuery, [credential.user_id]);
        console.log(`âœ… Ø§Ù„Ø£Ø¯ÙˆØ§Ø±: ${rolesResult.rows.length} Ø¯ÙˆØ±`);
        
        // 6. Ø§Ù„Ù†ØªÙŠØ¬Ø©
        console.log('\nðŸ“Š ØªÙØ§ØµÙŠÙ„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„:');
        console.log(`   ðŸ‘¤ Ø§Ù„Ø§Ø³Ù…: ${credential.name}`);
        console.log(`   ðŸ“§ Ø§Ù„Ø¨Ø±ÙŠØ¯: ${credential.email}`);
        console.log(`   ðŸ¢ Ø§Ù„Ø¬Ù‡Ø©: ${credential.entity_name} (${credential.entity_id})`);
        console.log(`   ðŸŽ­ Ø§Ù„Ø£Ø¯ÙˆØ§Ø±: ${rolesResult.rows.map(r => r.name_ar).join(', ') || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯'}`);
        
        return {
            success: true,
            message: 'ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­',
            user: {
                id: credential.user_id,
                name: credential.name,
                email: credential.email,
                entity_id: credential.entity_id,
                entity_name: credential.entity_name
            },
            roles: rolesResult.rows
        };
        
    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£:', error.message);
        return { success: false, message: 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø®Ø§Ø¯Ù…' };
    } finally {
        client.release();
    }
}

async function runTests() {
    console.log('\nâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—');
    console.log('â•‘  Ø§Ø®ØªØ¨Ø§Ø± Ø´Ø§Ù…Ù„ Ù„Ù†Ø¸Ø§Ù… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ       â•‘');
    console.log('â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
    
    // Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± 1: ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Super Admin
    await simulateLogin('ahmed@nayosh.com', 'Admin@123');
    
    // Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± 2: ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ù…Ø³ØªØ®Ø¯Ù… Ø¹Ø§Ø¯ÙŠ
    await simulateLogin('sara@nayosh.com', 'User@123');
    
    // Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± 3: Ù…Ø­Ø§ÙˆÙ„Ø© Ø¨ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø®Ø§Ø·Ø¦Ø©
    await simulateLogin('ahmed@nayosh.com', 'WrongPassword');
    
    // Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± 4: Ù…Ø­Ø§ÙˆÙ„Ø© Ø¨Ø¨Ø±ÙŠØ¯ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯
    await simulateLogin('notexist@nayosh.com', 'Admin@123');
    
    // Ø¹Ø±Ø¶ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø©
    console.log('\nâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—');
    console.log('â•‘  Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø© Ù„Ù„Ø¯Ø®ÙˆÙ„                                 â•‘');
    console.log('â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n');
    
    const allUsers = await pool.query(`
        SELECT u.name, u.email, u.entity_id,
               CASE WHEN u.entity_id = 'HQ001' THEN 'Admin@123' ELSE 'User@123' END as password
        FROM users u
        JOIN user_credentials uc ON u.id = uc.user_id
        WHERE uc.is_active = true
        ORDER BY u.id
    `);
    
    console.log('â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”');
    allUsers.rows.forEach((u, i) => {
        console.log(`â”‚ ${i+1}. ${u.name}`);
        console.log(`â”‚    ðŸ“§ ${u.email}`);
        console.log(`â”‚    ðŸ”‘ ${u.password}`);
        if (i < allUsers.rows.length - 1) {
            console.log('â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤');
        }
    });
    console.log('â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜');
    
    console.log('\nâœ… Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø§Ù†ØªÙ‡Øª!');
    console.log('ðŸ“Œ Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø¢Ù† ÙŠØ¹Ù…Ù„ Ø¨Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ø´Ø®ØµÙŠ (Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ)\n');
    
    await pool.end();
}

runTests().catch(console.error);
