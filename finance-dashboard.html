<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ“Š Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø§Ù„ÙŠØ© - Ù†Ø§ÙŠÙˆØ´</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            font-family: 'Cairo', sans-serif;
            background: linear-gradient(120deg, #0ea5e9 0%, #0f766e 45%, #7c3aed 100%);
            min-height: 100vh;
        }
        .card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            padding: 1.5rem;
            margin-bottom: 1rem;
        }
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1rem;
        }
        .stat-card.green {
            background: linear-gradient(135deg, #56ab2f 0%, #a8e063 100%);
        }
        .stat-card.red {
            background: linear-gradient(135deg, #eb3349 0%, #f45c43 100%);
        }
        .stat-card.blue {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }
        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        .btn-success {
            background: linear-gradient(135deg, #56ab2f 0%, #a8e063 100%);
            color: white;
        }
        .btn-danger {
            background: linear-gradient(135deg, #eb3349 0%, #f45c43 100%);
            color: white;
        }
        .input-field {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            margin-bottom: 1rem;
            transition: border 0.3s;
        }
        .input-field:focus {
            outline: none;
            border-color: #667eea;
        }
        .tab {
            padding: 1rem 2rem;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }
        .tab.active {
            border-bottom-color: #667eea;
            color: #667eea;
            font-weight: 700;
        }
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .toast {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 1rem 2rem;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            z-index: 1000;
            animation: slideDown 0.3s ease-out;
        }
        .toast.success { background: #56ab2f; }
        .toast.error { background: #eb3349; }
        @keyframes slideDown {
            from { transform: translate(-50%, -100%); opacity: 0; }
            to { transform: translate(-50%, 0); opacity: 1; }
        }
        .section-accent-sky { border-top: 4px solid #0ea5e9; }
        .section-accent-emerald { border-top: 4px solid #10b981; }
        .section-accent-amber { border-top: 4px solid #f59e0b; }
        .section-accent-violet { border-top: 4px solid #8b5cf6; }
        .section-accent-indigo { border-top: 4px solid #6366f1; }
    </style>
</head>
<body class="bg-slate-50">

    <!-- Header -->
    <div class="bg-gradient-to-r from-purple-600 to-indigo-600 text-white p-6 shadow-lg">
        <div class="container mx-auto">
            <h1 class="text-3xl font-bold mb-2">ğŸ“Š Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø§Ù„ÙŠØ© Ø§Ù„Ù…ØªÙ‚Ø¯Ù…</h1>
            <p class="text-purple-100">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªØ¯ÙÙ‚Ø§Øª Ø§Ù„Ù†Ù‚Ø¯ÙŠØ© â€¢ Ø§Ù„ØªÙˆÙ‚Ø¹Ø§Øª Ø§Ù„Ø°ÙƒÙŠØ© â€¢ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ø´Ø§Ù…Ù„Ø©</p>
        </div>
    </div>

    <div class="bg-white border-b">
        <div class="container mx-auto px-6 py-4 flex flex-wrap gap-3">
            <a href="/finance/cashflow-risk-reports.html" class="btn btn-primary flex items-center gap-2">
                <i class="fas fa-water"></i>
                Ø§Ù„ØªØ¯ÙÙ‚Ø§Øª ÙˆØ§Ù„Ù…Ø®Ø§Ø·Ø± ÙˆØ§Ù„ØªÙ‚Ø§Ø±ÙŠØ±
            </a>
            <a href="/finance/accounting-cycle-impact.html" class="btn btn-success flex items-center gap-2">
                <i class="fas fa-sitemap"></i>
                Ø£Ø«Ø± Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø­Ø§Ø³Ø¨ÙŠ ÙˆØ§Ù„Ø¯ÙˆØ±Ø©
            </a>
            <a href="/finance/chart-accounts-ui-design.html" class="btn btn-primary flex items-center gap-2">
                <i class="fas fa-project-diagram"></i>
                ØªØµÙ…ÙŠÙ… Ø´Ø¬Ø±Ø© Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª ÙˆØ§Ù„ÙˆØ§Ø¬Ù‡Ø§Øª
            </a>
            <a href="/finance/invoices-budgets-master.html" class="btn btn-success flex items-center gap-2">
                <i class="fas fa-file-invoice"></i>
                Ø§Ù„ÙÙˆØ§ØªÙŠØ± ÙˆØ§Ù„ØªØ­ØµÙŠÙ„ ÙˆØ§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ§Øª
            </a>
            <a href="/finance/system-blueprint-execution.html" class="btn btn-primary flex items-center gap-2">
                <i class="fas fa-network-wired"></i>
                Ø§Ù„Ù…Ø®Ø·Ø· Ø§Ù„ØªÙ†ÙÙŠØ°ÙŠ Ù„Ù„Ù†Ø¸Ø§Ù…
            </a>
            <a href="/finance/financial-governance-executive.html" class="btn btn-success flex items-center gap-2">
                <i class="fas fa-shield-halved"></i>
                Ø§Ù„Ø­ÙˆÙƒÙ…Ø© Ø§Ù„Ù…Ø§Ù„ÙŠØ© ÙˆØ§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª
            </a>
            <a href="/finance/strategic-financial-reports.html" class="btn btn-primary flex items-center gap-2">
                <i class="fas fa-chart-pie"></i>
                Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ© ÙˆØ§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ù…Ø§Ù„ÙŠ
            </a>
        </div>
    </div>

    <!-- Tabs -->
    <div class="bg-white shadow-sm border-b">
        <div class="container mx-auto flex overflow-x-auto">
            <div class="tab active" onclick="switchTab('overview')">
                <i class="fas fa-chart-line ml-2"></i> Ù†Ø¸Ø±Ø© Ø¹Ø§Ù…Ø©
            </div>
            <div class="tab" onclick="switchTab('accounts')">
                <i class="fas fa-book ml-2"></i> Ø´Ø¬Ø±Ø© Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª
            </div>
            <div class="tab" onclick="switchTab('operating')">
                <i class="fas fa-shopping-cart ml-2"></i> Ø§Ù„ØªØ¯ÙÙ‚Ø§Øª Ø§Ù„ØªØ´ØºÙŠÙ„ÙŠØ©
            </div>
            <div class="tab" onclick="switchTab('investing')">
                <i class="fas fa-building ml-2"></i> Ø§Ù„ØªØ¯ÙÙ‚Ø§Øª Ø§Ù„Ø§Ø³ØªØ«Ù…Ø§Ø±ÙŠØ©
            </div>
            <div class="tab" onclick="switchTab('financing')">
                <i class="fas fa-hand-holding-usd ml-2"></i> Ø§Ù„ØªØ¯ÙÙ‚Ø§Øª Ø§Ù„ØªÙ…ÙˆÙŠÙ„ÙŠØ©
            </div>
            <div class="tab" onclick="switchTab('forecast')">
                <i class="fas fa-brain ml-2"></i> Ø§Ù„ØªÙˆÙ‚Ø¹Ø§Øª Ø§Ù„Ø°ÙƒÙŠØ©
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="container mx-auto p-6">

        <!-- Overview Tab -->
        <div id="overview-tab" class="tab-content">
            <h2 class="text-2xl font-bold mb-4">ğŸ“ˆ Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</h2>
            
            <!-- Stats Cards -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                <div class="stat-card green">
                    <div class="text-sm opacity-90">ØµØ§ÙÙŠ Ø§Ù„ØªØ¯ÙÙ‚ Ø§Ù„ØªØ´ØºÙŠÙ„ÙŠ</div>
                    <div class="text-3xl font-bold mt-2" id="operating-net">0 Ø±ÙŠØ§Ù„</div>
                    <div class="text-sm mt-2 opacity-75">Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«: Ø§Ù„ÙŠÙˆÙ…</div>
                </div>
                <div class="stat-card red">
                    <div class="text-sm opacity-90">ØµØ§ÙÙŠ Ø§Ù„ØªØ¯ÙÙ‚ Ø§Ù„Ø§Ø³ØªØ«Ù…Ø§Ø±ÙŠ</div>
                    <div class="text-3xl font-bold mt-2" id="investing-net">0 Ø±ÙŠØ§Ù„</div>
                    <div class="text-sm mt-2 opacity-75">Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«: Ø§Ù„ÙŠÙˆÙ…</div>
                </div>
                <div class="stat-card blue">
                    <div class="text-sm opacity-90">ØµØ§ÙÙŠ Ø§Ù„ØªØ¯ÙÙ‚ Ø§Ù„ØªÙ…ÙˆÙŠÙ„ÙŠ</div>
                    <div class="text-3xl font-bold mt-2" id="financing-net">0 Ø±ÙŠØ§Ù„</div>
                    <div class="text-sm mt-2 opacity-75">Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«: Ø§Ù„ÙŠÙˆÙ…</div>
                </div>
            </div>

            <!-- Total Net Flow -->
            <div class="card section-accent-sky">
                <h3 class="text-xl font-bold mb-4">ğŸ’° Ø¥Ø¬Ù…Ø§Ù„ÙŠ ØµØ§ÙÙŠ Ø§Ù„ØªØ¯ÙÙ‚ Ø§Ù„Ù†Ù‚Ø¯ÙŠ</h3>
                <div class="text-4xl font-bold text-purple-600" id="total-net">0 Ø±ÙŠØ§Ù„</div>
                <div class="mt-4">
                    <canvas id="cashflow-chart"></canvas>
                </div>
            </div>

            <!-- Recent Transactions -->
            <div class="card section-accent-emerald">
                <h3 class="text-xl font-bold mb-4">ğŸ“‹ Ø¢Ø®Ø± Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</h3>
                <div id="recent-transactions" class="space-y-2">
                    <div class="text-gray-500 text-center py-4">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
                </div>
            </div>
        </div>

        <!-- Accounts Tab (NEW) -->
        <div id="accounts-tab" class="tab-content hidden">
            <h2 class="text-2xl font-bold mb-4">ğŸ“š Ø´Ø¬Ø±Ø© Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ù…Ø§Ù„ÙŠØ©</h2>
            
            <!-- Stats -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                <div class="stat-card green">
                    <div class="text-sm opacity-90">Ø§Ù„Ø£ØµÙˆÙ„</div>
                    <div class="text-2xl font-bold mt-2" id="assets-count">0</div>
                </div>
                <div class="stat-card red">
                    <div class="text-sm opacity-90">Ø§Ù„Ø®ØµÙˆÙ…</div>
                    <div class="text-2xl font-bold mt-2" id="liabilities-count">0</div>
                </div>
                <div class="stat-card blue">
                    <div class="text-sm opacity-90">Ø­Ù‚ÙˆÙ‚ Ø§Ù„Ù…Ù„ÙƒÙŠØ©</div>
                    <div class="text-2xl font-bold mt-2" id="equity-count">0</div>
                </div>
                <div class="stat-card">
                    <div class="text-sm opacity-90">Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª ÙˆØ§Ù„Ù…ØµØ±ÙˆÙØ§Øª</div>
                    <div class="text-2xl font-bold mt-2" id="income-expense-count">0</div>
                </div>
            </div>

            <!-- Accounts Table -->
            <div class="card section-accent-indigo">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-bold">ğŸ“‹ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª (61 Ø­Ø³Ø§Ø¨)</h3>
                    <input type="text" id="search-accounts" class="input-field" placeholder="ğŸ” Ø¨Ø­Ø«..." style="width: 300px; margin-bottom: 0;">
                </div>
                <div class="overflow-auto" style="max-height: 600px;">
                    <table class="w-full">
                        <thead class="bg-gray-100 sticky top-0">
                            <tr>
                                <th class="p-3 text-right">account_id</th>
                                <th class="p-3 text-right">account_code</th>
                                <th class="p-3 text-right">account_name_ar</th>
                                <th class="p-3 text-right">account_name_en</th>
                                <th class="p-3 text-right">account_type</th>
                                <th class="p-3 text-right">parent_account_id</th>
                                <th class="p-3 text-right">parent_name</th>
                                <th class="p-3 text-right">level</th>
                                <th class="p-3 text-right">is_header</th>
                                <th class="p-3 text-right">normal_balance</th>
                                <th class="p-3 text-right">is_active</th>
                                <th class="p-3 text-right">entity_type</th>
                                <th class="p-3 text-right">entity_id</th>
                                <th class="p-3 text-right">branch_id</th>
                                <th class="p-3 text-right">incubator_id</th>
                                <th class="p-3 text-right">platform_id</th>
                                <th class="p-3 text-right">office_id</th>
                                <th class="p-3 text-right">description</th>
                                <th class="p-3 text-right">notes</th>
                                <th class="p-3 text-right">children_count</th>
                                <th class="p-3 text-right">created_at</th>
                                <th class="p-3 text-right">updated_at</th>
                                <th class="p-3 text-right">created_by</th>
                                <th class="p-3 text-right">updated_by</th>
                            </tr>
                        </thead>
                        <tbody id="accounts-tbody">
                            <tr><td colspan="24" class="text-center p-4 text-gray-500">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Operating Cashflow Tab -->
        <div id="operating-tab" class="tab-content hidden">
            <h2 class="text-2xl font-bold mb-4">ğŸ”„ Ø§Ù„ØªØ¯ÙÙ‚Ø§Øª Ø§Ù„ØªØ´ØºÙŠÙ„ÙŠØ©</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Add Operating Flow -->
                <div class="card section-accent-emerald">
                    <h3 class="text-lg font-bold mb-4">â• Ø¥Ø¶Ø§ÙØ© ØªØ¯ÙÙ‚ ØªØ´ØºÙŠÙ„ÙŠ</h3>
                    <form id="operating-form" onsubmit="addOperatingFlow(event)">
                        <select class="input-field" id="op-type" required>
                            <option value="">Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„ØªØ¯ÙÙ‚</option>
                            <option value="customer_collection">ØªØ­ØµÙŠÙ„ Ù…Ù† Ø¹Ù…ÙŠÙ„</option>
                            <option value="vendor_payment">Ø¯ÙØ¹ Ù„Ù…ÙˆØ±Ø¯</option>
                            <option value="salary_payment">Ø±ÙˆØ§ØªØ¨ Ù…ÙˆØ¸ÙÙŠÙ†</option>
                            <option value="rent_payment">Ø¥ÙŠØ¬Ø§Ø±Ø§Øª</option>
                            <option value="utilities_payment">Ù…Ø±Ø§ÙÙ‚</option>
                        </select>
                        <input type="number" class="input-field" id="op-amount" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº (Ø±ÙŠØ§Ù„)" required step="0.01">
                        <input type="text" class="input-field" id="op-description" placeholder="Ø§Ù„ÙˆØµÙ" required>
                        <input type="date" class="input-field" id="op-date" required>
                        <button type="submit" class="btn btn-success w-full">
                            <i class="fas fa-plus ml-2"></i> Ø¥Ø¶Ø§ÙØ©
                        </button>
                    </form>
                </div>

                <!-- Operating Summary -->
                <div class="card section-accent-emerald">
                    <h3 class="text-lg font-bold mb-4">ğŸ“Š Ù…Ù„Ø®Øµ Ø§Ù„ØªØ¯ÙÙ‚Ø§Øª Ø§Ù„ØªØ´ØºÙŠÙ„ÙŠØ©</h3>
                    <div id="operating-summary" class="space-y-3">
                        <div class="text-gray-500 text-center py-4">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
                    </div>
                </div>
            </div>

            <!-- Operating List -->
            <div class="card mt-6 section-accent-emerald">
                <h3 class="text-lg font-bold mb-4">ğŸ“‹ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØªØ¯ÙÙ‚Ø§Øª Ø§Ù„ØªØ´ØºÙŠÙ„ÙŠØ©</h3>
                <div id="operating-list" class="overflow-auto">
                    <table class="w-full">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="p-3 text-right">flow_id</th>
                                <th class="p-3 text-right">entity_id</th>
                                <th class="p-3 text-right">flow_type</th>
                                <th class="p-3 text-right">amount</th>
                                <th class="p-3 text-right">direction</th>
                                <th class="p-3 text-right">description</th>
                                <th class="p-3 text-right">flow_date</th>
                                <th class="p-3 text-right">created_by</th>
                                <th class="p-3 text-right">created_at</th>
                            </tr>
                        </thead>
                        <tbody id="operating-tbody">
                            <tr><td colspan="9" class="text-center p-4 text-gray-500">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Investing Cashflow Tab -->
        <div id="investing-tab" class="tab-content hidden">
            <h2 class="text-2xl font-bold mb-4">ğŸ¢ Ø§Ù„ØªØ¯ÙÙ‚Ø§Øª Ø§Ù„Ø§Ø³ØªØ«Ù…Ø§Ø±ÙŠØ©</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Add Investing Flow -->
                <div class="card section-accent-amber">
                    <h3 class="text-lg font-bold mb-4">â• Ø¥Ø¶Ø§ÙØ© ØªØ¯ÙÙ‚ Ø§Ø³ØªØ«Ù…Ø§Ø±ÙŠ</h3>
                    <form id="investing-form" onsubmit="addInvestingFlow(event)">
                        <select class="input-field" id="inv-type" required>
                            <option value="">Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„ØªØ¯ÙÙ‚</option>
                            <option value="asset_purchase">Ø´Ø±Ø§Ø¡ Ø£ØµÙ„</option>
                            <option value="asset_sale">Ø¨ÙŠØ¹ Ø£ØµÙ„</option>
                            <option value="platform_investment">Ø§Ø³ØªØ«Ù…Ø§Ø± ÙÙŠ Ù…Ù†ØµØ©</option>
                            <option value="equipment_purchase">Ø´Ø±Ø§Ø¡ Ù…Ø¹Ø¯Ø§Øª</option>
                        </select>
                        <input type="number" class="input-field" id="inv-amount" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº (Ø±ÙŠØ§Ù„)" required step="0.01">
                        <input type="text" class="input-field" id="inv-description" placeholder="Ø§Ù„ÙˆØµÙ" required>
                        <input type="date" class="input-field" id="inv-date" required>
                        <button type="submit" class="btn btn-success w-full">
                            <i class="fas fa-plus ml-2"></i> Ø¥Ø¶Ø§ÙØ©
                        </button>
                    </form>
                </div>

                <!-- Investing Summary -->
                <div class="card section-accent-amber">
                    <h3 class="text-lg font-bold mb-4">ğŸ“Š Ù…Ù„Ø®Øµ Ø§Ù„ØªØ¯ÙÙ‚Ø§Øª Ø§Ù„Ø§Ø³ØªØ«Ù…Ø§Ø±ÙŠØ©</h3>
                    <div id="investing-summary" class="space-y-3">
                        <div class="text-gray-500 text-center py-4">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
                    </div>
                </div>
            </div>

            <!-- Investing List -->
            <div class="card mt-6 section-accent-amber">
                <h3 class="text-lg font-bold mb-4">ğŸ“‹ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØªØ¯ÙÙ‚Ø§Øª Ø§Ù„Ø§Ø³ØªØ«Ù…Ø§Ø±ÙŠØ©</h3>
                <div id="investing-list" class="overflow-auto">
                    <table class="w-full">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="p-3 text-right">flow_id</th>
                                <th class="p-3 text-right">entity_id</th>
                                <th class="p-3 text-right">flow_type</th>
                                <th class="p-3 text-right">amount</th>
                                <th class="p-3 text-right">direction</th>
                                <th class="p-3 text-right">description</th>
                                <th class="p-3 text-right">flow_date</th>
                                <th class="p-3 text-right">created_by</th>
                                <th class="p-3 text-right">created_at</th>
                            </tr>
                        </thead>
                        <tbody id="investing-tbody">
                            <tr><td colspan="9" class="text-center p-4 text-gray-500">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Financing Cashflow Tab -->
        <div id="financing-tab" class="tab-content hidden">
            <h2 class="text-2xl font-bold mb-4">ğŸ’µ Ø§Ù„ØªØ¯ÙÙ‚Ø§Øª Ø§Ù„ØªÙ…ÙˆÙŠÙ„ÙŠØ©</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Add Financing Flow -->
                <div class="card section-accent-violet">
                    <h3 class="text-lg font-bold mb-4">â• Ø¥Ø¶Ø§ÙØ© ØªØ¯ÙÙ‚ ØªÙ…ÙˆÙŠÙ„ÙŠ</h3>
                    <form id="financing-form" onsubmit="addFinancingFlow(event)">
                        <select class="input-field" id="fin-type" required>
                            <option value="">Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„ØªØ¯ÙÙ‚</option>
                            <option value="bank_loan">Ù‚Ø±Ø¶ Ù…Ù† Ø¨Ù†Ùƒ</option>
                            <option value="loan_repayment">Ø³Ø¯Ø§Ø¯ Ù‚Ø±Ø¶</option>
                            <option value="capital_increase">Ø²ÙŠØ§Ø¯Ø© Ø±Ø£Ø³ Ø§Ù„Ù…Ø§Ù„</option>
                            <option value="dividend_payment">ØªÙˆØ²ÙŠØ¹ Ø£Ø±Ø¨Ø§Ø­</option>
                        </select>
                        <input type="number" class="input-field" id="fin-amount" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº (Ø±ÙŠØ§Ù„)" required step="0.01">
                        <input type="text" class="input-field" id="fin-description" placeholder="Ø§Ù„ÙˆØµÙ" required>
                        <input type="date" class="input-field" id="fin-date" required>
                        <button type="submit" class="btn btn-success w-full">
                            <i class="fas fa-plus ml-2"></i> Ø¥Ø¶Ø§ÙØ©
                        </button>
                    </form>
                </div>

                <!-- Financing Summary -->
                <div class="card section-accent-violet">
                    <h3 class="text-lg font-bold mb-4">ğŸ“Š Ù…Ù„Ø®Øµ Ø§Ù„ØªØ¯ÙÙ‚Ø§Øª Ø§Ù„ØªÙ…ÙˆÙŠÙ„ÙŠØ©</h3>
                    <div id="financing-summary" class="space-y-3">
                        <div class="text-gray-500 text-center py-4">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
                    </div>
                </div>
            </div>

            <!-- Financing List -->
            <div class="card mt-6 section-accent-violet">
                <h3 class="text-lg font-bold mb-4">ğŸ“‹ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØªØ¯ÙÙ‚Ø§Øª Ø§Ù„ØªÙ…ÙˆÙŠÙ„ÙŠØ©</h3>
                <div id="financing-list" class="overflow-auto">
                    <table class="w-full">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="p-3 text-right">flow_id</th>
                                <th class="p-3 text-right">entity_id</th>
                                <th class="p-3 text-right">flow_type</th>
                                <th class="p-3 text-right">amount</th>
                                <th class="p-3 text-right">direction</th>
                                <th class="p-3 text-right">description</th>
                                <th class="p-3 text-right">flow_date</th>
                                <th class="p-3 text-right">created_by</th>
                                <th class="p-3 text-right">created_at</th>
                            </tr>
                        </thead>
                        <tbody id="financing-tbody">
                            <tr><td colspan="9" class="text-center p-4 text-gray-500">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- AI Forecast Tab -->
        <div id="forecast-tab" class="tab-content hidden">
            <h2 class="text-2xl font-bold mb-4">ğŸ¤– Ø§Ù„ØªÙˆÙ‚Ø¹Ø§Øª Ø§Ù„Ø°ÙƒÙŠØ© Ø¨Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Create Forecast -->
                <div class="card section-accent-sky">
                    <h3 class="text-lg font-bold mb-4">â• Ø¥Ù†Ø´Ø§Ø¡ ØªÙˆÙ‚Ø¹ Ø¬Ø¯ÙŠØ¯</h3>
                    <form id="forecast-form" onsubmit="addForecast(event)">
                        <select class="input-field" id="fc-type" required>
                            <option value="">Ù†ÙˆØ¹ Ø§Ù„ØªÙˆÙ‚Ø¹</option>
                            <option value="surplus">ÙØ§Ø¦Ø¶ Ù†Ù‚Ø¯ÙŠ</option>
                            <option value="deficit">Ø¹Ø¬Ø² Ù†Ù‚Ø¯ÙŠ</option>
                        </select>
                        <input type="date" class="input-field" id="fc-date" placeholder="ØªØ§Ø±ÙŠØ® Ø§Ù„ØªÙˆÙ‚Ø¹" required>
                        <input type="number" class="input-field" id="fc-amount" placeholder="Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…ØªÙˆÙ‚Ø¹Ø© (Ø±ÙŠØ§Ù„)" required step="0.01">
                        <input type="number" class="input-field" id="fc-confidence" placeholder="Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø«Ù‚Ø© %" required min="0" max="100" step="0.1">
                        <input type="number" class="input-field" id="fc-lower" placeholder="Ø§Ù„Ù†Ø·Ø§Ù‚ Ø§Ù„Ø³ÙÙ„ÙŠ (Ø±ÙŠØ§Ù„)" required step="0.01">
                        <input type="number" class="input-field" id="fc-upper" placeholder="Ø§Ù„Ù†Ø·Ø§Ù‚ Ø§Ù„Ø¹Ù„ÙˆÙŠ (Ø±ÙŠØ§Ù„)" required step="0.01">
                        <textarea class="input-field" id="fc-factors" placeholder="Ø§Ù„Ø¹ÙˆØ§Ù…Ù„ Ø§Ù„Ù…Ø¤Ø«Ø±Ø© (JSON)" rows="3">[]</textarea>
                        <button type="submit" class="btn btn-primary w-full">
                            <i class="fas fa-brain ml-2"></i> Ø¥Ù†Ø´Ø§Ø¡ ØªÙˆÙ‚Ø¹
                        </button>
                    </form>
                </div>

                <!-- Forecast Stats -->
                <div class="card section-accent-sky">
                    <h3 class="text-lg font-bold mb-4">ğŸ“ˆ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„ØªÙˆÙ‚Ø¹Ø§Øª</h3>
                    <div id="forecast-stats" class="space-y-3">
                        <div class="text-gray-500 text-center py-4">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
                    </div>
                </div>
            </div>

            <!-- Forecasts Table -->
            <div class="card mt-6 section-accent-sky">
                <h3 class="text-lg font-bold mb-4">ğŸ”® Ø¬Ø¯ÙˆÙ„ Ø§Ù„ØªÙˆÙ‚Ø¹Ø§Øª</h3>
                <div class="overflow-auto">
                    <table class="w-full">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="p-3 text-right">forecast_id</th>
                                <th class="p-3 text-right">entity_id</th>
                                <th class="p-3 text-right">forecast_period</th>
                                <th class="p-3 text-right">forecast_type</th>
                                <th class="p-3 text-right">forecast_amount</th>
                                <th class="p-3 text-right">confidence_level</th>
                                <th class="p-3 text-right">ai_model</th>
                                <th class="p-3 text-right">ai_insights</th>
                                <th class="p-3 text-right">created_at</th>
                            </tr>
                        </thead>
                        <tbody id="forecast-tbody">
                            <tr><td colspan="9" class="text-center p-4 text-gray-500">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

    </div>

    <script>
        const API_BASE = window.location.origin;
        const ENTITY_ID = '1'; // Default entity
        let cashflowChart = null;

        // Switch Tabs
        function switchTab(tab) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));

            // Show selected tab
            document.getElementById(`${tab}-tab`).classList.remove('hidden');
            event.target.closest('.tab').classList.add('active');

            // Load data for the tab
            if (tab === 'overview') loadOverview();
            else if (tab === 'accounts') loadAccounts();
            else if (tab === 'operating') loadOperating();
            else if (tab === 'investing') loadInvesting();
            else if (tab === 'financing') loadFinancing();
            else if (tab === 'forecast') loadForecasts();
        }

        // Toast Notification
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `<i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'} ml-2"></i> ${message}`;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        // Format Number
        function formatMoney(amount) {
            return new Intl.NumberFormat('ar-SA', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(amount) + ' Ø±ÙŠØ§Ù„';
        }

        // Load Overview
        async function loadOverview() {
            try {
                const res = await fetch(`${API_BASE}/finance/cashflow/overview?entity_id=${ENTITY_ID}`);
                const data = await res.json();

                document.getElementById('operating-net').textContent = formatMoney(data.operating.net_cashflow);
                document.getElementById('investing-net').textContent = formatMoney(data.investing.net_cashflow);
                document.getElementById('financing-net').textContent = formatMoney(data.financing.net_cashflow);
                document.getElementById('total-net').textContent = formatMoney(data.total_net_cashflow);

                updateChart([
                    data.operating.net_cashflow,
                    data.investing.net_cashflow,
                    data.financing.net_cashflow
                ]);

                loadRecentTransactions();
            } catch (error) {
                console.error('Error loading overview:', error);
                showToast('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'error');
            }
        }

        async function loadRecentTransactions() {
            try {
                const [opRes, invRes, finRes] = await Promise.all([
                    fetch(`${API_BASE}/finance/cashflow/operating?entity_id=${ENTITY_ID}`),
                    fetch(`${API_BASE}/finance/cashflow/investing?entity_id=${ENTITY_ID}`),
                    fetch(`${API_BASE}/finance/cashflow/financing?entity_id=${ENTITY_ID}`)
                ]);

                const [opData, invData, finData] = await Promise.all([
                    opRes.json(), invRes.json(), finRes.json()
                ]);

                const combined = []
                    .concat((opData.cashflows || []).map(f => ({ ...f, flow_group: 'OPERATING' })))
                    .concat((invData.cashflows || []).map(f => ({ ...f, flow_group: 'INVESTING' })))
                    .concat((finData.cashflows || []).map(f => ({ ...f, flow_group: 'FINANCING' })));

                const recent = combined
                    .sort((a, b) => new Date(b.flow_date) - new Date(a.flow_date))
                    .slice(0, 6);

                const container = document.getElementById('recent-transactions');
                if (!recent.length) {
                    container.innerHTML = '<div class="text-gray-500 text-center py-4">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù…Ù„ÙŠØ§Øª</div>';
                    return;
                }

                container.innerHTML = recent.map(item => {
                    const amount = parseFloat(item.amount || 0);
                    const direction = amount >= 0 ? 'IN' : 'OUT';
                    const badgeColor = direction === 'IN' ? 'text-green-600' : 'text-red-600';
                    const groupLabel = item.flow_group === 'OPERATING' ? 'ØªØ´ØºÙŠÙ„ÙŠ' : item.flow_group === 'INVESTING' ? 'Ø§Ø³ØªØ«Ù…Ø§Ø±ÙŠ' : 'ØªÙ…ÙˆÙŠÙ„ÙŠ';
                    return `
                        <div class="flex items-center justify-between bg-white/70 p-3 rounded-lg border">
                            <div>
                                <div class="font-semibold">${groupLabel} â€¢ ${getFlowTypeLabel(item.flow_type)}</div>
                                <div class="text-sm text-gray-500">${item.description || '-'} â€¢ ${new Date(item.flow_date).toLocaleDateString('ar-SA')}</div>
                            </div>
                            <div class="font-bold ${badgeColor}">${formatMoney(Math.abs(amount))}</div>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                console.error('Error loading recent transactions:', error);
            }
        }

        // Load Accounts
        async function loadAccounts() {
            try {
                const res = await fetch(`${API_BASE}/finance/accounts?entity_id=${ENTITY_ID}`);
                const data = await res.json();

                if (!data.success) {
                    throw new Error('Failed to load accounts');
                }

                const accounts = data.accounts;

                // Count by type
                const assets = accounts.filter(a => a.account_type === 'ASSET').length;
                const liabilities = accounts.filter(a => a.account_type === 'LIABILITY').length;
                const equity = accounts.filter(a => a.account_type === 'EQUITY').length;
                const income = accounts.filter(a => a.account_type === 'REVENUE' || a.account_type === 'EXPENSE').length;

                document.getElementById('assets-count').textContent = `${assets} Ø­Ø³Ø§Ø¨`;
                document.getElementById('liabilities-count').textContent = `${liabilities} Ø­Ø³Ø§Ø¨`;
                document.getElementById('equity-count').textContent = `${equity} Ø­Ø³Ø§Ø¨`;
                document.getElementById('income-expense-count').textContent = `${income} Ø­Ø³Ø§Ø¨`;

                // Display accounts
                const tbody = document.getElementById('accounts-tbody');
                tbody.innerHTML = accounts.map(acc => {
                    const typeLabels = {
                        'ASSET': 'Ø£ØµÙ„',
                        'LIABILITY': 'Ø§Ù„ØªØ²Ø§Ù…',
                        'EQUITY': 'Ø­Ù‚ÙˆÙ‚ Ù…Ù„ÙƒÙŠØ©',
                        'REVENUE': 'Ø¥ÙŠØ±Ø§Ø¯',
                        'EXPENSE': 'Ù…ØµØ±ÙˆÙ'
                    };

                    const typeColors = {
                        'ASSET': 'text-green-600',
                        'LIABILITY': 'text-red-600',
                        'EQUITY': 'text-blue-600',
                        'REVENUE': 'text-purple-600',
                        'EXPENSE': 'text-orange-600'
                    };

                    return `
                        <tr class="border-b hover:bg-gray-50 account-row" data-search="${acc.account_code} ${acc.account_name_ar} ${acc.account_name_en || ''} ${typeLabels[acc.account_type] || acc.account_type}">
                            <td class="p-3 font-mono">${acc.account_id ?? '-'}</td>
                            <td class="p-3 font-mono font-bold">${acc.account_code ?? '-'}</td>
                            <td class="p-3">${acc.account_name_ar ?? '-'}</td>
                            <td class="p-3">${acc.account_name_en ?? '-'}</td>
                            <td class="p-3 ${typeColors[acc.account_type] || ''}">${typeLabels[acc.account_type] || acc.account_type || '-'}</td>
                            <td class="p-3 font-mono text-sm text-gray-500">${acc.parent_account_id ?? '-'}</td>
                            <td class="p-3">${acc.parent_name ?? '-'}</td>
                            <td class="p-3 text-center"><span class="bg-gray-200 px-2 py-1 rounded text-sm">${acc.level ?? '-'}</span></td>
                            <td class="p-3">${acc.is_header === true ? 'Ù†Ø¹Ù…' : acc.is_header === false ? 'Ù„Ø§' : '-'}</td>
                            <td class="p-3">${acc.normal_balance ?? '-'}</td>
                            <td class="p-3">${acc.is_active === true ? 'Ù†Ø¹Ù…' : acc.is_active === false ? 'Ù„Ø§' : '-'}</td>
                            <td class="p-3">${acc.entity_type ?? '-'}</td>
                            <td class="p-3">${acc.entity_id ?? '-'}</td>
                            <td class="p-3">${acc.branch_id ?? '-'}</td>
                            <td class="p-3">${acc.incubator_id ?? '-'}</td>
                            <td class="p-3">${acc.platform_id ?? '-'}</td>
                            <td class="p-3">${acc.office_id ?? '-'}</td>
                            <td class="p-3">${acc.description ?? '-'}</td>
                            <td class="p-3">${acc.notes ?? '-'}</td>
                            <td class="p-3">${acc.children_count ?? 0}</td>
                            <td class="p-3">${acc.created_at ? new Date(acc.created_at).toLocaleString('ar-SA') : '-'}</td>
                            <td class="p-3">${acc.updated_at ? new Date(acc.updated_at).toLocaleString('ar-SA') : '-'}</td>
                            <td class="p-3">${acc.created_by ?? '-'}</td>
                            <td class="p-3">${acc.updated_by ?? '-'}</td>
                        </tr>
                    `;
                }).join('');

                // Search functionality
                document.getElementById('search-accounts').addEventListener('input', (e) => {
                    const searchTerm = e.target.value.toLowerCase();
                    document.querySelectorAll('.account-row').forEach(row => {
                        const searchData = row.getAttribute('data-search').toLowerCase();
                        row.style.display = searchData.includes(searchTerm) ? '' : 'none';
                    });
                });

            } catch (error) {
                console.error('Error loading accounts:', error);
                showToast('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª', 'error');
            }
        }

        // Update Chart
        function updateChart(data) {
            const ctx = document.getElementById('cashflow-chart');
            if (cashflowChart) cashflowChart.destroy();

            cashflowChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Ø§Ù„ØªØ´ØºÙŠÙ„ÙŠ', 'Ø§Ù„Ø§Ø³ØªØ«Ù…Ø§Ø±ÙŠ', 'Ø§Ù„ØªÙ…ÙˆÙŠÙ„ÙŠ'],
                    datasets: [{
                        label: 'ØµØ§ÙÙŠ Ø§Ù„ØªØ¯ÙÙ‚ Ø§Ù„Ù†Ù‚Ø¯ÙŠ (Ø±ÙŠØ§Ù„)',
                        data: data,
                        backgroundColor: [
                            'rgba(86, 171, 47, 0.7)',
                            'rgba(235, 51, 73, 0.7)',
                            'rgba(79, 172, 254, 0.7)'
                        ],
                        borderColor: [
                            'rgb(86, 171, 47)',
                            'rgb(235, 51, 73)',
                            'rgb(79, 172, 254)'
                        ],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        }

        // Add Operating Flow
        async function addOperatingFlow(e) {
            e.preventDefault();
            const btn = e.target.querySelector('button');
            btn.disabled = true;
            btn.innerHTML = '<span class="loading"></span>';

            try {
                const res = await fetch(`${API_BASE}/finance/cashflow/operating`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        entity_id: ENTITY_ID,
                        flow_type: document.getElementById('op-type').value,
                        amount: parseFloat(document.getElementById('op-amount').value),
                        description: document.getElementById('op-description').value,
                        flow_date: document.getElementById('op-date').value
                    })
                });

                if (res.ok) {
                    showToast('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØªØ¯ÙÙ‚ Ø¨Ù†Ø¬Ø§Ø­');
                    e.target.reset();
                    loadOperating();
                } else {
                    throw new Error('Failed to add');
                }
            } catch (error) {
                showToast('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¥Ø¶Ø§ÙØ©', 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-plus ml-2"></i> Ø¥Ø¶Ø§ÙØ©';
            }
        }

        // Load Operating
        async function loadOperating() {
            try {
                const res = await fetch(`${API_BASE}/finance/cashflow/operating?entity_id=${ENTITY_ID}`);
                const data = await res.json();

                // Summary
                document.getElementById('operating-summary').innerHTML = `
                    <div class="bg-green-50 p-4 rounded-lg">
                        <div class="text-sm text-gray-600">Ø§Ù„ØªØ¯ÙÙ‚ Ø§Ù„Ø¯Ø§Ø®Ù„</div>
                        <div class="text-2xl font-bold text-green-600">${formatMoney(data.summary.inflow)}</div>
                    </div>
                    <div class="bg-red-50 p-4 rounded-lg">
                        <div class="text-sm text-gray-600">Ø§Ù„ØªØ¯ÙÙ‚ Ø§Ù„Ø®Ø§Ø±Ø¬</div>
                        <div class="text-2xl font-bold text-red-600">${formatMoney(data.summary.outflow)}</div>
                    </div>
                    <div class="bg-blue-50 p-4 rounded-lg">
                        <div class="text-sm text-gray-600">ØµØ§ÙÙŠ Ø§Ù„ØªØ¯ÙÙ‚</div>
                        <div class="text-2xl font-bold text-blue-600">${formatMoney(data.summary.net_flow)}</div>
                    </div>
                `;

                // List
                const tbody = document.getElementById('operating-tbody');
                const flows = data.cashflows || [];
                if (flows.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="9" class="text-center p-4 text-gray-500">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù…Ù„ÙŠØ§Øª</td></tr>';
                } else {
                    tbody.innerHTML = flows.map(f => {
                        const amount = parseFloat(f.amount || 0);
                        const direction = amount >= 0 ? 'IN' : 'OUT';
                        return `
                            <tr class="border-b hover:bg-gray-50">
                                <td class="p-3 font-mono">${f.flow_id ?? '-'}</td>
                                <td class="p-3">${f.entity_id ?? '-'}</td>
                                <td class="p-3">${getFlowTypeLabel(f.flow_type)}</td>
                                <td class="p-3 ${direction === 'IN' ? 'text-green-600' : 'text-red-600'}">${formatMoney(amount)}</td>
                                <td class="p-3">${direction}</td>
                                <td class="p-3">${f.description ?? '-'}</td>
                                <td class="p-3">${f.flow_date ? new Date(f.flow_date).toLocaleDateString('ar-SA') : '-'}</td>
                                <td class="p-3">${f.created_by ?? '-'}</td>
                                <td class="p-3">${f.created_at ? new Date(f.created_at).toLocaleString('ar-SA') : '-'}</td>
                            </tr>
                        `;
                    }).join('');
                }
            } catch (error) {
                console.error('Error loading operating:', error);
            }
        }

        // Add Investing Flow
        async function addInvestingFlow(e) {
            e.preventDefault();
            const btn = e.target.querySelector('button');
            btn.disabled = true;
            btn.innerHTML = '<span class="loading"></span>';

            try {
                const res = await fetch(`${API_BASE}/finance/cashflow/investing`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        entity_id: ENTITY_ID,
                        flow_type: document.getElementById('inv-type').value,
                        amount: parseFloat(document.getElementById('inv-amount').value),
                        description: document.getElementById('inv-description').value,
                        flow_date: document.getElementById('inv-date').value
                    })
                });

                if (res.ok) {
                    showToast('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØªØ¯ÙÙ‚ Ø¨Ù†Ø¬Ø§Ø­');
                    e.target.reset();
                    loadInvesting();
                } else {
                    throw new Error('Failed');
                }
            } catch (error) {
                showToast('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¥Ø¶Ø§ÙØ©', 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-plus ml-2"></i> Ø¥Ø¶Ø§ÙØ©';
            }
        }

        // Load Investing
        async function loadInvesting() {
            try {
                const res = await fetch(`${API_BASE}/finance/cashflow/investing?entity_id=${ENTITY_ID}`);
                const data = await res.json();

                document.getElementById('investing-summary').innerHTML = `
                    <div class="bg-green-50 p-4 rounded-lg">
                        <div class="text-sm text-gray-600">Ø§Ù„ØªØ¯ÙÙ‚ Ø§Ù„Ø¯Ø§Ø®Ù„</div>
                        <div class="text-2xl font-bold text-green-600">${formatMoney(data.summary.inflow)}</div>
                    </div>
                    <div class="bg-red-50 p-4 rounded-lg">
                        <div class="text-sm text-gray-600">Ø§Ù„ØªØ¯ÙÙ‚ Ø§Ù„Ø®Ø§Ø±Ø¬</div>
                        <div class="text-2xl font-bold text-red-600">${formatMoney(data.summary.outflow)}</div>
                    </div>
                    <div class="bg-blue-50 p-4 rounded-lg">
                        <div class="text-sm text-gray-600">ØµØ§ÙÙŠ Ø§Ù„ØªØ¯ÙÙ‚</div>
                        <div class="text-2xl font-bold text-blue-600">${formatMoney(data.summary.net_flow)}</div>
                    </div>
                `;

                const tbody = document.getElementById('investing-tbody');
                const flows = data.cashflows || [];
                if (flows.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="9" class="text-center p-4 text-gray-500">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù…Ù„ÙŠØ§Øª</td></tr>';
                } else {
                    tbody.innerHTML = flows.map(f => {
                        const amount = parseFloat(f.amount || 0);
                        const direction = amount >= 0 ? 'IN' : 'OUT';
                        return `
                            <tr class="border-b hover:bg-gray-50">
                                <td class="p-3 font-mono">${f.flow_id ?? '-'}</td>
                                <td class="p-3">${f.entity_id ?? '-'}</td>
                                <td class="p-3">${getFlowTypeLabel(f.flow_type)}</td>
                                <td class="p-3 ${direction === 'IN' ? 'text-green-600' : 'text-red-600'}">${formatMoney(amount)}</td>
                                <td class="p-3">${direction}</td>
                                <td class="p-3">${f.description ?? '-'}</td>
                                <td class="p-3">${f.flow_date ? new Date(f.flow_date).toLocaleDateString('ar-SA') : '-'}</td>
                                <td class="p-3">${f.created_by ?? '-'}</td>
                                <td class="p-3">${f.created_at ? new Date(f.created_at).toLocaleString('ar-SA') : '-'}</td>
                            </tr>
                        `;
                    }).join('');
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }

        // Add Financing Flow
        async function addFinancingFlow(e) {
            e.preventDefault();
            const btn = e.target.querySelector('button');
            btn.disabled = true;
            btn.innerHTML = '<span class="loading"></span>';

            try {
                const res = await fetch(`${API_BASE}/finance/cashflow/financing`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        entity_id: ENTITY_ID,
                        flow_type: document.getElementById('fin-type').value,
                        amount: parseFloat(document.getElementById('fin-amount').value),
                        description: document.getElementById('fin-description').value,
                        flow_date: document.getElementById('fin-date').value
                    })
                });

                if (res.ok) {
                    showToast('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØªØ¯ÙÙ‚ Ø¨Ù†Ø¬Ø§Ø­');
                    e.target.reset();
                    loadFinancing();
                } else {
                    throw new Error('Failed');
                }
            } catch (error) {
                showToast('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¥Ø¶Ø§ÙØ©', 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-plus ml-2"></i> Ø¥Ø¶Ø§ÙØ©';
            }
        }

        // Load Financing
        async function loadFinancing() {
            try {
                const res = await fetch(`${API_BASE}/finance/cashflow/financing?entity_id=${ENTITY_ID}`);
                const data = await res.json();

                document.getElementById('financing-summary').innerHTML = `
                    <div class="bg-green-50 p-4 rounded-lg">
                        <div class="text-sm text-gray-600">Ø§Ù„ØªØ¯ÙÙ‚ Ø§Ù„Ø¯Ø§Ø®Ù„</div>
                        <div class="text-2xl font-bold text-green-600">${formatMoney(data.summary.inflow)}</div>
                    </div>
                    <div class="bg-red-50 p-4 rounded-lg">
                        <div class="text-sm text-gray-600">Ø§Ù„ØªØ¯ÙÙ‚ Ø§Ù„Ø®Ø§Ø±Ø¬</div>
                        <div class="text-2xl font-bold text-red-600">${formatMoney(data.summary.outflow)}</div>
                    </div>
                    <div class="bg-blue-50 p-4 rounded-lg">
                        <div class="text-sm text-gray-600">ØµØ§ÙÙŠ Ø§Ù„ØªØ¯ÙÙ‚</div>
                        <div class="text-2xl font-bold text-blue-600">${formatMoney(data.summary.net_flow)}</div>
                    </div>
                `;

                const tbody = document.getElementById('financing-tbody');
                const flows = data.cashflows || [];
                if (flows.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="9" class="text-center p-4 text-gray-500">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù…Ù„ÙŠØ§Øª</td></tr>';
                } else {
                    tbody.innerHTML = flows.map(f => {
                        const amount = parseFloat(f.amount || 0);
                        const direction = amount >= 0 ? 'IN' : 'OUT';
                        return `
                            <tr class="border-b hover:bg-gray-50">
                                <td class="p-3 font-mono">${f.flow_id ?? '-'}</td>
                                <td class="p-3">${f.entity_id ?? '-'}</td>
                                <td class="p-3">${getFlowTypeLabel(f.flow_type)}</td>
                                <td class="p-3 ${direction === 'IN' ? 'text-green-600' : 'text-red-600'}">${formatMoney(amount)}</td>
                                <td class="p-3">${direction}</td>
                                <td class="p-3">${f.description ?? '-'}</td>
                                <td class="p-3">${f.flow_date ? new Date(f.flow_date).toLocaleDateString('ar-SA') : '-'}</td>
                                <td class="p-3">${f.created_by ?? '-'}</td>
                                <td class="p-3">${f.created_at ? new Date(f.created_at).toLocaleString('ar-SA') : '-'}</td>
                            </tr>
                        `;
                    }).join('');
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }

        // Add Forecast
        async function addForecast(e) {
            e.preventDefault();
            const btn = e.target.querySelector('button');
            btn.disabled = true;
            btn.innerHTML = '<span class="loading"></span>';

            try {
                const forecastDate = document.getElementById('fc-date').value;
                const periodLabel = forecastDate ? new Date(forecastDate).toLocaleDateString('ar-SA', { month: 'long', year: 'numeric' }) : 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
                const rawConfidence = parseFloat(document.getElementById('fc-confidence').value || 0);
                const confidenceNormalized = rawConfidence > 1 ? rawConfidence / 100 : rawConfidence;
                const res = await fetch(`${API_BASE}/finance/cashflow/forecast`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        entity_id: ENTITY_ID,
                        forecast_type: document.getElementById('fc-type').value,
                        forecast_period: periodLabel,
                        forecast_amount: parseFloat(document.getElementById('fc-amount').value),
                        confidence_level: confidenceNormalized,
                        ai_model: 'Naiosh-AI v1',
                        ai_insights: JSON.parse(document.getElementById('fc-factors').value)
                    })
                });

                if (res.ok) {
                    showToast('ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªÙˆÙ‚Ø¹ Ø¨Ù†Ø¬Ø§Ø­');
                    e.target.reset();
                    loadForecasts();
                } else {
                    throw new Error('Failed');
                }
            } catch (error) {
                showToast('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡', 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-brain ml-2"></i> Ø¥Ù†Ø´Ø§Ø¡ ØªÙˆÙ‚Ø¹';
            }
        }

        // Load Forecasts
        async function loadForecasts() {
            try {
                const res = await fetch(`${API_BASE}/finance/cashflow/forecast?entity_id=${ENTITY_ID}`);
                const data = await res.json();

                document.getElementById('forecast-stats').innerHTML = `
                    <div class="bg-purple-50 p-4 rounded-lg">
                        <div class="text-sm text-gray-600">Ø¹Ø¯Ø¯ Ø§Ù„ØªÙˆÙ‚Ø¹Ø§Øª</div>
                        <div class="text-2xl font-bold text-purple-600">${data.forecasts.length}</div>
                    </div>
                    <div class="bg-green-50 p-4 rounded-lg">
                        <div class="text-sm text-gray-600">ØªÙˆÙ‚Ø¹Ø§Øª Ø§Ù„ÙØ§Ø¦Ø¶</div>
                        <div class="text-2xl font-bold text-green-600">${data.forecasts.filter(f => f.forecast_type === 'surplus').length}</div>
                    </div>
                    <div class="bg-red-50 p-4 rounded-lg">
                        <div class="text-sm text-gray-600">ØªÙˆÙ‚Ø¹Ø§Øª Ø§Ù„Ø¹Ø¬Ø²</div>
                        <div class="text-2xl font-bold text-red-600">${data.forecasts.filter(f => f.forecast_type === 'deficit').length}</div>
                    </div>
                `;

                const tbody = document.getElementById('forecast-tbody');
                if (data.forecasts.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="9" class="text-center p-4 text-gray-500">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙˆÙ‚Ø¹Ø§Øª</td></tr>';
                } else {
                    tbody.innerHTML = data.forecasts.map(f => {
                        const confidence = parseFloat(f.confidence_level || 0);
                        const confidencePct = confidence <= 1 ? (confidence * 100).toFixed(1) : confidence.toFixed(1);
                        return `
                            <tr class="border-b hover:bg-gray-50">
                                <td class="p-3 font-mono">${f.forecast_id ?? '-'}</td>
                                <td class="p-3">${f.entity_id ?? '-'}</td>
                                <td class="p-3">${f.forecast_period ?? '-'}</td>
                                <td class="p-3">${f.forecast_type ?? '-'}</td>
                                <td class="p-3 font-semibold text-purple-600">${formatMoney(f.forecast_amount || 0)}</td>
                                <td class="p-3">${confidencePct}%</td>
                                <td class="p-3">${f.ai_model ?? '-'}</td>
                                <td class="p-3">${f.ai_insights ? JSON.stringify(f.ai_insights) : '-'}</td>
                                <td class="p-3">${f.created_at ? new Date(f.created_at).toLocaleString('ar-SA') : '-'}</td>
                            </tr>
                        `;
                    }).join('');
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }

        // Get Flow Type Label
        function getFlowTypeLabel(type) {
            const labels = {
                customer_collection: 'ØªØ­ØµÙŠÙ„ Ù…Ù† Ø¹Ù…ÙŠÙ„',
                vendor_payment: 'Ø¯ÙØ¹ Ù„Ù…ÙˆØ±Ø¯',
                salary_payment: 'Ø±ÙˆØ§ØªØ¨',
                rent_payment: 'Ø¥ÙŠØ¬Ø§Ø±',
                utilities_payment: 'Ù…Ø±Ø§ÙÙ‚',
                asset_purchase: 'Ø´Ø±Ø§Ø¡ Ø£ØµÙ„',
                asset_sale: 'Ø¨ÙŠØ¹ Ø£ØµÙ„',
                platform_investment: 'Ø§Ø³ØªØ«Ù…Ø§Ø± Ù…Ù†ØµØ©',
                equipment_purchase: 'Ø´Ø±Ø§Ø¡ Ù…Ø¹Ø¯Ø§Øª',
                bank_loan: 'Ù‚Ø±Ø¶ Ø¨Ù†ÙƒÙŠ',
                loan_repayment: 'Ø³Ø¯Ø§Ø¯ Ù‚Ø±Ø¶',
                capital_increase: 'Ø²ÙŠØ§Ø¯Ø© Ø±Ø£Ø³ Ù…Ø§Ù„',
                dividend_payment: 'ØªÙˆØ²ÙŠØ¹ Ø£Ø±Ø¨Ø§Ø­'
            };
            return labels[type] || type;
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            // Set default dates
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('op-date').value = today;
            document.getElementById('inv-date').value = today;
            document.getElementById('fin-date').value = today;
            document.getElementById('fc-date').value = today;

            // Load all data on startup
            loadOverview();
            loadAccounts();
            loadOperating();
            loadInvesting();
            loadFinancing();
            loadForecasts();
        });
    </script>

</body>
</html>
