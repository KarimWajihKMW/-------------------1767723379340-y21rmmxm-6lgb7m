<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ØªØ´Ø®ÙŠØµ Ù†Ø¸Ø§Ù… Ù†Ø§ÙŠÙˆØ´</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="bg-gray-50">
    <div class="container mx-auto p-6 max-w-4xl">
        <div class="bg-white rounded-lg shadow-lg p-8 mb-6">
            <h1 class="text-3xl font-bold mb-4 text-gray-800">
                <i class="fas fa-stethoscope text-blue-600 mr-3"></i>
                ØªØ´Ø®ÙŠØµ Ù†Ø¸Ø§Ù… Ù†Ø§ÙŠÙˆØ´
            </h1>
            <p class="text-gray-600 mb-6">Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø© Ù„ØªØ´Ø®ÙŠØµ Ù…Ø´Ø§ÙƒÙ„ Ø§Ù„Ù†Ø¸Ø§Ù… ÙˆØ¹Ø±Ø¶ Ø­Ø§Ù„Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙƒÙˆÙ†Ø§Øª</p>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                <div class="bg-blue-50 p-4 rounded-lg">
                    <h3 class="font-bold text-blue-800 mb-2">
                        <i class="fas fa-info-circle mr-2"></i>
                        Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…
                    </h3>
                    <div class="text-sm space-y-1">
                        <p><strong>Ø§Ù„Ù…Ø¶ÙŠÙ:</strong> <span id="hostname">-</span></p>
                        <p><strong>Ø§Ù„Ø¨Ø±ÙˆØªÙˆÙƒÙˆÙ„:</strong> <span id="protocol">-</span></p>
                        <p><strong>API URL:</strong> <span id="api-url">-</span></p>
                        <p><strong>Ø§Ù„ÙˆÙ‚Øª:</strong> <span id="current-time">-</span></p>
                    </div>
                </div>
                
                <div class="bg-green-50 p-4 rounded-lg">
                    <h3 class="font-bold text-green-800 mb-2">
                        <i class="fas fa-database mr-2"></i>
                        Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„Ø§Øª
                    </h3>
                    <div class="text-sm space-y-1">
                        <p id="server-status">â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„ÙØ­Øµ...</p>
                        <p id="db-status">â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„ÙØ­Øµ...</p>
                        <p id="api-status">â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„ÙØ­Øµ...</p>
                    </div>
                </div>
            </div>

            <button onclick="runDiagnostics()" 
                    class="w-full bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700 transition mb-4">
                <i class="fas fa-play-circle mr-2"></i>
                Ø¨Ø¯Ø¡ Ø§Ù„ØªØ´Ø®ÙŠØµ
            </button>
        </div>

        <div id="results" class="space-y-4"></div>
    </div>

    <script>
        const API_BASE = window.location.hostname === 'localhost' 
            ? 'http://localhost:3000/api' 
            : '/api';

        // Update system info
        document.getElementById('hostname').textContent = window.location.hostname;
        document.getElementById('protocol').textContent = window.location.protocol;
        document.getElementById('api-url').textContent = API_BASE;
        
        setInterval(() => {
            document.getElementById('current-time').textContent = new Date().toLocaleString('ar-EG');
        }, 1000);

        function addResult(title, content, status = 'info') {
            const colors = {
                success: 'bg-green-50 border-green-500 text-green-900',
                error: 'bg-red-50 border-red-500 text-red-900',
                warning: 'bg-yellow-50 border-yellow-500 text-yellow-900',
                info: 'bg-blue-50 border-blue-500 text-blue-900'
            };
            
            const icons = {
                success: 'fa-check-circle',
                error: 'fa-times-circle',
                warning: 'fa-exclamation-triangle',
                info: 'fa-info-circle'
            };

            const resultsDiv = document.getElementById('results');
            const div = document.createElement('div');
            div.className = `border-r-4 p-4 rounded-lg ${colors[status]}`;
            div.innerHTML = `
                <h3 class="font-bold mb-2">
                    <i class="fas ${icons[status]} mr-2"></i>
                    ${title}
                </h3>
                <div class="text-sm whitespace-pre-wrap font-mono">${content}</div>
            `;
            resultsDiv.appendChild(div);
        }

        async function testEndpoint(name, url, headers = {}) {
            try {
                const startTime = Date.now();
                const response = await fetch(url, { headers });
                const duration = Date.now() - startTime;
                
                if (!response.ok) {
                    const text = await response.text();
                    addResult(
                        `âŒ ${name}`,
                        `Ø§Ù„Ø­Ø§Ù„Ø©: ${response.status}\nØ§Ù„Ø²Ù…Ù†: ${duration}ms\nØ§Ù„Ø®Ø·Ø£: ${text.substring(0, 200)}`,
                        'error'
                    );
                    return false;
                }
                
                const data = await response.json();
                const count = Array.isArray(data) ? data.length : 'object';
                addResult(
                    `âœ… ${name}`,
                    `Ø§Ù„Ø­Ø§Ù„Ø©: ${response.status} OK\nØ§Ù„Ø²Ù…Ù†: ${duration}ms\nØ§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ${count} Ø¹Ù†ØµØ±`,
                    'success'
                );
                return true;
            } catch (error) {
                addResult(
                    `ğŸ’¥ ${name}`,
                    `Ø®Ø·Ø£: ${error.message}\nØ§Ù„Ù†ÙˆØ¹: ${error.name}`,
                    'error'
                );
                return false;
            }
        }

        async function runDiagnostics() {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '';
            
            addResult('ğŸš€ Ø¨Ø¯Ø¡ Ø§Ù„ØªØ´Ø®ÙŠØµ', `Ø§Ù„ÙˆÙ‚Øª: ${new Date().toLocaleString('ar-EG')}`, 'info');

            // Test 1: Server Health
            addResult('ğŸ” ÙØ­Øµ Ø§Ù„Ø³ÙŠØ±ÙØ±', 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±...', 'info');
            await testEndpoint('Ø§Ù„Ø³ÙŠØ±ÙØ± Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ', window.location.origin);

            // Test 2: API Endpoints without headers
            addResult('ğŸ” ÙØ­Øµ API Ø¨Ø¯ÙˆÙ† headers', 'Ø¬Ø§Ø±ÙŠ Ø§Ø®ØªØ¨Ø§Ø± endpoints Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©...', 'info');
            await testEndpoint('GET /api/entities (Ø¨Ø¯ÙˆÙ† headers)', `${API_BASE}/entities`);

            // Test 3: API with Incubator headers
            addResult('ğŸ” ÙØ­Øµ API Ù„Ø­Ø§Ø¶Ù†Ø© Ø§Ù„Ø³Ù„Ø§Ù…Ø©', 'Ø¬Ø§Ø±ÙŠ Ø§Ø®ØªØ¨Ø§Ø± Ù…Ø¹ headers Ø§Ù„Ø­Ø§Ø¶Ù†Ø©...', 'info');
            const incubatorHeaders = {
                'x-entity-type': 'INCUBATOR',
                'x-entity-id': '5'
            };

            await testEndpoint('GET /api/entities (Incubator)', `${API_BASE}/entities`, incubatorHeaders);
            await testEndpoint('GET /api/users (Incubator)', `${API_BASE}/users`, incubatorHeaders);
            await testEndpoint('GET /api/invoices (Incubator)', `${API_BASE}/invoices`, incubatorHeaders);
            await testEndpoint('GET /api/transactions (Incubator)', `${API_BASE}/transactions`, incubatorHeaders);
            await testEndpoint('GET /api/ledger (Incubator)', `${API_BASE}/ledger`, incubatorHeaders);
            await testEndpoint('GET /api/ads (Incubator)', `${API_BASE}/ads`, incubatorHeaders);
            await testEndpoint('GET /api/approvals (Incubator)', `${API_BASE}/approvals`, incubatorHeaders);

            // Test 4: Dashboard API
            addResult('ğŸ” ÙØ­Øµ Dashboard API', 'Ø¬Ø§Ø±ÙŠ Ø§Ø®ØªØ¨Ø§Ø± dashboard endpoints...', 'info');
            await testEndpoint('GET /api/dashboard/type', `${API_BASE}/dashboard/type`, incubatorHeaders);
            await testEndpoint('GET /api/dashboard/incubator', `${API_BASE}/dashboard/incubator`, incubatorHeaders);

            addResult('âœ… Ø§ÙƒØªÙ…Ù„ Ø§Ù„ØªØ´Ø®ÙŠØµ', `Ø§Ù„ÙˆÙ‚Øª: ${new Date().toLocaleString('ar-EG')}`, 'success');
            
            // Update status indicators
            document.getElementById('server-status').innerHTML = 'âœ… Ø§Ù„Ø³ÙŠØ±ÙØ± ÙŠØ¹Ù…Ù„';
            document.getElementById('db-status').innerHTML = 'âœ… Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…ØªØµÙ„Ø©';
            document.getElementById('api-status').innerHTML = 'âœ… API ÙŠØ¹Ù…Ù„';
        }

        // Auto-run on load
        window.addEventListener('load', () => {
            setTimeout(runDiagnostics, 1000);
        });
    </script>
</body>
</html>
